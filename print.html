<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>PyO3 user guide</title>
        <meta name="robots" content="noindex">


        <!-- Custom HTML head -->

        <meta name="description" content="PyO3 user guide">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon-de23e50b.svg">
        <link rel="shortcut icon" href="favicon-8114d1fc.png">
        <link rel="stylesheet" href="css/variables-8adf115d.css">
        <link rel="stylesheet" href="css/general-2459343d.css">
        <link rel="stylesheet" href="css/chrome-ae938929.css">
        <link rel="stylesheet" href="css/print-9e4910d8.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="fonts/fonts-9644e21d.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="mdbook-highlight-css" href="highlight-493f70e1.css">
        <link rel="stylesheet" id="mdbook-tomorrow-night-css" href="tomorrow-night-4c0ae647.css">
        <link rel="stylesheet" id="mdbook-ayu-highlight-css" href="ayu-highlight-3fdfc3ac.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="theme/tabs-52f01167.css">


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "searchindex-78070eb0.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="toc-c528a6fa.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>â†</kbd> or <kbd>â†’</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="mdbook-body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="mdbook-sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("mdbook-sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="mdbook-sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="toc.html"></iframe>
            </noscript>
            <div id="mdbook-sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="mdbook-page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="mdbook-menu-bar-hover-placeholder"></div>
                <div id="mdbook-menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="mdbook-sidebar-toggle" class="icon-button" for="mdbook-sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="mdbook-sidebar">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M0 96C0 78.3 14.3 64 32 64H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32C14.3 128 0 113.7 0 96zM0 256c0-17.7 14.3-32 32-32H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32c-17.7 0-32-14.3-32-32zM448 416c0 17.7-14.3 32-32 32H32c-17.7 0-32-14.3-32-32s14.3-32 32-32H416c17.7 0 32 14.3 32 32z"/></svg></span>
                        </label>
                        <button id="mdbook-theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="mdbook-theme-list">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M371.3 367.1c27.3-3.9 51.9-19.4 67.2-42.9L600.2 74.1c12.6-19.5 9.4-45.3-7.6-61.2S549.7-4.4 531.1 9.6L294.4 187.2c-24 18-38.2 46.1-38.4 76.1L371.3 367.1zm-19.6 25.4l-116-104.4C175.9 290.3 128 339.6 128 400c0 3.9 .2 7.8 .6 11.6c1.8 17.5-10.2 36.4-27.8 36.4H96c-17.7 0-32 14.3-32 32s14.3 32 32 32H240c61.9 0 112-50.1 112-112c0-2.5-.1-5-.2-7.5z"/></svg></span>
                        </button>
                        <ul id="mdbook-theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-ayu">Ayu</button></li>
                        </ul>
                        <button id="mdbook-search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="mdbook-searchbar">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M416 208c0 45.9-14.9 88.3-40 122.7L502.6 457.4c12.5 12.5 12.5 32.8 0 45.3s-32.8 12.5-45.3 0L330.7 376c-34.4 25.2-76.8 40-122.7 40C93.1 416 0 322.9 0 208S93.1 0 208 0S416 93.1 416 208zM208 352c79.5 0 144-64.5 144-144s-64.5-144-144-144S64 128.5 64 208s64.5 144 144 144z"/></svg></span>
                        </button>
                    </div>

                    <h1 class="menu-title">PyO3 user guide</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <span class=fa-svg id="print-button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M128 0C92.7 0 64 28.7 64 64v96h64V64H354.7L384 93.3V160h64V93.3c0-17-6.7-33.3-18.7-45.3L400 18.7C388 6.7 371.7 0 354.7 0H128zM384 352v32 64H128V384 368 352H384zm64 32h32c17.7 0 32-14.3 32-32V256c0-35.3-28.7-64-64-64H64c-35.3 0-64 28.7-64 64v96c0 17.7 14.3 32 32 32H64v64c0 35.3 28.7 64 64 64H384c35.3 0 64-28.7 64-64V384zm-16-88c-13.3 0-24-10.7-24-24s10.7-24 24-24s24 10.7 24 24s-10.7 24-24 24z"/></svg></span>
                        </a>
                        <a href="https://github.com/PyO3/pyo3/tree/main/guide" title="Git repository" aria-label="Git repository">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg></span>
                        </a>

                    </div>
                </div>

                <div id="mdbook-search-wrapper" class="hidden">
                    <form id="mdbook-searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="mdbook-searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="mdbook-searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <span class=fa-svg id="fa-spin"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M304 48c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zm0 416c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zM48 304c26.5 0 48-21.5 48-48s-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48zm464-48c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zM142.9 437c18.7-18.7 18.7-49.1 0-67.9s-49.1-18.7-67.9 0s-18.7 49.1 0 67.9s49.1 18.7 67.9 0zm0-294.2c18.7-18.7 18.7-49.1 0-67.9S93.7 56.2 75 75s-18.7 49.1 0 67.9s49.1 18.7 67.9 0zM369.1 437c18.7 18.7 49.1 18.7 67.9 0s18.7-49.1 0-67.9s-49.1-18.7-67.9 0s-18.7 49.1 0 67.9z"/></svg></span>
                            </div>
                        </div>
                    </form>
                    <div id="mdbook-searchresults-outer" class="searchresults-outer hidden">
                        <div id="mdbook-searchresults-header" class="searchresults-header"></div>
                        <ul id="mdbook-searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('mdbook-sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('mdbook-sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#mdbook-sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="mdbook-content" class="content">
                    <main>
                        <h1 id="pyo3-ç”¨æˆ·æŒ‡å—"><a class="header" href="#pyo3-ç”¨æˆ·æŒ‡å—">PyO3 ç”¨æˆ·æŒ‡å—</a></h1>
<p>æ¬¢è¿æ¥åˆ° PyO3 ç”¨æˆ·æŒ‡å—ï¼æœ¬ä¹¦æ˜¯ <a href="https://docs.rs/pyo3">PyO3 çš„ API æ–‡æ¡£</a> çš„é…å¥—æŒ‡å—ï¼ŒåŒ…å«ä¸°å¯Œçš„ç¤ºä¾‹å’Œè¯¦ç»†è¯´æ˜ï¼Œå¸®åŠ©ä½ å…¨é¢æŒæ¡ PyO3 çš„å„ç§ä½¿ç”¨åœºæ™¯ã€‚</p>
<p>æœ¬ç”¨æˆ·æŒ‡å—çš„å¤§è‡´å†…å®¹ç»“æ„å¦‚ä¸‹ï¼š</p>
<ol>
<li>å…¥é—¨ä»‹ç»</li>
<li>å°† Rust ä»£ç å°è£…ä¸ºå¯åœ¨ Python ä¸­ä½¿ç”¨çš„æ¨¡å—</li>
<li>å¦‚ä½•åœ¨ Rust ä¸­è°ƒç”¨ Python ä»£ç </li>
<li>å…¶ä»–è¿›é˜¶ä¸»é¢˜çš„æ·±å…¥è®²è§£</li>
</ol>
<p>è¯·ä»å·¦ä¾§ç« èŠ‚é€‰æ‹©å…·ä½“å†…å®¹ï¼Œæˆ–ç»§ç»­é˜…è¯»ä¸‹æ–‡ï¼Œä» PyO3 çš„ README å¼€å§‹å­¦ä¹ ã€‚</p>
<hr style="opacity:0.2">
<h1 id="pyo3"><a class="header" href="#pyo3">PyO3</a></h1>
<p><a href="https://github.com/PyO3/pyo3/actions"><img src="https://img.shields.io/github/actions/workflow/status/PyO3/pyo3/ci.yml?branch=main&amp;logo=github&amp;style=" alt="actions status"></a>
<a href="https://codspeed.io/PyO3/pyo3"><img src="https://img.shields.io/endpoint?url=https://codspeed.io/badge.json" alt="benchmark"></a>
<a href="https://codecov.io/gh/PyO3/pyo3"><img src="https://img.shields.io/codecov/c/gh/PyO3/pyo3?logo=codecov" alt="codecov"></a>
<a href="https://crates.io/crates/pyo3"><img src="https://img.shields.io/crates/v/pyo3?logo=rust" alt="crates.io"></a>
<a href="https://rust-lang.github.io/rfcs/2495-min-rust-version.html"><img src="https://img.shields.io/badge/rustc-1.74+-blue?logo=rust" alt="minimum rustc 1.74"></a>
<a href="https://discord.gg/33kcChzH7f"><img src="https://img.shields.io/discord/1209263839632424990?logo=discord" alt="discord server"></a>
<a href="https://github.com/PyO3/pyo3/blob/main/Contributing.md"><img src="https://img.shields.io/badge/contribute-on%20github-Green?logo=github" alt="contributing notes"></a></p>
<p><a href="https://www.rust-lang.org/">Rust</a> ä¸ <a href="https://www.python.org/">Python</a> çš„ç»‘å®šåº“ï¼ŒåŒ…å«ç”¨äºåˆ›å»ºåŸç”Ÿ Python æ‰©å±•æ¨¡å—çš„å·¥å…·ã€‚åŒæ—¶æ”¯æŒåœ¨ Rust ç¨‹åºä¸­è¿è¡Œå’Œäº¤äº’ Python ä»£ç ã€‚</p>
<ul>
<li>ç”¨æˆ·æŒ‡å—: <a href="https://pyo3.rs">ç¨³å®šç‰ˆ</a> | <a href="https://pyo3.rs/main">main åˆ†æ”¯</a></li>
<li>API æ–‡æ¡£: <a href="https://docs.rs/pyo3/">ç¨³å®šç‰ˆ</a> | <a href="https://pyo3.rs/main/doc">main åˆ†æ”¯</a></li>
</ul>
<h2 id="ä½¿ç”¨æ–¹æ³•"><a class="header" href="#ä½¿ç”¨æ–¹æ³•">ä½¿ç”¨æ–¹æ³•</a></h2>
<p>éœ€è¦ Rust 1.74 æˆ–æ›´é«˜ç‰ˆæœ¬ã€‚</p>
<p>PyO3 æ”¯æŒä»¥ä¸‹ Python å‘è¡Œç‰ˆï¼š</p>
<ul>
<li>CPython 3.7 æˆ–æ›´é«˜ç‰ˆæœ¬</li>
<li>PyPy 7.3ï¼ˆæ”¯æŒ Python 3.11+ï¼‰</li>
<li>GraalPy 24.2 æˆ–æ›´é«˜ç‰ˆæœ¬ï¼ˆæ”¯æŒ Python 3.11+ï¼‰</li>
</ul>
<p>ä½ å¯ä»¥ä½¿ç”¨ PyO3 ç¼–å†™åŸºäº Rust çš„åŸç”Ÿ Python æ¨¡å—ï¼Œä¹Ÿå¯ä»¥åœ¨ Rust äºŒè¿›åˆ¶ç¨‹åºä¸­åµŒå…¥ Pythonã€‚ä»¥ä¸‹éƒ¨åˆ†å°†é€ä¸€ä»‹ç»è¿™ä¸¤ç§ç”¨æ³•ã€‚</p>
<h3 id="åœ¨-python-ä¸­ä½¿ç”¨-rust"><a class="header" href="#åœ¨-python-ä¸­ä½¿ç”¨-rust">åœ¨ Python ä¸­ä½¿ç”¨ Rust</a></h3>
<p>PyO3 å¯ç”¨äºç”ŸæˆåŸç”Ÿ Python æ¨¡å—ã€‚é¦–æ¬¡å°è¯•æœ€ç®€å•çš„æ–¹å¼æ˜¯ä½¿ç”¨ <a href="https://github.com/PyO3/maturin"><code>maturin</code></a>ã€‚<code>maturin</code> æ˜¯ä¸€ä¸ªæ„å»ºå’Œå‘å¸ƒåŸºäº Rust çš„ Python åŒ…çš„å·¥å…·ï¼Œå‡ ä¹æ— éœ€é…ç½®ã€‚ä»¥ä¸‹æ­¥éª¤å°†å®‰è£… <code>maturin</code>ï¼Œç”¨å®ƒç”Ÿæˆå¹¶æ„å»ºä¸€ä¸ªæ–°çš„ Python åŒ…ï¼Œç„¶åå¯åŠ¨ Python å¯¼å…¥å¹¶è°ƒç”¨å…¶ä¸­çš„å‡½æ•°ã€‚</p>
<p>é¦–å…ˆï¼Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤åˆ›å»ºä¸€ä¸ªæ–°ç›®å½•å’Œå¯¹åº”çš„ Python <code>virtualenv</code>ï¼Œå¹¶ä½¿ç”¨ Python åŒ…ç®¡ç†å™¨ <code>pip</code> å°† <code>maturin</code> å®‰è£…åˆ°è™šæ‹Ÿç¯å¢ƒä¸­ï¼š</p>
<pre><code class="language-bash"># (å°† string_sum æ›¿æ¢ä¸ºä½ æƒ³è¦çš„åŒ…å)
$ mkdir string_sum
$ cd string_sum
$ python -m venv .env
$ source .env/bin/activate
$ pip install maturin
</code></pre>
<p>ä»åœ¨ <code>string_sum</code> ç›®å½•ä¸­ï¼Œè¿è¡Œ <code>maturin init</code>ã€‚è¯¥å‘½ä»¤å°†ç”Ÿæˆæ–°çš„åŒ…æºç ã€‚å½“æç¤ºé€‰æ‹©ç»‘å®šæ–¹å¼æ—¶ï¼Œè¯·é€‰æ‹© pyo3 ç»‘å®šï¼š</p>
<pre><code class="language-bash">$ maturin init
âœ” ğŸ¤· What kind of bindings to use? Â· pyo3
  âœ¨ Done! New project created string_sum
</code></pre>
<p>è¯¥å‘½ä»¤ç”Ÿæˆçš„æœ€é‡è¦æ–‡ä»¶æ˜¯ <code>Cargo.toml</code> å’Œ <code>lib.rs</code>ï¼Œå¤§è‡´å†…å®¹å¦‚ä¸‹ï¼š</p>
<p><strong><code>Cargo.toml</code></strong></p>
<pre><code class="language-toml">[package]
name = "string_sum"
version = "0.1.0"
edition = "2021"

[lib]
# åŸç”Ÿåº“çš„åç§°ï¼ŒPython ä¸­å¯¼å…¥æ—¶å°†ä½¿ç”¨æ­¤åç§°ï¼ˆä¾‹å¦‚ `import string_sum`ï¼‰ã€‚
# å¦‚æœä¿®æ”¹æ­¤åç§°ï¼Œä¹Ÿå¿…é¡»åŒæ­¥ä¿®æ”¹ `src/lib.rs` ä¸­ `#[pymodule]` çš„æ¨¡å—åã€‚
name = "string_sum"
# "cdylib" ç”¨äºç”Ÿæˆ Python å¯å¯¼å…¥çš„å…±äº«åº“ã€‚
#
# ä¸‹æ¸¸ Rust ä»£ç ï¼ˆåŒ…æ‹¬ `bin/`ã€`examples/` å’Œ `tests/` ä¸­çš„ä»£ç ï¼‰è‹¥æƒ³ä½¿ç”¨ `use string_sum;`
# åˆ™è¿˜éœ€æ·»åŠ  "rlib" æˆ– "lib" ç±»å‹ï¼Œä¾‹å¦‚ï¼š
# crate-type = ["cdylib", "rlib"]
crate-type = ["cdylib"]

[dependencies]
pyo3 = { version = "0.27.2", features = ["extension-module"] }
</code></pre>
<p><strong><code>src/lib.rs</code></strong></p>
<pre><code class="language-rust">/// ä¸€ä¸ªç”¨ Rust å®ç°çš„ Python æ¨¡å—ã€‚æ­¤æ¨¡å—åç§°å¿…é¡»ä¸ Cargo.toml ä¸­çš„ `lib.name`
/// ä¿æŒä¸€è‡´ï¼Œå¦åˆ™ Python æ— æ³•å¯¼å…¥è¯¥æ¨¡å—ã€‚
#[pyo3::pymodule]
mod string_sum {
  use pyo3::prelude::*;

  /// å°†ä¸¤ä¸ªæ•°çš„å’Œæ ¼å¼åŒ–ä¸ºå­—ç¬¦ä¸²ã€‚
  #[pyfunction]
  fn sum_as_string(a: usize, b: usize) -&gt; PyResult&lt;String&gt; {
    Ok((a + b).to_string())
  }
}</code></pre>
<p>æœ€åè¿è¡Œ <code>maturin develop</code>ã€‚è¯¥å‘½ä»¤å°†æ„å»ºåŒ…å¹¶å®‰è£…åˆ°ä¹‹å‰åˆ›å»ºå’Œæ¿€æ´»çš„ Python è™šæ‹Ÿç¯å¢ƒä¸­ã€‚ä¹‹åå³å¯åœ¨ <code>python</code> ä¸­ä½¿ç”¨è¯¥åŒ…ï¼š</p>
<pre><code class="language-bash">$ maturin develop
# maturin ç¼–è¯‘è¿‡ç¨‹ä¸­ä¼šè¾“å‡ºå¤§é‡è¿›åº¦ä¿¡æ¯...
$ python
&gt;&gt;&gt; import string_sum
&gt;&gt;&gt; string_sum.sum_as_string(5, 20)
'25'
</code></pre>
<p>å¦‚éœ€ä¿®æ”¹åŒ…å†…å®¹ï¼Œåªéœ€ç¼–è¾‘ Rust æºç ï¼Œç„¶åé‡æ–°è¿è¡Œ <code>maturin develop</code> ä»¥é‡æ–°ç¼–è¯‘ã€‚</p>
<p>è‹¥æƒ³ä¸€é”®å¤åˆ¶ç²˜è´´æ‰§è¡Œå…¨éƒ¨æµç¨‹ï¼Œå¯ä½¿ç”¨ä¸‹æ–¹çš„ bash è„šæœ¬ï¼ˆå°†ç¬¬ä¸€è¡Œçš„ <code>string_sum</code> æ›¿æ¢ä¸ºä½ æƒ³è¦çš„åŒ…åï¼‰ï¼š</p>
<pre><code class="language-bash">mkdir string_sum &amp;&amp; cd "$_"
python -m venv .env
source .env/bin/activate
pip install maturin
maturin init --bindings pyo3
maturin develop
</code></pre>
<p>å¦‚æœä½ å¸Œæœ›è¿è¡Œ <code>cargo test</code> æˆ–å°†æ­¤é¡¹ç›®ç”¨äº Cargo å·¥ä½œåŒºä½†é‡åˆ°é“¾æ¥å™¨é—®é¢˜ï¼Œå¯å‚è€ƒ <a href="https://pyo3.rs/latest/faq.html#i-cant-run-cargo-test-or-i-cant-build-in-a-cargo-workspace-im-having-linker-issues-like-symbol-not-found-or-undefined-reference-to-_pyexc_systemerror">FAQ</a> ä¸­çš„è§£å†³æ–¹æ¡ˆã€‚</p>
<p>é™¤äº†ä½¿ç”¨ <code>maturin</code>ï¼Œè¿˜å¯ä»¥é€šè¿‡ <a href="https://github.com/PyO3/setuptools-rust"><code>setuptools-rust</code></a> æˆ– <a href="https://pyo3.rs/latest/building-and-distribution.html#manual-builds">æ‰‹åŠ¨æ–¹å¼</a> æ„å»ºã€‚è¿™ä¸¤ç§æ–¹å¼æ¯” <code>maturin</code> æ›´çµæ´»ï¼Œä½†åˆå§‹é…ç½®æ›´å¤æ‚ã€‚</p>
<h3 id="åœ¨-rust-ä¸­ä½¿ç”¨-python"><a class="header" href="#åœ¨-rust-ä¸­ä½¿ç”¨-python">åœ¨ Rust ä¸­ä½¿ç”¨ Python</a></h3>
<p>è‹¥è¦åœ¨ Rust äºŒè¿›åˆ¶ç¨‹åºä¸­åµŒå…¥ Pythonï¼Œéœ€ç¡®ä¿ä½ çš„ Python å®‰è£…åŒ…å«å…±äº«åº“ã€‚ä»¥ä¸‹æ­¥éª¤å°†æ¼”ç¤ºå¦‚ä½•ç¡®ä¿è¿™ä¸€ç‚¹ï¼ˆä»¥ Ubuntu ä¸ºä¾‹ï¼‰ï¼Œå¹¶æä¾›ä¸€æ®µåµŒå…¥ Python è§£é‡Šå™¨çš„ç¤ºä¾‹ä»£ç ã€‚</p>
<p>åœ¨ Ubuntu ä¸Šå®‰è£… Python å…±äº«åº“ï¼š</p>
<pre><code class="language-bash">sudo apt install python3-dev
</code></pre>
<p>åœ¨åŸºäº RPM çš„å‘è¡Œç‰ˆï¼ˆå¦‚ Fedoraã€Red Hatã€SuSEï¼‰ä¸Šï¼Œå®‰è£… <code>python3-devel</code> åŒ…å³å¯ã€‚</p>
<p>ä½¿ç”¨ <code>cargo new</code> åˆ›å»ºæ–°é¡¹ç›®ï¼Œå¹¶åœ¨ <code>Cargo.toml</code> ä¸­æ·»åŠ  <code>pyo3</code> ä¾èµ–ï¼š</p>
<pre><code class="language-toml">[dependencies.pyo3]
version = "0.27.2"
features = ["auto-initialize"]
</code></pre>
<p>ç¤ºä¾‹ç¨‹åºï¼šæ˜¾ç¤º <code>sys.version</code> çš„å€¼å’Œå½“å‰ç”¨æˆ·åï¼š</p>
<pre><code class="language-rust">use pyo3::prelude::*;
use pyo3::types::IntoPyDict;
use pyo3::ffi::c_str;

fn main() -&gt; PyResult&lt;()&gt; {
    Python::attach(|py| {
        let sys = py.import("sys")?;
        let version: String = sys.getattr("version")?.extract()?;

        let locals = [("os", py.import("os")?)].into_py_dict(py)?;
        let code = c_str!("os.getenv('USER') or os.getenv('USERNAME') or 'Unknown'");
        let user: String = py.eval(code, None, Some(&amp;locals))?.extract()?;

        println!("Hello {}, I'm Python {}", user, version);
        Ok(())
    })
}</code></pre>
<p>æœ¬æŒ‡å—çš„ <a href="https://pyo3.rs/latest/python-from-rust.html">ç›¸å…³ç« èŠ‚</a> æä¾›äº†å¤§é‡å…³äºè¯¥ä¸»é¢˜çš„ç¤ºä¾‹ã€‚</p>
<h2 id="å·¥å…·ä¸åº“"><a class="header" href="#å·¥å…·ä¸åº“">å·¥å…·ä¸åº“</a></h2>
<ul>
<li><a href="https://github.com/PyO3/maturin">maturin</a> <em>å°†å¸¦æœ‰ pyo3ã€rust-cpython æˆ– cffi ç»‘å®šçš„ crate ä»¥åŠ Rust äºŒè¿›åˆ¶æ–‡ä»¶æ‰“åŒ…ä¸º Python åŒ…çš„æ„å»ºä¸å‘å¸ƒå·¥å…·</em></li>
<li><a href="https://github.com/PyO3/setuptools-rust">setuptools-rust</a> <em>æ”¯æŒ Rust çš„ Setuptools æ’ä»¶</em></li>
<li><a href="https://github.com/PyO3/pyo3-built">pyo3-built</a> <em>ç®€å•å®ï¼Œç”¨äºå°† <a href="https://crates.io/crates/built"><code>built</code></a> crate è·å–çš„å…ƒæ•°æ®æš´éœ²ä¸º <a href="https://docs.rs/pyo3/*/pyo3/types/struct.PyDict.html"><code>PyDict</code></a></em></li>
<li><a href="https://github.com/PyO3/rust-numpy">rust-numpy</a> <em>NumPy C-API çš„ Rust ç»‘å®š</em></li>
<li><a href="https://github.com/gperinazzo/dict-derive">dict-derive</a> <em>æ´¾ç”Ÿ FromPyObjectï¼Œè‡ªåŠ¨å°† Python å­—å…¸è½¬æ¢ä¸º Rust ç»“æ„ä½“</em></li>
<li><a href="https://github.com/vorner/pyo3-log">pyo3-log</a> <em>Rust æ—¥å¿—åˆ° Python æ—¥å¿—çš„æ¡¥æ¥</em></li>
<li><a href="https://github.com/davidhewitt/pythonize">pythonize</a> <em>Serde åºåˆ—åŒ–å™¨ï¼Œç”¨äºå°† Rust å¯¹è±¡è½¬æ¢ä¸º JSON å…¼å®¹çš„ Python å¯¹è±¡</em></li>
<li><a href="https://github.com/PyO3/pyo3-async-runtimes">pyo3-async-runtimes</a> <em>æ”¯æŒ Python Asyncio åº“ä¸ Rust å¼‚æ­¥è¿è¡Œæ—¶äº’æ“ä½œçš„å·¥å…·</em></li>
<li><a href="https://github.com/mityax/rustimport">rustimport</a> <em>ç›´æ¥ä» Python å¯¼å…¥ Rust æ–‡ä»¶æˆ– crateï¼Œæ— éœ€æ‰‹åŠ¨ç¼–è¯‘ã€‚é»˜è®¤æä¾› pyo3 é›†æˆå¹¶è‡ªåŠ¨ç”Ÿæˆ pyo3 ç»‘å®šä»£ç </em></li>
<li><a href="https://crates.io/crates/pyo3-arrow">pyo3-arrow</a> <em>ä¸º pyo3 æä¾›è½»é‡çº§ <a href="https://arrow.apache.org/">Apache Arrow</a> é›†æˆ</em></li>
<li><a href="https://crates.io/crates/pyo3-bytes">pyo3-bytes</a> <em><code>bytes</code> crate ä¸ pyo3 çš„é›†æˆ</em></li>
<li><a href="https://github.com/developmentseed/obstore/tree/main/pyo3-object_store">pyo3-object_store</a> <em><code>object_store</code> crate ä¸ <code>pyo3</code> çš„é›†æˆ</em></li>
</ul>
<h2 id="ç¤ºä¾‹é¡¹ç›®"><a class="header" href="#ç¤ºä¾‹é¡¹ç›®">ç¤ºä¾‹é¡¹ç›®</a></h2>
<ul>
<li><a href="https://github.com/kylebarron/arro3">arro3</a> <em>æç®€çš„ Apache Arrow Python åº“ï¼Œè¿æ¥ Rust çš„ arrow crate</em>
<ul>
<li><a href="https://github.com/kylebarron/arro3/tree/main/arro3-compute">arro3-compute</a> <em><code>arro3-compute</code></em></li>
<li><a href="https://github.com/kylebarron/arro3/tree/main/arro3-core">arro3-core</a> <em><code>arro3-core</code></em></li>
<li><a href="https://github.com/kylebarron/arro3/tree/main/arro3-io">arro3-io</a> <em><code>arro3-io</code></em></li>
</ul>
</li>
<li><a href="https://github.com/fastlmm/bed-reader">bed-reader</a> <em>ç®€å•é«˜æ•ˆåœ°è¯»å†™ PLINK BED æ ¼å¼</em>
<ul>
<li>å±•ç¤ºäº† Rayon/ndarray::parallelï¼ˆåŒ…æ‹¬é”™è¯¯æ•è·ã€çº¿ç¨‹æ•°æ§åˆ¶ï¼‰ã€Python ç±»å‹åˆ° Rust æ³›å‹çš„è½¬æ¢ã€Github Actions ç­‰æŠ€æœ¯- <a href="https://github.com/oconnor663/blake3-py">blake3-py</a> <em>ä¸º<a href="https://github.com/BLAKE3-team/BLAKE3">BLAKE3</a>åŠ å¯†å“ˆå¸Œå‡½æ•°æä¾›çš„Pythonç»‘å®šã€‚</em></li>
<li>åœ¨GitHub Actionsä¸Šä¸ºMacOSã€Linuxå’ŒWindowså¹¶è¡Œæ„å»ºï¼ŒåŒ…å«å…è´¹çº¿ç¨‹çš„3.13tè½®å­åŒ…ã€‚</li>
</ul>
</li>
<li><a href="https://cellular-raza.com">cellular_raza</a> <em>ä¸€ä¸ªåŸºäºç»†èƒä»£ç†çš„æ¨¡æ‹Ÿæ¡†æ¶ï¼Œç”¨äºä»é›¶å¼€å§‹æ„å»ºå¤æ‚æ¨¡å‹ã€‚</em></li>
<li><a href="https://github.com/sfu-db/connector-x/tree/main/connectorx-python">connector-x</a> <em>ä½¿ç”¨Rustå’ŒPythonå®ç°çš„æœ€å¿«æ•°æ®åº“åˆ°DataFrameçš„æ•°æ®åŠ è½½åº“ã€‚</em></li>
<li><a href="https://github.com/pyca/cryptography/tree/main/src/rust">cryptography</a> <em>PythonåŠ å¯†åº“ï¼Œéƒ¨åˆ†åŠŸèƒ½ä»¥Rustç¼–å†™ã€‚</em></li>
<li><a href="https://github.com/Stranger6667/css-inline/tree/master/bindings/python">css-inline</a> <em>ç”¨Rustå®ç°çš„Python CSSå†…è”å·¥å…·ã€‚</em></li>
<li><a href="https://github.com/apache/arrow-datafusion-python">datafusion-python</a> <em>ç»‘å®šApache Arrowå†…å­˜ä¸­æŸ¥è¯¢å¼•æ“DataFusionçš„Pythonåº“ã€‚</em></li>
<li><a href="https://github.com/delta-io/delta-rs/tree/main/python">deltalake-python</a> <em>åŸºäºdelta-rså¹¶é›†æˆPandasçš„åŸç”ŸDelta Lake Pythonç»‘å®šã€‚</em></li>
<li><a href="https://github.com/yankun1992/fastbloom">fastbloom</a> <em>ä½¿ç”¨Rustä¸ºRustå’ŒPythonå®ç°çš„å¿«é€Ÿ<a href="https://github.com/yankun1992/fastbloom#BloomFilter">bloom filter</a> | <a href="https://github.com/yankun1992/fastbloom#countingbloomfilter">è®¡æ•°å‹bloom filter</a>ï¼</em></li>
<li><a href="https://github.com/thedrow/fastuuid/">fastuuid</a> <em>Rust UUIDåº“çš„Pythonç»‘å®šã€‚</em></li>
<li><a href="https://github.com/feos-org/feos">feos</a> <em>ä½¿ç”¨Rustå®ç°é—ªç”µèˆ¬å¿«é€Ÿçš„çƒ­åŠ›å­¦å»ºæ¨¡ï¼Œå¹¶æä¾›å®Œæ•´çš„Pythonæ¥å£ã€‚</em></li>
<li><a href="https://github.com/Nnamdi-sys/finalytics">finalytics</a> <em>ä½¿ç”¨Rust | Pythonç¼–å†™çš„æŠ•èµ„åˆ†æåº“ã€‚</em></li>
<li><a href="https://github.com/jinlow/forust">forust</a> <em>ä½¿ç”¨Rustç¼–å†™çš„è½»é‡çº§æ¢¯åº¦æå‡å†³ç­–æ ‘åº“ã€‚</em></li>
<li><a href="https://github.com/kylebarron/geo-index">geo-index</a> <em>ä¸€ä¸ªRust crateå’Œ<a href="https://github.com/kylebarron/geo-index/tree/main/python">Pythonåº“</a>ï¼Œç”¨äºå®ç°æ‰“åŒ…ã€ä¸å¯å˜ã€é›¶æ‹·è´çš„ç©ºé—´ç´¢å¼•ã€‚</em></li>
<li><a href="https://github.com/emmett-framework/granian">granian</a> <em>ä¸ºPythonåº”ç”¨æœåŠ¡çš„Rust HTTPæœåŠ¡å™¨ã€‚</em></li>
<li><a href="https://github.com/BooleanCat/haem">haem</a> <em>ç”¨äºè§£å†³ç”Ÿç‰©ä¿¡æ¯å­¦é—®é¢˜çš„Pythonåº“ã€‚</em></li>
<li><a href="https://github.com/deedy5/html2text_rs">html2text-rs</a> <em>ç”¨äºå°†HTMLè½¬æ¢ä¸ºæ ‡è®°æˆ–çº¯æ–‡æœ¬çš„Pythonåº“ã€‚</em></li>
<li><a href="https://github.com/PyO3/setuptools-rust/tree/main/examples/html-py-ever">html-py-ever</a> <em>é€šè¿‡<a href="https://github.com/kuchiki-rs/kuchiki">kuchiki</a>ä½¿ç”¨<a href="https://github.com/servo/html5ever">html5ever</a>åŠ é€ŸHTMLè§£æå’ŒCSSé€‰æ‹©ã€‚</em></li>
<li><a href="https://github.com/apache/hudi-rs">hudi-rs</a> <em>Apache Hudiçš„åŸç”ŸRustå®ç°ï¼Œæä¾›C++ä¸Python APIç»‘å®šã€‚</em></li>
<li><a href="https://github.com/m-ou-se/inline-python">inline-python</a> <em>ç›´æ¥åœ¨Rustä»£ç ä¸­åµŒå…¥Pythonä»£ç ã€‚</em></li>
<li><a href="https://github.com/kushaldas/johnnycanencrypt">johnnycanencrypt</a> æ”¯æŒYubikeyçš„OpenPGPåº“ã€‚</li>
<li><a href="https://github.com/Stranger6667/jsonschema/tree/master/crates/jsonschema-py">jsonschema</a> <em>ç”¨äºPythonçš„é«˜æ€§èƒ½JSON SchemaéªŒè¯å™¨ã€‚</em></li>
<li><a href="https://github.com/cds-astro/mocpy">mocpy</a> <em>å¤©æ–‡å­¦Pythonåº“ï¼Œæä¾›æè¿°å•ä½çƒä½“ä¸Šä»»æ„è¦†ç›–åŒºåŸŸçš„æ•°æ®ç»“æ„ã€‚</em></li>
<li><a href="https://github.com/developmentseed/obstore">obstore</a> <em>ç”±Rusté©±åŠ¨çš„æœ€ç®€å•ã€æœ€é«˜ååé‡çš„Pythonæ¥å£ï¼Œæ”¯æŒAmazon S3ã€Google Cloud Storageã€Azure StorageåŠå…¶ä»–å…¼å®¹S3çš„APIã€‚</em></li>
<li><a href="https://github.com/apache/opendal/tree/main/bindings/python">opendal</a> <em>æ•°æ®è®¿é—®å±‚ï¼Œå…è®¸ç”¨æˆ·ä»¥ç»Ÿä¸€æ–¹å¼è½»æ¾é«˜æ•ˆåœ°ä»å„ç§å­˜å‚¨æœåŠ¡ä¸­è·å–æ•°æ®ã€‚</em></li>
<li><a href="https://github.com/ijl/orjson">orjson</a> <em>å¿«é€Ÿçš„Python JSONåº“ã€‚</em></li>
<li><a href="https://github.com/aviramha/ormsgpack">ormsgpack</a> <em>å¿«é€Ÿçš„Python msgpackåº“ã€‚</em></li>
<li><a href="https://github.com/pola-rs/polars">polars</a> <em>ç”¨Rust | Python | Node.jså®ç°çš„å¿«é€Ÿå¤šçº¿ç¨‹DataFrameåº“ã€‚</em></li>
<li><a href="https://github.com/jupyter-server/pycrdt">pycrdt</a> <em>ä¸ºRust CRDTå®ç°<a href="https://github.com/y-crdt/y-crdt">Yrs</a>æä¾›çš„Pythonç»‘å®šã€‚</em></li>
<li><a href="https://github.com/pydantic/pydantic-core">pydantic-core</a> <em>ç”¨Rustç¼–å†™çš„pydanticæ ¸å¿ƒéªŒè¯é€»è¾‘ã€‚</em></li>
<li><a href="https://github.com/deedy5/primp">primp</a> <em>æœ€å¿«çš„Python HTTPå®¢æˆ·ç«¯ï¼Œå¯é€šè¿‡æ¨¡ä»¿æµè§ˆå™¨å¤´éƒ¨åŠTLS/JA3/JA4/HTTP2æŒ‡çº¹æ¥ä¼ªè£…æˆç½‘é¡µæµè§ˆå™¨ã€‚</em></li>
<li><a href="https://github.com/pkalivas/radiate">radiate</a>: <em>ç”¨äºé—ä¼ ç¼–ç¨‹å’Œè¿›åŒ–ç®—æ³•çš„é«˜æ€§èƒ½æ¼”åŒ–å¼•æ“ã€‚</em></li>
<li><a href="https://github.com/attack68/rateslib">rateslib</a> <em>ä½¿ç”¨Rustæ‰©å±•çš„Pythonå›ºå®šæ”¶ç›Šåº“ã€‚</em></li>
<li><a href="https://github.com/online-ml/river">river</a> <em>åŸºäºPythonçš„åœ¨çº¿æœºå™¨å­¦ä¹ åº“ï¼Œè®¡ç®—å¯†é›†å‹ç»Ÿè®¡ç®—æ³•ç”±Rustå®ç°ã€‚</em></li>
<li><a href="https://github.com/sparckles/Robyn">robyn</a> ä¸€ä¸ªåŸºäºRustè¿è¡Œæ—¶çš„è¶…å¿«é€Ÿå¼‚æ­¥Python Webæ¡†æ¶ã€‚</li>
<li><a href="https://github.com/cjermain/rust-python-coverage">rust-python-coverage</a> <em>å¸¦è‡ªåŠ¨åŒ–æµ‹è¯•è¦†ç›–ç‡ï¼ˆRustä¸Pythonï¼‰çš„PyO3ç¤ºä¾‹é¡¹ç›®ã€‚</em></li>
<li><a href="https://github.com/0x676e67/rnet">rnet</a> å¸¦æœ‰é»‘é­”æ³•çš„å¼‚æ­¥Python HTTPå®¢æˆ·ç«¯</li>
<li><a href="https://github.com/lakehq/sail">sail</a> <em>ç»Ÿä¸€æµã€æ‰¹å¤„ç†å’ŒAIå·¥ä½œè´Ÿè½½ï¼Œå…¼å®¹Apache Sparkã€‚</em></li>
<li><a href="https://github.com/openai/tiktoken">tiktoken</a> <em>ç”¨äºOpenAIæ¨¡å‹çš„å¿«é€ŸBPEåˆ†è¯å™¨ã€‚</em></li>
<li><a href="https://github.com/huggingface/tokenizers/tree/main/bindings/python">tokenizers</a> <em>Hugging Faceï¼ˆNLPï¼‰åˆ†è¯å™¨çš„Pythonç»‘å®šï¼Œç”±Rustç¼–å†™ã€‚</em></li>
<li><a href="http://github.com/ringsaturn/tzfpy">tzfpy</a> <em>å¿«é€Ÿå°†ç»åº¦/çº¬åº¦è½¬æ¢ä¸ºæ—¶åŒºåç§°çš„åŒ…ã€‚</em></li>
<li><a href="https://github.com/jessekrubin/utiles">utiles</a> <em>å¿«é€Ÿçš„Pythonç½‘ç»œåœ°å›¾ç“¦ç‰‡å·¥å…·</em></li>
</ul>
<h2 id="æ–‡ç« å’Œå…¶ä»–åª’ä½“"><a class="header" href="#æ–‡ç« å’Œå…¶ä»–åª’ä½“">æ–‡ç« å’Œå…¶ä»–åª’ä½“</a></h2>
<ul>
<li><a href="https://www.youtube.com/watch?v=J7phN_M4GLM">(è§†é¢‘) åœ¨å…è´¹çº¿ç¨‹ä¸å¸¸è§„Python 3.13ä¸­ä½¿ç”¨Rust</a> - 2025å¹´6æœˆ4æ—¥</li>
<li><a href="https://www.youtube.com/watch?v=KTQn_PTHNCw">(è§†é¢‘) äº”å¹´æ¥åœ¨Pythonä¸­å¼•å…¥Rustçš„ç»éªŒæ€»ç»“</a> - 2025å¹´2æœˆ26æ—¥</li>
<li><a href="https://www.youtube.com/watch?v=P47JUMSQagU">(æ’­å®¢) è¿æ¥Pythonä¸Rustï¼šå¯¹PyO3ç»´æŠ¤è€…David Hewittçš„ä¸“è®¿</a> - 2024å¹´8æœˆ30æ—¥</li>
<li><a href="https://www.youtube.com/watch?v=UmL_CA-v3O8">(è§†é¢‘) PyO3ï¼šä»Pythonåˆ°Rustï¼Œå†å›åˆ°Python</a> - 2024å¹´7æœˆ3æ—¥</li>
<li><a href="https://www.gauge.sh/blog/parsing-python-asts-20x-faster-with-rust">ä½¿ç”¨Rustå°†Python ASTè§£æé€Ÿåº¦æå‡20å€</a> - 2024å¹´6æœˆ17æ—¥</li>
<li><a href="https://www.youtube.com/watch?v=UilujdubqVU">(è§†é¢‘) Pythonå¦‚ä½•é€šè¿‡PyO3åˆ©ç”¨Rust</a> - 2024å¹´5æœˆ18æ—¥</li>
<li><a href="https://www.youtube.com/watch?v=lyG6AKzu4ew">(è§†é¢‘) ç»“åˆRustä¸Pythonï¼šä¸¤è€…å…¼å¾—ï¼Ÿ</a> - 2024å¹´3æœˆ1æ—¥</li>
<li><a href="https://www.youtube.com/watch?v=T45ZEmSR1-s">(è§†é¢‘) ä½¿ç”¨PyO3é€šè¿‡Rustæ‰©å±•Python</a> - 2023å¹´12æœˆ16æ—¥</li>
<li><a href="https://terencezl.github.io/blog/2023/06/06/a-week-of-pyo3-rust-numpy/">ä¸€å‘¨PyO3 + rust-numpyå®è·µï¼ˆå¦‚ä½•å°†ä½ çš„æ•°æ®æµæ°´çº¿æé€Ÿè‹¥å¹²å€ï¼‰</a> - 2023å¹´6æœˆ6æ—¥</li>
<li><a href="https://rustacean-station.org/episode/david-hewitt/">(æ’­å®¢) ä¸David HewittèŠèŠPyO3</a> - 2023å¹´5æœˆ19æ—¥</li>
<li><a href="https://ohadravid.github.io/posts/2023-03-rusty-python/">ä½¿ç”¨ä¸åˆ°100è¡ŒRustä»£ç è®©Pythonæé€Ÿ100å€</a> - 2023å¹´3æœˆ28æ—¥</li>
<li><a href="https://fosdem.org/2023/schedule/event/rust_how_pydantic_v2_leverages_rusts_superpowers/">Pydantic V2å¦‚ä½•åˆ©ç”¨Rustçš„å¼ºå¤§èƒ½åŠ›</a> - 2023å¹´2æœˆ4æ—¥</li>
<li><a href="https://boring-guy.sh/posts/river-rust/">æˆ‘ä»¬å¦‚ä½•ä½¿ç”¨PyO3ä¸ºRiverç»Ÿè®¡æ¨¡å—å¢åŠ Rustæ”¯æŒ</a> - 2022å¹´12æœˆ23æ—¥</li>
<li><a href="https://towardsdatascience.com/nine-rules-for-writing-python-extensions-in-rust-d35ea3a4ec29?sk=f8d808d5f414154fdb811e4137011437">ç¼–å†™Pythonæ‰©å±•çš„ä¹æ¡Rustè§„åˆ™</a> - 2021å¹´12æœˆ31æ—¥</li>
<li><a href="https://saidvandeklundert.net/learn/2021-11-18-calling-rust-from-python-using-pyo3/">ä½¿ç”¨PyO3ä»Pythonè°ƒç”¨Rust</a> - 2021å¹´11æœˆ18æ—¥</li>
<li><a href="https://www.youtube.com/watch?v=-XyWG_klSAw&amp;t=320s">Davidhewittåœ¨2021å¹´Rustæ›¼å½»æ–¯ç‰¹èšä¼šçš„æ¼”è®²</a> - 2021å¹´8æœˆ19æ—¥</li>
<li><a href="https://blog.waleedkhan.name/port-python-to-rust/">é€æ­¥å°†ä¸€ä¸ªå°çš„Pythoné¡¹ç›®è¿ç§»åˆ°Rust</a> - 2021å¹´4æœˆ29æ—¥</li>
<li><a href="https://www.vortexa.com/blog/integrating-rust-into-python">Vortexa - å°†Rusté›†æˆåˆ°Pythonä¸­</a> - 2021å¹´4æœˆ12æ—¥</li>
<li><a href="https://blog.yossarian.net/2020/08/02/Writing-and-publishing-a-python-module-in-rust">ç¼–å†™å¹¶å‘å¸ƒä¸€ä¸ªRustç¼–å†™çš„Pythonæ¨¡å—</a> - 2020å¹´8æœˆ2æ—¥</li>
</ul>
<h2 id="è´¡çŒ®"><a class="header" href="#è´¡çŒ®">è´¡çŒ®</a></h2>
<p>æ¬¢è¿æ‰€æœ‰äººå‚ä¸PyO3é¡¹ç›®ï¼ä½ å¯ä»¥é€šè¿‡å¤šç§æ–¹å¼æ”¯æŒæœ¬é¡¹ç›®ï¼Œä¾‹å¦‚ï¼š</p>
<ul>
<li>åœ¨GitHubå’Œ<a href="https://discord.gg/33kcChzH7f">Discord</a>ä¸Šå¸®åŠ©PyO3ç”¨æˆ·è§£å†³é—®é¢˜</li>
<li>æ”¹è¿›æ–‡æ¡£</li>
<li>ç¼–å†™æ–°åŠŸèƒ½æˆ–ä¿®å¤æ¼æ´</li>
<li>å‘å¸ƒå…³äºå¦‚ä½•ä½¿ç”¨PyO3çš„åšå®¢å’Œç¤ºä¾‹</li>
</ul>
<p>å¦‚æœä½ æƒ³è´¡çŒ®æ—¶é—´ä½†ä¸çŸ¥é“ä»ä½•å¼€å§‹ï¼Œå¯ä»¥å‚è€ƒæˆ‘ä»¬çš„<a href="https://github.com/PyO3/pyo3/blob/main/Contributing.md">è´¡çŒ®æŒ‡å—</a>å’Œ<a href="https://github.com/PyO3/pyo3/blob/main/Architecture.md">æ¶æ„æŒ‡å—</a>è·å–æ›´å¤šèµ„æºã€‚</p>
<p>å¦‚æœä½ æ²¡æœ‰æ—¶é—´äº²è‡ªè´¡çŒ®ä½†ä»å¸Œæœ›æ”¯æŒé¡¹ç›®çš„æœªæ¥å‘å±•ï¼Œéƒ¨åˆ†ç»´æŠ¤è€…æä¾›äº†GitHubèµåŠ©é¡µé¢ï¼š</p>
<ul>
<li><a href="https://github.com/sponsors/davidhewitt">davidhewitt</a></li>
<li><a href="https://github.com/sponsors/messense">messense</a></li>
</ul>
<h2 id="è®¸å¯è¯"><a class="header" href="#è®¸å¯è¯">è®¸å¯è¯</a></h2>
<p>PyO3åœ¨<a href="LICENSE-APACHE">Apache-2.0è®¸å¯è¯</a>æˆ–<a href="LICENSE-MIT">MITè®¸å¯è¯</a>ä¸‹æˆæƒï¼Œç”±ä½ é€‰æ‹©ã€‚</p>
<p>Pythonåœ¨<a href="https://docs.python.org/3/license.html">Pythonè®¸å¯è¯</a>ä¸‹æˆæƒã€‚</p>
<p>é™¤éä½ æ˜ç¡®å£°æ˜ï¼Œä»»ä½•ä½ æœ‰æ„æäº¤ç»™PyO3çš„è´¡çŒ®ï¼Œæ ¹æ®Apacheè®¸å¯è¯å®šä¹‰ï¼Œå°†ä»¥ä¸Šè¿°åŒé‡è®¸å¯è¯æˆæƒï¼Œä¸å†é™„åŠ å…¶ä»–æ¡æ¬¾æˆ–æ¡ä»¶ã€‚</p>
<p><a href="https://www.netlify.com"> <img src="https://www.netlify.com/v3/img/components/netlify-color-accent.svg" alt="ç”±Netlifyéƒ¨ç½²" /> </a></p>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="å®‰è£…"><a class="header" href="#å®‰è£…">å®‰è£…</a></h1>
<p>è¦å¼€å§‹ä½¿ç”¨ PyO3ï¼Œä½ éœ€è¦ä¸‰æ ·ä¸œè¥¿ï¼šRust å·¥å…·é“¾ã€Python ç¯å¢ƒä»¥åŠæ„å»ºæ–¹å¼ã€‚æˆ‘ä»¬å°†åœ¨ä¸‹é¢é€ä¸€ä»‹ç»ã€‚</p>
<blockquote>
<p>å¦‚æœä½ æƒ³ä¸ PyO3 ç»´æŠ¤è€…å’Œå…¶ä»– PyO3 ç”¨æˆ·äº¤æµï¼Œè¯·è€ƒè™‘åŠ å…¥ <a href="https://discord.gg/33kcChzH7f">PyO3 Discord æœåŠ¡å™¨</a>ã€‚æˆ‘ä»¬å¾ˆå¸Œæœ›èƒ½å¬åˆ°ä½ åˆå­¦è€…çš„ä½“éªŒï¼Œä»¥ä¾¿è®© PyO3 å¯¹æ‰€æœ‰äººéƒ½æ›´æ˜“ç”¨ï¼</p>
</blockquote>
<h2 id="rust"><a class="header" href="#rust">Rust</a></h2>
<p>é¦–å…ˆï¼Œç¡®ä¿ä½ çš„ç³»ç»Ÿä¸Šå·²å®‰è£… Rustã€‚å¦‚æœå°šæœªå®‰è£…ï¼Œè¯·å‚è€ƒ <a href="https://www.rust-lang.org/tools/install">æ­¤å¤„</a> çš„è¯´æ˜è¿›è¡Œå®‰è£…ã€‚PyO3 æ”¯æŒ <code>stable</code> å’Œ <code>nightly</code> ç‰ˆæœ¬ï¼Œå› æ­¤ä½ å¯ä»¥é€‰æ‹©æœ€é€‚åˆè‡ªå·±çš„ç‰ˆæœ¬ã€‚æœ€ä½è¦æ±‚çš„ Rust ç‰ˆæœ¬ä¸º 1.74ã€‚</p>
<p>å¦‚æœä½ å¯ä»¥è¿è¡Œ <code>rustc --version</code> ä¸”ç‰ˆæœ¬è¶³å¤Ÿæ–°ï¼Œå°±å¯ä»¥ç»§ç»­äº†ï¼</p>
<h2 id="python"><a class="header" href="#python">Python</a></h2>
<p>ä½¿ç”¨ PyO3 éœ€è¦è‡³å°‘ Python 3.7ã€‚è™½ç„¶ä½ å¯ä»¥ç›´æ¥ä½¿ç”¨ç³»ç»Ÿé»˜è®¤çš„ Python è§£é‡Šå™¨ï¼Œä½†å»ºè®®ä½¿ç”¨è™šæ‹Ÿç¯å¢ƒã€‚</p>
<h2 id="è™šæ‹Ÿç¯å¢ƒ"><a class="header" href="#è™šæ‹Ÿç¯å¢ƒ">è™šæ‹Ÿç¯å¢ƒ</a></h2>
<p>è™½ç„¶ä½ å¯ä»¥ä½¿ç”¨ä»»ä½•ä½ å–œæ¬¢çš„è™šæ‹Ÿç¯å¢ƒç®¡ç†å·¥å…·ï¼Œä½†æˆ‘ä»¬ç‰¹åˆ«æ¨èä½¿ç”¨ <code>pyenv</code>ï¼Œå°¤å…¶æ˜¯å½“ä½ å¸Œæœ›ä¸ºå¤šä¸ªä¸åŒç‰ˆæœ¬çš„ Python è¿›è¡Œå¼€å‘æˆ–æµ‹è¯•æ—¶ã€‚æœ¬ä¹¦ä¸­çš„ç¤ºä¾‹å°†ä½¿ç”¨ <code>pyenv</code>ã€‚<code>pyenv</code> çš„å®‰è£…è¯´æ˜å¯åœ¨æ­¤å¤„æ‰¾åˆ°ï¼š<a href="https://github.com/pyenv/pyenv#a-getting-pyenv">è¿™é‡Œ</a>ã€‚ï¼ˆæ³¨æ„ï¼šè¦ä½¿ç”¨ <code>pyenv activate</code> å’Œ <code>pyenv virtualenv</code> å‘½ä»¤ï¼Œä½ è¿˜éœ€å®‰è£… <a href="https://github.com/pyenv/pyenv-virtualenv"><code>pyenv-virtualenv</code></a> æ’ä»¶ã€‚<a href="https://github.com/pyenv/pyenv-installer#installation--update--uninstallation">pyenv å®‰è£…ç¨‹åº</a> å¯åŒæ—¶å®‰è£…ä¸¤è€…ã€‚ï¼‰</p>
<p>åœ¨ä½¿ç”¨ <code>pyenv</code> å®‰è£…æ—¶ä¿ç•™æºä»£ç å¯èƒ½ä¼šå¯¹ä»¥åçš„è°ƒè¯•æœ‰å¸®åŠ©ï¼Œè¿™æ ·å°†æ¥è°ƒè¯•æ—¶å°±èƒ½çœ‹åˆ°åŸå§‹çš„æºæ–‡ä»¶ã€‚å¯ä»¥é€šè¿‡åœ¨ <code>pyenv install</code> å‘½ä»¤ä¸­æ·»åŠ  <code>--keep</code> æ ‡å¿—æ¥å®ç°ã€‚</p>
<p>ä¾‹å¦‚ï¼š</p>
<pre><code class="language-bash">pyenv install 3.12 --keep
</code></pre>
<h3 id="æ„å»º"><a class="header" href="#æ„å»º">æ„å»º</a></h3>
<p>æœ‰å¤šç§æ„å»ºå’Œ Python åŒ…ç®¡ç†ç³»ç»Ÿå¯ä¾›é€‰æ‹©ï¼Œæ¯”å¦‚ <a href="https://github.com/PyO3/setuptools-rust"><code>setuptools-rust</code></a> æˆ– <a href="#manual-builds">æ‰‹åŠ¨æ„å»º</a>ã€‚æˆ‘ä»¬æ¨èä½¿ç”¨ <code>maturin</code>ï¼Œä½ å¯ä»¥åœ¨è¿™é‡Œå®‰è£…ï¼š<a href="https://maturin.rs/installation.html">maturin.rs/installation.html</a>ã€‚<code>maturin</code> æ˜¯ä¸“ä¸ºä¸ PyO3 ååŒå¼€å‘è€Œè®¾è®¡çš„ï¼Œæä¾›äº†æœ€å®Œæ•´çš„â€œå¼€ç®±å³ç”¨â€ä½“éªŒï¼Œç‰¹åˆ«æ˜¯å¦‚æœä½ è®¡åˆ’å‘å¸ƒåˆ° PyPIã€‚<code>maturin</code> æœ¬èº«åªæ˜¯ä¸€ä¸ª Python åŒ…ï¼Œå› æ­¤ä½ å¯ä»¥åƒå®‰è£…å…¶ä»– Python åŒ…ä¸€æ ·å®‰è£…å®ƒã€‚</p>
<p>ç³»ç»Ÿ Pythonï¼š</p>
<pre><code class="language-bash">pip install maturin --user
</code></pre>
<p>pipxï¼š</p>
<pre><code class="language-bash">pipx install maturin
</code></pre>
<p>pyenvï¼š</p>
<pre><code class="language-bash">pyenv activate pyo3
pip install maturin
</code></pre>
<p>poetryï¼š</p>
<pre><code class="language-bash">poetry add -G dev maturin
</code></pre>
<p>å®‰è£…å®Œæˆåï¼Œä½ å¯ä»¥è¿è¡Œ <code>maturin --version</code> æ¥ç¡®è®¤æ˜¯å¦æ­£ç¡®å®‰è£…ã€‚</p>
<h2 id="åˆ›å»ºæ–°é¡¹ç›®"><a class="header" href="#åˆ›å»ºæ–°é¡¹ç›®">åˆ›å»ºæ–°é¡¹ç›®</a></h2>
<p>é¦–å…ˆï¼Œä½ åº”è¯¥åˆ›å»ºä¸€ä¸ªç›®å½•å’Œè™šæ‹Ÿç¯å¢ƒæ¥å­˜æ”¾ä½ çš„æ–°é¡¹ç›®ã€‚è¿™é‡Œæˆ‘ä»¬å°†ä½¿ç”¨æ¨èçš„ <code>pyenv</code>ï¼š</p>
<pre><code class="language-bash">mkdir pyo3-example
cd pyo3-example
pyenv virtualenv pyo3
pyenv local pyo3
</code></pre>
<p>ä¹‹åï¼Œä½ åº”è¯¥å®‰è£…ä½ çš„æ„å»ºç®¡ç†å·¥å…·ã€‚åœ¨æ­¤ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ <code>maturin</code>ã€‚æ¿€æ´»è™šæ‹Ÿç¯å¢ƒåï¼Œå°† <code>maturin</code> å®‰è£…åˆ°å…¶ä¸­ï¼š</p>
<pre><code class="language-bash">pip install maturin
</code></pre>
<p>ç°åœ¨ä½ å¯ä»¥åˆå§‹åŒ–æ–°é¡¹ç›®äº†ï¼š</p>
<pre><code class="language-bash">maturin init
</code></pre>
<p>å¦‚æœ <code>maturin</code> å·²ç»å®‰è£…ï¼Œä½ ä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨å®ƒåˆ›å»ºæ–°é¡¹ç›®ï¼š</p>
<pre><code class="language-bash">maturin new -b pyo3 pyo3-example
cd pyo3-example
pyenv virtualenv pyo3
pyenv local pyo3
</code></pre>
<h2 id="æ·»åŠ åˆ°å·²æœ‰é¡¹ç›®"><a class="header" href="#æ·»åŠ åˆ°å·²æœ‰é¡¹ç›®">æ·»åŠ åˆ°å·²æœ‰é¡¹ç›®</a></h2>
<p>é—æ†¾çš„æ˜¯ï¼Œç›®å‰ <code>maturin</code> æ— æ³•åœ¨å·²æœ‰é¡¹ç›®ä¸­è¿è¡Œã€‚å› æ­¤ï¼Œå¦‚æœä½ æƒ³åœ¨å·²æœ‰é¡¹ç›®ä¸­ä½¿ç”¨ Pythonï¼ŒåŸºæœ¬ä¸Šæœ‰ä¸¤ä¸ªé€‰æ‹©ï¼š</p>
<ol>
<li>æŒ‰ç…§ä¸Šè¿°æ–¹æ³•åˆ›å»ºä¸€ä¸ªæ–°é¡¹ç›®ï¼Œå¹¶å°†ç°æœ‰ä»£ç ç§»å…¥è¯¥é¡¹ç›®</li>
<li>æ‰‹åŠ¨ç¼–è¾‘é¡¹ç›®é…ç½®æ–‡ä»¶</li>
</ol>
<p>å¦‚æœä½ é€‰æ‹©ç¬¬äºŒç§æ–¹å¼ï¼Œéœ€è¦æ³¨æ„ä»¥ä¸‹å‡ ç‚¹ï¼š</p>
<h2 id="cargotoml"><a class="header" href="#cargotoml">Cargo.toml</a></h2>
<p>è¯·ç¡®ä¿ä½ å¸Œæœ›ä» Python è®¿é—®çš„ Rust crate è¢«ç¼–è¯‘ä¸ºåº“ã€‚ä½ ä¹Ÿå¯ä»¥åŒæ—¶ç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶ï¼Œä½†ä½ æƒ³ä» Python è®¿é—®çš„ä»£ç å¿…é¡»ä½äºåº“éƒ¨åˆ†ã€‚æ­¤å¤–ï¼Œè¯·ç¡®ä¿ crate ç±»å‹ä¸º <code>cdylib</code>ï¼Œå¹¶å°† PyO3 æ·»åŠ ä¸ºä¾èµ–é¡¹ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre><code class="language-toml"># å¦‚æœä½ çš„ `Cargo.toml` ä¸­å·²æœ‰ [package] ä¿¡æ¯ï¼Œå¯ä»¥å¿½ç•¥è¿™ä¸€éƒ¨åˆ†ï¼
[package]
# è¿™é‡Œçš„ `name` æ˜¯åŒ…çš„åç§°ã€‚
name = "pyo3_start"
# è¿™äº›æ˜¯è‰¯å¥½çš„é»˜è®¤è®¾ç½®ï¼š
version = "0.1.0"
edition = "2021"

[lib]
# åŸç”Ÿåº“çš„åç§°ã€‚è¿™æ˜¯ Python ä¸­å¯¼å…¥åº“æ—¶ä½¿ç”¨çš„åç§°ï¼ˆä¾‹å¦‚ `import string_sum`ï¼‰ã€‚
# å¦‚æœä½ æ›´æ”¹äº†è¿™ä¸ªåç§°ï¼Œä¹Ÿå¿…é¡»æ›´æ”¹ `src/lib.rs` ä¸­ `#[pymodule]` çš„åç§°ã€‚
name = "pyo3_example"

# "cdylib" æ˜¯ç”Ÿæˆ Python å¯å¯¼å…¥çš„å…±äº«åº“æ‰€å¿…éœ€çš„ã€‚
crate-type = ["cdylib"]

[dependencies]
pyo3 = { {{#PYO3_CRATE_VERSION}}, features = ["extension-module"] }
</code></pre>
<h2 id="pyprojecttoml"><a class="header" href="#pyprojecttoml">pyproject.toml</a></h2>
<p>ä½ ä¹Ÿåº”è¯¥åˆ›å»ºä¸€ä¸ªåŒ…å«ä»¥ä¸‹å†…å®¹çš„ <code>pyproject.toml</code> æ–‡ä»¶ï¼š</p>
<pre><code class="language-toml">[build-system]
requires = ["maturin&gt;=1,&lt;2"]
build-backend = "maturin"

[project]
name = "pyo3_example"
requires-python = "&gt;=3.7"
classifiers = [
    "Programming Language :: Rust",
    "Programming Language :: Python :: Implementation :: CPython",
    "Programming Language :: Python :: Implementation :: PyPy",
]
</code></pre>
<h2 id="è¿è¡Œä»£ç "><a class="header" href="#è¿è¡Œä»£ç ">è¿è¡Œä»£ç </a></h2>
<p>æ¥ä¸‹æ¥ï¼Œä½ å¯ä»¥è®¾ç½® Rust ä»£ç ä»¥åœ¨ Python ä¸­ä½¿ç”¨ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼›ä¾‹å¦‚ï¼Œå¯å°†ä»¥ä¸‹ä»£ç æ”¾å…¥ <code>src/lib.rs</code>ï¼š</p>
<pre><code class="language-rust no_run">/// ä¸€ä¸ªç”¨ Rust å®ç°çš„ Python æ¨¡å—ã€‚è¯¥å‡½æ•°çš„åç§°å¿…é¡»ä¸ `Cargo.toml` ä¸­çš„ `lib.name` ä¸€è‡´ï¼Œ
/// å¦åˆ™ Python å°†æ— æ³•å¯¼å…¥è¯¥æ¨¡å—ã€‚
#[pyo3::pymodule]
mod pyo3_example {
    use pyo3::prelude::*;

    /// å°†ä¸¤ä¸ªæ•°å­—çš„å’Œæ ¼å¼åŒ–ä¸ºå­—ç¬¦ä¸²ã€‚
    #[pyfunction]
    fn sum_as_string(a: usize, b: usize) -&gt; PyResult&lt;String&gt; {
        Ok((a + b).to_string())
    }
}</code></pre>
<p>ç°åœ¨ä½ å¯ä»¥è¿è¡Œ <code>maturin develop</code> æ¥å‡†å¤‡ Python åŒ…ï¼Œä¹‹åå°±å¯ä»¥åƒè¿™æ ·ä½¿ç”¨å®ƒï¼š</p>
<pre><code class="language-bash">$ maturin develop
# maturin æ‰§è¡Œç¼–è¯‘æ—¶ä¼šè¾“å‡ºå¤§é‡è¿›åº¦ä¿¡æ¯...
$ python
&gt;&gt;&gt; import pyo3_example
&gt;&gt;&gt; pyo3_example.sum_as_string(5, 20)
'25'
</code></pre>
<p>æœ‰å…³å¦‚ä½•åœ¨ Rust ä¸­ä½¿ç”¨ Python ä»£ç çš„æ›´å¤šè¯´æ˜ï¼Œè¯·å‚é˜… <a href="#åœ¨-rust-ä»£ç ä¸­è°ƒç”¨-python">Rust ä¸­çš„ Python</a> é¡µé¢ã€‚</p>
<h2 id="maturin-å¯¼å…¥é’©å­"><a class="header" href="#maturin-å¯¼å…¥é’©å­">Maturin å¯¼å…¥é’©å­</a></h2>
<p>åœ¨å¼€å‘è¿‡ç¨‹ä¸­ï¼Œæ¯æ¬¡ä»£ç å˜æ›´åéƒ½éœ€è¦è¿è¡Œ <code>maturin develop</code> æ‰èƒ½æµ‹è¯•ã€‚ä¸ºäº†ç®€åŒ–å¼€å‘æµç¨‹ï¼Œä½ å¯ä»¥å®‰è£… <a href="https://github.com/PyO3/maturin-import-hook">Maturin Import Hook</a>ï¼Œå®ƒä¼šåœ¨å¯¼å…¥å«æœ‰æ›´æ”¹çš„åº“æ—¶è‡ªåŠ¨è¿è¡Œ <code>maturin develop</code>ã€‚</p>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="åœ¨-python-ä¸­ä½¿ç”¨-rust-1"><a class="header" href="#åœ¨-python-ä¸­ä½¿ç”¨-rust-1">åœ¨ Python ä¸­ä½¿ç”¨ Rust</a></h1>
<p>æœ¬ç« æ—¨åœ¨ä»‹ç»å¦‚ä½•å°† Rust ä»£ç å°è£…ä¸º Python å¯¹è±¡ã€‚</p>
<p>PyO3 åˆ©ç”¨ Rust çš„â€œè¿‡ç¨‹å®â€æä¾›äº†ä¸€ä¸ªåŠŸèƒ½å¼ºå¤§ yet ç®€å•æ˜“ç”¨çš„ APIï¼Œç”¨ä»¥å£°æ˜å“ªäº› Rust ä»£ç åº”æ˜ å°„ä¸º Python å¯¹è±¡ã€‚</p>
<p>PyO3 å¯ä»¥åˆ›å»ºä¸‰ç§ç±»å‹çš„ Python å¯¹è±¡ï¼š</p>
<ul>
<li>é€šè¿‡ <code>#[pymodule]</code> å®åˆ›å»º Python æ¨¡å—</li>
<li>é€šè¿‡ <code>#[pyfunction]</code> å®åˆ›å»º Python å‡½æ•°</li>
<li>é€šè¿‡ <code>#[pyclass]</code> å®ï¼ˆä»¥åŠç”¨äºå®šä¹‰ç±»æ–¹æ³•çš„ <code>#[pymethods]</code>ï¼‰åˆ›å»º Python ç±»</li>
</ul>
<p>æ¥ä¸‹æ¥çš„å„ä¸ªå°èŠ‚å°†ä¾æ¬¡è¯¦ç»†ä»‹ç»è¿™ä¸‰ç§å¯¹è±¡ã€‚</p>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="python-æ¨¡å—"><a class="header" href="#python-æ¨¡å—">Python æ¨¡å—</a></h1>
<p>ä½ å¯ä»¥ä½¿ç”¨ <code>#[pymodule]</code> åˆ›å»ºä¸€ä¸ªæ¨¡å—ï¼š</p>
<pre><code class="language-rust no_run"><span class="boring">mod declarative_module_basic_test {
</span>use pyo3::prelude::*;


#[pyfunction]
fn double(x: usize) -&gt; usize {
    x * 2
}


/// æœ¬æ¨¡å—ä½¿ç”¨ Rust å®ç°ã€‚
#[pymodule]
mod my_extension {
    use pyo3::prelude::*;


    #[pymodule_export]
    use super::double; // å°† double å‡½æ•°æš´éœ²ç»™ Pythonï¼Œç±»ä¹Ÿå¯ä»¥è¿™æ ·å¯¼å‡º


    #[pyfunction] // å†…è”å®šä¹‰ä¸€ä¸ª pyfunctionï¼Œå¹¶æš´éœ²ç»™ Python
    fn triple(x: usize) -&gt; usize {
        x * 3
    }
}
<span class="boring">}</span></code></pre>
<p><code>#[pymodule]</code> è¿‡ç¨‹å®è´Ÿè´£åˆ›å»ºæ¨¡å—çš„åˆå§‹åŒ–å‡½æ•°å¹¶å°†å…¶æš´éœ²ç»™ Pythonã€‚</p>
<p>æ¨¡å—çš„é»˜è®¤åç§°æ˜¯å¯¹åº” Rust æ¨¡å—çš„åç§°ã€‚ä½ å¯ä»¥ä½¿ç”¨ <code>#[pyo3(name = "custom_name")]</code> æ¥è¦†ç›–æ¨¡å—åç§°ï¼š</p>
<pre><code class="language-rust no_run"><span class="boring">mod declarative_module_custom_name_test {
</span>use pyo3::prelude::*;


#[pyfunction]
fn double(x: usize) -&gt; usize {
    x * 2
}


#[pymodule(name = "custom_name")]
mod my_extension {
    #[pymodule_export]
    use super::double;
}
<span class="boring">}</span></code></pre>
<p>æ¨¡å—çš„åç§°å¿…é¡»ä¸ç”Ÿæˆçš„ <code>.so</code> æˆ– <code>.pyd</code> æ–‡ä»¶çš„åç§°ä¸€è‡´ã€‚å¦åˆ™ï¼Œåœ¨ Python ä¸­å¯¼å…¥æ—¶å°†ä¼šå‡ºç°å¦‚ä¸‹é”™è¯¯ï¼š
<code>ImportError: dynamic module does not define module export function (PyInit_name_of_your_module)</code></p>
<p>è¦å¯¼å…¥è¯¥æ¨¡å—ï¼Œå¯ä»¥ï¼š</p>
<ul>
<li>æŒ‰ç…§<a href="#manual-builds">æ‰‹åŠ¨æ„å»º</a>ä¸­çš„è¯´æ˜å¤åˆ¶å…±äº«åº“ï¼Œæˆ–è€…</li>
<li>ä½¿ç”¨å·¥å…·ï¼Œä¾‹å¦‚ä½¿ç”¨ <a href="https://github.com/PyO3/maturin">maturin</a> çš„ <code>maturin develop</code>ï¼Œæˆ–ä½¿ç”¨ <a href="https://github.com/PyO3/setuptools-rust">setuptools-rust</a> çš„ <code>python setup.py develop</code>ã€‚</li>
</ul>
<h2 id="æ–‡æ¡£"><a class="header" href="#æ–‡æ¡£">æ–‡æ¡£</a></h2>
<p>Rust æ¨¡å—çš„<a href="https://doc.rust-lang.org/stable/book/ch03-04-comments.html">Rust æ–‡æ¡£æ³¨é‡Š</a>å°†è‡ªåŠ¨ä½œä¸º Python æ¨¡å—çš„ <code>docstring</code> è¢«ä½¿ç”¨ã€‚</p>
<p>ä¾‹å¦‚ï¼ŒåŸºäºä¸Šé¢çš„ä»£ç ï¼Œä»¥ä¸‹ Python ä»£ç ä¼šæ‰“å° <code>This module is implemented in Rust.</code>ï¼š</p>
<pre><code class="language-python">import my_extension


print(my_extension.__doc__)
</code></pre>
<h2 id="python-å­æ¨¡å—"><a class="header" href="#python-å­æ¨¡å—">Python å­æ¨¡å—</a></h2>
<p>ä½ å¯ä»¥é€šè¿‡åƒå¯¼å…¥å‡½æ•°æˆ–ç±»ä¸€æ ·ä½¿ç”¨ <code>use</code> æ¥åœ¨å•ä¸ªæ‰©å±•æ¨¡å—å†…åˆ›å»ºæ¨¡å—å±‚çº§ç»“æ„ã€‚ä¾‹å¦‚ï¼Œä½ å¯ä»¥å®šä¹‰ <code>parent_module</code> å’Œ <code>parent_module.child_module</code> æ¨¡å—ï¼š</p>
<pre><code class="language-rust">use pyo3::prelude::*;


#[pymodule]
mod parent_module {
    #[pymodule_export]
    use super::child_module;
}


#[pymodule]
mod child_module {
    #[pymodule_export]
    use super::func;
}


#[pyfunction]
fn func() -&gt; String {
    "func".to_string()
}
<span class="boring">
</span><span class="boring">fn main() {
</span><span class="boring">  Python::attach(|py| {
</span><span class="boring">      use pyo3::wrap_pymodule;
</span><span class="boring">      use pyo3::types::IntoPyDict;
</span><span class="boring">      use pyo3::ffi::c_str;
</span><span class="boring">      let parent_module = wrap_pymodule!(parent_module)(py);
</span><span class="boring">      let ctx = [("parent_module", parent_module)].into_py_dict(py).unwrap();
</span><span class="boring">
</span><span class="boring">     py.run(c_str!("assert parent_module.child_module.func() == 'func'"), None, Some(&amp;ctx)).unwrap();
</span><span class="boring">  })
</span>}</code></pre>
<p>è¯·æ³¨æ„ï¼Œè¿™å¹¶ä¸ä¼šå®šä¹‰ä¸€ä¸ªåŒ…ï¼ˆpackageï¼‰ï¼Œå› æ­¤æ— æ³•é€šè¿‡ <code>from parent_module import child_module</code> ç›´æ¥åœ¨ Python ä¸­å¯¼å…¥å­æ¨¡å—ã€‚æ›´å¤šä¿¡æ¯è¯·å‚é˜… <a href="https://github.com/PyO3/pyo3/issues/759">#759</a> å’Œ <a href="https://github.com/PyO3/pyo3/issues/1517#issuecomment-808664021">#1517</a>ã€‚</p>
<p>ä½ å¯ä»¥ä¸ºéé¡¶å±‚æ¨¡å—çš„ <code>#[pymodule()]</code> æä¾› <code>submodule</code> å‚æ•°ï¼Œä»¥ä¾¿è‡ªåŠ¨æ­£ç¡®ç”Ÿæˆ <code>#[pyclass]</code> çš„ <code>module</code> å±æ€§ã€‚</p>
<h2 id="å†…è”å£°æ˜"><a class="header" href="#å†…è”å£°æ˜">å†…è”å£°æ˜</a></h2>
<p>ä½ å¯ä»¥åœ¨æ¨¡å—ä¸­å†…è”å£°æ˜å‡½æ•°ã€ç±»ã€å­æ¨¡å—å’Œå¸¸é‡ï¼š</p>
<p>ä¾‹å¦‚ï¼š</p>
<pre><code class="language-rust no_run"><span class="boring">mod declarative_module_test {
</span>#[pyo3::pymodule]
mod my_extension {
    use pyo3::prelude::*;


    #[pymodule_export]
    const PI: f64 = std::f64::consts::PI; // å°† PI å¸¸é‡ä½œä¸ºæ¨¡å—çš„ä¸€éƒ¨åˆ†å¯¼å‡º


    #[pyfunction] // è¿™å°†æ˜¯æ¨¡å—çš„ä¸€éƒ¨åˆ†
    fn double(x: usize) -&gt; usize {
        x * 2
    }


    #[pyclass] // è¿™å°†æ˜¯æ¨¡å—çš„ä¸€éƒ¨åˆ†
    struct Unit;


    #[pymodule]
    mod submodule {
        // è¿™æ˜¯ä¸€ä¸ªå­æ¨¡å—
        use pyo3::prelude::*;


        #[pyclass]
        struct Nested;
    }
}
<span class="boring">}</span></code></pre>
<p>åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œ<code>#[pymodule]</code> å®ä¼šè‡ªåŠ¨ä½¿ç”¨å…¶åç§°è®¾ç½®å†…éƒ¨å£°æ˜çš„ <code>#[pyclass]</code> å®çš„ <code>module</code> å±æ€§ã€‚å¯¹äºåµŒå¥—æ¨¡å—ï¼Œçˆ¶æ¨¡å—çš„åç§°ä¼šè‡ªåŠ¨æ·»åŠ ã€‚åœ¨å‰é¢çš„ä¾‹å­ä¸­ï¼Œ<code>Nested</code> ç±»çš„ <code>module</code> å°†æ˜¯ <code>my_extension.submodule</code>ã€‚</p>
<h2 id="è¿‡ç¨‹å¼åˆå§‹åŒ–"><a class="header" href="#è¿‡ç¨‹å¼åˆå§‹åŒ–">è¿‡ç¨‹å¼åˆå§‹åŒ–</a></h2>
<p>å¦‚æœ PyO3 æä¾›çš„å®ä¸è¶³ä»¥æ»¡è¶³éœ€æ±‚ï¼Œè¿˜å¯ä»¥åœ¨æ¨¡å—åˆå§‹åŒ–æ—¶è¿è¡Œè‡ªå®šä¹‰ä»£ç ï¼š</p>
<pre><code class="language-rust no_run"><span class="boring">mod procedural_module_test {
</span>#[pyo3::pymodule]
mod my_extension {
    use pyo3::prelude::*;


    #[pyfunction]
    fn double(x: usize) -&gt; usize {
        x * 2
    }


    #[pymodule_init]
    fn init(m: &amp;Bound&lt;'_, PyModule&gt;) -&gt; PyResult&lt;()&gt; {
        // åœ¨æ¨¡å—åˆå§‹åŒ–æ—¶è¿è¡Œä»»æ„ä»£ç 
        m.add("double2", m.getattr("double")?)
    }
}
<span class="boring">}</span></code></pre>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="python-å‡½æ•°"><a class="header" href="#python-å‡½æ•°">Python å‡½æ•°</a></h1>
<p><code>#[pyfunction]</code> å±æ€§ç”¨äºä» Rust å‡½æ•°å®šä¹‰ä¸€ä¸ª Python å‡½æ•°ã€‚å®šä¹‰åï¼Œè¯¥å‡½æ•°éœ€è¦è¢«æ·»åŠ åˆ°ä¸€ä¸ª<a href="#python-æ¨¡å—">æ¨¡å—</a>ä¸­ã€‚</p>
<p>ä»¥ä¸‹ç¤ºä¾‹å®šä¹‰äº†ä¸€ä¸ªåä¸º <code>double</code> çš„å‡½æ•°ï¼Œå¹¶å°†å…¶ç½®äºåä¸º <code>my_extension</code> çš„ Python æ¨¡å—ä¸­ï¼š</p>
<pre><code class="language-rust no_run">#[pyo3::pymodule]
mod my_extension {
    use pyo3::prelude::*;


    #[pyfunction]
    fn double(x: usize) -&gt; usize {
        x * 2
    }
}</code></pre>
<p>æœ¬æŒ‡å—çš„è¿™ä¸€ç« èŠ‚å°†è¯¦ç»†ä»‹ç» <code>#[pyfunction]</code> å±æ€§çš„å®Œæ•´ç”¨æ³•ã€‚åœ¨æœ¬èŠ‚ä¸­ï¼Œæ¶µç›–ä»¥ä¸‹ä¸»é¢˜ï¼š</p>
<ul>
<li><a href="#function-options">å‡½æ•°é€‰é¡¹</a>
<ul>
<li><a href="#name"><code>#[pyo3(name = "...")]</code></a></li>
<li><a href="#signature"><code>#[pyo3(signature = (...))]</code></a></li>
<li><a href="#text_signature"><code>#[pyo3(text_signature = "...")]</code></a></li>
<li><a href="#pass_module"><code>#[pyo3(pass_module)]</code></a></li>
<li><a href="#warn"><code>#[pyo3(warn(message = "...", category = ...))]</code></a></li>
</ul>
</li>
<li><a href="#per-argument-options">å•ä¸ªå‚æ•°é€‰é¡¹</a></li>
<li><a href="#advanced-function-patterns">é«˜çº§å‡½æ•°æ¨¡å¼</a></li>
</ul>
<p>æ­¤å¤–è¿˜æœ‰å…³äºä»¥ä¸‹ä¸»é¢˜çš„é¢å¤–ç« èŠ‚ï¼š</p>
<ul>
<li><a href="#å‡½æ•°ç­¾å">å‡½æ•°ç­¾å</a></li>
<li><a href="#é”™è¯¯å¤„ç†">é”™è¯¯å¤„ç†</a></li>
</ul>
<h2 id="å‡½æ•°é€‰é¡¹"><a class="header" href="#å‡½æ•°é€‰é¡¹">å‡½æ•°é€‰é¡¹</a></h2>
<p><code>#[pyo3]</code> å±æ€§å¯ç”¨äºä¿®æ”¹ç”Ÿæˆçš„ Python å‡½æ•°çš„å±æ€§ã€‚å¯ä»¥ä»»æ„ç»„åˆä½¿ç”¨ä»¥ä¸‹é€‰é¡¹ï¼š</p>
<ul>
<li>
<p><a id="name"></a> <code>#[pyo3(name = "...")]</code></p>
<p>è¦†ç›–æš´éœ²ç»™ Python çš„å‡½æ•°åã€‚</p>
<p>åœ¨ä»¥ä¸‹ç¤ºä¾‹ä¸­ï¼ŒRust å‡½æ•° <code>no_args_py</code> å°†ä½œä¸º Python å‡½æ•° <code>no_args</code> æ·»åŠ åˆ° Python æ¨¡å— <code>module_with_functions</code> ä¸­ï¼š</p>
<pre><code class="language-rust"><span class="boring">use pyo3::prelude::*;
</span>#[pyo3::pymodule]
mod module_with_functions {
    use pyo3::prelude::*;


    #[pyfunction]
    #[pyo3(name = "no_args")]
    fn no_args_py() -&gt; usize {
        42
    }
}


<span class="boring">Python::attach(|py| {
</span><span class="boring">    let m = pyo3::wrap_pymodule!(module_with_functions)(py);
</span><span class="boring">    assert!(m.getattr(py, "no_args").is_ok());
</span><span class="boring">    assert!(m.getattr(py, "no_args_py").is_err());
</span><span class="boring">});</span></code></pre>
</li>
<li>
<p><a id="signature"></a> <code>#[pyo3(signature = (...))]</code></p>
<p>å®šä¹‰ Python ä¸­çš„å‡½æ•°ç­¾åã€‚å‚è§ <a href="#å‡½æ•°ç­¾å">å‡½æ•°ç­¾å</a>ã€‚</p>
</li>
<li>
<p><a id="text_signature"></a> <code>#[pyo3(text_signature = "...")]</code></p>
<p>è¦†ç›– PyO3 ç”Ÿæˆçš„ã€åœ¨ Python å·¥å…·ï¼ˆå¦‚ <a href="https://docs.python.org/3/library/inspect.html#inspect.signature"><code>inspect.signature</code></a>ï¼‰ä¸­å¯è§çš„å‡½æ•°ç­¾åã€‚è¯¦è§ <a href="#making-the-function-signature-available-to-python">å‡½æ•°ç­¾åå­ç« èŠ‚ä¸­çš„å¯¹åº”å†…å®¹</a>ã€‚</p>
</li>
<li>
<p><a id="pass_module"></a> <code>#[pyo3(pass_module)]</code></p>
<p>è®¾ç½®æ­¤é€‰é¡¹åï¼ŒPyO3 ä¼šå°†åŒ…å«è¯¥å‡½æ•°çš„æ¨¡å—ä½œä¸ºç¬¬ä¸€ä¸ªå‚æ•°ä¼ é€’ç»™å‡½æ•°ï¼Œä»è€Œå¯ä»¥åœ¨å‡½æ•°ä½“ä¸­ä½¿ç”¨è¯¥æ¨¡å—ã€‚ç¬¬ä¸€ä¸ªå‚æ•°<strong>å¿…é¡»</strong>æ˜¯ <code>&amp;Bound&lt;'_, PyModule&gt;</code>ã€<code>Bound&lt;'_, PyModule&gt;</code> æˆ– <code>Py&lt;PyModule&gt;</code> ç±»å‹ã€‚</p>
<p>ä»¥ä¸‹ç¤ºä¾‹åˆ›å»ºäº†ä¸€ä¸ªå‡½æ•° <code>pyfunction_with_module</code>ï¼Œå®ƒè¿”å›å…¶æ‰€åœ¨æ¨¡å—çš„åç§°ï¼ˆå³ <code>module_with_fn</code>ï¼‰ï¼š</p>
<pre><code class="language-rust no_run">#[pyo3::pymodule]
mod module_with_fn {
    use pyo3::prelude::*;
    use pyo3::types::PyString;


    #[pyfunction]
    #[pyo3(pass_module)]
    fn pyfunction_with_module&lt;'py&gt;(
        module: &amp;Bound&lt;'py, PyModule&gt;,
    ) -&gt; PyResult&lt;Bound&lt;'py, PyString&gt;&gt; {
        module.name()
    }
}</code></pre>
</li>
<li>
<p><a id="warn"></a> <code>#[pyo3(warn(message = "...", category = ...))]</code></p>
<p>æ­¤é€‰é¡¹ç”¨äºåœ¨ Python ä¸­ä½¿ç”¨è¯¥å‡½æ•°æ—¶æ˜¾ç¤ºè­¦å‘Šã€‚å…¶æ•ˆæœç­‰åŒäº <a href="https://docs.python.org/3/library/warnings.html#warnings.warn"><code>warnings.warn(message, category)</code></a>ã€‚<code>message</code> å‚æ•°æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œåœ¨è°ƒç”¨å‡½æ•°æ—¶æ˜¾ç¤ºï¼›<code>category</code> å‚æ•°æ˜¯å¯é€‰çš„ï¼Œå¿…é¡»æ˜¯ <a href="https://docs.python.org/3/library/exceptions.html#Warning"><code>Warning</code></a> çš„å­ç±»ã€‚å¦‚æœæœªæä¾› <code>category</code> å‚æ•°ï¼Œåˆ™é»˜è®¤è­¦å‘Šç±»å‹ä¸º <a href="https://docs.python.org/3/library/exceptions.html#UserWarning"><code>UserWarning</code></a>ã€‚</p>
<blockquote>
<p>æ³¨æ„ï¼šå½“ä¸ <code>#[pymethods]</code> ä¸€èµ·ä½¿ç”¨æ—¶ï¼Œæ­¤å±æ€§åœ¨ <code>#[classattr]</code> æˆ– <code>__traverse__</code> ç‰¹æ®Šæ–¹æ³•ä¸Šæ— æ•ˆã€‚</p>
</blockquote>
<p>ä»¥ä¸‹æ˜¯ä½¿ç”¨ <code>#[pyo3(warn)]</code> å±æ€§çš„ç¤ºä¾‹ï¼š</p>
<pre><code class="language-rust">use pyo3::prelude::*;


#[pymodule]
mod raising_warning_fn {
    use pyo3::prelude::pyfunction;
    use pyo3::exceptions::PyFutureWarning;


    #[pyfunction]
    #[pyo3(warn(message = "This is a warning message"))]
    fn function_with_warning() -&gt; usize {
        42
    }


    #[pyfunction]
    #[pyo3(warn(message = "This function is warning with FutureWarning", category = PyFutureWarning))]
    fn function_with_warning_and_custom_category() -&gt; usize {
        42
    }
}


<span class="boring">use pyo3::exceptions::{PyFutureWarning, PyUserWarning};
</span><span class="boring">use pyo3::types::{IntoPyDict, PyList};
</span><span class="boring">use pyo3::PyTypeInfo;
</span><span class="boring">
</span><span class="boring">fn catch_warning(py: Python&lt;'_&gt;, f: impl FnOnce(&amp;Bound&lt;'_, PyList&gt;) -&gt; ()) -&gt; PyResult&lt;()&gt; {
</span><span class="boring">    let warnings = py.import("warnings")?;
</span><span class="boring">    let kwargs = [("record", true)].into_py_dict(py)?;
</span><span class="boring">    let catch_warnings = warnings
</span><span class="boring">        .getattr("catch_warnings")?
</span><span class="boring">        .call((), Some(&amp;kwargs))?;
</span><span class="boring">    let list = catch_warnings.call_method0("__enter__")?.cast_into()?;
</span><span class="boring">    warnings.getattr("simplefilter")?.call1(("always",))?;  // show all warnings
</span><span class="boring">    f(&amp;list);
</span><span class="boring">    catch_warnings
</span><span class="boring">        .call_method1("__exit__", (py.None(), py.None(), py.None()))
</span><span class="boring">        .unwrap();
</span><span class="boring">    Ok(())
</span><span class="boring">}
</span><span class="boring">
</span><span class="boring">macro_rules! assert_warnings {
</span><span class="boring">    ($py:expr, $body:expr, [$(($category:ty, $message:literal)),+] $(,)? ) =&gt; {
</span><span class="boring">        catch_warning($py, |list| {
</span><span class="boring">            $body;
</span><span class="boring">            let expected_warnings = [$((&lt;$category as PyTypeInfo&gt;::type_object($py), $message)),+];
</span><span class="boring">            assert_eq!(list.len(), expected_warnings.len());
</span><span class="boring">            for (warning, (category, message)) in list.iter().zip(expected_warnings) {
</span><span class="boring">                assert!(warning.getattr("category").unwrap().is(&amp;category));
</span><span class="boring">                assert_eq!(
</span><span class="boring">                    warning.getattr("message").unwrap().str().unwrap().to_string_lossy(),
</span><span class="boring">                    message
</span><span class="boring">                );
</span><span class="boring">            }
</span><span class="boring">        }).unwrap();
</span><span class="boring">    };
</span><span class="boring">}
</span><span class="boring">
</span><span class="boring">Python::attach(|py| {
</span><span class="boring">    assert_warnings!(
</span><span class="boring">        py,
</span><span class="boring">        {
</span><span class="boring">            let m = pyo3::wrap_pymodule!(raising_warning_fn)(py);
</span><span class="boring">            let f1 = m.getattr(py, "function_with_warning").unwrap();
</span><span class="boring">            let f2 = m.getattr(py, "function_with_warning_and_custom_category").unwrap();
</span><span class="boring">            f1.call0(py).unwrap();
</span><span class="boring">            f2.call0(py).unwrap();
</span><span class="boring">        },
</span><span class="boring">        [
</span><span class="boring">            (PyUserWarning, "This is a warning message"),
</span><span class="boring">            (
</span><span class="boring">                PyFutureWarning,
</span><span class="boring">                "This function is warning with FutureWarning"
</span><span class="boring">            )
</span><span class="boring">        ]
</span><span class="boring">    );
</span><span class="boring">});</span></code></pre>
<p>å½“ä»¥ä¸‹å‡½æ•°è¢«è°ƒç”¨æ—¶ï¼Œå°†æ˜¾ç¤ºè­¦å‘Šï¼š</p>
<pre><code class="language-python">import warnings
from raising_warning_fn import function_with_warning, function_with_warning_and_custom_category


function_with_warning()
function_with_warning_and_custom_category()
</code></pre>
<p>è­¦å‘Šè¾“å‡ºå¦‚ä¸‹ï¼š</p>
<pre><code class="language-plaintext">UserWarning: This is a warning message
FutureWarning: This function is warning with FutureWarning
</code></pre>
</li>
</ul>
<h2 id="å•ä¸ªå‚æ•°é€‰é¡¹"><a class="header" href="#å•ä¸ªå‚æ•°é€‰é¡¹">å•ä¸ªå‚æ•°é€‰é¡¹</a></h2>
<p><code>#[pyo3]</code> å±æ€§å¯ç”¨äºå•ä¸ªå‚æ•°ï¼Œä»¥ä¿®æ”¹ç”Ÿæˆå‡½æ•°ä¸­å‚æ•°çš„å±æ€§ã€‚å¯ä»»æ„ç»„åˆä½¿ç”¨ä»¥ä¸‹é€‰é¡¹ï¼š</p>
<ul>
<li>
<p><a id="from_py_with"></a> <code>#[pyo3(from_py_with = ...)]</code></p>
<p>è®¾ç½®æ­¤é€‰é¡¹å¯ä¸ºå‚æ•°æŒ‡å®šä¸€ä¸ªè‡ªå®šä¹‰å‡½æ•°ï¼Œç”¨äºå°† Python å‚æ•°è½¬æ¢ä¸ºç›®æ ‡ Rust ç±»å‹ï¼Œè€Œä¸ä½¿ç”¨é»˜è®¤çš„ <code>FromPyObject</code> æå–æ–¹å¼ã€‚è¯¥å‡½æ•°çš„ç­¾åå¿…é¡»ä¸º <code>fn(&amp;Bound&lt;'_, PyAny&gt;) -&gt; PyResult&lt;T&gt;</code>ï¼Œå…¶ä¸­ <code>T</code> æ˜¯è¯¥å‚æ•°çš„ Rust ç±»å‹ã€‚</p>
<p>ä»¥ä¸‹ç¤ºä¾‹ä½¿ç”¨ <code>from_py_with</code> å°†è¾“å…¥çš„ Python å¯¹è±¡è½¬æ¢ä¸ºå…¶é•¿åº¦ï¼š</p>
<pre><code class="language-rust">use pyo3::prelude::*;


fn get_length(obj: &amp;Bound&lt;'_, PyAny&gt;) -&gt; PyResult&lt;usize&gt; {
    obj.len()
}


#[pyfunction]
fn object_length(#[pyo3(from_py_with = get_length)] argument: usize) -&gt; usize {
    argument
}


<span class="boring">Python::attach(|py| {
</span><span class="boring">    let f = pyo3::wrap_pyfunction!(object_length)(py).unwrap();
</span><span class="boring">    assert_eq!(f.call1((vec![1, 2, 3],)).unwrap().extract::&lt;usize&gt;().unwrap(), 3);
</span><span class="boring">});</span></code></pre>
</li>
</ul>
<h2 id="é«˜çº§å‡½æ•°æ¨¡å¼"><a class="header" href="#é«˜çº§å‡½æ•°æ¨¡å¼">é«˜çº§å‡½æ•°æ¨¡å¼</a></h2>
<h3 id="åœ¨-rust-ä¸­è°ƒç”¨-python-å‡½æ•°"><a class="header" href="#åœ¨-rust-ä¸­è°ƒç”¨-python-å‡½æ•°">åœ¨ Rust ä¸­è°ƒç”¨ Python å‡½æ•°</a></h3>
<p>å¯ä»¥å°† Python ä¸­ç”¨ <code>def</code> å®šä¹‰çš„å‡½æ•°å’Œå†…ç½®å‡½æ•°ä¼ é€’ç»™ Rust å‡½æ•°ï¼š<a href="{{#PYO3_DOCS_URL}}/pyo3/types/struct.PyFunction.html"><code>PyFunction</code></a> å¯¹åº”æ™®é€šçš„ Python å‡½æ•°ï¼Œè€Œ <a href="{{#PYO3_DOCS_URL}}/pyo3/types/struct.PyCFunction.html"><code>PyCFunction</code></a> æè¿°å†…ç½®å‡½æ•°ï¼ˆå¦‚ <code>repr()</code>ï¼‰ã€‚</p>
<p>ä½ ä¹Ÿå¯ä»¥ä½¿ç”¨ <a href="{{#PYO3_DOCS_URL}}/pyo3/prelude/trait.PyAnyMethods.html#tymethod.is_callable"><code>Bound&lt;'_, PyAny&gt;::is_callable</code></a> æ£€æŸ¥æ˜¯å¦å¾—åˆ°ä¸€ä¸ªå¯è°ƒç”¨å¯¹è±¡ã€‚<code>is_callable</code> å¯¹å‡½æ•°ï¼ˆåŒ…æ‹¬ lambdaï¼‰ã€æ–¹æ³•ä»¥åŠå…·æœ‰ <code>__call__</code> æ–¹æ³•çš„å¯¹è±¡éƒ½ä¼šè¿”å› <code>true</code>ã€‚ä½ å¯ä»¥ä½¿ç”¨ <a href="{{#PYO3_DOCS_URL}}/pyo3/prelude/trait.PyAnyMethods.html#tymethod.call"><code>Bound&lt;'_, PyAny&gt;::call</code></a> è°ƒç”¨è¯¥å¯¹è±¡ï¼Œç¬¬ä¸€ä¸ªå‚æ•°ä¸ºä½ç½®å‚æ•°ï¼Œç¬¬äºŒä¸ªå‚æ•°ä¸ºå…³é”®å­—å‚æ•°ï¼ˆæˆ– <code>None</code>ï¼‰ã€‚å¦å¤–è¿˜æœ‰ <a href="{{#PYO3_DOCS_URL}}/pyo3/prelude/trait.PyAnyMethods.html#tymethod.call0"><code>Bound&lt;'_, PyAny&gt;::call0</code></a>ï¼ˆæ— å‚æ•°ï¼‰å’Œ <a href="{{#PYO3_DOCS_URL}}/pyo3/prelude/trait.PyAnyMethods.html#tymethod.call1"><code>Bound&lt;'_, PyAny&gt;::call1</code></a>ï¼ˆä»…ä½ç½®å‚æ•°ï¼‰ã€‚</p>
<h3 id="åœ¨-python-ä¸­è°ƒç”¨-rust-å‡½æ•°"><a class="header" href="#åœ¨-python-ä¸­è°ƒç”¨-rust-å‡½æ•°">åœ¨ Python ä¸­è°ƒç”¨ Rust å‡½æ•°</a></h3>
<p>å°† Rust å‡½æ•°è½¬æ¢ä¸º Python å¯¹è±¡çš„æ–¹æ³•å–å†³äºå‡½æ•°ç±»å‹ï¼š</p>
<ul>
<li>å‘½åå‡½æ•°ï¼Œä¾‹å¦‚ <code>fn foo()</code>ï¼šæ·»åŠ  <code>#[pyfunction]</code>ï¼Œç„¶åä½¿ç”¨ <a href="{{#PYO3_DOCS_URL}}/pyo3/macro.wrap_pyfunction.html"><code>wrap_pyfunction!</code></a> è·å–å¯¹åº”çš„ <a href="{{#PYO3_DOCS_URL}}/pyo3/types/struct.PyCFunction.html"><code>PyCFunction</code></a>ã€‚</li>
<li>åŒ¿åå‡½æ•°ï¼ˆæˆ–é—­åŒ…ï¼‰ï¼Œä¾‹å¦‚ <code>foo: fn()</code>ï¼š
<ul>
<li>ä½¿ç”¨ <code>#[pyclass]</code> å®šä¹‰ä¸€ä¸ªç»“æ„ä½“ï¼Œå°†å‡½æ•°å­˜å‚¨ä¸ºå­—æ®µï¼Œå¹¶å®ç° <code>__call__</code> æ¥è°ƒç”¨è¯¥å‡½æ•°ã€‚</li>
<li>æˆ–ä½¿ç”¨ <code>PyCFunction::new_closure</code> ç›´æ¥ä»å‡½æ•°åˆ›å»ºå¯¹è±¡ã€‚</li>
</ul>
</li>
</ul>
<h3 id="è®¿é—®-ffi-å‡½æ•°ä¸ºäº†ä½¿-rust-å‡½æ•°å¯ä»¥ä»-python-è°ƒç”¨pyo3-ä¼šç”Ÿæˆä¸€ä¸ª-extern-c-å‡½æ•°å…¶å…·ä½“ç­¾åå–å†³äº-rust-çš„ç­¾åpyo3-ä¼šé€‰æ‹©æœ€ä¼˜çš„-python-å‚æ•°ä¼ é€’çº¦å®šç„¶åå®ƒå°†å¯¹-rust-å‡½æ•°çš„è°ƒç”¨åµŒå…¥åˆ°è¿™ä¸ª-ffi-åŒ…è£…å‡½æ•°ä¸­è¯¥åŒ…è£…å™¨è´Ÿè´£ä»è¾“å…¥çš„-pyobject-ä¸­æå–æ™®é€šå‚æ•°å’Œå…³é”®å­—å‚æ•°"><a class="header" href="#è®¿é—®-ffi-å‡½æ•°ä¸ºäº†ä½¿-rust-å‡½æ•°å¯ä»¥ä»-python-è°ƒç”¨pyo3-ä¼šç”Ÿæˆä¸€ä¸ª-extern-c-å‡½æ•°å…¶å…·ä½“ç­¾åå–å†³äº-rust-çš„ç­¾åpyo3-ä¼šé€‰æ‹©æœ€ä¼˜çš„-python-å‚æ•°ä¼ é€’çº¦å®šç„¶åå®ƒå°†å¯¹-rust-å‡½æ•°çš„è°ƒç”¨åµŒå…¥åˆ°è¿™ä¸ª-ffi-åŒ…è£…å‡½æ•°ä¸­è¯¥åŒ…è£…å™¨è´Ÿè´£ä»è¾“å…¥çš„-pyobject-ä¸­æå–æ™®é€šå‚æ•°å’Œå…³é”®å­—å‚æ•°">è®¿é—® FFI å‡½æ•°ä¸ºäº†ä½¿ Rust å‡½æ•°å¯ä»¥ä» Python è°ƒç”¨ï¼ŒPyO3 ä¼šç”Ÿæˆä¸€ä¸ª <code>extern "C"</code> å‡½æ•°ï¼Œå…¶å…·ä½“ç­¾åå–å†³äº Rust çš„ç­¾åã€‚ï¼ˆPyO3 ä¼šé€‰æ‹©æœ€ä¼˜çš„ Python å‚æ•°ä¼ é€’çº¦å®šã€‚ï¼‰ç„¶åï¼Œå®ƒå°†å¯¹ Rust å‡½æ•°çš„è°ƒç”¨åµŒå…¥åˆ°è¿™ä¸ª FFI åŒ…è£…å‡½æ•°ä¸­ã€‚è¯¥åŒ…è£…å™¨è´Ÿè´£ä»è¾“å…¥çš„ <code>PyObject</code> ä¸­æå–æ™®é€šå‚æ•°å’Œå…³é”®å­—å‚æ•°ã€‚</a></h3>
<p>å¯ä»¥ä½¿ç”¨ <code>wrap_pyfunction</code> å®ï¼Œå°†ä¸€ä¸ª <code>#[pyfunction]</code> å’Œä¸€ä¸ª <code>Bound&lt;PyModule&gt;</code> ç›´æ¥è½¬æ¢ä¸ºä¸€ä¸ª <code>Bound&lt;PyCFunction&gt;</code>ï¼š<code>wrap_pyfunction!(rust_fun, module)</code>ã€‚</p>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="å‡½æ•°ç­¾å"><a class="header" href="#å‡½æ•°ç­¾å">å‡½æ•°ç­¾å</a></h1>
<p><code>#[pyfunction]</code> å±æ€§è¿˜æ¥å—å‚æ•°æ¥æ§åˆ¶ç”Ÿæˆçš„ Python å‡½æ•°å¦‚ä½•æ¥æ”¶å‚æ•°ã€‚ä¸ Python ä¸€æ ·ï¼Œå‚æ•°å¯ä»¥ä»…ä¸ºä½ç½®å‚æ•°ã€ä»…ä¸ºå…³é”®å­—å‚æ•°ï¼Œæˆ–ä¸¤è€…çš†å¯ã€‚ä¹Ÿå¯ä»¥æ¥æ”¶ <code>*args</code> å‚æ•°åˆ—è¡¨å’Œ <code>**kwargs</code> å­—å…¸ã€‚è¿™äº›å‚æ•°åŒæ ·é€‚ç”¨äº <code>#[pymethods]</code>ï¼Œç›¸å…³å†…å®¹å°†åœ¨æœ¬æŒ‡å—çš„ <a href="#python-ç±»">Python ç±»</a> éƒ¨åˆ†ä»‹ç»ã€‚</p>
<p>é»˜è®¤æƒ…å†µä¸‹ï¼Œä¸ Python ç›¸åŒï¼ŒPyO3 æ¥å—æ‰€æœ‰å‚æ•°ä¸ºä½ç½®æˆ–å…³é”®å­—å‚æ•°ã€‚é»˜è®¤æƒ…å†µä¸‹æ‰€æœ‰å‚æ•°éƒ½æ˜¯å¿…éœ€çš„ã€‚è¯¥è¡Œä¸ºå¯ä»¥é€šè¿‡ <code>#[pyo3(signature = (...))]</code> é€‰é¡¹è¿›è¡Œé…ç½®ï¼Œè¯¥é€‰é¡¹å…è®¸ä½¿ç”¨ Python è¯­æ³•ç¼–å†™å‡½æ•°ç­¾åã€‚</p>
<p>æœ¬æŒ‡å—çš„è¿™ä¸€éƒ¨åˆ†è¯¦ç»†ä»‹ç»äº† <code>#[pyo3(signature = (...))]</code> é€‰é¡¹åŠå…¶ç›¸å…³é€‰é¡¹ <code>#[pyo3(text_signature = "...")]</code> çš„ä½¿ç”¨æ–¹æ³•ã€‚</p>
<h2 id="ä½¿ç”¨-pyo3signature--"><a class="header" href="#ä½¿ç”¨-pyo3signature--">ä½¿ç”¨ <code>#[pyo3(signature = (...))]</code></a></h2>
<p>ä¾‹å¦‚ï¼Œä¸‹é¢çš„å‡½æ•°æ¥å—ä»»æ„å…³é”®å­—å‚æ•°ï¼ˆPython è¯­æ³•ä¸­çš„ <code>**kwargs</code>ï¼‰å¹¶è¿”å›ä¼ å…¥çš„å‚æ•°æ•°é‡ï¼š</p>
<pre><code class="language-rust no_run">#[pyo3::pymodule]
mod module_with_functions {
    use pyo3::prelude::*;
    use pyo3::types::PyDict;


    #[pyfunction]
    #[pyo3(signature = (**kwds))]
    fn num_kwds(kwds: Option&lt;&amp;Bound&lt;'_, PyDict&gt;&gt;) -&gt; usize {
        kwds.map_or(0, |dict| dict.len())
    }
}</code></pre>
<p>ä¸ Python ä¸­ä¸€æ ·ï¼Œç­¾åä¸­å¯ä»¥åŒ…å«ä»¥ä¸‹ç»“æ„ï¼š</p>
<ul>
<li><code>/</code>ï¼šä½ç½®å‚æ•°åˆ†éš”ç¬¦ï¼Œä½äº <code>/</code> ä¹‹å‰çš„æ¯ä¸ªå‚æ•°éƒ½æ˜¯ä»…ä½ç½®å‚æ•°ã€‚</li>
<li><code>*</code>ï¼šå˜é•¿å‚æ•°åˆ†éš”ç¬¦ï¼Œä½äº <code>*</code> ä¹‹åçš„æ¯ä¸ªå‚æ•°éƒ½æ˜¯ä»…å…³é”®å­—å‚æ•°ã€‚</li>
<li><code>*args</code>ï¼šâ€œargsâ€ æ˜¯å˜é•¿å‚æ•°åˆ—è¡¨ã€‚<code>args</code> å‚æ•°çš„ç±»å‹å¿…é¡»æ˜¯ <code>&amp;Bound&lt;'_, PyTuple&gt;</code>ã€‚</li>
<li><code>**kwargs</code>ï¼šâ€œkwargsâ€ ç”¨äºæ¥æ”¶å…³é”®å­—å‚æ•°ã€‚<code>kwargs</code> å‚æ•°çš„ç±»å‹å¿…é¡»æ˜¯ <code>Option&lt;&amp;Bound&lt;'_, PyDict&gt;&gt;</code>ã€‚</li>
<li><code>arg=Value</code>ï¼šå…·æœ‰é»˜è®¤å€¼çš„å‚æ•°ã€‚
å¦‚æœ <code>arg</code> å‚æ•°å®šä¹‰åœ¨å˜é•¿å‚æ•°ä¹‹åï¼Œåˆ™è¢«è§†ä¸ºä»…å…³é”®å­—å‚æ•°ã€‚
æ³¨æ„ <code>Value</code> å¿…é¡»æ˜¯æœ‰æ•ˆçš„ Rust ä»£ç ï¼ŒPyO3 ä¼šç›´æ¥å°†å…¶æ’å…¥ç”Ÿæˆçš„ä»£ç ä¸­è€Œä¸ä½œä¿®æ”¹ã€‚</li>
</ul>
<p>ç¤ºä¾‹ï¼š</p>
<pre><code class="language-rust no_run"><span class="boring">use pyo3::prelude::*;
</span>use pyo3::types::{PyDict, PyTuple};
<span class="boring">
</span><span class="boring">#[pyclass]
</span><span class="boring">struct MyClass {
</span><span class="boring">    num: i32,
</span><span class="boring">}
</span>#[pymethods]
impl MyClass {
    #[new]
    #[pyo3(signature = (num=-1))]
    fn new(num: i32) -&gt; Self {
        MyClass { num }
    }


    #[pyo3(signature = (num=10, *py_args, name="Hello", **py_kwargs))]
    fn method(
        &amp;mut self,
        num: i32,
        py_args: &amp;Bound&lt;'_, PyTuple&gt;,
        name: &amp;str,
        py_kwargs: Option&lt;&amp;Bound&lt;'_, PyDict&gt;&gt;,
    ) -&gt; String {
        let num_before = self.num;
        self.num = num;
        format!(
            "num={} (was previously={}), py_args={:?}, name={}, py_kwargs={:?} ",
            num, num_before, py_args, name, py_kwargs,
        )
    }


    fn make_change(&amp;mut self, num: i32) -&gt; PyResult&lt;String&gt; {
        self.num = num;
        Ok(format!("num={}", self.num))
    }
}</code></pre>
<p>ç±»å‹ä¸º <code>Python</code> çš„å‚æ•°ä¸èƒ½å‡ºç°åœ¨ç­¾åä¸­ï¼š</p>
<pre><code class="language-rust no_run"><span class="boring">#![allow(dead_code)]
</span><span class="boring">use pyo3::prelude::*;
</span>#[pyfunction]
#[pyo3(signature = (lambda))]
pub fn simple_python_bound_function(py: Python&lt;'_&gt;, lambda: Py&lt;PyAny&gt;) -&gt; PyResult&lt;()&gt; {
    Ok(())
}</code></pre>
<p>æ³¨æ„ï¼š<code>/</code> å’Œ <code>*</code> å‚æ•°ï¼ˆå¦‚æœåŒ…å«ï¼‰çš„ä½ç½®å†³å®šäº†å¤„ç†ä½ç½®å’Œå…³é”®å­—å‚æ•°çš„æœºåˆ¶ã€‚åœ¨ Python ä¸­ï¼š</p>
<pre><code class="language-python">import mymodule


mc = mymodule.MyClass()
print(mc.method(44, False, "World", 666, x=44, y=55))
print(mc.method(num=-1, name="World"))
print(mc.make_change(44))
</code></pre>
<p>è¾“å‡ºç»“æœä¸ºï¼š</p>
<pre><code class="language-text">num=44 (was previously=-1), py_args=(False, 'World', 666), name=Hello, py_kwargs=Some({'x': 44, 'y': 55})
num=-1 (was previously=44), py_args=(), name=World, py_kwargs=None
num=44
</code></pre>
<!-- rumdl-disable MD052 - code block in quote confuses linter -->
<blockquote>
<p>æ³¨æ„ï¼šè‹¥è¦ä½¿ç”¨ <code>struct</code> ç­‰å…³é”®å­—ä½œä¸ºå‡½æ•°å‚æ•°ï¼Œè¯·åœ¨ç­¾åå’Œå‡½æ•°å®šä¹‰ä¸­åŒæ—¶ä½¿ç”¨â€œåŸå§‹æ ‡è¯†ç¬¦â€è¯­æ³• <code>r#struct</code>ï¼š</p>
<pre><code class="language-rust no_run"><span class="boring">#![allow(dead_code)]
</span><span class="boring">use pyo3::prelude::*;
</span>#[pyfunction(signature = (r#struct = "foo"))]
fn function_with_keyword(r#struct: &amp;str) {
<span class="boring">    let _ = r#struct;
</span>    /* ... */
}</code></pre>
</blockquote>
<!-- rumdl-enable MD052 -->
<h2 id="ä½¿å‡½æ•°ç­¾åå¯¹-python-å¯è§"><a class="header" href="#ä½¿å‡½æ•°ç­¾åå¯¹-python-å¯è§">ä½¿å‡½æ•°ç­¾åå¯¹ Python å¯è§</a></h2>
<p>å‡½æ•°ç­¾åé€šè¿‡ <code>__text_signature__</code> å±æ€§æš´éœ²ç»™ Pythonã€‚PyO3 ä¼šè‡ªåŠ¨ä¸ºæ¯ä¸ª <code>#[pyfunction]</code> å’Œæ‰€æœ‰ <code>#[pymethods]</code> ä» Rust å‡½æ•°ç”Ÿæˆæ­¤ä¿¡æ¯ï¼Œå¹¶è€ƒè™‘ <code>#[pyo3(signature = (...))]</code> é€‰é¡¹æ‰€åšçš„ä»»ä½•è¦†ç›–ã€‚</p>
<p>è¿™ç§è‡ªåŠ¨ç”Ÿæˆåªèƒ½æ˜¾ç¤ºå­—ç¬¦ä¸²ã€æ•´æ•°ã€å¸ƒå°”ç±»å‹å’Œ <code>None</code> çš„é»˜è®¤å‚æ•°å€¼ã€‚ä»»ä½•å…¶ä»–é»˜è®¤å‚æ•°å°†æ˜¾ç¤ºä¸º <code>...</code>ã€‚ï¼ˆ<code>.pyi</code> ç±»å‹å­˜æ ¹æ–‡ä»¶é€šå¸¸ä¹Ÿä»¥ç›¸åŒæ–¹å¼ä½¿ç”¨ <code>...</code> è¡¨ç¤ºé»˜è®¤å‚æ•°ã€‚ï¼‰</p>
<p>åœ¨éœ€è¦è°ƒæ•´è‡ªåŠ¨ç”Ÿæˆçš„ç­¾åçš„æƒ…å†µä¸‹ï¼Œå¯ä»¥ä½¿ç”¨ <code>#[pyo3(text_signature)]</code> é€‰é¡¹<a href="#è¦†ç›–ç”Ÿæˆçš„ç­¾å">è¦†ç›–</a>å®ƒã€‚</p>
<p>ä¸‹é¢çš„ç¤ºä¾‹åˆ›å»ºä¸€ä¸ªå‡½æ•° <code>add</code>ï¼Œå®ƒæ¥å—ä¸¤ä¸ªä»…ä½ç½®å‚æ•° <code>a</code> å’Œ <code>b</code>ï¼Œå…¶ä¸­ <code>b</code> çš„é»˜è®¤å€¼ä¸º 0ã€‚</p>
<pre><code class="language-rust">use pyo3::prelude::*;


/// æ­¤å‡½æ•°å°†ä¸¤ä¸ªæ— ç¬¦å· 64 ä½æ•´æ•°ç›¸åŠ ã€‚
#[pyfunction]
#[pyo3(signature = (a, b=0, /))]
fn add(a: u64, b: u64) -&gt; u64 {
    a + b
}
<span class="boring">
</span><span class="boring">fn main() -&gt; PyResult&lt;()&gt; {
</span><span class="boring">    Python::attach(|py| {
</span><span class="boring">        let fun = pyo3::wrap_pyfunction!(add, py)?;
</span><span class="boring">
</span><span class="boring">        let doc: String = fun.getattr("__doc__")?.extract()?;
</span><span class="boring">        assert_eq!(doc, "æ­¤å‡½æ•°å°†ä¸¤ä¸ªæ— ç¬¦å· 64 ä½æ•´æ•°ç›¸åŠ ã€‚");
</span><span class="boring">
</span><span class="boring">        let inspect = PyModule::import(py, "inspect")?.getattr("signature")?;
</span><span class="boring">        let sig: String = inspect
</span><span class="boring">            .call1((fun,))?
</span><span class="boring">            .call_method0("__str__")?
</span><span class="boring">            .extract()?;
</span><span class="boring">
</span><span class="boring">        #[cfg(Py_3_8)]  // åœ¨ 3.7 ç‰ˆæœ¬ä¸­ç­¾åä¸ä¼šæ˜¾ç¤º bï¼Œä¸Šæ¸¸ bugï¼Ÿ
</span><span class="boring">        assert_eq!(sig, "(a, b=0, /)");
</span><span class="boring">
</span><span class="boring">        Ok(())
</span><span class="boring">    })
</span><span class="boring">}</span></code></pre>
<p>ä»¥ä¸‹ IPython è¾“å‡ºæ¼”ç¤ºäº†ä» Python å·¥å…·ä¸­å¦‚ä½•çœ‹åˆ°æ­¤ç”Ÿæˆçš„ç­¾åï¼š</p>
<pre><code class="language-text">&gt;&gt;&gt; pyo3_test.add.__text_signature__
'(a, b=..., /)'
&gt;&gt;&gt; pyo3_test.add?
Signature: pyo3_test.add(a, b=0, /)
Docstring: æ­¤å‡½æ•°å°†ä¸¤ä¸ªæ— ç¬¦å· 64 ä½æ•´æ•°ç›¸åŠ ã€‚
Type:      builtin_function_or_method
</code></pre>
<h3 id="è¦†ç›–ç”Ÿæˆçš„ç­¾å"><a class="header" href="#è¦†ç›–ç”Ÿæˆçš„ç­¾å">è¦†ç›–ç”Ÿæˆçš„ç­¾å</a></h3>
<p>å¯ä»¥ä½¿ç”¨ <code>#[pyo3(text_signature = "(&lt;some signature&gt;)")]</code> å±æ€§æ¥è¦†ç›–é»˜è®¤ç”Ÿæˆçš„ç­¾åã€‚</p>
<p>åœ¨ä¸‹é¢çš„ä»£ç ç‰‡æ®µä¸­ï¼Œä½¿ç”¨æ–‡æœ¬ç­¾åå±æ€§æ˜¾å¼åŒ…å«å‚æ•° <code>b</code> çš„é»˜è®¤å€¼ <code>0</code>ï¼Œè€Œä¸æ˜¯è‡ªåŠ¨ç”Ÿæˆçš„ <code>...</code>ï¼š</p>
<pre><code class="language-rust">use pyo3::prelude::*;


/// æ­¤å‡½æ•°å°†ä¸¤ä¸ªæ— ç¬¦å· 64 ä½æ•´æ•°ç›¸åŠ ã€‚
#[pyfunction]
#[pyo3(signature = (a, b=0, /), text_signature = "(a, b=0, /)")]
fn add(a: u64, b: u64) -&gt; u64 {
    a + b
}
<span class="boring">
</span><span class="boring">fn main() -&gt; PyResult&lt;()&gt; {
</span><span class="boring">    Python::attach(|py| {
</span><span class="boring">        let fun = pyo3::wrap_pyfunction!(add, py)?;
</span><span class="boring">
</span><span class="boring">        let doc: String = fun.getattr("__doc__")?.extract()?;
</span><span class="boring">        assert_eq!(doc, "æ­¤å‡½æ•°å°†ä¸¤ä¸ªæ— ç¬¦å· 64 ä½æ•´æ•°ç›¸åŠ ã€‚");
</span><span class="boring">
</span><span class="boring">        let inspect = PyModule::import(py, "inspect")?.getattr("signature")?;
</span><span class="boring">        let sig: String = inspect
</span><span class="boring">            .call1((fun,))?
</span><span class="boring">            .call_method0("__str__")?
</span><span class="boring">            .extract()?;
</span><span class="boring">        assert_eq!(sig, "(a, b=0, /)");
</span><span class="boring">
</span><span class="boring">        Ok(())
</span><span class="boring">    })
</span><span class="boring">}</span></code></pre>
<p>PyO3 ä¼šå°†æ³¨è§£å†…å®¹åŸæ ·åŒ…å«ä¸º <code>__text_signature__</code>ã€‚ä»¥ä¸‹æ˜¾ç¤ºäº† IPython ç°åœ¨å¦‚ä½•å±•ç¤ºè¿™ä¸ªä¿¡æ¯ï¼ˆæ³¨æ„ <code>b</code> çš„é»˜è®¤å€¼ä¸º 0ï¼‰ï¼š</p>
<pre><code class="language-text">&gt;&gt;&gt; pyo3_test.add.__text_signature__
'(a, b=0, /)'
&gt;&gt;&gt; pyo3_test.add?
Signature: pyo3_test.add(a, b=0, /)
Docstring: æ­¤å‡½æ•°å°†ä¸¤ä¸ªæ— ç¬¦å· 64 ä½æ•´æ•°ç›¸åŠ ã€‚
Type:      builtin_function_or_method
</code></pre>
<p>å¦‚æœå®Œå…¨ä¸éœ€è¦ç­¾åï¼Œä½¿ç”¨ <code>#[pyo3(text_signature = None)]</code> å°†ç¦ç”¨å†…ç½®ç­¾åã€‚ä¸‹é¢çš„ä»£ç ç‰‡æ®µæ¼”ç¤ºäº†è¿™ä¸€ç‚¹ï¼š</p>
<pre><code class="language-rust">use pyo3::prelude::*;


/// æ­¤å‡½æ•°å°†ä¸¤ä¸ªæ— ç¬¦å· 64 ä½æ•´æ•°ç›¸åŠ ã€‚
#[pyfunction]
#[pyo3(signature = (a, b=0, /), text_signature = None)]
fn add(a: u64, b: u64) -&gt; u64 {
    a + b
}
<span class="boring">
</span><span class="boring">fn main() -&gt; PyResult&lt;()&gt; {
</span><span class="boring">    Python::attach(|py| {
</span><span class="boring">        let fun = pyo3::wrap_pyfunction!(add, py)?;
</span><span class="boring">
</span><span class="boring">        let doc: String = fun.getattr("__doc__")?.extract()?;
</span><span class="boring">        assert_eq!(doc, "æ­¤å‡½æ•°å°†ä¸¤ä¸ªæ— ç¬¦å· 64 ä½æ•´æ•°ç›¸åŠ ã€‚");
</span><span class="boring">        assert!(fun.getattr("__text_signature__")?.is_none());
</span><span class="boring">
</span><span class="boring">        Ok(())
</span><span class="boring">    })
</span><span class="boring">}</span></code></pre>
<p>ç°åœ¨å‡½æ•°çš„ <code>__text_signature__</code> å°†è¢«è®¾ç½®ä¸º <code>None</code>ï¼ŒIPython åœ¨å¸®åŠ©ä¸­å°†ä¸å†æ˜¾ç¤ºä»»ä½•ç­¾åï¼š</p>
<pre><code class="language-text">&gt;&gt;&gt; pyo3_test.add.__text_signature__ == None
True
&gt;&gt;&gt; pyo3_test.add?
Docstring: æ­¤å‡½æ•°å°†ä¸¤ä¸ªæ— ç¬¦å· 64 ä½æ•´æ•°ç›¸åŠ ã€‚
Type:      builtin_function_or_method
</code></pre>
<h3 id="ç­¾åä¸­çš„ç±»å‹æ³¨è§£"><a class="header" href="#ç­¾åä¸­çš„ç±»å‹æ³¨è§£">ç­¾åä¸­çš„ç±»å‹æ³¨è§£</a></h3>
<p>å½“å¯ç”¨ <code>experimental-inspect</code> Cargo ç‰¹æ€§æ—¶ï¼Œ<code>signature</code> å±æ€§è¿˜å¯ä»¥åŒ…å«ç±»å‹æç¤ºï¼š</p>
<pre><code class="language-rust"><span class="boring">#[cfg(feature = "experimental-inspect")] {
</span>use pyo3::prelude::*;


#[pymodule]
pub mod example {
   use pyo3::prelude::*;


   #[pyfunction]
   #[pyo3(signature = (arg: "list[int]") -&gt; "list[int]")]
   fn list_of_int_identity(arg: Bound&lt;'_, PyAny&gt;) -&gt; Bound&lt;'_, PyAny&gt; {
      arg
   }
}
<span class="boring">}</span></code></pre>
<p>è¯¥ç‰¹æ€§å¯ç”¨äº† PyO3 <a href="#ç±»å‹å­˜æ ¹ç”Ÿæˆpyi-æ–‡ä»¶å’Œå†…çœåŠŸèƒ½">æ­£åœ¨å¼€å‘ä¸­çš„è‡ªåŠ¨ç”Ÿæˆç±»å‹å­˜æ ¹åŠŸèƒ½</a>ï¼Œå¯ç”ŸæˆåŒ…å«æ­£ç¡®ç±»å‹æç¤ºçš„æ–‡ä»¶ï¼š</p>
<pre><code class="language-python">def list_of_int_identity(arg: list[int]) -&gt; list[int]: ...
</code></pre>
<p>è€Œä¸æ˜¯æ³›å‹å½¢å¼ï¼š</p>
<pre><code class="language-python">import typing


def list_of_int_identity(arg: typing.Any) -&gt; typing.Any: ...
</code></pre>
<p>è¯·æ³¨æ„ï¼Œå½“å‰ç±»å‹æ³¨è§£å¿…é¡»å†™æˆ Rust å­—ç¬¦ä¸²ã€‚</p>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="é”™è¯¯å¤„ç†"><a class="header" href="#é”™è¯¯å¤„ç†">é”™è¯¯å¤„ç†</a></h1>
<p>æœ¬ç« ç®€è¦ä»‹ç»äº† Rust ä¸­çš„é”™è¯¯å¤„ç†æœºåˆ¶ï¼Œä»¥åŠ PyO3 å¦‚ä½•å°†å…¶ä¸ Python å¼‚å¸¸é›†æˆã€‚</p>
<p>è¿™æ¶µç›–è¶³å¤Ÿçš„ç»†èŠ‚æ¥åˆ›å»ºä¸€ä¸ª <code>#[pyfunction]</code>ï¼Œè¯¥å‡½æ•°ä¼šä» Rust ä¸­çš„é”™è¯¯å¼•å‘ Python å¼‚å¸¸ã€‚</p>
<p>æŒ‡å—åé¢æœ‰å…³äº <a href="#python-å¼‚å¸¸">Python å¼‚å¸¸</a> çš„ä¸€èŠ‚ï¼Œæ›´è¯¦ç»†åœ°ä»‹ç»äº†å¼‚å¸¸ç±»å‹ã€‚</p>
<h2 id="è¡¨ç¤º-python-å¼‚å¸¸"><a class="header" href="#è¡¨ç¤º-python-å¼‚å¸¸">è¡¨ç¤º Python å¼‚å¸¸</a></h2>
<p>Rust ä»£ç ä½¿ç”¨æ³›å‹ <a href="https://doc.rust-lang.org/stable/std/result/enum.Result.html"><code>Result&lt;T, E&gt;</code></a> æšä¸¾æ¥ä¼ æ’­é”™è¯¯ã€‚é”™è¯¯ç±»å‹ <code>E</code> ç”±ä»£ç ä½œè€…é€‰æ‹©ï¼Œç”¨äºæè¿°å¯èƒ½å‘ç”Ÿçš„å…·ä½“é”™è¯¯ã€‚</p>
<p>PyO3 æä¾›äº† <a href="function/{{#PYO3_DOCS_URL}}/pyo3/struct.PyErr.html"><code>PyErr</code></a> ç±»å‹ï¼Œè¡¨ç¤ºä¸€ä¸ª Python å¼‚å¸¸ã€‚å¦‚æœæŸä¸ª PyO3 API å¯èƒ½å¯¼è‡´ Python å¼‚å¸¸è¢«æŠ›å‡ºï¼Œé‚£ä¹ˆè¯¥ API çš„è¿”å›ç±»å‹å°†æ˜¯ <a href="function/{{#PYO3_DOCS_URL}}/pyo3/prelude/type.PyResult.html"><code>PyResult&lt;T&gt;</code></a>ï¼Œè¿™æ˜¯ <code>Result&lt;T, PyErr&gt;</code> ç±»å‹çš„åˆ«åã€‚</p>
<p>æ€»ç»“å¦‚ä¸‹ï¼š</p>
<ul>
<li>å½“ Python å¼‚å¸¸è¢«å¼•å‘å¹¶ç”± PyO3 æ•è·æ—¶ï¼Œè¯¥å¼‚å¸¸å°†å­˜å‚¨åœ¨ <code>PyResult</code> çš„ <code>Err</code> å˜ä½“ä¸­ã€‚</li>
<li>é€šè¿‡ Rust ä»£ç ä¼ é€’ Python å¼‚å¸¸æ—¶ï¼Œä½¿ç”¨æ‰€æœ‰â€œå¸¸è§„â€æŠ€æœ¯ï¼Œä¾‹å¦‚ <code>?</code> æ“ä½œç¬¦ï¼Œå…¶ä¸­é”™è¯¯ç±»å‹ä¸º <code>PyErr</code>ã€‚</li>
<li>æœ€åï¼Œå½“ä¸€ä¸ª <code>PyResult</code> é€šè¿‡ PyO3 ä» Rust è¿”å›åˆ° Python æ—¶ï¼Œå¦‚æœç»“æœæ˜¯ <code>Err</code> å˜ä½“ï¼Œåˆ™å…¶ä¸­åŒ…å«çš„å¼‚å¸¸å°†è¢«å¼•å‘ã€‚</li>
</ul>
<p>ï¼ˆå…³äº Rust é”™è¯¯å¤„ç†å’Œ <code>?</code> æ“ä½œç¬¦æœ‰è®¸å¤šä¼˜ç§€çš„æ•™ç¨‹ï¼Œå› æ­¤æœ¬æŒ‡å—ä¸ä¼šæ·±å…¥è®²è§£ä»…é™ Rust çš„ä¸»é¢˜ã€‚ï¼‰</p>
<h2 id="ä»å‡½æ•°ä¸­æŠ›å‡ºå¼‚å¸¸"><a class="header" href="#ä»å‡½æ•°ä¸­æŠ›å‡ºå¼‚å¸¸">ä»å‡½æ•°ä¸­æŠ›å‡ºå¼‚å¸¸</a></h2>
<p>å¦‚å‰æ‰€è¿°ï¼Œå½“åŒ…å« <code>Err</code> çš„ <code>PyResult</code> ä» Rust è½¬ç§»åˆ° Python æ—¶ï¼ŒPyO3 å°†å¼•å‘å…¶ä¸­åŒ…å«çš„å¼‚å¸¸ã€‚</p>
<p>å› æ­¤ï¼Œè¦ä» <code>#[pyfunction]</code> ä¸­æŠ›å‡ºå¼‚å¸¸ï¼Œè¯·å°†è¿”å›ç±»å‹ <code>T</code> æ›´æ”¹ä¸º <code>PyResult&lt;T&gt;</code>ã€‚å½“å‡½æ•°è¿”å› <code>Err</code> æ—¶ï¼Œå°±ä¼šå¼•å‘ä¸€ä¸ª Python å¼‚å¸¸ã€‚ï¼ˆåªè¦é”™è¯¯ç±»å‹ <code>E</code> å®ç°äº† <code>From</code> è½¬æ¢ä¸º <code>PyErr</code>ï¼Œå…¶ä»– <code>Result&lt;T, E&gt;</code> ç±»å‹ä¹Ÿå¯ä»¥ä½¿ç”¨ï¼Œè¯·å‚è§ä¸‹æ–‡çš„ <a href="#è‡ªå®šä¹‰-rust-é”™è¯¯ç±»å‹">è‡ªå®šä¹‰ Rust é”™è¯¯ç±»å‹</a>ã€‚ï¼‰</p>
<p>è¿™å¯¹ <code>#[pymethods]</code> ä¸­çš„å‡½æ•°ä¹Ÿæœ‰æ•ˆã€‚</p>
<p>ä¾‹å¦‚ï¼Œä»¥ä¸‹ <code>check_positive</code> å‡½æ•°åœ¨è¾“å…¥ä¸ºè´Ÿæ•°æ—¶å¼•å‘ <code>ValueError</code>ï¼š</p>
<pre><code class="language-rust">use pyo3::exceptions::PyValueError;
use pyo3::prelude::*;

#[pyfunction]
fn check_positive(x: i32) -&gt; PyResult&lt;()&gt; {
    if x &lt; 0 {
        Err(PyValueError::new_err("x is negative"))
    } else {
        Ok(())
    }
}
<span class="boring">
</span><span class="boring">fn main(){
</span><span class="boring">	Python::attach(|py|{
</span><span class="boring">		let fun = pyo3::wrap_pyfunction!(check_positive, py).unwrap();
</span><span class="boring">		fun.call1((-1,)).unwrap_err();
</span><span class="boring">		fun.call1((1,)).unwrap();
</span><span class="boring">	});
</span><span class="boring">}</span></code></pre>
<p>æ‰€æœ‰å†…ç½®çš„ Python å¼‚å¸¸ç±»å‹éƒ½å®šä¹‰åœ¨ <a href="function/{{#PYO3_DOCS_URL}}/pyo3/exceptions/index.html"><code>pyo3::exceptions</code></a> æ¨¡å—ä¸­ã€‚å®ƒä»¬éƒ½æœ‰ <code>new_err</code> æ„é€ å‡½æ•°ï¼Œå¯ä»¥ç›´æ¥æ„å»º <code>PyErr</code>ï¼Œå¦‚ä¸Šä¾‹æ‰€ç¤ºã€‚</p>
<h2 id="è‡ªå®šä¹‰-rust-é”™è¯¯ç±»å‹"><a class="header" href="#è‡ªå®šä¹‰-rust-é”™è¯¯ç±»å‹">è‡ªå®šä¹‰ Rust é”™è¯¯ç±»å‹</a></h2>
<p>åªè¦å­˜åœ¨ <code>std::from::From&lt;E&gt; for PyErr</code> çš„å®ç°ï¼ŒPyO3 å°±ä¼šè‡ªåŠ¨å°† <code>#[pyfunction]</code> è¿”å›çš„ <code>Result&lt;T, E&gt;</code> è½¬æ¢ä¸º <code>PyResult&lt;T&gt;</code>ã€‚Rust æ ‡å‡†åº“ä¸­çš„è®¸å¤šé”™è¯¯ç±»å‹éƒ½ä»¥è¿™ç§æ–¹å¼å®šä¹‰äº† <a href="https://doc.rust-lang.org/stable/std/convert/trait.From.html"><code>From</code></a> è½¬æ¢ã€‚</p>
<p>å¦‚æœä½ å¤„ç†çš„ç±»å‹ <code>E</code> æ˜¯å®šä¹‰åœ¨ç¬¬ä¸‰æ–¹ crate ä¸­çš„ï¼Œè¯·å‚é˜…ä¸‹æ–‡çš„ <a href="#å¤–éƒ¨-rust-é”™è¯¯ç±»å‹">å¤–éƒ¨ Rust é”™è¯¯ç±»å‹</a> ä¸€èŠ‚ï¼Œäº†è§£å¦‚ä½•å¤„ç†æ­¤ç±»é”™è¯¯ã€‚</p>
<p>ä»¥ä¸‹ç¤ºä¾‹åˆ©ç”¨äº† <code>From&lt;ParseIntError&gt; for PyErr</code> çš„å®ç°ï¼Œåœ¨è§£æå­—ç¬¦ä¸²ä¸ºæ•´æ•°æ—¶å¼•å‘å¼‚å¸¸ï¼š</p>
<pre><code class="language-rust"><span class="boring">use pyo3::prelude::*;
</span>use std::num::ParseIntError;

#[pyfunction]
fn parse_int(x: &amp;str) -&gt; Result&lt;usize, ParseIntError&gt; {
    x.parse()
}

<span class="boring">fn main() {
</span><span class="boring">    Python::attach(|py| {
</span><span class="boring">        let fun = pyo3::wrap_pyfunction!(parse_int, py).unwrap();
</span><span class="boring">        let value: usize = fun.call1(("5",)).unwrap().extract().unwrap();
</span><span class="boring">        assert_eq!(value, 5);
</span><span class="boring">    });
</span><span class="boring">}</span></code></pre>
<p>å½“ä¼ å…¥ä¸åŒ…å«æµ®ç‚¹æ•°çš„å­—ç¬¦ä¸²æ—¶ï¼Œå¼•å‘çš„å¼‚å¸¸å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre><code class="language-python">&gt;&gt;&gt; parse_int("bar")
Traceback (most recent call last):
  File "&lt;stdin&gt;", line 1, in &lt;module&gt;
ValueError: invalid digit found in string
</code></pre>
<p>æ›´å®Œæ•´çš„ä¾‹å­ï¼šä¸‹é¢çš„ä»£ç ç‰‡æ®µå®šä¹‰äº†ä¸€ä¸ªåä¸º <code>CustomIOError</code> çš„ Rust é”™è¯¯ç±»å‹ã€‚ç„¶åå®šä¹‰äº† <code>From&lt;CustomIOError&gt; for PyErr</code>ï¼Œè¿”å›ä¸€ä¸ªè¡¨ç¤º Python <code>OSError</code> çš„ <code>PyErr</code>ã€‚å› æ­¤ï¼Œå¯ä»¥ç›´æ¥åœ¨ <code>#[pyfunction]</code> çš„ç»“æœä¸­ä½¿ç”¨æ­¤é”™è¯¯ï¼Œå¹¶ä¾èµ–è½¬æ¢æœºåˆ¶å°†å…¶ä¼ æ’­ä¸º Python å¼‚å¸¸ã€‚</p>
<pre><code class="language-rust">use pyo3::exceptions::PyOSError;
use pyo3::prelude::*;
use std::fmt;

#[derive(Debug)]
struct CustomIOError;

impl std::error::Error for CustomIOError {}

impl fmt::Display for CustomIOError {
    fn fmt(&amp;self, f: &amp;mut fmt::Formatter&lt;'_&gt;) -&gt; fmt::Result {
        write!(f, "Oh no!")
    }
}

impl std::convert::From&lt;CustomIOError&gt; for PyErr {
    fn from(err: CustomIOError) -&gt; PyErr {
        PyOSError::new_err(err.to_string())
    }
}

pub struct Connection {/* ... */}

fn bind(addr: String) -&gt; Result&lt;Connection, CustomIOError&gt; {
    if &amp;addr == "0.0.0.0" {
        Err(CustomIOError)
    } else {
        Ok(Connection{ /* ... */})
    }
}

#[pyfunction]
fn connect(s: String) -&gt; Result&lt;(), CustomIOError&gt; {
    bind(s)?;
    // etc.
    Ok(())
}

fn main() {
    Python::attach(|py| {
        let fun = pyo3::wrap_pyfunction!(connect, py).unwrap();
        let err = fun.call1(("0.0.0.0",)).unwrap_err();
        assert!(err.is_instance_of::&lt;PyOSError&gt;(py));
    });
}</code></pre>
<p>å¦‚æœå¸Œæœ›å»¶è¿Ÿæ„å»º Python å¼‚å¸¸å®ä¾‹ï¼Œå¯ä»¥æ”¹ä¸ºå®ç° <a href="function/{{#PYO3_DOCS_URL}}/pyo3/trait.PyErrArguments.html"><code>PyErrArguments</code></a> traitã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå®é™…çš„å¼‚å¸¸å‚æ•°åˆ›å»ºå°†æ¨è¿Ÿåˆ°éœ€è¦ <code>PyErr</code> æ—¶æ‰è¿›è¡Œã€‚</p>
<p>æœ€åéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä»»ä½•å®ç°äº† <code>From</code> è½¬æ¢çš„é”™è¯¯ <code>E</code> éƒ½å¯ä»¥ä¸ <code>?</code>ï¼ˆâ€œtryâ€ï¼‰æ“ä½œç¬¦ä¸€èµ·ä½¿ç”¨ã€‚ä»¥ä¸‹æ˜¯ä¸Šè¿° <code>parse_int</code> å‡½æ•°çš„å¦ä¸€ä¸ªå®ç°ç‰ˆæœ¬ï¼Œç›´æ¥è¿”å› <code>PyResult</code>ï¼š</p>
<pre><code class="language-rust">use pyo3::prelude::*;

fn parse_int(s: String) -&gt; PyResult&lt;usize&gt; {
    let x = s.parse()?;
    Ok(x)
}
<span class="boring">
</span><span class="boring">use pyo3::exceptions::PyValueError;
</span><span class="boring">
</span><span class="boring">fn main() {
</span><span class="boring">    Python::attach(|py| {
</span><span class="boring">        assert_eq!(parse_int(String::from("1")).unwrap(), 1);
</span><span class="boring">        assert_eq!(parse_int(String::from("1337")).unwrap(), 1337);
</span><span class="boring">
</span><span class="boring">        assert!(parse_int(String::from("-1"))
</span><span class="boring">            .unwrap_err()
</span><span class="boring">            .is_instance_of::&lt;PyValueError&gt;(py));
</span><span class="boring">        assert!(parse_int(String::from("foo"))
</span><span class="boring">            .unwrap_err()
</span><span class="boring">            .is_instance_of::&lt;PyValueError&gt;(py));
</span><span class="boring">        assert!(parse_int(String::from("13.37"))
</span><span class="boring">            .unwrap_err()
</span><span class="boring">            .is_instance_of::&lt;PyValueError&gt;(py));
</span><span class="boring">    })
</span><span class="boring">}</span></code></pre>
<h2 id="å¤–éƒ¨-rust-é”™è¯¯ç±»å‹"><a class="header" href="#å¤–éƒ¨-rust-é”™è¯¯ç±»å‹">å¤–éƒ¨ Rust é”™è¯¯ç±»å‹</a></h2>
<p>Rust ç¼–è¯‘å™¨ä¸å…è®¸ä¸ºåœ¨å½“å‰ crate ä¹‹å¤–å®šä¹‰çš„ç±»å‹å®ç° traitï¼ˆè¿™è¢«ç§°ä¸ºâ€œå­¤å„¿è§„åˆ™â€ï¼‰ã€‚</p>
<p>å‡è®¾æœ‰ä¸€ä¸ªåœ¨ç¬¬ä¸‰æ–¹ä»£ç ä¸­å®šä¹‰çš„ç±»å‹ <code>OtherError</code>ï¼Œè¦å°†å…¶ä¸ PyO3 é›†æˆï¼Œä¸»è¦æœ‰ä¸¤ç§ç­–ç•¥ï¼š</p>
<ul>
<li>åˆ›å»ºä¸€ä¸ªæ–°çš„ç±»å‹åŒ…è£…å™¨ï¼Œä¾‹å¦‚ <code>MyOtherError</code>ã€‚ç„¶åå®ç° <code>From&lt;MyOtherError&gt; for PyErr</code>ï¼ˆæˆ– <code>PyErrArguments</code>ï¼‰ï¼Œä»¥åŠ <code>From&lt;OtherError&gt;</code> for <code>MyOtherError</code>ã€‚</li>
<li>ä½¿ç”¨ Rust çš„ Result ç»„åˆå­ï¼Œå¦‚ <code>map_err</code>ï¼Œè‡ªç”±ç¼–å†™ä»£ç å°† <code>OtherError</code> è½¬æ¢ä¸ºæ‰€éœ€çš„ç±»å‹ã€‚è¿™ç§æ–¹å¼æ¯æ¬¡ä½¿ç”¨éƒ½éœ€è¦æ ·æ¿ä»£ç ï¼Œä½†æä¾›äº†æ— é™çµæ´»æ€§ã€‚</li>
</ul>
<p>è¿›ä¸€æ­¥è¯´æ˜æ–°ç±»å‹ç­–ç•¥çš„å…³é”®æŠ€å·§æ˜¯ä» <code>#[pyfunction]</code> è¿”å› <code>Result&lt;T, MyOtherError&gt;</code>ã€‚è¿™æ„å‘³ç€ PyO3 å°†åˆ©ç”¨ <code>From&lt;MyOtherError&gt; for PyErr</code> æ¥åˆ›å»º Python å¼‚å¸¸ï¼Œè€Œ <code>#[pyfunction]</code> çš„å®ç°å¯ä»¥é€šè¿‡ <code>?</code> è‡ªåŠ¨å°† <code>OtherError</code> è½¬æ¢ä¸º <code>MyOtherError</code>ã€‚</p>
<p>ä»¥ä¸‹ç¤ºä¾‹æ¼”ç¤ºäº†æŸä¸ªå‡æƒ³ç¬¬ä¸‰æ–¹ crate <code>some_crate</code> çš„æƒ…å†µï¼Œå…¶ä¸­å‡½æ•° <code>get_x</code> è¿”å› <code>Result&lt;i32, OtherError&gt;</code>ï¼š</p>
<pre><code class="language-rust"><span class="boring">mod some_crate {
</span><span class="boring">  pub struct OtherError(());
</span><span class="boring">  impl OtherError {
</span><span class="boring">      pub fn message(&amp;self) -&gt; &amp;'static str { "some error occurred" }
</span><span class="boring">  }
</span><span class="boring">  pub fn get_x() -&gt; Result&lt;i32, OtherError&gt; { Ok(5) }
</span><span class="boring">}
</span>
use pyo3::prelude::*;
use pyo3::exceptions::PyValueError;
use some_crate::{OtherError, get_x};

struct MyOtherError(OtherError);

impl From&lt;MyOtherError&gt; for PyErr {
    fn from(error: MyOtherError) -&gt; Self {
        PyValueError::new_err(error.0.message())
    }
}

impl From&lt;OtherError&gt; for MyOtherError {
    fn from(other: OtherError) -&gt; Self {
        Self(other)
    }
}

#[pyfunction]
fn wrapped_get_x() -&gt; Result&lt;i32, MyOtherError&gt; {
    // get_x æ˜¯ä¸€ä¸ªè¿”å› Result&lt;i32, OtherError&gt; çš„å‡½æ•°
    let x: i32 = get_x()?;
    Ok(x)
}

<span class="boring">fn main() {
</span><span class="boring">    Python::attach(|py| {
</span><span class="boring">        let fun = pyo3::wrap_pyfunction!(wrapped_get_x, py).unwrap();
</span><span class="boring">        let value: usize = fun.call0().unwrap().extract().unwrap();
</span><span class="boring">        assert_eq!(value, 5);
</span><span class="boring">    });
</span><span class="boring">}</span></code></pre>
<h2 id="æ³¨æ„äº‹é¡¹"><a class="header" href="#æ³¨æ„äº‹é¡¹">æ³¨æ„äº‹é¡¹</a></h2>
<p>åœ¨ Python 3.11 åŠæ›´é«˜ç‰ˆæœ¬ä¸­ï¼Œå¯ä»¥å‘ Python å¼‚å¸¸æ·»åŠ æ³¨é‡Šï¼ˆnotesï¼‰ï¼Œä»¥ä¾¿åœ¨æ‰“å°å¼‚å¸¸æ—¶æä¾›é¢å¤–çš„è°ƒè¯•ä¿¡æ¯ã€‚åœ¨ PyO3 ä¸­ï¼Œä½ å¯ä»¥ä½¿ç”¨ <code>PyErr</code> ä¸Šçš„ <code>add_note</code> æ–¹æ³•å®ç°æ­¤åŠŸèƒ½ã€‚</p>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="python-ç±»"><a class="header" href="#python-ç±»">Python ç±»</a></h1>
<p>PyO3 åˆ©ç”¨ Rust çš„è¿‡ç¨‹å®ç³»ç»Ÿæä¾›äº†ä¸€ç»„å±æ€§ï¼Œç”¨äºå°† Rust ç»“æ„ä½“å®šä¹‰ä¸º Python ç±»ã€‚</p>
<p>ä¸»è¦çš„å±æ€§æ˜¯ <code>#[pyclass]</code>ï¼Œå®ƒç”¨äºæ ‡æ³¨ Rust çš„ <code>struct</code> æˆ– <code>enum</code>ï¼Œä»¥ç”Ÿæˆå¯¹åº”çš„ Python ç±»å‹ã€‚å®ƒä»¬é€šå¸¸è¿˜ä¼šæœ‰ä¸€ä¸ªï¼ˆæˆ–å¤šä¸ªï¼Œå¦‚æœå¯ç”¨äº† [<code>multiple-pymethods</code>] ç‰¹æ€§ï¼‰ç”¨ <code>#[pymethods]</code> æ ‡æ³¨çš„ <code>impl</code> å—ï¼Œç”¨äºå®šä¹‰ç”Ÿæˆçš„ Python ç±»å‹çš„æ–¹æ³•å’Œå¸¸é‡ã€‚<code>#[pymethods]</code> ä¸­ä¹Ÿå¯ä»¥å®ç° Python çš„é­”æœ¯æ–¹æ³•ï¼Œä¾‹å¦‚ <code>__str__</code>ã€‚</p>
<p>æœ¬ç« å°†è®¨è®ºè¿™äº›å±æ€§æä¾›çš„åŠŸèƒ½å’Œé…ç½®ã€‚ä»¥ä¸‹æ˜¯æœ¬ç« å„éƒ¨åˆ†å†…å®¹çš„é“¾æ¥åˆ—è¡¨ï¼š</p>
<ul>
<li><a href="#defining-a-new-class"><code>#[pyclass]</code></a>
<ul>
<li><a href="#object-properties-using-pyo3get-set"><code>#[pyo3(get, set)]</code></a></li>
</ul>
</li>
<li><a href="#instance-methods"><code>#[pymethods]</code></a>
<ul>
<li><a href="#constructor"><code>#[new]</code></a></li>
<li><a href="#object-properties-using-getter-and-setter"><code>#[getter]</code></a></li>
<li><a href="#object-properties-using-getter-and-setter"><code>#[setter]</code></a></li>
<li><a href="#static-methods"><code>#[staticmethod]</code></a></li>
<li><a href="#class-methods"><code>#[classmethod]</code></a></li>
<li><a href="#class-attributes"><code>#[classattr]</code></a></li>
<li><a href="#method-arguments"><code>#[args]</code></a></li>
</ul>
</li>
<li><a href="#ç±»çš„è‡ªå®šä¹‰">é­”æœ¯æ–¹æ³•å’Œæ§½ä½</a></li>
<li><a href="#classes-as-function-arguments">ç±»ä½œä¸ºå‡½æ•°å‚æ•°</a></li>
</ul>
<h2 id="å®šä¹‰æ–°ç±»"><a class="header" href="#å®šä¹‰æ–°ç±»">å®šä¹‰æ–°ç±»</a></h2>
<p>è¦å®šä¹‰è‡ªå®šä¹‰çš„ Python ç±»ï¼Œå¯å°† <code>#[pyclass]</code> å±æ€§æ·»åŠ åˆ° Rust ç»“æ„ä½“æˆ–æšä¸¾ä¸Šã€‚</p>
<pre><code class="language-rust"><span class="boring">#![allow(dead_code)]
</span>use pyo3::prelude::*;

#[pyclass]
struct MyClass {
    inner: i32,
}

// â€œå…ƒç»„â€ç»“æ„ä½“
#[pyclass]
struct Number(i32);

// PyO3 æ”¯æŒä»…å«å•å…ƒå˜ä½“çš„æšä¸¾ï¼ˆå³æ‰€æœ‰å˜ä½“éƒ½æ˜¯å•å…ƒç±»å‹ï¼‰
// è¿™ç±»ç®€å•æšä¸¾çš„è¡Œä¸ºç±»ä¼¼äº Python çš„æšä¸¾ï¼ˆenum.Enumï¼‰
#[pyclass(eq, eq_int)]
#[derive(PartialEq)]
enum MyEnum {
    Variant,
    OtherVariant = 30, // PyO3 æ”¯æŒè‡ªå®šä¹‰åˆ¤åˆ«å€¼
}

// PyO3 æ”¯æŒåœ¨ä»…å«å•å…ƒå˜ä½“çš„æšä¸¾ä¸­ä½¿ç”¨è‡ªå®šä¹‰åˆ¤åˆ«å€¼
#[pyclass(eq, eq_int)]
#[derive(PartialEq)]
enum HttpResponse {
    Ok = 200,
    NotFound = 404,
    Teapot = 418,
    // ...
}

// PyO3 ä¹Ÿæ”¯æŒåŒ…å«ç»“æ„ä½“å’Œå…ƒç»„å˜ä½“çš„æšä¸¾
// è¿™äº›å¤æ‚çš„æšä¸¾ä¸ä¸Šé¢çš„ç®€å•æšä¸¾è¡Œä¸ºç•¥æœ‰ä¸åŒ
// å®ƒä»¬ä¸»è¦ç”¨äºå®ä¾‹æ£€æŸ¥å’ŒåŒ¹é…è¯­å¥æ¨¡å¼
// å˜ä½“å¯ä»¥æ··åˆä½¿ç”¨
// ç»“æ„ä½“å˜ä½“å…·æœ‰å‘½åå­—æ®µï¼Œè€Œå…ƒç»„å˜ä½“ä¼šæŒ‰é¡ºåºç”Ÿæˆé€šç”¨å­—æ®µå _0, _1, _2, ...
// é™¤æ­¤ä¹‹å¤–ï¼Œè¿™ä¸¤ç±»åœ¨åŠŸèƒ½ä¸Šæ˜¯ç›¸åŒçš„
#[pyclass]
enum Shape {
    Circle { radius: f64 },
    Rectangle { width: f64, height: f64 },
    RegularPolygon(u32, f64),
    Nothing(),
}</code></pre>
<p>ä¸Šè¿°ç¤ºä¾‹ä¸º <code>MyClass</code>ã€<code>Number</code>ã€<code>MyEnum</code>ã€<code>HttpResponse</code> å’Œ <code>Shape</code> ç”Ÿæˆäº† [<code>PyTypeInfo</code>] å’Œ [<code>PyClass</code>] çš„å®ç°ã€‚æœ‰å…³ç”Ÿæˆä»£ç çš„è¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚è§æœ¬ç« æœ«å°¾çš„<a href="#implementation-details">å®ç°ç»†èŠ‚</a>ã€‚</p>
<h3 id="é™åˆ¶"><a class="header" href="#é™åˆ¶">é™åˆ¶</a></h3>
<p>ä¸ºäº†å°† Rust ç±»å‹ä¸ Python é›†æˆï¼ŒPyO3 éœ€è¦å¯¹å¯ä½¿ç”¨ <code>#[pyclass]</code> æ ‡æ³¨çš„ç±»å‹æ–½åŠ ä¸€äº›é™åˆ¶ã€‚ç‰¹åˆ«æ˜¯ï¼Œè¿™äº›ç±»å‹ä¸èƒ½æœ‰ç”Ÿå‘½å‘¨æœŸå‚æ•°ã€ä¸èƒ½æœ‰æ³›å‹å‚æ•°ï¼Œå¹¶ä¸”å¿…é¡»æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚å„é™åˆ¶çš„åŸå› å¦‚ä¸‹æ‰€è¿°ã€‚</p>
<h4 id="æ— ç”Ÿå‘½å‘¨æœŸå‚æ•°"><a class="header" href="#æ— ç”Ÿå‘½å‘¨æœŸå‚æ•°">æ— ç”Ÿå‘½å‘¨æœŸå‚æ•°</a></h4>
<p>Rust çš„ç”Ÿå‘½å‘¨æœŸæ˜¯ Rust ç¼–è¯‘å™¨ç”¨æ¥åˆ†æç¨‹åºå†…å­˜å®‰å…¨çš„æœºåˆ¶ï¼Œå®ƒä»…åœ¨ç¼–è¯‘æ—¶å­˜åœ¨ï¼›åœ¨è¿è¡Œæ—¶æ— æ³•é€šè¿‡ Python è¿™æ ·çš„åŠ¨æ€è¯­è¨€è®¿é—® Rust çš„ç”Ÿå‘½å‘¨æœŸã€‚</p>
<p>ä¸€æ—¦ Rust æ•°æ®æš´éœ²ç»™ Pythonï¼Œå°±æ— æ³•ä¿è¯ Rust ç¼–è¯‘å™¨å¯¹æ•°æ®ç”Ÿå‘½å‘¨æœŸçš„æ¨æ–­ä»ç„¶æˆç«‹ã€‚Python æ˜¯å¼•ç”¨è®¡æ•°è¯­è¨€ï¼Œå…¶å¼•ç”¨å¯èƒ½è¢«ä»»æ„é•¿æ—¶é—´æŒæœ‰ï¼Œè¿™è¶…å‡ºäº† Rust ç¼–è¯‘å™¨çš„è¿½è¸ªèƒ½åŠ›ã€‚å”¯ä¸€èƒ½æ­£ç¡®è¡¨è¾¾è¿™ä¸€ç‚¹çš„æ–¹å¼æ˜¯è¦æ±‚æ‰€æœ‰ <code>#[pyclass]</code> ç±»å‹ä¸å€Ÿç”¨ä»»ä½•çŸ­äº <code>'static</code> ç”Ÿå‘½å‘¨æœŸçš„æ•°æ®ï¼Œå³ <code>#[pyclass]</code> ç±»å‹ä¸èƒ½æœ‰ä»»ä½•ç”Ÿå‘½å‘¨æœŸå‚æ•°ã€‚</p>
<p>å½“ä½ éœ€è¦åœ¨ Python å’Œ Rust ä¹‹é—´å…±äº«æ•°æ®æ‰€æœ‰æƒæ—¶ï¼Œåº”è€ƒè™‘ä½¿ç”¨å¼•ç”¨è®¡æ•°çš„æ™ºèƒ½æŒ‡é’ˆï¼ˆå¦‚ [<code>Arc</code>] æˆ– [<code>Py</code>][<code>Py&lt;T&gt;</code>]ï¼‰ï¼Œè€Œéå¸¦ç”Ÿå‘½å‘¨æœŸçš„å€Ÿç”¨å¼•ç”¨ã€‚</p>
<h4 id="æ— æ³›å‹å‚æ•°"><a class="header" href="#æ— æ³›å‹å‚æ•°">æ— æ³›å‹å‚æ•°</a></h4>
<p>å¸¦æ³›å‹å‚æ•° <code>T</code> çš„ Rust ç»“æ„ä½“ <code>Foo&lt;T&gt;</code> åœ¨æ¯æ¬¡ä½¿ç”¨ä¸åŒçš„å…·ä½“ç±»å‹ä½œä¸º <code>T</code> æ—¶ï¼Œéƒ½ä¼šç”±ç¼–è¯‘å™¨ç”Ÿæˆæ–°çš„å®ç°ã€‚è¿™äº›å®ç°æ˜¯æŒ‰éœ€åœ¨ä½¿ç”¨ä½ç½®ç”Ÿæˆçš„ã€‚è¿™ä¸å°† <code>Foo</code> å°è£…ä¸º Python ç±»å‹ä¸å…¼å®¹ï¼Œå› ä¸ºåè€…éœ€è¦ä¸€ä¸ªå•ä¸€çš„ã€ç¼–è¯‘å¥½çš„ <code>Foo</code> å®ç°ä¸ Python è§£é‡Šå™¨é›†æˆã€‚</p>
<p>ç›®å‰æœ€å¥½çš„æ›¿ä»£æ–¹æ¡ˆæ˜¯ç¼–å†™ä¸€ä¸ªå®ï¼Œåœ¨ä½ éœ€è¦çš„æ¯ä¸ªå®ä¾‹åŒ–æ—¶å±•å¼€ä¸ºä¸€ä¸ªæ–°çš„ <code>#[pyclass]</code>ï¼š</p>
<pre><code class="language-rust"><span class="boring">#![allow(dead_code)]
</span>use pyo3::prelude::*;

struct GenericClass&lt;T&gt; {
    data: T,
}

macro_rules! create_interface {
    ($name: ident, $type: ident) =&gt; {
        #[pyclass]
        pub struct $name {
            inner: GenericClass&lt;$type&gt;,
        }
        #[pymethods]
        impl $name {
            #[new]
            pub fn new(data: $type) -&gt; Self {
                Self {
                    inner: GenericClass { data: data },
                }
            }
        }
    };
}

create_interface!(IntClass, i64);
create_interface!(FloatClass, String);</code></pre>
<h4 id="å¿…é¡»æ˜¯çº¿ç¨‹å®‰å…¨çš„"><a class="header" href="#å¿…é¡»æ˜¯çº¿ç¨‹å®‰å…¨çš„">å¿…é¡»æ˜¯çº¿ç¨‹å®‰å…¨çš„</a></h4>
<p>Python è§£é‡Šå™¨ä¼šåœ¨çº¿ç¨‹é—´è‡ªç”±å…±äº« Python å¯¹è±¡ã€‚è¿™æ„å‘³ç€ï¼š</p>
<ul>
<li>Python å¯¹è±¡å¯èƒ½ç”±ä¸åŒçš„ Python çº¿ç¨‹åˆ›å»ºå’Œé”€æ¯ï¼Œå› æ­¤ <code>#[pyclass]</code> ç±»å‹å¿…é¡»æ˜¯ <code>Send</code> çš„ã€‚</li>
<li>Python å¯¹è±¡å¯èƒ½è¢«å¤šä¸ª Python çº¿ç¨‹åŒæ—¶è®¿é—®ï¼Œå› æ­¤ <code>#[pyclass]</code> ç±»å‹å¿…é¡»æ˜¯ <code>Sync</code> çš„ã€‚</li>
</ul>
<p>ç›®å‰æ— éœ€è¿‡äºæ‹…å¿ƒè¿™äº›è¦æ±‚ï¼Œç®€å•çš„ç±»é€šå¸¸å·²ç»æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚æœ¬æŒ‡å—ç¨åä¼šæœ‰<a href="#pyclass-çº¿ç¨‹å®‰å…¨">å…³äºçº¿ç¨‹å®‰å…¨çš„è¯¦ç»†è®¨è®º</a>ã€‚</p>
<h2 id="æ„é€ å™¨"><a class="header" href="#æ„é€ å™¨">æ„é€ å™¨</a></h2>
<p>é»˜è®¤æƒ…å†µä¸‹ï¼Œæ— æ³•ä» Python ä»£ç åˆ›å»ºè‡ªå®šä¹‰ç±»çš„å®ä¾‹ã€‚è¦å£°æ˜æ„é€ å™¨ï¼Œéœ€è¦å®šä¹‰ä¸€ä¸ªæ–¹æ³•å¹¶ç”¨ <code>#[new]</code> å±æ€§æ ‡æ³¨ã€‚åªèƒ½æŒ‡å®š Python çš„ <code>__new__</code> æ–¹æ³•ï¼Œ<code>__init__</code> ä¸å¯ç”¨ã€‚</p>
<pre><code class="language-rust"><span class="boring">#![allow(dead_code)]
</span><span class="boring">use pyo3::prelude::*;
</span><span class="boring">#[pyclass]
</span><span class="boring">struct Number(i32);
</span><span class="boring">
</span>#[pymethods]
impl Number {
    #[new]
    fn new(value: i32) -&gt; Self {
        Number(value)
    }
}</code></pre>
<p>æˆ–è€…ï¼Œå¦‚æœä½ çš„ <code>new</code> æ–¹æ³•å¯èƒ½å¤±è´¥ï¼Œå¯ä»¥è¿”å› <code>PyResult&lt;Self&gt;</code>ã€‚</p>
<pre><code class="language-rust"><span class="boring">#![allow(dead_code)]
</span><span class="boring">use pyo3::prelude::*;
</span><span class="boring">use pyo3::exceptions::PyValueError;
</span><span class="boring">#[pyclass]
</span><span class="boring">struct Nonzero(i32);
</span><span class="boring">
</span>#[pymethods]
impl Nonzero {
    #[new]
    fn py_new(value: i32) -&gt; PyResult&lt;Self&gt; {
        if value == 0 {
            Err(PyValueError::new_err("cannot be zero"))
        } else {
            Ok(Nonzero(value))
        }
    }
}</code></pre>
<p>å¦‚æœä½ å¸Œæœ›è¿”å›ä¸€ä¸ªå·²å­˜åœ¨çš„å¯¹è±¡ï¼ˆä¾‹å¦‚ï¼Œä½ çš„ <code>new</code> æ–¹æ³•ç¼“å­˜äº†è¿”å›å€¼ï¼‰ï¼Œ<code>new</code> æ–¹æ³•å¯ä»¥è¿”å› <code>pyo3::Py&lt;Self&gt;</code>ã€‚</p>
<p>å¦‚ä½ æ‰€è§ï¼ŒRust æ–¹æ³•çš„åç§°åœ¨è¿™é‡Œå¹¶ä¸é‡è¦ï¼›ä½ ä»å¯ä½¿ç”¨ <code>new()</code> ä½œä¸º Rust å±‚çº§çš„æ„é€ å™¨ã€‚</p>
<p>å¦‚æœæ²¡æœ‰å£°æ˜æ ‡è®°ä¸º <code>#[new]</code> çš„æ–¹æ³•ï¼Œåˆ™å¯¹è±¡å®ä¾‹åªèƒ½ä» Rust åˆ›å»ºï¼Œè€Œä¸èƒ½ä» Python åˆ›å»ºã€‚</p>
<p>å…³äºå‚æ•°çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚è§ä¸‹é¢çš„<a href="#method-arguments"><code>æ–¹æ³•å‚æ•°</code></a>éƒ¨åˆ†ã€‚</p>
<h2 id="å°†ç±»æ·»åŠ åˆ°æ¨¡å—"><a class="header" href="#å°†ç±»æ·»åŠ åˆ°æ¨¡å—">å°†ç±»æ·»åŠ åˆ°æ¨¡å—</a></h2>
<p>ä¸‹ä¸€æ­¥æ˜¯åˆ›å»º Python æ¨¡å—å¹¶å°†æˆ‘ä»¬çš„ç±»æ·»åŠ è¿›å»ï¼š</p>
<pre><code class="language-rust"><span class="boring">#![allow(dead_code)]
</span><span class="boring">use pyo3::prelude::*;
</span><span class="boring">fn main() {}
</span><span class="boring">#[pyclass]
</span><span class="boring">struct Number(i32);
</span><span class="boring">
</span>#[pymodule]
mod my_module {
    #[pymodule_export]
    use super::Number;
}</code></pre>
<h2 id="bound-ä¸å†…éƒ¨å¯å˜æ€§"><a class="header" href="#bound-ä¸å†…éƒ¨å¯å˜æ€§">Bound<t> ä¸å†…éƒ¨å¯å˜æ€§</t></a></h2>
<p>å°† <code>#[pyclass]</code> ç±»å‹ <code>T</code> è½¬æ¢ä¸º Python å¯¹è±¡å¹¶åœ¨ Rust ä»£ç ä¸­è®¿é—®å®ƒå¸¸å¸¸æ˜¯å¿…è¦çš„ã€‚<code>[</code>Py<t><code>] å’Œ [</code>Bound&lt;â€™py, T&gt;`] æ™ºèƒ½æŒ‡é’ˆæ˜¯ PyO3 API ä¸­è¡¨ç¤º Python å¯¹è±¡çš„æ–¹å¼ã€‚æœ‰å…³å®ƒä»¬çš„æ›´å¤šç»†èŠ‚å¯å‚è§æŒ‡å—ä¸­çš„<a href="#pyo3s-smart-pointers">Python å¯¹è±¡</a>éƒ¨åˆ†ã€‚</t></p>
<p>å¤§å¤šæ•° Python å¯¹è±¡ä¸æä¾›ç‹¬å ï¼ˆ<code>&amp;mut</code>ï¼‰è®¿é—®ï¼ˆå‚è§<a href="#pythons-memory-model">Python å†…å­˜æ¨¡å‹ç« èŠ‚</a>ï¼‰ï¼Œä½† Rust ç»“æ„ä½“åŒ…è£…æˆçš„ Python å¯¹è±¡ï¼ˆå³ <code>pyclass</code> ç±»å‹ï¼‰é€šå¸¸ç¡®å®éœ€è¦ <code>&amp;mut</code> è®¿é—®ã€‚ç„¶è€Œï¼Œä¸€æ—¦å¯¹è±¡çš„æ‰€æœ‰æƒè¢«äº¤ç»™ Python è§£é‡Šå™¨ï¼ŒRust çš„å€Ÿç”¨æ£€æŸ¥å™¨å°±æ— æ³•å†å¯¹ <code>&amp;mut</code> å¼•ç”¨è¿›è¡Œåˆ†æã€‚</p>
<p>ä¸ºäº†è§£å†³è¿™ä¸€é—®é¢˜ï¼ŒPyO3 ä½¿ç”¨ç±»ä¼¼äº <code>std::cell::RefCell&lt;T&gt;</code> çš„æœºåˆ¶åœ¨è¿è¡Œæ—¶è¿›è¡Œå€Ÿç”¨æ£€æŸ¥ã€‚è¿™è¢«ç§°ä¸º<a href="https://doc.rust-lang.org/book/ch15-05-interior-mutability.html">å†…éƒ¨å¯å˜æ€§</a>ã€‚</p>
<p>ç†Ÿæ‚‰ <code>RefCell&lt;T&gt;</code> çš„ç”¨æˆ·å¯ä»¥åƒä½¿ç”¨ <code>RefCell&lt;T&gt;</code> ä¸€æ ·ä½¿ç”¨ <code>Py&lt;T&gt;</code> å’Œ <code>Bound&lt;'py, T&gt;</code>ã€‚</p>
<p>ä¸å¤ªç†Ÿæ‚‰ <code>RefCell&lt;T&gt;</code> çš„ç”¨æˆ·ï¼Œä»¥ä¸‹æ˜¯ Rust å€Ÿç”¨è§„åˆ™çš„å›é¡¾ï¼š</p>
<ul>
<li>åœ¨ä»»æ„æ—¶åˆ»ï¼Œä½ åªèƒ½æ‹¥æœ‰ä¸€ä¸ªå¯å˜å¼•ç”¨ï¼Œæˆ–ä»»æ„æ•°é‡çš„ä¸å¯å˜å¼•ç”¨ï¼ˆä½†ä¸èƒ½åŒæ—¶æ‹¥æœ‰ï¼‰ã€‚</li>
<li>å¼•ç”¨çš„ç”Ÿå‘½å‘¨æœŸç»ä¸èƒ½è¶…è¿‡å…¶æ‰€æŒ‡å‘æ•°æ®çš„ç”Ÿå‘½å‘¨æœŸã€‚</li>
</ul>
<p><code>Py&lt;T&gt;</code> å’Œ <code>Bound&lt;'py, T&gt;</code> ä¸ <code>RefCell&lt;T&gt;</code> ä¸€æ ·ï¼Œé€šè¿‡åœ¨è¿è¡Œæ—¶è·Ÿè¸ªå¼•ç”¨æ¥ç¡®ä¿è¿™äº›å€Ÿç”¨è§„åˆ™ã€‚</p>
<pre><code class="language-rust"><span class="boring">use pyo3::prelude::*;
</span>#[pyclass]
struct MyClass {
    #[pyo3(get)]
    num: i32,
}
Python::attach(|py| {
    let obj = Bound::new(py, MyClass { num: 3 }).unwrap();
    {
        let obj_ref = obj.borrow(); // è·å– PyRef
        assert_eq!(obj_ref.num, 3);
        // é™¤éæ‰€æœ‰ PyRefs éƒ½è¢«é‡Šæ”¾ï¼Œå¦åˆ™æ— æ³•è·å– PyRefMut
        assert!(obj.try_borrow_mut().is_err());
    }
    {
        let mut obj_mut = obj.borrow_mut(); // è·å– PyRefMut
        obj_mut.num = 5;
        // åœ¨ PyRefMut è¢«é‡Šæ”¾å‰ï¼Œæ— æ³•è·å–ä»»ä½•å…¶ä»–å¼•ç”¨
        assert!(obj.try_borrow().is_err());
        assert!(obj.try_borrow_mut().is_err());
    }

    // ä½ å¯ä»¥å°† `Bound` è½¬æ¢ä¸º Python å¯¹è±¡
    pyo3::py_run!(py, obj, "assert obj.num == 5");
});</code></pre>
<p><code>Bound&lt;'py, T&gt;</code> å—é™äº Python çš„ç”Ÿå‘½å‘¨æœŸ <code>'py</code>ã€‚è‹¥è¦ä½¿å¯¹è±¡æ‹¥æœ‰æ›´é•¿çš„ç”Ÿå‘½å‘¨æœŸï¼ˆä¾‹å¦‚ï¼Œå°†å…¶å­˜å‚¨åœ¨æŸä¸ªç»“æ„ä½“ä¸­ï¼‰åœ¨ Rust ä¸€ä¾§ä½¿ç”¨ <code>Py&lt;T&gt;</code>ã€‚<code>Py&lt;T&gt;</code> éœ€è¦ä¸€ä¸ª <code>Python&lt;'_&gt;</code> token æ‰èƒ½è®¿é—®ï¼š</p>
<pre><code class="language-rust"><span class="boring">use pyo3::prelude::*;
</span>#[pyclass]
struct MyClass {
    num: i32,
}


fn return_myclass() -&gt; Py&lt;MyClass&gt; {
    Python::attach(|py| Py::new(py, MyClass { num: 1 }).unwrap())
}


let obj = return_myclass();


Python::attach(move |py| {
    let bound = obj.bind(py); // Py&lt;MyClass&gt;::bind è¿”å› &amp;Bound&lt;'py, MyClass&gt;
    let obj_ref = bound.borrow(); // è·å– PyRef&lt;T&gt;
    assert_eq!(obj_ref.num, 1);
});</code></pre>
<h3 id="å†»ç»“ç±»é€€å‡ºå†…éƒ¨å¯å˜æ€§"><a class="header" href="#å†»ç»“ç±»é€€å‡ºå†…éƒ¨å¯å˜æ€§">å†»ç»“ç±»ï¼šé€€å‡ºå†…éƒ¨å¯å˜æ€§</a></h3>
<p>å¦‚ä¸Šæ‰€è¿°ï¼Œè¿è¡Œæ—¶å€Ÿç”¨æ£€æŸ¥ç›®å‰é»˜è®¤å¯ç”¨ã€‚ä½†ç±»å¯ä»¥é€šè¿‡å£°æ˜ä¸º <code>frozen</code> æ¥é€‰æ‹©é€€å‡ºã€‚å®ƒä»å¯é€šè¿‡ <code>RefCell</code> æˆ– <code>Mutex</code> ç­‰æ ‡å‡† Rust ç±»å‹ä½¿ç”¨å†…éƒ¨å¯å˜æ€§ï¼Œä½†ä¸å†å—é™äº PyO3 æä¾›çš„å®ç°ï¼Œå¯ä»¥é€å­—æ®µé€‰æ‹©æœ€åˆé€‚çš„ç­–ç•¥ã€‚</p>
<p>æ ‡è®°ä¸º <code>frozen</code> ä¸”ä¸º <code>Sync</code> çš„ç±»ï¼ˆä¾‹å¦‚ä½¿ç”¨ <code>Mutex</code> ä½†ä¸ä½¿ç”¨ <code>RefCell</code>ï¼‰ï¼Œå¯ä»¥é€šè¿‡ <code>Bound::get</code> å’Œ <code>Py::get</code> æ–¹æ³•ç›´æ¥è®¿é—®ï¼Œè€Œæ— éœ€ <code>Python</code> tokenï¼š</p>
<pre><code class="language-rust">use std::sync::atomic::{AtomicUsize, Ordering};
<span class="boring">use pyo3::prelude::*;
</span>

#[pyclass(frozen)]
struct FrozenCounter {
    value: AtomicUsize,
}


let py_counter: Py&lt;FrozenCounter&gt; = Python::attach(|py| {
    let counter = FrozenCounter {
        value: AtomicUsize::new(0),
    };


    Py::new(py, counter).unwrap()
});


py_counter.get().value.fetch_add(1, Ordering::Relaxed);


Python::attach(move |_py| drop(py_counter));</code></pre>
<p>æœªæ¥ <code>frozen</code> ç±»å¯èƒ½ä¼šæˆä¸ºé»˜è®¤è¡Œä¸ºï¼Œä»¥å¼•å¯¼ PyO3 ç”Ÿæ€ç³»ç»Ÿæ›´æ˜ç¡®åœ°åº”ç”¨å†…éƒ¨å¯å˜æ€§ã€‚æœ€ç»ˆè¿™åº”èƒ½å®ç°å¯¹ PyO3 å†…éƒ¨æœºåˆ¶çš„è¿›ä¸€æ­¥ä¼˜åŒ–ï¼Œå¹¶é¿å…ä¸‹æ¸¸ä»£ç åœ¨ä¸éœ€è¦æ—¶æ‰¿æ‹…å†…éƒ¨å¯å˜æ€§çš„å¼€é”€ã€‚</p>
<h2 id="è‡ªå®šä¹‰ç±»"><a class="header" href="#è‡ªå®šä¹‰ç±»">è‡ªå®šä¹‰ç±»</a></h2>
<p><code>#[pyclass]</code> å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‚æ•°ï¼š</p>
<div class="table-wrapper">
<table>
<thead>
<tr><th style="text-align: left">å‚æ•°</th><th style="text-align: left">è¯´æ˜</th></tr>
</thead>
<tbody>
<tr><td style="text-align: left"><code>constructor</code></td><td style="text-align: left">ç›®å‰ä»…å…è®¸ç”¨äº<a href="https://pyo3.rs/latest/class.html#complex-enums">å¤æ‚æšä¸¾çš„å˜ä½“</a>ã€‚å¯ç”¨äºè‡ªå®šä¹‰æ¯ä¸ªå˜ä½“çš„ç±»æ„é€ å‡½æ•°ã€‚å…¶è¯­æ³•ä¸å‡½æ•°å’Œæ–¹æ³•çš„ <code>signature</code> å±æ€§ç›¸åŒï¼Œæ”¯æŒç›¸åŒçš„é€‰é¡¹ã€‚</td></tr>
<tr><td style="text-align: left"><span style="white-space: pre"><code>crate = "some::path"</code></span></td><td style="text-align: left">æŒ‡å®šå¯¼å…¥ <code>pyo3</code> crate çš„è·¯å¾„ï¼Œå¦‚æœå®ƒä¸åœ¨ <code>::pyo3</code> èŒƒå›´å†…ã€‚</td></tr>
<tr><td style="text-align: left"><code>dict</code></td><td style="text-align: left">ä¸ºæ­¤ç±»çš„å®ä¾‹æä¾›ä¸€ä¸ªç©ºçš„ <code>__dict__</code> ä»¥å­˜å‚¨è‡ªå®šä¹‰å±æ€§ã€‚</td></tr>
<tr><td style="text-align: left"><code>eq</code></td><td style="text-align: left">ä½¿ç”¨åº•å±‚ Rust æ•°æ®ç±»å‹çš„ <code>PartialEq</code> å®ç° <code>__eq__</code>ã€‚</td></tr>
<tr><td style="text-align: left"><code>eq_int</code></td><td style="text-align: left">å¯¹ç®€å•æšä¸¾ä½¿ç”¨ <code>__int__</code> å®ç° <code>__eq__</code>ã€‚</td></tr>
<tr><td style="text-align: left"><span style="white-space: pre"><code>extends = BaseType</code></span></td><td style="text-align: left">ä½¿ç”¨è‡ªå®šä¹‰åŸºç±»ã€‚é»˜è®¤ä¸º <a href="https://docs.rs/pyo3/latest/pyo3/types/struct.PyAny.html"><code>PyAny</code></a>ã€‚</td></tr>
<tr><td style="text-align: left"><span style="white-space: pre"><code>freelist = N</code></span></td><td style="text-align: left">å®ç°å¤§å°ä¸º N çš„<a href="https://en.wikipedia.org/wiki/Free_list">ç©ºé—²åˆ—è¡¨</a>ã€‚å¯¹äºé¢‘ç¹åˆ›å»ºå’Œåˆ é™¤çš„ç±»å‹ï¼Œå¯æå‡æ€§èƒ½ã€‚è¯·å¯¹ä»£ç è¿›è¡Œæ€§èƒ½åˆ†æä»¥ç¡®è®¤æ˜¯å¦é€‚ç”¨ <code>freelist</code>ã€‚</td></tr>
<tr><td style="text-align: left"><code>from_py_object</code></td><td style="text-align: left">ä¸ºæ­¤ pyclass å®ç° <code>FromPyObject</code>ã€‚è¦æ±‚ pyclass å®ç° <code>Clone</code>ã€‚</td></tr>
<tr><td style="text-align: left"><span style="white-space: pre"><code>frozen</code></span></td><td style="text-align: left">å£°æ˜ä½ çš„ pyclass æ˜¯ä¸å¯å˜çš„ã€‚åœ¨è·å–å¯¹ Rust ç»“æ„ä½“çš„å…±äº«å¼•ç”¨æ—¶å¯é¿å…å€Ÿç”¨æ£€æŸ¥å¼€é”€ï¼Œä½†ç¦ç”¨è·å–å¯å˜å¼•ç”¨çš„èƒ½åŠ›ã€‚</td></tr>
<tr><td style="text-align: left"><code>generic</code></td><td style="text-align: left">æ ¹æ® <a href="https://peps.python.org/pep-0560/">PEP 560</a> ä¸ºç±»å®ç°è¿è¡Œæ—¶å‚æ•°åŒ–ã€‚</td></tr>
<tr><td style="text-align: left"><code>get_all</code></td><td style="text-align: left">ä¸º pyclass çš„æ‰€æœ‰å­—æ®µç”Ÿæˆ getterã€‚</td></tr>
<tr><td style="text-align: left"><code>hash</code></td><td style="text-align: left">ä½¿ç”¨åº•å±‚ Rust æ•°æ®ç±»å‹çš„ <code>Hash</code> å®ç° <code>__hash__</code>ã€‚<em>éœ€è¦ <code>eq</code> å’Œ <code>frozen</code></em></td></tr>
<tr><td style="text-align: left"><code>immutable_type</code></td><td style="text-align: left">ä½¿ç±»å‹å¯¹è±¡ä¸å¯å˜ã€‚åœ¨å¯ç”¨ <code>abi3</code> ç‰¹æ€§æ—¶é€‚ç”¨äº 3.14+ï¼Œå¦åˆ™é€‚ç”¨äº 3.10+ã€‚</td></tr>
<tr><td style="text-align: left"><code>mapping</code></td><td style="text-align: left">å‘ŠçŸ¥ PyO3 è¯¥ç±»æ˜¯ <a href="https://pyo3.rs/latest/class/protocols.html#mapping--sequence-types"><code>Mapping</code></a>ï¼Œå› æ­¤å°†å…¶ C-API åºåˆ—æ§½ä½ç•™ç©ºã€‚</td></tr>
<tr><td style="text-align: left"><span style="white-space: pre"><code>module = "module_name"</code></span></td><td style="text-align: left">Python ä»£ç ä¼šè®¤ä¸ºè¯¥ç±»åœ¨æŒ‡å®šæ¨¡å—ä¸­å®šä¹‰ã€‚é»˜è®¤ä¸º <code>builtins</code>ã€‚</td></tr>
<tr><td style="text-align: left"><span style="white-space: pre"><code>name = "python_name"</code></span></td><td style="text-align: left">è®¾ç½® Python çœ‹åˆ°çš„ç±»åã€‚é»˜è®¤ä¸º Rust ç»“æ„ä½“çš„åç§°ã€‚</td></tr>
<tr><td style="text-align: left"><code>ord</code></td><td style="text-align: left">ä½¿ç”¨åº•å±‚ Rust æ•°æ®ç±»å‹çš„ <code>PartialOrd</code> å®ç° <code>__lt__</code>ã€<code>__gt__</code>ã€<code>__le__</code> å’Œ <code>__ge__</code>ã€‚<em>éœ€è¦ <code>eq</code></em></td></tr>
<tr><td style="text-align: left"><code>rename_all = "renaming_rule"</code></td><td style="text-align: left">å¯¹ç»“æ„ä½“çš„æ‰€æœ‰ getter å’Œ setterï¼Œæˆ–æšä¸¾çš„æ‰€æœ‰å˜ä½“åº”ç”¨é‡å‘½åè§„åˆ™ã€‚å¯èƒ½çš„å€¼æœ‰ï¼šâ€œcamelCaseâ€ã€â€œkebab-caseâ€ã€â€œlowercaseâ€ã€â€œPascalCaseâ€ã€â€œSCREAMING-KEBAB-CASEâ€ã€â€œSCREAMING_SNAKE_CASEâ€ã€â€œsnake_caseâ€ã€â€œUPPERCASEâ€ã€‚</td></tr>
<tr><td style="text-align: left"><code>sequence</code></td><td style="text-align: left">å‘ŠçŸ¥ PyO3 è¯¥ç±»æ˜¯ <a href="https://pyo3.rs/latest/class/protocols.html#mapping--sequence-types"><code>Sequence</code></a>ï¼Œå› æ­¤å°†å…¶ C-API æ˜ å°„é•¿åº¦æ§½ä½ç•™ç©ºã€‚</td></tr>
<tr><td style="text-align: left"><code>set_all</code></td><td style="text-align: left">ä¸º pyclass çš„æ‰€æœ‰å­—æ®µç”Ÿæˆ setterã€‚</td></tr>
<tr><td style="text-align: left"><code>skip_from_py_object</code></td><td style="text-align: left">é˜»æ­¢è¯¥ PyClass å‚ä¸ <code>FromPyObject: PyClass + Clone</code> çš„é€šé…å®ç°ã€‚è¿™å…è®¸è‡ªå®šä¹‰ <code>FromPyObject</code> å®ç°ï¼Œå³ä½¿ <code>self</code> æ˜¯ <code>Clone</code>ã€‚</td></tr>
<tr><td style="text-align: left"><code>str</code></td><td style="text-align: left">ä½¿ç”¨åº•å±‚ Rust æ•°æ®ç±»å‹çš„ <code>Display</code> å®ç° <code>__str__</code>ï¼Œæˆ–é€šè¿‡å¯é€‰æ ¼å¼å­—ç¬¦ä¸² <code>str="&lt;format string&gt;"</code> å®ç°ã€‚<em>æ³¨æ„ï¼šå¯é€‰æ ¼å¼å­—ç¬¦ä¸²ä»…å¯¹ç»“æ„ä½“æœ‰æ•ˆã€‚<code>name</code> å’Œ <code>rename_all</code> ä¸èƒ½ä¸å¯é€‰æ ¼å¼å­—ç¬¦ä¸²åŒæ—¶ä½¿ç”¨ã€‚æ›´å¤šç»†èŠ‚è§æ­¤ <a href="https://github.com/PyO3/pyo3/pull/4233">PR</a> çš„è®¨è®ºã€‚</em></td></tr>
<tr><td style="text-align: left"><code>subclass</code></td><td style="text-align: left">å…è®¸å…¶ä»– Python ç±»å’Œ <code>#[pyclass]</code> ç»§æ‰¿è¯¥ç±»ã€‚æšä¸¾ä¸èƒ½è¢«ç»§æ‰¿ã€‚</td></tr>
<tr><td style="text-align: left"><code>unsendable</code></td><td style="text-align: left">å¦‚æœä½ çš„ç»“æ„ä½“ä¸æ˜¯ <a href="https://doc.rust-lang.org/std/marker/trait.Send.html"><code>Send</code></a>ï¼Œåˆ™éœ€è¦æ­¤å‚æ•°ã€‚ç›¸æ¯”ä½¿ç”¨ <code>unsendable</code>ï¼Œå»ºè®®é€šè¿‡ä¾‹å¦‚ç”¨ <a href="https://doc.rust-lang.org/std/sync/struct.Arc.html"><code>Arc</code></a> æ›¿ä»£ <a href="https://doc.rust-lang.org/std/rc/struct.Rc.html"><code>Rc</code></a> çš„æ–¹å¼ä½¿ç»“æ„ä½“çº¿ç¨‹å®‰å…¨ã€‚ä½¿ç”¨ <code>unsendable</code> ä¼šå¯¼è‡´ç±»åœ¨è¢«å…¶ä»–çº¿ç¨‹è®¿é—®æ—¶ panicã€‚è¿˜éœ€æ³¨æ„ï¼ŒPython çš„ GC æ˜¯å¤šçº¿ç¨‹çš„ï¼Œè™½ç„¶é <code>Send</code> ç±»åœ¨å…¶ä»–çº¿ç¨‹ä¸Šä¸ä¼šè¢«éå†æ¥é¿å…æœªå®šä¹‰è¡Œä¸ºï¼Œä½†è¿™å¯èƒ½å¯¼è‡´å†…å­˜æ³„æ¼ã€‚</td></tr>
<tr><td style="text-align: left"><code>weakref</code></td><td style="text-align: left">å…è®¸è¯¥ç±»è¢«<a href="https://docs.python.org/3/library/weakref.html">å¼±å¼•ç”¨</a>ã€‚</td></tr>
</tbody>
</table>
</div>
<p>æ‰€æœ‰è¿™äº›å‚æ•°å¯ä»¥ç›´æ¥ä¼ é€’ç»™ <code>#[pyclass(...)]</code> æ³¨è§£ï¼Œä¹Ÿå¯ä»¥ä½œä¸ºä¸€æˆ–å¤šä¸ªç‹¬ç«‹çš„ <code>#[pyo3(...)]</code> æ³¨è§£ä¼ å…¥ï¼Œä¾‹å¦‚ï¼š</p>
<pre><code class="language-rust ignore">// å‚æ•°ç›´æ¥æä¾›ç»™ `#[pyclass]` æ³¨è§£ã€‚
#[pyclass(name = "SomeName", subclass)]
struct MyClass {}


// å‚æ•°ä½œä¸ºå•ç‹¬æ³¨è§£æä¾›ã€‚
#[pyclass]
#[pyo3(name = "SomeName", subclass)]
struct MyClass {}</code></pre>
<p>è¿™äº›å‚æ•°åœ¨æœ¬æŒ‡å—çš„å„ä¸ªéƒ¨åˆ†ä¸­å‡æœ‰ä»‹ç»ã€‚</p>
<h3 id="è¿”å›ç±»å‹"><a class="header" href="#è¿”å›ç±»å‹">è¿”å›ç±»å‹</a></h3>
<p>é€šå¸¸ï¼Œ<code>#[new]</code> æ–¹æ³•å¿…é¡»è¿”å› <code>T: Into&lt;PyClassInitializer&lt;Self&gt;&gt;</code> æˆ– <code>PyResult&lt;T&gt; where T: Into&lt;PyClassInitializer&lt;Self&gt;&gt;</code>ã€‚</p>
<p>å¯¹äºå¯èƒ½å¤±è´¥çš„æ„é€ å‡½æ•°ï¼Œä½ ä¹Ÿåº”å°†è¿”å›ç±»å‹åŒ…è£…åœ¨ <code>PyResult</code> ä¸­ã€‚è¯·å‚é˜…ä¸‹è¡¨ä»¥ç¡®å®šæ„é€ å‡½æ•°åº”è¿”å›çš„ç±»å‹ï¼š</p>
<div class="table-wrapper">
<table>
<thead>
<tr><th></th><th><strong>ä¸ä¼šå¤±è´¥</strong></th><th><strong>å¯èƒ½å¤±è´¥</strong></th></tr>
</thead>
<tbody>
<tr><td><strong>æ— ç»§æ‰¿</strong></td><td><code>T</code></td><td><code>PyResult&lt;T&gt;</code></td></tr>
<tr><td><strong>ç»§æ‰¿(T ç»§æ‰¿ U)</strong></td><td><code>(T, U)</code></td><td><code>PyResult&lt;(T, U)&gt;</code></td></tr>
<tr><td><strong>ç»§æ‰¿(ä¸€èˆ¬æƒ…å†µ)</strong></td><td>[<code>PyClassInitializer&lt;T&gt;</code>]</td><td><code>PyResult&lt;PyClassInitializer&lt;T&gt;&gt;</code></td></tr>
</tbody>
</table>
</div>
<h2 id="ç»§æ‰¿"><a class="header" href="#ç»§æ‰¿">ç»§æ‰¿</a></h2>
<p>é»˜è®¤æƒ…å†µä¸‹ï¼Œ<code>object</code>ï¼ˆå³ <code>PyAny</code>ï¼‰è¢«ç”¨ä½œåŸºç±»ã€‚è¦è¦†ç›–æ­¤é»˜è®¤è®¾ç½®ï¼Œè¯·åœ¨ <code>pyclass</code> ä¸­ä½¿ç”¨ <code>extends</code> å‚æ•°å¹¶æŒ‡å®šåŸºç±»çš„å®Œæ•´è·¯å¾„ã€‚ç›®å‰ï¼Œåªèƒ½ç»§æ‰¿ç”¨ Rust å®šä¹‰çš„ç±»ä»¥åŠ PyO3 æä¾›çš„å†…ç½®ç±»å‹ï¼›å°šä¸æ”¯æŒç»§æ‰¿ç”¨ Python å®šä¹‰çš„å…¶ä»–ç±»ï¼ˆ<a href="https://github.com/PyO3/pyo3/issues/991">#991</a>ï¼‰ã€‚</p>
<p>ä¸ºæ–¹ä¾¿èµ·è§ï¼Œ<code>(T, U)</code> å®ç°äº† <code>Into&lt;PyClassInitializer&lt;T&gt;&gt;</code>ï¼Œå…¶ä¸­ <code>U</code> æ˜¯ <code>T</code> çš„åŸºç±»ã€‚ä½†å¯¹äºæ›´æ·±å±‚æ¬¡çš„ç»§æ‰¿ï¼Œå¿…é¡»æ˜¾å¼è¿”å› <code>PyClassInitializer&lt;T&gt;</code>ã€‚</p>
<p>è¦ä»å­ç±»ä¸­è·å–çˆ¶ç±»ï¼Œè¯·åœ¨æ–¹æ³•ä¸­ä½¿ç”¨ [<code>PyRef</code>] æ›¿ä»£ <code>&amp;self</code>ï¼Œæˆ–ä½¿ç”¨ [<code>PyRefMut</code>] æ›¿ä»£ <code>&amp;mut self</code>ã€‚ç„¶åå¯é€šè¿‡ <code>self_.as_super()</code> ä»¥ <code>&amp;PyRef&lt;Self::BaseClass&gt;</code> çš„å½¢å¼è®¿é—®çˆ¶ç±»ï¼Œæˆ–é€šè¿‡ <code>self_.into_super()</code> ä»¥ <code>PyRef&lt;Self::BaseClass&gt;</code> çš„å½¢å¼è®¿é—®ï¼ˆ<code>PyRefMut</code> æƒ…å†µç±»ä¼¼ï¼‰ã€‚ä¸ºæ–¹ä¾¿èµ·è§ï¼Œä¹Ÿå¯ä½¿ç”¨ <code>self_.as_ref()</code> ç›´æ¥è·å– <code>&amp;Self::BaseClass</code>ï¼›ä½†æ­¤æ–¹å¼æ— æ³•è®¿é—®ç»§æ‰¿å±‚æ¬¡ç»“æ„ä¸­æ›´ä¸Šå±‚çš„åŸºç±»ï¼Œè¦è®¿é—®é‚£äº›ç±»éœ€å¤šæ¬¡é“¾å¼è°ƒç”¨ <code>as_super</code> æˆ– <code>into_super</code>ã€‚</p>
<pre><code class="language-rust"><span class="boring">use pyo3::prelude::*;
</span>

#[pyclass(subclass)]
struct BaseClass {
    val1: usize,
}


#[pymethods]
impl BaseClass {
    #[new]
    fn new() -&gt; Self {
        BaseClass { val1: 10 }
    }


    pub fn method1(&amp;self) -&gt; PyResult&lt;usize&gt; {
        Ok(self.val1)
    }
}


#[pyclass(extends=BaseClass, subclass)]
struct SubClass {
    val2: usize,
}


#[pymethods]
impl SubClass {
    #[new]
    fn new() -&gt; (Self, BaseClass) {
        (SubClass { val2: 15 }, BaseClass::new())
    }


    fn method2(self_: PyRef&lt;'_, Self&gt;) -&gt; PyResult&lt;usize&gt; {
        let super_ = self_.as_super(); // è·å– &amp;PyRef&lt;BaseClass&gt;
        super_.method1().map(|x| x * self_.val2)
    }
}


#[pyclass(extends=SubClass)]
struct SubSubClass {
    val3: usize,
}


#[pymethods]
impl SubSubClass {
    #[new]
    fn new() -&gt; PyClassInitializer&lt;Self&gt; {
        PyClassInitializer::from(SubClass::new()).add_subclass(SubSubClass { val3: 20 })
    }


    fn method3(self_: PyRef&lt;'_, Self&gt;) -&gt; PyResult&lt;usize&gt; {
        let base = self_.as_super().as_super(); // è·å– &amp;PyRef&lt;'_, BaseClass&gt;
        base.method1().map(|x| x * self_.val3)
    }


    fn method4(self_: PyRef&lt;'_, Self&gt;) -&gt; PyResult&lt;usize&gt; {
        let v = self_.val3;
        let super_ = self_.into_super(); // è·å– PyRef&lt;'_, SubClass&gt;
        SubClass::method2(super_).map(|x| x * v)
    }


      fn get_values(self_: PyRef&lt;'_, Self&gt;) -&gt; (usize, usize, usize) {
          let val1 = self_.as_super().as_super().val1;
          let val2 = self_.as_super().val2;
          (val1, val2, self_.val3)
      }


    fn double_values(mut self_: PyRefMut&lt;'_, Self&gt;) {
        self_.as_super().as_super().val1 *= 2;
        self_.as_super().val2 *= 2;
        self_.val3 *= 2;
    }


    #[staticmethod]
    fn factory_method(py: Python&lt;'_&gt;, val: usize) -&gt; PyResult&lt;Py&lt;PyAny&gt;&gt; {
        let base = PyClassInitializer::from(BaseClass::new());
        let sub = base.add_subclass(SubClass { val2: val });
        if val % 2 == 0 {
            Ok(Py::new(py, sub)?.into_any())
        } else {
            let sub_sub = sub.add_subclass(SubSubClass { val3: val });
            Ok(Py::new(py, sub_sub)?.into_any())
        }
    }
}
<span class="boring">Python::attach(|py| {
</span><span class="boring">    let subsub = pyo3::Py::new(py, SubSubClass::new()).unwrap();
</span><span class="boring">    pyo3::py_run!(py, subsub, "assert subsub.method1() == 10");
</span><span class="boring">    pyo3::py_run!(py, subsub, "assert subsub.method2() == 150");
</span><span class="boring">    pyo3::py_run!(py, subsub, "assert subsub.method3() == 200");
</span><span class="boring">    pyo3::py_run!(py, subsub, "assert subsub.method4() == 3000");
</span><span class="boring">    pyo3::py_run!(py, subsub, "assert subsub.get_values() == (10, 15, 20)");
</span><span class="boring">    pyo3::py_run!(py, subsub, "assert subsub.double_values() == None");
</span><span class="boring">    pyo3::py_run!(py, subsub, "assert subsub.get_values() == (20, 30, 40)");
</span><span class="boring">    let subsub = SubSubClass::factory_method(py, 2).unwrap();
</span><span class="boring">    let subsubsub = SubSubClass::factory_method(py, 3).unwrap();
</span><span class="boring">    let cls = py.get_type::&lt;SubSubClass&gt;();
</span><span class="boring">    pyo3::py_run!(py, subsub cls, "assert not isinstance(subsub, cls)");
</span><span class="boring">    pyo3::py_run!(py, subsubsub cls, "assert isinstance(subsubsub, cls)");
</span><span class="boring">});
</span>```ä½ å¯ä»¥ç»§æ‰¿åŸç”Ÿç±»å‹ï¼Œä¾‹å¦‚ `PyDict`ï¼Œå‰ææ˜¯å®ƒä»¬å®ç°äº† [`PySizedLayout`]({{#PYO3_DOCS_URL}}/pyo3/type_object/trait.PySizedLayout.html)ã€‚å½“ä½¿ç”¨ Python æœ‰é™ APIï¼ˆå³ PyO3 çš„ `abi3` åŠŸèƒ½ï¼‰æ„å»ºæ—¶ï¼Œä¸æ”¯æŒæ­¤åŠŸèƒ½ã€‚

è¦åœ¨ Rust ç±»å‹åŠå…¶åŸç”ŸåŸºç±»ä¹‹é—´è½¬æ¢ï¼Œå¯ä»¥å°† `slf` ä½œä¸º Python å¯¹è±¡ä½¿ç”¨ã€‚é€šè¿‡ `slf.borrow()` æˆ– `slf.borrow_mut()` è®¿é—® Rust å­—æ®µï¼Œé€šè¿‡ `slf.cast::&lt;BaseClass&gt;()` è®¿é—®åŸºç±»ã€‚

```rust
<span class="boring">#[cfg(not(Py_LIMITED_API))] {
</span><span class="boring">use pyo3::prelude::*;
</span>use pyo3::types::PyDict;
use std::collections::HashMap;


#[pyclass(extends=PyDict)]
#[derive(Default)]
struct DictWithCounter {
    counter: HashMap&lt;String, usize&gt;,
}


#[pymethods]
impl DictWithCounter {
    #[new]
    fn new() -&gt; Self {
        Self::default()
    }


    fn set(slf: &amp;Bound&lt;'_, Self&gt;, key: String, value: Bound&lt;'_, PyAny&gt;) -&gt; PyResult&lt;()&gt; {
        slf.borrow_mut().counter.entry(key.clone()).or_insert(0);
        let dict = slf.cast::&lt;PyDict&gt;()?;
        dict.set_item(key, value)
    }
}
<span class="boring">Python::attach(|py| {
</span><span class="boring">    let cnt = pyo3::Py::new(py, DictWithCounter::new()).unwrap();
</span><span class="boring">    pyo3::py_run!(py, cnt, "cnt.set('abc', 10); assert cnt['abc'] == 10")
</span><span class="boring">});
</span><span class="boring">}</span></code></pre>
<p>å¦‚æœ <code>SubClass</code> æ²¡æœ‰æä¾›åŸºç±»çš„åˆå§‹åŒ–ï¼Œç¼–è¯‘å°†ä¼šå¤±è´¥ã€‚</p>
<pre><code class="language-rust compile_fail"><span class="boring">use pyo3::prelude::*;
</span>

#[pyclass]
struct BaseClass {
    val1: usize,
}


#[pyclass(extends=BaseClass)]
struct SubClass {
    val2: usize,
}


#[pymethods]
impl SubClass {
    #[new]
    fn new() -&gt; Self {
        SubClass { val2: 15 }
    }
}</code></pre>
<p>å½“ä» Python åˆ›å»ºæ–°å®ä¾‹æ—¶ï¼ŒåŸç”ŸåŸºç±»çš„ <code>__new__</code> æ„é€ å‡½æ•°ä¼šéšå¼è°ƒç”¨ã€‚è¯·ç¡®ä¿åœ¨ <code>#[new]</code> æ–¹æ³•ä¸­æ¥å—ä½ éœ€è¦åŸºç±»è·å–çš„å‚æ•°ï¼Œå³ä½¿è¿™äº›å‚æ•°æœªåœ¨å‡½æ•°ä¸­ä½¿ç”¨ï¼š</p>
<pre><code class="language-rust"><span class="boring">#[allow(dead_code)]
</span><span class="boring">#[cfg(not(Py_LIMITED_API))] {
</span><span class="boring">use pyo3::prelude::*;
</span>use pyo3::types::PyDict;


#[pyclass(extends=PyDict)]
struct MyDict {
    private: i32,
}


#[pymethods]
impl MyDict {
    #[new]
    #[pyo3(signature = (*args, **kwargs))]
    fn new(args: &amp;Bound&lt;'_, PyAny&gt;, kwargs: Option&lt;&amp;Bound&lt;'_, PyAny&gt;&gt;) -&gt; Self {
        Self { private: 0 }
    }


    // ä¸€äº›ä½¿ç”¨ `private` çš„è‡ªå®šä¹‰æ–¹æ³•...
}
<span class="boring">Python::attach(|py| {
</span><span class="boring">    let cls = py.get_type::&lt;MyDict&gt;();
</span><span class="boring">    pyo3::py_run!(py, cls, "cls(a=1, b=2)")
</span><span class="boring">});
</span><span class="boring">}</span></code></pre>
<p>åœ¨è¿™é‡Œï¼Œ<code>args</code> å’Œ <code>kwargs</code> å…è®¸åœ¨åˆ›å»ºå­ç±»å®ä¾‹æ—¶ä¼ å…¥åˆå§‹é¡¹ï¼Œä¾‹å¦‚ <code>MyDict(item_sequence)</code> æˆ– <code>MyDict(a=1, b=2)</code>ã€‚</p>
<h2 id="å¯¹è±¡å±æ€§"><a class="header" href="#å¯¹è±¡å±æ€§">å¯¹è±¡å±æ€§</a></h2>
<p>PyO3 æ”¯æŒä¸¤ç§æ–¹å¼ä¸ºä½ çš„ <code>#[pyclass]</code> æ·»åŠ å±æ€§ï¼š</p>
<ul>
<li>å¯¹äºæ²¡æœ‰å‰¯ä½œç”¨çš„ç®€å•ç»“æ„ä½“å­—æ®µï¼Œå¯ä»¥åœ¨ <code>#[pyclass]</code> å­—æ®µå®šä¹‰ä¸Šç›´æ¥æ·»åŠ  <code>#[pyo3(get, set)]</code> å±æ€§ï¼›</li>
<li>å¯¹äºéœ€è¦è®¡ç®—çš„å±æ€§ï¼Œå¯ä»¥å®šä¹‰ <code>#[getter]</code> å’Œ <code>#[setter]</code> æ–¹æ³•åœ¨ <a href="#instance-methods"><code>#[pymethods]</code></a> å—ä¸­ã€‚</li>
</ul>
<p>æˆ‘ä»¬å°†åœ¨ä»¥ä¸‹ç« èŠ‚åˆ†åˆ«è¯´æ˜ã€‚</p>
<h3 id="ä½¿ç”¨-pyo3get-set-çš„å¯¹è±¡å±æ€§"><a class="header" href="#ä½¿ç”¨-pyo3get-set-çš„å¯¹è±¡å±æ€§">ä½¿ç”¨ <code>#[pyo3(get, set)]</code> çš„å¯¹è±¡å±æ€§</a></h3>
<p>åœ¨åªæ˜¯è¯»å†™æ— å‰¯ä½œç”¨çš„æˆå‘˜å˜é‡è¿™ç§ç®€å•æƒ…å†µä¸‹ï¼Œä½ å¯ä»¥ä½¿ç”¨ <code>pyo3</code> å±æ€§åœ¨ <code>#[pyclass]</code> å­—æ®µå®šä¹‰ä¸­å£°æ˜ getter å’Œ setterï¼Œä¾‹å¦‚ä»¥ä¸‹ç¤ºä¾‹ï¼š</p>
<pre><code class="language-rust"><span class="boring">use pyo3::prelude::*;
</span><span class="boring">#[allow(dead_code)]
</span>#[pyclass]
struct MyClass {
    #[pyo3(get, set)]
    num: i32,
}</code></pre>
<p>å¦‚ä¸Šä»£ç å°†ä½¿ <code>num</code> å­—æ®µå¯ä½œä¸º <code>self.num</code> è¿™ä¸€ Python å±æ€§è¿›è¡Œè¯»å†™ã€‚è‹¥éœ€ä»¥ä¸å­—æ®µä¸åŒçš„åç§°æš´éœ²è¯¥å±æ€§ï¼Œå¯å°†è¯¥åç§°ä¸å…¶ä»–é€‰é¡¹ä¸€åŒæŒ‡å®šï¼Œä¾‹å¦‚ <code>#[pyo3(get, set, name = "custom_name")]</code>ã€‚</p>
<p>å¯ä»¥ä»…ä½¿ç”¨ <code>#[pyo3(get)]</code> æˆ– <code>#[pyo3(set)]</code> åˆ†åˆ«å®ç°åªè¯»æˆ–åªå†™å±æ€§ã€‚</p>
<p>è¦ä½¿ç”¨è¿™äº›æ³¨è§£ï¼Œå­—æ®µç±»å‹å¿…é¡»å®ç°æŸäº›è½¬æ¢ traitï¼š</p>
<ul>
<li>å¯¹äº <code>get</code>ï¼Œå­—æ®µç±»å‹ <code>T</code> å¿…é¡»å®ç° <code>&amp;T: IntoPyObject</code> æˆ– <code>T: IntoPyObject + Clone</code>ï¼›</li>
<li>å¯¹äº <code>set</code>ï¼Œå­—æ®µç±»å‹å¿…é¡»å®ç° <code>FromPyObject</code>ã€‚</li>
</ul>
<p>ä¾‹å¦‚ï¼Œ<code>Cell</code> ç±»å‹æä¾›äº†è¿™äº› trait çš„å®ç°ï¼ˆå‰ææ˜¯å…¶å†…éƒ¨ç±»å‹ä¹Ÿå®ç°äº†è¯¥ traitï¼‰ã€‚è¿™æ„å‘³ç€ä½ å¯ä»¥åœ¨ <code>Cell</code> åŒ…è£¹çš„å­—æ®µä¸Šä½¿ç”¨ <code>#[pyo3(get, set)]</code>ã€‚</p>
<h3 id="ä½¿ç”¨-getter-å’Œ-setter-çš„å¯¹è±¡å±æ€§"><a class="header" href="#ä½¿ç”¨-getter-å’Œ-setter-çš„å¯¹è±¡å±æ€§">ä½¿ç”¨ <code>#[getter]</code> å’Œ <code>#[setter]</code> çš„å¯¹è±¡å±æ€§</a></h3>
<p>å¯¹äºä¸æ»¡è¶³ <code>#[pyo3(get, set)]</code> trait è¦æ±‚ï¼Œæˆ–éœ€è¦å‰¯ä½œç”¨çš„æƒ…å†µï¼Œå¯ä»¥åœ¨ <code>#[pymethods]</code> çš„ <code>impl</code> å—ä¸­å®šä¹‰æè¿°ç¬¦æ–¹æ³•ã€‚</p>
<p>è¿™é€šè¿‡ä½¿ç”¨ <code>#[getter]</code> å’Œ <code>#[setter]</code> å±æ€§å®ç°ï¼Œå¦‚ä¸‹ä¾‹æ‰€ç¤ºï¼š</p>
<pre><code class="language-rust"><span class="boring">use pyo3::prelude::*;
</span>#[pyclass]
struct MyClass {
    num: i32,
}


#[pymethods]
impl MyClass {
    #[getter]
    fn num(&amp;self) -&gt; PyResult&lt;i32&gt; {
        Ok(self.num)
    }
}</code></pre>
<p>é»˜è®¤æƒ…å†µä¸‹ï¼Œgetter æˆ– setter çš„å‡½æ•°åå³ä¸ºå±æ€§åã€‚æœ‰å‡ ç§æ–¹å¼å¯ä»¥è¦†ç›–è¯¥åç§°ã€‚</p>
<p>å¦‚æœå‡½æ•°åä»¥ <code>get_</code> æˆ– <code>set_</code> å¼€å¤´ï¼ˆåˆ†åˆ«å¯¹åº” getter å’Œ setterï¼‰ï¼Œåˆ™å±æ€§åå°†ä¸ºå»é™¤è¯¥å‰ç¼€åçš„å‡½æ•°åã€‚è¿™åœ¨å‡½æ•°åä¸º Rust å…³é”®å­—ï¼ˆå¦‚ <code>type</code>ï¼‰æ—¶ä¹Ÿå¾ˆæœ‰ç”¨ï¼ˆè‡ª Rust 2018 èµ·å¯ä½¿ç”¨<a href="https://doc.rust-lang.org/edition-guide/rust-2018/module-system/raw-identifiers.html">åŸç”Ÿæ ‡è¯†ç¬¦</a>ï¼‰ã€‚</p>
<pre><code class="language-rust"><span class="boring">use pyo3::prelude::*;
</span><span class="boring">#[pyclass]
</span><span class="boring">struct MyClass {
</span><span class="boring">    num: i32,
</span><span class="boring">}
</span>#[pymethods]
impl MyClass {
    #[getter]
    fn get_num(&amp;self) -&gt; PyResult&lt;i32&gt; {
        Ok(self.num)
    }


    #[setter]
    fn set_num(&amp;mut self, value: i32) -&gt; PyResult&lt;()&gt; {
        self.num = value;
        Ok(())
    }
}</code></pre>
<p>æ­¤æ—¶ä¼šå®šä¹‰åä¸º <code>num</code> çš„å±æ€§ï¼Œå¹¶å¯é€šè¿‡ <code>self.num</code> ä» Python ä»£ç è®¿é—®ã€‚</p>
<p><code>#[getter]</code> å’Œ <code>#[setter]</code> å±æ€§éƒ½æ¥å—ä¸€ä¸ªå‚æ•°ã€‚å¦‚æœæŒ‡å®šäº†è¯¥å‚æ•°ï¼Œåˆ™å°†å…¶ä½œä¸ºå±æ€§åï¼Œä¾‹å¦‚ï¼š</p>
<pre><code class="language-rust"><span class="boring">use pyo3::prelude::*;
</span><span class="boring">#[pyclass]
</span><span class="boring">struct MyClass {
</span><span class="boring">   num: i32,
</span><span class="boring">}
</span>#[pymethods]
impl MyClass {
    #[getter(number)]
    fn num(&amp;self) -&gt; PyResult&lt;i32&gt; {
        Ok(self.num)
    }


    #[setter(number)]
    fn set_num(&amp;mut self, value: i32) -&gt; PyResult&lt;()&gt; {
        self.num = value;
        Ok(())
    }
}</code></pre>
<p>æ­¤æ—¶ä¼šå®šä¹‰åä¸º <code>number</code> çš„å±æ€§ï¼Œå¹¶å¯é€šè¿‡ <code>self.number</code> ä» Python ä»£ç è®¿é—®ã€‚</p>
<p>ç”± <code>#[setter]</code> æˆ– <code>#[pyo3(set)]</code> å®šä¹‰çš„å±æ€§åœ¨ <code>del</code> æ“ä½œæ—¶æ€»æ˜¯ä¼šå¼•å‘ <code>AttributeError</code>ã€‚è‡ªå®šä¹‰ <code>del</code> è¡Œä¸ºçš„æ”¯æŒæ­£åœ¨è¢«è¿½è¸ªäº <a href="https://github.com/PyO3/pyo3/issues/1778">#1778</a>ã€‚</p>
<h2 id="å®ä¾‹æ–¹æ³•"><a class="header" href="#å®ä¾‹æ–¹æ³•">å®ä¾‹æ–¹æ³•</a></h2>
<p>è¦å®šä¹‰å…¼å®¹ Python çš„æ–¹æ³•ï¼Œéœ€è¦åœ¨ç»“æ„ä½“çš„ <code>impl</code> å—ä¸Šæ·»åŠ  <code>#[pymethods]</code> å±æ€§ã€‚PyO3 ä¼šä¸ºè¯¥å—ä¸­çš„æ‰€æœ‰å‡½æ•°ç”Ÿæˆå…¼å®¹ Python çš„åŒ…è£…å™¨ï¼ŒåŒ…æ‹¬æè¿°ç¬¦ã€ç±»æ–¹æ³•ã€é™æ€æ–¹æ³•ç­‰å˜ä½“ã€‚</p>
<p>ç”±äº Rust å…è®¸å¤šä¸ª <code>impl</code> å—ï¼Œä½ å¯ä»¥è½»æ¾åœ°åŒºåˆ†å¯¹ Pythonï¼ˆåŠ Rustï¼‰å…¬å¼€çš„æ–¹æ³•å’Œåªå¯¹ Rust å…¬å¼€çš„æ–¹æ³•ã€‚ä½†è‹¥éœ€è¦ä¸ºåŒä¸€ç»“æ„ä½“å®šä¹‰å¤šä¸ª <code>#[pymethods]</code> å—ï¼Œåˆ™å¿…é¡»å¯ç”¨ PyO3 çš„ [<code>multiple-pymethods</code>] ç‰¹æ€§ã€‚</p>
<pre><code class="language-rust"><span class="boring">use pyo3::prelude::*;
</span><span class="boring">#[pyclass]
</span><span class="boring">struct MyClass {
</span><span class="boring">    num: i32,
</span><span class="boring">}
</span>#[pymethods]
impl MyClass {
    fn method1(&amp;self) -&gt; PyResult&lt;i32&gt; {
        Ok(10)
    }


    fn set_method(&amp;mut self, value: i32) -&gt; PyResult&lt;()&gt; {
        self.num = value;
        Ok(())
    }
}</code></pre>
<p>å¯ä»¥ä½¿ç”¨ <code>&amp;self</code> æˆ– <code>&amp;mut self</code>ï¼Œè¿™å¾—ç›Šäºä½¿ç”¨äº† <a href="#bound-and-interior-mutability">è¿è¡Œæ—¶å€Ÿç”¨æ£€æŸ¥</a>ã€‚</p>
<p>è¿”å›ç±»å‹å¿…é¡»æ˜¯ <code>PyResult&lt;T&gt;</code> æˆ– <code>T</code>ï¼Œå…¶ä¸­ <code>T</code> å®ç°äº† <code>IntoPyObject</code>ï¼›å¦‚æœæ–¹æ³•ä¸ä¼šå¼•å‘ Python å¼‚å¸¸ï¼Œåˆ™å…è®¸ä½¿ç”¨åä¸€ç§å½¢å¼ã€‚</p>
<p>æ–¹æ³•ç­¾åä¸­å¯åŒ…å«ä¸€ä¸ª <code>Python</code> å‚æ•°ï¼Œæ­¤æ—¶æ–¹æ³•åŒ…è£…å™¨ä¼šæ³¨å…¥ <code>py</code> å‚æ•°ï¼Œä¾‹å¦‚ï¼š</p>
<pre><code class="language-rust"><span class="boring">use pyo3::prelude::*;
</span><span class="boring">#[pyclass]
</span><span class="boring">struct MyClass {
</span><span class="boring">#[allow(dead_code)]
</span><span class="boring">    num: i32,
</span><span class="boring">}
</span>#[pymethods]
impl MyClass {
    fn method2(&amp;self, py: Python&lt;'_&gt;) -&gt; PyResult&lt;i32&gt; {
        Ok(10)
    }
}</code></pre>
<p>ä» Python è§†è§’æ¥çœ‹ï¼Œæ­¤ä¾‹ä¸­çš„ <code>method2</code> ä¸æ¥å—ä»»ä½•å‚æ•°ã€‚</p>
<h2 id="ç±»æ–¹æ³•"><a class="header" href="#ç±»æ–¹æ³•">ç±»æ–¹æ³•</a></h2>
<p>è¦ä¸ºè‡ªå®šä¹‰ç±»åˆ›å»ºç±»æ–¹æ³•ï¼Œéœ€ä½¿ç”¨ <code>#[classmethod]</code> å±æ€§æ ‡æ³¨æ–¹æ³•ã€‚è¿™ç­‰åŒäº Python ä¸­çš„ <code>@classmethod</code> è£…é¥°å™¨ã€‚</p>
<pre><code class="language-rust"><span class="boring">use pyo3::prelude::*;
</span><span class="boring">use pyo3::types::PyType;
</span><span class="boring">#[pyclass]
</span><span class="boring">struct MyClass {
</span><span class="boring">    #[allow(dead_code)]
</span><span class="boring">    num: i32,
</span><span class="boring">}
</span>#[pymethods]
impl MyClass {
    #[classmethod]
    fn cls_method(cls: &amp;Bound&lt;'_, PyType&gt;) -&gt; PyResult&lt;i32&gt; {
        Ok(10)
    }
}</code></pre>
<p>è¿™å£°æ˜äº†ä¸€ä¸ªå¯ç”± Python è°ƒç”¨çš„ç±»æ–¹æ³•ã€‚</p>
<ul>
<li>ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯è°ƒç”¨è¯¥æ–¹æ³•çš„ç±»çš„ç±»å‹å¯¹è±¡ï¼Œå¯èƒ½æ˜¯æ´¾ç”Ÿç±»çš„ç±»å‹å¯¹è±¡ï¼›</li>
<li>ç¬¬ä¸€ä¸ªå‚æ•°çš„ç±»å‹é»˜è®¤ä¸º <code>&amp;Bound&lt;'_, PyType&gt;</code>ï¼›</li>
<li>å…³äº <code>parameter-list</code> çš„ç»†èŠ‚ï¼Œè¯·å‚é˜… <code>æ–¹æ³•å‚æ•°</code> éƒ¨åˆ†æ–‡æ¡£ï¼›</li>
<li>è¿”å›ç±»å‹å¿…é¡»æ˜¯ <code>PyResult&lt;T&gt;</code> æˆ– <code>T</code>ï¼Œå…¶ä¸­ <code>T</code> å®ç°äº† <code>IntoPyObject</code>ã€‚</li>
</ul>
<h3 id="æ¥å—ç±»å‚æ•°çš„æ„é€ å‡½æ•°"><a class="header" href="#æ¥å—ç±»å‚æ•°çš„æ„é€ å‡½æ•°">æ¥å—ç±»å‚æ•°çš„æ„é€ å‡½æ•°</a></h3>
<p>è¦åˆ›å»ºä¸€ä¸ªæ¥å—ä½ç½®ç±»å‚æ•°çš„æ„é€ å‡½æ•°ï¼Œå¯ä»¥ç»„åˆä½¿ç”¨ <code>#[classmethod]</code> å’Œ <code>#[new]</code> ä¿®é¥°ç¬¦ï¼š</p>
<pre><code class="language-rust"><span class="boring">#![allow(dead_code)]
</span><span class="boring">use pyo3::prelude::*;
</span><span class="boring">use pyo3::types::PyType;
</span><span class="boring">#[pyclass]
</span><span class="boring">struct BaseClass(Py&lt;PyAny&gt;);
</span><span class="boring">
</span>#[pymethods]
impl BaseClass {
    #[new]
    #[classmethod]
    fn py_new(cls: &amp;Bound&lt;'_, PyType&gt;) -&gt; PyResult&lt;Self&gt; {
        // è·å–ä¸€ä¸ªï¼ˆå¤§æ¦‚ï¼‰åœ¨è¯¥ç±»çš„å­ç±»ä¸Šå£°æ˜çš„æŠ½è±¡å±æ€§ã€‚
        let subclass_attr: Bound&lt;'_, PyAny&gt; = cls.getattr("a_class_attr")?;
        Ok(Self(subclass_attr.unbind()))
    }
}</code></pre>
<h2 id="é™æ€æ–¹æ³•"><a class="header" href="#é™æ€æ–¹æ³•">é™æ€æ–¹æ³•</a></h2>
<p>è¦ä¸ºè‡ªå®šä¹‰ç±»åˆ›å»ºé™æ€æ–¹æ³•ï¼Œéœ€ç”¨ <code>#[staticmethod]</code> å±æ€§æ ‡æ³¨æ–¹æ³•ã€‚è¿”å›ç±»å‹å¿…é¡»æ˜¯ <code>T</code> æˆ– <code>PyResult&lt;T&gt;</code>ï¼Œå…¶ä¸­ <code>T</code> å®ç°äº† <code>IntoPyObject</code>ã€‚</p>
<pre><code class="language-rust"><span class="boring">use pyo3::prelude::*;
</span><span class="boring">#[pyclass]
</span><span class="boring">struct MyClass {
</span><span class="boring">    #[allow(dead_code)]
</span><span class="boring">    num: i32,
</span><span class="boring">}
</span>#[pymethods]
impl MyClass {
    #[staticmethod]
    fn static_method(param1: i32, param2: &amp;str) -&gt; PyResult&lt;i32&gt; {
        Ok(10)
    }
}
```## ç±»å±æ€§

è¦åˆ›å»ºä¸€ä¸ªç±»å±æ€§ï¼ˆä¹Ÿç§°ä¸º [class variable][classattr]ï¼‰ï¼Œå¯ä»¥å°†ä¸€ä¸ªæ— å‚æ•°çš„æ–¹æ³•æ ‡æ³¨ä¸Š `#[classattr]` å±æ€§ã€‚

```rust,no_run
<span class="boring">use pyo3::prelude::*;
</span><span class="boring">#[pyclass]
</span><span class="boring">struct MyClass {}
</span>#[pymethods]
impl MyClass {
    #[classattr]
    fn my_attribute() -&gt; String {
        "hello".to_string()
    }
}

Python::attach(|py| {
    let my_class = py.get_type::&lt;MyClass&gt;();
    pyo3::py_run!(py, my_class, "assert my_class.my_attribute == 'hello'")
});</code></pre>
<blockquote>
<p>æ³¨æ„ï¼šå¦‚æœè¯¥æ–¹æ³•è¿”å›ç±»å‹ä¸º <code>Result</code> å¹¶è¿”å› <code>Err</code>ï¼ŒPyO3 åœ¨åˆ›å»ºç±»æ—¶ä¼š panicã€‚</p>
</blockquote>
<blockquote>
<p>æ³¨æ„ï¼š<code>#[classattr]</code> ä¸èƒ½ä¸ <a href="#warn"><code>#[pyo3(warn(...))]</code></a> å±æ€§ä¸€èµ·ä½¿ç”¨ã€‚</p>
</blockquote>
<p>å¦‚æœç±»å±æ€§ä»…ç”± <code>const</code> ä»£ç å®šä¹‰ï¼Œåˆ™ä¹Ÿå¯ä»¥æ ‡æ³¨å…³è”å¸¸é‡ï¼š</p>
<pre><code class="language-rust no_run"><span class="boring">use pyo3::prelude::*;
</span><span class="boring">#[pyclass]
</span><span class="boring">struct MyClass {}
</span>#[pymethods]
impl MyClass {
    #[classattr]
    const MY_CONST_ATTRIBUTE: &amp;'static str = "foobar";
}</code></pre>
<h2 id="ç±»ä½œä¸ºå‡½æ•°å‚æ•°"><a class="header" href="#ç±»ä½œä¸ºå‡½æ•°å‚æ•°">ç±»ä½œä¸ºå‡½æ•°å‚æ•°</a></h2>
<p>ç±»å¯¹è±¡å¯ä»¥ç”¨ä½œ <code>#[pyfunction]</code> å’Œ <code>#[pymethods]</code> çš„å‚æ•°ï¼Œæ–¹å¼ä¸å®ä¾‹æ–¹æ³•çš„ self å‚æ•°ç›¸åŒï¼Œå³å¯ä»¥ä½œä¸ºä»¥ä¸‹ç±»å‹ä¼ é€’ï¼š</p>
<ul>
<li>æŒ‡å‘ç±» Python å¯¹è±¡çš„ <code>Py&lt;T&gt;</code> æˆ– <code>Bound&lt;'py, T&gt;</code> æ™ºèƒ½æŒ‡é’ˆï¼Œ</li>
<li>æŒ‡å‘ Python å¯¹è±¡ä¸­åŒ…å«çš„ Rust æ•°æ®çš„ <code>&amp;T</code> æˆ– <code>&amp;mut T</code> å¼•ç”¨ï¼Œ</li>
<li>æˆ– <code>PyRef&lt;T&gt;</code> å’Œ <code>PyRefMut&lt;T&gt;</code> å¼•ç”¨åŒ…è£…å™¨ã€‚</li>
</ul>
<p>ä»¥ä¸‹ä¸ºæ¯ç§æ–¹å¼çš„ç¤ºä¾‹ï¼š</p>
<pre><code class="language-rust no_run"><span class="boring">#![allow(dead_code)]
</span><span class="boring">use pyo3::prelude::*;
</span>#[pyclass]
struct MyClass {
    my_field: i32,
}

// å½“ Python å¯¹è±¡æ— å…³ç´§è¦æ—¶ï¼Œå– Rust æ•°æ®çš„å¼•ç”¨ã€‚
#[pyfunction]
fn increment_field(my_class: &amp;mut MyClass) {
    my_class.my_field += 1;
}

// å½“å€Ÿç”¨åº”è‡ªåŠ¨è¿›è¡Œï¼Œä½†ä»éœ€è¦è®¿é—® Python å¯¹è±¡æ—¶ï¼Œä½¿ç”¨å¼•ç”¨åŒ…è£…å™¨ã€‚
#[pyfunction]
fn print_field_and_return_me(my_class: PyRef&lt;'_, MyClass&gt;) -&gt; PyRef&lt;'_, MyClass&gt; {
    println!("{}", my_class.my_field);
    my_class
}

// å½“éœ€è¦æ‰‹åŠ¨ç®¡ç†å€Ÿç”¨æ—¶ï¼Œå–ï¼ˆæˆ–å¼•ç”¨ï¼‰Python å¯¹è±¡çš„æ™ºèƒ½æŒ‡é’ˆã€‚
#[pyfunction]
fn increment_then_print_field(my_class: &amp;Bound&lt;'_, MyClass&gt;) {
    my_class.borrow_mut().my_field += 1;

    println!("{}", my_class.borrow().my_field);
}

// å½“éœ€è¦å°† Python å¯¹è±¡æ™ºèƒ½æŒ‡é’ˆå­˜å‚¨åˆ°å…¶ä»–åœ°æ–¹æ—¶ï¼Œä¼˜å…ˆä½¿ç”¨ `Py&lt;T&gt;` è€Œé `Bound&lt;'py, T&gt;`ï¼Œä»¥é¿å…ç”Ÿå‘½å‘¨æœŸé™åˆ¶ã€‚
#[pyfunction]
fn print_refcnt(my_class: Py&lt;MyClass&gt;, py: Python&lt;'_&gt;) {
    println!("{}", my_class.get_refcnt(py));
}</code></pre>
<p>å¦‚æœç±»å¯ä»¥å…‹éš†ï¼Œä¹Ÿå¯ä»¥æŒ‰å€¼ä¼ é€’ï¼Œå³å¦‚æœå®ç°äº† <code>Clone</code>ï¼ˆä¾‹å¦‚é€šè¿‡ <code>#[derive(Clone)]</code>ï¼‰ï¼Œåˆ™ä¼šè‡ªåŠ¨å®ç° <code>FromPyObject</code>ï¼š</p>
<pre><code class="language-rust no_run"><span class="boring">#![allow(dead_code)]
</span><span class="boring">use pyo3::prelude::*;
</span>#[pyclass]
#[derive(Clone)]
struct MyClass {
    my_field: Box&lt;i32&gt;,
}

#[pyfunction]
fn disassemble_clone(my_class: MyClass) {
    let MyClass { mut my_field } = my_class;
    *my_field += 1;
}</code></pre>
<p>è¯·æ³¨æ„ï¼Œå¯¹ç±»ä½¿ç”¨ <code>#[derive(FromPyObject)]</code> é€šå¸¸æ²¡æœ‰ç”¨ï¼Œå› ä¸ºå®ƒä¼šå°è¯•é€šè¿‡æŸ¥æ‰¾ä»»æ„ Python å¯¹è±¡çš„å±æ€§æ¥å¡«å……å­—æ®µï¼Œä»è€Œæ„é€ ä¸€ä¸ªæ–°çš„ Rust å€¼ã€‚</p>
<h2 id="æ–¹æ³•å‚æ•°"><a class="header" href="#æ–¹æ³•å‚æ•°">æ–¹æ³•å‚æ•°</a></h2>
<p>ä¸ <code>#[pyfunction]</code> ç±»ä¼¼ï¼Œ<code>#[pyo3(signature = (...))]</code> å±æ€§å¯ç”¨äºæŒ‡å®š <code>#[pymethods]</code> æ¥å—å‚æ•°çš„æ–¹å¼ã€‚è¯·æŸ¥é˜… <a href="#å‡½æ•°ç­¾å"><code>å‡½æ•°ç­¾å</code></a> æ–‡æ¡£ä»¥äº†è§£æ­¤å±æ€§æ¥å—çš„å‚æ•°ã€‚</p>
<p>ä¸‹é¢çš„ç¤ºä¾‹å®šä¹‰äº†ä¸€ä¸ªç±» <code>MyClass</code> åŠå…¶æ–¹æ³• <code>method</code>ã€‚è¯¥æ–¹æ³•çš„ç­¾åè®¾ç½®äº† <code>num</code> å’Œ <code>name</code> çš„é»˜è®¤å€¼ï¼Œå¹¶æŒ‡ç¤º <code>py_args</code> æ”¶é›†æ‰€æœ‰é¢å¤–çš„ä½ç½®å‚æ•°ï¼Œ<code>py_kwargs</code> æ”¶é›†æ‰€æœ‰é¢å¤–çš„å…³é”®å­—å‚æ•°ï¼š</p>
<pre><code class="language-rust no_run"><span class="boring">use pyo3::prelude::*;
</span>use pyo3::types::{PyDict, PyTuple};
<span class="boring">
</span><span class="boring">#[pyclass]
</span><span class="boring">struct MyClass {
</span><span class="boring">    num: i32,
</span><span class="boring">}
</span>#[pymethods]
impl MyClass {
    #[new]
    #[pyo3(signature = (num=-1))]
    fn new(num: i32) -&gt; Self {
        MyClass { num }
    }

    #[pyo3(signature = (num=10, *py_args, name="Hello", **py_kwargs))]
    fn method(
        &amp;mut self,
        num: i32,
        py_args: &amp;Bound&lt;'_, PyTuple&gt;,
        name: &amp;str,
        py_kwargs: Option&lt;&amp;Bound&lt;'_, PyDict&gt;&gt;,
    ) -&gt; String {
        let num_before = self.num;
        self.num = num;
        format!(
            "num={} (was previously={}), py_args={:?}, name={}, py_kwargs={:?} ",
            num, num_before, py_args, name, py_kwargs,
        )
    }
}</code></pre>
<p>åœ¨ Python ä¸­ï¼Œå¯èƒ½è¿™æ ·ä½¿ç”¨ï¼š</p>
<pre><code class="language-python">&gt;&gt;&gt; import mymodule
&gt;&gt;&gt; mc = mymodule.MyClass()
&gt;&gt;&gt; print(mc.method(44, False, "World", 666, x=44, y=55))
py_args=('World', 666), py_kwargs=Some({'x': 44, 'y': 55}), name=Hello, num=44, num_before=-1
&gt;&gt;&gt; print(mc.method(num=-1, name="World"))
py_args=(), py_kwargs=None, name=World, num=-1, num_before=44
</code></pre>
<p><code>#[pyfunction]</code> çš„ <a href="#overriding-the-generated-signature"><code>#[pyo3(text_signature = "...")</code></a> é€‰é¡¹å¯¹ <code>#[pymethods]</code> åŒæ ·æœ‰æ•ˆã€‚</p>
<pre><code class="language-rust"><span class="boring">#![allow(dead_code)]
</span>use pyo3::prelude::*;
use pyo3::types::PyType;

#[pyclass]
struct MyClass {}

#[pymethods]
impl MyClass {
    #[new]
    #[pyo3(text_signature = "(c, d)")]
    fn new(c: i32, d: &amp;str) -&gt; Self {
        Self {}
    }
    // self å‚æ•°åº”å†™ä½œ $self
    #[pyo3(text_signature = "($self, e, f)")]
    fn my_method(&amp;self, e: i32, f: i32) -&gt; i32 {
        e + f
    }
    // ç±»æ–¹æ³•å‚æ•°åŒç†ï¼Œä½¿ç”¨ $cls
    #[classmethod]
    #[pyo3(text_signature = "($cls, e, f)")]
    fn my_class_method(cls: &amp;Bound&lt;'_, PyType&gt;, e: i32, f: i32) -&gt; i32 {
        e + f
    }
    #[staticmethod]
    #[pyo3(text_signature = "(e, f)")]
    fn my_static_method(e: i32, f: i32) -&gt; i32 {
        e + f
    }
}
<span class="boring">
</span><span class="boring">fn main() -&gt; PyResult&lt;()&gt; {
</span><span class="boring">    Python::attach(|py| {
</span><span class="boring">        let inspect = PyModule::import(py, "inspect")?.getattr("signature")?;
</span><span class="boring">        let module = PyModule::new(py, "my_module")?;
</span><span class="boring">        module.add_class::&lt;MyClass&gt;()?;
</span><span class="boring">        let class = module.getattr("MyClass")?;
</span><span class="boring">
</span><span class="boring">        if cfg!(not(Py_LIMITED_API)) || py.version_info() &gt;= (3, 10)  {
</span><span class="boring">            let doc: String = class.getattr("__doc__")?.extract()?;
</span><span class="boring">            assert_eq!(doc, "");
</span><span class="boring">
</span><span class="boring">            let sig: String = inspect
</span><span class="boring">                .call1((&amp;class,))?
</span><span class="boring">                .call_method0("__str__")?
</span><span class="boring">                .extract()?;
</span><span class="boring">            assert_eq!(sig, "(c, d)");
</span><span class="boring">        } else {
</span><span class="boring">            let doc: String = class.getattr("__doc__")?.extract()?;
</span><span class="boring">            assert_eq!(doc, "");
</span><span class="boring">
</span><span class="boring">            inspect.call1((&amp;class,)).expect_err("`text_signature` on classes is not compatible with compilation in `abi3` mode until Python 3.10 or greater");
</span><span class="boring">         }
</span><span class="boring">
</span><span class="boring">        {
</span><span class="boring">            let method = class.getattr("my_method")?;
</span><span class="boring">
</span><span class="boring">            assert!(method.getattr("__doc__")?.is_none());
</span><span class="boring">
</span><span class="boring">            let sig: String = inspect
</span><span class="boring">                .call1((method,))?
</span><span class="boring">                .call_method0("__str__")?
</span><span class="boring">                .extract()?;
</span><span class="boring">            assert_eq!(sig, "(self, /, e, f)");
</span><span class="boring">        }
</span><span class="boring">
</span><span class="boring">        {
</span><span class="boring">            let method = class.getattr("my_class_method")?;
</span><span class="boring">
</span><span class="boring">            assert!(method.getattr("__doc__")?.is_none());
</span><span class="boring">
</span><span class="boring">            let sig: String = inspect
</span><span class="boring">                .call1((method,))?
</span><span class="boring">                .call_method0("__str__")?
</span><span class="boring">                .extract()?;
</span><span class="boring">            assert_eq!(sig, "(e, f)");  // inspect.signature skips the $cls arg
</span><span class="boring">        }
</span><span class="boring">
</span><span class="boring">        {
</span><span class="boring">            let method = class.getattr("my_static_method")?;
</span><span class="boring">
</span><span class="boring">            assert!(method.getattr("__doc__")?.is_none());
</span><span class="boring">
</span><span class="boring">            let sig: String = inspect
</span><span class="boring">                .call1((method,))?
</span><span class="boring">                .call_method0("__str__")?
</span><span class="boring">                .extract()?;
</span><span class="boring">            assert_eq!(sig, "(e, f)");
</span><span class="boring">        }
</span><span class="boring">
</span><span class="boring">        Ok(())
</span><span class="boring">    })
</span><span class="boring">}</span></code></pre>
<p>æ³¨æ„ï¼šåœ¨ <code>#[new]</code> ä¸Šä½¿ç”¨ <code>text_signature</code> åœ¨ Python 3.10 æˆ–æ›´é«˜ç‰ˆæœ¬ä¹‹å‰ï¼Œä¸ <code>abi3</code> æ¨¡å¼ä¸‹çš„ç¼–è¯‘ä¸å…¼å®¹ã€‚</p>
<h3 id="æ–¹æ³•æ¥æ”¶å™¨ä¸ç”Ÿå‘½å‘¨æœŸçœç•¥"><a class="header" href="#æ–¹æ³•æ¥æ”¶å™¨ä¸ç”Ÿå‘½å‘¨æœŸçœç•¥">æ–¹æ³•æ¥æ”¶å™¨ä¸ç”Ÿå‘½å‘¨æœŸçœç•¥</a></h3>
<p>PyO3 æ”¯æŒä½¿ç”¨å¸¸è§„æ–¹æ³•æ¥æ”¶å™¨ï¼ˆå…±äº«å¼•ç”¨ <code>&amp;self</code> å’Œç‹¬å å¼•ç”¨ <code>&amp;mut self</code>ï¼‰æ¥ç¼–å†™å®ä¾‹æ–¹æ³•ã€‚è¿™ä¸[ç”Ÿå‘½å‘¨æœŸçœç•¥][lifetime-elision]äº¤äº’ï¼Œå³æ¥æ”¶å™¨çš„ç”Ÿå‘½å‘¨æœŸä¼šè¢«åˆ†é…ç»™æ‰€æœ‰çœç•¥äº†ç”Ÿå‘½å‘¨æœŸçš„è¾“å‡ºå‚æ•°ã€‚</p>
<p>è¿™æ˜¯æ™®é€š Rust ä»£ç çš„ä¸€ä¸ªè‰¯å¥½é»˜è®¤è¡Œä¸ºï¼Œå› ä¸ºè¿”å›å€¼æ›´å¯èƒ½å€Ÿç”¨æ¥æ”¶å™¨è€Œä¸æ˜¯å…¶ä»–å‚æ•°ï¼ˆå¦‚æœå­˜åœ¨ç”Ÿå‘½å‘¨æœŸçš„è¯ï¼‰ã€‚ç„¶è€Œï¼Œåœ¨åŸºäº PyO3 çš„ä»£ç ä¸­è¿”å›ç»‘å®šå¼•ç”¨ <code>Bound&lt;'py, T&gt;</code> æ—¶ï¼ŒPython ç”Ÿå‘½å‘¨æœŸ <code>'py</code> é€šå¸¸åº”ä»ä½œä¸ºå‚æ•°ä¼ å…¥çš„ <code>py: Python&lt;'py&gt;</code> token å¯¼å‡ºï¼Œè€Œä¸æ˜¯ä»æ¥æ”¶å™¨å¯¼å‡ºã€‚</p>
<p>å…·ä½“æ¥è¯´ï¼Œåƒè¿™æ ·çš„ç­¾åï¼š</p>
<pre><code class="language-rust ignore">fn frobnicate(&amp;self, py: Python) -&gt; Bound&lt;Foo&gt;;</code></pre>
<p>å°†æ— æ³•æ­£å¸¸å·¥ä½œï¼Œå› ä¸ºå®ƒè¢«æ¨æ–­ä¸ºï¼š</p>
<pre><code class="language-rust ignore">fn frobnicate&lt;'a, 'py&gt;(&amp;'a self, py: Python&lt;'py&gt;) -&gt; Bound&lt;'a, Foo&gt;;</code></pre>
<p>è€Œä¸æ˜¯é¢„æœŸçš„ï¼š</p>
<pre><code class="language-rust ignore">fn frobnicate&lt;'a, 'py&gt;(&amp;'a self, py: Python&lt;'py&gt;) -&gt; Bound&lt;'py, Foo&gt;;</code></pre>
<p>è€Œåº”é€šå¸¸å†™æˆï¼š</p>
<pre><code class="language-rust ignore">fn frobnicate&lt;'py&gt;(&amp;self, py: Python&lt;'py&gt;) -&gt; Bound&lt;'py, Foo&gt;;</code></pre>
<p><code>#[pyfunction]</code> ä¸å­˜åœ¨æ­¤é—®é¢˜ï¼Œå› ä¸ºæ¥æ”¶å™¨ç”Ÿå‘½å‘¨æœŸçš„ç‰¹æ®Šæƒ…å†µä¸é€‚ç”¨ï¼Œäº‹å®ä¸Šåƒè¿™æ ·çš„ç­¾åï¼š</p>
<pre><code class="language-rust ignore">fn frobnicate(bar: &amp;Bar, py: Python) -&gt; Bound&lt;Foo&gt;;</code></pre>
<p>å°†å¯¼è‡´ç¼–è¯‘å™¨é”™è¯¯ [E0106 â€œç¼ºå°‘ç”Ÿå‘½å‘¨æœŸè¯´æ˜ç¬¦â€][compiler-error-e0106]ã€‚</p>
<h2 id="pyclass-æšä¸¾"><a class="header" href="#pyclass-æšä¸¾"><code>#[pyclass]</code> æšä¸¾</a></h2>
<p>PyO3 ä¸­çš„æšä¸¾æ”¯æŒåˆ†ä¸ºä¸¤ç§ç±»å‹ï¼Œå–å†³äºæšä¸¾çš„å˜ä½“ç±»å‹ï¼šç®€å•æšä¸¾å’Œå¤æ‚æšä¸¾ã€‚</p>
<h3 id="ç®€å•æšä¸¾"><a class="header" href="#ç®€å•æšä¸¾">ç®€å•æšä¸¾</a></h3>
<p>ç®€å•æšä¸¾ï¼ˆåˆç§° C é£æ ¼æšä¸¾ï¼‰ä»…å…·æœ‰å•å…ƒå˜ä½“ã€‚</p>
<p>PyO3 ä¸ºæ¯ä¸ªå˜ä½“æ·»åŠ ä¸€ä¸ªç±»å±æ€§ï¼Œå› æ­¤ä½ å¯ä»¥åœ¨ Python ä¸­ç›´æ¥è®¿é—®å®ƒä»¬è€Œæ— éœ€å®šä¹‰ <code>#[new]</code>ã€‚PyO3 è¿˜æä¾›äº† <code>__richcmp__</code> å’Œ <code>__int__</code> çš„é»˜è®¤å®ç°ï¼Œå› æ­¤å¯ä»¥ä½¿ç”¨ <code>==</code> è¿›è¡Œæ¯”è¾ƒï¼š</p>
<pre><code class="language-rust"><span class="boring">use pyo3::prelude::*;
</span>#[pyclass(eq, eq_int)]
#[derive(PartialEq)]
enum MyEnum {
    Variant,
    OtherVariant,
}

Python::attach(|py| {
    let x = Py::new(py, MyEnum::Variant).unwrap();
    let y = Py::new(py, MyEnum::OtherVariant).unwrap();
    let cls = py.get_type::&lt;MyEnum&gt;();
    pyo3::py_run!(py, x y cls, r#"
        assert x == cls.Variant
        assert y == cls.OtherVariant
        assert x != y
    "#)
})
```ä½ ä¹Ÿå¯ä»¥å°†ç®€å•çš„æšä¸¾è½¬æ¢ä¸º `int`ï¼š

```rust
<span class="boring">use pyo3::prelude::*;
</span>#[pyclass(eq, eq_int)]
#[derive(PartialEq)]
enum MyEnum {
    Variant,
    OtherVariant = 10,
}


Python::attach(|py| {
    let cls = py.get_type::&lt;MyEnum&gt;();
    let x = MyEnum::Variant as i32; // å…·ä½“çš„å€¼ç”±ç¼–è¯‘å™¨åˆ†é…ã€‚
    pyo3::py_run!(py, cls x, r#"
        assert int(cls.Variant) == x
        assert int(cls.OtherVariant) == 10
    "#)
})</code></pre>
<p>PyO3 ä¹Ÿä¸ºæšä¸¾æä¾›äº† <code>__repr__</code>ï¼š</p>
<pre><code class="language-rust"><span class="boring">use pyo3::prelude::*;
</span>#[pyclass(eq, eq_int)]
#[derive(PartialEq)]
enum MyEnum{
    Variant,
    OtherVariant,
}


Python::attach(|py| {
    let cls = py.get_type::&lt;MyEnum&gt;();
    let x = Py::new(py, MyEnum::Variant).unwrap();
    pyo3::py_run!(py, cls x, r#"
        assert repr(x) == 'MyEnum.Variant'
        assert repr(cls.OtherVariant) == 'MyEnum.OtherVariant'
    "#)
})</code></pre>
<p>PyO3 å®šä¹‰çš„æ‰€æœ‰æ–¹æ³•éƒ½å¯ä»¥è¢«é‡å†™ã€‚ä¾‹å¦‚ï¼Œä»¥ä¸‹æ˜¯å¦‚ä½•é‡å†™ <code>__repr__</code> çš„ç¤ºä¾‹ï¼š</p>
<pre><code class="language-rust"><span class="boring">use pyo3::prelude::*;
</span>#[pyclass(eq, eq_int)]
#[derive(PartialEq)]
enum MyEnum {
    Answer = 42,
}


#[pymethods]
impl MyEnum {
    fn __repr__(&amp;self) -&gt; &amp;'static str {
        "42"
    }
}


Python::attach(|py| {
    let cls = py.get_type::&lt;MyEnum&gt;();
    pyo3::py_run!(py, cls, "assert repr(cls.Answer) == '42'")
})</code></pre>
<p>æšä¸¾åŠå…¶å˜ä½“ä¹Ÿå¯ä»¥ä½¿ç”¨ <code>#[pyo3(name)]</code> è¿›è¡Œé‡å‘½åï¼š</p>
<pre><code class="language-rust"><span class="boring">use pyo3::prelude::*;
</span>#[pyclass(eq, eq_int, name = "RenamedEnum")]
#[derive(PartialEq)]
enum MyEnum {
    #[pyo3(name = "UPPERCASE")]
    Variant,
}


Python::attach(|py| {
    let x = Py::new(py, MyEnum::Variant).unwrap();
    let cls = py.get_type::&lt;MyEnum&gt;();
    pyo3::py_run!(py, x cls, r#"
        assert repr(x) == 'RenamedEnum.UPPERCASE'
        assert x == cls.UPPERCASE
    "#)
})</code></pre>
<p>å¯ä»¥ä½¿ç”¨ <code>#[pyo3(ord)]</code> å¯é€‰åœ°æ·»åŠ æšä¸¾å˜ä½“çš„é¡ºåºæ¯”è¾ƒåŠŸèƒ½ã€‚
<em>æ³¨æ„ï¼šå½“ä½¿ç”¨ <code>ord</code> å‚æ•°æ—¶ï¼Œå¿…é¡»å®ç° <code>PartialOrd</code> traitã€‚å¦‚æœæ²¡æœ‰å®ç°ï¼Œä¼šåœ¨ç¼–è¯‘æ—¶äº§ç”Ÿé”™è¯¯ã€‚</em></p>
<pre><code class="language-rust"><span class="boring">use pyo3::prelude::*;
</span>#[pyclass(eq, ord)]
#[derive(PartialEq, PartialOrd)]
enum MyEnum{
    A,
    B,
    C,
}


Python::attach(|py| {
    let cls = py.get_type::&lt;MyEnum&gt;();
    let a = Py::new(py, MyEnum::A).unwrap();
    let b = Py::new(py, MyEnum::B).unwrap();
    let c = Py::new(py, MyEnum::C).unwrap();
    pyo3::py_run!(py, cls a b c, r#"
        assert (a &lt; b) == True
        assert (c &lt;= b) == False
        assert (c &gt; a) == True
    "#)
})</code></pre>
<p>ä½ ä¸èƒ½å°†æšä¸¾ç”¨ä½œåŸºç±»ï¼Œä¹Ÿä¸èƒ½è®©æšä¸¾ç»§æ‰¿è‡ªå…¶ä»–ç±»ã€‚</p>
<pre><code class="language-rust compile_fail"><span class="boring">use pyo3::prelude::*;
</span>#[pyclass(subclass)]
enum BadBase {
    Var1,
}</code></pre>
<pre><code class="language-rust compile_fail"><span class="boring">use pyo3::prelude::*;
</span>

#[pyclass(subclass)]
struct Base;


#[pyclass(extends=Base)]
enum BadSubclass {
    Var1,
}</code></pre>
<p>ç›®å‰ï¼Œ<code>#[pyclass]</code> æšä¸¾ä¸ Python ä¸­çš„ <code>IntEnum</code> ä¸å…¼å®¹ã€‚</p>
<h3 id="å¤æ‚æšä¸¾"><a class="header" href="#å¤æ‚æšä¸¾">å¤æ‚æšä¸¾</a></h3>
<p>å¦‚æœä¸€ä¸ªæšä¸¾æœ‰ä»»ä½•éå•å…ƒç±»å‹ï¼ˆç»“æ„ä½“æˆ–å…ƒç»„ï¼‰çš„å˜ä½“ï¼Œåˆ™å®ƒè¢«è§†ä¸ºå¤æ‚æšä¸¾ã€‚</p>
<p>PyO3 åœ¨å¤æ‚æšä¸¾ä¸­ä»…æ”¯æŒç»“æ„ä½“å’Œå…ƒç»„å˜ä½“ã€‚ç›®å‰ä¸æ”¯æŒå•å…ƒå˜ä½“ï¼ˆå»ºè®®ä½¿ç”¨ç©ºå…ƒç»„ä½œä¸ºæ›¿ä»£ï¼‰ã€‚</p>
<p>PyO3 ä¸ºæ¯ä¸ªå˜ä½“æ·»åŠ ä¸€ä¸ªç±»å±æ€§ï¼Œå¯ç”¨äºæ„é€ å€¼ä»¥åŠåŒ¹é…æ¨¡å¼ä¸­ã€‚PyO3 è¿˜ä¸ºæ¯ä¸ªå˜ä½“çš„æ‰€æœ‰å­—æ®µæä¾› getter æ–¹æ³•ã€‚</p>
<pre><code class="language-rust"><span class="boring">use pyo3::prelude::*;
</span>#[pyclass]
enum Shape {
    Circle { radius: f64 },
    Rectangle { width: f64, height: f64 },
    RegularPolygon(u32, f64),
    Nothing { },
}


<span class="boring">#[cfg(Py_3_10)]
</span>Python::attach(|py| {
    let circle = Shape::Circle { radius: 10.0 }.into_pyobject(py)?;
    let square = Shape::RegularPolygon(4, 10.0).into_pyobject(py)?;
    let cls = py.get_type::&lt;Shape&gt;();
    pyo3::py_run!(py, circle square cls, r#"
        assert isinstance(circle, cls)
        assert isinstance(circle, cls.Circle)
        assert circle.radius == 10.0


        assert isinstance(square, cls)
        assert isinstance(square, cls.RegularPolygon)
        assert square[0] == 4 # è·å– _0 å­—æ®µ
        assert square[1] == 10.0 # è·å– _1 å­—æ®µ


        def count_vertices(cls, shape):
            match shape:
                case cls.Circle():
                    return 0
                case cls.Rectangle():
                    return 4
                case cls.RegularPolygon(n):
                    return n
                case cls.Nothing():
                    return 0


        assert count_vertices(cls, circle) == 0
        assert count_vertices(cls, square) == 4
    "#);
<span class="boring">  Ok::&lt;_, PyErr&gt;(())
</span>})
<span class="boring">.unwrap();</span></code></pre>
<p>è­¦å‘Šï¼š<code>Py::new</code> å’Œ <code>.into_pyobject</code> å½“å‰è¡Œä¸ºä¸ä¸€è‡´ã€‚æ³¨æ„æ„é€ å‡ºçš„å€¼ <em>ä¸æ˜¯</em> ç‰¹å®šå˜ä½“çš„å®ä¾‹ã€‚å› æ­¤ï¼Œå»ºè®®ä»…ä½¿ç”¨ <code>.into_pyobject</code> æ¥æ„é€ å€¼ã€‚</p>
<pre><code class="language-rust"><span class="boring">use pyo3::prelude::*;
</span>#[pyclass]
enum MyEnum {
    Variant { i: i32 },
}


Python::attach(|py| {
    let x = Py::new(py, MyEnum::Variant { i: 42 }).unwrap();
    let cls = py.get_type::&lt;MyEnum&gt;();
    pyo3::py_run!(py, x cls, r#"
        assert isinstance(x, cls)
        assert not isinstance(x, cls.Variant)
    "#)
})</code></pre>
<p>å¯ä»¥ä½¿ç”¨ <code>#[pyo3(constructor = (...))]</code> å±æ€§æ¥è‡ªå®šä¹‰æ¯ä¸ªç”Ÿæˆç±»çš„æ„é€ å‡½æ•°ã€‚å…¶è¯­æ³•ä¸å‡½æ•°å’Œæ–¹æ³•ä¸Šçš„ <a href="#å‡½æ•°ç­¾å"><code>#[pyo3(signature = (...))]</code></a> å±æ€§ç›¸åŒï¼Œå¹¶æ”¯æŒç›¸åŒé€‰é¡¹ã€‚è¦åº”ç”¨æ­¤å±æ€§ï¼Œåªéœ€å°†å…¶æ”¾åœ¨ <code>#[pyclass]</code> å¤æ‚æšä¸¾çš„æŸä¸ªå˜ä½“ä¸Šï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre><code class="language-rust"><span class="boring">use pyo3::prelude::*;
</span>#[pyclass]
enum Shape {
    #[pyo3(constructor = (radius=1.0))]
    Circle { radius: f64 },
    #[pyo3(constructor = (*, width, height))]
    Rectangle { width: f64, height: f64 },
    #[pyo3(constructor = (side_count, radius=1.0))]
    RegularPolygon { side_count: u32, radius: f64 },
    Nothing { },
}


<span class="boring">#[cfg(Py_3_10)]
</span>Python::attach(|py| {
    let cls = py.get_type::&lt;Shape&gt;();
    pyo3::py_run!(py, cls, r#"
        circle = cls.Circle()
        assert isinstance(circle, cls)
        assert isinstance(circle, cls.Circle)
        assert circle.radius == 1.0


        square = cls.Rectangle(width = 1, height = 1)
        assert isinstance(square, cls)
        assert isinstance(square, cls.Rectangle)
        assert square.width == 1
        assert square.height == 1


        hexagon = cls.RegularPolygon(6)
        assert isinstance(hexagon, cls)
        assert isinstance(hexagon, cls.RegularPolygon)
        assert hexagon.side_count == 6
        assert hexagon.radius == 1
    "#)
})</code></pre>
<h2 id="å®ç°ç»†èŠ‚"><a class="header" href="#å®ç°ç»†èŠ‚">å®ç°ç»†èŠ‚</a></h2>
<p><code>#[pyclass]</code> å®ä¾èµ–äºå¤§é‡çš„æ¡ä»¶ä»£ç ç”Ÿæˆï¼šæ¯ä¸ª <code>#[pyclass]</code> å¯é€‰æ‹©æ€§åœ°æ‹¥æœ‰ä¸€ä¸ª <code>#[pymethods]</code> å—ã€‚</p>
<p>ä¸ºäº†æ”¯æŒè¿™ç§çµæ´»æ€§ï¼Œ<code>#[pyclass]</code> å®ä¼šå±•å¼€æˆä¸€æ®µæ ·æ¿ä»£ç ï¼Œè®¾ç½® <a href="https://github.com/dtolnay/case-studies/blob/master/autoref-specialization/README.md">â€œdtolnay ç‰¹åŒ–â€</a> ç»“æ„ã€‚è¿™ç§å®ç°æ¨¡å¼ä½¿ Rust ç¼–è¯‘å™¨èƒ½å¤Ÿåœ¨å­˜åœ¨ <code>#[pymethods]</code> å®ç°æ—¶ä½¿ç”¨å®ƒä»¬ï¼Œè€Œåœ¨ä¸å­˜åœ¨æ—¶å›é€€åˆ°é»˜è®¤ï¼ˆç©ºï¼‰å®šä¹‰ã€‚</p>
<p>è¿™ç§ç®€å•æŠ€æœ¯é€‚ç”¨äºé›¶ä¸ªæˆ–ä¸€ä¸ªå®ç°çš„æƒ…å†µã€‚ä¸ºäº†æ”¯æŒä¸€ä¸ª <code>#[pyclass]</code> æœ‰å¤šä¸ª <code>#[pymethods]</code>ï¼ˆåœ¨ [<code>multiple-pymethods</code>] åŠŸèƒ½ä¸‹ï¼‰ï¼Œä¼šæ”¹ç”¨ <code>inventory</code> crate æä¾›çš„æ³¨å†Œæœºåˆ¶ã€‚å®ƒåœ¨åº“åŠ è½½æ—¶æ”¶é›† <code>impl</code>ï¼Œä½†å¹¶éæ‰€æœ‰å¹³å°éƒ½æ”¯æŒã€‚è¯¦è§ <a href="https://github.com/dtolnay/inventory#how-it-works">inventory: å®ƒå¦‚ä½•å·¥ä½œ</a>ã€‚</p>
<p><code>#[pyclass]</code> å®å¤§è‡´å±•å¼€ä¸ºå¦‚ä¸‹ä»£ç ã€‚<code>PyClassImplCollector</code> æ˜¯ PyO3 å†…éƒ¨ç”¨äº dtolnay ç‰¹åŒ–çš„ç±»å‹ï¼š</p>
<pre><code class="language-rust"><span class="boring">#[cfg(not(feature = "multiple-pymethods"))] {
</span><span class="boring">use pyo3::prelude::*;
</span>// æ³¨æ„ï¼šå¯ç”¨ `multiple-pymethods` åŠŸèƒ½æ—¶å®ç°ç•¥æœ‰ä¸åŒã€‚
<span class="boring">#[allow(dead_code)]
</span>struct MyClass {
<span class="boring">    #[allow(dead_code)]
</span>    num: i32,
}


impl pyo3::types::DerefToPyAny for MyClass {}


unsafe impl pyo3::type_object::PyTypeInfo for MyClass {
    const NAME: &amp;'static str = "MyClass";
    const MODULE: ::std::option::Option&lt;&amp;'static str&gt; = ::std::option::Option::None;


    #[inline]
    fn type_object_raw(py: pyo3::Python&lt;'_&gt;) -&gt; *mut pyo3::ffi::PyTypeObject {
        &lt;Self as pyo3::impl_::pyclass::PyClassImpl&gt;::lazy_type_object()
            .get_or_try_init(py)
            .unwrap_or_else(|e| pyo3::impl_::pyclass::type_object_init_failed(
                py,
                e,
                &lt;Self as pyo3::type_object::PyTypeInfo&gt;::NAME
            ))
            .as_type_ptr()
    }
}


impl pyo3::PyClass for MyClass {
    type Frozen = pyo3::pyclass::boolean_struct::False;
}


impl pyo3::impl_::pyclass::PyClassImpl for MyClass {
    const IS_BASETYPE: bool = false;
    const IS_SUBCLASS: bool = false;
    const IS_MAPPING: bool = false;
    const IS_SEQUENCE: bool = false;
    type BaseType = PyAny;
    type ThreadChecker = pyo3::impl_::pyclass::SendablePyClass&lt;MyClass&gt;;
    type PyClassMutability = &lt;&lt;pyo3::PyAny as pyo3::impl_::pyclass::PyClassBaseType&gt;::PyClassMutability as pyo3::impl_::pycell::PyClassMutability&gt;::MutableChild;
    type Dict = pyo3::impl_::pyclass::PyClassDummySlot;
    type WeakRef = pyo3::impl_::pyclass::PyClassDummySlot;
    type BaseNativeType = pyo3::PyAny;


    const RAW_DOC: &amp;'static std::ffi::CStr = pyo3::ffi::c_str!("...");
    const DOC: &amp;'static std::ffi::CStr = pyo3::ffi::c_str!("...");


    fn items_iter() -&gt; pyo3::impl_::pyclass::PyClassItemsIter {
        use pyo3::impl_::pyclass::*;
        let collector = PyClassImplCollector::&lt;MyClass&gt;::new();
        static INTRINSIC_ITEMS: PyClassItems = PyClassItems { slots: &amp;[], methods: &amp;[] };
        PyClassItemsIter::new(&amp;INTRINSIC_ITEMS, collector.py_methods())
    }


    fn lazy_type_object() -&gt; &amp;'static pyo3::impl_::pyclass::LazyTypeObject&lt;MyClass&gt; {
        use pyo3::impl_::pyclass::LazyTypeObject;
        static TYPE_OBJECT: LazyTypeObject&lt;MyClass&gt; = LazyTypeObject::new();
        &amp;TYPE_OBJECT
    }
}


<span class="boring">Python::attach(|py| {
</span><span class="boring">    let cls = py.get_type::&lt;MyClass&gt;();
</span><span class="boring">    pyo3::py_run!(py, cls, "assert cls.__name__ == 'MyClass'")
</span><span class="boring">});
</span><span class="boring">}
</span>```[`PyTypeInfo`]: {{#PYO3_DOCS_URL}}/pyo3/type_object/trait.PyTypeInfo.html

[`Py&lt;T&gt;`]: {{#PYO3_DOCS_URL}}/pyo3/struct.Py.html
[`Bound&lt;'py, T&gt;`]: {{#PYO3_DOCS_URL}}/pyo3/struct.Bound.html
[`PyClass`]: {{#PYO3_DOCS_URL}}/pyo3/pyclass/trait.PyClass.html
[`PyRef`]: {{#PYO3_DOCS_URL}}/pyo3/pycell/struct.PyRef.html
[`PyRefMut`]: {{#PYO3_DOCS_URL}}/pyo3/pycell/struct.PyRefMut.html
[`PyClassInitializer&lt;T&gt;`]: {{#PYO3_DOCS_URL}}/pyo3/pyclass_init/struct.PyClassInitializer.html

[`Arc`]: https://doc.rust-lang.org/std/sync/struct.Arc.html

[classattr]: https://docs.python.org/zh-cn/3/tutorial/classes.html#class-and-instance-variables

[`multiple-pymethods`]: features.md#multiple-pymethods

[lifetime-elision]: https://doc.rust-lang.org/reference/lifetime-elision.html
[compiler-error-e0106]: https://doc.rust-lang.org/error_codes/E0106.html</code></pre>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="ç±»çš„è‡ªå®šä¹‰"><a class="header" href="#ç±»çš„è‡ªå®šä¹‰">ç±»çš„è‡ªå®šä¹‰</a></h1>
<p>Python çš„å¯¹è±¡æ¨¡å‹å®šä¹‰äº†å¤šç§åè®®æ¥æ§åˆ¶ä¸åŒçš„å¯¹è±¡è¡Œä¸ºï¼Œä¾‹å¦‚åºåˆ—ã€æ˜ å°„å’Œæ•°å­—åè®®ã€‚Python ç±»é€šè¿‡å®ç°â€œé­”æ³•â€æ–¹æ³•ï¼ˆmagic methodsï¼‰æ¥æ”¯æŒè¿™äº›åè®®ï¼Œä¾‹å¦‚ <code>__str__</code> æˆ– <code>__repr__</code>ã€‚ç”±äºè¿™äº›æ–¹æ³•çš„åç§°ä¸¤ä¾§éƒ½æœ‰åŒä¸‹åˆ’çº¿ï¼Œå®ƒä»¬ä¹Ÿè¢«ç§°ä¸ºâ€œdunderâ€æ–¹æ³•ã€‚</p>
<p>PyO3 å…è®¸åœ¨ <code>#[pymethods]</code> ä¸­ä»¥ä¸æ™®é€š Python ç±»ç›¸åŒçš„æ–¹å¼å®ç°æ¯ä¸ªé­”æ³•æ–¹æ³•ï¼Œä½†æœ‰å‡ ç‚¹æ˜¾è‘—åŒºåˆ«ï¼š</p>
<ul>
<li><code>__new__</code> å’Œ <code>__init__</code> è¢« <a href="#constructor"><code>#[new]</code> å±æ€§</a> æ‰€æ›¿ä»£ã€‚</li>
<li><code>__del__</code> å½“å‰å°šæœªæ”¯æŒï¼Œä½†æœªæ¥å¯èƒ½ä¼šæ”¯æŒã€‚</li>
<li><code>__buffer__</code> å’Œ <code>__release_buffer__</code> ç›®å‰ä¸æ”¯æŒï¼Œå–è€Œä»£ä¹‹çš„æ˜¯ PyO3 æ”¯æŒ <a href="#buffer-objects"><code>__getbuffer__</code> å’Œ <code>__releasebuffer__</code></a> æ–¹æ³•ï¼ˆè¿™äº›æ–¹æ³•æ—©äº <a href="https://peps.python.org/pep-0688/#python-level-buffer-protocol">PEP 688</a>ï¼‰ï¼Œæœªæ¥å¯èƒ½ä¼šå‘ç”Ÿå˜åŒ–ã€‚</li>
<li>PyO3 æ·»åŠ äº† <a href="#garbage-collector-integration"><code>__traverse__</code> å’Œ <code>__clear__</code></a> æ–¹æ³•ç”¨äºæ§åˆ¶åƒåœ¾å›æ”¶ã€‚</li>
<li>ç”±äº PyO3 åŸºäº Python C-API å®ç°ï¼Œè®¸å¤šé­”æ³•æ–¹æ³•éœ€è¦å…·æœ‰ç‰¹å®šçš„ C å‡½æ•°ç­¾åï¼Œå¹¶è¢«æ”¾å…¥ç±»ç±»å‹å¯¹è±¡çš„ç‰¹æ®Šâ€œæ§½ä½â€ï¼ˆslotsï¼‰ä¸­ã€‚è¿™é™åˆ¶äº†è¿™äº›æ–¹æ³•å…è®¸çš„å‚æ•°å’Œè¿”å›ç±»å‹ã€‚è¿™äº›é™åˆ¶åœ¨ä¸‹æ–‡ä¸­æœ‰è¯¦ç»†åˆ—å‡ºã€‚</li>
</ul>
<p>å¦‚æœæŸä¸ªé­”æ³•æ–¹æ³•ä¸åœ¨ä¸Šè¿°åˆ—è¡¨ä¸­ï¼ˆä¾‹å¦‚ <code>__init_subclass__</code>ï¼‰ï¼Œé‚£ä¹ˆå®ƒåœ¨ PyO3 ä¸­åº”å½“å¯ä»¥ç›´æ¥ä½¿ç”¨ã€‚å¦‚æœä¸æ˜¯è¿™æ ·ï¼Œè¯·æäº¤é”™è¯¯æŠ¥å‘Šã€‚</p>
<h2 id="pyo3-å¤„ç†çš„é­”æ³•æ–¹æ³•"><a class="header" href="#pyo3-å¤„ç†çš„é­”æ³•æ–¹æ³•">PyO3 å¤„ç†çš„é­”æ³•æ–¹æ³•</a></h2>
<p>å¦‚æœåœ¨ <code>#[pymethods]</code> ä¸­å®šä¹‰çš„å‡½æ•°æ˜¯ä¸€ä¸ªéœ€è¦ç‰¹æ®Šå¤„ç†çš„å·²çŸ¥é­”æ³•æ–¹æ³•ï¼Œè¯¥å‡½æ•°å°†è¢«è‡ªåŠ¨æ”¾ç½®åˆ° Python ç±»å‹å¯¹è±¡çš„æ­£ç¡®æ§½ä½ä¸­ã€‚å‡½æ•°åç§°éµå¾ª <code>#[pymethods]</code> çš„å¸¸è§„å‘½åè§„åˆ™ï¼šå¦‚æœå­˜åœ¨ <code>#[pyo3(name = "...")]</code> å±æ€§ï¼Œåˆ™ä½¿ç”¨å®ƒï¼›å¦åˆ™ä½¿ç”¨ Rust å‡½æ•°åã€‚</p>
<p>PyO3 å¤„ç†çš„é­”æ³•æ–¹æ³•ä¸ <a href="https://docs.python.org/3/reference/datamodel.html#special-method-names">æ­¤é¡µé¢</a> ä¸Šçš„æ ‡å‡† Python æ–¹æ³•éå¸¸ç›¸ä¼¼ï¼Œå°¤å…¶æ˜¯é‚£äº›å…·æœ‰æ§½ä½å®šä¹‰çš„å­é›†ï¼Œå¦‚ <a href="https://docs.python.org/3/c-api/typeobj.html">æ­¤å¤„å®šä¹‰</a>ã€‚</p>
<p>å½“ PyO3 å¤„ç†æŸä¸ªé­”æ³•æ–¹æ³•æ—¶ï¼Œä¸æ™®é€š <code>#[pymethods]</code> ç›¸æ¯”æœ‰ä»¥ä¸‹å‡ ä¸ªå˜åŒ–ï¼š</p>
<ul>
<li>Rust å‡½æ•°ç­¾åå¿…é¡»ç¬¦åˆè¯¥é­”æ³•æ–¹æ³•çš„è¦æ±‚ã€‚</li>
<li>ä¸å…è®¸ä½¿ç”¨ <code>#[pyo3(signature = (...)]</code> å’Œ <code>#[pyo3(text_signature = "...")]</code> å±æ€§ã€‚</li>
</ul>
<p>ä»¥ä¸‹éƒ¨åˆ†åˆ—å‡ºäº† PyO3 å®ç°ç‰¹æ®Šå¤„ç†çš„æ‰€æœ‰é­”æ³•æ–¹æ³•ã€‚æ‰€ç»™çš„ç­¾ååº”æŒ‰å¦‚ä¸‹æ–¹å¼ç†è§£ï¼š</p>
<ul>
<li>æ‰€æœ‰æ–¹æ³•éƒ½ä»¥æ¥æ”¶å™¨ä½œä¸ºç¬¬ä¸€ä¸ªå‚æ•°ï¼Œè¡¨ç¤ºä¸º <code>&lt;self&gt;</code>ã€‚å®ƒå¯ä»¥æ˜¯ <code>&amp;self</code>ã€<code>&amp;mut self</code> æˆ– <code>Bound</code> å¼•ç”¨ï¼ˆä¾‹å¦‚ <code>self_: PyRef&lt;'_, Self&gt;</code> å’Œ <code>self_: PyRefMut&lt;'_, Self&gt;</code>ï¼‰ï¼Œå¦‚ <a href="#inheritance">æ­¤å¤„æ‰€è¿°</a>ã€‚</li>
<li>å§‹ç»ˆå…è®¸å°†å¯é€‰çš„ <code>Python&lt;'py&gt;</code> å‚æ•°ä½œä¸ºç¬¬ä¸€ä¸ªå‚æ•°ã€‚</li>
<li>è¿”å›å€¼å¯ä»¥é€‰æ‹©æ€§åœ°ç”¨ <code>PyResult</code> åŒ…è£¹ã€‚</li>
<li><code>object</code> æ„å‘³ç€ä»»ä½•å¯ä»¥ä»ä¸­æå–è‡ª Python å¯¹è±¡ï¼ˆä½œä¸ºå‚æ•°ï¼‰æˆ–å°†è½¬æ¢ä¸º Python å¯¹è±¡ï¼ˆä½œä¸ºè¿”å›å€¼ï¼‰çš„ç±»å‹éƒ½å¯ä»¥ä½¿ç”¨ã€‚</li>
<li>å…¶ä»–ç±»å‹å¿…é¡»ä¸ç»™å®šçš„ç±»å‹åŒ¹é…ï¼Œä¾‹å¦‚ <code>__richcmp__</code> çš„ç¬¬äºŒä¸ªå‚æ•°åº”ä¸º <code>pyo3::basic::CompareOp</code>ã€‚</li>
<li>å¯¹äºæ¯”è¾ƒå’Œç®—æœ¯æ–¹æ³•ï¼Œæå–é”™è¯¯ä¸ä¼šä»¥å¼‚å¸¸å½¢å¼ä¼ æ’­ï¼Œè€Œæ˜¯è¿”å› <code>NotImplemented</code>ã€‚</li>
<li>å¯¹äºæŸäº›é­”æ³•æ–¹æ³•ï¼Œè¿”å›å€¼ä¸å— PyO3 é™åˆ¶ï¼Œä½†ç”± Python è§£é‡Šå™¨æ£€æŸ¥ã€‚ä¾‹å¦‚ï¼Œ<code>__str__</code> å¿…é¡»è¿”å›å­—ç¬¦ä¸²å¯¹è±¡ã€‚è¿™è¡¨ç¤ºä¸º <code>object (Python type)</code>ã€‚</li>
</ul>
<h3 id="åŸºæœ¬å¯¹è±¡è‡ªå®šä¹‰"><a class="header" href="#åŸºæœ¬å¯¹è±¡è‡ªå®šä¹‰">åŸºæœ¬å¯¹è±¡è‡ªå®šä¹‰</a></h3>
<ul>
<li>
<p><code>__str__(&lt;self&gt;) -&gt; object (str)</code></p>
</li>
<li>
<p><code>__repr__(&lt;self&gt;) -&gt; object (str)</code></p>
</li>
<li>
<p><code>__hash__(&lt;self&gt;) -&gt; isize</code></p>
<p>æ¯”è¾ƒç›¸ç­‰çš„å¯¹è±¡å¿…é¡»å…·æœ‰ç›¸åŒçš„å“ˆå¸Œå€¼ã€‚å¯ä»¥è¿”å›ä»»ä½•æœ€å¤š 64 ä½çš„ç±»å‹æ¥ä»£æ›¿ <code>isize</code>ï¼ŒPyO3 ä¼šè‡ªåŠ¨å°†å…¶è½¬æ¢ä¸º <code>isize</code>ï¼ˆå¯¹æ— ç¬¦å·ç±»å‹å¦‚ <code>u64</code> å’Œ <code>usize</code> è¿›è¡ŒåŒ…è£…ï¼‰ã€‚</p>
  <details>
  <summary>ç¦ç”¨ Python é»˜è®¤å“ˆå¸Œ</summary>
<p>é»˜è®¤æƒ…å†µä¸‹ï¼Œæ‰€æœ‰ <code>#[pyclass]</code> ç±»å‹éƒ½æœ‰æ¥è‡ª Python çš„é»˜è®¤å“ˆå¸Œå®ç°ã€‚ä¸åº”å¯å“ˆå¸Œçš„ç±»å‹å¯ä»¥é€šè¿‡å°† <code>__hash__</code> è®¾ç½®ä¸º <code>None</code> æ¥è¦†ç›–æ­¤è¡Œä¸ºã€‚è¿™ä¸çº¯ Python ç±»çš„æœºåˆ¶ç›¸åŒã€‚å®ç°æ–¹å¼å¦‚ä¸‹ï¼š</p>
<pre><code class="language-rust no_run"><span class="boring">use pyo3::prelude::*;
</span><span class="boring">
</span>#[pyclass]
struct NotHashable {}

#[pymethods]
impl NotHashable {
    #[classattr]
    const __hash__: Option&lt;Py&lt;PyAny&gt;&gt; = None;
}</code></pre>
  </details>
</li>
<li>
<p><code>__lt__(&lt;self&gt;, object) -&gt; object</code></p>
</li>
<li>
<p><code>__le__(&lt;self&gt;, object) -&gt; object</code></p>
</li>
<li>
<p><code>__eq__(&lt;self&gt;, object) -&gt; object</code></p>
</li>
<li>
<p><code>__ne__(&lt;self&gt;, object) -&gt; object</code></p>
</li>
<li>
<p><code>__gt__(&lt;self&gt;, object) -&gt; object</code></p>
</li>
<li>
<p><code>__ge__(&lt;self&gt;, object) -&gt; object</code></p>
<p>åˆ†åˆ«å®ç° Python çš„â€œå¯Œæ¯”è¾ƒâ€è¿ç®—ç¬¦ <code>&lt;</code>ã€<code>&lt;=</code>ã€<code>==</code>ã€<code>!=</code>ã€<code>&gt;</code> å’Œ <code>&gt;=</code>ã€‚</p>
<p><em>æ³¨æ„ï¼šå®ç°å…¶ä¸­ä»»ä¸€æ–¹æ³•å°†å¯¼è‡´ Python ä¸å†ç”Ÿæˆé»˜è®¤çš„ XXXXXXXXXX å®ç°ï¼Œå› æ­¤åœ¨å®ç°æ—¶åº”è€ƒè™‘åŒæ—¶å®ç° XXXXXXXXXXã€‚</em></p>
  <details>
  <summary>è¿”å›ç±»å‹</summary>
  è¿”å›ç±»å‹é€šå¸¸ä¸º `bool` æˆ– `PyResult<bool>`ï¼Œä½†ä¹Ÿå¯ä»¥è¿”å›ä»»ä½• Python å¯¹è±¡ã€‚
  
</bool></details></li>
<li>
<p><code>__richcmp__(&lt;self&gt;, object, pyo3::basic::CompareOp) -&gt; object</code></p>
<p>åœ¨å•ä¸ªæ–¹æ³•ä¸­å®ç° Python æ¯”è¾ƒæ“ä½œï¼ˆ<code>==</code>ã€<code>!=</code>ã€<code>&lt;</code>ã€<code>&lt;=</code>ã€<code>&gt;</code> å’Œ <code>&gt;=</code>ï¼‰ã€‚<code>CompareOp</code> å‚æ•°è¡¨ç¤ºå½“å‰æ‰§è¡Œçš„æ¯”è¾ƒæ“ä½œã€‚ä½ å¯ä»¥ä½¿ç”¨ <a href="class/{{#PYO3_DOCS_URL}}/pyo3/pyclass/enum.CompareOp.html#method.matches"><code>CompareOp::matches</code></a> å°† Rust çš„ <code>std::cmp::Ordering</code> ç»“æœé€‚é…ä¸ºè¯·æ±‚çš„æ¯”è¾ƒæ“ä½œã€‚</p>
<p><em>æ­¤æ–¹æ³•ä¸èƒ½ä¸ XXXXXXXXã€XXXXXXXXã€XXXXXXXXã€XXXXXXXXã€XXXXXXXX æˆ– XXXXXXXX ç»„åˆå®ç°ã€‚</em></p>
<p><em>æ³¨æ„ï¼šå®ç° XXXXXXXXXXXXX å°†å¯¼è‡´ Python ä¸å†ç”Ÿæˆé»˜è®¤çš„ XXXXXXXXXX å®ç°ï¼Œå› æ­¤åœ¨å®ç° XXXXXXXXXXXXX æ—¶åº”è€ƒè™‘åŒæ—¶å®ç° XXXXXXXXXXã€‚</em></p>
  <details>
  <summary>è¿”å›ç±»å‹</summary>
  è¿”å›ç±»å‹é€šå¸¸ä¸º `PyResult<bool>`ï¼Œä½†å¯ä»¥è¿”å›ä»»ä½• Python å¯¹è±¡ã€‚
<p>å¦‚æœä½ å¸Œæœ›æŸäº›æ“ä½œæœªå®ç°ï¼Œå¯ä»¥åœ¨æŸäº›æ“ä½œä¸­è¿”å› <code>py.NotImplemented()</code>ï¼š</p>
<pre><code class="language-rust no_run">use pyo3::class::basic::CompareOp;
use pyo3::types::PyNotImplemented;

<span class="boring">use pyo3::prelude::*;
</span><span class="boring">use pyo3::BoundObject;
</span><span class="boring">
</span><span class="boring">#[pyclass]
</span><span class="boring">struct Number(i32);
</span><span class="boring">
</span>#[pymethods]
impl Number {
    fn __richcmp__&lt;'py&gt;(&amp;self, other: &amp;Self, op: CompareOp, py: Python&lt;'py&gt;) -&gt; PyResult&lt;Borrowed&lt;'py, 'py, PyAny&gt;&gt; {
        match op {
            CompareOp::Eq =&gt; Ok((self.0 == other.0).into_pyobject(py)?.into_any()),
            CompareOp::Ne =&gt; Ok((self.0 != other.0).into_pyobject(py)?.into_any()),
            _ =&gt; Ok(PyNotImplemented::get(py).into_any()),
        }
    }
}</code></pre>
<p>å¦‚æœç¬¬äºŒä¸ªå‚æ•° <code>object</code> ä¸ç¬¦åˆç­¾åä¸­æŒ‡å®šçš„ç±»å‹ï¼Œç”Ÿæˆçš„ä»£ç å°†è‡ªåŠ¨ <code>return NotImplemented</code>ã€‚</p>
  
</bool></details></li>
<li>
<p><code>__getattr__(&lt;self&gt;, object) -&gt; object</code></p>
</li>
<li>
<p><code>__getattribute__(&lt;self&gt;, object) -&gt; object</code></p>
  <details>
  <summary>`__getattr__` å’Œ `__getattribute__` çš„åŒºåˆ«</summary>
  ä¸ Python ä¸­ä¸€æ ·ï¼Œåªæœ‰åœ¨é€šè¿‡æ­£å¸¸å±æ€§æŸ¥æ‰¾æœªæ‰¾åˆ°å±æ€§æ—¶æ‰ä¼šè°ƒç”¨ `__getattr__`ã€‚è€Œ `__getattribute__` åˆ™ä¼šåœ¨ *æ¯æ¬¡* å±æ€§è®¿é—®æ—¶è¢«è°ƒç”¨ã€‚å¦‚æœå®ƒéœ€è¦è®¿é—® `self` ä¸Šçš„ç°æœ‰å±æ€§ï¼Œå¿…é¡»éå¸¸å°å¿ƒä»¥é¿å…æ— é™é€’å½’ï¼Œå¹¶ä½¿ç”¨ `baseclass.__getattribute__()`ã€‚
  </details>
</li>
<li>
<p><code>__setattr__(&lt;self&gt;, value: object) -&gt; ()</code></p>
</li>
<li>
<p><code>__delattr__(&lt;self&gt;, object) -&gt; ()</code></p>
<p>è¦†ç›–å±æ€§è®¿é—®ã€‚</p>
</li>
<li>
<p><code>__bool__(&lt;self&gt;) -&gt; bool</code></p>
<p>å†³å®šå¯¹è±¡çš„â€œçœŸå€¼æ€§â€ã€‚</p>
</li>
<li>
<p><code>__call__(&lt;self&gt;, ...) -&gt; object</code> â€”â€” è¿™é‡Œå¯ä»¥åƒæ™®é€š <code>pymethods</code> ä¸€æ ·å®šä¹‰ä»»æ„å‚æ•°åˆ—è¡¨ã€‚</p>
</li>
</ul>
<h3 id="å¯è¿­ä»£å¯¹è±¡"><a class="header" href="#å¯è¿­ä»£å¯¹è±¡">å¯è¿­ä»£å¯¹è±¡</a></h3>
<p>å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹æ³•å®šä¹‰è¿­ä»£å™¨ï¼š</p>
<ul>
<li><code>__iter__(&lt;self&gt;) -&gt; object</code></li>
<li><code>__next__(&lt;self&gt;) -&gt; Option&lt;object&gt; æˆ– IterNextOutput</code> ï¼ˆ<a href="#returning-a-value-from-iteration">å‚è§è¯¦æƒ…</a>ï¼‰</li>
</ul>
<p>ä» <code>__next__</code> è¿”å› <code>None</code> è¡¨ç¤ºæ²¡æœ‰æ›´å¤šé¡¹äº†ã€‚</p>
<p>ç¤ºä¾‹ï¼š</p>
<pre><code class="language-rust no_run">use pyo3::prelude::*;
use std::sync::Mutex;

#[pyclass]
struct MyIterator {
    iter: Mutex&lt;Box&lt;dyn Iterator&lt;Item = Py&lt;PyAny&gt;&gt; + Send&gt;&gt;,
}

#[pymethods]
impl MyIterator {
    fn __iter__(slf: PyRef&lt;'_, Self&gt;) -&gt; PyRef&lt;'_, Self&gt; {
        slf
    }

    fn __next__(slf: PyRefMut&lt;'_, Self&gt;) -&gt; Option&lt;Py&lt;PyAny&gt;&gt; {
        slf.iter.lock().unwrap().next()
    }
}</code></pre>
<p>åœ¨è®¸å¤šæƒ…å†µä¸‹ï¼Œä½ å°†åŒºåˆ†è¢«è¿­ä»£çš„ç±»å‹ï¼ˆå³ <em>å¯è¿­ä»£å¯¹è±¡</em>ï¼‰å’Œå®ƒæä¾›çš„è¿­ä»£å™¨ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¯è¿­ä»£å¯¹è±¡åªéœ€å®ç° <code>__iter__()</code>ï¼Œè€Œè¿­ä»£å™¨å¿…é¡»åŒæ—¶å®ç° <code>__iter__()</code> å’Œ <code>__next__()</code>ã€‚ä¾‹å¦‚ï¼š</p>
<pre><code class="language-rust no_run"><span class="boring">use pyo3::prelude::*;
</span>
#[pyclass]
struct Iter {
    inner: std::vec::IntoIter&lt;usize&gt;,
}

#[pymethods]
impl Iter {
    fn __iter__(slf: PyRef&lt;'_, Self&gt;) -&gt; PyRef&lt;'_, Self&gt; {
        slf
    }

    fn __next__(mut slf: PyRefMut&lt;'_, Self&gt;) -&gt; Option&lt;usize&gt; {
        slf.inner.next()
    }
}

#[pyclass]
struct Container {
    iter: Vec&lt;usize&gt;,
}

#[pymethods]
impl Container {
    fn __iter__(slf: PyRef&lt;'_, Self&gt;) -&gt; PyResult&lt;Py&lt;Iter&gt;&gt; {
        let iter = Iter {
            inner: slf.iter.clone().into_iter(),
        };
        Py::new(slf.py(), iter)
    }
}

<span class="boring">Python::attach(|py| {
</span><span class="boring">    let container = Container { iter: vec![1, 2, 3, 4] };
</span><span class="boring">    let inst = pyo3::Py::new(py, container).unwrap();
</span><span class="boring">    pyo3::py_run!(py, inst, "assert list(inst) == [1, 2, 3, 4]");
</span><span class="boring">    pyo3::py_run!(py, inst, "assert list(iter(iter(inst))) == [1, 2, 3, 4]");
</span><span class="boring">});</span></code></pre>
<p>æœ‰å…³ Python è¿­ä»£åè®®çš„æ›´å¤šç»†èŠ‚ï¼Œè¯·æŸ¥é˜… <a href="https://docs.python.org/library/stdtypes.html#iterator-types">åº“æ–‡æ¡£ä¸­çš„â€œè¿­ä»£å™¨ç±»å‹â€éƒ¨åˆ†</a>ã€‚</p>
<h4 id="ä»è¿­ä»£ä¸­è¿”å›å€¼æœ¬æŒ‡å—åˆ°ç›®å‰ä¸ºæ­¢å±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨-optiont-åœ¨è¿­ä»£è¿‡ç¨‹ä¸­äº§ç”Ÿå€¼åœ¨-python-ä¸­ç”Ÿæˆå™¨ä¹Ÿå¯ä»¥è¿”å›ä¸€ä¸ªå€¼è¿™æ˜¯é€šè¿‡æŠ›å‡º-stopiteration-å¼‚å¸¸å®ç°çš„è¦åœ¨-rust-ä¸­è¡¨è¾¾è¿™ä¸€ç‚¹åº”è¿”å›ä¸€ä¸ª-pyresulterrå¹¶å°†-pystopiteration-ä½œä¸ºé”™è¯¯å€¼"><a class="header" href="#ä»è¿­ä»£ä¸­è¿”å›å€¼æœ¬æŒ‡å—åˆ°ç›®å‰ä¸ºæ­¢å±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨-optiont-åœ¨è¿­ä»£è¿‡ç¨‹ä¸­äº§ç”Ÿå€¼åœ¨-python-ä¸­ç”Ÿæˆå™¨ä¹Ÿå¯ä»¥è¿”å›ä¸€ä¸ªå€¼è¿™æ˜¯é€šè¿‡æŠ›å‡º-stopiteration-å¼‚å¸¸å®ç°çš„è¦åœ¨-rust-ä¸­è¡¨è¾¾è¿™ä¸€ç‚¹åº”è¿”å›ä¸€ä¸ª-pyresulterrå¹¶å°†-pystopiteration-ä½œä¸ºé”™è¯¯å€¼">ä»è¿­ä»£ä¸­è¿”å›å€¼æœ¬æŒ‡å—åˆ°ç›®å‰ä¸ºæ­¢å±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨ <code>Option&lt;T&gt;</code> åœ¨è¿­ä»£è¿‡ç¨‹ä¸­äº§ç”Ÿå€¼ã€‚åœ¨ Python ä¸­ï¼Œç”Ÿæˆå™¨ä¹Ÿå¯ä»¥è¿”å›ä¸€ä¸ªå€¼ï¼Œè¿™æ˜¯é€šè¿‡æŠ›å‡º <code>StopIteration</code> å¼‚å¸¸å®ç°çš„ã€‚è¦åœ¨ Rust ä¸­è¡¨è¾¾è¿™ä¸€ç‚¹ï¼Œåº”è¿”å›ä¸€ä¸ª <code>PyResult::Err</code>ï¼Œå¹¶å°† <code>PyStopIteration</code> ä½œä¸ºé”™è¯¯å€¼ã€‚</a></h4>
<h3 id="å¯ç­‰å¾…å¯¹è±¡"><a class="header" href="#å¯ç­‰å¾…å¯¹è±¡">å¯ç­‰å¾…å¯¹è±¡</a></h3>
<ul>
<li><code>__await__(&lt;self&gt;) -&gt; object</code></li>
<li><code>__aiter__(&lt;self&gt;) -&gt; object</code></li>
<li><code>__anext__(&lt;self&gt;) -&gt; Option&lt;object&gt;</code></li>
</ul>
<h3 id="æ˜ å°„ä¸åºåˆ—ç±»å‹"><a class="header" href="#æ˜ å°„ä¸åºåˆ—ç±»å‹">æ˜ å°„ä¸åºåˆ—ç±»å‹</a></h3>
<p>æœ¬èŠ‚ä¸­çš„é­”æœ¯æ–¹æ³•å¯ç”¨äºå®ç° Python å®¹å™¨ç±»å‹ã€‚Python ä¸­ä¸»è¦æœ‰ä¸¤ç±»å®¹å™¨ï¼šâ€œæ˜ å°„â€ï¼ˆå¦‚ <code>dict</code>ï¼‰ï¼Œå…¶é”®æ˜¯ä»»æ„çš„ï¼›ä»¥åŠâ€œåºåˆ—â€ï¼ˆå¦‚ <code>list</code> å’Œ <code>tuple</code>ï¼‰ï¼Œå…¶é”®ä¸ºæ•´æ•°ã€‚</p>
<p>PyO3 æ‰€åŸºäºçš„ Python C-API ä¸ºåºåˆ—å’Œæ˜ å°„åˆ†åˆ«è®¾ç½®äº†ç‹¬ç«‹çš„â€œæ’æ§½â€ã€‚ä½†åœ¨çº¯ Python ä¸­ç¼–å†™ <code>class</code> æ—¶ï¼Œå®ç°ä¸Šå¹¶æ— æ­¤ç±»åŒºåˆ†â€”â€”ä¾‹å¦‚ï¼Œä¸€ä¸ª <code>__getitem__</code> çš„å®ç°ä¼šåŒæ—¶å¡«å……æ˜ å°„å’Œåºåˆ—çš„æ’æ§½ã€‚</p>
<p>é»˜è®¤æƒ…å†µä¸‹ï¼ŒPyO3 ä¼šå¤ç° Python çš„è¡Œä¸ºï¼Œå³åŒæ—¶å¡«å……æ˜ å°„å’Œåºåˆ—çš„æ’æ§½ã€‚è¿™å¯¹äºä¸ Python è¡Œä¸ºä¸€è‡´çš„â€œç®€å•â€æƒ…å†µä»¥åŠåºåˆ—ç±»å‹æ˜¯åˆç†çš„ï¼Œå› ä¸ºåœ¨åºåˆ—ä¸­ï¼Œæ˜ å°„æ’æ§½æœ¬æ¥ä¹Ÿä¼šç”¨äºå®ç°åˆ‡ç‰‡ç´¢å¼•ã€‚</p>
<p>è€Œæ˜ å°„ç±»å‹é€šå¸¸ä¸å¸Œæœ›å¡«å……åºåˆ—æ’æ§½ã€‚å¦‚æœå¡«å……äº†è¿™äº›æ’æ§½ï¼Œå¯èƒ½ä¼šå¯¼è‡´éé¢„æœŸçš„ç»“æœï¼Œä¾‹å¦‚ï¼š</p>
<ul>
<li>è¯¥æ˜ å°„ç±»å‹å°†èƒ½æˆåŠŸè½¬æ¢ä¸º <a href="class/{{#PYO3_DOCS_URL}}/pyo3/types/struct.PySequence.html"><code>PySequence</code></a>ï¼Œè¿™å¯èƒ½å¯¼è‡´ä½¿ç”¨è€…é”™è¯¯åœ°å¤„ç†è¯¥ç±»å‹ã€‚</li>
<li>Python ä¸ºåºåˆ—æä¾›äº†é»˜è®¤çš„ <code>__iter__</code> å®ç°ï¼Œå®ƒä¼šä» 0 å¼€å§‹è¿ç»­è°ƒç”¨ <code>__getitem__</code> ä¼ å…¥æ­£æ•´æ•°ç´¢å¼•ï¼Œç›´åˆ°æŠ›å‡º <code>IndexError</code> ä¸ºæ­¢ã€‚é™¤éæ˜ å°„çš„é”®ä»…ä¸ºè¿ç»­çš„æ­£æ•´æ•°ï¼Œå¦åˆ™æ­¤ <code>__iter__</code> å®ç°å¾ˆå¯èƒ½ä¸æ˜¯é¢„æœŸè¡Œä¸ºã€‚</li>
</ul>
<p>ä½¿ç”¨ <code>#[pyclass(mapping)]</code> æ³¨è§£å¯æŒ‡ç¤º PyO3 ä»…å¡«å……æ˜ å°„æ’æ§½ï¼Œè€Œè®©åºåˆ—æ’æ§½ä¸ºç©ºã€‚è¿™å°†ä½œç”¨äº <code>__getitem__</code>ã€<code>__setitem__</code> å’Œ <code>__delitem__</code>ã€‚</p>
<p>ä½¿ç”¨ <code>#[pyclass(sequence)]</code> æ³¨è§£å¯æŒ‡ç¤º PyO3 åœ¨å®ç° <code>__len__</code> æ—¶å¡«å…… <code>sq_length</code> æ’æ§½è€Œé <code>mp_length</code> æ’æ§½ã€‚è¿™æœ‰åŠ©äºè¯¸å¦‚ <code>numpy</code> ç­‰åº“å°†æ­¤ç±»è¯†åˆ«ä¸ºåºåˆ—ï¼Œä½†ä¹Ÿä¼šå¯¼è‡´ CPython åœ¨å°†è´Ÿç´¢å¼•ä¼ é€’ç»™ <code>__getitem__</code> å‰è‡ªåŠ¨åŠ ä¸Šåºåˆ—é•¿åº¦ã€‚ï¼ˆå¯¹äºåˆ‡ç‰‡æ“ä½œï¼Œ<code>__getitem__</code>ã€<code>__setitem__</code> å’Œ <code>__delitem__</code> ä»ç„¶ä½¿ç”¨æ˜ å°„æ’æ§½ã€‚ï¼‰</p>
<ul>
<li>
<p><code>__len__(&lt;self&gt;) -&gt; usize</code></p>
<p>å®ç°å†…å»ºå‡½æ•° <code>len()</code>ã€‚</p>
</li>
<li>
<p><code>__contains__(&lt;self&gt;, object) -&gt; bool</code></p>
<p>å®ç°æˆå‘˜æµ‹è¯•æ“ä½œç¬¦ã€‚è‹¥ <code>item</code> åœ¨ <code>self</code> ä¸­åº”è¿”å› <code>true</code>ï¼Œå¦åˆ™è¿”å› <code>false</code>ã€‚å¯¹äºæœªå®šä¹‰ <code>__contains__()</code> çš„å¯¹è±¡ï¼Œæˆå‘˜æµ‹è¯•å°†ç®€å•åœ°éå†åºåˆ—ç›´åˆ°æ‰¾åˆ°åŒ¹é…é¡¹ã€‚</p>
  <details>
  <summary>ç¦ç”¨ Python é»˜è®¤çš„ contains å®ç°</summary>
<p>é»˜è®¤æƒ…å†µä¸‹ï¼Œæ‰€æœ‰å¸¦æœ‰ <code>__iter__</code> æ–¹æ³•çš„ <code>#[pyclass]</code> ç±»å‹éƒ½æ”¯æŒ <code>in</code> æ“ä½œç¬¦çš„é»˜è®¤å®ç°ã€‚è‹¥æŸäº›ç±»å‹ä¸éœ€è¦æ­¤è¡Œä¸ºï¼Œå¯é€šè¿‡å°† <code>__contains__</code> è®¾ç½®ä¸º <code>None</code> æ¥è¦†ç›–ã€‚è¿™ä¸çº¯ Python ç±»çš„æœºåˆ¶ç›¸åŒã€‚å®ç°æ–¹å¼å¦‚ä¸‹ï¼š</p>
<pre><code class="language-rust no_run"><span class="boring">use pyo3::prelude::*;
</span><span class="boring">
</span>#[pyclass]
struct NoContains {}


#[pymethods]
impl NoContains {
    #[classattr]
    const __contains__: Option&lt;Py&lt;PyAny&gt;&gt; = None;
}</code></pre>
  </details>
</li>
<li>
<p><code>__getitem__(&lt;self&gt;, object) -&gt; object</code></p>
<p>å®ç° <code>self[a]</code> å…ƒç´ çš„è·å–ã€‚</p>
<p><em>æ³¨æ„</em>ï¼šPyO3 ä¸ä¼šç‰¹æ®Šå¤„ç†è´Ÿæ•´æ•°ç´¢å¼•ã€‚ä½†å¯¹äºå¸¦æœ‰ <code>#[pyclass(sequence)]</code> çš„ç±»ï¼Œå½“é€šè¿‡ <code>PySequence::get_item</code> è®¿é—®è´Ÿç´¢å¼•æ—¶ï¼Œåº•å±‚ C API å·²ç»ä¼šå°†ç´¢å¼•è°ƒæ•´ä¸ºæ­£å€¼ã€‚</p>
</li>
<li>
<p><code>__setitem__(&lt;self&gt;, object, object) -&gt; ()</code></p>
<p>å®ç°å¯¹ <code>self[a]</code> å…ƒç´ çš„èµ‹å€¼ã€‚ä»…å½“å…ƒç´ å¯è¢«æ›¿æ¢æ—¶æ‰åº”å®ç°æ­¤æ–¹æ³•ã€‚</p>
<p>å¯¹è´Ÿç´¢å¼•çš„å¤„ç†è¡Œä¸ºä¸ <code>__getitem__</code> ç›¸åŒã€‚</p>
</li>
<li>
<p><code>__delitem__(&lt;self&gt;, object) -&gt; ()</code></p>
<p>å®ç°åˆ é™¤ <code>self[a]</code> å…ƒç´ ã€‚ä»…å½“å…ƒç´ å¯è¢«åˆ é™¤æ—¶æ‰åº”å®ç°æ­¤æ–¹æ³•ã€‚</p>
<p>å¯¹è´Ÿç´¢å¼•çš„å¤„ç†è¡Œä¸ºä¸ <code>__getitem__</code> ç›¸åŒã€‚</p>
</li>
<li>
<p><code>fn __concat__(&amp;self, other: impl FromPyObject) -&gt; PyResult&lt;impl ToPyObject&gt;</code></p>
<p>è¿æ¥ä¸¤ä¸ªåºåˆ—ã€‚åœ¨å°è¯•é€šè¿‡ <code>__add__</code> å’Œ <code>__radd__</code> æ–¹æ³•è¿›è¡Œæ•°å€¼åŠ æ³•åï¼Œç”± <code>+</code> æ“ä½œç¬¦ä½¿ç”¨ã€‚</p>
</li>
<li>
<p><code>fn __repeat__(&amp;self, count: isize) -&gt; PyResult&lt;impl ToPyObject&gt;</code></p>
<p>å°†åºåˆ—é‡å¤ <code>count</code> æ¬¡ã€‚åœ¨å°è¯•é€šè¿‡ <code>__mul__</code> å’Œ <code>__rmul__</code> æ–¹æ³•è¿›è¡Œæ•°å€¼ä¹˜æ³•åï¼Œç”± <code>*</code> æ“ä½œç¬¦ä½¿ç”¨ã€‚</p>
</li>
<li>
<p><code>fn __inplace_concat__(&amp;self, other: impl FromPyObject) -&gt; PyResult&lt;impl ToPyObject&gt;</code></p>
<p>è¿æ¥ä¸¤ä¸ªåºåˆ—ã€‚åœ¨å°è¯•é€šè¿‡ <code>__iadd__</code> æ–¹æ³•è¿›è¡Œæ•°å€¼åŠ æ³•åï¼Œç”± <code>+=</code> æ“ä½œç¬¦ä½¿ç”¨ã€‚</p>
</li>
<li>
<p><code>fn __inplace_repeat__(&amp;self, count: isize) -&gt; PyResult&lt;impl ToPyObject&gt;</code></p>
<p>è¿æ¥ä¸¤ä¸ªåºåˆ—ã€‚åœ¨å°è¯•é€šè¿‡ <code>__imul__</code> æ–¹æ³•è¿›è¡Œæ•°å€¼ä¹˜æ³•åï¼Œç”± <code>*=</code> æ“ä½œç¬¦ä½¿ç”¨ã€‚</p>
</li>
</ul>
<h3 id="æè¿°ç¬¦"><a class="header" href="#æè¿°ç¬¦">æè¿°ç¬¦</a></h3>
<ul>
<li><code>__get__(&lt;self&gt;, object, object) -&gt; object</code></li>
<li><code>__set__(&lt;self&gt;, object, object) -&gt; ()</code></li>
<li><code>__delete__(&lt;self&gt;, object) -&gt; ()</code></li>
</ul>
<h3 id="æ•°å€¼ç±»å‹"><a class="header" href="#æ•°å€¼ç±»å‹">æ•°å€¼ç±»å‹</a></h3>
<p>äºŒå…ƒç®—æœ¯æ“ä½œï¼ˆ<code>+</code>ã€<code>-</code>ã€<code>*</code>ã€<code>@</code>ã€<code>/</code>ã€<code>//</code>ã€<code>%</code>ã€<code>divmod()</code>ã€<code>pow()</code> å’Œ <code>**</code>ã€<code>&lt;&lt;</code>ã€<code>&gt;&gt;</code>ã€<code>&amp;</code>ã€<code>^</code>ã€<code>|</code>ï¼‰åŠå…¶åå‘ç‰ˆæœ¬ï¼š</p>
<p>ï¼ˆå¦‚æœå‚æ•° <code>object</code> ä¸ç¬¦åˆç­¾åä¸­æŒ‡å®šçš„ç±»å‹ï¼Œç”Ÿæˆçš„ä»£ç å°†è‡ªåŠ¨ <code>return NotImplemented</code>ã€‚ï¼‰</p>
<ul>
<li><code>__add__(&lt;self&gt;, object) -&gt; object</code></li>
<li><code>__radd__(&lt;self&gt;, object) -&gt; object</code></li>
<li><code>__sub__(&lt;self&gt;, object) -&gt; object</code></li>
<li><code>__rsub__(&lt;self&gt;, object) -&gt; object</code></li>
<li><code>__mul__(&lt;self&gt;, object) -&gt; object</code></li>
<li><code>__rmul__(&lt;self&gt;, object) -&gt; object</code></li>
<li><code>__matmul__(&lt;self&gt;, object) -&gt; object</code></li>
<li><code>__rmatmul__(&lt;self&gt;, object) -&gt; object</code></li>
<li><code>__floordiv__(&lt;self&gt;, object) -&gt; object</code></li>
<li><code>__rfloordiv__(&lt;self&gt;, object) -&gt; object</code></li>
<li><code>__truediv__(&lt;self&gt;, object) -&gt; object</code></li>
<li><code>__rtruediv__(&lt;self&gt;, object) -&gt; object</code></li>
<li><code>__divmod__(&lt;self&gt;, object) -&gt; object</code></li>
<li><code>__rdivmod__(&lt;self&gt;, object) -&gt; object</code></li>
<li><code>__mod__(&lt;self&gt;, object) -&gt; object</code></li>
<li><code>__rmod__(&lt;self&gt;, object) -&gt; object</code></li>
<li><code>__lshift__(&lt;self&gt;, object) -&gt; object</code></li>
<li><code>__rlshift__(&lt;self&gt;, object) -&gt; object</code></li>
<li><code>__rshift__(&lt;self&gt;, object) -&gt; object</code></li>
<li><code>__rrshift__(&lt;self&gt;, object) -&gt; object</code></li>
<li><code>__and__(&lt;self&gt;, object) -&gt; object</code></li>
<li><code>__rand__(&lt;self&gt;, object) -&gt; object</code></li>
<li><code>__xor__(&lt;self&gt;, object) -&gt; object</code></li>
<li><code>__rxor__(&lt;self&gt;, object) -&gt; object</code></li>
<li><code>__or__(&lt;self&gt;, object) -&gt; object</code></li>
<li><code>__ror__(&lt;self&gt;, object) -&gt; object</code></li>
<li><code>__pow__(&lt;self&gt;, object, object) -&gt; object</code></li>
<li><code>__rpow__(&lt;self&gt;, object, object) -&gt; object</code></li>
</ul>
<p>å°±åœ°èµ‹å€¼æ“ä½œï¼ˆ<code>+=</code>ã€<code>-=</code>ã€<code>*=</code>ã€<code>@=</code>ã€<code>/=</code>ã€<code>//=</code>ã€<code>%=</code>, <code>**=</code>ã€<code>&lt;&lt;=</code>ã€<code>&gt;&gt;=</code>ã€<code>&amp;=</code>ã€<code>^=</code>ã€<code>|=</code>ï¼‰ï¼š</p>
<ul>
<li><code>__iadd__(&lt;self&gt;, object) -&gt; ()</code></li>
<li><code>__isub__(&lt;self&gt;, object) -&gt; ()</code></li>
<li><code>__imul__(&lt;self&gt;, object) -&gt; ()</code></li>
<li><code>__imatmul__(&lt;self&gt;, object) -&gt; ()</code></li>
<li><code>__itruediv__(&lt;self&gt;, object) -&gt; ()</code></li>
<li><code>__ifloordiv__(&lt;self&gt;, object) -&gt; ()</code></li>
<li><code>__imod__(&lt;self&gt;, object) -&gt; ()</code></li>
<li><code>__ipow__(&lt;self&gt;, object, object) -&gt; ()</code></li>
<li><code>__ilshift__(&lt;self&gt;, object) -&gt; ()</code></li>
<li><code>__irshift__(&lt;self&gt;, object) -&gt; ()</code></li>
<li><code>__iand__(&lt;self&gt;, object) -&gt; ()</code></li>
<li><code>__ixor__(&lt;self&gt;, object) -&gt; ()</code></li>
<li><code>__ior__(&lt;self&gt;, object) -&gt; ()</code></li>
</ul>
<p>ä¸€å…ƒæ“ä½œï¼ˆ<code>-</code>ã€<code>+</code>ã€<code>abs()</code> å’Œ <code>~</code>ï¼‰ï¼š</p>
<ul>
<li><code>__pos__(&lt;self&gt;) -&gt; object</code></li>
<li><code>__neg__(&lt;self&gt;) -&gt; object</code></li>
<li><code>__abs__(&lt;self&gt;) -&gt; object</code></li>
<li><code>__invert__(&lt;self&gt;) -&gt; object</code></li>
</ul>
<p>ç±»å‹è½¬æ¢ï¼š</p>
<ul>
<li><code>__index__(&lt;self&gt;) -&gt; object (int)</code></li>
<li><code>__int__(&lt;self&gt;) -&gt; object (int)</code></li>
<li><code>__float__(&lt;self&gt;) -&gt; object (float)</code></li>
</ul>
<h3 id="ç¼“å†²åŒºå¯¹è±¡"><a class="header" href="#ç¼“å†²åŒºå¯¹è±¡">ç¼“å†²åŒºå¯¹è±¡</a></h3>
<ul>
<li><code>__getbuffer__(&lt;self&gt;, *mut ffi::Py_buffer, flags) -&gt; ()</code></li>
<li><code>__releasebuffer__(&lt;self&gt;, *mut ffi::Py_buffer) -&gt; ()</code><br><code>__releasebuffer__</code> ä¸­è¿”å›çš„é”™è¯¯å°†è¢«å‘é€åˆ° <code>sys.unraiseablehook</code>ã€‚å¼ºçƒˆå»ºè®®æ°¸è¿œä¸è¦ä»æ­¤æ–¹æ³•è¿”å›é”™è¯¯ï¼Œå¦‚æœç¡®å®å¿…è¦ï¼Œåº”åœ¨è¿”å›å‰å°½æœ€å¤§åŠªåŠ›å®Œæˆæ‰€æœ‰å¿…è¦çš„é‡Šæ”¾æ“ä½œã€‚<code>__releasebuffer__</code> ä¸ä¼šè¢«è°ƒç”¨ç¬¬äºŒæ¬¡ï¼›ä»»ä½•æœªé‡Šæ”¾çš„èµ„æºéƒ½å°†æ³„æ¼ã€‚</li>
</ul>
<h3 id="åƒåœ¾å›æ”¶å™¨é›†æˆ"><a class="header" href="#åƒåœ¾å›æ”¶å™¨é›†æˆ">åƒåœ¾å›æ”¶å™¨é›†æˆ</a></h3>
<p>å¦‚æœä½ çš„ç±»å‹æŒæœ‰å¯¹å…¶ä»– Python å¯¹è±¡çš„å¼•ç”¨ï¼Œåˆ™éœ€è¦ä¸ Python çš„åƒåœ¾å›æ”¶å™¨é›†æˆï¼Œä»¥ä¾¿ GC èƒ½æ„ŸçŸ¥è¿™äº›å¼•ç”¨ã€‚ä¸ºæ­¤ï¼Œéœ€å®ç° <code>__traverse__</code> å’Œ <code>__clear__</code> ä¸¤ä¸ªæ–¹æ³•ã€‚å®ƒä»¬å¯¹åº”äº Python C API ä¸­çš„ <code>tp_traverse</code> å’Œ <code>tp_clear</code> æ’æ§½ã€‚<code>__traverse__</code> å¿…é¡»å¯¹æ¯ä¸ªæŒ‡å‘å…¶ä»– Python å¯¹è±¡çš„å¼•ç”¨è°ƒç”¨ <code>visit.call()</code>ã€‚<code>__clear__</code> å¿…é¡»æ¸…é™¤å¯¹å…¶ä»–å¯å˜ Python å¯¹è±¡çš„æ‰€æœ‰å¼•ç”¨ï¼ˆä»è€Œæ‰“ç ´å¼•ç”¨å¾ªç¯ï¼‰ã€‚ä¸å¯å˜å¼•ç”¨æ— éœ€æ¸…é™¤ï¼Œå› ä¸ºæ¯ä¸ªå¾ªç¯ä¸­å¿…é¡»è‡³å°‘åŒ…å«ä¸€ä¸ªå¯å˜å¼•ç”¨ã€‚</p>
<ul>
<li><code>__traverse__(&lt;self&gt;, pyo3::class::gc::PyVisit&lt;'_&gt;) -&gt; Result&lt;(), pyo3::class::gc::PyTraverseError&gt;</code></li>
<li><code>__clear__(&lt;self&gt;) -&gt; ()</code></li>
</ul>
<blockquote>
<p>æ³¨æ„ï¼š<code>__traverse__</code> ä¸èƒ½ä¸ <a href="#warn"><code>#[pyo3(warn(...))]</code></a> ä¸€èµ·ä½¿ç”¨ã€‚</p>
</blockquote>
<p>ç¤ºä¾‹ï¼š</p>
<pre><code class="language-rust no_run">use pyo3::prelude::*;
use pyo3::PyTraverseError;
use pyo3::gc::PyVisit;


#[pyclass]
struct ClassWithGCSupport {
    obj: Option&lt;Py&lt;PyAny&gt;&gt;,
}


#[pymethods]
impl ClassWithGCSupport {
    fn __traverse__(&amp;self, visit: PyVisit&lt;'_&gt;) -&gt; Result&lt;(), PyTraverseError&gt; {
        visit.call(&amp;self.obj)?;
        Ok(())
    }


    fn __clear__(&amp;mut self) {
        // æ¸…é™¤å¼•ç”¨ï¼Œè¿™ä¼šå‡å°‘å¼•ç”¨è®¡æ•°ã€‚
        self.obj = None;
    }
}</code></pre>
<p>é€šå¸¸ï¼Œ<code>__traverse__</code> çš„å®ç°é™¤äº†è°ƒç”¨ <code>visit.call</code> å¤–ä¸åº”åšå…¶ä»–ä»»ä½•äº‹ã€‚æœ€å…³é”®çš„æ˜¯ï¼Œåœ¨ <code>__traverse__</code> çš„å®ç°ä¸­ç¦æ­¢å®‰å…¨è®¿é—®è§£é‡Šå™¨ï¼Œå³ <code>Python::attach</code> å°†å¼•å‘ panicã€‚&gt; æ³¨æ„ï¼šè¿™äº›æ–¹æ³•å±äº C APIï¼ŒPyPy ä¸ä¸€å®šæ”¯æŒå®ƒä»¬ã€‚å¦‚æœä½ æ­£åœ¨ä¸º PyPy æ„å»ºç¨‹åºï¼Œåº”æµ‹é‡å†…å­˜å ç”¨æƒ…å†µï¼Œä»¥ç¡®ä¿æ²¡æœ‰å¤±æ§çš„å†…å­˜å¢é•¿ã€‚è¯·å‚é˜… <a href="https://github.com/pypy/pypy/issues/3848">PyPy bug è·Ÿè¸ªå™¨ä¸­çš„æ­¤é—®é¢˜</a>ã€‚</p>
<!-- rumdl-disable-next-line MD053 - false positive -->
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="åŸºæœ¬å¯¹è±¡è‡ªå®šä¹‰-1"><a class="header" href="#åŸºæœ¬å¯¹è±¡è‡ªå®šä¹‰-1">åŸºæœ¬å¯¹è±¡è‡ªå®šä¹‰</a></h1>
<p>å›æƒ³ä¸€ä¸‹ä¸Šä¸€ç« ä¸­çš„ <code>Number</code> ç±»ï¼š</p>
<pre><code class="language-rust no_run"><span class="boring">#![allow(dead_code)]
</span><span class="boring">fn main() {}
</span>use pyo3::prelude::*;


#[pyclass]
struct Number(i32);


#[pymethods]
impl Number {
    #[new]
    fn new(value: i32) -&gt; Self {
        Self(value)
    }
}


#[pymodule]
mod my_module {
    #[pymodule_export]
    use super::Number;
}</code></pre>
<p>æ­¤æ—¶ï¼ŒPython ä»£ç å¯ä»¥å¯¼å…¥æ¨¡å—ã€è®¿é—®ç±»å¹¶åˆ›å»ºç±»å®ä¾‹â€”â€”ä½†ä»…æ­¤è€Œå·²ã€‚</p>
<pre><code class="language-python">from my_module import Number


n = Number(5)
print(n)
</code></pre>
<pre><code class="language-text">&lt;builtins.Number object at 0x000002B4D185D7D0&gt;
</code></pre>
<h2 id="å­—ç¬¦ä¸²è¡¨ç¤º"><a class="header" href="#å­—ç¬¦ä¸²è¡¨ç¤º">å­—ç¬¦ä¸²è¡¨ç¤º</a></h2>
<p>å®ƒç”šè‡³æ— æ³•æ‰“å°å‡ºç”¨æˆ·å¯è¯»çš„è‡ªèº«è¡¨ç¤ºï¼æˆ‘ä»¬å¯ä»¥é€šè¿‡åœ¨ <code>#[pymethods]</code> å—å†…å®šä¹‰ <code>__repr__</code> å’Œ <code>__str__</code> æ–¹æ³•æ¥ä¿®å¤è¿™ä¸ªé—®é¢˜ã€‚æˆ‘ä»¬é€šè¿‡è®¿é—® <code>Number</code> å†…éƒ¨åŒ…å«çš„å€¼æ¥å®ç°è¿™ä¸€ç‚¹ã€‚</p>
<pre><code class="language-rust no_run"><span class="boring">use pyo3::prelude::*;
</span><span class="boring">
</span><span class="boring">#[pyclass]
</span><span class="boring">struct Number(i32);
</span><span class="boring">
</span>#[pymethods]
impl Number {
    // å¯¹äº `__repr__`ï¼Œæˆ‘ä»¬å¸Œæœ›è¿”å›ä¸€ä¸ªå­—ç¬¦ä¸²ï¼ŒPython ä»£ç å¯ä»¥ç”¨å®ƒæ¥é‡æ–°åˆ›å»º `Number`ï¼Œä¾‹å¦‚ `Number(5)`ã€‚
    fn __repr__(&amp;self) -&gt; String {
        // æˆ‘ä»¬ä½¿ç”¨ `format!` å®æ¥åˆ›å»ºä¸€ä¸ªå­—ç¬¦ä¸²ã€‚å®ƒçš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ä¸€ä¸ªæ ¼å¼åŒ–å­—ç¬¦ä¸²ï¼Œåé¢è·Ÿç€ä»»æ„æ•°é‡çš„å‚æ•°ï¼Œè¿™äº›å‚æ•°å°†æ›¿æ¢æ ¼å¼å­—ç¬¦ä¸²ä¸­çš„ `{}`ã€‚
        //
        //                       ğŸ‘‡ Rust ä¸­å…ƒç»„å­—æ®µè®¿é—®ä½¿ç”¨ç‚¹å·
        format!("Number({})", self.0)
    }
    // `__str__` é€šå¸¸ç”¨äºåˆ›å»ºä¸€ä¸ªâ€œéæ­£å¼â€çš„è¡¨ç¤ºï¼Œå› æ­¤æˆ‘ä»¬ç›´æ¥è°ƒç”¨ `i32` çš„ `ToString` trait å®ç°æ¥æ‰“å°ä¸€ä¸ªå•çº¯çš„æ•°å­—ã€‚
    fn __str__(&amp;self) -&gt; String {
        self.0.to_string()
    }
}</code></pre>
<p>è¦ä½¿ç”¨ <code>Display</code> trait å®ç°è‡ªåŠ¨ç”Ÿæˆ <code>__str__</code>ï¼Œå¯ä»¥å°† <code>str</code> å‚æ•°ä¼ é€’ç»™ <code>pyclass</code>ã€‚</p>
<pre><code class="language-rust no_run"><span class="boring">use std::fmt::{Display, Formatter};
</span><span class="boring">use pyo3::prelude::*;
</span><span class="boring">
</span><span class="boring">#[allow(dead_code)]
</span>#[pyclass(str)]
struct Coordinate {
    x: i32,
    y: i32,
    z: i32,
}


impl Display for Coordinate {
    fn fmt(&amp;self, f: &amp;mut Formatter&lt;'_&gt;) -&gt; std::fmt::Result {
        write!(f, "({}, {}, {})", self.x, self.y, self.z)
    }
}</code></pre>
<p>ä¸ºäº†æ–¹ä¾¿èµ·è§ï¼Œå¯¹äº<strong>ä»…é™ç»“æ„ä½“</strong>çš„æƒ…å†µï¼Œå¯ä»¥å°†ç®€å†™æ ¼å¼å­—ç¬¦ä¸²ä½œä¸º <code>str="&lt;format string&gt;"</code> ä¼ é€’ã€‚å®ƒä¼šå±•å¼€å¹¶åœ¨ä»¥ä¸‹æ–¹å¼ä¸­ä¼ å…¥ <code>format!</code> å®ï¼š</p>
<ul>
<li><code>"{x}"</code> -&gt; <code>"{}", self.x</code></li>
<li><code>"{0}"</code> -&gt; <code>"{}", self.0</code></li>
<li><code>"{x:?}"</code> -&gt; <code>"{:?}", self.x</code></li>
</ul>
<p><em>æ³¨æ„ï¼šæ ¹æ®ä½ ä½¿ç”¨çš„æ ¼å¼å­—ç¬¦ä¸²ï¼Œè¿™å¯èƒ½è¦æ±‚ä¸ºç»™å®šçš„ Rust ç±»å‹å®ç° <code>Display</code> æˆ– <code>Debug</code> traitã€‚</em><br><em>æ³¨æ„ï¼š<code>pyclass</code> å‚æ•° <code>name</code> å’Œ <code>rename_all</code> ä¸ç®€å†™æ ¼å¼å­—ç¬¦ä¸²ä¸å…¼å®¹ï¼Œä¼šå¯¼è‡´ç¼–è¯‘æ—¶é”™è¯¯ã€‚</em></p>
<pre><code class="language-rust no_run"><span class="boring">use pyo3::prelude::*;
</span><span class="boring">
</span><span class="boring">#[allow(dead_code)]
</span>#[pyclass(str="({x}, {y}, {z})")]
struct Coordinate {
    x: i32,
    y: i32,
    z: i32,
}</code></pre>
<h3 id="è®¿é—®ç±»å"><a class="header" href="#è®¿é—®ç±»å">è®¿é—®ç±»å</a></h3>
<p>åœ¨ <code>__repr__</code> ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨äº†ç¡¬ç¼–ç çš„ç±»åã€‚è¿™æœ‰æ—¶å¹¶ä¸ç†æƒ³ï¼Œå› ä¸ºå¦‚æœè¯¥ç±»åœ¨ Python ä¸­è¢«å­ç±»åŒ–ï¼Œæˆ‘ä»¬å¸Œæœ› <code>repr</code> èƒ½åæ˜ å‡ºå­ç±»çš„åç§°ã€‚è¿™åœ¨ Python ä¸­é€šå¸¸é€šè¿‡è®¿é—® <code>self.__class__.__name__</code> æ¥å®ç°ã€‚ä¸ºäº†èƒ½å¤Ÿè®¿é—® Python çš„ç±»å‹ä¿¡æ¯ <em>å’Œ</em> Rust ç»“æ„ä½“ï¼Œæˆ‘ä»¬éœ€è¦åœ¨ <code>self</code> å‚æ•°ä¸­ä½¿ç”¨ <code>Bound</code>ã€‚</p>
<pre><code class="language-rust no_run"><span class="boring">use pyo3::prelude::*;
</span><span class="boring">use pyo3::types::PyString;
</span><span class="boring">
</span><span class="boring">#[allow(dead_code)]
</span><span class="boring">#[pyclass]
</span><span class="boring">struct Number(i32);
</span><span class="boring">
</span>#[pymethods]
impl Number {
    fn __repr__(slf: &amp;Bound&lt;'_, Self&gt;) -&gt; PyResult&lt;String&gt; {
        // è¿™ç›¸å½“äº Python ä¸­çš„ `self.__class__.__name__`ã€‚
        let class_name: Bound&lt;'_, PyString&gt; = slf.get_type().qualname()?;
        // è¦è®¿é—® Rust ç»“æ„ä½“çš„å­—æ®µï¼Œæˆ‘ä»¬éœ€è¦ä» Bound å¯¹è±¡å€Ÿç”¨ã€‚
        Ok(format!("{}({})", class_name, slf.borrow().0))
    }
}</code></pre>
<h3 id="å“ˆå¸Œ"><a class="header" href="#å“ˆå¸Œ">å“ˆå¸Œ</a></h3>
<p>æˆ‘ä»¬å†æ¥å®ç°å“ˆå¸ŒåŠŸèƒ½ã€‚æˆ‘ä»¬å°†åªå¯¹ <code>i32</code> è¿›è¡Œå“ˆå¸Œã€‚ä¸ºæ­¤æˆ‘ä»¬éœ€è¦ä¸€ä¸ª [<code>Hasher</code>]ã€‚<code>std</code> æä¾›çš„å®ç°æ˜¯ [<code>DefaultHasher</code>]ï¼Œå®ƒä½¿ç”¨ [SipHash] ç®—æ³•ã€‚</p>
<pre><code class="language-rust no_run">use std::collections::hash_map::DefaultHasher;


// éœ€è¦å¯¼å…¥ä»¥è°ƒç”¨ `.hash` å’Œ `.finish` æ–¹æ³•ï¼Œè¿™äº›æ–¹æ³•å®šä¹‰åœ¨ trait ä¸Šã€‚
use std::hash::{Hash, Hasher};


<span class="boring">use pyo3::prelude::*;
</span><span class="boring">
</span><span class="boring">#[allow(dead_code)]
</span><span class="boring">#[pyclass]
</span><span class="boring">struct Number(i32);
</span><span class="boring">
</span>#[pymethods]
impl Number {
    fn __hash__(&amp;self) -&gt; u64 {
        let mut hasher = DefaultHasher::new();
        self.0.hash(&amp;mut hasher);
        hasher.finish()
    }
}</code></pre>
<p>è¦ä½¿ç”¨ Rust çš„ [<code>Hash</code>] trait å®ç°æ¥å®ç° <code>__hash__</code>ï¼Œå¯ä»¥ä½¿ç”¨ <code>hash</code> é€‰é¡¹ã€‚æ­¤é€‰é¡¹ä»…å¯¹ <code>frozen</code> ç±»å¯ç”¨ï¼Œä»¥é˜²æ­¢å› å¯¹è±¡å¯å˜è€Œå¯¼è‡´å“ˆå¸Œå€¼æ„å¤–æ›´æ”¹ã€‚å¦‚æœä½ éœ€è¦ä¸ºå¯å˜ç±»å®ç° <code>__hash__</code>ï¼Œè¯·ä½¿ç”¨ä¸Šé¢çš„æ‰‹åŠ¨æ–¹æ³•ã€‚æ­¤é€‰é¡¹è¿˜è¦æ±‚è®¾ç½® <code>eq</code>ï¼šæ ¹æ® <a href="https://docs.python.org/3/reference/datamodel.html#object.__hash__">Python æ–‡æ¡£</a>ï¼Œâ€œå¦‚æœä¸€ä¸ªç±»æ²¡æœ‰å®šä¹‰ <code>__eq__()</code> æ–¹æ³•ï¼Œåˆ™ä¹Ÿä¸åº”è¯¥å®šä¹‰ <code>__hash__()</code> æ“ä½œâ€ã€‚</p>
<pre><code class="language-rust no_run"><span class="boring">use pyo3::prelude::*;
</span><span class="boring">
</span><span class="boring">#[allow(dead_code)]
</span>#[pyclass(frozen, eq, hash)]
#[derive(PartialEq, Hash)]
struct Number(i32);</code></pre>
<blockquote>
<p><strong>æ³¨æ„</strong>ï¼šåœ¨å®ç° <code>__hash__</code> å’Œæ¯”è¾ƒæ—¶ï¼Œå¿…é¡»ä¿è¯ä»¥ä¸‹å±æ€§æˆç«‹ï¼š</p>
<pre><code class="language-text">k1 == k2 -&gt; hash(k1) == hash(k2)
</code></pre>
<p>æ¢å¥è¯è¯´ï¼Œå¦‚æœä¸¤ä¸ªé”®ç›¸ç­‰ï¼Œå®ƒä»¬çš„å“ˆå¸Œå€¼ä¹Ÿå¿…é¡»ç›¸ç­‰ã€‚æ­¤å¤–ï¼Œä½ å¿…é¡»ç¡®ä¿ç±»çš„å“ˆå¸Œå€¼åœ¨å…¶ç”Ÿå‘½å‘¨æœŸå†…ä¸ä¼šæ”¹å˜ã€‚åœ¨æœ¬æ•™ç¨‹ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡ä¸å…è®¸ Python ä»£ç ä¿®æ”¹æˆ‘ä»¬çš„ <code>Number</code> ç±»æ¥å®ç°è¿™ä¸€ç‚¹ã€‚æ¢å¥è¯è¯´ï¼Œå®ƒæ˜¯ä¸å¯å˜çš„ã€‚</p>
<p>é»˜è®¤æƒ…å†µä¸‹ï¼Œæ‰€æœ‰ <code>#[pyclass]</code> ç±»å‹éƒ½å…·æœ‰æ¥è‡ª Python çš„é»˜è®¤å“ˆå¸Œå®ç°ã€‚ä¸åº”å“ˆå¸Œçš„ç±»å‹å¯ä»¥é€šè¿‡å°† <code>__hash__</code> è®¾ç½®ä¸º None æ¥è¦†ç›–æ­¤è¡Œä¸ºã€‚è¿™ä¸çº¯ Python ç±»çš„æœºåˆ¶ç›¸åŒã€‚å®ç°æ–¹å¼å¦‚ä¸‹ï¼š</p>
<pre><code class="language-rust no_run"><span class="boring">use pyo3::prelude::*;
</span>#[pyclass]
struct NotHashable {}

#[pymethods]
impl NotHashable {
    #[classattr]
    const __hash__: Option&lt;Py&lt;PyAny&gt;&gt; = None;
}</code></pre>
</blockquote>
<h3 id="æ¯”è¾ƒ"><a class="header" href="#æ¯”è¾ƒ">æ¯”è¾ƒ</a></h3>
<p>PyO3 æ”¯æŒ Python ä¸­å¸¸è§çš„é­”æœ¯æ¯”è¾ƒæ–¹æ³•ï¼Œä¾‹å¦‚ <code>__eq__</code>ã€<code>__lt__</code> ç­‰ã€‚ä¹Ÿå¯ä»¥ä¸€æ¬¡æ€§æ”¯æŒå…¨éƒ¨å…­ä¸ªæ“ä½œï¼Œé€šè¿‡ <code>__richcmp__</code> å®ç°ã€‚æ­¤æ–¹æ³•å°†æ ¹æ®æ“ä½œæ¥æ”¶åˆ°ä¸€ä¸ª <code>CompareOp</code> å€¼ã€‚</p>
<pre><code class="language-rust no_run">use pyo3::class::basic::CompareOp;


<span class="boring">use pyo3::prelude::*;
</span><span class="boring">
</span><span class="boring">#[allow(dead_code)]
</span><span class="boring">#[pyclass]
</span><span class="boring">struct Number(i32);
</span><span class="boring">
</span>#[pymethods]
impl Number {
    fn __richcmp__(&amp;self, other: &amp;Self, op: CompareOp) -&gt; PyResult&lt;bool&gt; {
        match op {
            CompareOp::Lt =&gt; Ok(self.0 &lt; other.0),
            CompareOp::Le =&gt; Ok(self.0 &lt;= other.0),
            CompareOp::Eq =&gt; Ok(self.0 == other.0),
            CompareOp::Ne =&gt; Ok(self.0 != other.0),
            CompareOp::Gt =&gt; Ok(self.0 &gt; other.0),
            CompareOp::Ge =&gt; Ok(self.0 &gt;= other.0),
        }
    }
}</code></pre>
<p>å¦‚æœä½ é€šè¿‡æ¯”è¾ƒä¸¤ä¸ª Rust å€¼è·å¾—ç»“æœï¼ˆå¦‚æœ¬ä¾‹æ‰€ç¤ºï¼‰ï¼Œå¯ä»¥ä½¿ç”¨ <code>CompareOp::matches</code> ç®€åŒ–ä»£ç ï¼š</p>
<pre><code class="language-rust no_run">use pyo3::class::basic::CompareOp;


<span class="boring">use pyo3::prelude::*;
</span><span class="boring">
</span><span class="boring">#[allow(dead_code)]
</span><span class="boring">#[pyclass]
</span><span class="boring">struct Number(i32);
</span><span class="boring">
</span>#[pymethods]
impl Number {
    fn __richcmp__(&amp;self, other: &amp;Self, op: CompareOp) -&gt; bool {
        op.matches(self.0.cmp(&amp;other.0))
    }
}</code></pre>
<p>å®ƒä¼šæ£€æŸ¥ä» Rust çš„ <code>Ord</code> è·å¾—çš„ <code>std::cmp::Ordering</code> æ˜¯å¦ä¸ç»™å®šçš„ <code>CompareOp</code> åŒ¹é…ã€‚</p>
<p>æˆ–è€…ï¼Œä½ å¯ä»¥ä»…ä½¿ç”¨ <code>__eq__</code> å®ç°ç›¸ç­‰æ€§æ£€æŸ¥ï¼š</p>
<pre><code class="language-rust"><span class="boring">use pyo3::prelude::*;
</span><span class="boring">
</span><span class="boring">#[pyclass]
</span><span class="boring">struct Number(i32);
</span><span class="boring">
</span>#[pymethods]
impl Number {
    fn __eq__(&amp;self, other: &amp;Self) -&gt; bool {
        self.0 == other.0
    }
}


<span class="boring">fn main() -&gt; PyResult&lt;()&gt; {
</span><span class="boring">    Python::attach(|py| {
</span><span class="boring">        let x = &amp;Bound::new(py, Number(4))?;
</span><span class="boring">        let y = &amp;Bound::new(py, Number(4))?;
</span><span class="boring">        assert!(x.eq(y)?);
</span><span class="boring">        assert!(!x.ne(y)?);
</span><span class="boring">        Ok(())
</span><span class="boring">    })
</span><span class="boring">}</span></code></pre>
<p>è¦ä½¿ç”¨ Rust [<code>PartialEq</code>] trait å®ç°æ¥å®ç° <code>__eq__</code>ï¼Œå¯ä»¥ä½¿ç”¨ <code>eq</code> é€‰é¡¹ã€‚</p>
<pre><code class="language-rust no_run"><span class="boring">use pyo3::prelude::*;
</span><span class="boring">
</span><span class="boring">#[allow(dead_code)]
</span>#[pyclass(eq)]
#[derive(PartialEq)]
struct Number(i32);</code></pre>
<p>è¦ä½¿ç”¨ Rust <code>PartialOrd</code> trait å®ç°æ¥å®ç° <code>__lt__</code>ã€<code>__le__</code>ã€<code>__gt__</code> å’Œ <code>__ge__</code>ï¼Œå¯ä»¥ä½¿ç”¨ <code>ord</code> é€‰é¡¹ã€‚<em>æ³¨æ„ï¼šéœ€è¦ <code>eq</code>ã€‚</em></p>
<pre><code class="language-rust no_run"><span class="boring">use pyo3::prelude::*;
</span><span class="boring">
</span><span class="boring">#[allow(dead_code)]
</span>#[pyclass(eq, ord)]
#[derive(PartialEq, PartialOrd)]
struct Number(i32);</code></pre>
<h3 id="çœŸå€¼æ€§"><a class="header" href="#çœŸå€¼æ€§">çœŸå€¼æ€§</a></h3>
<p>æˆ‘ä»¬å°†è®¤ä¸º <code>Number</code> åœ¨éé›¶æ—¶ä¸º <code>True</code>ï¼š</p>
<pre><code class="language-rust no_run"><span class="boring">use pyo3::prelude::*;
</span><span class="boring">
</span><span class="boring">#[allow(dead_code)]
</span><span class="boring">#[pyclass]
</span><span class="boring">struct Number(i32);
</span><span class="boring">
</span>#[pymethods]
impl Number {
    fn __bool__(&amp;self) -&gt; bool {
        self.0 != 0
    }
}</code></pre>
<h3 id="æœ€ç»ˆä»£ç "><a class="header" href="#æœ€ç»ˆä»£ç ">æœ€ç»ˆä»£ç </a></h3>
<pre><code class="language-rust no_run"><span class="boring">fn main() {}
</span>use std::collections::hash_map::DefaultHasher;
use std::hash::{Hash, Hasher};


use pyo3::prelude::*;
use pyo3::class::basic::CompareOp;
use pyo3::types::PyString;


#[pyclass]
struct Number(i32);


#[pymethods]
impl Number {
    #[new]
    fn new(value: i32) -&gt; Self {
        Self(value)
    }


    fn __repr__(slf: &amp;Bound&lt;'_, Self&gt;) -&gt; PyResult&lt;String&gt; {
        let class_name: Bound&lt;'_, PyString&gt; = slf.get_type().qualname()?;
        Ok(format!("{}({})", class_name, slf.borrow().0))
    }


    fn __str__(&amp;self) -&gt; String {
        self.0.to_string()
    }


    fn __hash__(&amp;self) -&gt; u64 {
        let mut hasher = DefaultHasher::new();
        self.0.hash(&amp;mut hasher);
        hasher.finish()
    }


    fn __richcmp__(&amp;self, other: &amp;Self, op: CompareOp) -&gt; PyResult&lt;bool&gt; {
        match op {
            CompareOp::Lt =&gt; Ok(self.0 &lt; other.0),
            CompareOp::Le =&gt; Ok(self.0 &lt;= other.0),
            CompareOp::Eq =&gt; Ok(self.0 == other.0),
            CompareOp::Ne =&gt; Ok(self.0 != other.0),
            CompareOp::Gt =&gt; Ok(self.0 &gt; other.0),
            CompareOp::Ge =&gt; Ok(self.0 &gt;= other.0),
        }
    }


    fn __bool__(&amp;self) -&gt; bool {
        self.0 != 0
    }
}


#[pymodule]
mod my_module {
    #[pymodule_export]
    use super::Number;
}
```[`Hash`]: https://doc.rust-lang.org/zh-CN/std/hash/trait.Hash.html  
[`Hasher`]: https://doc.rust-lang.org/zh-CN/std/hash/trait.Hasher.html  
[`DefaultHasher`]: https://doc.rust-lang.org/zh-CN/std/collections/hash_map/struct.DefaultHasher.html  
[SipHash]: https://zh.wikipedia.org/wiki/SipHash  
[`PartialEq`]: https://doc.rust-lang.org/zh-CN/std/cmp/trait.PartialEq.html</code></pre>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="æ¨¡æ‹Ÿæ•°å€¼ç±»å‹"><a class="header" href="#æ¨¡æ‹Ÿæ•°å€¼ç±»å‹">æ¨¡æ‹Ÿæ•°å€¼ç±»å‹</a></h1>
<p>ç›®å‰æˆ‘ä»¬æœ‰äº†ä¸€ä¸ª <code>Number</code> ç±»ï¼Œä½†å´æ— æ³•çœŸæ­£è¿›è¡Œä»»ä½•æ•°å­¦è¿ç®—ï¼</p>
<p>åœ¨ç»§ç»­ä¹‹å‰ï¼Œæˆ‘ä»¬åº”è¯¥è€ƒè™‘å¦‚ä½•å¤„ç†æº¢å‡ºé—®é¢˜ã€‚æœ‰ä¸‰ç§æ˜¾è€Œæ˜“è§çš„è§£å†³æ–¹æ¡ˆï¼š</p>
<ul>
<li>
<p>æˆ‘ä»¬å¯ä»¥è®©æ•°å€¼å…·æœ‰æ— é™ç²¾åº¦ï¼Œå°±åƒ Python çš„ <code>int</code> é‚£æ ·ã€‚ä½†é‚£æ ·ä¼šå¾ˆæ— è¶£â€”â€”æˆ‘ä»¬åªæ˜¯åœ¨é‡æ–°å‘æ˜è½®å­ã€‚</p>
</li>
<li>
<p>å½“ <code>Number</code> å‘ç”Ÿæº¢å‡ºæ—¶æŠ›å‡ºå¼‚å¸¸ï¼Œä½†è¿™ä¼šè®© API ä½¿ç”¨èµ·æ¥å¾ˆç—›è‹¦ã€‚</p>
</li>
<li>
<p>æˆ‘ä»¬å¯ä»¥åœ¨ <code>i32</code> çš„è¾¹ç•Œå¤„è¿›è¡Œç¯ç»•ï¼ˆwrap aroundï¼‰ã€‚è¿™æ­£æ˜¯æˆ‘ä»¬è¿™é‡Œé‡‡ç”¨çš„æ–¹æ³•ã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬å°†ç›´æ¥è°ƒç”¨ <code>i32</code> çš„ <code>wrapping_*</code> æ–¹æ³•ã€‚</p>
</li>
</ul>
<h2 id="ä¿®å¤æ„é€ å‡½æ•°"><a class="header" href="#ä¿®å¤æ„é€ å‡½æ•°">ä¿®å¤æ„é€ å‡½æ•°</a></h2>
<p>è®©æˆ‘ä»¬å…ˆè§£å†³æ„é€ å‡½æ•°ä¸­çš„ç¬¬ä¸€ä¸ªæº¢å‡ºé—®é¢˜ï¼š</p>
<pre><code class="language-python">from my_module import Number


n = Number(1 &lt;&lt; 1337)
</code></pre>
<pre><code class="language-text">Traceback (most recent call last):
  File "example.py", line 3, in &lt;module&gt;
    n = Number(1 &lt;&lt; 1337)
OverflowError: Python int too large to convert to C long
</code></pre>
<p>æˆ‘ä»¬ä¸å†ä¾èµ–é»˜è®¤çš„ <a href="class/{{#PYO3_DOCS_URL}}/pyo3/conversion/trait.FromPyObject.html"><code>FromPyObject</code></a> æå–æ–¹å¼æ¥è§£æå‚æ•°ï¼Œè€Œæ˜¯å¯ä»¥æŒ‡å®šè‡ªå·±çš„æå–å‡½æ•°ï¼Œä½¿ç”¨ <code>#[pyo3(from_py_with = ...)]</code> å±æ€§ã€‚ä¸å¹¸çš„æ˜¯ï¼ŒPyO3 å¹¶æ²¡æœ‰æä¾›å¼€ç®±å³ç”¨çš„æ–¹å¼æ¥åŒ…è£… Python æ•´æ•°ï¼Œä½†æˆ‘ä»¬å¯ä»¥é€šè¿‡è°ƒç”¨ Python æ–¹æ³•å°†å…¶æ©ç å¹¶è½¬æ¢ä¸º <code>i32</code>ã€‚</p>
<pre><code class="language-rust no_run"><span class="boring">#![allow(dead_code)]
</span>use pyo3::prelude::*;


fn wrap(obj: &amp;Bound&lt;'_, PyAny&gt;) -&gt; PyResult&lt;i32&gt; {
    let val = obj.call_method1("__and__", (0xFFFFFFFF_u32,))?;
    let val: u32 = val.extract()?;
    //     ğŸ‘‡ è¿™é‡Œæœ‰æ„å‘ç”Ÿæº¢å‡ºï¼
    Ok(val as i32)
}</code></pre>
<p>æˆ‘ä»¬è¿˜æ·»åŠ äº†é€šè¿‡ <code>///</code> æ³¨é‡Šç¼–å†™çš„æ–‡æ¡£ï¼Œè¿™äº›æ–‡æ¡£å¯¹ Python ç”¨æˆ·å¯è§ã€‚</p>
<pre><code class="language-rust no_run"><span class="boring">#![allow(dead_code)]
</span>use pyo3::prelude::*;


fn wrap(obj: &amp;Bound&lt;'_, PyAny&gt;) -&gt; PyResult&lt;i32&gt; {
    let val = obj.call_method1("__and__", (0xFFFFFFFF_u32,))?;
    let val: u32 = val.extract()?;
    Ok(val as i32)
}


/// ä½ å¬è¯´è¿‡è¾¾æ–¯Â·æœ‰ç¬¦å·æº¢å‡ºçš„æ‚²å‰§å—ï¼Ÿæˆ‘æƒ³ä½ æ²¡å¬è¿‡ã€‚
/// è¿™ä¸æ˜¯ä¸€ä¸ª C ä¼šè®²ç»™ä½ çš„æ•…äº‹ã€‚è¿™æ˜¯ä¸€ä¸ª Rust çš„ä¼ è¯´ã€‚
#[pyclass(module = "my_module")]
struct Number(i32);


#[pymethods]
impl Number {
    #[new]
    fn new(#[pyo3(from_py_with = wrap)] value: i32) -&gt; Self {
        Self(value)
    }
}</code></pre>
<p>è§£å†³äº†è¿™ä¸ªé—®é¢˜åï¼Œè®©æˆ‘ä»¬æ¥å®ç°ä¸€äº›æ“ä½œç¬¦ï¼š</p>
<pre><code class="language-rust no_run">use pyo3::exceptions::{PyZeroDivisionError, PyValueError};


<span class="boring">use pyo3::prelude::*;
</span><span class="boring">
</span><span class="boring">#[pyclass]
</span><span class="boring">struct Number(i32);
</span><span class="boring">
</span>#[pymethods]
impl Number {
    fn __add__(&amp;self, other: &amp;Self) -&gt; Self {
        Self(self.0.wrapping_add(other.0))
    }


    fn __sub__(&amp;self, other: &amp;Self) -&gt; Self {
        Self(self.0.wrapping_sub(other.0))
    }


    fn __mul__(&amp;self, other: &amp;Self) -&gt; Self {
        Self(self.0.wrapping_mul(other.0))
    }


    fn __truediv__(&amp;self, other: &amp;Self) -&gt; PyResult&lt;Self&gt; {
        match self.0.checked_div(other.0) {
            Some(i) =&gt; Ok(Self(i)),
            None =&gt; Err(PyZeroDivisionError::new_err("division by zero")),
        }
    }


    fn __floordiv__(&amp;self, other: &amp;Self) -&gt; PyResult&lt;Self&gt; {
        match self.0.checked_div(other.0) {
            Some(i) =&gt; Ok(Self(i)),
            None =&gt; Err(PyZeroDivisionError::new_err("division by zero")),
        }
    }


    fn __rshift__(&amp;self, other: &amp;Self) -&gt; PyResult&lt;Self&gt; {
        match other.0.try_into() {
            Ok(rhs) =&gt; Ok(Self(self.0.wrapping_shr(rhs))),
            Err(_) =&gt; Err(PyValueError::new_err("negative shift count")),
        }
    }


    fn __lshift__(&amp;self, other: &amp;Self) -&gt; PyResult&lt;Self&gt; {
        match other.0.try_into() {
            Ok(rhs) =&gt; Ok(Self(self.0.wrapping_shl(rhs))),
            Err(_) =&gt; Err(PyValueError::new_err("negative shift count")),
        }
    }
}</code></pre>
<h3 id="ä¸€å…ƒç®—æœ¯æ“ä½œ"><a class="header" href="#ä¸€å…ƒç®—æœ¯æ“ä½œ">ä¸€å…ƒç®—æœ¯æ“ä½œ</a></h3>
<pre><code class="language-rust no_run"><span class="boring">use pyo3::prelude::*;
</span><span class="boring">
</span><span class="boring">#[pyclass]
</span><span class="boring">struct Number(i32);
</span><span class="boring">
</span>#[pymethods]
impl Number {
    fn __pos__(slf: PyRef&lt;'_, Self&gt;) -&gt; PyRef&lt;'_, Self&gt; {
        slf
    }


    fn __neg__(&amp;self) -&gt; Self {
        Self(-self.0)
    }


    fn __abs__(&amp;self) -&gt; Self {
        Self(self.0.abs())
    }


    fn __invert__(&amp;self) -&gt; Self {
        Self(!self.0)
    }
}</code></pre>
<h3 id="æ”¯æŒ-complexint-å’Œ-float-å†…ç½®å‡½æ•°"><a class="header" href="#æ”¯æŒ-complexint-å’Œ-float-å†…ç½®å‡½æ•°">æ”¯æŒ <code>complex()</code>ã€<code>int()</code> å’Œ <code>float()</code> å†…ç½®å‡½æ•°</a></h3>
<pre><code class="language-rust no_run"><span class="boring">use pyo3::prelude::*;
</span><span class="boring">
</span><span class="boring">#[pyclass]
</span><span class="boring">struct Number(i32);
</span><span class="boring">
</span>use pyo3::types::PyComplex;


#[pymethods]
impl Number {
    fn __int__(&amp;self) -&gt; i32 {
        self.0
    }


    fn __float__(&amp;self) -&gt; f64 {
        self.0 as f64
    }


    fn __complex__&lt;'py&gt;(&amp;self, py: Python&lt;'py&gt;) -&gt; Bound&lt;'py, PyComplex&gt; {
        PyComplex::from_doubles(py, self.0 as f64, 0.0)
    }
}</code></pre>
<p>æˆ‘ä»¬ä¸å®ç° <code>__iadd__</code> è¿™æ ·çš„å°±åœ°æ“ä½œï¼Œå› ä¸ºæˆ‘ä»¬ä¸æƒ³ä¿®æ”¹ <code>Number</code>ã€‚åŒæ ·ï¼Œæˆ‘ä»¬ä¹Ÿä¸æ‰“ç®—æ”¯æŒä¸åŒç±»å‹ä¹‹é—´çš„æ“ä½œï¼Œå› æ­¤ä¹Ÿä¸ä¼šå®ç° <code>__radd__</code> è¿™æ ·çš„åå‘æ“ä½œã€‚</p>
<p>ç°åœ¨ Python å¯ä»¥ä½¿ç”¨æˆ‘ä»¬çš„ <code>Number</code> ç±»äº†ï¼š</p>
<pre><code class="language-python">from my_module import Number


def hash_djb2(s: str):
	'''
	Daniel J. Bernstein çš„ djb2 å­—ç¬¦ä¸²å“ˆå¸Œç®—æ³•çš„ä¸€ç§å®ç°
	åƒè®¸å¤šå“ˆå¸Œç®—æ³•ä¸€æ ·ï¼Œå®ƒä¾èµ–æ•´æ•°ç¯ç»•ç‰¹æ€§ã€‚
	'''


	n = Number(0)
	five = Number(5)


	for x in s:
		n = Number(ord(x)) + ((n &lt;&lt; five) - n)
	return n


assert hash_djb2('l50_50') == Number(-1152549421)
</code></pre>
<h3 id="å®Œæ•´ä»£ç "><a class="header" href="#å®Œæ•´ä»£ç ">å®Œæ•´ä»£ç </a></h3>
<pre><code class="language-rust">use std::collections::hash_map::DefaultHasher;
use std::hash::{Hash, Hasher};


use pyo3::exceptions::{PyValueError, PyZeroDivisionError};
use pyo3::prelude::*;
use pyo3::class::basic::CompareOp;
use pyo3::types::{PyComplex, PyString};


fn wrap(obj: &amp;Bound&lt;'_, PyAny&gt;) -&gt; PyResult&lt;i32&gt; {
    let val = obj.call_method1("__and__", (0xFFFFFFFF_u32,))?;
    let val: u32 = val.extract()?;
    Ok(val as i32)
}
/// ä½ å¬è¯´è¿‡è¾¾æ–¯Â·æœ‰ç¬¦å·æº¢å‡ºçš„æ‚²å‰§å—ï¼Ÿæˆ‘æƒ³ä½ æ²¡å¬è¿‡ã€‚
/// è¿™ä¸æ˜¯ä¸€ä¸ª C ä¼šè®²ç»™ä½ çš„æ•…äº‹ã€‚è¿™æ˜¯ä¸€ä¸ª Rust çš„ä¼ è¯´ã€‚
#[pyclass(module = "my_module")]
struct Number(i32);


#[pymethods]
impl Number {
    #[new]
    fn new(#[pyo3(from_py_with = wrap)] value: i32) -&gt; Self {
        Self(value)
    }


    fn __repr__(slf: &amp;Bound&lt;'_, Self&gt;) -&gt; PyResult&lt;String&gt; {
       // åŠ¨æ€è·å–ç±»åï¼Œä»¥é˜² `Number` è¢«ç»§æ‰¿
       let class_name: Bound&lt;'_, PyString&gt; = slf.get_type().qualname()?;
        Ok(format!("{}({})", class_name, slf.borrow().0))
    }


    fn __str__(&amp;self) -&gt; String {
        self.0.to_string()
    }


    fn __hash__(&amp;self) -&gt; u64 {
        let mut hasher = DefaultHasher::new();
        self.0.hash(&amp;mut hasher);
        hasher.finish()
    }


    fn __richcmp__(&amp;self, other: &amp;Self, op: CompareOp) -&gt; PyResult&lt;bool&gt; {
        match op {
            CompareOp::Lt =&gt; Ok(self.0 &lt; other.0),
            CompareOp::Le =&gt; Ok(self.0 &lt;= other.0),
            CompareOp::Eq =&gt; Ok(self.0 == other.0),
            CompareOp::Ne =&gt; Ok(self.0 != other.0),
            CompareOp::Gt =&gt; Ok(self.0 &gt; other.0),
            CompareOp::Ge =&gt; Ok(self.0 &gt;= other.0),
        }
    }


    fn __bool__(&amp;self) -&gt; bool {
        self.0 != 0
    }


    fn __add__(&amp;self, other: &amp;Self) -&gt; Self {
        Self(self.0.wrapping_add(other.0))
    }


    fn __sub__(&amp;self, other: &amp;Self) -&gt; Self {
        Self(self.0.wrapping_sub(other.0))
    }


    fn __mul__(&amp;self, other: &amp;Self) -&gt; Self {
        Self(self.0.wrapping_mul(other.0))
    }


    fn __truediv__(&amp;self, other: &amp;Self) -&gt; PyResult&lt;Self&gt; {
        match self.0.checked_div(other.0) {
            Some(i) =&gt; Ok(Self(i)),
            None =&gt; Err(PyZeroDivisionError::new_err("division by zero")),
        }
    }


    fn __floordiv__(&amp;self, other: &amp;Self) -&gt; PyResult&lt;Self&gt; {
        match self.0.checked_div(other.0) {
            Some(i) =&gt; Ok(Self(i)),
            None =&gt; Err(PyZeroDivisionError::new_err("division by zero")),
        }
    }


    fn __rshift__(&amp;self, other: &amp;Self) -&gt; PyResult&lt;Self&gt; {
        match other.0.try_into() {
            Ok(rhs) =&gt; Ok(Self(self.0.wrapping_shr(rhs))),
            Err(_) =&gt; Err(PyValueError::new_err("negative shift count")),
        }
    }


    fn __lshift__(&amp;self, other: &amp;Self) -&gt; PyResult&lt;Self&gt; {
        match other.0.try_into() {
            Ok(rhs) =&gt; Ok(Self(self.0.wrapping_shl(rhs))),
            Err(_) =&gt; Err(PyValueError::new_err("negative shift count")),
        }
    }


    fn __xor__(&amp;self, other: &amp;Self) -&gt; Self {
        Self(self.0 ^ other.0)
    }


    fn __or__(&amp;self, other: &amp;Self) -&gt; Self {
        Self(self.0 | other.0)
    }


    fn __and__(&amp;self, other: &amp;Self) -&gt; Self {
        Self(self.0 &amp; other.0)
    }


    fn __int__(&amp;self) -&gt; i32 {
        self.0
    }


    fn __float__(&amp;self) -&gt; f64 {
        self.0 as f64
    }


    fn __complex__&lt;'py&gt;(&amp;self, py: Python&lt;'py&gt;) -&gt; Bound&lt;'py, PyComplex&gt; {
        PyComplex::from_doubles(py, self.0 as f64, 0.0)
    }
}


#[pymodule]
mod my_module {
    #[pymodule_export]
    use super::Number;
}
<span class="boring">const SCRIPT: &amp;'static std::ffi::CStr = pyo3::ffi::c_str!(r#"
</span><span class="boring">def hash_djb2(s: str):
</span><span class="boring">    n = Number(0)
</span><span class="boring">    five = Number(5)
</span><span class="boring">
</span><span class="boring">    for x in s:
</span><span class="boring">        n = Number(ord(x)) + ((n &lt;&lt; five) - n)
</span><span class="boring">    return n
</span><span class="boring">
</span><span class="boring">assert hash_djb2('l50_50') == Number(-1152549421)
</span><span class="boring">assert hash_djb2('logo') == Number(3327403)
</span><span class="boring">assert hash_djb2('horizon') == Number(1097468315)
</span><span class="boring">
</span><span class="boring">
</span><span class="boring">assert Number(2) + Number(2) == Number(4)
</span><span class="boring">assert Number(2) + Number(2) != Number(5)
</span><span class="boring">
</span><span class="boring">assert Number(13) - Number(7) == Number(6)
</span><span class="boring">assert Number(13) - Number(-7) == Number(20)
</span><span class="boring">
</span><span class="boring">assert Number(13) / Number(7) == Number(1)
</span><span class="boring">assert Number(13) // Number(7) == Number(1)
</span><span class="boring">
</span><span class="boring">assert Number(13) * Number(7) == Number(13*7)
</span><span class="boring">
</span><span class="boring">assert Number(13) &gt; Number(7)
</span><span class="boring">assert Number(13) &lt; Number(20)
</span><span class="boring">assert Number(13) == Number(13)
</span><span class="boring">assert Number(13) &gt;= Number(7)
</span><span class="boring">assert Number(13) &lt;= Number(20)
</span><span class="boring">assert Number(13) == Number(13)
</span><span class="boring">
</span><span class="boring">
</span><span class="boring">assert (True if Number(1) else False)
</span><span class="boring">assert (False if Number(0) else True)
</span><span class="boring">
</span><span class="boring">
</span><span class="boring">assert int(Number(13)) == 13
</span><span class="boring">assert float(Number(13)) == 13
</span><span class="boring">assert Number.__doc__ == "Did you ever hear the tragedy of Darth Signed The Overfloweth? I thought not.\nIt's not a story C would tell you. It's a Rust legend."
</span><span class="boring">assert Number(12345234523452) == Number(1498514748)
</span><span class="boring">try:
</span><span class="boring">    import inspect
</span><span class="boring">    assert inspect.signature(Number).__str__() == '(value)'
</span><span class="boring">except ValueError:
</span><span class="boring">    # Not supported with `abi3` before Python 3.10
</span><span class="boring">    pass
</span><span class="boring">assert Number(1337).__str__() == '1337'
</span><span class="boring">assert Number(1337).__repr__() == 'Number(1337)'
</span>"#);


<span class="boring">
</span><span class="boring">use pyo3::PyTypeInfo;
</span><span class="boring">
</span><span class="boring">fn main() -&gt; PyResult&lt;()&gt; {
</span><span class="boring">    Python::attach(|py| -&gt; PyResult&lt;()&gt; {
</span><span class="boring">        let globals = PyModule::import(py, "__main__")?.dict();
</span><span class="boring">        globals.set_item("Number", Number::type_object(py))?;
</span><span class="boring">
</span><span class="boring">        py.run(SCRIPT, Some(&amp;globals), None)?;
</span><span class="boring">        Ok(())
</span><span class="boring">    })
</span><span class="boring">}
</span>```## é™„å½•ï¼šç¼–å†™ä¸€äº›ä¸å®‰å…¨ä»£ç 

åœ¨æœ¬ç« å¼€å¤´ï¼Œæˆ‘ä»¬æåˆ° PyO3 å¹¶æ²¡æœ‰å¼€ç®±å³ç”¨åœ°æä¾›åŒ…è£… Python æ•´æ•°çš„æ–¹æ³•ï¼Œä½†è¿™åªè¯´å¯¹äº†ä¸€åŠã€‚è™½ç„¶ PyO3 æ²¡æœ‰ä¸ºæ­¤æä¾›é«˜çº§ APIï¼Œä½† Python çš„ C API ä¸­ç¡®å®æœ‰ä¸€ä¸ªå‡½æ•°å¯ä»¥å®Œæˆè¯¥ä»»åŠ¡ï¼š

```c
unsigned long PyLong_AsUnsignedLongMask(PyObject *obj)</code></pre>
<p>æˆ‘ä»¬å¯ä»¥é€šè¿‡ <a href="class/{{#PYO3_DOCS_URL}}/pyo3/ffi/fn.PyLong_AsUnsignedLongMask.html"><code>pyo3::ffi::PyLong_AsUnsignedLongMask</code></a> åœ¨ Rust ä¸­è°ƒç”¨æ­¤å‡½æ•°ã€‚è¿™æ˜¯ä¸€ä¸ª <em>ä¸å®‰å…¨</em>ï¼ˆunsafeï¼‰å‡½æ•°ï¼Œæ„å‘³ç€æˆ‘ä»¬å¿…é¡»ä½¿ç”¨ <code>unsafe</code> å—æ¥è°ƒç”¨å®ƒï¼Œå¹¶è‡ªè¡Œè´Ÿè´£ç»´æŠ¤è¯¥å‡½æ•°çš„å¥‘çº¦ã€‚è®©æˆ‘ä»¬å›é¡¾ä¸€ä¸‹è¿™äº›å¥‘çº¦ï¼š</p>
<ul>
<li>æˆ‘ä»¬å¿…é¡»å·²è¿æ¥åˆ° Python è§£é‡Šå™¨ã€‚å¦‚æœæœªè¿æ¥ï¼Œè°ƒç”¨æ­¤å‡½æ•°ä¼šå¯¼è‡´æ•°æ®ç«äº‰ã€‚</li>
<li>æŒ‡é’ˆå¿…é¡»æœ‰æ•ˆï¼Œå³å®ƒå¿…é¡»æ­£ç¡®å¯¹é½å¹¶æŒ‡å‘ä¸€ä¸ªåˆæ³•çš„ Python å¯¹è±¡ã€‚</li>
</ul>
<p>ç°åœ¨è®©æˆ‘ä»¬å®ç°è¿™ä¸ªè¾…åŠ©å‡½æ•°ã€‚å‡½æ•°ç­¾ååº”ä¸º <code>fn(&amp;Bound&lt;'_, PyAny&gt;) -&gt; PyResult&lt;T&gt;</code>ã€‚</p>
<ul>
<li><code>&amp;Bound&lt;'_, PyAny&gt;</code> ä»£è¡¨ä¸€ä¸ªç»è¿‡æ£€æŸ¥çš„ç»‘å®šå¼•ç”¨ï¼Œå› æ­¤ä»ä¸­è·å–çš„æŒ‡é’ˆæ˜¯æœ‰æ•ˆçš„ï¼ˆä¸”éç©ºï¼‰ã€‚</li>
<li>åªè¦ä½œç”¨åŸŸå†…å­˜åœ¨å¯¹ Python å¯¹è±¡çš„ç»‘å®šå¼•ç”¨ï¼Œå°±ä¿è¯æˆ‘ä»¬å·²ç»è¿æ¥åˆ°è§£é‡Šå™¨ã€‚è¿™ä¸ªå¼•ç”¨ä¹Ÿæ˜¯æˆ‘ä»¬è·å– <a href="class/{{#PYO3_DOCS_URL}}/pyo3/marker/struct.Python.html"><code>Python</code></a> ä»¤ç‰Œçš„åœ°æ–¹ï¼Œå¯ç”¨äºè°ƒç”¨ <a href="class/{{#PYO3_DOCS_URL}}/pyo3/prelude/struct.PyErr.html#method.take"><code>PyErr::take</code></a>ã€‚</li>
</ul>
<pre><code class="language-rust no_run"><span class="boring">#![allow(dead_code)]
</span>use std::ffi::c_ulong;
use pyo3::prelude::*;
use pyo3::ffi;


fn wrap(obj: &amp;Bound&lt;'_, PyAny&gt;) -&gt; Result&lt;i32, PyErr&gt; {
    let py: Python&lt;'_&gt; = obj.py();


    unsafe {
        let ptr = obj.as_ptr();


        let ret: c_ulong = ffi::PyLong_AsUnsignedLongMask(ptr);
        if ret == c_ulong::MAX {
            if let Some(err) = PyErr::take(py) {
                return Err(err);
            }
        }


        Ok(ret as i32)
    }
}</code></pre>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="æ¨¡æ‹Ÿå¯è°ƒç”¨å¯¹è±¡"><a class="header" href="#æ¨¡æ‹Ÿå¯è°ƒç”¨å¯¹è±¡">æ¨¡æ‹Ÿå¯è°ƒç”¨å¯¹è±¡</a></h1>
<p>å¦‚æœç±»å…·æœ‰åä¸º <code>__call__</code> çš„ <code>#[pymethod]</code>ï¼Œåˆ™è¯¥ç±»æ˜¯å¯è°ƒç”¨çš„ã€‚è¿™ä½¿å¾—ç±»çš„å®ä¾‹å¯ä»¥è¡¨ç°å¾—ç±»ä¼¼äºå‡½æ•°ã€‚</p>
<p>è¯¥æ–¹æ³•çš„ç­¾åå¿…é¡»å½¢å¦‚ <code>__call__(&lt;self&gt;, ...) -&gt; object</code>ï¼Œå…¶ä¸­å‚æ•°åˆ—è¡¨å¯ä»¥åƒæ™®é€š pymethod ä¸€æ ·å®šä¹‰ã€‚</p>
<h2 id="ç¤ºä¾‹å®ç°è°ƒç”¨è®¡æ•°å™¨"><a class="header" href="#ç¤ºä¾‹å®ç°è°ƒç”¨è®¡æ•°å™¨">ç¤ºä¾‹ï¼šå®ç°è°ƒç”¨è®¡æ•°å™¨</a></h2>
<p>ä»¥ä¸‹ pyclass æ˜¯ä¸€ä¸ªåŸºæœ¬çš„è£…é¥°å™¨ â€”â€” å…¶æ„é€ å‡½æ•°æ¥æ”¶ä¸€ä¸ª Python å¯¹è±¡ä½œä¸ºå‚æ•°ï¼Œå¹¶åœ¨è¢«è°ƒç”¨æ—¶è°ƒç”¨è¯¥å¯¹è±¡ã€‚ç­‰æ•ˆçš„ Python å®ç°å°†åœ¨æœ€åæä¾›é“¾æ¥ã€‚</p>
<p>åŒ…å«æ­¤ pyclass çš„ç¤ºä¾‹ crate å¯ä»¥åœ¨ <a href="https://github.com/PyO3/pyo3/tree/main/examples/decorator">è¿™é‡Œ</a> æ‰¾åˆ°ã€‚</p>
<pre><code class="language-rust ignore">use pyo3::prelude::*;
use pyo3::types::{PyDict, PyTuple};
use std::sync::atomic::{AtomicU64, Ordering};

/// A function decorator that keeps track how often it is called.
///
/// It otherwise doesn't do anything special.
#[pyclass(name = "Counter")]
pub struct PyCounter {
    // Keeps track of how many calls have gone through.
    //
    // See the discussion at the end for why `AtomicU64` is used.
    count: AtomicU64,

    // This is the actual function being wrapped.
    wraps: Py&lt;PyAny&gt;,
}

#[pymethods]
impl PyCounter {
    // Note that we don't validate whether `wraps` is actually callable.
    //
    // While we could use `PyAny::is_callable` for that, it has some flaws:
    //    1. It doesn't guarantee the object can actually be called successfully
    //    2. We still need to handle any exceptions that the function might raise
    #[new]
    fn __new__(wraps: Py&lt;PyAny&gt;) -&gt; Self {
        PyCounter {
            count: AtomicU64::new(0),
            wraps,
        }
    }

    #[getter]
    fn count(&amp;self) -&gt; u64 {
        self.count.load(Ordering::Relaxed)
    }

    #[pyo3(signature = (*args, **kwargs))]
    fn __call__(
        &amp;self,
        py: Python&lt;'_&gt;,
        args: &amp;Bound&lt;'_, PyTuple&gt;,
        kwargs: Option&lt;&amp;Bound&lt;'_, PyDict&gt;&gt;,
    ) -&gt; PyResult&lt;Py&lt;PyAny&gt;&gt; {
        let new_count = self.count.fetch_add(1, Ordering::Relaxed);
        let name = self.wraps.getattr(py, "__name__")?;

        println!("{name} has been called {new_count} time(s).");

        // After doing something, we finally forward the call to the wrapped function
        let ret = self.wraps.call(py, args, kwargs)?;

        // We could do something with the return value of
        // the function before returning it
        Ok(ret)
    }
}

#[pymodule]
pub fn decorator(module: &amp;Bound&lt;'_, PyModule&gt;) -&gt; PyResult&lt;()&gt; {
    module.add_class::&lt;PyCounter&gt;()?;
    Ok(())
}</code></pre>
<p>Python ä»£ç ï¼š</p>
<pre><code class="language-python">from decorator import Counter


@Counter
def say_hello():
    print("hello")


say_hello()
say_hello()
say_hello()
say_hello()

assert say_hello.count == 4
</code></pre>
<p>è¾“å‡ºï¼š</p>
<pre><code class="language-text">say_hello å·²è¢«è°ƒç”¨ 1 æ¬¡ã€‚
hello
say_hello å·²è¢«è°ƒç”¨ 2 æ¬¡ã€‚
hello
say_hello å·²è¢«è°ƒç”¨ 3 æ¬¡ã€‚
hello
say_hello å·²è¢«è°ƒç”¨ 4 æ¬¡ã€‚
hello
</code></pre>
<h3 id="çº¯-python-å®ç°"><a class="header" href="#çº¯-python-å®ç°">çº¯ Python å®ç°</a></h3>
<p>è¿™ä¸ªåŠŸèƒ½çš„ Python å®ç°ä¸ Rust ç‰ˆæœ¬ç›¸ä¼¼ï¼š</p>
<pre><code class="language-python">class Counter:
    def __init__(self, wraps):
        self.count = 0
        self.wraps = wraps

    def __call__(self, *args, **kwargs):
        self.count += 1
        print(f"{self.wraps.__name__} has been called {self.count} time(s)")
        self.wraps(*args, **kwargs)
</code></pre>
<p>æ³¨æ„ï¼Œå®ƒä¹Ÿå¯ä»¥å®ç°ä¸ºé«˜é˜¶å‡½æ•°ï¼š</p>
<pre><code class="language-python">def Counter(wraps):
    count = 0
    def call(*args, **kwargs):
        nonlocal count
        count += 1
        print(f"{wraps.__name__} has been called {count} time(s)")
        return wraps(*args, **kwargs)
    return call
</code></pre>
<h3 id="atomicu64-çš„ä½œç”¨æ˜¯ä»€ä¹ˆ"><a class="header" href="#atomicu64-çš„ä½œç”¨æ˜¯ä»€ä¹ˆ"><code>AtomicU64</code> çš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ</a></h3>
<p><a href="https://github.com/PyO3/pyo3/discussions/2598" title="Thread Safe Decorator &lt;Help Wanted&gt; Â· Discussion #2598 Â· PyO3/pyo3">ä¹‹å‰çš„å®ç°</a> ä½¿ç”¨äº†æ™®é€šçš„ <code>u64</code>ï¼Œè¿™æ„å‘³ç€éœ€è¦ä½¿ç”¨ <code>&amp;mut self</code> æ¥æ”¶å™¨æ¥æ›´æ–°è®¡æ•°ï¼š</p>
<pre><code class="language-rust ignore">#[pyo3(signature = (*args, **kwargs))]
fn __call__(
    &amp;mut self,
    py: Python&lt;'_&gt;,
    args: &amp;Bound&lt;'_, PyTuple&gt;,
    kwargs: Option&lt;&amp;Bound&lt;'_, PyDict&gt;&gt;,
) -&gt; PyResult&lt;Py&lt;PyAny&gt;&gt; {
    self.count += 1;
    let name = self.wraps.getattr(py, "__name__")?;

    println!("{} has been called {} time(s).", name, self.count);

    // åšå®Œä¸€äº›äº‹æƒ…åï¼Œæœ€ç»ˆå°†è°ƒç”¨è½¬å‘ç»™è¢«åŒ…è£…çš„å‡½æ•°
    let ret = self.wraps.call(py, args, kwargs)?;

    // æˆ‘ä»¬å¯ä»¥åœ¨è¿”å›ä¹‹å‰å¯¹å‡½æ•°çš„è¿”å›å€¼è¿›è¡Œå¤„ç†
    Ok(ret)
}</code></pre>
<p>è¿™ä¸ªé—®é¢˜åœ¨äºï¼Œ<code>&amp;mut self</code> æ¥æ”¶å™¨æ„å‘³ç€ PyO3 å¿…é¡»å¯¹å…¶è¿›è¡Œç‹¬å å€Ÿç”¨ï¼Œå¹¶åœ¨æ•´ä¸ª <code>self.wraps.call(py, args, kwargs)</code> è°ƒç”¨æœŸé—´ä¿æŒè¯¥å€Ÿç”¨ã€‚è¿™ä¸ªè°ƒç”¨ä¼šæŠŠæ§åˆ¶æƒäº¤è¿˜ç»™ç”¨æˆ·çš„ Python ä»£ç ï¼Œè€Œè¿™äº›ä»£ç å¯ä»¥è‡ªç”±æ‰§è¡Œä»»æ„æ“ä½œï¼Œ<em>åŒ…æ‹¬</em> å†æ¬¡è°ƒç”¨è¢«è£…é¥°çš„å‡½æ•°ã€‚å¦‚æœå‘ç”Ÿè¿™ç§æƒ…å†µï¼ŒPyO3 å°†æ— æ³•åˆ›å»ºç¬¬äºŒä¸ªç‹¬å å€Ÿç”¨ï¼Œä»è€Œè¢«è¿«æŠ›å‡ºå¼‚å¸¸ã€‚</p>
<p>å› æ­¤ï¼Œåƒä¸‹é¢è¿™æ ·çœ‹ä¼¼æ— å®³çš„ä»£ç ä¹Ÿä¼šæŠ›å‡ºå¼‚å¸¸ï¼š</p>
<pre><code class="language-py">@Counter
def say_hello():
    if say_hello.count &lt; 2:
        print(f"hello from decorator")

say_hello()
# RuntimeError: Already borrowed
</code></pre>
<p>æœ¬ç« ä¸­çš„å®ç°é€šè¿‡ä»ä¸è¿›è¡Œç‹¬å å€Ÿç”¨è§£å†³äº†è¿™ä¸ªé—®é¢˜ï¼šæ‰€æœ‰æ–¹æ³•éƒ½ä½¿ç”¨ <code>&amp;self</code> ä½œä¸ºæ¥æ”¶å™¨ï¼Œå…è®¸å¤šä¸ªå¼•ç”¨åŒæ—¶å­˜åœ¨ã€‚è¿™è¦æ±‚ä½¿ç”¨å…±äº«è®¡æ•°å™¨ï¼Œè€Œå¯¹ <code>u64</code> å®ç°çº¿ç¨‹å®‰å…¨çš„å†…éƒ¨å¯å˜æ€§ï¼ˆå³ç±»å‹æ— éœ€æ¥å— <code>&amp;mut self</code> å³å¯ä¿®æ”¹å…¶â€œå†…éƒ¨â€çŠ¶æ€ï¼‰æœ€ç›´æ¥çš„æ–¹å¼å°±æ˜¯ä½¿ç”¨ <a href="https://doc.rust-lang.org/std/sync/atomic/struct.AtomicU64.html" title="AtomicU64 in std::sync::atomic - Rust"><code>AtomicU64</code></a>ï¼Œå› æ­¤è¿™é‡Œé‡‡ç”¨äº†å®ƒã€‚</p>
<p>è¿™ä½“ç°äº†è¿è¡Œä»»æ„ Python ä»£ç çš„å±é™©æ€§ â€”â€” éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œâ€œè¿è¡Œä»»æ„ Python ä»£ç â€å¯èƒ½æ¯”ä¸Šé¢çš„ä¾‹å­æ›´åŠ éšè”½ï¼š</p>
<ul>
<li>Python çš„å¼‚æ­¥æ‰§è¡Œå™¨å¯èƒ½åœ¨æ‰§è¡Œ Python ä»£ç è¿‡ç¨‹ä¸­æŒ‚èµ·å½“å‰çº¿ç¨‹ï¼Œå³ä½¿æ˜¯ä½ è‡ªå·±æ§åˆ¶çš„ä»£ç ï¼Œä»è€Œè®©å…¶ä»– Python ä»£ç å¾—ä»¥è¿è¡Œã€‚</li>
<li>é‡Šæ”¾ä»»æ„ Python å¯¹è±¡æ—¶å¯èƒ½è§¦å‘åœ¨ Python ä¸­å®šä¹‰çš„ææ„å‡½æ•°ï¼ˆ<code>__del__</code> æ–¹æ³•ï¼‰ã€‚</li>
<li>è°ƒç”¨ Python çš„ C APIï¼ˆå¤§å¤šæ•° PyO3 API åœ¨å†…éƒ¨éƒ½ä¼šè°ƒç”¨ C API å‡½æ•°ï¼‰å¯èƒ½æŠ›å‡ºå¼‚å¸¸ï¼Œä»è€Œå…è®¸ä¿¡å·å¤„ç†å™¨ä¸­çš„ Python ä»£ç è¿è¡Œã€‚</li>
<li>åœ¨æ”¯æŒè‡ªç”±çº¿ç¨‹çš„æ„å»ºç‰ˆæœ¬ä¸­ï¼Œç”¨æˆ·å¯èƒ½ä½¿ç”¨ Python çš„ <code>threading</code> æ¨¡å—ä»å¤šä¸ªæ“ä½œç³»ç»Ÿçº¿ç¨‹åŒæ—¶è®¿é—®ä½ çš„ç±»å‹ã€‚</li>
</ul>
<p>è¿™ä¸€ç‚¹åœ¨ç¼–å†™ unsafe ä»£ç æ—¶å°¤å…¶é‡è¦ï¼šPython ä»£ç ç»ä¸èƒ½å¯¼è‡´æœªå®šä¹‰è¡Œä¸ºã€‚ä½ å¿…é¡»ç¡®ä¿åœ¨æ‰§è¡Œä¸Šè¿°ä»»ä½•æ“ä½œå‰ï¼Œä½ çš„ Rust ä»£ç å¤„äºä¸€è‡´çŠ¶æ€ã€‚</p>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="pyclass-çº¿ç¨‹å®‰å…¨"><a class="header" href="#pyclass-çº¿ç¨‹å®‰å…¨"><code>#[pyclass]</code> çº¿ç¨‹å®‰å…¨</a></h1>
<p>Python è§£é‡Šå™¨å…è®¸åœ¨å¤šä¸ªçº¿ç¨‹ä¹‹é—´è‡ªç”±å…±äº« Python å¯¹è±¡ã€‚è¿™æ„å‘³ç€ï¼š</p>
<ul>
<li>æ— æ³•æ§åˆ¶å“ªä¸ªçº¿ç¨‹æœ€ç»ˆä¼šé‡Šæ”¾ <code>#[pyclass]</code> å¯¹è±¡ï¼Œå› æ­¤éœ€è¦æ»¡è¶³ <code>Send</code> çº¦æŸã€‚</li>
<li>å¤šä¸ªçº¿ç¨‹å¯èƒ½åŒæ—¶è¯»å– <code>#[pyclass]</code> ä¸­çš„æ•°æ®ï¼Œå› æ­¤éœ€è¦æ»¡è¶³ <code>Sync</code> çº¦æŸã€‚</li>
</ul>
<p>æœ¬æŒ‡å—çš„è¿™ä¸€éƒ¨åˆ†å°†è®¨è®ºå¯ç”¨äºä½¿ç±»å‹æ»¡è¶³è¿™äº›è¦æ±‚çš„å„ç§æ•°æ®ç»“æ„ã€‚</p>
<p>åœ¨æå°‘æ•°ç‰¹æ®Šæƒ…å†µä¸‹ï¼Œå¦‚æœä½ ç¡®å®šä½ çš„ Python åº”ç”¨ç¨‹åºæ°¸è¿œä¸ä¼šä½¿ç”¨çº¿ç¨‹ï¼Œå¯ä»¥ä½¿ç”¨ <a href="#customizing-the-class"><code>#[pyclass(unsendable)]</code></a> é€‰æ‹©ä¸æ»¡è¶³çº¿ç¨‹å®‰å…¨è¦æ±‚ï¼Œä½†ä»£ä»·æ˜¯å¹¶å‘è®¿é—® Rust æ•°æ®ä¼šåœ¨è¿è¡Œæ—¶å¼•å‘é”™è¯¯ã€‚è¿™ä»…é€‚ç”¨äºéå¸¸ç‰¹å®šçš„ä½¿ç”¨åœºæ™¯ï¼›é€šå¸¸æ›´å¥½çš„åšæ³•æ˜¯æ„å»ºæ­£ç¡®çš„çº¿ç¨‹å®‰å…¨ç±»å‹ã€‚</p>
<h2 id="ä½¿-pyclass-ç±»å‹çº¿ç¨‹å®‰å…¨"><a class="header" href="#ä½¿-pyclass-ç±»å‹çº¿ç¨‹å®‰å…¨">ä½¿ <code>#[pyclass]</code> ç±»å‹çº¿ç¨‹å®‰å…¨</a></h2>
<p>çº¿ç¨‹å®‰å…¨çš„ä¸»è¦æŒ‘æˆ˜æ˜¯ç¡®ä¿ä¸¤ä¸ªçº¿ç¨‹ä¸èƒ½åŒæ—¶å¯¹åŒä¸€æ•°æ®è¿›è¡ŒæœªåŒæ­¥çš„å†™æ“ä½œï¼Œå³é¿å…æ•°æ®ç«äº‰ã€‚æ•°æ®ç«äº‰ä¼šå¯¼è‡´ä¸å¯é¢„æµ‹çš„ç»“æœï¼Œå¹¶ä¸” Rust ç¦æ­¢æ­¤ç±»è¡Œä¸ºã€‚</p>
<p>é»˜è®¤æƒ…å†µä¸‹ï¼Œ<code>#[pyclass]</code> ä½¿ç”¨ä¸€ç§ <a href="#bound-and-interior-mutability">â€œå†…éƒ¨å¯å˜æ€§â€ æ¨¡å¼</a>ï¼Œå…è®¸é€šè¿‡å¤šä¸ªå…±äº«å¼•ç”¨ <code>&amp;T</code> æˆ–å•ä¸ªç‹¬å å¼•ç”¨ <code>&amp;mut T</code> æ¥è®¿é—®æ•°æ®ã€‚è¿™ä½¿å¾—ç®€å•çš„ <code>#[pyclass]</code> ç±»å‹èƒ½å¤Ÿè‡ªåŠ¨å®ç°çº¿ç¨‹å®‰å…¨ï¼Œä»£ä»·æ˜¯è¿è¡Œæ—¶æ£€æŸ¥å¹¶å‘è®¿é—®ã€‚å¦‚æœä½¿ç”¨å‘ç”Ÿé‡å ï¼Œå°†å¼•å‘é”™è¯¯ã€‚</p>
<p>ä¾‹å¦‚ï¼Œä¸‹é¢è¿™ä¸ªç®€å•çš„ç±»æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼š</p>
<pre><code class="language-rust no_run"><span class="boring">use pyo3::prelude::*;
</span>

#[pyclass]
struct MyClass {
    x: i32,
    y: i32,
}


#[pymethods]
impl MyClass {
    fn get_x(&amp;self) -&gt; i32 {
        self.x
    }


    fn set_y(&amp;mut self, value: i32) {
        self.y = value;
    }
}</code></pre>
<p>åœ¨ä¸Šè¿°ç¤ºä¾‹ä¸­ï¼Œå¦‚æœæ¥è‡ªä¸¤ä¸ªä¸åŒçº¿ç¨‹çš„ <code>get_x</code> å’Œ <code>set_y</code> è°ƒç”¨å‘ç”Ÿé‡å ï¼Œåˆ™è‡³å°‘å…¶ä¸­ä¸€ä¸ªçº¿ç¨‹å°†é‡åˆ°è¿è¡Œæ—¶é”™è¯¯ï¼Œæç¤ºæ•°æ®â€œå·²è¢«å€Ÿç”¨â€ã€‚</p>
<p>ä¸ºäº†é¿å…è¿™äº›é”™è¯¯ï¼Œä½ å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼ä¹‹ä¸€è‡ªè¡Œæ§åˆ¶å†…éƒ¨å¯å˜æ€§ã€‚</p>
<h3 id="ä½¿ç”¨åŸå­æ•°æ®ç»“æ„"><a class="header" href="#ä½¿ç”¨åŸå­æ•°æ®ç»“æ„">ä½¿ç”¨åŸå­æ•°æ®ç»“æ„</a></h3>
<p>ä¸ºäº†é¿å… <code>&amp;self</code> å’Œ <code>&amp;mut self</code> å¼•ç”¨é‡å å¯¼è‡´è¿è¡Œæ—¶é”™è¯¯ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨ <code>#[pyclass(frozen)]</code> å¹¶ç»“åˆ <a href="https://doc.rust-lang.org/std/sync/atomic/">åŸå­æ•°æ®ç»“æ„</a> ç›´æ¥æ§åˆ¶ä¿®æ”¹ã€‚</p>
<p>ä¾‹å¦‚ï¼Œä½¿ç”¨åŸå­æ•´æ•°å®ç°çš„ä¸Šè¿° <code>MyClass</code> çš„çº¿ç¨‹å®‰å…¨ç‰ˆæœ¬å¦‚ä¸‹ï¼š</p>
<pre><code class="language-rust no_run"><span class="boring">use pyo3::prelude::*;
</span>use std::sync::atomic::{AtomicI32, Ordering};


#[pyclass(frozen)]
struct MyClass {
    x: AtomicI32,
    y: AtomicI32,
}


#[pymethods]
impl MyClass {
    fn get_x(&amp;self) -&gt; i32 {
        self.x.load(Ordering::Relaxed)
    }


    fn set_y(&amp;self, value: i32) {
        self.y.store(value, Ordering::Relaxed)
    }
}</code></pre>
<h3 id="ä½¿ç”¨é”"><a class="header" href="#ä½¿ç”¨é”">ä½¿ç”¨é”</a></h3>
<p>æ›¿ä»£åŸå­æ•°æ®ç»“æ„çš„ä¸€ç§æ–¹æ³•æ˜¯ä½¿ç”¨ <a href="https://doc.rust-lang.org/std/sync/struct.Mutex.html">é”</a>ï¼Œä½¿çº¿ç¨‹åœ¨è®¿é—®å…±äº«æ•°æ®å‰ç­‰å¾…ã€‚</p>
<p>ä¾‹å¦‚ï¼Œä½¿ç”¨é”å®ç°çš„ä¸Šè¿° <code>MyClass</code> çš„çº¿ç¨‹å®‰å…¨ç‰ˆæœ¬å¦‚ä¸‹ï¼š</p>
<pre><code class="language-rust no_run"><span class="boring">use pyo3::prelude::*;
</span>use std::sync::Mutex;


struct MyClassInner {
    x: i32,
    y: i32,
}


#[pyclass(frozen)]
struct MyClass {
    inner: Mutex&lt;MyClassInner&gt;
}


#[pymethods]
impl MyClass {
    fn get_x(&amp;self) -&gt; i32 {
        self.inner.lock().expect("lock not poisoned").x
    }


    fn set_y(&amp;self, value: i32) {
        self.inner.lock().expect("lock not poisoned").y = value;
    }
}</code></pre>
<p>å¦‚æœä½ éœ€è¦åœ¨æŒæœ‰é”çš„åŒæ—¶é”å®šå­˜å‚¨åœ¨ Python è§£é‡Šå™¨ä¸­çš„çŠ¶æ€ï¼Œæˆ–è°ƒç”¨ Python C APIï¼Œä½ å¯èƒ½ä¼šå‘ç° <code>MutexExt</code> trait éå¸¸æœ‰ç”¨ã€‚å®ƒä¸º <code>std::sync::Mutex</code> æä¾›äº†ä¸€ä¸ª <code>lock_py_attached</code> æ–¹æ³•ï¼Œå¯é¿å…ä¸ GIL æˆ–è§£é‡Šå™¨ä¸­çš„å…¶ä»–å…¨å±€åŒæ­¥äº‹ä»¶å‘ç”Ÿæ­»é”ã€‚æ­¤å¤–ï¼Œå¯¹ <code>parking_lot</code> å’Œ <code>lock_api</code> åŒæ­¥åº“çš„æ”¯æŒç”± <code>parking_lot</code> å’Œ <code>lock_api</code> åŠŸèƒ½å¼€å…³æ§åˆ¶ã€‚å¦‚æœä½ éœ€è¦ä»»ä¸€åº“çš„ <code>arc_lock</code> åŠŸèƒ½ï¼Œä¹Ÿå¯ä»¥å¯ç”¨ <code>arc_lock</code> åŠŸèƒ½ã€‚</p>
<h3 id="åŒ…è£…éåŒæ­¥æ•°æ®"><a class="header" href="#åŒ…è£…éåŒæ­¥æ•°æ®">åŒ…è£…éåŒæ­¥æ•°æ®</a></h3>
<p>åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œ<code>#[pyclass]</code> å†…éƒ¨å­˜å‚¨çš„æ•°æ®ç»“æ„æœ¬èº«å¯èƒ½ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚å› æ­¤ Rust ä¸ä¼šä¸ºè¯¥ <code>#[pyclass]</code> ç±»å‹è‡ªåŠ¨å®ç° <code>Send</code> å’Œ <code>Sync</code>ã€‚</p>
<p>ä¸ºäº†å®ç°çº¿ç¨‹å®‰å…¨ï¼Œéœ€è¦æ‰‹åŠ¨å®ç° <code>Send</code> å’Œ <code>Sync</code>ï¼Œè¿™æ˜¯ <code>unsafe</code> æ“ä½œï¼Œå¿…é¡»åœ¨ä»”ç»†è¯„ä¼°å®ç°çš„æ­£ç¡®æ€§ä¹‹åæ‰èƒ½è¿›è¡Œã€‚å¯¹ PyO3 ç±»å‹æ‰§è¡Œæ­¤æ“ä½œä¸å¯¹å…¶ä»–ä»»ä½• Rust ä»£ç çš„æ“ä½œå¹¶æ— åŒºåˆ«ï¼Œ<a href="https://doc.rust-lang.org/nomicon/send-and-sync.html">The Rustonomicon</a> å¯¹æ­¤æœ‰æ·±å…¥çš„è®¨è®ºã€‚</p>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="åœ¨-rust-ä»£ç ä¸­è°ƒç”¨-python"><a class="header" href="#åœ¨-rust-ä»£ç ä¸­è°ƒç”¨-python">åœ¨ Rust ä»£ç ä¸­è°ƒç”¨ Python</a></h1>
<p>æœ¬ç« ä»‹ç»äº†ä» Rust ä¸ Python ä»£ç äº¤äº’çš„ä¸€äº›æ–¹æ³•ã€‚</p>
<p>ä»¥ä¸‹æ˜¯å…³äº <code>'py</code> ç”Ÿå‘½å‘¨æœŸçš„ä»‹ç»ï¼Œä»¥åŠå¯¹ PyO3 API å¦‚ä½•å¤„ç† Python ä»£ç çš„ä¸€äº›æ€»ä½“è¯´æ˜ã€‚</p>
<p>å­ç« èŠ‚è¿˜æ¶µç›–äº†ä»¥ä¸‹ä¸»é¢˜ï¼š</p>
<ul>
<li>PyO3 API ä¸­å¯ç”¨çš„ Python å¯¹è±¡ç±»å‹</li>
<li>å¦‚ä½•å¤„ç† Python å¼‚å¸¸</li>
<li>å¦‚ä½•è°ƒç”¨ Python å‡½æ•°</li>
<li>å¦‚ä½•æ‰§è¡Œç°æœ‰çš„ Python ä»£ç </li>
</ul>
<h2 id="py-ç”Ÿå‘½å‘¨æœŸ"><a class="header" href="#py-ç”Ÿå‘½å‘¨æœŸ"><code>'py</code> ç”Ÿå‘½å‘¨æœŸ</a></h2>
<p>ä¸ºäº†å®‰å…¨åœ°ä¸ Python è§£é‡Šå™¨äº¤äº’ï¼ŒRust çº¿ç¨‹å¿…é¡»[é™„åŠ ]åˆ° Python è§£é‡Šå™¨ã€‚PyO3 æä¾›äº†ä¸€ä¸ª <code>Python&lt;'py&gt;</code> ä»¤ç‰Œï¼Œç”¨äºè¯æ˜è¿™äº›æ¡ä»¶å·²æ»¡è¶³ã€‚å…¶ç”Ÿå‘½å‘¨æœŸ <code>'py</code> æ˜¯ PyO3 API çš„æ ¸å¿ƒç»„æˆéƒ¨åˆ†ã€‚</p>
<p><code>Python&lt;'py&gt;</code> ä»¤ç‰Œå…·æœ‰ä¸‰ä¸ªç”¨é€”ï¼š</p>
<ul>
<li>æä¾›å¯¹ Python è§£é‡Šå™¨çš„å…¨å±€ APIï¼Œä¾‹å¦‚ <a href="{{#PYO3_DOCS_URL}}/pyo3/marker/struct.Python.html#method.eval"><code>py.eval()</code></a> å’Œ <a href="{{#PYO3_DOCS_URL}}/pyo3/marker/struct.Python.html#method.import"><code>py.import()</code></a>ã€‚</li>
<li>å¯ä¼ é€’ç»™éœ€è¦é™„åŠ è¯æ˜çš„å‡½æ•°ï¼Œä¾‹å¦‚ <a href="{{#PYO3_DOCS_URL}}/pyo3/prelude/struct.Py.html#method.clone_ref"><code>Py::clone_ref</code></a>ã€‚</li>
<li>å…¶ç”Ÿå‘½å‘¨æœŸ <code>'py</code> ç”¨äºå°† PyO3 çš„è®¸å¤šç±»å‹ç»‘å®šåˆ° Python è§£é‡Šå™¨ï¼Œä¾‹å¦‚ <a href="{{#PYO3_DOCS_URL}}/pyo3/struct.Bound.html"><code>Bound&lt;'py, T&gt;</code></a>ã€‚</li>
</ul>
<p>PyO3 ä¸­ç»‘å®šåˆ° <code>'py</code> ç”Ÿå‘½å‘¨æœŸçš„ç±»å‹ï¼ˆä¾‹å¦‚ <code>Bound&lt;'py, T&gt;</code>ï¼‰éƒ½åŒ…å«ä¸€ä¸ª <code>Python&lt;'py&gt;</code> ä»¤ç‰Œã€‚è¿™æ„å‘³ç€å®ƒä»¬å¯ä»¥å®Œå…¨è®¿é—® Python è§£é‡Šå™¨ï¼Œå¹¶æä¾›å®Œæ•´çš„ API ä»¥ä¸ Python å¯¹è±¡äº¤äº’ã€‚</p>
<p>è¯·æŸ¥é˜… <a href="{{#PYO3_DOCS_URL}}/pyo3/marker/struct.Python.html#obtaining-a-python-token">PyO3 çš„ API æ–‡æ¡£</a> äº†è§£å¦‚ä½•è·å–æ­¤ç±»ä»¤ç‰Œã€‚</p>
<h3 id="å…¨å±€è§£é‡Šå™¨é”"><a class="header" href="#å…¨å±€è§£é‡Šå™¨é”">å…¨å±€è§£é‡Šå™¨é”</a></h3>
<p>åœ¨æ”¯æŒè‡ªç”±çº¿ç¨‹çš„ Python å¼•å…¥ä¹‹å‰ï¼ˆæœ€æ—©åœ¨ 3.13 ç‰ˆæœ¬ä¸­æä¾›ï¼Œ3.14 ç‰ˆæœ¬å®Œå…¨æ”¯æŒï¼‰ï¼ŒPython è§£é‡Šå™¨é€šè¿‡[å…¨å±€è§£é‡Šå™¨é”]å®ç°çº¿ç¨‹å®‰å…¨ã€‚è¯¥æœºåˆ¶ç¡®ä¿æ¯æ¬¡åªæœ‰ä¸€ä¸ª Python çº¿ç¨‹å¯ä»¥ä½¿ç”¨ Python è§£é‡Šå™¨åŠå…¶ APIã€‚å†å²ä¸Šï¼ŒRust ä»£ç å¯ä»¥åˆ©ç”¨ GIL ä½œä¸ºåŒæ­¥ä¿è¯ï¼Œä½†è‡ªç”±çº¿ç¨‹ Python çš„å¼•å…¥ä½¿è¿™ä¸€å¯èƒ½æ€§ä¸å¤å­˜åœ¨ã€‚</p>
<p><a href="{{#PYO3_DOCS_URL}}/pyo3/sync/index.html"><code>pyo3::sync</code></a> æ¨¡å—æä¾›äº†å¯¹ä¸¤ç§ Python æ„å»ºæ¨¡å¼éƒ½å…¼å®¹çš„åŒæ­¥å·¥å…·ã€‚</p>
<p>ä¸ºäº†åœ¨å¯ç”¨ GIL çš„æ„å»ºä¸­å®ç°å¹¶è¡Œï¼Œä»¥åŠåœ¨è‡ªç”±çº¿ç¨‹æ„å»ºä¸­è·å¾—æœ€ä½³ååé‡ï¼Œé Python æ“ä½œï¼ˆç³»ç»Ÿè°ƒç”¨å’ŒåŸç”Ÿ Rust ä»£ç ï¼‰åº”è€ƒè™‘ä» Python è§£é‡Šå™¨åˆ†ç¦»ï¼Œä»¥å…è®¸å…¶ä»–ä»»åŠ¡ç»§ç»­æ‰§è¡Œã€‚æœ‰å…³å¦‚ä½•å®ç°è¿™ä¸€ç‚¹ï¼Œè¯·å‚é˜…<a href="#å¹¶è¡Œæ€§">å¹¶è¡Œæ€§ç« èŠ‚</a>ã€‚</p>
<h2 id="python-çš„å†…å­˜æ¨¡å‹"><a class="header" href="#python-çš„å†…å­˜æ¨¡å‹">Python çš„å†…å­˜æ¨¡å‹</a></h2>
<p>Python çš„å†…å­˜æ¨¡å‹åœ¨ä¸¤ä¸ªå…³é”®æ–¹é¢ä¸åŒäº Rust çš„å†…å­˜æ¨¡å‹ï¼š</p>
<ul>
<li>æ²¡æœ‰æ‰€æœ‰æƒçš„æ¦‚å¿µï¼›æ‰€æœ‰ Python å¯¹è±¡éƒ½æ˜¯å…±äº«çš„ï¼Œé€šå¸¸é€šè¿‡å¼•ç”¨è®¡æ•°å®ç°</li>
<li>æ²¡æœ‰ç‹¬å å¼•ç”¨ï¼ˆ<code>&amp;mut</code>ï¼‰çš„æ¦‚å¿µï¼›ä»»ä½•å¼•ç”¨éƒ½å¯ä»¥ä¿®æ”¹ Python å¯¹è±¡</li>
</ul>
<p>PyO3 çš„ API é€šè¿‡æä¾›<a href="https://doc.rust-lang.org/book/ch15-00-smart-pointers.html">æ™ºèƒ½æŒ‡é’ˆ</a>ç±»å‹ <code>Py&lt;T&gt;</code>ã€<code>Bound&lt;'py, T&gt;</code> ä»¥åŠï¼ˆæå°‘ä½¿ç”¨çš„ï¼‰<code>Borrowed&lt;'a, 'py, T&gt;</code> åæ˜ äº†è¿™ä¸€ç‚¹ã€‚è¿™äº›æ™ºèƒ½æŒ‡é’ˆéƒ½ä½¿ç”¨ Python çš„å¼•ç”¨è®¡æ•°æœºåˆ¶ã€‚æœ‰å…³è¿™äº›ç±»å‹çš„æ›´å¤šç»†èŠ‚ï¼Œè¯·å‚è§<a href="#python-å¯¹è±¡ç±»å‹">ç±»å‹å­ç« èŠ‚</a>ã€‚</p>
<p>ç”±äºç¼ºä¹ç‹¬å çš„ <code>&amp;mut</code> å¼•ç”¨ï¼ŒPyO3 é’ˆå¯¹ Python å¯¹è±¡çš„ APIï¼ˆä¾‹å¦‚ <a href="{{#PYO3_DOCS_URL}}/pyo3/types/trait.PyListMethods.html#tymethod.append"><code>PyListMethods::append</code></a>ï¼‰ä½¿ç”¨å…±äº«å¼•ç”¨ã€‚è¿™åœ¨å®‰å…¨æ€§ä¸Šæ˜¯å¯è¡Œçš„ï¼Œå› ä¸º Python å¯¹è±¡å†…éƒ¨æœ‰é˜²æ­¢æ•°æ®ç«äº‰çš„æœºåˆ¶ï¼ˆæˆªè‡³æ’°å†™æ—¶ï¼Œä¾èµ–çš„æ˜¯ Python çš„ GILï¼‰ã€‚</p>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="python-å¯¹è±¡ç±»å‹"><a class="header" href="#python-å¯¹è±¡ç±»å‹">Python å¯¹è±¡ç±»å‹</a></h1>
<p>PyO3 æä¾›äº†ä¸¤ç»„ä¸»è¦çš„ç±»å‹æ¥ä¸ Python å¯¹è±¡è¿›è¡Œäº¤äº’ã€‚æœ¬æŒ‡å—çš„è¿™ä¸€éƒ¨åˆ†è¯¦ç»†å±•å¼€ä»‹ç»è¿™äº›ç±»å‹ä»¥åŠå¦‚ä½•é€‰æ‹©ä½¿ç”¨å“ªä¸€ç§ã€‚</p>
<p>ç¬¬ä¸€ç»„ç±»å‹æ˜¯æ‰€æœ‰ Python å¯¹è±¡éƒ½è¢«åŒ…è£¹åœ¨å…¶ä¸­çš„<a href="https://doc.rust-lang.org/book/ch15-00-smart-pointers.html">æ™ºèƒ½æŒ‡é’ˆ</a>ã€‚å®ƒä»¬æ˜¯ <code>Py&lt;T&gt;</code>ã€<code>Bound&lt;'py, T&gt;</code> å’Œ <code>Borrowed&lt;'a, 'py, T&gt;</code>ã€‚ä¸‹é¢çš„<a href="#pyo3çš„æ™ºèƒ½æŒ‡é’ˆ">ç¬¬ä¸€ä¸ªå°èŠ‚</a>å°†è¯¦ç»†å±•å¼€ä»‹ç»è¿™ä¸‰ä¸ªç±»å‹åŠå…¶å­˜åœ¨çš„åŸå› ã€‚</p>
<p>ç¬¬äºŒç»„ç±»å‹æ˜¯å¡«å……æ™ºèƒ½æŒ‡é’ˆä¸­æ³›å‹å‚æ•° <code>T</code> çš„ç±»å‹ã€‚æœ€å¸¸è§çš„æ˜¯ <code>PyAny</code>ï¼Œå®ƒè¡¨ç¤ºä»»æ„ Python å¯¹è±¡ï¼ˆç±»ä¼¼äº Python çš„ <code>typing.Any</code>ï¼‰ã€‚å¯¹äºè®¸å¤š Python å†…ç½®ç±»å‹ï¼Œä¹Ÿæœ‰å…·ä½“çš„ç±»å‹ï¼Œä¾‹å¦‚ <code>PyList</code>ã€<code>PyDict</code> å’Œ <code>PyTuple</code>ã€‚ç”¨æˆ·å®šä¹‰çš„ <code>#[pyclass]</code> ç±»å‹ä¹Ÿå±äºæ­¤ç±»åˆ«ã€‚ä¸‹é¢çš„<a href="#å…·ä½“çš„-python-ç±»å‹">ç¬¬äºŒå°èŠ‚</a>å°†è¿›ä¸€æ­¥è¯´æ˜å¦‚ä½•ä½¿ç”¨è¿™äº›ç±»å‹ã€‚</p>
<h2 id="pyo3-çš„æ™ºèƒ½æŒ‡é’ˆ"><a class="header" href="#pyo3-çš„æ™ºèƒ½æŒ‡é’ˆ">PyO3 çš„æ™ºèƒ½æŒ‡é’ˆ</a></h2>
<p>PyO3 çš„ API æä¾›äº†ä¸‰ç§æ³›å‹æ™ºèƒ½æŒ‡é’ˆï¼š<code>Py&lt;T&gt;</code>ã€<code>Bound&lt;'py, T&gt;</code> å’Œ <code>Borrowed&lt;'a, 'py, T&gt;</code>ã€‚å¯¹äºæ¯ç§ç±»å‹ï¼Œç±»å‹å‚æ•° <code>T</code> éƒ½ä¼šç”±ä¸€ä¸ª<a href="#å…·ä½“çš„-python-ç±»å‹">å…·ä½“çš„ Python ç±»å‹</a>å¡«å……ã€‚ä¾‹å¦‚ï¼Œä¸€ä¸ª Python åˆ—è¡¨å¯¹è±¡å¯ä»¥è¡¨ç¤ºä¸º <code>Py&lt;PyList&gt;</code>ã€<code>Bound&lt;'py, PyList&gt;</code> å’Œ <code>Borrowed&lt;'a, 'py, PyList&gt;</code>ã€‚</p>
<p>ç”±äºè¿™äº›æ™ºèƒ½æŒ‡é’ˆå…·æœ‰ä¸åŒçš„ç”Ÿå‘½å‘¨æœŸå‚æ•°ï¼Œå®ƒä»¬çš„è¡Œä¸ºä¹Ÿå„ä¸ç›¸åŒã€‚<code>Py&lt;T&gt;</code> æ²¡æœ‰ç”Ÿå‘½å‘¨æœŸå‚æ•°ï¼Œ<code>Bound&lt;'py, T&gt;</code> å…·æœ‰<a href="#the-py-lifetime"> <code>'py</code> ç”Ÿå‘½å‘¨æœŸ</a>ä½œä¸ºå‚æ•°ï¼Œè€Œ <code>Borrowed&lt;'a, 'py, T&gt;</code> å…·æœ‰ <code>'py</code> ç”Ÿå‘½å‘¨æœŸä»¥åŠä¸€ä¸ªé¢å¤–çš„ç”Ÿå‘½å‘¨æœŸ <code>'a</code>ï¼Œç”¨äºè¡¨ç¤ºå®ƒå€Ÿç”¨æ•°æ®çš„ç”Ÿå‘½å‘¨æœŸã€‚ï¼ˆä½ å¯ä»¥åœ¨ä¸‹é¢çš„å­å°èŠ‚ä¸­é˜…è¯»æ›´å¤šå…³äºè¿™äº›ç”Ÿå‘½å‘¨æœŸçš„ä¿¡æ¯ã€‚ï¼‰</p>
<p>Python å¯¹è±¡æ˜¯å¼•ç”¨è®¡æ•°çš„ï¼Œå°±åƒ <a href="https://doc.rust-lang.org/stable/std/sync/struct.Arc.html"><code>std::sync::Arc</code></a> ä¸€æ ·ã€‚è¿™äº›æ™ºèƒ½æŒ‡é’ˆçš„ä¸»è¦ä½œç”¨ä¹‹ä¸€å°±æ˜¯å°† Python çš„å¼•ç”¨è®¡æ•°æœºåˆ¶å¸¦åˆ° Rust çš„ API ä¸­ã€‚</p>
<p>å…³äºä½•æ—¶ä½¿ç”¨è¿™äº›æ™ºèƒ½æŒ‡é’ˆçš„å»ºè®®å¦‚ä¸‹ï¼š</p>
<ul>
<li>å°½å¯èƒ½ä½¿ç”¨ <code>Bound&lt;'py, T&gt;</code>ï¼Œå› ä¸ºå®ƒæä¾›äº†æœ€é«˜æ•ˆå’Œå®Œæ•´çš„ APIã€‚</li>
<li><code>Py&lt;T&gt;</code> ä¸»è¦ç”¨äºå­˜å‚¨åœ¨ä¸æƒ³æˆ–æ— æ³•ä¸º <code>Bound&lt;'py, T&gt;</code> æ·»åŠ ç”Ÿå‘½å‘¨æœŸå‚æ•°çš„ Rust <code>struct</code> ä¸­ã€‚</li>
<li><code>Borrowed&lt;'a, 'py, T&gt;</code> å‡ ä¹ä»ä¸ä½¿ç”¨ã€‚å®ƒå¶å°”å‡ºç°åœ¨ Rust ä¸ Python è§£é‡Šå™¨ä¹‹é—´çš„è¾¹ç•Œä¸Šï¼Œä¾‹å¦‚ä» Python å…ƒç»„ä¸­å€Ÿç”¨æ•°æ®æ—¶ï¼ˆè¿™æ˜¯å®‰å…¨çš„ï¼Œå› ä¸ºå…ƒç»„æ˜¯ä¸å¯å˜çš„ï¼‰ã€‚</li>
</ul>
<p>ä¸‹é¢çš„ç« èŠ‚ä¹Ÿä¼šæ›´è¯¦ç»†åœ°è§£é‡Šè¿™äº›æ™ºèƒ½æŒ‡é’ˆã€‚</p>
<h3 id="pyt"><a class="header" href="#pyt"><code>Py&lt;T&gt;</code></a></h3>
<p><a href="{{#PYO3_DOCS_URL}}/pyo3/struct.Py.html"><code>Py&lt;T&gt;</code></a> æ˜¯ PyO3 API ä¸­çš„åŸºç¡€æ™ºèƒ½æŒ‡é’ˆã€‚ç±»å‹å‚æ•° <code>T</code> è¡¨ç¤º Python å¯¹è±¡çš„ç±»å‹ã€‚è¿™ç§æƒ…å†µéå¸¸å¸¸è§çš„æ˜¯ <code>PyAny</code>ï¼Œæ„å‘³ç€ä»»ä½• Python å¯¹è±¡ã€‚</p>
<p>ç”±äº <code>Py&lt;T&gt;</code> ä¸ç»‘å®šåˆ°<a href="#the-py-lifetime"> <code>'py</code> ç”Ÿå‘½å‘¨æœŸ</a>ï¼Œæ‰€ä»¥åœ¨å°† Python å¯¹è±¡å­˜å‚¨åœ¨ä¸å¸Œæœ›æˆ–æ— æ³•å¸¦æœ‰ç”Ÿå‘½å‘¨æœŸå‚æ•°çš„ Rust <code>struct</code> æˆ– <code>enum</code> ä¸­æ—¶ï¼Œåº”ä½¿ç”¨è¯¥ç±»å‹ã€‚ç‰¹åˆ«æ˜¯ <a href="#python-ç±»"><code>#[pyclass]</code></a> ç±»å‹ä¸å…è®¸å¸¦æœ‰ç”Ÿå‘½å‘¨æœŸï¼Œå› æ­¤ <code>Py&lt;T&gt;</code> æ˜¯åœ¨å…¶ä¸­å­˜å‚¨ Python å¯¹è±¡çš„æ­£ç¡®ç±»å‹ã€‚</p>
<p>ç¼ºä¹å¯¹ <code>'py</code> ç”Ÿå‘½å‘¨æœŸçš„ç»‘å®šä¹Ÿæœ‰ä¸€äº›ç¼ºç‚¹ï¼š</p>
<ul>
<li><code>Py&lt;T&gt;</code> ä¸Šçš„å‡ ä¹æ‰€æœ‰æ–¹æ³•éƒ½éœ€è¦ <code>Python&lt;'py&gt;</code> ä»¤ç‰Œä½œä¸ºç¬¬ä¸€ä¸ªå‚æ•°</li>
<li>å…¶ä»–åŠŸèƒ½ï¼Œå¦‚ <a href="https://doc.rust-lang.org/std/ops/trait.Drop.html"><code>Drop</code></a>ï¼Œéœ€è¦åœ¨è¿è¡Œæ—¶æ£€æŸ¥æ˜¯å¦è¿æ¥åˆ°äº† Python è§£é‡Šå™¨ï¼Œå¸¦æ¥è¾ƒå°çš„æ€§èƒ½å¼€é”€</li>
</ul>
<p>ç”±äºè¿™äº›ç¼ºç‚¹ï¼Œ<code>Bound&lt;'py, T&gt;</code> åœ¨ PyO3 çš„è®¸å¤š API ä¸­æ›´å—æ¨èã€‚ç‰¹åˆ«æ˜¯ï¼Œ<code>Bound&lt;'py, T&gt;</code> æ›´é€‚åˆä½œä¸ºå‡½æ•°å‚æ•°ã€‚</p>
<p>è¦å°† <code>Py&lt;T&gt;</code> è½¬æ¢ä¸º <code>Bound&lt;'py, T&gt;</code>ï¼Œå¯ä½¿ç”¨ <code>Py::bind</code> å’Œ <code>Py::into_bound</code> æ–¹æ³•ã€‚å¯ä»¥ä½¿ç”¨ <a href="{{#PYO3_DOCS_URL}}/pyo3/struct.Bound.html#method.unbind"><code>Bound::unbind</code></a> æ–¹æ³•å°† <code>Bound&lt;'py, T&gt;</code> é‡æ–°è½¬æ¢å› <code>Py&lt;T&gt;</code>ã€‚</p>
<h3 id="boundpy-t"><a class="header" href="#boundpy-t"><code>Bound&lt;'py, T&gt;</code></a></h3>
<p><a href="{{#PYO3_DOCS_URL}}/pyo3/struct.Bound.html"><code>Bound&lt;'py, T&gt;</code></a> æ˜¯ä¸ <code>Py&lt;T&gt;</code> å¯¹åº”çš„ç±»å‹ï¼ŒåŒæ—¶ä¹Ÿç»‘å®šåˆ°äº† <code>'py</code> ç”Ÿå‘½å‘¨æœŸã€‚å¯ä»¥å°†å…¶è§†ä¸ºç­‰åŒäº Rust å…ƒç»„ <code>(Python&lt;'py&gt;, Py&lt;T&gt;)</code>ã€‚</p>
<p>é€šè¿‡ç»‘å®šåˆ° <code>'py</code> ç”Ÿå‘½å‘¨æœŸï¼Œ<code>Bound&lt;'py, T&gt;</code> å¯ä»¥ä»¥æœ€é«˜çš„æ•ˆç‡æä¾›å®Œæ•´çš„ PyO3 APIã€‚è¿™æ„å‘³ç€ï¼Œåªè¦æºå¸¦æ­¤ç”Ÿå‘½å‘¨æœŸæ˜¯å¯æ¥å—çš„ï¼Œé€šå¸¸åº”ä½¿ç”¨ <code>Bound&lt;'py, T&gt;</code>ï¼Œå¦åˆ™ä½¿ç”¨ <code>Py&lt;T&gt;</code>ã€‚</p>
<p><code>Bound&lt;'py, T&gt;</code> å‚ä¸ Python çš„å¼•ç”¨è®¡æ•°ã€‚è¿™è¡¨ç¤º <code>Bound&lt;'py, T&gt;</code> æ‹¥æœ‰ä¸€ä¸ª Python å¯¹è±¡ã€‚ä»…æƒ³å€Ÿç”¨ Python å¯¹è±¡çš„ Rust ä»£ç åº”ä½¿ç”¨å…±äº«å¼•ç”¨ <code>&amp;Bound&lt;'py, T&gt;</code>ã€‚å°±åƒ <code>std::sync::Arc</code> ä¸€æ ·ï¼Œä½¿ç”¨ <code>.clone()</code> å’Œ <code>drop()</code> ä¼šå»‰ä»·åœ°å¢åŠ å’Œå‡å°‘å¯¹è±¡çš„å¼•ç”¨è®¡æ•°ï¼ˆåªæ˜¯åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¼•ç”¨è®¡æ•°ç”± Python è§£é‡Šå™¨æœ¬èº«å®ç°ï¼‰ã€‚</p>
<p>ä»¥ <code>Bound&lt;'py, T&gt;</code> ä½œä¸º PyO3 ä¸»è¦ API ç±»å‹ä¸ºä¾‹ï¼Œè€ƒè™‘ä»¥ä¸‹ Python ä»£ç ï¼š</p>
<pre><code class="language-python">def example():
    x = list()   # åˆ›å»ºä¸€ä¸ª Python åˆ—è¡¨
    x.append(1)  # å‘å…¶ä¸­æ·»åŠ æ•´æ•° 1
    y = x        # åˆ›å»ºå¯¹åˆ—è¡¨çš„ç¬¬äºŒä¸ªå¼•ç”¨
    del x        # åˆ é™¤åŸå§‹å¼•ç”¨
</code></pre>
<p>ä½¿ç”¨ PyO3 çš„ APIï¼Œç‰¹åˆ«æ˜¯ <code>Bound&lt;'py, PyList&gt;</code>ï¼Œè¿™æ®µä»£ç è½¬æ¢ä¸ºä»¥ä¸‹ Rust ä»£ç ï¼š</p>
<pre><code class="language-rust">use pyo3::prelude::*;
use pyo3::types::PyList;


fn example&lt;'py&gt;(py: Python&lt;'py&gt;) -&gt; PyResult&lt;()&gt; {
    let x: Bound&lt;'py, PyList&gt; = PyList::empty(py);
    x.append(1)?;
    let y: Bound&lt;'py, PyList&gt; = x.clone(); // y æ˜¯å¯¹åŒä¸€åˆ—è¡¨çš„æ–°å¼•ç”¨
    drop(x); // é‡Šæ”¾åŸå§‹å¼•ç”¨ x
    Ok(())
}
<span class="boring">Python::attach(example).unwrap();</span></code></pre>
<p>æˆ–è€…ï¼Œä¸å¸¦ç±»å‹æ³¨è§£ï¼š</p>
<pre><code class="language-rust">use pyo3::prelude::*;
use pyo3::types::PyList;


fn example(py: Python&lt;'_&gt;) -&gt; PyResult&lt;()&gt; {
    let x = PyList::empty(py);
    x.append(1)?;
    let y = x.clone();
    drop(x);
    Ok(())
}
<span class="boring">Python::attach(example).unwrap();</span></code></pre>
<h4 id="å‡½æ•°å‚æ•°çš„ç”Ÿå‘½å‘¨æœŸ"><a class="header" href="#å‡½æ•°å‚æ•°çš„ç”Ÿå‘½å‘¨æœŸ">å‡½æ•°å‚æ•°çš„ç”Ÿå‘½å‘¨æœŸ</a></h4>
<p>ç”±äº <code>'py</code> ç”Ÿå‘½å‘¨æœŸç»å¸¸ä½œä¸º <code>Bound&lt;'py, T&gt;</code> æ™ºèƒ½æŒ‡é’ˆçš„ä¸€éƒ¨åˆ†å‡ºç°åœ¨å¤šä¸ªå‡½æ•°å‚æ•°ä¸­ï¼ŒRust ç¼–è¯‘å™¨é€šå¸¸éœ€è¦å¯¹è¾“å…¥å’Œè¾“å‡ºçš„ç”Ÿå‘½å‘¨æœŸè¿›è¡Œæ ‡æ³¨ã€‚å½“å‡½æ•°è¾“å‡ºè‡³å°‘æœ‰ä¸€ä¸ªç”Ÿå‘½å‘¨æœŸï¼Œè€Œè¾“å…¥ä¸­å­˜åœ¨å¤šä¸ªç”Ÿå‘½å‘¨æœŸæ—¶ï¼Œè¿™ç§æƒ…å†µå°±ä¼šå‘ç”Ÿã€‚</p>
<p>ä¸¾ä¾‹è¯´æ˜ï¼Œè€ƒè™‘è¿™ä¸ªæ¥å— Python å¯¹è±¡å¹¶å¯¹å…¶åº”ç”¨<a href="{{#PYO3_DOCS_URL}}/pyo3/types/trait.PyAnyMethods.html#tymethod.add">Python <code>+</code> æ“ä½œ</a>çš„å‡½æ•°ï¼š</p>
<pre><code class="language-rust compile_fail"><span class="boring">use pyo3::prelude::*;
</span>fn add(left: &amp;'_ Bound&lt;'_, PyAny&gt;, right: &amp;'_ Bound&lt;'_, PyAny&gt;) -&gt; PyResult&lt;Bound&lt;'_, PyAny&gt;&gt; {
    left.add(right)
}</code></pre>
<p>ç”±äº Python <code>+</code> æ“ä½œå¯èƒ½ä¼šå¼•å‘å¼‚å¸¸ï¼Œæ­¤å‡½æ•°è¿”å› <code>PyResult&lt;Bound&lt;'_, PyAny&gt;&gt;</code>ã€‚å®ƒä¸éœ€è¦æ‹¥æœ‰è¾“å…¥çš„æ‰€æœ‰æƒï¼Œå› æ­¤é‡‡ç”¨ <code>&amp;Bound&lt;'_, PyAny&gt;</code> å…±äº«å¼•ç”¨ã€‚ä¸ºäº†è¯´æ˜é—®é¢˜ï¼Œæ‰€æœ‰ç”Ÿå‘½å‘¨æœŸéƒ½ä½¿ç”¨é€šé…ç¬¦ <code>'_</code>ï¼Œè®© Rust ç¼–è¯‘å™¨å°è¯•æ¨æ–­å®ƒä»¬ã€‚ç”±äºæœ‰å››ä¸ªè¾“å…¥ç”Ÿå‘½å‘¨æœŸï¼ˆä¸¤ä¸ªå…±äº«å¼•ç”¨çš„ç”Ÿå‘½å‘¨æœŸï¼Œä»¥åŠ <code>Bound&lt;'_, PyAny&gt;</code> æŒ‡é’ˆå†…éƒ¨ä¸¤ä¸ªæœªå‘½åçš„ <code>'py</code> ç”Ÿå‘½å‘¨æœŸï¼‰ï¼Œç¼–è¯‘å™¨æ— æ³•åˆ¤æ–­å“ªä¸ªå¿…é¡»ä¸è¾“å‡ºå…³è”ã€‚</p>
<p>æ­£ç¡®çš„è§£å†³æ–¹æ³•æ˜¯å°† <code>'py</code> ç”Ÿå‘½å‘¨æœŸä½œä¸ºå‡½æ•°çš„å‚æ•°ï¼Œå¹¶å‘½å <code>Bound&lt;'py, PyAny&gt;</code> æ™ºèƒ½æŒ‡é’ˆå†…çš„æ‰€æœ‰ <code>'py</code> ç”Ÿå‘½å‘¨æœŸã€‚å¯¹äºå…±äº«å¼•ç”¨ï¼Œä¹Ÿå¯ä»¥å°† <code>&amp;'_</code> ç®€åŒ–ä¸º <code>&amp;</code>ã€‚æœ€ç»ˆå¯è¡Œçš„ç»“æœå¦‚ä¸‹ï¼š</p>
<pre><code class="language-rust"><span class="boring">use pyo3::prelude::*;
</span>fn add&lt;'py&gt;(
    left: &amp;Bound&lt;'py, PyAny&gt;,
    right: &amp;Bound&lt;'py, PyAny&gt;,
) -&gt; PyResult&lt;Bound&lt;'py, PyAny&gt;&gt; {
    left.add(right)
}
<span class="boring">Python::attach(|py| {
</span><span class="boring">    let s = pyo3::types::PyString::new(py, "s");
</span><span class="boring">    assert!(add(&amp;s, &amp;s).unwrap().eq("ss").unwrap());
</span><span class="boring">})</span></code></pre>
<p>å¦‚æœä¸º <code>'py</code> ç”Ÿå‘½å‘¨æœŸå‘½åä½¿å‡½æ•°ç­¾åå˜å¾—ä¸å¿…è¦çš„å¤æ‚ï¼Œä¹Ÿå¯ä»¥æ¥å—è¿”å›æ— ç”Ÿå‘½å‘¨æœŸçš„ <code>Py&lt;PyAny&gt;</code>ã€‚ä»£ä»·æ˜¯åœ¨å®ç°ä¸Šç•¥å¾®å¢åŠ å¤æ‚æ€§ï¼Œå¦‚å¼•å…¥å¯¹ <a href="{{#PYO3_DOCS_URL}}/pyo3/struct.Bound.html#method.unbind"><code>Bound::unbind</code></a> çš„è°ƒç”¨ï¼š</p>
<pre><code class="language-rust"><span class="boring">use pyo3::prelude::*;
</span>fn add(left: &amp;Bound&lt;'_, PyAny&gt;, right: &amp;Bound&lt;'_, PyAny&gt;) -&gt; PyResult&lt;Py&lt;PyAny&gt;&gt; {
    let output: Bound&lt;'_, PyAny&gt; = left.add(right)?;
    Ok(output.unbind())
}
<span class="boring">Python::attach(|py| {
</span><span class="boring">    let s = pyo3::types::PyString::new(py, "s");
</span><span class="boring">    assert!(add(&amp;s, &amp;s).unwrap().bind(py).eq("ss").unwrap());
</span><span class="boring">})</span></code></pre>
<h3 id="borroweda-py-t"><a class="header" href="#borroweda-py-t"><code>Borrowed&lt;'a, 'py, T&gt;</code></a></h3>
<p><a href="{{#PYO3_DOCS_URL}}/pyo3/struct.Borrowed.html"><code>Borrowed&lt;'a, 'py, T&gt;</code></a> æ˜¯ä¸€ç§é«˜çº§ç±»å‹ï¼Œä»…å¶å°”ç”¨äºä¸ Python è§£é‡Šå™¨äº¤äº’çš„è¾¹ç•Œå¤„ã€‚å¯ä»¥å°†å…¶è§†ä¸ºç±»ä¼¼äºå…±äº«å¼•ç”¨ <code>&amp;'a Bound&lt;'py, T&gt;</code>ã€‚ä¸åŒä¹‹å¤„åœ¨äºï¼Œ<code>Borrowed&lt;'a, 'py, T&gt;</code> æœ¬èº«åªæ˜¯ä¸€ä¸ªæ™ºèƒ½æŒ‡é’ˆï¼Œè€Œä¸æ˜¯â€œæŒ‡å‘æ™ºèƒ½æŒ‡é’ˆçš„å¼•ç”¨â€ï¼Œè¿™åœ¨ä¸ Python è§£é‡Šå™¨çš„ç‰¹å®šäº¤äº’ä¸­å‡å°‘äº†é—´æ¥å±‚çº§ï¼Œæ˜¯æœ‰ç›Šçš„ä¼˜åŒ–ã€‚</p>
<p><code>Borrowed&lt;'a, 'py, T&gt;</code> ä¼šè§£å¼•ç”¨åˆ° <code>Bound&lt;'py, T&gt;</code>ï¼Œå› æ­¤ <code>Bound&lt;'py, T&gt;</code> ä¸Šçš„æ‰€æœ‰æ–¹æ³•åœ¨ <code>Borrowed&lt;'a, 'py, T&gt;</code> ä¸Šéƒ½å¯ç”¨ã€‚</p>
<p>ä¸€ä¸ªä½¿ç”¨ <code>Borrowed&lt;'a, 'py, T&gt;</code> çš„ä¾‹å­æ˜¯ <a href="{{#PYO3_DOCS_URL}}/pyo3/types/trait.PyTupleMethods.html#tymethod.get_item"><code>PyTupleMethods::get_borrowed_item</code></a>ï¼š</p>
<pre><code class="language-rust">use pyo3::prelude::*;
use pyo3::types::PyTuple;


<span class="boring">fn example&lt;'py&gt;(py: Python&lt;'py&gt;) -&gt; PyResult&lt;()&gt; {
</span>// åˆ›å»ºä¸€ä¸ªåŒ…å«å…ƒç´  (0, 1, 2) çš„æ–°å…ƒç»„
let t = PyTuple::new(py, [0, 1, 2])?;
for i in 0..=2 {
    let entry: Borrowed&lt;'_, 'py, PyAny&gt; = t.get_borrowed_item(i)?;
    // `PyAnyMethods::extract` å¯é€šè¿‡è§£å¼•ç”¨åˆ° `Bound` åœ¨ `Borrowed` ä¸Šä½¿ç”¨
    let value: usize = entry.extract()?;
    assert_eq!(i, value);
}
<span class="boring">Ok(())
</span><span class="boring">}
</span><span class="boring">Python::attach(example).unwrap();</span></code></pre>
<h3 id="åœ¨æ™ºèƒ½æŒ‡é’ˆç±»å‹ä¹‹é—´è½¬æ¢"><a class="header" href="#åœ¨æ™ºèƒ½æŒ‡é’ˆç±»å‹ä¹‹é—´è½¬æ¢">åœ¨æ™ºèƒ½æŒ‡é’ˆç±»å‹ä¹‹é—´è½¬æ¢</a></h3>
<p>è¦åœ¨ <code>Py&lt;T&gt;</code> å’Œ <code>Bound&lt;'py, T&gt;</code> ä¹‹é—´è½¬æ¢ï¼Œè¯·ä½¿ç”¨ <code>bind()</code> / <code>into_bound()</code> æ–¹æ³•ã€‚ä½¿ç”¨ <code>as_unbound()</code> / <code>unbind()</code> æ–¹æ³•ä» <code>Bound&lt;'py, T&gt;</code> è½¬å› <code>Py&lt;T&gt;</code>ã€‚</p>
<pre><code class="language-rust ignore">let obj: Py&lt;PyAny&gt; = ...;
let bound: &amp;Bound&lt;'py, PyAny&gt; = obj.bind(py);
let bound: Bound&lt;'py, PyAny&gt; = obj.into_bound(py);


let obj: &amp;Py&lt;PyAny&gt; = bound.as_unbound();
let obj: Py&lt;PyAny&gt; = bound.unbind();
```è¦å°† `Bound&lt;'py, T&gt;` è½¬æ¢ä¸º `Borrowed&lt;'a, 'py, T&gt;`ï¼Œè¯·ä½¿ç”¨ `as_borrowed()` æ–¹æ³•ã€‚`Borrowed&lt;'a, 'py, T&gt;` å¯é€šè¿‡ Deref å¼ºåˆ¶è§£å¼•ç”¨ä¸º `Bound&lt;'py, T&gt;`ã€‚ä½¿ç”¨ `to_owned()` æ–¹æ³•å¯ä»¥å¢åŠ  Python å¼•ç”¨è®¡æ•°ï¼Œå¹¶ä» `Borrowed&lt;'a, 'py, T&gt;` åˆ›å»ºä¸€ä¸ªæ–°çš„ `Bound&lt;'py, T&gt;`ã€‚

```rust,ignore
let bound: Bound&lt;'py, PyAny&gt; = ...;
let borrowed: Borrowed&lt;'_, 'py, PyAny&gt; = bound.as_borrowed();


// Deref å¼ºåˆ¶è½¬æ¢
let bound: &amp;Bound&lt;'py, PyAny&gt; = &amp;borrowed;


// é€šè¿‡å¢åŠ  Python å¼•ç”¨è®¡æ•°åˆ›å»ºæ–°çš„ Bound
let bound: Bound&lt;'py, PyAny&gt; = borrowed.to_owned();</code></pre>
<p>è¦å°† <code>Py&lt;T&gt;</code> ä¸ <code>Borrowed&lt;'a, 'py, T&gt;</code> ä¹‹é—´è½¬æ¢ï¼Œè¯·ä½¿ç”¨ <code>bind_borrowed()</code> æ–¹æ³•ã€‚ä» <code>Borrowed&lt;'a, 'py, T&gt;</code> è¿”å›åˆ° <code>Py&lt;T&gt;</code> æ—¶ï¼Œå¯é€šè¿‡ <code>Bound&lt;'py, T&gt;</code> ä½¿ç”¨ <code>as_unbound()</code> æˆ– <code>.to_owned().unbind()</code> æ–¹æ³•ã€‚</p>
<pre><code class="language-rust ignore">let obj: Py&lt;PyAny&gt; = ...;
let borrowed: Borrowed&lt;'_, 'py, PyAny&gt; = obj.bind_borrowed(py);


// é€šè¿‡ Deref å¼ºåˆ¶è½¬ä¸º Boundï¼Œå†è°ƒç”¨ Bound::as_unbound
let obj: &amp;Py&lt;PyAny&gt; = borrowed.as_unbound();


// é€šè¿‡å¢åŠ  Python å¼•ç”¨è®¡æ•°åˆ›å»ºæ–°çš„ Boundï¼Œå†è§£ç»‘
let obj: Py&lt;PyAny&gt; = borrowed.to_owned().unbind();</code></pre>
<h2 id="å…·ä½“çš„-python-ç±»å‹"><a class="header" href="#å…·ä½“çš„-python-ç±»å‹">å…·ä½“çš„ Python ç±»å‹</a></h2>
<p>åœ¨ <code>Py&lt;T&gt;</code>ã€<code>Bound&lt;'py, T&gt;</code> å’Œ <code>Borrowed&lt;'a, 'py, T&gt;</code> ä¸­ï¼Œç±»å‹å‚æ•° <code>T</code> è¡¨ç¤ºæ™ºèƒ½æŒ‡é’ˆæ‰€å¼•ç”¨çš„ Python å¯¹è±¡çš„ç±»å‹ã€‚</p>
<p>ç±»å‹å‚æ•° <code>T</code> å¯ä»¥æ˜¯ä»¥ä¸‹ç±»å‹ï¼š</p>
<ul>
<li><a href="{{#PYO3_DOCS_URL}}/pyo3/types/struct.PyAny.html"><code>PyAny</code></a>ï¼Œè¡¨ç¤ºä»»æ„ Python å¯¹è±¡ï¼›</li>
<li>åŸç”Ÿ Python ç±»å‹ï¼Œä¾‹å¦‚ <code>PyList</code>ã€<code>PyTuple</code> å’Œ <code>PyDict</code>ï¼›</li>
<li>ä½¿ç”¨ <a href="#python-ç±»"><code>#[pyclass]</code></a> ä» Rust å®šä¹‰çš„ç±»å‹ã€‚</li>
</ul>
<p>ä»¥ä¸‹å°èŠ‚è¯¦ç»†ä»‹ç»å¦‚ä½•ä½¿ç”¨è¿™äº›ç±»å‹ï¼š</p>
<ul>
<li>è¿™äº›å…·ä½“ç±»å‹å¯ä½¿ç”¨çš„ APIï¼›</li>
<li>å¦‚ä½•å°† <code>Bound&lt;'py, T&gt;</code> è½¬æ¢ä¸ºç‰¹å®šçš„å…·ä½“ç±»å‹ï¼›</li>
<li>å¦‚ä½•ä» <code>Bound&lt;'py, T&gt;</code> æå– Rust æ•°æ®ã€‚</li>
</ul>
<h3 id="ä½¿ç”¨å…·ä½“-python-ç±»å‹çš„-api"><a class="header" href="#ä½¿ç”¨å…·ä½“-python-ç±»å‹çš„-api">ä½¿ç”¨å…·ä½“ Python ç±»å‹çš„ API</a></h3>
<p>æ¯ä¸ªå…·ä½“ Python ç±»å‹ï¼ˆå¦‚ <code>PyAny</code>ã€<code>PyTuple</code> å’Œ <code>PyDict</code>ï¼‰éƒ½ä¼šåœ¨å¯¹åº”çš„ç»‘å®šæ™ºèƒ½æŒ‡é’ˆ <code>Bound&lt;'py, PyAny&gt;</code>ã€<code>Bound&lt;'py, PyTuple&gt;</code> å’Œ <code>Bound&lt;'py, PyDict&gt;</code> ä¸Šæš´éœ²å…¶ APIã€‚</p>
<p>æ¯ç§ç±»å‹çš„ API éƒ½é€šè¿‡ä¸€ä¸ª trait æš´éœ²ï¼š<code>PyAnyMethods</code>ã€<code>PyTupleMethods</code>ã€<code>PyDictMethods</code> ç­‰ï¼Œé€‚ç”¨äºæ‰€æœ‰å…·ä½“ç±»å‹ã€‚ä½¿ç”¨ trait è€Œéç›´æ¥åœ¨ <code>Bound</code> æ™ºèƒ½æŒ‡é’ˆä¸Šå®šä¹‰å…³è”æ–¹æ³•ï¼Œå‡ºäºä»¥ä¸‹å‡ ä¸ªåŸå› ï¼š</p>
<ul>
<li>æ–‡æ¡£æ¸…æ™°æ€§ï¼šæ¯ä¸ª trait åœ¨ PyO3 API æ–‡æ¡£ä¸­éƒ½æœ‰ç‹¬ç«‹çš„é¡µé¢ã€‚å¦‚æœæ‰€æœ‰æ–¹æ³•éƒ½ç›´æ¥æ”¾åœ¨ <code>Bound</code> ä¸Šï¼ŒPyO3 ç»å¤§å¤šæ•° API å°†é›†ä¸­åœ¨ä¸€ä¸ªæé•¿çš„æ–‡æ¡£é¡µé¢ä¸Šã€‚</li>
<li>ä¸€è‡´æ€§ï¼šä¸‹æ¸¸ä»£ç åœ¨ä¸ºç°æœ‰ Python ç±»å‹å®ç° Rust API æ—¶ï¼Œä¹Ÿå¯ä»¥éµå¾ªè¿™ç§ trait æ¨¡å¼ã€‚æ­¤å¤–ï¼Œä¸‹æ¸¸ä»£ç æ— æ³•ç›´æ¥ä¸º <code>Bound</code> ç±»å‹æ·»åŠ æ–°çš„å…³è”æ–¹æ³•ã€‚</li>
<li>æœªæ¥è®¾è®¡ï¼šå¸Œæœ›æœªæ¥çš„ Rust æ”¯æŒ <a href="https://github.com/rust-lang/rust/issues/44874">ä»»æ„ self ç±»å‹</a> åï¼Œå¯ä»¥ä¸å†éœ€è¦è¿™äº› traitï¼Œè€Œç›´æ¥å°†æ–¹æ³•æ”¾åœ¨ <code>PyAny</code>ã€<code>PyTuple</code>ã€<code>PyDict</code> ç­‰ç±»å‹ä¸Šã€‚</li>
</ul>
<p>è¿™äº› trait éƒ½åŒ…å«åœ¨ <code>pyo3::prelude</code> æ¨¡å—ä¸­ã€‚å› æ­¤ï¼Œå½“ä½¿ç”¨é€šé…ç¬¦å¯¼å…¥ <code>use pyo3::prelude::*</code> æ—¶ï¼Œå®Œæ•´çš„ PyO3 API å°±å¯¹ä¸‹æ¸¸ä»£ç å¯ç”¨ã€‚</p>
<p>ä»¥ä¸‹å‡½æ•°ä½¿ç”¨ <code>PyListMethods</code> trait ä¸­çš„ <code>.get_item()</code> æ–¹æ³•è®¿é—®è¾“å…¥ Python åˆ—è¡¨çš„ç¬¬ä¸€ä¸ªå…ƒç´ ï¼š</p>
<pre><code class="language-rust">use pyo3::prelude::*;
use pyo3::types::PyList;


fn get_first_item&lt;'py&gt;(list: &amp;Bound&lt;'py, PyList&gt;) -&gt; PyResult&lt;Bound&lt;'py, PyAny&gt;&gt; {
    list.get_item(0)
}
<span class="boring">Python::attach(|py| {
</span><span class="boring">    let l = PyList::new(py, ["hello world"]).unwrap();
</span><span class="boring">    assert!(get_first_item(&amp;l).unwrap().eq("hello world").unwrap());
</span><span class="boring">})</span></code></pre>
<h3 id="åœ¨-python-å¯¹è±¡ç±»å‹ä¹‹é—´è½¬æ¢"><a class="header" href="#åœ¨-python-å¯¹è±¡ç±»å‹ä¹‹é—´è½¬æ¢">åœ¨ Python å¯¹è±¡ç±»å‹ä¹‹é—´è½¬æ¢</a></h3>
<p>è¦å°† <code>Bound&lt;'py, T&gt;</code> æ™ºèƒ½æŒ‡é’ˆè½¬æ¢ä¸ºå…¶ä»–ç±»å‹ï¼Œè¯·ä½¿ç”¨ <a href="{{#PYO3_DOCS_URL}}/pyo3/struct.Bound.html#method.cast"><code>.cast()</code></a> ç³»åˆ—æ–¹æ³•ã€‚è¿™ä¼šå°† <code>&amp;Bound&lt;'py, T&gt;</code> è½¬æ¢ä¸ºå¦ä¸€ä¸ª <code>&amp;Bound&lt;'py, U&gt;</code>ï¼Œä¸è½¬ç§»æ‰€æœ‰æƒã€‚å¦å¤–æœ‰ <a href="{{#PYO3_DOCS_URL}}/pyo3/struct.Bound.html#method.cast_into"><code>.cast_into()</code></a> å¯å°† <code>Bound&lt;'py, T&gt;</code> è½¬æ¢ä¸º <code>Bound&lt;'py, U&gt;</code> å¹¶è½¬ç§»æ‰€æœ‰æƒã€‚è¿™äº›æ–¹æ³•é€‚ç”¨äºæ‰€æœ‰å®ç°äº† <a href="{{#PYO3_DOCS_URL}}/pyo3/type_object/trait.PyTypeCheck.html"><code>PyTypeCheck</code></a> trait çš„ç±»å‹ <code>T</code>ã€‚</p>
<p>è½¬æ¢ä¸º <code>Bound&lt;'py, PyAny&gt;</code> å¯ä½¿ç”¨ <code>.as_any()</code> æˆ– <code>.into_any()</code>ã€‚</p>
<p>ä¾‹å¦‚ï¼Œä»¥ä¸‹ä»£ç æ®µå±•ç¤ºäº†å¦‚ä½•å°† <code>Bound&lt;'py, PyAny&gt;</code> è½¬æ¢ä¸º <code>Bound&lt;'py, PyTuple&gt;</code>ï¼š</p>
<pre><code class="language-rust"><span class="boring">use pyo3::prelude::*;
</span><span class="boring">use pyo3::types::PyTuple;
</span><span class="boring">fn example&lt;'py&gt;(py: Python&lt;'py&gt;) -&gt; PyResult&lt;()&gt; {
</span>// åˆ›å»ºä¸€ä¸ªæ–°çš„ Python `tuple`ï¼Œå¹¶ä½¿ç”¨ `.into_any()` æ“¦é™¤ç±»å‹
let obj: Bound&lt;'py, PyAny&gt; = PyTuple::empty(py).into_any();


// ä½¿ç”¨ `.cast()` è½¬æ¢ä¸º `PyTuple`ï¼Œä¸è½¬ç§»æ‰€æœ‰æƒ
let _: &amp;Bound&lt;'py, PyTuple&gt; = obj.cast()?;


// ä½¿ç”¨ `.cast_into()` è½¬æ¢ä¸º `PyTuple`ï¼Œå¹¶è½¬ç§»æ‰€æœ‰æƒ
let _: Bound&lt;'py, PyTuple&gt; = obj.cast_into()?;
<span class="boring">Ok(())
</span><span class="boring">}
</span><span class="boring">Python::attach(example).unwrap()</span></code></pre>
<p>è‡ªå®šä¹‰çš„ <a href="#python-ç±»"><code>#[pyclass]</code></a> ç±»å‹ä¹Ÿå®ç°äº† <a href="{{#PYO3_DOCS_URL}}/pyo3/type_object/trait.PyTypeCheck.html"><code>PyTypeCheck</code></a>ï¼Œå› æ­¤ <code>.cast()</code> åŒæ ·é€‚ç”¨äºè¿™äº›ç±»å‹ã€‚ä»¥ä¸‹ä»£ç æ®µä¸ä¸Šæ–¹ç±»ä¼¼ï¼Œä½†è½¬æ¢ä¸ºè‡ªå®šä¹‰ç±»å‹ <code>MyClass</code>ï¼š</p>
<pre><code class="language-rust">use pyo3::prelude::*;


#[pyclass]
struct MyClass {}


<span class="boring">fn example&lt;'py&gt;(py: Python&lt;'py&gt;) -&gt; PyResult&lt;()&gt; {
</span>// åˆ›å»ºä¸€ä¸ªæ–°çš„ `MyClass` å®ä¾‹ï¼Œå¹¶ä½¿ç”¨ `.into_any()` æ“¦é™¤ç±»å‹
let obj: Bound&lt;'py, PyAny&gt; = Bound::new(py, MyClass {})?.into_any();


// ä½¿ç”¨ `.cast()` è½¬æ¢ä¸º `MyClass`ï¼Œä¸è½¬ç§»æ‰€æœ‰æƒ
let _: &amp;Bound&lt;'py, MyClass&gt; = obj.cast()?;


// ä½¿ç”¨ `.cast_into()` è½¬æ¢ä¸º `MyClass`ï¼Œå¹¶è½¬ç§»æ‰€æœ‰æƒ
let _: Bound&lt;'py, MyClass&gt; = obj.cast_into()?;
<span class="boring">Ok(())
</span><span class="boring">}
</span><span class="boring">Python::attach(example).unwrap()</span></code></pre>
<h3 id="ä»-python-å¯¹è±¡ä¸­æå–-rust-æ•°æ®"><a class="header" href="#ä»-python-å¯¹è±¡ä¸­æå–-rust-æ•°æ®">ä» Python å¯¹è±¡ä¸­æå– Rust æ•°æ®</a></h3>
<p>è‹¥è¦ä» Python å¯¹è±¡ä¸­æå– Rust æ•°æ®ï¼Œè¯·ä½¿ç”¨ <a href="{{#PYO3_DOCS_URL}}/pyo3/types/trait.PyAnyMethods.html#tymethod.extract"><code>.extract()</code></a> è€Œä¸æ˜¯ <code>.cast()</code>ã€‚æ­¤æ–¹æ³•é€‚ç”¨äºæ‰€æœ‰å®ç°äº† <a href="{{#PYO3_DOCS_URL}}/pyo3/conversion/trait.FromPyObject.html"><code>FromPyObject</code></a> trait çš„ç±»å‹ã€‚</p>
<p>ä¾‹å¦‚ï¼Œä»¥ä¸‹ä»£ç æ®µä» Python å…ƒç»„ä¸­æå–ä¸€ä¸ª Rust æ•´æ•°å…ƒç»„ï¼š</p>
<pre><code class="language-rust"><span class="boring">use pyo3::prelude::*;
</span><span class="boring">use pyo3::types::PyTuple;
</span><span class="boring">fn example&lt;'py&gt;(py: Python&lt;'py&gt;) -&gt; PyResult&lt;()&gt; {
</span>// åˆ›å»ºä¸€ä¸ªæ–°çš„ Python `tuple`ï¼Œå¹¶ä½¿ç”¨ `.into_any()` æ“¦é™¤ç±»å‹
let obj: Bound&lt;'py, PyAny&gt; = PyTuple::new(py, [1, 2, 3])?.into_any();


// ä» Python `tuple` æå–ä¸º Rust `(i32, i32, i32)` å…ƒç»„
let (x, y, z) = obj.extract::&lt;(i32, i32, i32)&gt;()?;
assert_eq!((x, y, z), (1, 2, 3));
<span class="boring">Ok(())
</span><span class="boring">}
</span><span class="boring">Python::attach(example).unwrap()</span></code></pre>
<p>ä¸ºé¿å…æ•°æ®æ‹·è´ï¼Œ<a href="#python-ç±»"><code>#[pyclass]</code></a> ç±»å‹å¯ä»¥ç›´æ¥å¼•ç”¨å­˜å‚¨åœ¨ Python å¯¹è±¡ä¸­çš„ Rust æ•°æ®ï¼Œè€Œæ— éœ€è°ƒç”¨ <code>.extract()</code>ã€‚æ›´å¤šç»†èŠ‚è¯·å‚è§<a href="#bound-and-interior-mutability">æŒ‡å—ä¸­ç±»éƒ¨åˆ†çš„ç›¸å…³æ–‡æ¡£</a>ã€‚</p>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="python-å¼‚å¸¸"><a class="header" href="#python-å¼‚å¸¸">Python å¼‚å¸¸</a></h1>
<h2 id="å®šä¹‰æ–°å¼‚å¸¸"><a class="header" href="#å®šä¹‰æ–°å¼‚å¸¸">å®šä¹‰æ–°å¼‚å¸¸</a></h2>
<p>ä½¿ç”¨ <a href="{{#PYO3_DOCS_URL}}/pyo3/macro.create_exception.html"><code>create_exception!</code></a> å®ï¼š</p>
<pre><code class="language-rust">use pyo3::create_exception;


create_exception!(module, MyError, pyo3::exceptions::PyException);</code></pre>
<ul>
<li><code>module</code> æ˜¯åŒ…å«è¯¥å¼‚å¸¸çš„æ¨¡å—åç§°ã€‚</li>
<li><code>MyError</code> æ˜¯æ–°å¼‚å¸¸ç±»å‹çš„åç§°ã€‚</li>
</ul>
<p>ä¾‹å¦‚ï¼š</p>
<pre><code class="language-rust">use pyo3::prelude::*;
use pyo3::create_exception;
use pyo3::types::IntoPyDict;
use pyo3::exceptions::PyException;


create_exception!(mymodule, CustomError, PyException);


<span class="boring">fn main() -&gt; PyResult&lt;()&gt; {
</span>Python::attach(|py| {
    let ctx = [("CustomError", py.get_type::&lt;CustomError&gt;())].into_py_dict(py)?;
    pyo3::py_run!(
        py,
        *ctx,
        "assert str(CustomError) == \"&lt;class 'mymodule.CustomError'&gt;\""
    );
    pyo3::py_run!(py, *ctx, "assert CustomError('oops').args == ('oops',)");
<span class="boring">  Ok(())
</span>})
<span class="boring">}</span></code></pre>
<p>å½“ä½¿ç”¨ PyO3 åˆ›å»ºæ‰©å±•æ¨¡å—æ—¶ï¼Œä½ å¯ä»¥å°†æ–°å¼‚å¸¸æ·»åŠ åˆ°æ¨¡å—ä¸­ï¼Œä½¿å…¶å¯ä»¥ä» Python ä¸­å¯¼å…¥ï¼š</p>
<pre><code class="language-rust no_run"><span class="boring">fn main() {}
</span>use pyo3::prelude::*;
use pyo3::exceptions::PyException;


pyo3::create_exception!(mymodule, CustomError, PyException);


#[pymodule]
mod mymodule {
    #[pymodule_export]
    use super::CustomError;


    // ... å…¶ä»–æ·»åŠ åˆ°æ¨¡å—çš„å…ƒç´  ...
}</code></pre>
<h2 id="æŠ›å‡ºå¼‚å¸¸"><a class="header" href="#æŠ›å‡ºå¼‚å¸¸">æŠ›å‡ºå¼‚å¸¸</a></h2>
<p>å¦‚ <a href="#é”™è¯¯å¤„ç†">å‡½æ•°é”™è¯¯å¤„ç†</a> ä¸€ç« æ‰€è¿°ï¼Œä» <code>#[pyfunction]</code> æˆ– <code>#[pymethods]</code> ä¸­æŠ›å‡ºå¼‚å¸¸ï¼Œåªéœ€è¿”å› <code>Err(PyErr)</code>ã€‚PyO3 åœ¨å°†ç»“æœè¿”å›ç»™ Python æ—¶ä¼šè‡ªåŠ¨ä¸ºä½ æŠ›å‡ºè¯¥å¼‚å¸¸ã€‚</p>
<p>ä½ ä¹Ÿå¯ä»¥æ‰‹åŠ¨åœ¨ Python è§£é‡Šå™¨çš„å…¨å±€çŠ¶æ€ä¸­å†™å…¥å’Œè·å–é”™è¯¯ï¼š</p>
<pre><code class="language-rust">use pyo3::{Python, PyErr};
use pyo3::exceptions::PyTypeError;


Python::attach(|py| {
    PyTypeError::new_err("Error").restore(py);
    assert!(PyErr::occurred(py));
    drop(PyErr::fetch(py));
});</code></pre>
<h2 id="æ£€æŸ¥å¼‚å¸¸ç±»å‹"><a class="header" href="#æ£€æŸ¥å¼‚å¸¸ç±»å‹">æ£€æŸ¥å¼‚å¸¸ç±»å‹</a></h2>
<p>Python æä¾›äº† <a href="https://docs.python.org/3/library/functions.html#isinstance"><code>isinstance</code></a> æ–¹æ³•æ¥æ£€æŸ¥å¯¹è±¡çš„ç±»å‹ã€‚
åœ¨ PyO3 ä¸­ï¼Œæ¯ä¸ªå¯¹è±¡éƒ½æœ‰ <a href="{{#PYO3_DOCS_URL}}/pyo3/types/trait.PyAnyMethods.html#tymethod.is_instance"><code>PyAny::is_instance</code></a> å’Œ <a href="{{#PYO3_DOCS_URL}}/pyo3/types/trait.PyAnyMethods.html#tymethod.is_instance_of"><code>PyAny::is_instance_of</code></a> æ–¹æ³•ï¼ŒåŠŸèƒ½ç›¸åŒã€‚</p>
<pre><code class="language-rust no_run">use pyo3::prelude::*;
use pyo3::types::{PyBool, PyList};


<span class="boring">fn main() -&gt; PyResult&lt;()&gt; {
</span>Python::attach(|py| {
    assert!(PyBool::new(py, true).is_instance_of::&lt;PyBool&gt;());
    let list = PyList::new(py, &amp;[1, 2, 3, 4])?;
    assert!(!list.is_instance_of::&lt;PyBool&gt;());
    assert!(list.is_instance_of::&lt;PyList&gt;());
<span class="boring">Ok(())
</span>})
<span class="boring">}</span></code></pre>
<p>è¦æ£€æŸ¥å¼‚å¸¸çš„ç±»å‹ï¼ŒåŒæ ·å¯ä»¥è¿™æ ·åšï¼š</p>
<pre><code class="language-rust no_run"><span class="boring">use pyo3::exceptions::PyTypeError;
</span><span class="boring">use pyo3::prelude::*;
</span><span class="boring">Python::attach(|py| {
</span><span class="boring">let err = PyTypeError::new_err(());
</span>err.is_instance_of::&lt;PyTypeError&gt;(py);
<span class="boring">});</span></code></pre>
<h2 id="ä½¿ç”¨-python-ä»£ç ä¸­å®šä¹‰çš„å¼‚å¸¸"><a class="header" href="#ä½¿ç”¨-python-ä»£ç ä¸­å®šä¹‰çš„å¼‚å¸¸">ä½¿ç”¨ Python ä»£ç ä¸­å®šä¹‰çš„å¼‚å¸¸</a></h2>
<p>å¯ä»¥å°† Python ä»£ç ä¸­å®šä¹‰çš„å¼‚å¸¸ä½œä¸ºåŸç”Ÿ Rust ç±»å‹ä½¿ç”¨ã€‚
<a href="{{#PYO3_DOCS_URL}}/pyo3/macro.import_exception.html"><code>import_exception!</code></a> å®å…è®¸å¯¼å…¥ç‰¹å®šçš„å¼‚å¸¸ç±»ï¼Œå¹¶ä¸ºè¯¥å¼‚å¸¸å®šä¹‰ä¸€ä¸ª Rust ç±»å‹ã€‚</p>
<pre><code class="language-rust no_run">#![allow(dead_code)]
use pyo3::prelude::*;


mod io {
    pyo3::import_exception!(io, UnsupportedOperation);
}


fn tell(file: &amp;Bound&lt;'_, PyAny&gt;) -&gt; PyResult&lt;u64&gt; {
    match file.call_method0("tell") {
        Err(_) =&gt; Err(io::UnsupportedOperation::new_err("not supported: tell")),
        Ok(x) =&gt; x.extract::&lt;u64&gt;(),
    }
}</code></pre>
<p><a href="{{#PYO3_DOCS_URL}}/pyo3/exceptions/index.html"><code>pyo3::exceptions</code></a>
ä¸ºå¤šä¸ªæ ‡å‡†åº“æ¨¡å—å®šä¹‰äº†å¼‚å¸¸ã€‚</p>
<h2 id="åˆ›å»ºæ›´å¤æ‚çš„å¼‚å¸¸"><a class="header" href="#åˆ›å»ºæ›´å¤æ‚çš„å¼‚å¸¸">åˆ›å»ºæ›´å¤æ‚çš„å¼‚å¸¸</a></h2>
<p>å¦‚æœéœ€è¦åˆ›å»ºå…·æœ‰æ›´å¤æ‚è¡Œä¸ºçš„å¼‚å¸¸ï¼Œä¹Ÿå¯ä»¥æ‰‹åŠ¨åˆ›å»º <code>PyException</code> çš„å­ç±»ï¼š</p>
<pre><code class="language-rust">#![allow(dead_code)]
<span class="boring">#[cfg(any(not(feature = "abi3")))] {
</span>use pyo3::prelude::*;
use pyo3::types::IntoPyDict;
use pyo3::exceptions::PyException;


#[pyclass(extends=PyException)]
struct CustomError {
    #[pyo3(get)]
    url: String,


    #[pyo3(get)]
    message: String,
}


#[pymethods]
impl CustomError {
    #[new]
    fn new(url: String, message: String) -&gt; Self {
        Self { url, message }
    }
}


<span class="boring">fn main() -&gt; PyResult&lt;()&gt; {
</span>Python::attach(|py| {
    let ctx = [("CustomError", py.get_type::&lt;CustomError&gt;())].into_py_dict(py)?;
    pyo3::py_run!(
        py,
        *ctx,
        "assert str(CustomError) == \"&lt;class 'builtins.CustomError'&gt;\", repr(CustomError)"
    );
    pyo3::py_run!(py, *ctx, "assert CustomError('https://example.com', 'something went bad').args == ('https://example.com', 'something went bad')");
    pyo3::py_run!(py, *ctx, "assert CustomError('https://example.com', 'something went bad').url == 'https://example.com'");
<span class="boring">  Ok(())
</span>})
<span class="boring">}
</span><span class="boring">}</span></code></pre>
<p>è¯·æ³¨æ„ï¼Œå½“å¯ç”¨ <code>abi3</code> åŠŸèƒ½æ—¶ï¼Œè¿™æ˜¯ä¸å¯èƒ½çš„ï¼Œå› ä¸ºå®ƒé˜»æ­¢äº†å¯¹ <code>PyException</code> çš„å­ç±»åŒ–ã€‚</p>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="è°ƒç”¨-python-å‡½æ•°"><a class="header" href="#è°ƒç”¨-python-å‡½æ•°">è°ƒç”¨ Python å‡½æ•°</a></h1>
<p><code>Bound&lt;'py, T&gt;</code> æ™ºèƒ½æŒ‡é’ˆï¼ˆä¾‹å¦‚ <code>Bound&lt;'py, PyAny&gt;</code>ã€<code>Bound&lt;'py, PyList&gt;</code> æˆ– <code>Bound&lt;'py, MyClass&gt;</code>ï¼‰å¯ç”¨äºè°ƒç”¨ Python å‡½æ•°ã€‚</p>
<p>PyO3 æä¾›äº†ä¸¤ä¸ª API æ¥è¿›è¡Œå‡½æ•°è°ƒç”¨ï¼š</p>
<ul>
<li><a href="python-from-rust/{{#PYO3_DOCS_URL}}/pyo3/types/trait.PyAnyMethods.html#tymethod.call"><code>call</code></a> â€” è°ƒç”¨ä»»æ„å¯è°ƒç”¨çš„ Python å¯¹è±¡ã€‚</li>
<li><a href="python-from-rust/{{#PYO3_DOCS_URL}}/pyo3/types/trait.PyAnyMethods.html#tymethod.call_method"><code>call_method</code></a> â€” è°ƒç”¨ Python å¯¹è±¡ä¸Šçš„æ–¹æ³•ã€‚</li>
</ul>
<p>è¿™ä¸¤ä¸ª API éƒ½æ¥å— <code>args</code> å’Œ <code>kwargs</code> å‚æ•°ï¼ˆåˆ†åˆ«ç”¨äºä½ç½®å‚æ•°å’Œå…³é”®å­—å‚æ•°ï¼‰ã€‚é’ˆå¯¹è¾ƒç®€å•è°ƒç”¨åœºæ™¯è¿˜æä¾›äº†ç®€åŒ–ç‰ˆæœ¬ï¼š</p>
<ul>
<li><a href="python-from-rust/{{#PYO3_DOCS_URL}}/pyo3/types/trait.PyAnyMethods.html#tymethod.call1"><code>call1</code></a> å’Œ <a href="python-from-rust/{{#PYO3_DOCS_URL}}/pyo3/types/trait.PyAnyMethods.html#tymethod.call_method1"><code>call_method1</code></a> â€” ä»…ä½¿ç”¨ä½ç½®å‚æ•° <code>args</code> è¿›è¡Œè°ƒç”¨ã€‚</li>
<li><a href="python-from-rust/{{#PYO3_DOCS_URL}}/pyo3/types/trait.PyAnyMethods.html#tymethod.call0"><code>call0</code></a> å’Œ <a href="python-from-rust/{{#PYO3_DOCS_URL}}/pyo3/types/trait.PyAnyMethods.html#tymethod.call_method0"><code>call_method0</code></a> â€” ä¸å¸¦ä»»ä½•å‚æ•°è¿›è¡Œè°ƒç”¨ã€‚</li>
</ul>
<p>ä¸ºäº†æ–¹ä¾¿èµ·è§ï¼Œ<a href="#pyt"><code>Py&lt;T&gt;</code></a> æ™ºèƒ½æŒ‡é’ˆä¹Ÿæš´éœ²äº†è¿™å…­ä¸ªç›¸åŒçš„ API æ–¹æ³•ï¼Œä½†éœ€è¦ä¸€ä¸ªé¢å¤–çš„ <code>Python</code> ä»¤ç‰Œä½œä¸ºç¬¬ä¸€ä¸ªå‚æ•°ï¼Œä»¥è¯æ˜å½“å‰çº¿ç¨‹å·²é™„åŠ åˆ° Python è§£é‡Šå™¨ã€‚</p>
<p>ä»¥ä¸‹ç¤ºä¾‹å±•ç¤ºäº†å¦‚ä½•é€šè¿‡ <code>Py&lt;PyAny&gt;</code> å¼•ç”¨è°ƒç”¨ Python å‡½æ•°ï¼š</p>
<pre><code class="language-rust">use pyo3::prelude::*;
use pyo3::types::PyTuple;
use pyo3_ffi::c_str;


fn main() -&gt; PyResult&lt;()&gt; {
    let arg1 = "arg1";
    let arg2 = "arg2";
    let arg3 = "arg3";


    Python::attach(|py| {
        let fun: Py&lt;PyAny&gt; = PyModule::from_code(
            py,
            c_str!("def example(*args, **kwargs):
                if args != ():
                    print('called with args', args)
                if kwargs != {}:
                    print('called with kwargs', kwargs)
                if args == () and kwargs == {}:
                    print('called with no arguments')"),
            c_str!("example.py"),
            c_str!(""),
        )?
        .getattr("example")?
        .into();


        // è°ƒç”¨æ— å‚å‡½æ•°
        fun.call0(py)?;


        // ä½¿ç”¨åŒ…å«ä½ç½®å‚æ•°çš„ Rust å…ƒç»„è°ƒç”¨
        let args = (arg1, arg2, arg3);
        fun.call1(py, args)?;


        // ä½¿ç”¨ Python å…ƒç»„ä½œä¸ºä½ç½®å‚æ•°è°ƒç”¨
        let args = PyTuple::new(py, &amp;[arg1, arg2, arg3])?;
        fun.call1(py, args)?;
        Ok(())
    })
}</code></pre>
<h2 id="åˆ›å»ºå…³é”®å­—å‚æ•°"><a class="header" href="#åˆ›å»ºå…³é”®å­—å‚æ•°">åˆ›å»ºå…³é”®å­—å‚æ•°</a></h2>
<p>å¯¹äº <code>call</code> å’Œ <code>call_method</code> APIï¼Œ<code>kwargs</code> çš„ç±»å‹æ˜¯ <code>Option&lt;&amp;Bound&lt;'py, PyDict&gt;&gt;</code>ï¼Œå› æ­¤å¯ä»¥æ˜¯ <code>None</code> æˆ– <code>Some(&amp;dict)</code>ã€‚ä½ å¯ä»¥ä½¿ç”¨ <a href="python-from-rust/{{#PYO3_DOCS_URL}}/pyo3/types/trait.IntoPyDict.html"><code>IntoPyDict</code></a> trait å°†å…¶ä»–ç±»å­—å…¸å®¹å™¨ï¼ˆå¦‚ <code>HashMap</code> æˆ– <code>BTreeMap</code>ï¼‰è½¬æ¢ä¸º Python å­—å…¸ï¼Œä¹Ÿæ”¯æŒæœ€å¤š 10 ä¸ªå…ƒç´ çš„å…ƒç»„ä»¥åŠæ¯ä¸ªå…ƒç´ ä¸ºäºŒå…ƒç»„çš„ <code>Vec</code>ã€‚è‹¥è¦ä¼ é€’ä¸åŒç±»å‹çš„å…³é”®å­—å‚æ•°ï¼Œå»ºè®®ç›´æ¥æ„é€ ä¸€ä¸ª <code>PyDict</code> å¯¹è±¡ã€‚</p>
<pre><code class="language-rust">use pyo3::prelude::*;
use pyo3::types::{PyDict, IntoPyDict};
use std::collections::HashMap;
use pyo3::ffi::c_str;


fn main() -&gt; PyResult&lt;()&gt; {
    let key1 = "key1";
    let val1 = 1;
    let key2 = "key2";
    let val2 = 2;


    Python::attach(|py| {
        let fun: Py&lt;PyAny&gt; = PyModule::from_code(
            py,
            c_str!("def example(*args, **kwargs):
                if args != ():
                    print('called with args', args)
                if kwargs != {}:
                    print('called with kwargs', kwargs)
                if args == () and kwargs == {}:
                    print('called with no arguments')"),
            c_str!("example.py"),
            c_str!(""),
        )?
        .getattr("example")?
        .into();


        // ä½¿ç”¨ PyDict ä¼ é€’å…³é”®å­—å‚æ•°
        let kwargs = [(key1, val1)].into_py_dict(py)?;
        fun.call(py, (), Some(&amp;kwargs))?;


        // ä»¥ Vec å½¢å¼ä¼ é€’å‚æ•°
        let kwargs = vec![(key1, val1), (key2, val2)];
        fun.call(py, (), Some(&amp;kwargs.into_py_dict(py)?))?;


        // ä»¥ HashMap å½¢å¼ä¼ é€’å‚æ•°
        let mut kwargs = HashMap::&lt;&amp;str, i32&gt;::new();
        kwargs.insert(key1, 1);
        fun.call(py, (), Some(&amp;kwargs.into_py_dict(py)?))?;


        // ä½¿ç”¨ PyDict ä¼ é€’ä¸åŒç±»å‹çš„å…³é”®å­—å‚æ•°
        let kwargs = PyDict::new(py);
        kwargs.set_item(key1, val1)?;
        kwargs.set_item(key2, "string")?;
        fun.call(py, (), Some(&amp;kwargs))?;


        Ok(())
    })
}</code></pre>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="æ‰§è¡Œç°æœ‰çš„-python-ä»£ç "><a class="header" href="#æ‰§è¡Œç°æœ‰çš„-python-ä»£ç ">æ‰§è¡Œç°æœ‰çš„ Python ä»£ç </a></h1>
<p>å¦‚æœä½ å·²ç»æœ‰ä¸€äº›éœ€è¦ä» Rust ä¸­æ‰§è¡Œçš„ç°æœ‰ Python ä»£ç ï¼Œä»¥ä¸‹å¸¸è§é—®é¢˜è§£ç­”å¯ä»¥å¸®åŠ©ä½ æ ¹æ®å…·ä½“æƒ…å†µé€‰æ‹©åˆé€‚çš„ PyO3 åŠŸèƒ½ï¼š</p>
<h2 id="æƒ³è¦è®¿é—®-python-apiä½¿ç”¨-pymoduleimport"><a class="header" href="#æƒ³è¦è®¿é—®-python-apiä½¿ç”¨-pymoduleimport">æƒ³è¦è®¿é—® Python APIï¼Ÿä½¿ç”¨ <code>PyModule::import</code></a></h2>
<p><a href="python-from-rust/{{#PYO3_DOCS_URL}}/pyo3/types/struct.PyModule.html#method.import"><code>PyModule::import</code></a> å¯ç”¨äºä» Rust è·å– Python æ¨¡å—çš„å¥æŸ„ã€‚ä½ å¯ä»¥ä½¿ç”¨å®ƒæ¥å¯¼å…¥å¹¶ä½¿ç”¨ç¯å¢ƒä¸­å¯ç”¨çš„ä»»ä½• Python æ¨¡å—ã€‚</p>
<pre><code class="language-rust">use pyo3::prelude::*;

fn main() -&gt; PyResult&lt;()&gt; {
    Python::attach(|py| {
        let builtins = PyModule::import(py, "builtins")?;
        let total: i32 = builtins
            .getattr("sum")?
            .call1((vec![1, 2, 3],))?
            .extract()?;
        assert_eq!(total, 6);
        Ok(())
    })
}</code></pre>
<h2 id="åªæƒ³è¿è¡Œä¸€ä¸ªè¡¨è¾¾å¼ä½¿ç”¨-eval"><a class="header" href="#åªæƒ³è¿è¡Œä¸€ä¸ªè¡¨è¾¾å¼ä½¿ç”¨-eval">åªæƒ³è¿è¡Œä¸€ä¸ªè¡¨è¾¾å¼ï¼Ÿä½¿ç”¨ <code>eval</code></a></h2>
<p><a href="python-from-rust/{{#PYO3_DOCS_URL}}/pyo3/marker/struct.Python.html#method.eval"><code>Python::eval</code></a> æ˜¯æ‰§è¡Œ <a href="https://docs.python.org/3/reference/expressions.html">Python è¡¨è¾¾å¼</a> å¹¶å°†è®¡ç®—ç»“æœä½œä¸º <code>Bound&lt;'py, PyAny&gt;</code> å¯¹è±¡è¿”å›çš„æ–¹æ³•ã€‚</p>
<pre><code class="language-rust">use pyo3::prelude::*;
use pyo3::ffi::c_str;

<span class="boring">fn main() -&gt; Result&lt;(), ()&gt; {
</span>Python::attach(|py| {
    let result = py
        .eval(c_str!("[i * 10 for i in range(5)]"), None, None)
        .map_err(|e| {
            e.print_and_set_sys_last_vars(py);
        })?;
    let res: Vec&lt;i64&gt; = result.extract().unwrap();
    assert_eq!(res, vec![0, 10, 20, 30, 40]);
    Ok(())
})
<span class="boring">}</span></code></pre>
<h2 id="æƒ³è¦è¿è¡Œè¯­å¥ä½¿ç”¨-run"><a class="header" href="#æƒ³è¦è¿è¡Œè¯­å¥ä½¿ç”¨-run">æƒ³è¦è¿è¡Œè¯­å¥ï¼Ÿä½¿ç”¨ <code>run</code></a></h2>
<p><a href="python-from-rust/{{#PYO3_DOCS_URL}}/pyo3/marker/struct.Python.html#method.run"><code>Python::run</code></a> æ˜¯æ‰§è¡Œä¸€ä¸ªæˆ–å¤šä¸ª <a href="https://docs.python.org/3/reference/simple_stmts.html">Python è¯­å¥</a> çš„æ–¹æ³•ã€‚è¯¥æ–¹æ³•ä¸è¿”å›ä»»ä½•å€¼ï¼ˆå¦‚åŒä»»ä½• Python è¯­å¥ä¸€æ ·ï¼‰ï¼Œä½†ä½ å¯ä»¥é€šè¿‡ <code>locals</code> å­—å…¸è®¿é—®è¢«æ“ä½œçš„å¯¹è±¡ã€‚</p>
<p>ä½ ä¹Ÿå¯ä»¥ä½¿ç”¨ <a href="python-from-rust/{{#PYO3_DOCS_URL}}/pyo3/macro.py_run.html"><code>py_run!</code></a> å®ï¼Œå®ƒæ˜¯ <a href="python-from-rust/{{#PYO3_DOCS_URL}}/pyo3/marker/struct.Python.html#method.run"><code>Python::run</code></a> çš„ç®€å†™å½¢å¼ã€‚ç”±äº <a href="python-from-rust/{{#PYO3_DOCS_URL}}/pyo3/macro.py_run.html"><code>py_run!</code></a> åœ¨å‘ç”Ÿå¼‚å¸¸æ—¶ä¼š panicï¼Œæˆ‘ä»¬å»ºè®®ä»…åœ¨å¿«é€Ÿæµ‹è¯• Python æ‰©å±•æ—¶ä½¿ç”¨æ­¤å®ã€‚</p>
<pre><code class="language-rust">use pyo3::prelude::*;
use pyo3::py_run;

<span class="boring">fn main() {
</span>#[pyclass]
struct UserData {
    id: u32,
    name: String,
}

#[pymethods]
impl UserData {
    fn as_tuple(&amp;self) -&gt; (u32, String) {
        (self.id, self.name.clone())
    }

    fn __repr__(&amp;self) -&gt; PyResult&lt;String&gt; {
        Ok(format!("User {}(id: {})", self.name, self.id))
    }
}

Python::attach(|py| {
    let userdata = UserData {
        id: 34,
        name: "Yu".to_string(),
    };
    let userdata = Py::new(py, userdata).unwrap();
    let userdata_as_tuple = (34, "Yu");
    py_run!(py, userdata userdata_as_tuple, r#"
assert repr(userdata) == "User Yu(id: 34)"
assert userdata.as_tuple() == userdata_as_tuple
    "#);
})
<span class="boring">}</span></code></pre>
<h2 id="ä½ æœ‰ä¸€ä¸ª-python-æ–‡ä»¶æˆ–ä»£ç ç‰‡æ®µä½¿ç”¨-pymodulefrom_code"><a class="header" href="#ä½ æœ‰ä¸€ä¸ª-python-æ–‡ä»¶æˆ–ä»£ç ç‰‡æ®µä½¿ç”¨-pymodulefrom_code">ä½ æœ‰ä¸€ä¸ª Python æ–‡ä»¶æˆ–ä»£ç ç‰‡æ®µï¼Ÿä½¿ç”¨ <code>PyModule::from_code</code></a></h2>
<p><a href="python-from-rust/{{#PYO3_DOCS_URL}}/pyo3/types/struct.PyModule.html#method.from_code"><code>PyModule::from_code</code></a> å¯ç”¨äºç”Ÿæˆä¸€ä¸ª Python æ¨¡å—ï¼Œç„¶åå¯ä»¥åƒé€šè¿‡ <code>PyModule::import</code> å¯¼å…¥ä¸€æ ·ä½¿ç”¨å®ƒã€‚</p>
<p><strong>è­¦å‘Š</strong>ï¼šè¿™å°†ç¼–è¯‘å¹¶æ‰§è¡Œä»£ç ã€‚<strong>åˆ‡å‹¿</strong>å‘æ­¤å‡½æ•°ä¼ é€’ä¸å¯ä¿¡çš„ä»£ç ï¼</p>
<pre><code class="language-rust">use pyo3::{prelude::*, types::IntoPyDict};
use pyo3_ffi::c_str;

<span class="boring">fn main() -&gt; PyResult&lt;()&gt; {
</span>Python::attach(|py| {
    let activators = PyModule::from_code(
        py,
        c_str!(r#"
def relu(x):
    """see https://en.wikipedia.org/wiki/Rectifier_(neural_networks)"""
    return max(0.0, x)

def leaky_relu(x, slope=0.01):
    return x if x &gt;= 0 else x * slope
    "#),
        c_str!("activators.py"),
        c_str!("activators"),
    )?;

    let relu_result: f64 = activators.getattr("relu")?.call1((-1.0,))?.extract()?;
    assert_eq!(relu_result, 0.0);

    let kwargs = [("slope", 0.2)].into_py_dict(py)?;
    let lrelu_result: f64 = activators
        .getattr("leaky_relu")?
        .call((-1.0,), Some(&amp;kwargs))?
        .extract()?;
    assert_eq!(lrelu_result, -0.2);
<span class="boring">   Ok(())
</span>})
<span class="boring">}</span></code></pre>
<h2 id="æƒ³è¦åœ¨-rust-ä¸­åµŒå…¥-python-å¹¶æ·»åŠ é¢å¤–æ¨¡å—"><a class="header" href="#æƒ³è¦åœ¨-rust-ä¸­åµŒå…¥-python-å¹¶æ·»åŠ é¢å¤–æ¨¡å—">æƒ³è¦åœ¨ Rust ä¸­åµŒå…¥ Python å¹¶æ·»åŠ é¢å¤–æ¨¡å—ï¼Ÿ</a></h2>
<p>Python ä½¿ç”¨ <code>sys.modules</code> å­—å…¸ç¼“å­˜æ‰€æœ‰å·²å¯¼å…¥çš„æ¨¡å—ã€‚Python ä¸­çš„å¯¼å…¥æ“ä½œé¦–å…ˆå°è¯•ä»æ­¤å­—å…¸ä¸­æŸ¥æ‰¾æ¨¡å—ï¼Œå¦‚æœæœªæ‰¾åˆ°ï¼Œåˆ™ä½¿ç”¨å¤šç§ç­–ç•¥å°è¯•å®šä½å¹¶åŠ è½½æ¨¡å—ã€‚</p>
<p><a href="python-from-rust/{{#PYO3_DOCS_URL}}/pyo3/macro.append_to_inittab.html"><code>append_to_inittab</code></a> å®å¯ç”¨äºå‘åµŒå…¥å¼ Python è§£é‡Šå™¨æ·»åŠ é¢å¤–çš„ <code>#[pymodule]</code> æ¨¡å—ã€‚è¯¥å® <strong>å¿…é¡»</strong> åœ¨åˆå§‹åŒ– Python <strong>ä¹‹å‰</strong> è°ƒç”¨ã€‚</p>
<p>ä¾‹å¦‚ï¼Œä»¥ä¸‹ä»£ç å°†æ¨¡å— <code>foo</code> æ·»åŠ åˆ°åµŒå…¥å¼è§£é‡Šå™¨ä¸­ï¼š</p>
<pre><code class="language-rust">use pyo3::prelude::*;
use pyo3::ffi::c_str;

#[pymodule]
mod foo {
    use pyo3::prelude::*;

    #[pyfunction]
    fn add_one(x: i64) -&gt; i64 {
        x + 1
    }
}

fn main() -&gt; PyResult&lt;()&gt; {
    pyo3::append_to_inittab!(foo);
    Python::attach(|py| Python::run(py, c_str!("import foo; foo.add_one(6)"), None, None))
}</code></pre>
<p>å¦‚æœç”±äºç¨‹åºé™åˆ¶æ— æ³•ä½¿ç”¨ <code>append_to_inittab</code>ï¼Œå¦ä¸€ç§é€‰æ‹©æ˜¯ä½¿ç”¨ <a href="python-from-rust/{{#PYO3_DOCS_URL}}/pyo3/types/struct.PyModule.html#method.new"><code>PyModule::new</code></a> åˆ›å»ºæ¨¡å—ï¼Œå¹¶æ‰‹åŠ¨å°†å…¶æ’å…¥åˆ° <code>sys.modules</code> ä¸­ï¼š</p>
<pre><code class="language-rust">use pyo3::prelude::*;
use pyo3::types::PyDict;
use pyo3::ffi::c_str;

#[pyfunction]
pub fn add_one(x: i64) -&gt; i64 {
    x + 1
}

fn main() -&gt; PyResult&lt;()&gt; {
    Python::attach(|py| {
        // åˆ›å»ºæ–°æ¨¡å—
        let foo_module = PyModule::new(py, "foo")?;
        foo_module.add_function(wrap_pyfunction!(add_one, &amp;foo_module)?)?;

        // å¯¼å…¥å¹¶è·å– sys.modules
        let sys = PyModule::import(py, "sys")?;
        let py_modules: Bound&lt;'_, PyDict&gt; = sys.getattr("modules")?.cast_into()?;

        // å°† foo æ’å…¥ sys.modules
        py_modules.set_item("foo", foo_module)?;

        // ç°åœ¨å¯ä»¥å¯¼å…¥å¹¶è¿è¡Œ Python ä»£ç 
        Python::run(py, c_str!("import foo; foo.add_one(6)"), None, None)
    })
}</code></pre>
<h2 id="åŒ…å«å¤šä¸ª-python-æ–‡ä»¶"><a class="header" href="#åŒ…å«å¤šä¸ª-python-æ–‡ä»¶">åŒ…å«å¤šä¸ª Python æ–‡ä»¶</a></h2>
<p>ä½ å¯ä»¥ä½¿ç”¨ <a href="https://doc.rust-lang.org/std/macro.include_str.html"><code>std::include_str</code></a> å®åœ¨ç¼–è¯‘æ—¶åŒ…å«æ–‡ä»¶ã€‚</p>
<p>ä¹Ÿå¯ä»¥ä½¿ç”¨ <a href="https://doc.rust-lang.org/std/fs/fn.read_to_string.html"><code>std::fs::read_to_string</code></a> å‡½æ•°åœ¨è¿è¡Œæ—¶åŠ è½½æ–‡ä»¶ã€‚</p>
<p>å¯ä»¥åŒ…å«å’ŒåŠ è½½å¤šä¸ª Python æ–‡ä»¶ã€‚å¦‚æœä¸€ä¸ªæ–‡ä»¶ä¾èµ–å¦ä¸€ä¸ªæ–‡ä»¶ï¼Œåˆ™åœ¨å£°æ˜ <code>PyModule</code> æ—¶å¿…é¡»ä¿æŒæ­£ç¡®çš„é¡ºåºã€‚</p>
<p>ç¤ºä¾‹ç›®å½•ç»“æ„ï¼š</p>
<pre><code class="language-text">.
â”œâ”€â”€ Cargo.lock
â”œâ”€â”€ Cargo.toml
â”œâ”€â”€ python_app
â”‚   â”œâ”€â”€ app.py
â”‚   â””â”€â”€ utils
â”‚       â””â”€â”€ foo.py
â””â”€â”€ src
    â””â”€â”€ main.rs
</code></pre>
<p><code>python_app/app.py</code>ï¼š</p>
<pre><code class="language-python">from utils.foo import bar

def run():
    return bar()
</code></pre>
<p><code>python_app/utils/foo.py</code>ï¼š</p>
<pre><code class="language-python">def bar():
    return "baz"
</code></pre>
<p>ä»¥ä¸‹ç¤ºä¾‹å±•ç¤ºï¼š</p>
<ul>
<li>å¦‚ä½•å°† <code>app.py</code> å’Œ <code>utils/foo.py</code> çš„å†…å®¹åŒ…å«åˆ°ä½ çš„ Rust äºŒè¿›åˆ¶æ–‡ä»¶ä¸­</li>
<li>å¦‚ä½•è°ƒç”¨åœ¨ <code>app.py</code> ä¸­å£°æ˜çš„ <code>run()</code> å‡½æ•°ï¼Œè¯¥å‡½æ•°éœ€è¦ä» <code>utils/foo.py</code> å¯¼å…¥çš„å‡½æ•°</li>
</ul>
<p><code>src/main.rs</code>ï¼š</p>
<pre><code class="language-rust ignore">use pyo3::prelude::*;
use pyo3_ffi::c_str;

fn main() -&gt; PyResult&lt;()&gt; {
    let py_foo = c_str!(include_str!(concat!(
        env!("CARGO_MANIFEST_DIR"),
        "/python_app/utils/foo.py"
    )));
    let py_app = c_str!(include_str!(concat!(env!("CARGO_MANIFEST_DIR"), "/python_app/app.py")));
    let from_python = Python::attach(|py| -&gt; PyResult&lt;Py&lt;PyAny&gt;&gt; {
        PyModule::from_code(py, py_foo, c_str!("foo.py"), c_str!("utils.foo"))?;
        let app: Py&lt;PyAny&gt; = PyModule::from_code(py, py_app, c_str!("app.py"), c_str!(""))?
            .getattr("run")?
            .into();
        app.call0(py)
    });

    println!("py: {}", from_python?);
    Ok(())
}</code></pre>
<p>ä»¥ä¸‹ç¤ºä¾‹å±•ç¤ºï¼š</p>
<ul>
<li>å¦‚ä½•åœ¨è¿è¡Œæ—¶åŠ è½½ <code>app.py</code> çš„å†…å®¹ï¼Œä½¿å…¶è‡ªåŠ¨è¯†åˆ«å…¶ä¾èµ–é¡¹</li>
<li>å¦‚ä½•è°ƒç”¨åœ¨ <code>app.py</code> ä¸­å£°æ˜çš„ <code>run()</code> å‡½æ•°ï¼Œè¯¥å‡½æ•°éœ€è¦ä» <code>utils/foo.py</code> å¯¼å…¥çš„å‡½æ•°</li>
</ul>
<p>å»ºè®®ä½¿ç”¨ç»å¯¹è·¯å¾„ï¼Œè¿™æ ·åªè¦ <code>app.py</code> åœ¨é¢„æœŸç›®å½•ä¸­ï¼ˆæœ¬ä¾‹ä¸­ä¸º <code>/usr/share/python_app</code>ï¼‰ï¼Œä½ çš„äºŒè¿›åˆ¶æ–‡ä»¶å°±å¯ä»¥ä»ä»»ä½•ä½ç½®è¿è¡Œã€‚</p>
<p><code>src/main.rs</code>ï¼š</p>
<pre><code class="language-rust no_run">use pyo3::prelude::*;
use pyo3::types::PyList;
use pyo3_ffi::c_str;
use std::fs;
use std::path::Path;
use std::ffi::CString;

fn main() -&gt; PyResult&lt;()&gt; {
    let path = Path::new("/usr/share/python_app");
    let py_app = CString::new(fs::read_to_string(path.join("app.py"))?)?;
    let from_python = Python::attach(|py| -&gt; PyResult&lt;Py&lt;PyAny&gt;&gt; {
        let syspath = py
            .import("sys")?
            .getattr("path")?
            .cast_into::&lt;PyList&gt;()?;
        syspath.insert(0, path)?;
        let app: Py&lt;PyAny&gt; = PyModule::from_code(py, py_app.as_c_str(), c_str!("app.py"), c_str!(""))?
            .getattr("run")?
            .into();
        app.call0(py)
    });

    println!("py: {}", from_python?);
    Ok(())
}</code></pre>
<h2 id="éœ€è¦ä»-rust-ä½¿ç”¨ä¸Šä¸‹æ–‡ç®¡ç†å™¨"><a class="header" href="#éœ€è¦ä»-rust-ä½¿ç”¨ä¸Šä¸‹æ–‡ç®¡ç†å™¨">éœ€è¦ä» Rust ä½¿ç”¨ä¸Šä¸‹æ–‡ç®¡ç†å™¨ï¼Ÿ</a></h2>
<p>ç›´æ¥è°ƒç”¨ <code>__enter__</code> å’Œ <code>__exit__</code> æ¥ä½¿ç”¨ä¸Šä¸‹æ–‡ç®¡ç†å™¨ã€‚</p>
<pre><code class="language-rust">use pyo3::prelude::*;
use pyo3::ffi::c_str;

fn main() {
    Python::attach(|py| {
        let custom_manager = PyModule::from_code(
            py,
            c_str!(r#"
class House(object):
    def __init__(self, address):
        self.address = address
    def __enter__(self):
        print(f"Welcome to {self.address}!")
    def __exit__(self, type, value, traceback):
        if type:
            print(f"Sorry you had {type} trouble at {self.address}")
        else:
            print(f"Thank you for visiting {self.address}, come again soon!")

        "#),
            c_str!("house.py"),
            c_str!("house"),
        )
        .unwrap();

        let house_class = custom_manager.getattr("House").unwrap();
        let house = house_class.call1(("123 Main Street",)).unwrap();

        house.call_method0("__enter__").unwrap();

        let result = py.eval(c_str!("undefined_variable + 1"), None, None);

        // å¦‚æœ eval æŠ›å‡ºå¼‚å¸¸ï¼Œåˆ™å°†å…¶ä¼ é€’ç»™ä¸Šä¸‹æ–‡ç®¡ç†å™¨ã€‚
        // å¦åˆ™ï¼Œç”¨ç©ºå‚æ•°ï¼ˆPython çš„ "None"ï¼‰è°ƒç”¨ __exit__ã€‚
        match result {
            Ok(_) =&gt; {
                let none = py.None();
                house
                    .call_method1("__exit__", (&amp;none, &amp;none, &amp;none))
                    .unwrap();
            }
            Err(e) =&gt; {
                house
                    .call_method1(
                        "__exit__",
                        (
                            e.get_type(py),
                            e.value(py),
                            e.traceback(py),
                        ),
                    )
                    .unwrap();
            }
        }
    })
}
```## å¤„ç†ç³»ç»Ÿä¿¡å·/ä¸­æ–­ï¼ˆCtrl-Cï¼‰

åœ¨è¿è¡Œ Rust ä»£ç æ—¶å¤„ç†ç³»ç»Ÿä¿¡å·çš„æœ€ä½³æ–¹æ³•æ˜¯å®šæœŸè°ƒç”¨ `Python::check_signals`ï¼Œä»¥å¤„ç† Python ä¿¡å·å¤„ç†å™¨æ•è·çš„ä»»ä½•ä¿¡å·ã€‚å¦è¯·å‚é˜…[å¸¸è§é—®é¢˜è§£ç­”](../faq.md#ctrl-c-doesn-t-do-anything-while-my-rust-code-is-executing)ã€‚

æˆ–è€…ï¼Œå¯ä»¥è®¾ç½® Python çš„ `signal` æ¨¡å—å¯¹æŸä¸ªä¿¡å·é‡‡å–é»˜è®¤æ“ä½œï¼š

```rust
use pyo3::prelude::*;

<span class="boring">fn main() -&gt; PyResult&lt;()&gt; {
</span>Python::attach(|py| -&gt; PyResult&lt;()&gt; {
    let signal = py.import("signal")?;
    // è®¾ç½® SIGINT é‡‡å–é»˜è®¤æ“ä½œ
    signal
        .getattr("signal")?
        .call1((signal.getattr("SIGINT")?, signal.getattr("SIG_DFL")?))?;
    Ok(())
})
<span class="boring">}</span></code></pre>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="ç±»å‹è½¬æ¢"><a class="header" href="#ç±»å‹è½¬æ¢">ç±»å‹è½¬æ¢</a></h1>
<p>åœ¨æœ¬æŒ‡å—çš„è¿™ä¸€éƒ¨åˆ†ï¼Œæˆ‘ä»¬å°†è®¨è®º PyO3 æä¾›çš„ Python ç±»å‹åˆ° Rust ç±»å‹çš„æ˜ å°„ï¼Œä»¥åŠå¯ç”¨äºåœ¨å®ƒä»¬ä¹‹é—´æ‰§è¡Œè½¬æ¢çš„ traitã€‚</p>
<p>å¦è¯·å‚é˜…è½¬æ¢<a href="#rust-ç±»å‹åˆ°-python-ç±»å‹çš„æ˜ å°„">è¡¨æ ¼</a>å’Œ<a href="#è½¬æ¢-trait">trait</a>ã€‚</p>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="rust-ç±»å‹åˆ°-python-ç±»å‹çš„æ˜ å°„"><a class="header" href="#rust-ç±»å‹åˆ°-python-ç±»å‹çš„æ˜ å°„">Rust ç±»å‹åˆ° Python ç±»å‹çš„æ˜ å°„</a></h1>
<p>åœ¨ç¼–å†™å¯ä» Python è°ƒç”¨çš„å‡½æ•°æ—¶ï¼ˆä¾‹å¦‚ <code>#[pyfunction]</code> æˆ– <code>#[pymethods]</code> å—ä¸­çš„å‡½æ•°ï¼‰ï¼Œå‡½æ•°å‚æ•°éœ€è¦å®ç° <code>FromPyObject</code> traitï¼Œè€Œè¿”å›å€¼éœ€è¦å®ç° <code>IntoPyObject</code> traitã€‚</p>
<p>è¯·å‚è€ƒä¸‹è¡¨ï¼Œäº†è§£ PyO3 æä¾›çš„ã€å®ç°è¿™äº› trait çš„ Rust ç±»å‹ã€‚</p>
<h2 id="å‚æ•°ç±»å‹"><a class="header" href="#å‚æ•°ç±»å‹">å‚æ•°ç±»å‹</a></h2>
<p>åœ¨æ¥æ”¶å‡½æ•°å‚æ•°æ—¶ï¼Œæ—¢å¯ä»¥ä½¿ç”¨ Rust æ ‡å‡†åº“ç±»å‹ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ PyO3 çš„ Python åŸç”Ÿç±»å‹ã€‚ï¼ˆä½•æ—¶ä½¿ç”¨å“ªç§ç±»å‹ï¼Œè¯·å‚è§ä¸‹ä¸€èŠ‚çš„è®¨è®ºã€‚ï¼‰</p>
<p>ä¸‹è¡¨åˆ—å‡ºäº† Python ç±»å‹åŠå…¶å¯¹åº”çš„ Rust å‚æ•°ç±»å‹ï¼š</p>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Python</th><th style="text-align: center">Rust</th><th style="text-align: center">Rustï¼ˆPython åŸç”Ÿï¼‰</th></tr>
</thead>
<tbody>
<tr><td><code>object</code></td><td style="text-align: center">-</td><td style="text-align: center"><code>PyAny</code></td></tr>
<tr><td><code>str</code></td><td style="text-align: center"><code>String</code>, <code>Cow&lt;str&gt;</code>, <code>&amp;str</code>, <code>char</code>, <code>OsString</code>, <code>PathBuf</code>, <code>Path</code></td><td style="text-align: center"><code>PyString</code></td></tr>
<tr><td><code>bytes</code></td><td style="text-align: center"><code>Vec&lt;u8&gt;</code>, <code>&amp;[u8]</code>, <code>Cow&lt;[u8]&gt;</code></td><td style="text-align: center"><code>PyBytes</code></td></tr>
<tr><td><code>bool</code></td><td style="text-align: center"><code>bool</code></td><td style="text-align: center"><code>PyBool</code></td></tr>
<tr><td><code>int</code></td><td style="text-align: center"><code>i8</code>, <code>u8</code>, <code>i16</code>, <code>u16</code>, <code>i32</code>, <code>u32</code>, <code>i64</code>, <code>u64</code>, <code>i128</code>, <code>u128</code>, <code>isize</code>, <code>usize</code>, <code>num_bigint::BigInt</code><sup class="footnote-reference" id="fr-1-1"><a href="#footnote-1">1</a></sup>, <code>num_bigint::BigUint</code><sup class="footnote-reference" id="fr-1-2"><a href="#footnote-1">1</a></sup></td><td style="text-align: center"><code>PyInt</code></td></tr>
<tr><td><code>float</code></td><td style="text-align: center"><code>f32</code>, <code>f64</code>, <code>ordered_float::NotNan</code><sup class="footnote-reference" id="fr-10-1"><a href="#footnote-10">2</a></sup>, <code>ordered_float::OrderedFloat</code><sup class="footnote-reference" id="fr-10-2"><a href="#footnote-10">2</a></sup></td><td style="text-align: center"><code>PyFloat</code></td></tr>
<tr><td><code>complex</code></td><td style="text-align: center"><code>num_complex::Complex</code><sup class="footnote-reference" id="fr-2-1"><a href="#footnote-2">3</a></sup></td><td style="text-align: center"><code>PyComplex</code></td></tr>
<tr><td><code>fractions.Fraction</code></td><td style="text-align: center"><code>num_rational::Ratio</code><sup class="footnote-reference" id="fr-8-1"><a href="#footnote-8">4</a></sup></td><td style="text-align: center">-</td></tr>
<tr><td><code>list[T]</code></td><td style="text-align: center"><code>Vec&lt;T&gt;</code></td><td style="text-align: center"><code>PyList</code></td></tr>
<tr><td><code>dict[K, V]</code></td><td style="text-align: center"><code>HashMap&lt;K, V&gt;</code>, <code>BTreeMap&lt;K, V&gt;</code>, <code>hashbrown::HashMap&lt;K, V&gt;</code><sup class="footnote-reference" id="fr-3-1"><a href="#footnote-3">5</a></sup>, <code>indexmap::IndexMap&lt;K, V&gt;</code><sup class="footnote-reference" id="fr-4-1"><a href="#footnote-4">6</a></sup></td><td style="text-align: center"><code>PyDict</code></td></tr>
<tr><td><code>tuple[T, U]</code></td><td style="text-align: center"><code>(T, U)</code>, <code>Vec&lt;T&gt;</code></td><td style="text-align: center"><code>PyTuple</code></td></tr>
<tr><td><code>set[T]</code></td><td style="text-align: center"><code>HashSet&lt;T&gt;</code>, <code>BTreeSet&lt;T&gt;</code>, <code>hashbrown::HashSet&lt;T&gt;</code><sup class="footnote-reference" id="fr-3-2"><a href="#footnote-3">5</a></sup></td><td style="text-align: center"><code>PySet</code></td></tr>
<tr><td><code>frozenset[T]</code></td><td style="text-align: center"><code>HashSet&lt;T&gt;</code>, <code>BTreeSet&lt;T&gt;</code>, <code>hashbrown::HashSet&lt;T&gt;</code><sup class="footnote-reference" id="fr-3-3"><a href="#footnote-3">5</a></sup></td><td style="text-align: center"><code>PyFrozenSet</code></td></tr>
<tr><td><code>bytearray</code></td><td style="text-align: center"><code>Vec&lt;u8&gt;</code>, <code>Cow&lt;[u8]&gt;</code></td><td style="text-align: center"><code>PyByteArray</code></td></tr>
<tr><td><code>slice</code></td><td style="text-align: center">-</td><td style="text-align: center"><code>PySlice</code></td></tr>
<tr><td><code>type</code></td><td style="text-align: center">-</td><td style="text-align: center"><code>PyType</code></td></tr>
<tr><td><code>module</code></td><td style="text-align: center">-</td><td style="text-align: center"><code>PyModule</code></td></tr>
<tr><td><code>collections.abc.Buffer</code></td><td style="text-align: center">-</td><td style="text-align: center"><code>PyBuffer&lt;T&gt;</code></td></tr>
<tr><td><code>datetime.datetime</code></td><td style="text-align: center"><code>SystemTime</code>, <code>chrono::DateTime&lt;Tz&gt;</code><sup class="footnote-reference" id="fr-5-1"><a href="#footnote-5">7</a></sup>, <code>chrono::NaiveDateTime</code><sup class="footnote-reference" id="fr-5-2"><a href="#footnote-5">7</a></sup></td><td style="text-align: center"><code>PyDateTime</code></td></tr>
<tr><td><code>datetime.date</code></td><td style="text-align: center"><code>chrono::NaiveDate</code><sup class="footnote-reference" id="fr-5-3"><a href="#footnote-5">7</a></sup></td><td style="text-align: center"><code>PyDate</code></td></tr>
<tr><td><code>datetime.time</code></td><td style="text-align: center"><code>chrono::NaiveTime</code><sup class="footnote-reference" id="fr-5-4"><a href="#footnote-5">7</a></sup></td><td style="text-align: center"><code>PyTime</code></td></tr>
<tr><td><code>datetime.tzinfo</code></td><td style="text-align: center"><code>chrono::FixedOffset</code><sup class="footnote-reference" id="fr-5-5"><a href="#footnote-5">7</a></sup>, <code>chrono::Utc</code><sup class="footnote-reference" id="fr-5-6"><a href="#footnote-5">7</a></sup>, <code>chrono_tz::TimeZone</code><sup class="footnote-reference" id="fr-6-1"><a href="#footnote-6">8</a></sup></td><td style="text-align: center"><code>PyTzInfo</code></td></tr>
<tr><td><code>datetime.timedelta</code></td><td style="text-align: center"><code>Duration</code>, <code>chrono::Duration</code><sup class="footnote-reference" id="fr-5-7"><a href="#footnote-5">7</a></sup></td><td style="text-align: center"><code>PyDelta</code></td></tr>
<tr><td><code>decimal.Decimal</code></td><td style="text-align: center"><code>rust_decimal::Decimal</code><sup class="footnote-reference" id="fr-7-1"><a href="#footnote-7">9</a></sup></td><td style="text-align: center">-</td></tr>
<tr><td><code>decimal.Decimal</code></td><td style="text-align: center"><code>bigdecimal::BigDecimal</code><sup class="footnote-reference" id="fr-9-1"><a href="#footnote-9">10</a></sup></td><td style="text-align: center">-</td></tr>
<tr><td><code>ipaddress.IPv4Address</code></td><td style="text-align: center"><code>std::net::IpAddr</code>, <code>std::net::Ipv4Addr</code></td><td style="text-align: center">-</td></tr>
<tr><td><code>ipaddress.IPv6Address</code></td><td style="text-align: center"><code>std::net::IpAddr</code>, <code>std::net::Ipv6Addr</code></td><td style="text-align: center">-</td></tr>
<tr><td><code>os.PathLike</code></td><td style="text-align: center"><code>PathBuf</code>, <code>Path</code></td><td style="text-align: center"><code>PyString</code></td></tr>
<tr><td><code>pathlib.Path</code></td><td style="text-align: center"><code>PathBuf</code>, <code>Path</code></td><td style="text-align: center"><code>PyString</code></td></tr>
<tr><td><code>typing.Optional[T]</code></td><td style="text-align: center"><code>Option&lt;T&gt;</code></td><td style="text-align: center">-</td></tr>
<tr><td><code>typing.Sequence[T]</code></td><td style="text-align: center"><code>Vec&lt;T&gt;</code></td><td style="text-align: center"><code>PySequence</code></td></tr>
<tr><td><code>typing.Mapping[K, V]</code></td><td style="text-align: center"><code>HashMap&lt;K, V&gt;</code>, <code>BTreeMap&lt;K, V&gt;</code>, <code>hashbrown::HashMap&lt;K, V&gt;</code><sup class="footnote-reference" id="fr-3-4"><a href="#footnote-3">5</a></sup>, <code>indexmap::IndexMap&lt;K, V&gt;</code><sup class="footnote-reference" id="fr-4-2"><a href="#footnote-4">6</a></sup></td><td style="text-align: center"><code>&amp;PyMapping</code></td></tr>
<tr><td><code>typing.Iterator[Any]</code></td><td style="text-align: center">-</td><td style="text-align: center"><code>PyIterator</code></td></tr>
<tr><td><code>typing.Union[...]</code></td><td style="text-align: center">å‚è§ <a href="#deriving-frompyobject-for-enums"><code>#[derive(FromPyObject)]</code></a></td><td style="text-align: center">-</td></tr>
</tbody>
</table>
</div>
<p>æ­¤å¤–ï¼Œè¿˜éœ€è®°ä½ä»¥ä¸‹ç‰¹æ®Šç±»å‹ï¼š</p>
<div class="table-wrapper">
<table>
<thead>
<tr><th>å«ä¹‰</th><th>æè¿°</th></tr>
</thead>
<tbody>
<tr><td><code>Python&lt;'py&gt;</code></td><td>ç”¨äºè¯æ˜ä¸ Python è§£é‡Šå™¨å…³è”çš„ä»¤ç‰Œã€‚</td></tr>
<tr><td><code>Bound&lt;'py, T&gt;</code></td><td>ä¸è§£é‡Šå™¨å…³è”ç”Ÿå‘½å‘¨æœŸç»‘å®šçš„ Python å¯¹è±¡ã€‚å®ƒæä¾›äº†å¯¹ PyO3 å¤§éƒ¨åˆ† API çš„è®¿é—®ã€‚</td></tr>
<tr><td><code>Py&lt;T&gt;</code></td><td>æœªä¸ä»»ä½•è§£é‡Šå™¨ç”Ÿå‘½å‘¨æœŸç»‘å®šçš„ Python å¯¹è±¡ã€‚å¯è¢«å‘é€åˆ°å…¶ä»–çº¿ç¨‹ã€‚</td></tr>
<tr><td><code>PyRef&lt;T&gt;</code></td><td>ä¸å¯å˜å€Ÿç”¨çš„ <code>#[pyclass]</code> ç±»å‹ã€‚</td></tr>
<tr><td><code>PyRefMut&lt;T&gt;</code></td><td>å¯å˜å€Ÿç”¨çš„ <code>#[pyclass]</code> ç±»å‹ã€‚</td></tr>
</tbody>
</table>
</div>
<p>æœ‰å…³æ¥å— <code>#[pyclass]</code> å€¼ä½œä¸ºå‡½æ•°å‚æ•°çš„æ›´å¤šç»†èŠ‚ï¼Œè¯·å‚è§æœ¬æŒ‡å—ä¸­å…³äº<a href="#python-ç±»">Python ç±»</a>çš„éƒ¨åˆ†ã€‚</p>
<h3 id="ä½¿ç”¨-rust-åº“ç±»å‹-vs-python-åŸç”Ÿç±»å‹"><a class="header" href="#ä½¿ç”¨-rust-åº“ç±»å‹-vs-python-åŸç”Ÿç±»å‹">ä½¿ç”¨ Rust åº“ç±»å‹ vs Python åŸç”Ÿç±»å‹</a></h3>
<p>ä½œä¸ºå‡½æ•°å‚æ•°ä½¿ç”¨ Rust åº“ç±»å‹æ—¶ï¼Œç›¸æ¯”ä½¿ç”¨ Python åŸç”Ÿç±»å‹ä¼šå¸¦æ¥ä¸€å®šçš„è½¬æ¢å¼€é”€ã€‚è€Œä½¿ç”¨ Python åŸç”Ÿç±»å‹å‡ ä¹é›¶æˆæœ¬ï¼ˆä»…éœ€ç±»ä¼¼ Python å†…ç½®å‡½æ•° <code>isinstance()</code> çš„ç±»å‹æ£€æŸ¥ï¼‰ã€‚</p>
<p>ç„¶è€Œï¼Œä¸€æ—¦æ”¯ä»˜äº†è½¬æ¢æˆæœ¬ï¼ŒRust æ ‡å‡†åº“ç±»å‹æä¾›äº†è®¸å¤šä¼˜åŠ¿ï¼š</p>
<ul>
<li>ä½ å¯ä»¥ç”¨åŸç”Ÿé€Ÿåº¦çš„ Rust ä»£ç ç¼–å†™åŠŸèƒ½ï¼ˆé¿å… Python è¿è¡Œæ—¶å¼€é”€ï¼‰ã€‚</li>
<li>ä¸ Rust ç”Ÿæ€ç³»ç»Ÿçš„å…¶ä½™éƒ¨åˆ†æœ‰æ›´å¥½çš„äº’æ“ä½œæ€§ã€‚</li>
<li>å¯ä»¥ä½¿ç”¨ <code>Python::detach</code> è„±ç¦»è§£é‡Šå™¨ï¼Œè®©å…¶ä»– Python çº¿ç¨‹åœ¨ä½ çš„ Rust ä»£ç æ‰§è¡Œæ—¶ç»§ç»­è¿è¡Œã€‚</li>
<li>ç±»å‹æ£€æŸ¥æ›´ä¸¥æ ¼ã€‚ä¾‹å¦‚ä½ å¯ä»¥æŒ‡å®š <code>Vec&lt;i32&gt;</code>ï¼Œå®ƒåªä¼šæ¥å—åŒ…å«æ•´æ•°çš„ Python <code>list</code>ã€‚è€Œå¯¹åº”çš„ Python åŸç”Ÿç±»å‹ <code>&amp;PyList</code> ä¼šæ¥å—åŒ…å«ä»»æ„ç±»å‹å¯¹è±¡çš„ <code>list</code>ã€‚</li>
</ul>
<p>å¯¹äºå¤§å¤šæ•° PyO3 ä½¿ç”¨åœºæ™¯ï¼Œè¿™äº›ä¼˜åŠ¿å€¼å¾—ä»˜å‡ºè½¬æ¢æˆæœ¬ã€‚ä¸å¾€å¸¸ä¸€æ ·ï¼Œå¦‚æœä½ ä¸ç¡®å®šæ˜¯å¦å€¼å¾—ï¼Œå»ºè®®è¿›è¡Œæ€§èƒ½æµ‹è¯•ï¼</p>
<h2 id="å°†-rust-å€¼è¿”å›ç»™-python"><a class="header" href="#å°†-rust-å€¼è¿”å›ç»™-python">å°† Rust å€¼è¿”å›ç»™ Python</a></h2>
<p>å½“ä»å¯è¢« Python è°ƒç”¨çš„å‡½æ•°ä¸­è¿”å›å€¼æ—¶ï¼Œå¯ä»¥é›¶æˆæœ¬åœ°ä½¿ç”¨ <a href="#pyo3s-smart-pointers">PyO3 çš„æ™ºèƒ½æŒ‡é’ˆ</a>ï¼ˆ<code>Py&lt;T&gt;</code>ã€<code>Bound&lt;'py, T&gt;</code> å’Œ <code>Borrowed&lt;'a, 'py, T&gt;</code>ï¼‰ã€‚</p>
<p>ç”±äº <code>Bound&lt;'py, T&gt;</code> å’Œ <code>Borrowed&lt;'a, 'py, T&gt;</code> åŒ…å«ç”Ÿå‘½å‘¨æœŸå‚æ•°ï¼ŒRust ç¼–è¯‘å™¨å¯èƒ½è¦æ±‚ä½ ä¸ºå‡½æ•°æ·»åŠ ç”Ÿå‘½å‘¨æœŸæ³¨è§£ã€‚è¯¦ç»†è¯´æ˜è¯·å‚è§æŒ‡å—ä¸­å…³äºæ­¤ä¸»é¢˜çš„<a href="#function-argument-lifetimes">ä¸“é—¨ç« èŠ‚</a>ã€‚</p>
<p>å¦‚æœä½ çš„å‡½æ•°å¯èƒ½å¤±è´¥ï¼Œåº”è¿”å› <code>PyResult&lt;T&gt;</code> æˆ– <code>Result&lt;T, E&gt;</code>ï¼ˆå…¶ä¸­ <code>E</code> å®ç°äº† <code>From&lt;E&gt; for PyErr</code>ï¼‰ã€‚è¿™ä¼šåœ¨è¿”å› <code>Err</code> å˜ä½“æ—¶å¼•å‘ Python å¼‚å¸¸ã€‚</p>
<p>æœ€åï¼Œä»¥ä¸‹ Rust ç±»å‹ä¹Ÿå¯ä½œä¸ºè¿”å›å€¼è½¬æ¢ä¸º Pythonï¼š</p>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Rust ç±»å‹</th><th style="text-align: center">å¯¹åº”çš„ Python ç±»å‹</th></tr>
</thead>
<tbody>
<tr><td><code>String</code></td><td style="text-align: center"><code>str</code></td></tr>
<tr><td><code>&amp;str</code></td><td style="text-align: center"><code>str</code></td></tr>
<tr><td><code>bool</code></td><td style="text-align: center"><code>bool</code></td></tr>
<tr><td>ä»»æ„æ•´æ•°ç±»å‹ï¼ˆ<code>i32</code>ã€<code>u32</code>ã€<code>usize</code> ç­‰ï¼‰</td><td style="text-align: center"><code>int</code></td></tr>
<tr><td><code>f32</code>, <code>f64</code></td><td style="text-align: center"><code>float</code></td></tr>
<tr><td><code>Option&lt;T&gt;</code></td><td style="text-align: center"><code>Optional[T]</code></td></tr>
<tr><td><code>(T, U)</code></td><td style="text-align: center"><code>Tuple[T, U]</code></td></tr>
<tr><td><code>Vec&lt;T&gt;</code></td><td style="text-align: center"><code>List[T]</code></td></tr>
<tr><td><code>Cow&lt;[u8]&gt;</code></td><td style="text-align: center"><code>bytes</code></td></tr>
<tr><td><code>HashMap&lt;K, V&gt;</code></td><td style="text-align: center"><code>Dict[K, V]</code></td></tr>
<tr><td><code>BTreeMap&lt;K, V&gt;</code></td><td style="text-align: center"><code>Dict[K, V]</code></td></tr>
<tr><td><code>HashSet&lt;T&gt;</code></td><td style="text-align: center"><code>Set[T]</code></td></tr>
<tr><td><code>BTreeSet&lt;T&gt;</code></td><td style="text-align: center"><code>Set[T]</code></td></tr>
<tr><td><code>Py&lt;T&gt;</code></td><td style="text-align: center"><code>T</code></td></tr>
<tr><td><code>Bound&lt;T&gt;</code></td><td style="text-align: center"><code>T</code></td></tr>
<tr><td><code>PyRef&lt;T: PyClass&gt;</code></td><td style="text-align: center"><code>T</code></td></tr>
<tr><td><code>PyRefMut&lt;T: PyClass&gt;</code></td><td style="text-align: center"><code>T</code></td></tr>
</tbody>
</table>
</div>
<hr>
<ol class="footnote-definition">
<li id="footnote-1">
<p>éœ€å¯ç”¨ <code>num-bigint</code> å¯é€‰åŠŸèƒ½ã€‚ <a href="#fr-1-1">â†©</a> <a href="#fr-1-2">â†©2</a></p>
</li>
<li id="footnote-10">
<p>éœ€å¯ç”¨ <code>ordered-float</code> å¯é€‰åŠŸèƒ½ã€‚ <a href="#fr-10-1">â†©</a> <a href="#fr-10-2">â†©2</a></p>
</li>
<li id="footnote-2">
<p>éœ€å¯ç”¨ <code>num-complex</code> å¯é€‰åŠŸèƒ½ã€‚ <a href="#fr-2-1">â†©</a></p>
</li>
<li id="footnote-8">
<p>éœ€å¯ç”¨ <code>num-rational</code> å¯é€‰åŠŸèƒ½ã€‚ <a href="#fr-8-1">â†©</a></p>
</li>
<li id="footnote-3">
<p>éœ€å¯ç”¨ <code>hashbrown</code> å¯é€‰åŠŸèƒ½ã€‚ <a href="#fr-3-1">â†©</a> <a href="#fr-3-2">â†©2</a> <a href="#fr-3-3">â†©3</a> <a href="#fr-3-4">â†©4</a></p>
</li>
<li id="footnote-4">
<p>éœ€å¯ç”¨ <code>indexmap</code> å¯é€‰åŠŸèƒ½ã€‚ <a href="#fr-4-1">â†©</a> <a href="#fr-4-2">â†©2</a></p>
</li>
<li id="footnote-5">
<p>éœ€å¯ç”¨ <code>chrono</code>ï¼ˆä»¥åŠå¯èƒ½çš„ <code>chrono-local</code>ï¼‰å¯é€‰åŠŸèƒ½ã€‚ <a href="#fr-5-1">â†©</a> <a href="#fr-5-2">â†©2</a> <a href="#fr-5-3">â†©3</a> <a href="#fr-5-4">â†©4</a> <a href="#fr-5-5">â†©5</a> <a href="#fr-5-6">â†©6</a> <a href="#fr-5-7">â†©7</a></p>
</li>
<li id="footnote-6">
<p>éœ€å¯ç”¨ <code>chrono-tz</code> å¯é€‰åŠŸèƒ½ã€‚ <a href="#fr-6-1">â†©</a></p>
</li>
<li id="footnote-7">
<p>éœ€å¯ç”¨ <code>rust_decimal</code> å¯é€‰åŠŸèƒ½ã€‚ <a href="#fr-7-1">â†©</a></p>
</li>
<li id="footnote-9">
<p>éœ€å¯ç”¨ <code>bigdecimal</code> å¯é€‰åŠŸèƒ½ã€‚ <a href="#fr-9-1">â†©</a></p>
</li>
</ol>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="è½¬æ¢-trait"><a class="header" href="#è½¬æ¢-trait">è½¬æ¢ trait</a></h1>
<p>PyO3 æä¾›äº†ä¸€äº›ä¾¿æ·çš„ traitï¼Œç”¨äºåœ¨ Python ç±»å‹å’Œ Rust ç±»å‹ä¹‹é—´è¿›è¡Œè½¬æ¢ã€‚</p>
<h2 id="extract-å’Œ-frompyobject-trait"><a class="header" href="#extract-å’Œ-frompyobject-trait"><code>.extract()</code> å’Œ <code>FromPyObject</code> trait</a></h2>
<p>å°† Python å¯¹è±¡è½¬æ¢ä¸º Rust å€¼çš„æœ€ç®€å•æ–¹æ³•æ˜¯ä½¿ç”¨ <code>.extract()</code>ã€‚å¦‚æœè½¬æ¢å¤±è´¥ï¼Œå®ƒä¼šè¿”å›ä¸€ä¸ªåŒ…å«ç±»å‹é”™è¯¯çš„ <code>PyResult</code>ï¼Œå› æ­¤ä½ é€šå¸¸ä¼šè¿™æ ·ä½¿ç”¨ï¼š</p>
<pre><code class="language-rust"><span class="boring">use pyo3::prelude::*;
</span><span class="boring">use pyo3::types::PyList;
</span><span class="boring">fn main() -&gt; PyResult&lt;()&gt; {
</span><span class="boring">    Python::attach(|py| {
</span><span class="boring">        let list = PyList::new(py, b"foo")?;
</span>let v: Vec&lt;i32&gt; = list.extract()?;
<span class="boring">        assert_eq!(&amp;v, &amp;[102, 111, 111]);
</span><span class="boring">        Ok(())
</span><span class="boring">    })
</span><span class="boring">}</span></code></pre>
<p>æ­¤æ–¹æ³•é€‚ç”¨äºè®¸å¤š Python å¯¹è±¡ç±»å‹ï¼Œå¹¶èƒ½ç”Ÿæˆå¤šç§ Rust ç±»å‹ï¼Œä½ å¯ä»¥åœ¨ <a href="conversions/{{#PYO3_DOCS_URL}}/pyo3/conversion/trait.FromPyObject.html"><code>FromPyObject</code></a> çš„å®ç°è€…åˆ—è¡¨ä¸­æŸ¥çœ‹ã€‚</p>
<p><a href="conversions/{{#PYO3_DOCS_URL}}/pyo3/conversion/trait.FromPyObject.html"><code>FromPyObject</code></a> ä¹Ÿä¸ºä½ è‡ªå·±ä½œä¸º Python å¯¹è±¡åŒ…è£…çš„ Rust ç±»å‹æ‰€å®ç°ï¼ˆå‚è§<a href="#python-ç±»">å…³äºç±»çš„ç« èŠ‚</a>ï¼‰ã€‚åœ¨é‚£é‡Œï¼Œä¸ºäº†æ—¢èƒ½æ“ä½œå¯å˜å¼•ç”¨åˆèƒ½æ»¡è¶³ Rust å…³äºå¯å˜å¼•ç”¨ä¸å¯åˆ«åçš„è§„åˆ™ï¼Œä½ å¿…é¡»æå– PyO3 çš„å¼•ç”¨åŒ…è£…å™¨ <a href="conversions/{{#PYO3_DOCS_URL}}/pyo3/pycell/struct.PyRef.html"><code>PyRef</code></a> å’Œ <a href="conversions/{{#PYO3_DOCS_URL}}/pyo3/pycell/struct.PyRefMut.html"><code>PyRefMut</code></a>ã€‚å®ƒä»¬çš„å·¥ä½œæ–¹å¼ç±»ä¼¼äº <code>std::cell::RefCell</code> çš„å¼•ç”¨åŒ…è£…å™¨ï¼Œç¡®ä¿ï¼ˆåœ¨è¿è¡Œæ—¶ï¼‰Rust çš„å€Ÿç”¨æ˜¯è¢«å…è®¸çš„ã€‚</p>
<h3 id="æ´¾ç”Ÿ-frompyobject"><a class="header" href="#æ´¾ç”Ÿ-frompyobject">æ´¾ç”Ÿ <a href="conversions/{{#PYO3_DOCS_URL}}/pyo3/conversion/trait.FromPyObject.html"><code>FromPyObject</code></a></a></h3>
<p>å¦‚æœæˆå‘˜ç±»å‹æœ¬èº«å®ç°äº† <code>FromPyObject</code>ï¼Œåˆ™å¯ä»¥ä¸ºè®¸å¤šç±»å‹çš„ç»“æ„ä½“å’Œæšä¸¾è‡ªåŠ¨æ´¾ç”Ÿ <a href="conversions/{{#PYO3_DOCS_URL}}/pyo3/conversion/trait.FromPyObject.html"><code>FromPyObject</code></a>ã€‚è¿™ç”šè‡³åŒ…æ‹¬å¸¦æœ‰æ³›å‹ç±»å‹ <code>T: FromPyObject</code> çš„æˆå‘˜ã€‚ä¸æ”¯æŒå¯¹ç©ºæšä¸¾ã€æšä¸¾å˜ä½“å’Œç»“æ„ä½“è¿›è¡Œæ´¾ç”Ÿã€‚</p>
<h3 id="ä¸ºç»“æ„ä½“æ´¾ç”Ÿ-frompyobject"><a class="header" href="#ä¸ºç»“æ„ä½“æ´¾ç”Ÿ-frompyobject">ä¸ºç»“æ„ä½“æ´¾ç”Ÿ <a href="conversions/{{#PYO3_DOCS_URL}}/pyo3/conversion/trait.FromPyObject.html"><code>FromPyObject</code></a></a></h3>
<p>è¯¥æ´¾ç”Ÿä¼šç”Ÿæˆä»£ç ï¼Œå°è¯•è®¿é—® Python å¯¹è±¡ä¸Šçš„ <code>my_string</code> å±æ€§ï¼Œå³ <code>obj.getattr("my_string")</code>ï¼Œç„¶ååœ¨è¯¥å±æ€§ä¸Šè°ƒç”¨ <code>extract()</code>ã€‚</p>
<pre><code class="language-rust">use pyo3::prelude::*;
use pyo3_ffi::c_str;


#[derive(FromPyObject)]
struct RustyStruct {
    my_string: String,
}
<span class="boring">
</span><span class="boring">fn main() -&gt; PyResult&lt;()&gt; {
</span><span class="boring">    Python::attach(|py| -&gt; PyResult&lt;()&gt; {
</span><span class="boring">        let module = PyModule::from_code(
</span><span class="boring">            py,
</span><span class="boring">            c_str!("class Foo:
</span><span class="boring">            def __init__(self):
</span><span class="boring">                self.my_string = 'test'"),
</span><span class="boring">            c_str!("&lt;string&gt;"),
</span><span class="boring">            c_str!(""),
</span><span class="boring">        )?;
</span><span class="boring">
</span><span class="boring">        let class = module.getattr("Foo")?;
</span><span class="boring">        let instance = class.call0()?;
</span><span class="boring">        let rustystruct: RustyStruct = instance.extract()?;
</span><span class="boring">        assert_eq!(rustystruct.my_string, "test");
</span><span class="boring">        Ok(())
</span><span class="boring">    })
</span><span class="boring">}</span></code></pre>
<p>é€šè¿‡åœ¨å­—æ®µä¸Šè®¾ç½® <code>#[pyo3(item)]</code> å±æ€§ï¼ŒPyO3 ä¼šå°è¯•é€šè¿‡è°ƒç”¨ Python å¯¹è±¡çš„ <code>get_item</code> æ–¹æ³•æ¥æå–è¯¥å€¼ã€‚</p>
<pre><code class="language-rust">use pyo3::prelude::*;


#[derive(FromPyObject)]
struct RustyStruct {
    #[pyo3(item)]
    my_string: String,
}
<span class="boring">
</span><span class="boring">use pyo3::types::PyDict;
</span><span class="boring">fn main() -&gt; PyResult&lt;()&gt; {
</span><span class="boring">    Python::attach(|py| -&gt; PyResult&lt;()&gt; {
</span><span class="boring">        let dict = PyDict::new(py);
</span><span class="boring">        dict.set_item("my_string", "test")?;
</span><span class="boring">
</span><span class="boring">        let rustystruct: RustyStruct = dict.extract()?;
</span><span class="boring">        assert_eq!(rustystruct.my_string, "test");
</span><span class="boring">        Ok(())
</span><span class="boring">    })
</span><span class="boring">}</span></code></pre>
<p>ä¼ é€’ç»™ <code>getattr</code> å’Œ <code>get_item</code> çš„å‚æ•°ä¹Ÿå¯ä»¥è¢«é…ç½®ï¼š</p>
<pre><code class="language-rust">use pyo3::prelude::*;
use pyo3_ffi::c_str;


#[derive(FromPyObject)]
struct RustyStruct {
    #[pyo3(item("key"))]
    string_in_mapping: String,
    #[pyo3(attribute("name"))]
    string_attr: String,
}
<span class="boring">
</span><span class="boring">fn main() -&gt; PyResult&lt;()&gt; {
</span><span class="boring">    Python::attach(|py| -&gt; PyResult&lt;()&gt; {
</span><span class="boring">        let module = PyModule::from_code(
</span><span class="boring">            py,
</span><span class="boring">            c_str!("class Foo(dict):
</span><span class="boring">            def __init__(self):
</span><span class="boring">                self.name = 'test'
</span><span class="boring">                self['key'] = 'test2'"),
</span><span class="boring">            c_str!("&lt;string&gt;"),
</span><span class="boring">            c_str!(""),
</span><span class="boring">        )?;
</span><span class="boring">
</span><span class="boring">        let class = module.getattr("Foo")?;
</span><span class="boring">        let instance = class.call0()?;
</span><span class="boring">        let rustystruct: RustyStruct = instance.extract()?;
</span><span class="boring">		assert_eq!(rustystruct.string_attr, "test");
</span><span class="boring">        assert_eq!(rustystruct.string_in_mapping, "test2");
</span><span class="boring">
</span><span class="boring">        Ok(())
</span><span class="boring">    })
</span><span class="boring">}</span></code></pre>
<p>è¿™ä¼šå°è¯•ä»å±æ€§ <code>name</code> æå– <code>string_attr</code>ï¼Œå¹¶ä»é”®ä¸º <code>"key"</code> çš„æ˜ å°„ä¸­æå– <code>string_in_mapping</code>ã€‚<code>attribute</code> çš„å‚æ•°è¢«é™åˆ¶ä¸ºéç©ºå­—ç¬¦ä¸²å­—é¢é‡ï¼Œè€Œ <code>item</code> å¯ä»¥æ¥å—ä»»ä½•å®ç°äº† <code>ToBorrowedObject</code> çš„æœ‰æ•ˆå­—é¢é‡ã€‚</p>
<p>ä½ å¯ä»¥å¯¹ç»“æ„ä½“ä½¿ç”¨ <code>#[pyo3(from_item_all)]</code> æ¥ä½¿ç”¨ <code>get_item</code> æ–¹æ³•æå–æ¯ä¸ªå­—æ®µã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä¸èƒ½å¯¹ä»»ä½•å­—æ®µä½¿ç”¨ <code>#[pyo3(attribute)]</code> æˆ–å‡ ä¹ä¸èƒ½ä½¿ç”¨ <code>#[pyo3(item)]</code>ã€‚ç„¶è€Œï¼Œä»ç„¶å…è®¸ä½¿ç”¨ <code>#[pyo3(item("key"))]</code> æ¥ä¸ºæŸä¸ªå­—æ®µæŒ‡å®šé”®ã€‚</p>
<pre><code class="language-rust">use pyo3::prelude::*;


#[derive(FromPyObject)]
#[pyo3(from_item_all)]
struct RustyStruct {
    foo: String,
    bar: String,
    #[pyo3(item("foobar"))]
    baz: String,
}
<span class="boring">
</span><span class="boring">fn main() -&gt; PyResult&lt;()&gt; {
</span><span class="boring">    Python::attach(|py| -&gt; PyResult&lt;()&gt; {
</span><span class="boring">        let py_dict = py.eval(pyo3::ffi::c_str!("{'foo': 'foo', 'bar': 'bar', 'foobar': 'foobar'}"), None, None)?;
</span><span class="boring">        let rustystruct: RustyStruct = py_dict.extract()?;
</span><span class="boring">		  assert_eq!(rustystruct.foo, "foo");
</span><span class="boring">        assert_eq!(rustystruct.bar, "bar");
</span><span class="boring">        assert_eq!(rustystruct.baz, "foobar");
</span><span class="boring">
</span><span class="boring">        Ok(())
</span><span class="boring">    })
</span><span class="boring">}</span></code></pre>
<h3 id="ä¸ºå…ƒç»„ç»“æ„ä½“æ´¾ç”Ÿ-frompyobject"><a class="header" href="#ä¸ºå…ƒç»„ç»“æ„ä½“æ´¾ç”Ÿ-frompyobject">ä¸ºå…ƒç»„ç»“æ„ä½“æ´¾ç”Ÿ <a href="conversions/{{#PYO3_DOCS_URL}}/pyo3/conversion/trait.FromPyObject.html"><code>FromPyObject</code></a></a></h3>
<p>å…ƒç»„ç»“æ„ä½“ä¹Ÿå—æ”¯æŒï¼Œä½†ä¸å…è®¸è‡ªå®šä¹‰æå–è¿‡ç¨‹ã€‚è¾“å…¥æ€»æ˜¯è¢«å‡å®šä¸ºä¸ Rust ç±»å‹å…·æœ‰ç›¸åŒé•¿åº¦çš„ Python å…ƒç»„ï¼Œç¬¬ <code>n</code> ä¸ªå­—æ®µä» Python å…ƒç»„çš„ç¬¬ <code>n</code> ä¸ªå…ƒç´ ä¸­æå–ã€‚</p>
<pre><code class="language-rust">use pyo3::prelude::*;


#[derive(FromPyObject)]
struct RustyTuple(String, String);


<span class="boring">use pyo3::types::PyTuple;
</span><span class="boring">fn main() -&gt; PyResult&lt;()&gt; {
</span><span class="boring">    Python::attach(|py| -&gt; PyResult&lt;()&gt; {
</span><span class="boring">        let tuple = PyTuple::new(py, vec!["test", "test2"])?;
</span><span class="boring">
</span><span class="boring">        let rustytuple: RustyTuple = tuple.extract()?;
</span><span class="boring">        assert_eq!(rustytuple.0, "test");
</span><span class="boring">        assert_eq!(rustytuple.1, "test2");
</span><span class="boring">
</span><span class="boring">        Ok(())
</span><span class="boring">    })
</span><span class="boring">}</span></code></pre>
<p>å…·æœ‰å•ä¸ªå­—æ®µçš„å…ƒç»„ç»“æ„ä½“è¢«è§†ä¸ºåŒ…è£…ç±»å‹ï¼Œå¦‚ä¸‹ä¸€èŠ‚æ‰€è¿°ã€‚è¦è¦†ç›–æ­¤è¡Œä¸ºå¹¶ç¡®ä¿è¾“å…¥ç¡®å®ä¸ºå…ƒç»„ï¼Œåº”å°†ç»“æ„ä½“å£°æ˜ä¸ºï¼š</p>
<pre><code class="language-rust">use pyo3::prelude::*;


#[derive(FromPyObject)]
struct RustyTuple((String,));


<span class="boring">use pyo3::types::PyTuple;
</span><span class="boring">fn main() -&gt; PyResult&lt;()&gt; {
</span><span class="boring">    Python::attach(|py| -&gt; PyResult&lt;()&gt; {
</span><span class="boring">        let tuple = PyTuple::new(py, vec!["test"])?;
</span><span class="boring">
</span><span class="boring">        let rustytuple: RustyTuple = tuple.extract()?;
</span><span class="boring">        assert_eq!((rustytuple.0).0, "test");
</span><span class="boring">
</span><span class="boring">        Ok(())
</span><span class="boring">    })
</span><span class="boring">}</span></code></pre>
<h3 id="ä¸ºåŒ…è£…ç±»å‹æ´¾ç”Ÿ-frompyobject"><a class="header" href="#ä¸ºåŒ…è£…ç±»å‹æ´¾ç”Ÿ-frompyobject">ä¸ºåŒ…è£…ç±»å‹æ´¾ç”Ÿ <a href="conversions/{{#PYO3_DOCS_URL}}/pyo3/conversion/trait.FromPyObject.html"><code>FromPyObject</code></a></a></h3>
<p><code>pyo3(transparent)</code> å±æ€§å¯ç”¨äºæ°å¥½æœ‰ä¸€ä¸ªå­—æ®µçš„ç»“æ„ä½“ã€‚è¿™ä¼šå¯¼è‡´ç›´æ¥ä»è¾“å…¥å¯¹è±¡æå–å€¼ï¼Œå³ <code>obj.extract()</code>ï¼Œè€Œä¸æ˜¯å°è¯•è®¿é—®æŸä¸ªé¡¹æˆ–å±æ€§ã€‚å¯¹äºå•å­—æ®µçš„æ–°ç±»å‹ç»“æ„ä½“å’Œå…ƒç»„å˜ä½“ï¼Œæ­¤è¡Œä¸ºé»˜è®¤å¯ç”¨ã€‚</p>
<pre><code class="language-rust">use pyo3::prelude::*;


#[derive(FromPyObject)]
struct RustyTransparentTupleStruct(String);


#[derive(FromPyObject)]
#[pyo3(transparent)]
struct RustyTransparentStruct {
    inner: String,
}


<span class="boring">use pyo3::types::PyString;
</span><span class="boring">fn main() -&gt; PyResult&lt;()&gt; {
</span><span class="boring">    Python::attach(|py| -&gt; PyResult&lt;()&gt; {
</span><span class="boring">        let s = PyString::new(py, "test");
</span><span class="boring">
</span><span class="boring">        let tup: RustyTransparentTupleStruct = s.extract()?;
</span><span class="boring">        assert_eq!(tup.0, "test");
</span><span class="boring">
</span><span class="boring">        let stru: RustyTransparentStruct = s.extract()?;
</span><span class="boring">        assert_eq!(stru.inner, "test");
</span><span class="boring">
</span><span class="boring">        Ok(())
</span><span class="boring">    })
</span><span class="boring">}</span></code></pre>
<h3 id="ä¸ºæšä¸¾æ´¾ç”Ÿ-frompyobject"><a class="header" href="#ä¸ºæšä¸¾æ´¾ç”Ÿ-frompyobject">ä¸ºæšä¸¾æ´¾ç”Ÿ <a href="conversions/{{#PYO3_DOCS_URL}}/pyo3/conversion/trait.FromPyObject.html"><code>FromPyObject</code></a></a></h3>
<p>æšä¸¾çš„ <code>FromPyObject</code> æ´¾ç”Ÿä¼šç”Ÿæˆä»£ç ï¼ŒæŒ‰å­—æ®µé¡ºåºå°è¯•æå–å„ä¸ªå˜ä½“ã€‚ä¸€æ—¦æŸä¸ªå˜ä½“æˆåŠŸæå–ï¼Œå°±è¿”å›è¯¥å˜ä½“ã€‚è¿™ä½¿å¾—å¯ä»¥æå– Python è”åˆç±»å‹ï¼Œä¾‹å¦‚ <code>str | int</code>ã€‚</p>
<p>ç»“æ„ä½“æ´¾ç”Ÿä¸­æè¿°çš„ç›¸åŒè‡ªå®šä¹‰å’Œé™åˆ¶ä¹Ÿé€‚ç”¨äºæšä¸¾å˜ä½“ï¼Œå³å…ƒç»„å˜ä½“å‡å®šè¾“å…¥æ˜¯ Python å…ƒç»„ï¼Œç»“æ„ä½“å˜ä½“é»˜è®¤ä»å±æ€§æå–å­—æ®µä½†å¯ä»¥è¿›è¡ŒåŒæ ·æ–¹å¼çš„é…ç½®ã€‚<code>transparent</code> å±æ€§å¯ç”¨äºå•å­—æ®µå˜ä½“ã€‚</p>
<pre><code class="language-rust">use pyo3::prelude::*;
use pyo3_ffi::c_str;


#[derive(FromPyObject)]
<span class="boring">#[derive(Debug)]
</span>enum RustyEnum&lt;'py&gt; {
    Int(usize),                    // è¾“å…¥ä¸ºæ­£æ•´æ•°
    String(String),                // è¾“å…¥ä¸ºå­—ç¬¦ä¸²
    IntTuple(usize, usize),        // è¾“å…¥ä¸ºåŒ…å«æ­£æ•´æ•°çš„äºŒå…ƒç»„
    StringIntTuple(String, usize), // è¾“å…¥ä¸ºåŒ…å«å­—ç¬¦ä¸²å’Œæ•´æ•°çš„äºŒå…ƒç»„
    Coordinates3d {
        // å¿…é¡»åœ¨ 2d ä¹‹å‰
        x: usize,
        y: usize,
        z: usize,
    },
    Coordinates2d {
        // ä»…å½“è¾“å…¥æ²¡æœ‰ `z` æ—¶æ‰æ£€æŸ¥
        #[pyo3(attribute("x"))]
        a: usize,
        #[pyo3(attribute("y"))]
        b: usize,
    },
    #[pyo3(transparent)]
    CatchAll(Bound&lt;'py, PyAny&gt;), // æ­¤æå–æ°¸è¿œä¸ä¼šå¤±è´¥
}
<span class="boring">
</span><span class="boring">use pyo3::types::{PyBytes, PyString};
</span><span class="boring">fn main() -&gt; PyResult&lt;()&gt; {
</span><span class="boring">    Python::attach(|py| -&gt; PyResult&lt;()&gt; {
</span><span class="boring">        {
</span><span class="boring">            let thing = 42_u8.into_pyobject(py)?;
</span><span class="boring">            let rust_thing: RustyEnum&lt;'_&gt; = thing.extract()?;
</span><span class="boring">
</span><span class="boring">            assert_eq!(
</span><span class="boring">                42,
</span><span class="boring">                match rust_thing {
</span><span class="boring">                    RustyEnum::Int(i) =&gt; i,
</span><span class="boring">                    other =&gt; unreachable!("Error extracting: {:?}", other),
</span><span class="boring">                }
</span><span class="boring">            );
</span><span class="boring">        }
</span><span class="boring">        {
</span><span class="boring">            let thing = PyString::new(py, "text");
</span><span class="boring">            let rust_thing: RustyEnum&lt;'_&gt; = thing.extract()?;
</span><span class="boring">
</span><span class="boring">            assert_eq!(
</span><span class="boring">                "text",
</span><span class="boring">                match rust_thing {
</span><span class="boring">                    RustyEnum::String(i) =&gt; i,
</span><span class="boring">                    other =&gt; unreachable!("Error extracting: {:?}", other),
</span><span class="boring">                }
</span><span class="boring">            );
</span><span class="boring">        }
</span><span class="boring">        {
</span><span class="boring">            let thing = (32_u8, 73_u8).into_pyobject(py)?;
</span><span class="boring">            let rust_thing: RustyEnum&lt;'_&gt; = thing.extract()?;
</span><span class="boring">
</span><span class="boring">            assert_eq!(
</span><span class="boring">                (32, 73),
</span><span class="boring">                match rust_thing {
</span><span class="boring">                    RustyEnum::IntTuple(i, j) =&gt; (i, j),
</span><span class="boring">                    other =&gt; unreachable!("Error extracting: {:?}", other),
</span><span class="boring">                }
</span><span class="boring">            );
</span><span class="boring">        }
</span><span class="boring">        {
</span><span class="boring">            let thing = ("foo", 73_u8).into_pyobject(py)?;
</span><span class="boring">            let rust_thing: RustyEnum&lt;'_&gt; = thing.extract()?;
</span><span class="boring">
</span><span class="boring">            assert_eq!(
</span><span class="boring">                (String::from("foo"), 73),
</span><span class="boring">                match rust_thing {
</span><span class="boring">                    RustyEnum::StringIntTuple(i, j) =&gt; (i, j),
</span><span class="boring">                    other =&gt; unreachable!("Error extracting: {:?}", other),
</span><span class="boring">                }
</span><span class="boring">            );
</span><span class="boring">        }
</span><span class="boring">        {
</span><span class="boring">            let module = PyModule::from_code(
</span><span class="boring">                py,
</span><span class="boring">                c_str!("class Foo(dict):
</span><span class="boring">            def __init__(self):
</span><span class="boring">                self.x = 0
</span><span class="boring">                self.y = 1
</span><span class="boring">                self.z = 2"),
</span><span class="boring">                c_str!("&lt;string&gt;"),
</span><span class="boring">                c_str!(""),
</span><span class="boring">            )?;
</span><span class="boring">
</span><span class="boring">            let class = module.getattr("Foo")?;
</span><span class="boring">            let instance = class.call0()?;
</span><span class="boring">            let rust_thing: RustyEnum&lt;'_&gt; = instance.extract()?;
</span><span class="boring">
</span><span class="boring">            assert_eq!(
</span><span class="boring">                (0, 1, 2),
</span><span class="boring">                match rust_thing {
</span><span class="boring">                    RustyEnum::Coordinates3d { x, y, z } =&gt; (x, y, z),
</span><span class="boring">                    other =&gt; unreachable!("Error extracting: {:?}", other),
</span><span class="boring">                }
</span><span class="boring">            );
</span><span class="boring">        }
</span><span class="boring">
</span><span class="boring">        {
</span><span class="boring">            let module = PyModule::from_code(
</span><span class="boring">                py,
</span><span class="boring">                c_str!("class Foo(dict):
</span><span class="boring">            def __init__(self):
</span><span class="boring">                self.x = 3
</span><span class="boring">                self.y = 4"),
</span><span class="boring">                c_str!("&lt;string&gt;"),
</span><span class="boring">                c_str!(""),
</span><span class="boring">            )?;
</span><span class="boring">
</span><span class="boring">            let class = module.getattr("Foo")?;
</span><span class="boring">            let instance = class.call0()?;
</span><span class="boring">            let rust_thing: RustyEnum&lt;'_&gt; = instance.extract()?;
</span><span class="boring">
</span><span class="boring">            assert_eq!(
</span><span class="boring">                (3, 4),
</span><span class="boring">                match rust_thing {
</span><span class="boring">                    RustyEnum::Coordinates2d { a, b } =&gt; (a, b),
</span><span class="boring">                    other =&gt; unreachable!("Error extracting: {:?}", other),
</span><span class="boring">                }
</span><span class="boring">            );
</span><span class="boring">        }
</span><span class="boring">
</span><span class="boring">        {
</span><span class="boring">            let thing = PyBytes::new(py, b"text");
</span><span class="boring">            let rust_thing: RustyEnum&lt;'_&gt; = thing.extract()?;
</span><span class="boring">
</span><span class="boring">            assert_eq!(
</span><span class="boring">                b"text",
</span><span class="boring">                match rust_thing {
</span><span class="boring">                    RustyEnum::CatchAll(ref i) =&gt; i.cast::&lt;PyBytes&gt;()?.as_bytes(),
</span><span class="boring">                    other =&gt; unreachable!("Error extracting: {:?}", other),
</span><span class="boring">                }
</span><span class="boring">            );
</span><span class="boring">        }
</span><span class="boring">        Ok(())
</span><span class="boring">    })
</span><span class="boring">}
</span>```å¦‚æœæ²¡æœ‰ä»»ä½•æšä¸¾å˜ä½“åŒ¹é…ï¼Œå°†è¿”å›ä¸€ä¸ªåŒ…å«è¢«æµ‹è¯•å˜ä½“åç§°çš„ `PyTypeError`ã€‚é”™è¯¯æ¶ˆæ¯ä¸­æŠ¥å‘Šçš„åç§°å¯ä»¥é€šè¿‡ `#[pyo3(annotation = "name")]` å±æ€§è¿›è¡Œè‡ªå®šä¹‰ï¼Œä¾‹å¦‚ä½¿ç”¨ä¼ ç»Ÿçš„ Python ç±»å‹åç§°ï¼š


```rust
use pyo3::prelude::*;


#[derive(FromPyObject)]
<span class="boring">#[derive(Debug)]
</span>enum RustyEnum {
    #[pyo3(transparent, annotation = "str")]
    String(String),
    #[pyo3(transparent, annotation = "int")]
    Int(isize),
}
<span class="boring">
</span><span class="boring">fn main() -&gt; PyResult&lt;()&gt; {
</span><span class="boring">    Python::attach(|py| -&gt; PyResult&lt;()&gt; {
</span><span class="boring">        {
</span><span class="boring">            let thing = 42_u8.into_pyobject(py)?;
</span><span class="boring">            let rust_thing: RustyEnum = thing.extract()?;
</span><span class="boring">
</span><span class="boring">            assert_eq!(
</span><span class="boring">                42,
</span><span class="boring">                match rust_thing {
</span><span class="boring">                    RustyEnum::Int(i) =&gt; i,
</span><span class="boring">                    other =&gt; unreachable!("Error extracting: {:?}", other),
</span><span class="boring">                }
</span><span class="boring">            );
</span><span class="boring">        }
</span><span class="boring">
</span><span class="boring">        {
</span><span class="boring">            let thing = "foo".into_pyobject(py)?;
</span><span class="boring">            let rust_thing: RustyEnum = thing.extract()?;
</span><span class="boring">
</span><span class="boring">            assert_eq!(
</span><span class="boring">                "foo",
</span><span class="boring">                match rust_thing {
</span><span class="boring">                    RustyEnum::String(i) =&gt; i,
</span><span class="boring">                    other =&gt; unreachable!("Error extracting: {:?}", other),
</span><span class="boring">                }
</span><span class="boring">            );
</span><span class="boring">        }
</span><span class="boring">
</span><span class="boring">        {
</span><span class="boring">            let thing = b"foo".into_pyobject(py)?;
</span><span class="boring">            let error = thing.extract::&lt;RustyEnum&gt;().unwrap_err();
</span><span class="boring">            assert!(error.is_instance_of::&lt;pyo3::exceptions::PyTypeError&gt;(py));
</span><span class="boring">        }
</span><span class="boring">
</span><span class="boring">        Ok(())
</span><span class="boring">    })
</span><span class="boring">}</span></code></pre>
<p>å¦‚æœè¾“å…¥æ—¢ä¸æ˜¯å­—ç¬¦ä¸²ä¹Ÿä¸æ˜¯æ•´æ•°ï¼Œé”™è¯¯æ¶ˆæ¯å°†æ˜¯ï¼š<code>"'&lt;INPUT_TYPE&gt;' cannot be cast as 'str | int'"</code>ã€‚</p>
<h3 id="derivefrompyobject-å®¹å™¨å±æ€§"><a class="header" href="#derivefrompyobject-å®¹å™¨å±æ€§"><code>#[derive(FromPyObject)]</code> å®¹å™¨å±æ€§</a></h3>
<ul>
<li><code>pyo3(transparent)</code>
<ul>
<li>ç›´æ¥ä»å¯¹è±¡ä¸­æå–å­—æ®µï¼Œä½¿ç”¨ <code>obj.extract()</code> è€Œä¸æ˜¯ <code>get_item()</code> æˆ– <code>getattr()</code></li>
<li>å•å­—æ®µæ–°ç±»å‹ç»“æ„ä½“å’Œå…ƒç»„å˜ä½“é»˜è®¤è§†ä¸ºé€æ˜ã€‚</li>
<li>ä»…æ”¯æŒå•å­—æ®µç»“æ„ä½“å’Œæšä¸¾å˜ä½“</li>
</ul>
</li>
<li><code>pyo3(annotation = "name")</code>
<ul>
<li>åœ¨åŒ¹é…å¤±è´¥æ—¶ï¼Œä¿®æ”¹ç”Ÿæˆçš„é”™è¯¯æ¶ˆæ¯ä¸­å¤±è´¥å˜ä½“çš„åç§°</li>
<li>ä¾‹å¦‚ï¼Œ<code>pyo3("int")</code> å°†è¯¥å˜ä½“ç±»å‹æŠ¥å‘Šä¸º <code>int</code></li>
<li>ä»…æ”¯æŒæšä¸¾å˜ä½“</li>
</ul>
</li>
<li><code>pyo3(rename_all = "...")</code>
<ul>
<li>æŒ‰ç…§æŒ‡å®šçš„å‘½åè§„åˆ™é‡å‘½åæ‰€æœ‰å±æ€§/é¡¹é”®</li>
<li>å¯é€‰å€¼ä¸ºï¼šâ€œcamelCaseâ€ã€â€œkebab-caseâ€ã€â€œlowercaseâ€ã€â€œPascalCaseâ€ã€â€œSCREAMING-KEBAB-CASEâ€ã€â€œSCREAMING_SNAKE_CASEâ€ã€â€œsnake_caseâ€ã€â€œUPPERCASEâ€</li>
<li>ä½¿ç”¨ <code>attribute(...)</code>/<code>item(...)</code> æ˜¾å¼é‡å‘½åçš„å­—æ®µä¸å—å½±å“</li>
</ul>
</li>
</ul>
<h3 id="derivefrompyobject-å­—æ®µå±æ€§"><a class="header" href="#derivefrompyobject-å­—æ®µå±æ€§"><code>#[derive(FromPyObject)]</code> å­—æ®µå±æ€§</a></h3>
<ul>
<li><code>pyo3(attribute)</code>ï¼Œ<code>pyo3(attribute("name"))</code>
<ul>
<li>ä»å±æ€§ä¸­è·å–å­—æ®µï¼Œå¯èƒ½é€šè¿‡å‚æ•°æŒ‡å®šè‡ªå®šä¹‰åç§°</li>
<li>å‚æ•°å¿…é¡»æ˜¯å­—ç¬¦ä¸²å­—é¢é‡</li>
</ul>
</li>
<li><code>pyo3(item)</code>ï¼Œ<code>pyo3(item("key"))</code>
<ul>
<li>ä»æ˜ å°„ä¸­è·å–å­—æ®µï¼Œå¯èƒ½é€šè¿‡å‚æ•°æŒ‡å®šè‡ªå®šä¹‰é”®</li>
<li>å¯ä»¥æ˜¯ä»»ä½•å®ç° <code>ToBorrowedObject</code> çš„å­—é¢é‡</li>
</ul>
</li>
<li><code>pyo3(from_py_with = ...)</code>
<ul>
<li>åº”ç”¨è‡ªå®šä¹‰å‡½æ•°å°†å­—æ®µä» Python è½¬æ¢ä¸ºæ‰€éœ€çš„ Rust ç±»å‹</li>
<li>å‚æ•°å¿…é¡»æ˜¯å‡½æ•°è·¯å¾„</li>
<li>å‡½æ•°ç­¾åå¿…é¡»ä¸º <code>fn(&amp;Bound&lt;PyAny&gt;) -&gt; PyResult&lt;T&gt;</code>ï¼Œå…¶ä¸­ <code>T</code> æ˜¯è¯¥å‚æ•°çš„ Rust ç±»å‹</li>
</ul>
</li>
<li><code>pyo3(default)</code>ï¼Œ<code>pyo3(default = ...)</code>
<ul>
<li>å¦‚æœè®¾ç½®äº†è¯¥å‚æ•°ï¼Œåˆ™ä½¿ç”¨ç»™å®šçš„é»˜è®¤å€¼</li>
<li>æ­¤æ—¶å‚æ•°å¿…é¡»æ˜¯ä¸€ä¸ªè¿”å›æ‰€éœ€ Rust ç±»å‹å€¼çš„ Rust è¡¨è¾¾å¼</li>
<li>å¦‚æœæœªè®¾ç½®å‚æ•°ï¼Œåˆ™ä½¿ç”¨ <a href="https://doc.rust-lang.org/std/default/trait.Default.html#tymethod.default"><code>Default::default</code></a></li>
<li>æ³¨æ„ï¼Œé»˜è®¤å€¼ä»…åœ¨å­—æ®µæœªè®¾ç½®æ—¶ä½¿ç”¨ï¼›å¦‚æœå­—æ®µå·²è®¾ç½®ä½†ä» Python åˆ° Rust çš„è½¬æ¢å¤±è´¥ï¼Œåˆ™ä¼šæŠ›å‡ºå¼‚å¸¸ä¸”ä¸ä½¿ç”¨é»˜è®¤å€¼</li>
<li>è¯¥å±æ€§ä»…é€‚ç”¨äºå…·åå­—æ®µ</li>
</ul>
</li>
</ul>
<p>ä¾‹å¦‚ï¼Œä»¥ä¸‹ä»£ç å¯¹å­—å…¸é¡¹ <code>"value"</code> åº”ç”¨ç»™å®šçš„è½¬æ¢å‡½æ•°ä»¥è®¡ç®—å…¶é•¿åº¦ï¼Œè‹¥æ— è¯¥é¡¹åˆ™å›é€€åˆ°ç±»å‹çš„é»˜è®¤å€¼ï¼ˆ0ï¼‰ï¼š</p>
<pre><code class="language-rust">use pyo3::prelude::*;


#[derive(FromPyObject)]
struct RustyStruct {
    #[pyo3(item("value"), default, from_py_with = Bound::&lt;'_, PyAny&gt;::len)]
    len: usize,
    #[pyo3(item)]
    other: usize,
}
<span class="boring">
</span><span class="boring">use pyo3::types::PyDict;
</span><span class="boring">fn main() -&gt; PyResult&lt;()&gt; {
</span><span class="boring">    Python::attach(|py| -&gt; PyResult&lt;()&gt; {
</span><span class="boring">        // å¡«å……æƒ…å†µ
</span><span class="boring">        let dict = PyDict::new(py);
</span><span class="boring">        dict.set_item("value", (1,)).unwrap();
</span><span class="boring">        dict.set_item("other", 1).unwrap();
</span><span class="boring">        let result = dict.extract::&lt;RustyStruct&gt;()?;
</span><span class="boring">        assert_eq!(result.len, 1);
</span><span class="boring">        assert_eq!(result.other, 1);
</span><span class="boring">
</span><span class="boring">        // ç©ºæƒ…å†µ
</span><span class="boring">        let dict = PyDict::new(py);
</span><span class="boring">        dict.set_item("other", 1).unwrap();
</span><span class="boring">        let result = dict.extract::&lt;RustyStruct&gt;()?;
</span><span class="boring">        assert_eq!(result.len, 0);
</span><span class="boring">        assert_eq!(result.other, 1);
</span><span class="boring">        Ok(())
</span><span class="boring">    })
</span><span class="boring">}</span></code></pre>
<h3 id="-é€æ­¥æ·˜æ±°-frompyobject-å¯¹å¯å…‹éš†-pyclass-çš„æ³›å‹å®ç°-"><a class="header" href="#-é€æ­¥æ·˜æ±°-frompyobject-å¯¹å¯å…‹éš†-pyclass-çš„æ³›å‹å®ç°-">âš  é€æ­¥æ·˜æ±° <code>FromPyObject</code> å¯¹å¯å…‹éš† PyClass çš„æ³›å‹å®ç° âš </a></h3>
<p>å†å²ä¸Šï¼ŒPyO3 ä¸ºåŒæ—¶å®ç° <code>Clone</code> çš„ <code>#[pyclass]</code> ç±»å‹æä¾›äº†æ³›å‹å®ç°ï¼Œä»¥å…è®¸æŒ‰å€¼æå–æ­¤ç±»ç±»å‹ã€‚éšç€æ—¶é—´æ¨ç§»ï¼Œè¿™åœ¨å‡ ä¸ªæ–¹é¢è¢«è¯æ˜å­˜åœ¨é—®é¢˜ï¼Œæœ€ä¸»è¦çš„æ˜¯å½“ä¸‹æ¸¸ crate ä¸­çš„ç±»å‹å®ç°äº† <code>Clone</code> åï¼Œå°±æ— æ³•å†æä¾›è‡ªå®šä¹‰è½¬æ¢ã€‚åœ¨æ¥ä¸‹æ¥çš„å‡ ä¸ªç‰ˆæœ¬ä¸­ï¼Œè¯¥æ³›å‹å®ç°å°†é€æ¸è¢«æ·˜æ±°ï¼Œå¹¶æœ€ç»ˆè¢«é€‰æ‹©æ€§å¯ç”¨çš„é€‰é¡¹æ‰€å–ä»£ã€‚ä½œä¸ºè¿å¾™çš„ç¬¬ä¸€æ­¥ï¼Œ<code>#[pyclass]</code> å¼•å…¥äº†æ–°çš„ <code>skip_from_py_object</code> é€‰é¡¹ï¼Œç”¨äºé€‰æ‹©ä¸ä½¿ç”¨æ³›å‹å®ç°ï¼Œä»è€Œå…è®¸ä¸‹æ¸¸ç”¨æˆ·è‡ªè¡Œæä¾›å®ç°ï¼š</p>
<pre><code class="language-rust"><span class="boring">#![allow(dead_code)]
</span><span class="boring">use pyo3::prelude::*;
</span>

#[pyclass(skip_from_py_object)] // é€‰æ‹©ä¸ä½¿ç”¨ PyO3 çš„ FromPyObject æ³›å‹å®ç°
#[derive(Clone)]
struct Number(i32);


impl&lt;'py&gt; FromPyObject&lt;'_, 'py&gt; for Number {
    type Error = PyErr;


    fn extract(obj: pyo3::Borrowed&lt;'_, 'py, pyo3::PyAny&gt;) -&gt; Result&lt;Self, Self::Error&gt; {
        if let Ok(obj) = obj.cast::&lt;Self&gt;() { // é¦–å…ˆå°è¯•é€šè¿‡ç±»å¯¹è±¡æå–
            Ok(obj.borrow().clone())
        } else {
            obj.extract::&lt;i32&gt;().map(Self) // å¦åˆ™å°è¯•ç›´æ¥æå–æ•´æ•°
        }
    }
}</code></pre>
<p>ä½œä¸ºç¬¬äºŒæ­¥ï¼Œå¼•å…¥äº† <code>from_py_object</code> é€‰é¡¹ã€‚è¯¥é€‰é¡¹åŒæ ·é€‰æ‹©ä¸ä½¿ç”¨æ³›å‹å®ç°ï¼Œè€Œæ˜¯ä¸ºè¯¥ pyclass ç”Ÿæˆä¸€ä¸ªè‡ªå®šä¹‰çš„ <code>FromPyObject</code> å®ç°ï¼Œå…¶åŠŸèƒ½ä¸æ³›å‹å®ç°ç­‰æ•ˆã€‚</p>
<h2 id="intopyobject"><a class="header" href="#intopyobject"><code>IntoPyObject</code></a></h2>
<p><a href="conversions/{{#PYO3_DOCS_URL}}/pyo3/conversion/trait.IntoPyObject.html"><code>IntoPyObject</code></a> trait å®šä¹‰äº† Rust ç±»å‹åˆ° Python çš„è½¬æ¢ã€‚PyO3 ä¸­çš„æ‰€æœ‰ç±»å‹éƒ½å®ç°äº†è¯¥ traitï¼Œä½¿ç”¨ <code>extends</code> çš„ <code>#[pyclass]</code> é™¤å¤–ã€‚</p>
<p>è¯¥ trait å®šä¹‰äº†ä¸€ä¸ªæ–¹æ³• <code>into_pyobject()</code>ï¼Œè¿”å›ä¸€ä¸ª <a href="https://doc.rust-lang.org/stable/std/result/enum.Result.html"><code>Result</code></a>ï¼Œå…¶ <code>Ok</code> å’Œ <code>Err</code> ç±»å‹å–å†³äºè¾“å…¥å€¼ã€‚ä¸ºæ–¹ä¾¿èµ·è§ï¼Œè¿˜æœ‰ä¸€ä¸ªè¾…åŠ©çš„ <a href="conversions/{{#PYO3_DOCS_URL}}/pyo3/conversion/trait.IntoPyObjectExt.html"><code>IntoPyObjectExt</code></a> traitï¼Œæ·»åŠ äº†ä¸€äº›æ–¹æ³•ï¼Œä¾‹å¦‚ <code>into_py_any()</code>ï¼Œå°† <code>Ok</code> å’Œ <code>Err</code> ç±»å‹è½¬æ¢ä¸ºå¸¸ç”¨ç±»å‹ï¼ˆå¯¹äº <code>into_py_any()</code>ï¼Œåˆ†åˆ«æ˜¯ <code>Py&lt;PyAny&gt;</code> å’Œ <code>PyErr</code>ï¼‰ã€‚</p>
<p>æœ‰æ—¶ä½ å¯èƒ½å¸Œæœ›ä¸ºæ˜ å°„åˆ° Python ç±»å‹ä½†æ²¡æœ‰å”¯ä¸€ Python ç±»å‹çš„è‡ªå®šä¹‰ç±»å‹å®ç°æ­¤ traitã€‚</p>
<h3 id="æ´¾ç”Ÿå®"><a class="header" href="#æ´¾ç”Ÿå®">æ´¾ç”Ÿå®</a></h3>
<p><code>IntoPyObject</code> å¯ä»¥é€šè¿‡æˆ‘ä»¬çš„æ´¾ç”Ÿå®å®ç°ã€‚æ”¯æŒ <code>struct</code> å’Œ <code>enum</code>ã€‚</p>
<p><code>struct</code> å°†ä½¿ç”¨å­—æ®µåä½œä¸ºé”®è½¬æ¢ä¸º <code>PyDict</code>ï¼Œå…ƒç»„ç»“æ„ä½“å°†æŒ‰å­—æ®µå£°æ˜é¡ºåºè½¬æ¢ä¸º <code>PyTuple</code>ã€‚</p>
<pre><code class="language-rust no_run"><span class="boring">#![allow(dead_code)]
</span><span class="boring">use pyo3::prelude::*;
</span><span class="boring">use std::collections::HashMap;
</span><span class="boring">use std::hash::Hash;
</span>

// ç»“æ„ä½“è½¬æ¢ä¸ºä»¥å­—æ®µåä¸ºé”®çš„ `PyDict`
#[derive(IntoPyObject)]
struct Struct {
    count: usize,
    obj: Py&lt;PyAny&gt;,
}


// å…ƒç»„ç»“æ„ä½“è½¬æ¢ä¸º `PyTuple`
// æ”¯æŒç”Ÿå‘½å‘¨æœŸå’Œæ³›å‹ï¼Œå®ç°å°†å— `K: IntoPyObject, V: IntoPyObject` çº¦æŸ
#[derive(IntoPyObject)]
struct Tuple&lt;'a, K: Hash + Eq, V&gt;(&amp;'a str, HashMap&lt;K, V&gt;);</code></pre>
<p>å¯¹äºå•å­—æ®µç»“æ„ä½“ï¼ˆæ–°ç±»å‹æ¨¡å¼ï¼‰ï¼Œå¯ä»¥ä½¿ç”¨ <code>#[pyo3(transparent)]</code> é€‰é¡¹å°†å®ç°è½¬å‘ç»™å†…éƒ¨ç±»å‹ã€‚</p>
<pre><code class="language-rust"><span class="boring">#![allow(dead_code)]
</span><span class="boring">use pyo3::prelude::*;
</span>

// æ–°ç±»å‹å…ƒç»„ç»“æ„ä½“éšå¼ä¸º `transparent`
#[derive(IntoPyObject)]
struct TransparentTuple(Py&lt;PyAny&gt;);


#[derive(IntoPyObject)]
#[pyo3(transparent)]
struct TransparentStruct&lt;'py&gt; {
    inner: Bound&lt;'py, PyAny&gt;, // `'py` ç”Ÿå‘½å‘¨æœŸå°†ç”¨ä½œ Python ç”Ÿå‘½å‘¨æœŸ
}</code></pre>
<p>å¯¹äº <code>enum</code>ï¼Œæ¯ä¸ªå˜ä½“å°†æ ¹æ®ä¸Šè¿°ç»“æ„ä½“çš„è§„åˆ™è¿›è¡Œè½¬æ¢ã€‚</p>
<pre><code class="language-rust"><span class="boring">#![allow(dead_code)]
</span><span class="boring">use pyo3::prelude::*;
</span><span class="boring">use std::collections::HashMap;
</span><span class="boring">use std::hash::Hash;
</span>

#[derive(IntoPyObject)]
enum Enum&lt;'a, 'py, K: Hash + Eq, V&gt; { // æ”¯æŒæšä¸¾ï¼Œå¹¶å¯¹å˜ä½“ä½¿ç”¨ä¸ä¸Šè¿°ç»“æ„ä½“ç›¸åŒçš„è§„åˆ™
    TransparentTuple(Py&lt;PyAny&gt;),       // æ–°ç±»å‹å…ƒç»„
    #[pyo3(transparent)]
    TransparentStruct { inner: Bound&lt;'py, PyAny&gt; }, // é€æ˜ç»“æ„ä½“
    Tuple(&amp;'a str, HashMap&lt;K, V&gt;),    // å…ƒç»„å˜ä½“
    Struct { count: usize, obj: Py&lt;PyAny&gt; } // ç»“æ„ä½“å˜ä½“
}</code></pre>
<p>æ­¤å¤–ï¼Œè¿˜å¯ä»¥é€šè¿‡ <code>IntoPyObjectRef</code> æ´¾ç”Ÿå®ä¸ºç»“æ„ä½“æˆ–æšä¸¾çš„å¼•ç”¨æ´¾ç”Ÿ <code>IntoPyObject</code>ã€‚ä¸Šè¿°æ‰€æœ‰è§„åˆ™åŒæ ·é€‚ç”¨ã€‚</p>
<h4 id="deriveintopyobjectderiveintopyobjectref-å­—æ®µå±æ€§"><a class="header" href="#deriveintopyobjectderiveintopyobjectref-å­—æ®µå±æ€§"><code>#[derive(IntoPyObject)]</code>/<code>#[derive(IntoPyObjectRef)]</code> å­—æ®µå±æ€§</a></h4>
<ul>
<li><code>pyo3(into_py_with = ...)</code>
<ul>
<li>
<p>åº”ç”¨è‡ªå®šä¹‰å‡½æ•°å°†å­—æ®µä» Rust è½¬æ¢ä¸º Python</p>
</li>
<li>
<p>å‚æ•°å¿…é¡»æ˜¯å‡½æ•°æ ‡è¯†ç¬¦</p>
</li>
<li>
<p>å‡½æ•°ç­¾åå¿…é¡»ä¸º <code>fn(Cow&lt;'_, T&gt;, Python&lt;'py&gt;) -&gt; PyResult&lt;Bound&lt;'py, PyAny&gt;&gt;</code>ï¼Œå…¶ä¸­ <code>T</code> æ˜¯è¯¥å‚æ•°çš„ Rust ç±»å‹</p>
<ul>
<li><code>#[derive(IntoPyObject)]</code> ä¼šä»¥ <code>Cow::Owned</code> è°ƒç”¨è¯¥å‡½æ•°</li>
<li><code>#[derive(IntoPyObjectRef)]</code> ä¼šä»¥ <code>Cow::Borrowed</code> è°ƒç”¨è¯¥å‡½æ•°</li>
</ul>
<pre><code class="language-rust no_run"><span class="boring">use pyo3::prelude::*;
</span><span class="boring">use pyo3::IntoPyObjectExt;
</span><span class="boring">use std::borrow::Cow;
</span>#[derive(Clone)]
struct NotIntoPy(usize);


#[derive(IntoPyObject, IntoPyObjectRef)]
struct MyStruct {</code></pre>
</li>
</ul>
</li>
</ul>
<pre><code class="language-#[pyo3(into_py_with = convert)]">        not_into_py: NotIntoPy,
    }


    /// å°† `NotIntoPy` è½¬æ¢ä¸º Python å¯¹è±¡
    fn convert&lt;'py&gt;(not_into_py: Cow&lt;'_, NotIntoPy&gt;, py: Python&lt;'py&gt;) -&gt; PyResult&lt;Bound&lt;'py, PyAny&gt;&gt; {
        not_into_py.0.into_bound_py_any(py)
    }
    ```


### æ‰‹åŠ¨å®ç°


å¦‚æœæ´¾ç”Ÿå®ä¸é€‚ç”¨äºä½ çš„ä½¿ç”¨åœºæ™¯ï¼Œå¯ä»¥åƒä¸‹é¢è¿™æ ·æ‰‹åŠ¨å®ç° `IntoPyObject`ã€‚


```rust,no_run
# use pyo3::prelude::*;
# #[allow(dead_code)]
struct MyPyObjectWrapper(Py&lt;PyAny&gt;);


impl&lt;'py&gt; IntoPyObject&lt;'py&gt; for MyPyObjectWrapper {
    type Target = PyAny; // å¯¹åº”çš„ Python ç±»å‹
    type Output = Bound&lt;'py, Self::Target&gt;; // åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ä¸º `Bound`
    type Error = std::convert::Infallible; // è½¬æ¢é”™è¯¯ç±»å‹ï¼Œå¿…é¡»èƒ½è½¬æ¢ä¸º `PyErr`


    fn into_pyobject(self, py: Python&lt;'py&gt;) -&gt; Result&lt;Self::Output, Self::Error&gt; {
        Ok(self.0.into_bound(py))
    }
}


// ç­‰æ•ˆäºä¹‹å‰çš„ `ToPyObject` å®ç°
impl&lt;'a, 'py&gt; IntoPyObject&lt;'py&gt; for &amp;'a MyPyObjectWrapper {
    type Target = PyAny;
    type Output = Borrowed&lt;'a, 'py, Self::Target&gt;; // ä½¿ç”¨ `Borrowed` å¯ä¼˜åŒ–å¼•ç”¨è®¡æ•°
    type Error = std::convert::Infallible;


    fn into_pyobject(self, py: Python&lt;'py&gt;) -&gt; Result&lt;Self::Output, Self::Error&gt; {
        Ok(self.0.bind_borrowed(py))
    }
}
</code></pre>
<h3 id="ä½¿ç”¨-boundobject-å¤„ç†å¯èƒ½ä¸º-bound-æˆ–-borrowed-çš„è½¬æ¢"><a class="header" href="#ä½¿ç”¨-boundobject-å¤„ç†å¯èƒ½ä¸º-bound-æˆ–-borrowed-çš„è½¬æ¢">ä½¿ç”¨ <code>BoundObject</code> å¤„ç†å¯èƒ½ä¸º <code>Bound</code> æˆ– <code>Borrowed</code> çš„è½¬æ¢</a></h3>
<p><code>IntoPyObject::into_pyobject</code> æ ¹æ®å…·ä½“ç±»å‹çš„å®ç°è¿”å› <code>Bound</code> æˆ– <code>Borrowed</code>ã€‚ä¾‹å¦‚ï¼Œ<code>u32</code> çš„ <code>IntoPyObject</code> å®ç°äº§ç”Ÿ <code>Bound&lt;'py, PyInt&gt;</code>ï¼Œè€Œ <code>bool</code> çš„å®ç°äº§ç”Ÿ <code>Borrowed&lt;'py, 'py, PyBool&gt;</code>ï¼š</p>
<pre><code class="language-rust no_run">use pyo3::prelude::*;
use pyo3::IntoPyObject;
use pyo3::types::{PyBool, PyInt};


let ints: Vec&lt;u32&gt; = vec![1, 2, 3, 4];
let bools = vec![true, false, false, true];


Python::attach(|py| {
    let ints_as_pyint: Vec&lt;Bound&lt;'_, PyInt&gt;&gt; = ints
        .iter()
        .map(|x| Ok(x.into_pyobject(py)?))
        .collect::&lt;PyResult&lt;_&gt;&gt;()
        .unwrap();


    let bools_as_pybool: Vec&lt;Borrowed&lt;'_, '_, PyBool&gt;&gt; = bools
        .iter()
        .map(|x| Ok(x.into_pyobject(py)?))
        .collect::&lt;PyResult&lt;_&gt;&gt;()
        .unwrap();
});</code></pre>
<p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œå¦‚æœæˆ‘ä»¬æƒ³å°† <code>ints_as_pyints</code> å’Œ <code>bools_as_pybool</code> åˆå¹¶æˆä¸€ä¸ª <code>Vec&lt;Py&lt;PyAny&gt;&gt;</code> å¹¶ä» <code>Python::attach</code> é—­åŒ…ä¸­è¿”å›ï¼Œå°±éœ€è¦æ‰‹åŠ¨è½¬æ¢æ™ºèƒ½æŒ‡é’ˆå’Œ Python ç±»å‹çš„å…·ä½“ç±»å‹ã€‚</p>
<p>ç›¸åï¼Œæˆ‘ä»¬å¯ä»¥ç¼–å†™ä¸€ä¸ªæ³›å‹å‡½æ•°ï¼Œå°†åŒ…å«æ•´æ•°æˆ–å¸ƒå°”å€¼çš„å‘é‡ç»Ÿä¸€è½¬æ¢ä¸º <code>Vec&lt;Py&lt;PyAny&gt;&gt;</code>ï¼Œä½¿ç”¨çš„æ˜¯ <a href="conversions/{{#PYO3_DOCS_URL}}/pyo3/instance/trait.BoundObject.html"><code>BoundObject</code></a> traitï¼š</p>
<pre><code class="language-rust no_run"><span class="boring">use pyo3::prelude::*;
</span><span class="boring">use pyo3::BoundObject;
</span><span class="boring">use pyo3::IntoPyObject;
</span>

<span class="boring">let bools = vec![true, false, false, true];
</span><span class="boring">let ints = vec![1, 2, 3, 4];
</span>

fn convert_to_vec_of_pyobj&lt;'py, T&gt;(py: Python&lt;'py&gt;, the_vec: Vec&lt;T&gt;) -&gt; PyResult&lt;Vec&lt;Py&lt;PyAny&gt;&gt;&gt;
where
   T: IntoPyObject&lt;'py&gt; + Copy
{
    the_vec.iter()
        .map(|x| {
            Ok(
                // æ³¨æ„ï¼šè¿™ç­‰åŒäº `IntoPyObjectExt` trait ä¸­çš„ `x.into_py_any()`
                x.into_pyobject(py)
                .map_err(Into::into)?
                .into_any()
                .unbind()
            )
        })
        .collect()
}


let vec_of_pyobjs: Vec&lt;Py&lt;PyAny&gt;&gt; = Python::attach(|py| {
    let mut bools_as_pyany = convert_to_vec_of_pyobj(py, bools).unwrap();
    let mut ints_as_pyany = convert_to_vec_of_pyobj(py, ints).unwrap();
    let mut result: Vec&lt;Py&lt;PyAny&gt;&gt; = vec![];
    result.append(&amp;mut bools_as_pyany);
    result.append(&amp;mut ints_as_pyany);
    result
});</code></pre>
<p>åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨äº† <code>BoundObject::into_any</code> å’Œ <code>BoundObject::unbind</code> æ¥æ“ä½œ Python ç±»å‹å’Œæ™ºèƒ½æŒ‡é’ˆï¼Œä»¥å¾—åˆ°æˆ‘ä»¬æœŸæœ›çš„è¿”å›ç±»å‹ã€‚</p>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="ä½¿ç”¨-async-å’Œ-await"><a class="header" href="#ä½¿ç”¨-async-å’Œ-await">ä½¿ç”¨ <code>async</code> å’Œ <code>await</code></a></h1>
<p><em>æ­¤åŠŸèƒ½ä»åœ¨ç§¯æå¼€å‘ä¸­ã€‚è¯¦è§ <a href="https://github.com/PyO3/pyo3/issues/1632">ç›¸å…³ issue</a>ã€‚</em></p>
<p><code>#[pyfunction]</code> å’Œ <code>#[pymethods]</code> å±æ€§ä¹Ÿæ”¯æŒ <code>async fn</code>ã€‚</p>
<pre><code class="language-rust no_run"><span class="boring">#![allow(dead_code)]
</span><span class="boring">#[cfg(feature = "experimental-async")] {
</span>use std::{thread, time::Duration};
use futures::channel::oneshot;
use pyo3::prelude::*;


#[pyfunction]
#[pyo3(signature=(seconds, result=None))]
async fn sleep(seconds: f64, result: Option&lt;Py&lt;PyAny&gt;&gt;) -&gt; Option&lt;Py&lt;PyAny&gt;&gt; {
    let (tx, rx) = oneshot::channel();
    thread::spawn(move || {
        thread::sleep(Duration::from_secs_f64(seconds));
        tx.send(()).unwrap();
    });
    rx.await.unwrap();
    result
}
<span class="boring">}</span></code></pre>
<p><em>é€šè¿‡æ­¤æ–¹æ³•åˆ›å»ºçš„ Python å¯ç­‰å¾…å¯¹è±¡åªèƒ½åœ¨ <em>asyncio</em> ç¯å¢ƒä¸­è¢«ç­‰å¾…ã€‚æœªæ¥å¯èƒ½ä¼šæ”¯æŒå…¶ä»– Python å¼‚æ­¥è¿è¡Œæ—¶ã€‚</em></p>
<h2 id="send--static-çº¦æŸ"><a class="header" href="#send--static-çº¦æŸ"><code>Send + 'static</code> çº¦æŸ</a></h2>
<p>è¢« <code>#[pyfunction]</code> æ ‡è®°çš„ <code>async fn</code> æ‰€ç”Ÿæˆçš„ Future å¿…é¡»ä¸º <code>Send + 'static</code>ï¼Œä»¥ä¾¿åµŒå…¥åˆ° Python å¯¹è±¡ä¸­ã€‚</p>
<p>å› æ­¤ï¼Œ<code>async fn</code> çš„å‚æ•°å’Œè¿”å›ç±»å‹ä¹Ÿå¿…é¡»æ»¡è¶³ <code>Send + 'static</code>ï¼Œè¿™æ„å‘³ç€æ— æ³•æ‹¥æœ‰ç±»ä¼¼ <code>async fn does_not_compile&lt;'py&gt;(arg: Bound&lt;'py, PyAny&gt;) -&gt; Bound&lt;'py, PyAny&gt;</code> çš„ç­¾åã€‚</p>
<p>ç„¶è€Œï¼Œæ–¹æ³•æ¥æ”¶å™¨ï¼ˆreceiverï¼‰æ˜¯ä¸€ä¸ªä¾‹å¤–æƒ…å†µï¼Œå¼‚æ­¥æ–¹æ³•å¯ä»¥æ¥å— <code>&amp;self</code>/<code>&amp;mut self</code>ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™æ„å‘³ç€ç±»å®ä¾‹åœ¨æ•´ä¸ªè¿”å›çš„ Future å®Œæˆä¹‹å‰éƒ½ä¼šè¢«å€Ÿç”¨ï¼Œå³ä½¿åœ¨ yield ç‚¹ä¹‹é—´ä»¥åŠç­‰å¾… I/O æ“ä½œå®ŒæˆæœŸé—´ä¹Ÿæ˜¯å¦‚æ­¤ã€‚å› æ­¤ï¼Œåœ¨ Future ä»å¤„äºè¢«è½®è¯¢çŠ¶æ€æ—¶ï¼Œå…¶ä»–æ–¹æ³•æ— æ³•å–å¾—ç‹¬å å€Ÿç”¨ã€‚è¿™ä¸ Rust ä¸­å¼‚æ­¥æ–¹æ³•çš„ä¸€èˆ¬è¡Œä¸ºç›¸åŒï¼Œä½†ç”±äº Python ä¸­æ™®éå­˜åœ¨å…±äº«å¯å˜æ€§ï¼Œè¿™åœ¨ Rust ä¸ Python äº¤äº’ä»£ç ä¸­ä¼šå¸¦æ¥æ›´å¤§é—®é¢˜ã€‚å› æ­¤å¼ºçƒˆå»ºè®®ä¼˜å…ˆä½¿ç”¨å…±äº«å€Ÿç”¨ <code>&amp;self</code> è€Œéç‹¬å å€Ÿç”¨ <code>&amp;mut self</code>ï¼Œä»¥é¿å…åœ¨è¿è¡Œæ—¶å‡ºç°ç«äº‰æ€§çš„å€Ÿç”¨æ£€æŸ¥å¤±è´¥ã€‚</p>
<h2 id="éšå¼ç»‘å®šåˆ°è§£é‡Šå™¨"><a class="header" href="#éšå¼ç»‘å®šåˆ°è§£é‡Šå™¨">éšå¼ç»‘å®šåˆ°è§£é‡Šå™¨</a></h2>
<p>å³ä½¿æ— æ³•å°† <code>py: Python&lt;'py&gt;</code> ä»¤ç‰Œä¼ é€’ç»™ <code>async fn</code>ï¼Œåœ¨ Future æ‰§è¡ŒæœŸé—´æˆ‘ä»¬ä»ç„¶ç»‘å®šåˆ° Python è§£é‡Šå™¨â€”â€”è¿™ä¸€ç‚¹ä¸æ²¡æœ‰ <code>Python&lt;'py&gt;</code>/<code>Bound&lt;'py, PyAny&gt;</code> å‚æ•°çš„æ™®é€š <code>fn</code> ç›¸åŒã€‚</p>
<p>ä»ç„¶å¯ä»¥ä½¿ç”¨ <a href="{{#PYO3_DOCS_URL}}/pyo3/marker/struct.Python.html#method.attach"><code>Python::attach</code></a> è·å–ä¸€ä¸ª <code>Python</code> æ ‡è®°ï¼›ç”±äº <code>attach</code> æ˜¯å¯é‡å…¥ä¸”ç»è¿‡ä¼˜åŒ–çš„ï¼Œå…¶å¼€é”€å¯ä»¥å¿½ç•¥ä¸è®¡ã€‚</p>
<h2 id="åœ¨-await-æœŸé—´ä»è§£é‡Šå™¨è§£ç»‘"><a class="header" href="#åœ¨-await-æœŸé—´ä»è§£é‡Šå™¨è§£ç»‘">åœ¨ <code>.await</code> æœŸé—´ä»è§£é‡Šå™¨è§£ç»‘</a></h2>
<p>ç›®å‰å°šæ— ç®€å•æ–¹å¼åœ¨ç­‰å¾… Future æ—¶ä»è§£é‡Šå™¨è§£ç»‘ï¼Œ<em>ä½†ç›¸å…³è§£å†³æ–¹æ¡ˆæ­£åœ¨å¼€å‘ä¸­</em>ã€‚</p>
<p>ç›®å‰æ¨èçš„ä¸´æ—¶è§£å†³æ–¹æ¡ˆå¦‚ä¸‹ï¼š</p>
<pre><code class="language-rust ignore">use std::{
    future::Future,
    pin::{Pin, pin},
    task::{Context, Poll},
};
use pyo3::prelude::*;


struct AllowThreads&lt;F&gt;(F);


impl&lt;F&gt; Future for AllowThreads&lt;F&gt;
where
    F: Future + Unpin + Send,
    F::Output: Send,
{
    type Output = F::Output;

    fn poll(mut self: Pin&lt;&amp;mut Self&gt;, cx: &amp;mut Context&lt;'_&gt;) -&gt; Poll&lt;Self::Output&gt; {
        let waker = cx.waker();
        Python::attach(|py| {
            py.detach(|| pin!(&amp;mut self.0).poll(&amp;mut Context::from_waker(waker)))
        })
    }
}</code></pre>
<h2 id="å–æ¶ˆ"><a class="header" href="#å–æ¶ˆ">å–æ¶ˆ</a></h2>
<p>å¯ä»¥åœ¨ Python ç«¯é€šè¿‡ä½¿ç”¨ <a href="{{#PYO3_DOCS_URL}}/pyo3/coroutine/struct.CancelHandle.html"><code>CancelHandle</code></a> ç±»å‹å¹¶åœ¨å‡½æ•°å‚æ•°ä¸Šæ·»åŠ  <code>#[pyo3(cancel_handle)]</code> æ³¨è§£æ¥æ•è·å–æ¶ˆæ“ä½œã€‚</p>
<pre><code class="language-rust no_run"><span class="boring">#![allow(dead_code)]
</span><span class="boring">#[cfg(feature = "experimental-async")] {
</span>use futures::FutureExt;
use pyo3::prelude::*;
use pyo3::coroutine::CancelHandle;

#[pyfunction]
async fn cancellable(#[pyo3(cancel_handle)] mut cancel: CancelHandle) {
    futures::select! {
        /* _ = ... =&gt; println!("done"), */
        _ = cancel.cancelled().fuse() =&gt; println!("cancelled"),
    }
}
<span class="boring">}</span></code></pre>
<h2 id="coroutine-ç±»å‹"><a class="header" href="#coroutine-ç±»å‹"><code>Coroutine</code> ç±»å‹</a></h2>
<p>ä¸ºäº†è®© Rust çš„ Future å¯åœ¨ Python ä¸­è¢« awaitï¼ŒPyO3 å®šä¹‰äº†ä¸€ä¸ª <a href="{{#PYO3_DOCS_URL}}/pyo3/coroutine/struct.Coroutine.html"><code>Coroutine</code></a> ç±»å‹ï¼Œå®ƒå®ç°äº† Python çš„ <a href="https://docs.python.org/3/library/collections.abc.html#collections.abc.Coroutine">åç¨‹åè®®</a>ã€‚</p>
<p>æ¯æ¬¡å¯¹ <code>coroutine.send</code> çš„è°ƒç”¨éƒ½ä¼šè¢«è½¬æ¢ä¸ºä¸€æ¬¡ <code>Future::poll</code> è°ƒç”¨ã€‚å¦‚æœå£°æ˜äº† <a href="{{#PYO3_DOCS_URL}}/pyo3/coroutine/struct.CancelHandle.html"><code>CancelHandle</code></a> å‚æ•°ï¼Œåˆ™ä¼ é€’ç»™ <code>coroutine.throw</code> çš„å¼‚å¸¸å°†è¢«å­˜å‚¨åœ¨è¯¥å¥æŸ„ä¸­ï¼Œå¹¶å¯é€šè¿‡ <a href="{{#PYO3_DOCS_URL}}/pyo3/coroutine/struct.CancelHandle.html#method.cancelled"><code>CancelHandle::cancelled</code></a> å–å¾—ï¼›å¦åˆ™ï¼Œå®ƒå°†å–æ¶ˆåº•å±‚çš„ Rust Futureï¼Œå¹¶é‡æ–°æŠ›å‡ºè¯¥å¼‚å¸¸ã€‚</p>
<p><em>è¯¥ç±»å‹ç›®å‰å°šæœªæä¾›å…¬å¼€æ„é€ å‡½æ•°ï¼Œç›´åˆ°å…¶è®¾è®¡æœ€ç»ˆç¡®å®šä¸ºæ­¢ã€‚</em></p>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="å¹¶è¡Œæ€§"><a class="header" href="#å¹¶è¡Œæ€§">å¹¶è¡Œæ€§</a></h1>
<p>å†å²ä¸Šï¼ŒCPython å—é™äº<a href="https://docs.python.org/3/glossary.html#term-global-interpreter-lock">å…¨å±€è§£é‡Šå™¨é”</a>ï¼ˆGILï¼‰ï¼Œè¯¥æœºåˆ¶ä»…å…è®¸ä¸€ä¸ªçº¿ç¨‹åœ¨ä»»æ„æ—¶åˆ»è¿è¡Œ Python è§£é‡Šå™¨ã€‚è¿™ä½¿å¾— Python ä¸­çš„çº¿ç¨‹ä¸é€‚ç”¨äº<a href="https://zh.wikipedia.org/wiki/CPU_bound">è®¡ç®—å¯†é›†å‹</a>ä»»åŠ¡ï¼Œå¼€å‘è€…é€šå¸¸ä¸å¾—ä¸æ¥å—ä½¿ç”¨å¤šè¿›ç¨‹æ‰€å¸¦æ¥çš„å¼€é”€ã€‚</p>
<p>Rust éå¸¸é€‚åˆç¼–å†™å¤šçº¿ç¨‹ä»£ç ï¼Œåƒ <a href="https://github.com/rayon-rs/rayon"><code>rayon</code></a> è¿™æ ·çš„åº“å¯ä»¥å¸®åŠ©ä½ ä»¥æå°çš„ä»£ä»·å®ç°å®‰å…¨çš„å¹¶è¡Œã€‚é€šè¿‡ä½¿ç”¨ <a href="{{#PYO3_DOCS_URL}}/pyo3/marker/struct.Python.html#method.detach"><code>Python::detach</code></a> æ–¹æ³•ï¼Œå¯ä»¥åœ¨ Rust ä»£ç æ‰§è¡Œçš„åŒæ—¶ï¼Œå…è®¸ Python è§£é‡Šå™¨å¤„ç†å…¶ä»–ä»»åŠ¡ã€‚</p>
<p>ä¸ºäº†åœ¨ä½ çš„åº”ç”¨ä¸­å®ç°å®Œæ•´çš„å¹¶è¡Œèƒ½åŠ›ï¼Œå»ºè®®åŒæ—¶ä½¿ç”¨ <a href="#æ”¯æŒè‡ªç”±çº¿ç¨‹çš„-cpython">free-threaded Python</a>ï¼Œè¯¥ç‰¹æ€§è‡ª Python 3.14 èµ·å·²æ”¯æŒã€‚</p>
<h2 id="python-gil-ä¸‹çš„å¹¶è¡Œæ€§"><a class="header" href="#python-gil-ä¸‹çš„å¹¶è¡Œæ€§">Python GIL ä¸‹çš„å¹¶è¡Œæ€§</a></h2>
<p>è®©æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ª<a href="https://github.com/PyO3/pyo3/blob/main/examples/word-count/src/lib.rs">è¯é¢‘ç»Ÿè®¡</a>çš„ä¾‹å­ï¼Œå…¶ä¸­ <code>search</code> å‡½æ•°åˆ©ç”¨ <a href="https://github.com/rayon-rs/rayon"><code>rayon</code></a> åº“å¹¶è¡Œåœ°ç»Ÿè®¡å•è¯å‡ºç°æ¬¡æ•°ã€‚</p>
<pre><code class="language-rust no_run"><span class="boring">#![allow(dead_code)]
</span>use pyo3::prelude::*;

// è¿™äº› trait ä½¿å¾—æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ par_lines å’Œ mapã€‚
use rayon::str::ParallelString;
use rayon::iter::ParallelIterator;

/// ç»Ÿè®¡ needle åœ¨ line ä¸­å‡ºç°çš„æ¬¡æ•°ï¼ˆä¸åŒºåˆ†å¤§å°å†™ï¼‰
fn count_line(line: &amp;str, needle: &amp;str) -&gt; usize {
    let mut total = 0;
    for word in line.split(' ') {
        if word == needle {
            total += 1;
        }
    }
    total
}

#[pyfunction]
fn search(contents: &amp;str, needle: &amp;str) -&gt; usize {
    contents
        .par_lines()
        .map(|line| count_line(line, needle))
        .sum()
}</code></pre>
<p>ä½†å‡è®¾ä½ æœ‰ä¸€ä¸ªé•¿æ—¶é—´è¿è¡Œçš„ Rust å‡½æ•°ï¼Œå¸Œæœ›å¹¶è¡Œæ‰§è¡Œå¤šæ¬¡ã€‚æˆ‘ä»¬ä»¥ä¸€ä¸ªä¸²è¡Œç‰ˆæœ¬çš„è¯é¢‘ç»Ÿè®¡ä¸ºä¾‹ï¼š</p>
<pre><code class="language-rust no_run"><span class="boring">#![allow(dead_code)]
</span><span class="boring">fn count_line(line: &amp;str, needle: &amp;str) -&gt; usize {
</span><span class="boring">    let mut total = 0;
</span><span class="boring">    for word in line.split(' ') {
</span><span class="boring">        if word == needle {
</span><span class="boring">            total += 1;
</span><span class="boring">        }
</span><span class="boring">    }
</span><span class="boring">    total
</span><span class="boring">}
</span><span class="boring">
</span>fn search_sequential(contents: &amp;str, needle: &amp;str) -&gt; usize {
    contents.lines().map(|line| count_line(line, needle)).sum()
}</code></pre>
<p>ä¸ºäº†å®ç°è¯¥å‡½æ•°çš„å¹¶è¡Œæ‰§è¡Œï¼Œå¯ä»¥ä½¿ç”¨ <a href="{{#PYO3_DOCS_URL}}/pyo3/marker/struct.Python.html#method.detach"><code>Python::detach</code></a> æ–¹æ³•æš‚æ—¶é‡Šæ”¾ GILï¼Œä»è€Œå…è®¸å…¶ä»– Python çº¿ç¨‹è¿è¡Œã€‚ç„¶åæˆ‘ä»¬å‘ Python è¿è¡Œæ—¶æš´éœ²ä¸€ä¸ªå‡½æ•°ï¼Œè¯¥å‡½æ•°åœ¨ä¼ ç»™ <a href="{{#PYO3_DOCS_URL}}/pyo3/marker/struct.Python.html#method.detach"><code>Python::detach</code></a> çš„é—­åŒ…ä¸­è°ƒç”¨ <code>search_sequential</code>ï¼Œä»è€Œå®ç°çœŸæ­£çš„å¹¶è¡Œï¼š</p>
<pre><code class="language-rust no_run"><span class="boring">#![allow(dead_code)]
</span><span class="boring">use pyo3::prelude::*;
</span><span class="boring">
</span><span class="boring">fn count_line(line: &amp;str, needle: &amp;str) -&gt; usize {
</span><span class="boring">    let mut total = 0;
</span><span class="boring">    for word in line.split(' ') {
</span><span class="boring">        if word == needle {
</span><span class="boring">            total += 1;
</span><span class="boring">        }
</span><span class="boring">    }
</span><span class="boring">    total
</span><span class="boring">}
</span><span class="boring">
</span><span class="boring">fn search_sequential(contents: &amp;str, needle: &amp;str) -&gt; usize {
</span><span class="boring">   contents.lines().map(|line| count_line(line, needle)).sum()
</span><span class="boring">}
</span>#[pyfunction]
fn search_sequential_detached(py: Python&lt;'_&gt;, contents: &amp;str, needle: &amp;str) -&gt; usize {
    py.detach(|| search_sequential(contents, needle))
}</code></pre>
<p>ç°åœ¨ Python çº¿ç¨‹å¯ä»¥ä½¿ç”¨å¤šä¸ª CPU æ ¸å¿ƒï¼Œè§£å†³äº†é€šå¸¸æƒ…å†µä¸‹ Python å¤šçº¿ç¨‹ä»…é€‚ç”¨äº I/O å¯†é›†å‹ä»»åŠ¡çš„é™åˆ¶ï¼š</p>
<pre><code class="language-Python">from concurrent.futures import ThreadPoolExecutor
from word_count import search_sequential_detached

executor = ThreadPoolExecutor(max_workers=2)

future_1 = executor.submit(
    word_count.search_sequential_detached, contents, needle
)
future_2 = executor.submit(
    word_count.search_sequential_detached, contents, needle
)
result_1 = future_1.result()
result_2 = future_2.result()
</code></pre>
<h2 id="åŸºå‡†æµ‹è¯•"><a class="header" href="#åŸºå‡†æµ‹è¯•">åŸºå‡†æµ‹è¯•</a></h2>
<p>è®©æˆ‘ä»¬å¯¹ <code>word-count</code> ç¤ºä¾‹è¿›è¡ŒåŸºå‡†æµ‹è¯•ï¼Œä»¥éªŒè¯æˆ‘ä»¬æ˜¯å¦çœŸæ­£é€šè¿‡ PyO3 è§£é”äº†å¹¶è¡Œèƒ½åŠ›ã€‚</p>
<p>æˆ‘ä»¬ä½¿ç”¨ <code>pytest-benchmark</code> æ¥æµ‹è¯•å››ä¸ªè¯é¢‘ç»Ÿè®¡å‡½æ•°ï¼š</p>
<ol>
<li>çº¯ Python ç‰ˆæœ¬</li>
<li>Rust å¹¶è¡Œç‰ˆæœ¬</li>
<li>Rust ä¸²è¡Œç‰ˆæœ¬</li>
<li>ä½¿ç”¨ä¸¤ä¸ª Python çº¿ç¨‹åˆ†åˆ«æ‰§è¡Œä¸¤æ¬¡ Rust ä¸²è¡Œç‰ˆæœ¬</li>
</ol>
<p>åŸºå‡†æµ‹è¯•è„šæœ¬å¯ä»¥åœ¨<a href="https://github.com/PyO3/pyo3/blob/main/examples/word-count/tests/test_word_count.py">è¿™é‡Œ</a>æ‰¾åˆ°ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ <code>word-count</code> ç›®å½•ä¸‹è¿è¡Œ <code>nox</code> æ¥å¯¹è¿™äº›å‡½æ•°è¿›è¡ŒåŸºå‡†æµ‹è¯•ã€‚</p>
<p>è™½ç„¶åŸºå‡†æµ‹è¯•ç»“æœå–å†³äºä½ çš„æœºå™¨ï¼Œä½†ç›¸å¯¹ç»“æœåº”è¯¥ä¸ä»¥ä¸‹æ•°æ®ï¼ˆ2020 å¹´ä¸­ï¼‰ç›¸ä¼¼ï¼š</p>
<pre><code class="language-text">-------------------------------------------------------------------------------------------------- benchmark: 4 tests -------------------------------------------------------------------------------------------------
Name (time in ms)                                          Min                Max               Mean            StdDev             Median               IQR            Outliers       OPS            Rounds  Iterations
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
test_word_count_rust_parallel                           1.7315 (1.0)       4.6495 (1.0)       1.9972 (1.0)      0.4299 (1.0)       1.8142 (1.0)      0.2049 (1.0)         40;46  500.6943 (1.0)         375           1
test_word_count_rust_sequential                         7.3348 (4.24)     10.3556 (2.23)      8.0035 (4.01)     0.7785 (1.81)      7.5597 (4.17)     0.8641 (4.22)         26;5  124.9457 (0.25)        121           1
test_word_count_rust_sequential_twice_with_threads      7.9839 (4.61)     10.3065 (2.22)      8.4511 (4.23)     0.4709 (1.10)      8.2457 (4.55)     0.3927 (1.92)        17;17  118.3274 (0.24)        114           1
test_word_count_python_sequential                      27.3985 (15.82)    45.4527 (9.78)     28.9604 (14.50)    4.1449 (9.64)     27.5781 (15.20)    0.4638 (2.26)          3;5   34.5299 (0.07)         35           1
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
</code></pre>
<p>ä½ å¯ä»¥çœ‹åˆ°ï¼Œä½¿ç”¨ Python å¤šçº¿ç¨‹çš„ç‰ˆæœ¬æ¯” Rust ä¸²è¡Œç‰ˆæœ¬ç•¥æ…¢ï¼Œè¿™æ„å‘³ç€ä¸å•æ ¸æ‰§è¡Œç›¸æ¯”ï¼Œé€Ÿåº¦å‡ ä¹ç¿»äº†ä¸€å€ã€‚</p>
<h2 id="åœ¨-rust-çº¿ç¨‹é—´å…±äº«-python-å¯¹è±¡"><a class="header" href="#åœ¨-rust-çº¿ç¨‹é—´å…±äº«-python-å¯¹è±¡">åœ¨ Rust çº¿ç¨‹é—´å…±äº« Python å¯¹è±¡</a></h2>
<p>åœ¨ä¸Šè¿°ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬ä¸ºä¸€ä¸ªåº•å±‚ Rust å‡½æ•°æä¾›äº† Python æ¥å£ï¼Œç„¶ååˆ©ç”¨ Python çš„ <code>threading</code> æ¨¡å—å¹¶è¡Œè¿è¡Œè¯¥åº•å±‚å‡½æ•°ã€‚æ­¤å¤–ï¼Œä¹Ÿå¯ä»¥åœ¨ Rust ä¸­ç›´æ¥åˆ›å»ºçº¿ç¨‹ï¼Œè¿™äº›çº¿ç¨‹è·å– GIL å¹¶æ“ä½œ Python å¯¹è±¡ã€‚ä½†æ­¤æ—¶å¿…é¡»å°å¿ƒï¼Œé¿å…åœ¨è¿™äº›æƒ…å†µä¸‹ç¼–å†™å‡ºä¸ GIL æ­»é”çš„ä»£ç ã€‚</p>
<ul>
<li>æ³¨æ„ï¼šæœ¬ç¤ºä¾‹æ—¨åœ¨è¯´æ˜å¦‚ä½•é‡Šæ”¾å¹¶é‡æ–°è·å– GIL ä»¥é¿å…æ­»é”ã€‚é™¤éæ‰€åˆ›å»ºçš„çº¿ç¨‹ä¹‹åä¼šé‡Šæ”¾ GILï¼Œæˆ–ä½ ä½¿ç”¨çš„æ˜¯ CPython çš„ free-threaded æ„å»ºç‰ˆæœ¬ï¼Œå¦åˆ™ä½¿ç”¨ <code>rayon</code> å¹¶è¡ŒåŒ–é‚£äº›åœ¨æ•´ä¸ªæ‰§è¡Œè¿‡ç¨‹ä¸­æŒæœ‰ GIL çš„ä»£ç ï¼Œä¸ä¼šå¸¦æ¥ä»»ä½•æ€§èƒ½æå‡ã€‚</li>
</ul>
<p>åœ¨ä¸‹é¢çš„ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬å…±äº«ä¸€ä¸ªé€šè¿‡ <code>pyclass</code> å®å®šä¹‰çš„ <code>Vec</code> ç±»å‹çš„ç”¨æˆ· ID å¯¹è±¡ï¼Œå¹¶åˆ›å»ºçº¿ç¨‹ä½¿ç”¨ <code>rayon</code> çš„å¹¶è¡Œè¿­ä»£å™¨å°†æ•°æ®é›†åˆå¤„ç†ä¸ºä¸€ä¸ªå¸ƒå°”å€¼ <code>Vec</code>ï¼š</p>
<pre><code class="language-rust no_run">use pyo3::prelude::*;

// è¿™äº› trait ä½¿å¾—æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ int_par_iter å’Œ map
use rayon::iter::{IntoParallelRefIterator, ParallelIterator};

#[pyclass]
struct UserID {
    id: i64,
}

let allowed_ids: Vec&lt;bool&gt; = Python::attach(|outer_py| {
    let instances: Vec&lt;Py&lt;UserID&gt;&gt; = (0..10).map(|x| Py::new(outer_py, UserID { id: x }).unwrap()).collect();
    outer_py.detach(|| {
        instances.par_iter().map(|instance| {
            Python::attach(|inner_py| {
                instance.borrow(inner_py).id &gt; 5
            })
        }).collect()
    })
});
assert!(allowed_ids.into_iter().filter(|b| *b).count() == 4);</code></pre>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™é‡Œæœ‰ä¸€ä¸ª <code>outer_py</code> Python ä»¤ç‰Œå’Œä¸€ä¸ª <code>inner_py</code> ä»¤ç‰Œã€‚ä¸å…è®¸åœ¨çº¿ç¨‹é—´å…±äº« Python ä»¤ç‰Œï¼Œæ¯ä¸ªçº¿ç¨‹å¿…é¡»å•ç‹¬è¿æ¥åˆ°è§£é‡Šå™¨ä»¥è®¿é—®è¢« Python å¯¹è±¡åŒ…è£…çš„æ•°æ®ã€‚</p>
<p>åŒæ ·é‡è¦çš„æ˜¯ï¼Œæ­¤ç¤ºä¾‹ä½¿ç”¨äº† <a href="{{#PYO3_DOCS_URL}}/pyo3/marker/struct.Python.html#method.detach"><code>Python::detach</code></a> æ¥åŒ…è£¹é€šè¿‡ <code>rayon</code> åˆ›å»ºæ“ä½œç³»ç»Ÿçº¿ç¨‹çš„ä»£ç ã€‚å¦‚æœç¤ºä¾‹ä¸­ä¸ä½¿ç”¨ <code>detach</code>ï¼Œ<code>rayon</code> çš„å·¥ä½œçº¿ç¨‹ä¼šåœ¨å°è¯•è·å– GIL æ—¶é˜»å¡ï¼Œè€ŒæŒæœ‰ GIL çš„çº¿ç¨‹åˆ™ä¼šæ— é™å¾ªç¯ç­‰å¾… <code>rayon</code> çº¿ç¨‹çš„ç»“æœã€‚è°ƒç”¨ <code>detach</code> å¯ä»¥åœ¨æ”¶é›†å·¥ä½œçº¿ç¨‹ç»“æœçš„çº¿ç¨‹ä¸­é‡Šæ”¾ GILã€‚åœ¨åˆ›å»ºå·¥ä½œçº¿ç¨‹æ—¶åº”å½“å§‹ç»ˆè°ƒç”¨ <code>detach</code>ï¼Œå°¤å…¶æ˜¯åœ¨å·¥ä½œçº¿ç¨‹éœ€è¦è·å– GIL çš„æƒ…å†µä¸‹ï¼Œä»¥é˜²æ­¢æ­»é”ã€‚</p>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="æ”¯æŒè‡ªç”±çº¿ç¨‹çš„-cpython"><a class="header" href="#æ”¯æŒè‡ªç”±çº¿ç¨‹çš„-cpython">æ”¯æŒè‡ªç”±çº¿ç¨‹çš„ CPython</a></h1>
<p>CPython 3.14 å£°æ˜æ”¯æŒâ€œè‡ªç”±çº¿ç¨‹â€ï¼ˆfree-threadedï¼‰ç‰ˆæœ¬çš„ CPythonï¼Œè¯¥ç‰ˆæœ¬ä¸å†ä¾èµ–<a href="https://docs.python.org/zh-cn/3/glossary.html#term-global-interpreter-lock">å…¨å±€è§£é‡Šå™¨é”</a>ï¼ˆé€šå¸¸ç§°ä¸º GILï¼‰æ¥ç¡®ä¿çº¿ç¨‹å®‰å…¨ã€‚è‡ª 0.23 ç‰ˆæœ¬èµ·ï¼ŒPyO3 æ”¯æŒä¸ºè‡ªç”±çº¿ç¨‹ç‰ˆæœ¬çš„ Python æ„å»º Rust æ‰©å±•ï¼Œå¹¶æ”¯æŒä» Rust è°ƒç”¨è‡ªç”±çº¿ç¨‹ç‰ˆæœ¬çš„ Pythonã€‚</p>
<p>å¦‚æœä½ æƒ³äº†è§£æ›´å¤šå…³äºè‡ªç”±çº¿ç¨‹ Python çš„èƒŒæ™¯çŸ¥è¯†ï¼Œå¯ä»¥å‚è€ƒ 3.13 ç‰ˆæœ¬å‘å¸ƒè¯´æ˜ä¸­çš„<a href="https://docs.python.org/zh-cn/3/whatsnew/3.13.html#whatsnew313-free-threaded-cpython">æ–°ç‰¹æ€§</a>éƒ¨åˆ†ï¼ˆè¿™æ˜¯â€œè‡ªç”±çº¿ç¨‹â€æ„å»ºé¦–æ¬¡ä½œä¸ºå®éªŒæ€§åŠŸèƒ½å¼•å…¥ï¼‰ï¼ŒCPython æ–‡æ¡£ä¸­çš„<a href="https://docs.python.org/zh-cn/3/howto/free-threading-extensions.html#freethreading-extensions-howto">è‡ªç”±çº¿ç¨‹ HOWTO æŒ‡å—</a>ï¼Œç¤¾åŒºç»´æŠ¤çš„ Python è‡ªç”±çº¿ç¨‹æŒ‡å—ä¸­çš„<a href="https://py-free-threading.github.io/porting-extensions/">æ‰©å±•ç§»æ¤æŒ‡å—</a>ï¼Œä»¥åŠ <a href="https://peps.python.org/pep-0703/">PEP 703</a>ï¼Œè¯¥æ–‡æ¡£æä¾›äº† CPython ä¸­è‡ªç”±çº¿ç¨‹å®ç°çš„æŠ€æœ¯èƒŒæ™¯ã€‚</p>
<p>åœ¨æ”¯æŒ GIL çš„æ„å»ºä¸­ï¼ˆåœ¨â€œè‡ªç”±çº¿ç¨‹â€æ„å»ºæ¨å‡ºä¹‹å‰æ˜¯å”¯ä¸€é€‰æ‹©ï¼‰ï¼Œå…¨å±€è§£é‡Šå™¨é”å¯¹ Python è¿è¡Œæ—¶çš„è®¿é—®è¿›è¡Œäº†ä¸²è¡ŒåŒ–ã€‚å› æ­¤ï¼Œç”±äº<a href="https://zh.wikipedia.org/wiki/Amdahl%E5%AE%9A%E5%BE%8B">Amdahl å®šå¾‹</a>ï¼ŒGIL æˆä¸ºå¤šçº¿ç¨‹ Python å·¥ä½œè´Ÿè½½å¹¶è¡Œæ‰©å±•çš„æ ¹æœ¬é™åˆ¶ï¼Œå› ä¸ºåœ¨å•ä¸€æ‰§è¡Œä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œå¹¶è¡Œå¤„ç†ä»»åŠ¡çš„ä»»ä½•æ—¶é—´ï¼Œä»æ ¹æœ¬ä¸Šæ— æ³•é€šè¿‡å¹¶è¡ŒåŒ–åŠ é€Ÿã€‚</p>
<p>è‡ªç”±çº¿ç¨‹æ„å»ºæ¶ˆé™¤äº†è¿™ä¸€å¯¹å¤šçº¿ç¨‹ Python æ‰©å±•çš„é™åˆ¶ã€‚è¿™æ„å‘³ç€ä½¿ç”¨ Python çš„ <a href="https://docs.python.org/3/library/threading.html"><code>threading</code></a> æ¨¡å—å®ç°å¹¶è¡ŒåŒ–å˜å¾—æ›´åŠ ç›´æ¥ã€‚å¦‚æœä½ æ›¾ç»éœ€è¦ä½¿ç”¨ <a href="https://docs.python.org/zh-cn/3/library/multiprocessing.html"><code>multiprocessing</code></a> æ¥ä¸ºæŸäº› Python ä»£ç å®ç°å¹¶è¡ŒåŠ é€Ÿï¼Œé‚£ä¹ˆè‡ªç”±çº¿ç¨‹å¾ˆå¯èƒ½å…è®¸ä½ æ”¹ç”¨ Python çº¿ç¨‹æ¥å®Œæˆç›¸åŒçš„å·¥ä½œæµã€‚</p>
<p>PyO3 å¯¹è‡ªç”±çº¿ç¨‹ Python çš„æ”¯æŒå°†å…è®¸ç¼–å†™å¤©ç”Ÿçº¿ç¨‹å®‰å…¨çš„åŸç”Ÿ Python æ‰©å±•ï¼Œç›¸æ¯” C æ‰©å±•èƒ½æä¾›æ›´å¼ºçš„å®‰å…¨æ€§ä¿è¯ã€‚æˆ‘ä»¬çš„ç›®æ ‡æ˜¯é€šè¿‡åŸºäº Rust çš„ <a href="https://doc.rust-lang.org/nomicon/send-and-sync.html"><code>Send</code> å’Œ <code>Sync</code></a> traitï¼Œåœ¨åŸç”Ÿ Python è¿è¡Œæ—¶ä¸­å®ç°â€œæ— ç•å¹¶å‘â€ï¼ˆfearless concurrencyï¼‰ã€‚</p>
<p>æœ¬æ–‡æ¡£æä¾›å°†ä½¿ç”¨ PyO3 çš„ Rust ä»£ç ç§»æ¤åˆ°è‡ªç”±çº¿ç¨‹ Python ä¸‹è¿è¡Œçš„å»ºè®®ã€‚</p>
<h2 id="ä½¿ç”¨-pyo3-æ”¯æŒè‡ªç”±çº¿ç¨‹-python"><a class="header" href="#ä½¿ç”¨-pyo3-æ”¯æŒè‡ªç”±çº¿ç¨‹-python">ä½¿ç”¨ PyO3 æ”¯æŒè‡ªç”±çº¿ç¨‹ Python</a></h2>
<p>è®¸å¤šç®€å•çš„ PyO3 ä½¿ç”¨åœºæ™¯ï¼ˆä¾‹å¦‚ä¸ºæ— å‰¯ä½œç”¨çš„çº¯ Rust å‡½æ•°æš´éœ²ç»‘å®šï¼Œæˆ–å®šä¹‰ä¸å¯å˜çš„ Python ç±»ï¼‰åœ¨è‡ªç”±çº¿ç¨‹æ„å»ºä¸‹å¯èƒ½â€œå¼€ç®±å³ç”¨â€ã€‚ä½ å”¯ä¸€éœ€è¦åšçš„å°±æ˜¯æ ‡æ³¨é¡¹ç›®ä¸­ç”± Rust ä»£ç å£°æ˜çš„ Python æ¨¡å—ï¼Œè¡¨æ˜å®ƒä»¬æ”¯æŒè‡ªç”±çº¿ç¨‹ Pythonï¼Œä¾‹å¦‚é€šè¿‡ <code>#[pymodule(gil_used = false)]</code> å£°æ˜æ¨¡å—ã€‚</p>
<p>æ›´å¤æ‚çš„ <code>#[pyclass]</code> ç±»å‹å¯èƒ½éœ€è¦ç›´æ¥å¤„ç†çº¿ç¨‹å®‰å…¨ï¼›<a href="#pyclass-çº¿ç¨‹å®‰å…¨">æŒ‡å—ä¸­æœ‰ä¸€ä¸ªä¸“é—¨ç« èŠ‚</a>è®¨è®ºæ­¤é—®é¢˜ã€‚</p>
<p>åœ¨åº•å±‚ï¼Œæ ‡æ³¨æ¨¡å—ä¼šå°†æ‰©å±•å®šä¹‰çš„æ¨¡å—çš„ <code>Py_MOD_GIL</code> æ§½ä½è®¾ç½®ä¸º <code>Py_MOD_GIL_NOT_USED</code>ï¼Œè¿™æ ·è§£é‡Šå™¨åœ¨è¿è¡Œæ—¶å°±èƒ½çŸ¥é“æ‰©å±•çš„ä½œè€…è®¤ä¸ºè¯¥æ‰©å±•æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚ä½ åº”è¯¥ä»…åœ¨ä½ ç¡®å®šä½ çš„æ‰©å±•æ˜¯çº¿ç¨‹å®‰å…¨çš„æƒ…å†µä¸‹æ‰è¿™æ ·åšã€‚ç”±äº Rust æœ¬èº«çš„ä¿è¯ï¼Œè®¸å¤šæ‰©å±•å·²ç»æ»¡è¶³è¿™ä¸€ç‚¹ï¼Œä½†è¯·å‚è§ä¸‹æ–‡ä»¥äº†è§£å¦‚ä½•è¯„ä¼°ç°æœ‰ Rust æ‰©å±•çš„çº¿ç¨‹å®‰å…¨æ€§ï¼Œä»¥åŠå¦‚ä½•ç†è§£åœ¨æ²¡æœ‰ GIL çš„ Python è¿è¡Œæ—¶ä¸­ä½¿ç”¨ PyO3 APIã€‚</p>
<p>å¦‚æœä½ æœªæ˜¾å¼æ ‡è®°æ¨¡å—ä¸ºçº¿ç¨‹å®‰å…¨ï¼ŒPython è§£é‡Šå™¨åœ¨å¯¼å…¥ä½ çš„æ¨¡å—æ—¶å°†åœ¨è¿è¡Œæ—¶é‡æ–°å¯ç”¨ GILï¼Œå¹¶æ‰“å°ä¸€æ¡ <code>RuntimeWarning</code> è­¦å‘Šï¼Œæ¶ˆæ¯ä¸­åŒ…å«å¯¼è‡´ GIL è¢«é‡æ–°å¯ç”¨çš„æ¨¡å—åç§°ã€‚ä½ å¯ä»¥é€šè¿‡å°†ç¯å¢ƒå˜é‡è®¾ç½®ä¸º <code>PYTHON_GIL=0</code> æˆ–åœ¨å¯åŠ¨ Python æ—¶ä¼ å…¥ <code>-Xgil=0</code> æ¥å¼ºåˆ¶ä¿æŒ GIL ç¦ç”¨ï¼ˆ<code>0</code> è¡¨ç¤º GIL è¢«å…³é—­ï¼‰ã€‚</p>
<p>å¦‚æœä½ ç¡®å®šåœ¨ <code>PyModule</code> ä¸­æš´éœ²çš„æ‰€æœ‰æ•°æ®ç»“æ„éƒ½æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œåˆ™å¯ä»¥åœ¨å£°æ˜æ¨¡å—çš„ <code>pymodule</code> è¿‡ç¨‹å®ä¸­ä¼ å…¥ <code>gil_used = false</code> å‚æ•°ï¼Œæˆ–åœ¨ <code>PyModule</code> å®ä¾‹ä¸Šè°ƒç”¨ <code>PyModule::gil_used</code>ã€‚ä¾‹å¦‚ï¼š</p>
<pre><code class="language-rust no_run">use pyo3::prelude::*;

/// æœ¬æ¨¡å—æ”¯æŒè‡ªç”±çº¿ç¨‹ Python
#[pymodule(gil_used = false)]
fn my_extension(m: &amp;Bound&lt;'_, PyModule&gt;) -&gt; PyResult&lt;()&gt; {
    // æ·»åŠ ä½ çŸ¥é“æ˜¯çº¿ç¨‹å®‰å…¨çš„æˆå‘˜åˆ°æ¨¡å—
    Ok(())
}</code></pre>
<p>æˆ–å¯¹äºæœªä½¿ç”¨ <code>pymodule</code> å®æ„å»ºçš„æ¨¡å—ï¼š</p>
<pre><code class="language-rust no_run">use pyo3::prelude::*;

<span class="boring">#[allow(dead_code)]
</span>fn register_child_module(parent_module: &amp;Bound&lt;'_, PyModule&gt;) -&gt; PyResult&lt;()&gt; {
    let child_module = PyModule::new(parent_module.py(), "child_module")?;
    child_module.gil_used(false)?;
    parent_module.add_submodule(&amp;child_module)
}</code></pre>
<p>ç›®å‰ä½ å¿…é¡»é€šè¿‡æ ‡æ³¨æ‰©å±•ä¸­å®šä¹‰çš„æ¨¡å—æ¥æ˜¾å¼é€‰æ‹©æ”¯æŒè‡ªç”±çº¿ç¨‹ã€‚åœ¨æœªæ¥çš„ <code>PyO3</code> ç‰ˆæœ¬ä¸­ï¼Œæˆ‘ä»¬è®¡åˆ’å°† <code>gil_used = false</code> è®¾ä¸ºé»˜è®¤å€¼ã€‚</p>
<p>å‚è§ <a href="https://github.com/PyO3/pyo3/tree/main/pyo3-ffi/examples/string-sum"><code>string-sum</code></a> ç¤ºä¾‹ï¼Œäº†è§£å¦‚ä½•ä½¿ç”¨åŸå§‹ FFI è°ƒç”¨ä¸ºä½¿ç”¨å•é˜¶æ®µåˆå§‹åŒ–çš„æ¨¡å—å£°æ˜è‡ªç”±çº¿ç¨‹æ”¯æŒï¼Œä»¥åŠ <a href="https://github.com/PyO3/pyo3/tree/main/pyo3-ffi/examples/sequential"><code>sequential</code></a> ç¤ºä¾‹äº†è§£ä½¿ç”¨å¤šé˜¶æ®µåˆå§‹åŒ–çš„æ¨¡å—ã€‚</p>
<p>å¦‚æœä½ æƒ³é€šè¿‡æ¡ä»¶ç¼–è¯‘åœ¨è‡ªç”±çº¿ç¨‹æ„å»ºä¸‹è§¦å‘ä¸åŒçš„ä»£ç è·¯å¾„ï¼Œå¯ä»¥ä½¿ç”¨ <code>Py_GIL_DISABLED</code> å±æ€§ï¼Œå‰ææ˜¯ä½ çš„ crate å·²é…ç½®ç”Ÿæˆå¿…è¦çš„æ„å»ºé…ç½®æ•°æ®ã€‚è¯¦è§<a href="#æ”¯æŒå¤šä¸ª-python-ç‰ˆæœ¬">æŒ‡å—ç« èŠ‚</a>ï¼Œäº†è§£æ”¯æŒå¤šä¸ªä¸åŒ Python ç‰ˆæœ¬ï¼ˆåŒ…æ‹¬è‡ªç”±çº¿ç¨‹æ„å»ºï¼‰çš„æ›´å¤šç»†èŠ‚ã€‚</p>
<h2 id="è‡ªç”±çº¿ç¨‹æ„å»ºçš„ç‰¹æ®Šæ³¨æ„äº‹é¡¹"><a class="header" href="#è‡ªç”±çº¿ç¨‹æ„å»ºçš„ç‰¹æ®Šæ³¨æ„äº‹é¡¹">è‡ªç”±çº¿ç¨‹æ„å»ºçš„ç‰¹æ®Šæ³¨æ„äº‹é¡¹</a></h2>
<p>è‡ªç”±çº¿ç¨‹è§£é‡Šå™¨æ²¡æœ‰ GILã€‚è®¸å¤šç°æœ‰æ‰©å±•æä¾›çš„å¯å˜æ•°æ®ç»“æ„ä¾èµ– GIL æ¥é”å®š Python å¯¹è±¡ï¼Œä½¿å†…éƒ¨å¯å˜æ€§çº¿ç¨‹å®‰å…¨ã€‚</p>
<p>è°ƒç”¨ CPython C API åªæœ‰åœ¨æ“ä½œç³»ç»Ÿçº¿ç¨‹æ˜¾å¼é™„åŠ åˆ°è§£é‡Šå™¨è¿è¡Œæ—¶çš„æƒ…å†µä¸‹æ‰æ˜¯åˆæ³•çš„ã€‚åœ¨æ”¯æŒ GIL çš„æ„å»ºä¸­ï¼Œè¿™å‘ç”Ÿåœ¨è·å– GIL æ—¶ã€‚è€Œåœ¨è‡ªç”±çº¿ç¨‹æ„å»ºä¸­æ²¡æœ‰ GILï¼Œä½†ç›¸åŒçš„ C å®ï¼ˆåœ¨æ”¯æŒ GIL çš„æ„å»ºä¸­ç”¨äºé‡Šæ”¾æˆ–è·å– GILï¼‰ä¼šæ”¹ä¸ºè¯·æ±‚è§£é‡Šå™¨å°†çº¿ç¨‹é™„åŠ åˆ° Python è¿è¡Œæ—¶ï¼Œå¹¶ä¸”å¯ä»¥åŒæ—¶æœ‰å¤šä¸ªçº¿ç¨‹é™„åŠ ã€‚è¯¦è§ <a href="https://peps.python.org/pep-0703/#thread-states">PEP 703</a> è·å–æ›´å¤šå…³äºçº¿ç¨‹å¦‚ä½•ä»¥ç±»ä¼¼äºåœ¨æ”¯æŒ GIL çš„æ„å»ºä¸­é‡Šæ”¾/è·å– GIL çš„æ–¹å¼é™„åŠ å’Œåˆ†ç¦»åˆ°è§£é‡Šå™¨è¿è¡Œæ—¶çš„èƒŒæ™¯ä¿¡æ¯ã€‚</p>
<p>åœ¨æ”¯æŒ GIL çš„æ„å»ºä¸­ï¼ŒPyO3 ä½¿ç”¨ <a href="{{#PYO3_DOCS_URL}}/pyo3/marker/struct.Python.html"><code>Python&lt;'py&gt;</code></a> ç±»å‹å’Œ <code>'py</code> ç”Ÿå‘½å‘¨æœŸæ¥è¡¨ç¤ºæŒæœ‰å…¨å±€è§£é‡Šå™¨é”ã€‚åœ¨è‡ªç”±çº¿ç¨‹æ„å»ºä¸­ï¼ŒæŒæœ‰ <code>'py</code> ç”Ÿå‘½å‘¨æœŸä»…è¡¨ç¤ºå½“å‰çº¿ç¨‹å·²é™„åŠ åˆ° Python è§£é‡Šå™¨â€”â€”å…¶ä»–çº¿ç¨‹å¯ä»¥åŒæ—¶ä¸è§£é‡Šå™¨äº¤äº’ã€‚</p>
<h3 id="é™„åŠ åˆ°è¿è¡Œæ—¶"><a class="header" href="#é™„åŠ åˆ°è¿è¡Œæ—¶">é™„åŠ åˆ°è¿è¡Œæ—¶</a></h3>
<p>ä½ ä»ç„¶éœ€è¦è·å–ä¸€ä¸ª <code>'py</code> ç”Ÿå‘½å‘¨æœŸæ¥ä¸ Python å¯¹è±¡äº¤äº’æˆ–è°ƒç”¨ CPython C APIã€‚å¦‚æœä½ å°šæœªé™„åŠ åˆ° Python è¿è¡Œæ—¶ï¼Œå¯ä»¥ä½¿ç”¨ <a href="{{#PYO3_DOCS_URL}}/pyo3/marker/struct.Python.html#method.attach"><code>Python::attach</code></a> å‡½æ•°æ³¨å†Œçº¿ç¨‹ã€‚é€šè¿‡ Python <a href="https://docs.python.org/3/library/threading.html"><code>threading</code></a> æ¨¡å—åˆ›å»ºçš„çº¿ç¨‹ä¸éœ€è¦æ‰‹åŠ¨æ‰§è¡Œæ­¤æ“ä½œï¼Œå½“ CPython è°ƒç”¨ä½ çš„æ‰©å±•æ—¶ï¼Œpyo3 ä¼šè‡ªåŠ¨è®¾ç½® <a href="{{#PYO3_DOCS_URL}}/pyo3/marker/struct.Python.html"><code>Python&lt;'py&gt;</code></a> ä»¤ç‰Œã€‚</p>
<h3 id="åˆ†ç¦»ä»¥é¿å…æŒ‚èµ·å’Œæ­»é”"><a class="header" href="#åˆ†ç¦»ä»¥é¿å…æŒ‚èµ·å’Œæ­»é”">åˆ†ç¦»ä»¥é¿å…æŒ‚èµ·å’Œæ­»é”</a></h3>
<p>è‡ªç”±çº¿ç¨‹æ„å»ºåœ¨ä»¥ä¸‹æƒ…å†µä¸‹ä¼šè§¦å‘å…¨å±€åŒæ­¥äº‹ä»¶ï¼š</p>
<ul>
<li>åœ¨åƒåœ¾å›æ”¶æœŸé—´ï¼Œä»¥è·å¾—å¼•ç”¨è®¡æ•°å’Œå¯¹è±¡é—´å¼•ç”¨çš„å…¨å±€ä¸€è‡´è§†å›¾</li>
<li>åœ¨ Python 3.13 ä¸­ï¼Œå½“ç¬¬ä¸€ä¸ªåå°çº¿ç¨‹å¯åŠ¨æ—¶ï¼Œä»¥æ ‡è®°æŸäº›å¯¹è±¡ä¸ºâ€œæ°¸ç”Ÿâ€ï¼ˆimmortalï¼‰</li>
<li>å½“è°ƒç”¨ <code>sys.settrace</code> æˆ– <code>sys.setprofile</code> æ—¶ï¼Œä»¥å¯¹æ­£åœ¨è¿è¡Œçš„ä»£ç å¯¹è±¡å’Œçº¿ç¨‹è¿›è¡Œæ’æ¡©</li>
<li>åœ¨è°ƒç”¨ <code>os.fork()</code> æœŸé—´ï¼Œä»¥ç¡®ä¿æ•´ä¸ªè¿›ç¨‹çŠ¶æ€çš„ä¸€è‡´æ€§ã€‚</li>
</ul>
<p>æ­¤åˆ—è¡¨å¹¶éè¯¦å°½æ— é—ï¼Œæœªæ¥ Python ç‰ˆæœ¬ä¸­å¯èƒ½å‡ºç°å…¶ä»–è§¦å‘å…¨å±€åŒæ­¥äº‹ä»¶çš„åœºæ™¯ã€‚</p>
<p>å› æ­¤ï¼Œä½ åº”è¯¥åœ¨ä¸æ”¯æŒ GIL æ„å»ºä¸­ç›¸åŒçš„åœºæ™¯ä¸‹ä½¿ç”¨ <a href="{{#PYO3_DOCS_URL}}/pyo3/marker/struct.Python.html#method.detach"><code>Python::detach</code></a> ä»è§£é‡Šå™¨è¿è¡Œæ—¶åˆ†ç¦»ï¼šåœ¨æ‰§è¡Œä¸éœ€è¦ CPython è¿è¡Œæ—¶çš„é•¿æ—¶é—´ä»»åŠ¡æ—¶ï¼Œæˆ–åœ¨æ‰§è¡Œéœ€è¦é‡æ–°é™„åŠ åˆ°è¿è¡Œæ—¶çš„ä»»ä½•ä»»åŠ¡æ—¶ï¼ˆå‚è§<a href="#sharing-python-objects-between-rust-threads">æŒ‡å—ç« èŠ‚</a>äº†è§£æ­¤é—®é¢˜çš„è¯¦ç»†è¯´æ˜ï¼‰ã€‚åœ¨å‰ä¸€ç§æƒ…å†µä¸‹ï¼Œä½ ä¼šè§‚å¯Ÿåˆ°å…¶ä»–çº¿ç¨‹å› ç­‰å¾…é•¿æ—¶é—´ä»»åŠ¡å®Œæˆè€ŒæŒ‚èµ·ï¼›åœ¨åä¸€ç§æƒ…å†µä¸‹ï¼Œå½“è¿è¡Œæ—¶è§¦å‘å…¨å±€åŒæ­¥äº‹ä»¶åï¼ŒæŸçº¿ç¨‹å°è¯•é‡æ–°é™„åŠ æ—¶ä¼šé‡åˆ°æ­»é”ï¼Œè€Œç”Ÿæˆè¯¥çº¿ç¨‹çš„ä¸»çº¿ç¨‹ä¼šé˜»æ­¢åŒæ­¥äº‹ä»¶å®Œæˆã€‚</p>
<h3 id="å¯å˜-pyclass-å®ä¾‹çš„å¤šçº¿ç¨‹è®¿é—®å¼‚å¸¸ä¸ææ…Œ"><a class="header" href="#å¯å˜-pyclass-å®ä¾‹çš„å¤šçº¿ç¨‹è®¿é—®å¼‚å¸¸ä¸ææ…Œ">å¯å˜ <code>pyclass</code> å®ä¾‹çš„å¤šçº¿ç¨‹è®¿é—®å¼‚å¸¸ä¸ææ…Œ</a></h3>
<p>é™„åŠ åˆ° <code>pyclass</code> å®ä¾‹çš„æ•°æ®é€šè¿‡ç±»ä¼¼ <code>RefCell</code> çš„è¿è¡Œæ—¶å€Ÿç”¨æ£€æŸ¥æ¨¡å¼æ¥é˜²æ­¢å¹¶å‘è®¿é—®ã€‚ç±»ä¼¼äº <code>RefCell</code>ï¼ŒPyO3 ä¼šåœ¨å¯å˜å€Ÿç”¨æ—¶å¼•å‘å¼‚å¸¸ï¼ˆæˆ–æŸäº›æƒ…å†µä¸‹å¼•å‘ panicï¼‰ä»¥å¼ºåˆ¶æ‰§è¡Œç‹¬å è®¿é—®ã€‚åœ¨ PyO3 ä¸­ï¼Œè¿‡å»é€šè¿‡ <a href="{{#PYO3_DOCS_URL}}/pyo3/marker/struct.Python.html#method.detach"><code>Python::detach</code></a> é‡Šæ”¾ GIL æˆ–ä» <code>&amp;mut self</code> è°ƒç”¨æ¥å— <code>&amp;self</code> çš„ Python æ–¹æ³•æ—¶å°±å¯èƒ½äº§ç”Ÿæ­¤ç±» panicï¼ˆå‚è§<a href="#bound-and-interior-mutability">å…³äºå†…éƒ¨å¯å˜æ€§çš„æ–‡æ¡£</a>ï¼‰ï¼Œä½†ç°åœ¨åœ¨è‡ªç”±çº¿ç¨‹ Python ä¸­ï¼Œç”±äºæ²¡æœ‰ GIL æ¥é”å®šæ¥è‡ª Python çš„å¯¹å¯å˜å€Ÿç”¨æ•°æ®çš„å¹¶å‘è®¿é—®ï¼Œå› æ­¤ä» Python ä»£ç ä¸­è§¦å‘è¿™äº› panic çš„æœºä¼šæ›´å¤šäº†ã€‚è§¦å‘æ­¤é—®é¢˜æœ€ç›´æ¥çš„æ–¹æ³•æ˜¯ä½¿ç”¨ Python çš„ <a href="https://docs.python.org/3/library/threading.html"><code>threading</code></a> æ¨¡å—ï¼Œåœ¨å¤šä¸ªçº¿ç¨‹ä¸­åŒæ—¶è°ƒç”¨ä¸€ä¸ªå¯å˜å€Ÿç”¨ <a href="{{#PYO3_DOCS_URL}}/pyo3/attr.pyclass.html"><code>pyclass</code></a> çš„ Rust å‡½æ•°ã€‚ä¾‹å¦‚ï¼Œè€ƒè™‘ä»¥ä¸‹å®ç°ï¼š</p>
<pre><code class="language-rust no_run"><span class="boring">use pyo3::prelude::*;
</span>#[pyclass]
#[derive(Default)]
struct ThreadIter {
    count: usize,
}

#[pymethods]
impl ThreadIter {
    #[new]
    pub fn new() -&gt; Self {
        Default::default()
    }

    fn __next__(&amp;mut self, py: Python&lt;'_&gt;) -&gt; usize {
        self.count += 1;
        self.count
    }
}</code></pre>
<p>ç„¶åï¼Œå¦‚æœåœ¨ Python ä¸­æ‰§è¡Œå¦‚ä¸‹ä»£ç ï¼š</p>
<pre><code class="language-python">import concurrent.futures
from my_module import ThreadIter

i = ThreadIter()

def increment():
    next(i)

with concurrent.futures.ThreadPoolExecutor(max_workers=16) as tpe:
    futures = [tpe.submit(increment) for _ in range(100)]
    [f.result() for f in futures]
</code></pre>
<p>æˆ‘ä»¬å°†çœ‹åˆ°ä¸€ä¸ªå¼‚å¸¸ï¼š</p>
<pre><code class="language-text">Traceback (most recent call last)
  File "example.py", line 5, in &lt;module&gt;
    next(i)
RuntimeError: Already borrowed
</code></pre>
<p>æœªæ¥ç‰ˆæœ¬çš„ PyO3 å¯èƒ½ä¼šå…è®¸ç”¨æˆ·ä¸ºå¯å˜çš„ pyclass å®šä¹‰é€‰æ‹©ä¸åŒçš„è¯­ä¹‰ï¼Œä»è€Œå¯ä»¥é€‰æ‹©å¯ç”¨æŸç§é”æœºåˆ¶æ¥æ¨¡æ‹Ÿ GILï¼ˆå¦‚æœéœ€è¦çš„è¯ï¼‰ã€‚ç›®å‰ï¼Œä½ åº”è¯¥æ˜¾å¼æ·»åŠ é”æœºåˆ¶ï¼Œå¯èƒ½ä½¿ç”¨æ¡ä»¶ç¼–è¯‘æˆ–ä¸´ç•ŒåŒº APIï¼Œä»¥é¿å…ä¸ GIL äº§ç”Ÿæ­»é”ã€‚</p>
<h3 id="æ— æ³•ä½¿ç”¨å—é™-api-æ„å»ºæ‰©å±•"><a class="header" href="#æ— æ³•ä½¿ç”¨å—é™-api-æ„å»ºæ‰©å±•">æ— æ³•ä½¿ç”¨å—é™ API æ„å»ºæ‰©å±•</a></h3>
<p>è‡ªç”±çº¿ç¨‹æ„å»ºä½¿ç”¨äº†å…¨æ–°çš„ ABIï¼Œç›®å‰è¿˜æ²¡æœ‰é’ˆå¯¹è‡ªç”±çº¿ç¨‹ ABI çš„å—é™ API ç­‰ä»·ç‰©ã€‚è¿™æ„å‘³ç€ï¼Œå¦‚æœä½ çš„ crate ä¾èµ–äºä½¿ç”¨ <code>abi3</code> åŠŸèƒ½æˆ–æŸä¸ª <code>abi3-pyxx</code> åŠŸèƒ½çš„ PyO3ï¼Œé‚£ä¹ˆåœ¨ä½¿ç”¨è‡ªç”±çº¿ç¨‹è§£é‡Šå™¨æ„å»ºæ‰©å±•æ—¶ï¼ŒPyO3 å°†æ‰“å°è­¦å‘Šå¹¶å¿½ç•¥è¯¥è®¾ç½®ã€‚</p>
<p>è¿™æ„å‘³ç€ï¼Œå¦‚æœä½ çš„åŒ…åˆ©ç”¨äº†å—é™ API æä¾›çš„ ABI å‘å‰å…¼å®¹æ€§ï¼Œä»è€Œåªä¸ºæ¯ä¸ªç‰ˆæœ¬ä¸Šä¼ ä¸€ä¸ª wheel æ–‡ä»¶ï¼Œé‚£ä¹ˆä½ éœ€è¦æ›´æ–°å‘å¸ƒæµç¨‹ï¼Œé¢å¤–ä¸Šä¼ ä¸€ä¸ªç‰¹å®šç‰ˆæœ¬çš„è‡ªç”±çº¿ç¨‹ wheel æ–‡ä»¶ã€‚</p>
<p>æœ‰å…³æ”¯æŒå¤šä¸ªä¸åŒ Python ç‰ˆæœ¬ï¼ˆåŒ…æ‹¬è‡ªç”±çº¿ç¨‹æ„å»ºï¼‰çš„æ›´å¤šè¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚è§<a href="#æ”¯æŒå¤šä¸ª-python-ç‰ˆæœ¬">æŒ‡å—éƒ¨åˆ†</a>ã€‚</p>
<h3 id="çº¿ç¨‹å®‰å…¨çš„å•æ¬¡åˆå§‹åŒ–"><a class="header" href="#çº¿ç¨‹å®‰å…¨çš„å•æ¬¡åˆå§‹åŒ–">çº¿ç¨‹å®‰å…¨çš„å•æ¬¡åˆå§‹åŒ–</a></h3>
<p>ä¸ºäº†ç¡®ä¿æ•°æ®ä»…åˆå§‹åŒ–ä¸€æ¬¡ï¼Œè¯·ä½¿ç”¨ <a href="{{#PYO3_DOCS_URL}}/pyo3/sync/struct.PyOnceLock.html"><code>PyOnceLock</code></a> ç±»å‹ï¼Œå®ƒç±»ä¼¼äº <a href="https://doc.rust-lang.org/stable/std/sync/struct.OnceLock.html"><code>std::sync::OnceLock</code></a>ï¼Œå¹¶ä¸”åœ¨æœ‰çº¿ç¨‹é˜»å¡ç­‰å¾…å…¶ä»–çº¿ç¨‹å®Œæˆåˆå§‹åŒ–æ—¶ï¼Œä¼šè‡ªåŠ¨ä» Python è§£é‡Šå™¨åˆ†ç¦»ï¼Œä»è€Œå¸®åŠ©é¿å…æ­»é”ã€‚å¦‚æœå·²ç»åœ¨ä½¿ç”¨ <a href="https://doc.rust-lang.org/stable/std/sync/struct.OnceLock.html"><code>OnceLock</code></a>ï¼Œä¸”æ›¿æ¢ä¸º <a href="{{#PYO3_DOCS_URL}}/pyo3/sync/struct.PyOnceLock.html"><code>PyOnceLock</code></a> ä¸ç°å®ï¼Œåˆ™å¯ä»¥ä½¿ç”¨ <a href="{{#PYO3_DOCS_URL}}/pyo3/sync/trait.OnceLockExt.html"><code>OnceLockExt</code></a> æ‰©å±• traitï¼Œå®ƒæä¾›äº† <a href="{{#PYO3_DOCS_URL}}/pyo3/sync/trait.OnceLockExt.html#tymethod.get_or_init_py_attached"><code>OnceLockExt::get_or_init_py_attached</code></a> æ–¹æ³•ï¼Œåœ¨é˜»å¡æ—¶è‡ªåŠ¨ä»è§£é‡Šå™¨åˆ†ç¦»ï¼Œè¡Œä¸ºä¸ <a href="{{#PYO3_DOCS_URL}}/pyo3/sync/struct.PyOnceLock.html"><code>PyOnceLock</code></a> ç›¸åŒã€‚ä»¥ä¸‹æ˜¯ä½¿ç”¨ <a href="{{#PYO3_DOCS_URL}}/pyo3/sync/struct.PyOnceLock.html"><code>PyOnceLock</code></a> å•æ¬¡åˆå§‹åŒ–ä¸€ä¸ªæŒæœ‰ <code>Py&lt;PyDict&gt;</code> çš„è¿è¡Œæ—¶ç¼“å­˜çš„ç¤ºä¾‹ï¼š</p>
<pre><code class="language-rust"><span class="boring">use pyo3::prelude::*;
</span>use pyo3::sync::PyOnceLock;
use pyo3::types::PyDict;

let cache: PyOnceLock&lt;Py&lt;PyDict&gt;&gt; = PyOnceLock::new();

Python::attach(|py| {
    // ä¿è¯ä»…è¢«è°ƒç”¨ä¸€æ¬¡
    cache.get_or_init(py, || PyDict::new(py).unbind())
});</code></pre>
<p>åœ¨æŸäº›éœ€è¦å‡½æ•°ç²¾ç¡®æ‰§è¡Œä¸€æ¬¡çš„åœºæ™¯ä¸­ï¼Œå¯ä»¥å°† <a href="{{#PYO3_DOCS_URL}}/pyo3/sync/trait.OnceExt.html"><code>OnceExt</code></a> trait å¼•å…¥ä½œç”¨åŸŸã€‚<a href="{{#PYO3_DOCS_URL}}/pyo3/sync/trait.OnceExt.html"><code>OnceExt</code></a> ä¸º <code>std::sync::Once</code> æ·»åŠ äº† <a href="{{#PYO3_DOCS_URL}}/pyo3/sync/trait.OnceExt.html#tymethod.call_once_py_attached"><code>OnceExt::call_once_py_attached</code></a> å’Œ <a href="{{#PYO3_DOCS_URL}}/pyo3/sync/trait.OnceExt.html#tymethod.call_once_force_py_attached"><code>OnceExt::call_once_force_py_attached</code></a> æ–¹æ³•ï¼Œä½¿å…¶èƒ½å¤Ÿåœ¨å·²è¿æ¥åˆ° Python è§£é‡Šå™¨çš„ä¸Šä¸‹æ–‡ä¸­ä½¿ç”¨ <a href="https://doc.rust-lang.org/stable/std/sync/struct.Once.html"><code>Once</code></a>ã€‚è¿™äº›å‡½æ•°ç±»ä¼¼äº <a href="https://doc.rust-lang.org/stable/std/sync/struct.Once.html#method.call_once"><code>Once::call_once</code></a>ã€<a href="https://doc.rust-lang.org/stable/std/sync/struct.Once.html#method.call_once_force"><code>Once::call_once_force</code></a>ï¼Œä½†é¢å¤–æ¥å—ä¸€ä¸ª <a href="{{#PYO3_DOCS_URL}}/pyo3/marker/struct.Python.html"><code>Python&lt;'py&gt;</code></a> tokenã€‚æ‰€æœ‰è¿™äº›å‡½æ•°åœ¨é˜»å¡å‰ä¼šä»è§£é‡Šå™¨åˆ†ç¦»ï¼Œå¹¶åœ¨æ‰§è¡Œå‡½æ•°ä¹‹å‰é‡æ–°è¿æ¥ï¼Œä»è€Œé¿å…ä¸ä½¿ç”¨ PyO3 æ‰©å±• trait æ—¶å¯èƒ½å‡ºç°çš„æ­»é”ã€‚ä»¥ä¸‹æ˜¯ä½¿ç”¨ <a href="https://doc.rust-lang.org/stable/std/sync/struct.Once.html"><code>Once</code></a> è€Œé <a href="{{#PYO3_DOCS_URL}}/pyo3/sync/struct.PyOnceLock.html"><code>PyOnceLock</code></a> å®ç°ç›¸åŒåŠŸèƒ½çš„ç¤ºä¾‹ï¼š</p>
<pre><code class="language-rust"><span class="boring">use pyo3::prelude::*;
</span>use std::sync::Once;
use pyo3::sync::OnceExt;
use pyo3::types::PyDict;

struct RuntimeCache {
    once: Once,
    cache: Option&lt;Py&lt;PyDict&gt;&gt;
}

let mut cache = RuntimeCache {
    once: Once::new(),
    cache: None
};

Python::attach(|py| {
    // ä¿è¯ä»…è¢«è°ƒç”¨ä¸€æ¬¡
    cache.once.call_once_py_attached(py, || {
        cache.cache = Some(PyDict::new(py).unbind());
    });
});</code></pre>
<h3 id="gilprotected-æœªè¢«å¯¼å‡º"><a class="header" href="#gilprotected-æœªè¢«å¯¼å‡º"><code>GILProtected</code> æœªè¢«å¯¼å‡º</a></h3>
<p><a href="https://docs.rs/pyo3/0.22/pyo3/sync/struct.GILProtected.html"><code>GILProtected</code></a> æ˜¯ PyO3 ä¸­ä¸€ä¸ªï¼ˆå·²å¼ƒç”¨ï¼‰ç±»å‹ï¼Œå®ƒé€šè¿‡åˆ©ç”¨ GIL æ¥é”å®šå…¶ä»–çº¿ç¨‹çš„å¹¶å‘è®¿é—®ï¼Œä»è€Œå®ç°å¯¹é™æ€æ•°æ®çš„å¯å˜è®¿é—®ã€‚åœ¨è‡ªç”±çº¿ç¨‹ Python ä¸­æ²¡æœ‰ GILï¼Œå› æ­¤ä½ éœ€è¦å°†æ­¤ç±»å‹æ›¿æ¢ä¸ºå…¶ä»–å½¢å¼çš„é”æœºåˆ¶ã€‚åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œä½¿ç”¨ <a href="https://doc.rust-lang.org/std/sync/atomic/"><code>std::sync::atomic</code></a> ä¸­çš„ç±»å‹æˆ– <a href="https://doc.rust-lang.org/std/sync/struct.Mutex.html"><code>std::sync::Mutex</code></a> å°±è¶³å¤Ÿäº†ã€‚</p>
<p>ä¹‹å‰ï¼š</p>
<pre><code class="language-rust"><span class="boring">#![allow(deprecated)]
</span><span class="boring">fn main() {
</span><span class="boring">#[cfg(not(Py_GIL_DISABLED))] {
</span><span class="boring">use pyo3::prelude::*;
</span>use pyo3::sync::GILProtected;
use pyo3::types::{PyDict, PyNone};
use std::cell::RefCell;

static OBJECTS: GILProtected&lt;RefCell&lt;Vec&lt;Py&lt;PyDict&gt;&gt;&gt;&gt; =
    GILProtected::new(RefCell::new(Vec::new()));

Python::attach(|py| {
    // å ä½ç¬¦ï¼Œä»£è¡¨æ‰§è¡Œä»»æ„ Python ä»£ç 
    let d = PyDict::new(py);
    d.set_item(PyNone::get(py), PyNone::get(py)).unwrap();
    OBJECTS.get(py).borrow_mut().push(d.unbind());
});
<span class="boring">}}</span></code></pre>
<p>ä¹‹åï¼š</p>
<pre><code class="language-rust"><span class="boring">use pyo3::prelude::*;
</span><span class="boring">fn main() {
</span>use pyo3::types::{PyDict, PyNone};
use std::sync::Mutex;

static OBJECTS: Mutex&lt;Vec&lt;Py&lt;PyDict&gt;&gt;&gt; = Mutex::new(Vec::new());

Python::attach(|py| {
    // å ä½ç¬¦ï¼Œä»£è¡¨æ‰§è¡Œä»»æ„ Python ä»£ç 
    let d = PyDict::new(py);
    d.set_item(PyNone::get(py), PyNone::get(py)).unwrap();
    // ä¸ä»»ä½• `Mutex` ä½¿ç”¨æ–¹å¼ä¸€æ ·ï¼Œåº”å°½å¯èƒ½ç¼©çŸ­åŠ é”æ—¶é—´
    // è¿™é‡Œä»…åœ¨å‘ `Vec` æ·»åŠ å…ƒç´ æ—¶åŠ é”
    OBJECTS.lock().unwrap().push(d.unbind());
});
<span class="boring">}</span></code></pre>
<p>å¦‚æœä½ åœ¨æŒæœ‰é”çš„åŒæ—¶æ‰§è¡Œäº†ä»»æ„ Python ä»£ç ï¼Œåº”å¯¼å…¥ <a href="{{#PYO3_DOCS_URL}}/pyo3/sync/trait.MutexExt.html"><code>MutexExt</code></a> trait å¹¶ä½¿ç”¨ <code>lock_py_attached</code> æ–¹æ³•ä»£æ›¿ <code>lock</code>ã€‚è¿™èƒ½ç¡®ä¿ Python è¿è¡Œæ—¶å¯åŠ¨çš„å…¨å±€åŒæ­¥äº‹ä»¶å¯ä»¥ç»§ç»­è¿›è¡Œï¼Œä»è€Œé¿å…ä¸è§£é‡Šå™¨å¯èƒ½å‘ç”Ÿæ­»é”ã€‚</p>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="è°ƒè¯•"><a class="header" href="#è°ƒè¯•">è°ƒè¯•</a></h1>
<h2 id="å®"><a class="header" href="#å®">å®</a></h2>
<p>PyO3 çš„å±æ€§ï¼ˆ<code>#[pyclass]</code>ã€<code>#[pymodule]</code> ç­‰ï¼‰æ˜¯<a href="https://doc.rust-lang.org/reference/procedural-macros.html">è¿‡ç¨‹å®</a>ï¼Œè¿™æ„å‘³ç€å®ƒä»¬ä¼šé‡å†™è¢«æ³¨è§£é¡¹çš„æºä»£ç ã€‚ä½ å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æŸ¥çœ‹ç”Ÿæˆçš„æºä»£ç ï¼Œè¯¥å‘½ä»¤è¿˜ä¼šå±•å¼€å…¶ä»–ä¸€äº›å†…å®¹ï¼š</p>
<pre><code class="language-bash">cargo rustc --profile=check -- -Z unstable-options --pretty=expanded &gt; expanded.rs; rustfmt expanded.rs
</code></pre>
<p>ï¼ˆå¦‚æœå°šæœªå®‰è£… <a href="https://github.com/rust-lang-nursery/rustfmt">rustfmt</a>ï¼Œä½ å¯èƒ½éœ€è¦å…ˆå®‰è£…å®ƒã€‚ï¼‰</p>
<p>ä½ ä¹Ÿå¯ä»¥é€šè¿‡æ·»åŠ  <code>-Z trace-macros</code> æ¥è°ƒè¯•ç»å…¸çš„ <code>!</code>-å®ï¼š</p>
<pre><code class="language-bash">cargo rustc --profile=check -- -Z unstable-options --pretty=expanded -Z trace-macros &gt; expanded.rs; rustfmt expanded.rs
</code></pre>
<p>è¯·æ³¨æ„ï¼Œè¿™äº›å‘½ä»¤éœ€è¦ä½¿ç”¨ Rust çš„ nightly ç‰ˆæœ¬ï¼Œå¶å°”å¯èƒ½ä¼šæœ‰ bugã€‚æœ‰å…³æ›´å¤æ‚ä¸”ç¨³å®šçš„ç‰ˆæœ¬ï¼Œè¯·å‚é˜… <a href="https://github.com/dtolnay/cargo-expand">cargo expand</a>ã€‚</p>
<h2 id="ä½¿ç”¨-valgrind-è¿è¡Œ"><a class="header" href="#ä½¿ç”¨-valgrind-è¿è¡Œ">ä½¿ç”¨ Valgrind è¿è¡Œ</a></h2>
<p>Valgrind æ˜¯ä¸€ç§ç”¨äºæ£€æµ‹å†…å­˜ç®¡ç†é”™è¯¯ï¼ˆå¦‚å†…å­˜æ³„æ¼ï¼‰çš„å·¥å…·ã€‚</p>
<p>ä½ é¦–å…ˆéœ€è¦å®‰è£… Python çš„è°ƒè¯•ç‰ˆæœ¬ï¼Œå¦åˆ™ Valgrind å°†æ— æ³•äº§ç”Ÿå¯ç”¨çš„ç»“æœã€‚åœ¨ Ubuntu ä¸Šï¼Œä¾‹å¦‚æœ‰ <code>python3-dbg</code> åŒ…ã€‚</p>
<p>æ¿€æ´»åŒ…å«è°ƒè¯•è§£é‡Šå™¨çš„ç¯å¢ƒå¹¶é‡æ–°ç¼–è¯‘ã€‚å¦‚æœä½ ä½¿ç”¨çš„æ˜¯ Linuxï¼Œè¯·ä½¿ç”¨ <code>ldd</code> æ£€æŸ¥ä½ çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œç¡®è®¤ä½ é“¾æ¥çš„æ˜¯ç±»ä¼¼ <code>libpython3.7d.so.1.0</code> çš„åº“ï¼Œè€Œä¸æ˜¯ <code>libpython3.7.so.1.0</code>ã€‚</p>
<p><a href="https://raw.githubusercontent.com/python/cpython/master/Misc/valgrind-python.supp">ä¸‹è½½ CPython çš„æŠ‘åˆ¶æ–‡ä»¶</a>ã€‚</p>
<p>ä½¿ç”¨ <code>valgrind --suppressions=valgrind-python.supp ./my-command --with-options</code> è¿è¡Œ Valgrindã€‚</p>
<h2 id="è·å–å †æ ˆè·Ÿè¸ª"><a class="header" href="#è·å–å †æ ˆè·Ÿè¸ª">è·å–å †æ ˆè·Ÿè¸ª</a></h2>
<p>è°ƒæŸ¥å´©æºƒï¼ˆå¦‚æ®µé”™è¯¯ï¼‰çš„æœ€ä½³èµ·ç‚¹æ˜¯å †æ ˆè·Ÿè¸ªã€‚ä½ å¯ä»¥å°† <code>RUST_BACKTRACE=1</code> è®¾ç½®ä¸ºç¯å¢ƒå˜é‡ï¼Œä»¥åœ¨ <code>panic!</code> æ—¶è·å–å †æ ˆè·Ÿè¸ªã€‚æˆ–è€…ï¼Œä½ å¯ä»¥ä½¿ç”¨ <code>gdb</code> ç­‰è°ƒè¯•å™¨æ¥æ’æŸ¥é—®é¢˜ã€‚Rust æä¾›äº†ä¸€ä¸ªåŒ…è£…å™¨ <code>rust-gdb</code>ï¼Œå®ƒå…·å¤‡æ£€æŸ¥ Rust å˜é‡çš„ç¾è§‚æ‰“å°åŠŸèƒ½ã€‚ç”±äº PyO3 åœ¨ Python å…±äº«å¯¹è±¡ä¸­ä½¿ç”¨ <code>cdylib</code>ï¼Œå› æ­¤å®ƒä¸ä¼šåœ¨ <code>rust-gdb</code> ä¸­æ¥æ”¶åˆ°ç¾è§‚æ‰“å°çš„è°ƒè¯•é’©å­ï¼ˆ<a href="https://github.com/rust-lang/rust/issues/96365">rust-lang/rust#96365</a>ï¼‰ã€‚ä¸Šè¿°é—®é¢˜ä¸­åŒ…å«å¯ç”¨æ­¤æƒ…å†µä¸‹ç¾è§‚æ‰“å°çš„å˜é€šæ–¹æ³•ã€‚</p>
<ul>
<li>å¦‚å‰ä¸€ç« èŠ‚æ‰€è¿°ï¼Œé“¾æ¥åˆ° Python çš„è°ƒè¯•ç‰ˆæœ¬</li>
<li>è¿è¡Œ <code>rust-gdb &lt;my-binary&gt;</code></li>
<li>å¦‚æœä½ åœ¨è°ƒæŸ¥ <code>panic!</code>ï¼Œè¯·åœ¨ <code>rust_panic</code> ä¸Šè®¾ç½®æ–­ç‚¹ï¼ˆ<code>b</code>ï¼‰</li>
<li>è¾“å…¥ <code>r</code> æ¥è¿è¡Œ</li>
<li>å´©æºƒå‘ç”Ÿåï¼Œè¾“å…¥ <code>bt</code> æˆ– <code>bt full</code> æ‰“å°å †æ ˆè·Ÿè¸ª</li>
</ul>
<p>é€šå¸¸è¿è¡Œä¸€å°æ®µ Python ä»£ç æ¥æµ‹è¯• Rust çš„æŸéƒ¨åˆ†ä»£ç ä¼šå¾ˆæœ‰å¸®åŠ©ã€‚</p>
<pre><code class="language-console">rust-gdb --args python -c "import my_package; my_package.sum_to_string(1, 2)"
</code></pre>
<h2 id="åœ¨ä½ çš„-rust-ä»£ç ä¸­è®¾ç½®æ–­ç‚¹"><a class="header" href="#åœ¨ä½ çš„-rust-ä»£ç ä¸­è®¾ç½®æ–­ç‚¹">åœ¨ä½ çš„ Rust ä»£ç ä¸­è®¾ç½®æ–­ç‚¹</a></h2>
<p>å¼€å‘äººå‘˜è°ƒè¯•ä»£ç çš„é¦–é€‰æ–¹æ³•ä¹‹ä¸€æ˜¯è®¾ç½®æ–­ç‚¹ã€‚åœ¨ PyO3 ä¸­ï¼Œå¯ä»¥é€šè¿‡ä½¿ç”¨ <code>rust-gdb</code> æˆ– <code>rust-lldb</code> ç­‰è°ƒè¯•å™¨ä¸ Python è§£é‡Šå™¨ä¸€èµ·å®Œæˆæ­¤æ“ä½œã€‚</p>
<p>æœ‰å…³å¦‚ä½•ä½¿ç”¨ <code>lldb</code> å’Œ <code>gdb</code> çš„æ›´å¤šä¿¡æ¯ï¼Œä½ å¯ä»¥é˜…è¯» lldb æ–‡æ¡£ä¸­çš„ <a href="https://lldb.llvm.org/use/map.html">gdb åˆ° lldb å‘½ä»¤æ˜ å°„</a>ã€‚</p>
<h3 id="å¸¸è§„è®¾ç½®"><a class="header" href="#å¸¸è§„è®¾ç½®">å¸¸è§„è®¾ç½®</a></h3>
<ol>
<li>
<p>ä½¿ç”¨è°ƒè¯•ç¬¦å·ç¼–è¯‘ä½ çš„æ‰©å±•ï¼š</p>
<pre><code class="language-bash"># Debug æ˜¯ maturin çš„é»˜è®¤é€‰é¡¹ï¼Œä½†ä½ å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼æ˜¾å¼ç¡®ä¿è°ƒè¯•ç¬¦å·ï¼š
RUSTFLAGS="-g" maturin develop


# å¯¹äº setuptools-rust ç”¨æˆ·ï¼š
pip install -e .
</code></pre>
<blockquote>
<p><strong>æ³¨æ„</strong>ï¼šä½¿ç”¨è°ƒè¯•å™¨æ—¶ï¼Œè¯·ç¡®ä¿ <code>python</code> è§£æä¸ºå®é™…çš„ Python äºŒè¿›åˆ¶æ–‡ä»¶æˆ–ç¬¦å·é“¾æ¥ï¼Œè€Œä¸æ˜¯ shim è„šæœ¬ã€‚æŸäº›å·¥å…·ï¼ˆå¦‚ pyenvï¼‰ä½¿ç”¨ shim è„šæœ¬ï¼Œå¯èƒ½ä¼šå¹²æ‰°è°ƒè¯•ã€‚</p>
</blockquote>
</li>
</ol>
<h3 id="è°ƒè¯•å™¨ç‰¹å®šè®¾ç½®"><a class="header" href="#è°ƒè¯•å™¨ç‰¹å®šè®¾ç½®">è°ƒè¯•å™¨ç‰¹å®šè®¾ç½®</a></h3>
<p>æ ¹æ®ä½ çš„æ“ä½œç³»ç»Ÿå’Œåå¥½ï¼Œä½ å¯ä»¥ä½¿ç”¨ä¸¤ç§ä¸åŒçš„è°ƒè¯•å™¨ï¼š<code>rust-gdb</code> æˆ– <code>rust-lldb</code>ã€‚</p>
<div class="mdbook-tabs-container">
<nav class="mdbook-tabs">
<button class="mdbook-tab active" data-tabname="ä½¿ç”¨ rust-gdb">ä½¿ç”¨ rust-gdb</button>
<button class="mdbook-tab" data-tabname="ä½¿ç”¨ rust-lldbï¼ˆmacOS ç”¨æˆ·ï¼‰">ä½¿ç”¨ rust-lldbï¼ˆmacOS ç”¨æˆ·ï¼‰</button>
</nav>
<div class="mdbook-tab-content" data-tabname="ä½¿ç”¨ rust-gdb">
<ol>
<li>
<p>ä½¿ç”¨ Python è§£é‡Šå™¨å¯åŠ¨ rust-gdbï¼š</p>
<pre><code class="language-bash">rust-gdb --args python
</code></pre>
</li>
<li>
<p>è¿›å…¥ gdb åï¼Œåœ¨ä½ çš„ Rust ä»£ç ä¸­è®¾ç½®æ–­ç‚¹ï¼š</p>
<pre><code class="language-bash">(gdb) break your_module.rs:42
</code></pre>
</li>
<li>
<p>è¿è¡Œå¯¼å…¥å¹¶ä½¿ç”¨ä½ çš„ Rust æ‰©å±•çš„ Python è„šæœ¬ï¼š</p>
<pre><code class="language-bash"># é€‰é¡¹ 1ï¼šè¿è¡Œå†…è” Python å‘½ä»¤
(gdb) run -c "import your_module; your_module.your_function()"


# é€‰é¡¹ 2ï¼šè¿è¡Œ Python è„šæœ¬
(gdb) run your_script.py


# é€‰é¡¹ 3ï¼šè¿è¡Œ pytest æµ‹è¯•
(gdb) run -m pytest tests/test_something.py::TestName
</code></pre>
</li>
</ol>
</div>

<div class="mdbook-tab-content hidden" data-tabname="ä½¿ç”¨ rust-lldbï¼ˆmacOS ç”¨æˆ·ï¼‰">
<ol>
<li>
<p>ä½¿ç”¨ Python å¯åŠ¨ rust-lldbï¼š</p>
<pre><code class="language-bash">rust-lldb -- python
</code></pre>
</li>
<li>
<p>åœ¨ä½ çš„ Rust ä»£ç ä¸­è®¾ç½®æ–­ç‚¹ï¼š</p>
<pre><code class="language-bash">(lldb) breakpoint set --file your_module.rs --line 42
</code></pre>
</li>
<li>
<p>è¿è¡Œä½ çš„ Python è„šæœ¬ï¼š</p>
<pre><code class="language-bash"># é€‰é¡¹ 1ï¼šè¿è¡Œå†…è” Python å‘½ä»¤
(lldb) run -c "import your_module; your_module.your_function()"


# é€‰é¡¹ 2ï¼šè¿è¡Œ Python è„šæœ¬
(lldb) run your_script.py


# é€‰é¡¹ 3ï¼šè¿è¡Œ pytest æµ‹è¯•
(lldb) run -m pytest tests/test_something.py::TestName
</code></pre>
</li>
</ol>
</div>

</div>

<h3 id="ä½¿ç”¨-vs-code"><a class="header" href="#ä½¿ç”¨-vs-code">ä½¿ç”¨ VS Code</a></h3>
<p>å¸¦æœ‰ Rust å’Œ Python æ‰©å±•çš„ VS Code æä¾›äº†é›†æˆçš„è°ƒè¯•ä½“éªŒï¼š</p>
<ol>
<li>
<p>é¦–å…ˆï¼Œå®‰è£…å¿…è¦çš„ VS Code æ‰©å±•ï¼š</p>
<ul>
<li><a href="https://marketplace.visualstudio.com/items?itemName=rust-lang.rust-analyzer">Rust Analyzer</a></li>
<li><a href="https://marketplace.visualstudio.com/items?itemName=vadimcn.vscode-lldb">CodeLLDB</a></li>
<li><a href="https://marketplace.visualstudio.com/items?itemName=ms-python.python">Python</a></li>
</ul>
</li>
<li>
<p>åˆ›å»ºä¸€ä¸ª <code>.vscode/launch.json</code> æ–‡ä»¶ï¼Œå…¶ä¸­åŒ…å«ä½¿ç”¨ LLDB Debug Launcher çš„é…ç½®ï¼š</p>
<pre><code class="language-json">{
    "version": "0.2.0",
    "configurations": [
        {
            "name": "Debug PyO3",
            "type": "lldb",
            "request": "attach",
            "program": "${workspaceFolder}/.venv/bin/python",
            "pid": "${command:pickProcess}",
            "sourceLanguages": [
                "rust"
            ]
        },
        {
            "name": "Launch Python with PyO3",
            "type": "lldb",
            "request": "launch",
            "program": "${workspaceFolder}/.venv/bin/python",
            "args": ["${file}"],
            "cwd": "${workspaceFolder}",
            "sourceLanguages": ["rust"]
        },
        {
            "name": "Debug PyO3 with Args",
            "type": "lldb",
            "request": "launch",
            "program": "${workspaceFolder}/.venv/bin/python",
            "args": ["path/to/your/script.py", "arg1", "arg2"],
            "cwd": "${workspaceFolder}",
            "sourceLanguages": ["rust"]
        },
        {
            "name": "Debug PyO3 Tests",
            "type": "lldb",
            "request": "launch",
            "program": "${workspaceFolder}/.venv/bin/python",
            "args": ["-m", "pytest", "tests/your_test.py::test_function", "-v"],
            "cwd": "${workspaceFolder}",
            "sourceLanguages": ["rust"]
        }
     ]
}
</code></pre>
<p>æ­¤é…ç½®æ”¯æŒå¤šç§è°ƒè¯•åœºæ™¯ï¼š</p>
<ul>
<li>é™„åŠ åˆ°æ­£åœ¨è¿è¡Œçš„ Python è¿›ç¨‹</li>
<li>å¯åŠ¨å½“å‰æ‰“å¼€çš„ Python æ–‡ä»¶</li>
<li>ä½¿ç”¨å‘½ä»¤è¡Œå‚æ•°è¿è¡Œç‰¹å®šè„šæœ¬</li>
<li>è¿è¡Œ pytest æµ‹è¯•</li>
</ul>
</li>
</ol>
<!-- rumdl-disable MD029 - nested lists & code blocks false positive -->
<ol start="3">
<li>
<p>é€šè¿‡å•å‡»è¡Œå·æ—çš„ç©ºç™½åŒºåŸŸåœ¨ä½ çš„ Rust ä»£ç ä¸­è®¾ç½®æ–­ç‚¹ã€‚</p>
</li>
<li>
<p>å¼€å§‹è°ƒè¯•ï¼š</p>
<ul>
<li>è¦é™„åŠ åˆ°æ­£åœ¨è¿è¡Œçš„ Python è¿›ç¨‹ï¼šé¦–å…ˆå¯åŠ¨è¿›ç¨‹ï¼Œç„¶åé€‰æ‹©â€œDebug PyO3â€é…ç½®å¹¶ç‚¹å‡»â€œå¼€å§‹è°ƒè¯•â€ï¼ˆF5ï¼‰ã€‚ç³»ç»Ÿå°†æç¤ºä½ é€‰æ‹©è¦é™„åŠ çš„ Python è¿›ç¨‹ã€‚</li>
<li>è¦å¯åŠ¨ Python è„šæœ¬ï¼šæ‰“å¼€ä½ çš„ Python è„šæœ¬ï¼Œé€‰æ‹©â€œLaunch Python with PyO3â€é…ç½®å¹¶ç‚¹å‡»â€œå¼€å§‹è°ƒè¯•â€ï¼ˆF5ï¼‰ã€‚</li>
<li>è¦è¿è¡Œå¸¦å‚æ•°çš„è„šæœ¬ï¼šé€‰æ‹©â€œDebug PyO3 with Argsâ€ï¼ˆè®°å¾—ç”¨å®é™…è„šæœ¬è·¯å¾„å’Œå‚æ•°ç¼–è¾‘é…ç½®ï¼‰ã€‚</li>
<li>è¦è¿è¡Œæµ‹è¯•ï¼šé€‰æ‹©â€œDebug PyO3 Testsâ€ï¼ˆæ ¹æ®éœ€è¦ç¼–è¾‘æµ‹è¯•è·¯å¾„ï¼‰ã€‚</li>
</ul>
</li>
<li>
<p>åœ¨è°ƒè¯• PyO3 ä»£ç æ—¶ï¼š</p>
<ul>
<li>ä½ å¯ä»¥æ£€æŸ¥ Rust å˜é‡å’Œæ•°æ®ç»“æ„</li>
<li>ä½¿ç”¨è°ƒè¯•æ§åˆ¶å°æ±‚å€¼è¡¨è¾¾å¼</li>
<li>ä½¿ç”¨æ­¥è¿›æ§ä»¶é€è¡Œæ‰§è¡Œ Rust ä»£ç </li>
<li>è®¾ç½®æ¡ä»¶æ–­ç‚¹ç”¨äºæ›´å¤æ‚çš„è°ƒè¯•åœºæ™¯</li>
</ul>
</li>
</ol>
<!-- rumdl-enable MD029 -->
<h3 id="é«˜çº§è°ƒè¯•é…ç½®"><a class="header" href="#é«˜çº§è°ƒè¯•é…ç½®">é«˜çº§è°ƒè¯•é…ç½®</a></h3>
<p>å¯¹äºé«˜çº§è°ƒè¯•åœºæ™¯ï¼Œä½ å¯èƒ½å¸Œæœ›æ·»åŠ ç¯å¢ƒå˜é‡æˆ–å¯ç”¨ç‰¹å®šçš„ Rust è°ƒè¯•æ ‡å¿—ï¼š</p>
<pre><code class="language-json">{
    "name": "Debug PyO3 with Environment",
    "type": "lldb",
    "request": "launch",
    "program": "${workspaceFolder}/.venv/bin/python",
    "args": ["${file}"],
    "env": {
        "RUST_BACKTRACE": "1",
        "PYTHONPATH": "${workspaceFolder}"
    },
    "sourceLanguages": ["rust"]
}
</code></pre>
<h3 id="ä»-jupyter-notebook-è°ƒè¯•"><a class="header" href="#ä»-jupyter-notebook-è°ƒè¯•">ä» Jupyter Notebook è°ƒè¯•</a></h3>
<p>å¯¹äºä» VS Code è¿è¡Œçš„ Jupyter Notebookï¼Œä½ å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å¸®åŠ©å‡½æ•°æ¥è‡ªåŠ¨åŒ–å¯åŠ¨é…ç½®ï¼š</p>
<pre><code class="language-python">from pathlib import Path
import os
import json
import sys




def update_launch_json(vscode_config_file_path=None):
    """æ›´æ–° VSCode launch.json ä»¥åŒ…å«æ­£ç¡®çš„ Jupyter å†…æ ¸ PIDã€‚


    å‚æ•°ï¼š
        vscode_config_file_path (str, å¯é€‰)ï¼š.vscode/launch.json æ–‡ä»¶çš„è·¯å¾„ã€‚
            å¦‚æœæœªæä¾›ï¼Œå°†ä½¿ç”¨å½“å‰å·¥ä½œç›®å½•ã€‚
    """
    pid = get_jupyter_kernel_pid()
    if not pid:
        print("æ— æ³•ç¡®å®š Jupyter å†…æ ¸ PIDã€‚")
        return


    # ç¡®å®š launch.json è·¯å¾„
    if vscode_config_file_path:
        launch_json_path = vscode_config_file_path
    else:
        launch_json_path = os.path.join(Path(os.getcwd()), ".vscode", "launch.json")


    # è·å– Python è§£é‡Šå™¨è·¯å¾„
    python_path = sys.executable


    # é»˜è®¤è°ƒè¯•å™¨é…ç½®
    debug_config = {
        "version": "0.2.0",
        "configurations": [
            {
                "name": "Debug PyO3 (Jupyter)",
                "type": "lldb",
                "request": "attach",
                "program": python_path,
                "pid": pid,
                "sourceLanguages": ["rust"],
            },
            {
                "name": "Launch Python with PyO3",
                "type": "lldb",
                "request": "launch",
                "program": python_path,
                "args": ["${file}"],
                "cwd": "${workspaceFolder}",
                "sourceLanguages": ["rust"]
            }
        ],
    }


    # å¦‚æœ .vscode ç›®å½•ä¸å­˜åœ¨åˆ™åˆ›å»º
    try:
        os.makedirs(os.path.dirname(launch_json_path), exist_ok=True)


        # å¦‚æœ launch.json å·²å­˜åœ¨ï¼Œå°è¯•æ›´æ–°è€Œä¸æ˜¯è¦†ç›–
        if os.path.exists(launch_json_path):
            try:
                with open(launch_json_path, "r") as f:
                    existing_config = json.load(f)


                # æ£€æŸ¥æˆ‘ä»¬çš„é…ç½®æ˜¯å¦å·²å­˜åœ¨
                config_exists = False
                for config in existing_config.get("configurations", []):
                    if config.get("name") == "Debug PyO3 (Jupyter)":
                        config["pid"] = pid
                        config["program"] = python_path
                        config_exists = True


                if not config_exists:
                    existing_config.setdefault("configurations", []).append(debug_config["configurations"][0])


                debug_config = existing_config
            except Exception:
                # å¦‚æœè¯»å–å‡ºé”™ï¼Œæˆ‘ä»¬å°†ç›´æ¥ç”¨æ–°é…ç½®è¦†ç›–
                pass


        with open(launch_json_path, "w") as f:
            json.dump(debug_config, f, indent=4)
        print(f"å·²ä½¿ç”¨ PID: {pid} æ›´æ–° launch.jsonï¼Œä½ç½®ï¼š{launch_json_path}")
    except Exception as e:
        print(f"æ›´æ–° launch.json æ—¶å‡ºé”™: {e}")




def get_jupyter_kernel_pid():
    """æŸ¥æ‰¾æ­£åœ¨è¿è¡Œçš„ Jupyter å†…æ ¸çš„è¿›ç¨‹ ID (PID)ã€‚


    è¿”å›ï¼š
        int: Jupyter å†…æ ¸çš„è¿›ç¨‹ IDï¼Œå¦‚æœæœªæ‰¾åˆ°åˆ™è¿”å› Noneã€‚
    """
    # æ£€æŸ¥æ˜¯å¦åœ¨ Jupyter ç¯å¢ƒä¸­è¿è¡Œ
    if 'ipykernel' in sys.modules:
        pid = os.getpid()
        print(f"Jupyter å†…æ ¸ PID: {pid}")
        return pid
    else:
        print("æœªåœ¨ Jupyter ç¯å¢ƒä¸­è¿è¡Œã€‚")
        return None
```è¦ä½¿ç”¨è¿™äº›å‡½æ•°ï¼š

1. åœ¨ä½ çš„ Jupyter notebook ä¸­è¿è¡ŒåŒ…å«è¿™äº›å‡½æ•°çš„å•å…ƒæ ¼  
2. åœ¨ä¸€ä¸ªå•å…ƒæ ¼ä¸­è¿è¡Œ `update_launch_json()`  
3. åœ¨ VS Code ä¸­é€‰æ‹© "Debug PyO3 (Jupyter)" é…ç½®å¹¶å¼€å§‹è°ƒè¯•


## çº¿ç¨‹å®‰å…¨ä¸ç¼–è¯‘å™¨æ£€æµ‹å·¥å…·


PyO3 è¯•å›¾éµå¾ª Rust è¯­è¨€çº§åˆ«çš„çº¿ç¨‹å®‰å…¨ä¿è¯ï¼Œä½†è¿™å¹¶ä¸èƒ½æ’é™¤ PyO3 æ§åˆ¶èŒƒå›´ä¹‹å¤–çš„å…¶ä»–ä»£ç ï¼Œæˆ–ç”± PyO3 æ‰©å±•ç®¡ç†çš„æœ‰ç¼ºé™·ä»£ç å¼•å‘çº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚åˆ†æä½¿ç”¨ CPython C API çš„ Rust ä»£ç æ˜¯å¦çº¿ç¨‹å®‰å…¨å¯èƒ½éå¸¸å¤æ‚ï¼Œå› ä¸ºè®¸å¤š Python æ“ä½œéƒ½å¯èƒ½å¯¼è‡´ä»»æ„ Python ä»£ç çš„æ‰§è¡Œã€‚ç›¸æ¯”ä»£ç åˆ†æï¼Œä½¿ç”¨è‡ªåŠ¨åŒ–æ–¹å¼å‘ç°çº¿ç¨‹å®‰å…¨é—®é¢˜é€šå¸¸æ›´æœ‰æ•ˆã€‚

[ThreadSanitizer](https://clang.llvm.org/docs/ThreadSanitizer.html) æ˜¯ä¸€ç§çº¿ç¨‹å®‰å…¨æ£€æŸ¥è¿è¡Œæ—¶å·¥å…·ï¼Œå¯ç”¨äºæ£€æµ‹ç”±çº¿ç¨‹å®‰å…¨æ¼æ´æˆ–è¯¯ç”¨çº¿ç¨‹ä¸å®‰å…¨æ•°æ®ç»“æ„å¼•å‘çš„æ•°æ®ç«äº‰ã€‚è™½ç„¶å®ƒåªèƒ½æ£€æµ‹è¿è¡Œæ—¶è§¦å‘çš„æ•°æ®ç«äº‰ï¼Œä½†ä¸€æ—¦å‘ç°é—®é¢˜ï¼ŒæŠ¥å‘Šé€šå¸¸èƒ½å‡†ç¡®å®šä½é—®é¢˜å‘ç”Ÿçš„ä½ç½®ã€‚

è¦åœ¨ä¾èµ– PyO3 çš„åº“ä¸­ä½¿ç”¨ `ThreadSanitizer`ï¼Œä½ éœ€è¦å®‰è£…ä¸€ä¸ª nightly ç‰ˆæœ¬çš„ Rust å·¥å…·é“¾ï¼Œå¹¶åŒ…å« `rust-src` ç»„ä»¶ï¼Œå› ä¸ºä½ éœ€è¦é‡æ–°ç¼–è¯‘ Rust æ ‡å‡†åº“ï¼š

```bash
rustup install nightly
rustup override set nightly
rustup component add rust-src
</code></pre>
<p>ä½ è¿˜éœ€è¦ä¸€ä¸ªç”¨ LLVM/Clang ç¼–è¯‘çš„ CPython ç‰ˆæœ¬ï¼Œä¸”å…¶æ‰€ç”¨ LLVM ä¸»ç‰ˆæœ¬å·å¿…é¡»ä¸å½“å‰ nightly Rust ä½¿ç”¨çš„ç›¸åŒã€‚æˆªè‡³ 2025 å¹´ 3 æœˆï¼ŒRust nightly ä½¿ç”¨çš„æ˜¯ LLVM 20ã€‚</p>
<p><a href="https://github.com/nascheme/cpython_sanity">cpython_sanity docker é•œåƒ</a> æä¾›äº†ä¸€ä¸ªå¼€å‘ç¯å¢ƒï¼Œå…¶ä¸­åŒ…å«äº†é¢„ç¼–è¯‘çš„ CPython 3.13 æˆ– 3.14 ç‰ˆæœ¬ï¼Œä»¥åŠå¯é€‰çš„ NumPy å’Œ SciPyï¼Œå…¨éƒ¨ä½¿ç”¨ LLVM 20 å’Œ ThreadSanitizer ç¼–è¯‘ã€‚</p>
<p>æ¿€æ´» nightly Rust å·¥å…·é“¾åï¼Œä½ å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤é€šè¿‡ <code>ThreadSanitizer</code> æ„å»ºé¡¹ç›®ï¼š</p>
<pre><code class="language-bash">RUSTFLAGS="-Zsanitizer=thread" maturin develop -Zbuild-std --target x86_64-unknown-linux-gnu
</code></pre>
<p>å¦‚æœä½ ä¸åœ¨ x86_64 æ¶æ„çš„ Linux æœºå™¨ä¸Šè¿è¡Œï¼Œè¯·å°† <code>x86_64-unknown-linux-gnu</code> æ›¿æ¢ä¸ºé€‚ç”¨äºä½ ç³»ç»Ÿçš„ <a href="https://doc.rust-lang.org/rustc/platform-support.html#tier-1-with-host-tools">ç›®æ ‡ä¸‰å…ƒç»„</a>ã€‚ä½ ä¹Ÿå¯ä»¥å°† <code>maturin develop</code> æ›¿æ¢ä¸º <code>cargo test</code> æ¥è¿è¡Œ cargo æµ‹è¯•ã€‚æ³¨æ„ï¼Œ<code>cargo</code> ä½¿ç”¨çº¿ç¨‹æ± è¿è¡Œæµ‹è¯•ï¼Œå› æ­¤ cargo æµ‹è¯•æ˜¯å‘ç°çº¿ç¨‹å®‰å…¨é—®é¢˜çš„ä¸€ç§æœ‰æ•ˆæ–¹å¼ã€‚</p>
<p>ä½ è¿˜å¯ä»¥å°† <code>-Zsanitizer=thread</code> æ›¿æ¢ä¸º <code>-Zsanitizer=address</code>ï¼Œæˆ–å…¶ä»– <a href="https://doc.rust-lang.org/beta/unstable-book/compiler-flags/sanitizer.html">Rust æ”¯æŒçš„æ£€æµ‹å·¥å…·</a>ã€‚è¯·æ³¨æ„ï¼Œä½ éœ€è¦ä½¿ç”¨ç›¸åº”çš„ <a href="https://docs.python.org/3/using/configure.html#cmdoption-with-address-sanitizer">é…ç½®è„šæœ¬é€‰é¡¹</a> ä»æºç æ„å»º CPythonï¼Œä»¥ç¡®ä¿ Python ä¸ä½ çš„ Rust ä»£ç ä½¿ç”¨ç›¸åŒçš„æ£€æµ‹å·¥å…·ç¯å¢ƒã€‚</p>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="åŠŸèƒ½å‚è€ƒ"><a class="header" href="#åŠŸèƒ½å‚è€ƒ">åŠŸèƒ½å‚è€ƒ</a></h1>
<p>PyO3 æä¾›äº†è®¸å¤š Cargo åŠŸèƒ½ä»¥è‡ªå®šä¹‰åŠŸèƒ½ã€‚æœ¬æŒ‡å—çš„è¿™ä¸€ç« èŠ‚è¯¦ç»†ä»‹ç»äº†æ¯ä¸€é¡¹åŠŸèƒ½ã€‚</p>
<p>é»˜è®¤æƒ…å†µä¸‹ï¼Œä»…å¯ç”¨ <code>macros</code> åŠŸèƒ½ã€‚</p>
<h2 id="æ‰©å±•æ¨¡å—ä½œè€…çš„åŠŸèƒ½"><a class="header" href="#æ‰©å±•æ¨¡å—ä½œè€…çš„åŠŸèƒ½">æ‰©å±•æ¨¡å—ä½œè€…çš„åŠŸèƒ½</a></h2>
<h3 id="extension-module"><a class="header" href="#extension-module"><code>extension-module</code></a></h3>
<p>åœ¨ä½¿ç”¨ PyO3 æ„å»º Python æ‰©å±•æ¨¡å—æ—¶å¿…é¡»å¯ç”¨æ­¤åŠŸèƒ½ã€‚</p>
<p>å®ƒä¼šå‘Šè¯‰ PyO3 çš„æ„å»ºè„šæœ¬è·³è¿‡åœ¨ Unix å¹³å°ä¸Šé“¾æ¥ <code>libpython.so</code>ï¼Œå› ä¸ºè¿™åœ¨æŸäº›æƒ…å†µä¸‹æ˜¯ä¸å…è®¸çš„ã€‚</p>
<p>æ›´å¤šç»†èŠ‚è¯·å‚è§ <a href="#the-extension-module-feature">æ„å»ºä¸åˆ†å‘</a> éƒ¨åˆ†ã€‚</p>
<h3 id="abi3"><a class="header" href="#abi3"><code>abi3</code></a></h3>
<p>æ­¤åŠŸèƒ½åœ¨æ„å»º Python æ‰©å±•æ¨¡å—æ—¶ä½¿ç”¨ï¼Œç”¨äºåˆ›å»ºä¸å¤šä¸ª Python ç‰ˆæœ¬å…¼å®¹çš„ wheel åŒ…ã€‚</p>
<p>å®ƒå°† PyO3 çš„ API é™åˆ¶ä¸º <a href="https://www.python.org/dev/peps/pep-0384/">PEP 384</a> æ‰€ä¿è¯çš„ã€ä¸æœªæ¥ Python ç‰ˆæœ¬å‘å‰å…¼å®¹çš„ Python API å­é›†ã€‚</p>
<p>æ›´å¤šç»†èŠ‚è¯·å‚è§ <a href="#py_limited_apiabi3">æ„å»ºä¸åˆ†å‘</a> éƒ¨åˆ†ã€‚</p>
<h3 id="abi3-pyxy-ç³»åˆ—åŠŸèƒ½"><a class="header" href="#abi3-pyxy-ç³»åˆ—åŠŸèƒ½"><code>abi3-pyXY</code> ç³»åˆ—åŠŸèƒ½</a></h3>
<p>ï¼ˆ<code>abi3-py37</code>ã€<code>abi3-py38</code>ã€<code>abi3-py39</code>ã€<code>abi3-py310</code> å’Œ <code>abi3-py311</code>ï¼‰</p>
<p>è¿™äº›åŠŸèƒ½æ˜¯å¯¹ <code>abi3</code> åŠŸèƒ½çš„æ‰©å±•ï¼Œç”¨äºæŒ‡å®šå¤šç‰ˆæœ¬ wheel åŒ…æ‰€æ”¯æŒçš„æœ€ä½ Python ç‰ˆæœ¬ã€‚</p>
<p>æ›´å¤šç»†èŠ‚è¯·å‚è§ <a href="#minimum-python-version-for-abi3">æ„å»ºä¸åˆ†å‘</a> éƒ¨åˆ†ã€‚</p>
<h3 id="generate-import-lib"><a class="header" href="#generate-import-lib"><code>generate-import-lib</code></a></h3>
<p>æ­¤å®éªŒæ€§åŠŸèƒ½ç”¨äºä¸º MinGW-w64 å’Œ MSVCï¼ˆäº¤å‰ï¼‰ç¼–è¯‘ç›®æ ‡ç”Ÿæˆ Python DLL çš„å¯¼å…¥åº“ã€‚</p>
<p>å¯ç”¨æ­¤åŠŸèƒ½åï¼Œå¯åœ¨æ— éœ€å®‰è£…ç›®æ ‡å¹³å°çš„ Windows Python å‘è¡Œæ–‡ä»¶çš„æƒ…å†µä¸‹ï¼Œäº¤å‰ç¼–è¯‘æ‰©å±•æ¨¡å—è‡³ä»»æ„ Windows ç›®æ ‡å¹³å°ã€‚</p>
<p>æ›´å¤šç»†èŠ‚è¯·å‚è§ <a href="#building-abi3-extensions-without-a-python-interpreter">æ„å»ºä¸åˆ†å‘</a> éƒ¨åˆ†ã€‚</p>
<h2 id="åœ¨-rust-ä¸­åµŒå…¥-python-çš„åŠŸèƒ½"><a class="header" href="#åœ¨-rust-ä¸­åµŒå…¥-python-çš„åŠŸèƒ½">åœ¨ Rust ä¸­åµŒå…¥ Python çš„åŠŸèƒ½</a></h2>
<h3 id="auto-initialize"><a class="header" href="#auto-initialize"><code>auto-initialize</code></a></h3>
<p>æ­¤åŠŸèƒ½ä¼šæ”¹å˜ <a href="{{#PYO3_DOCS_URL}}/pyo3/marker/struct.Python.html#method.attach"><code>Python::attach</code></a>ï¼Œåœ¨éœ€è¦æ—¶è‡ªåŠ¨åˆå§‹åŒ– Python è§£é‡Šå™¨ï¼ˆé€šè¿‡è°ƒç”¨ <a href="{{#PYO3_DOCS_URL}}/pyo3/marker/struct.Python.html#method.initialize"><code>Python::initialize</code></a>ï¼‰ã€‚</p>
<p>å¦‚æœä½ æœªå¯ç”¨æ­¤åŠŸèƒ½ï¼Œåˆ™åº”åœ¨è°ƒç”¨å…¶ä»–ä»»ä½• Python API å‰æ‰‹åŠ¨è°ƒç”¨ <code>Python::initialize()</code>ã€‚</p>
<h2 id="é«˜çº§åŠŸèƒ½"><a class="header" href="#é«˜çº§åŠŸèƒ½">é«˜çº§åŠŸèƒ½</a></h2>
<h3 id="experimental-async"><a class="header" href="#experimental-async"><code>experimental-async</code></a></h3>
<p>æ­¤åŠŸèƒ½ä¸º <code>#[pyfunction]</code> å’Œ <code>#[pymethods]</code> æ·»åŠ å¯¹ <code>async fn</code> çš„æ”¯æŒã€‚</p>
<p>è¯¥åŠŸèƒ½ä»æœ‰ä¸€äº›æœªå®Œæˆçš„ä¼˜åŒ–å’Œæ€§èƒ½æ”¹è¿›ã€‚ä¸ºå¸®åŠ©å®Œæˆæ­¤åŠŸèƒ½ï¼Œè¯·å‚é˜… <a href="https://github.com/PyO3/pyo3/issues/1632">issue #1632</a> åŠå…¶ç›¸å…³è‰ç¨¿ PRã€‚</p>
<h3 id="experimental-inspect"><a class="header" href="#experimental-inspect"><code>experimental-inspect</code></a></h3>
<p>æ­¤åŠŸèƒ½ä¸ºæ„å»ºçš„äºŒè¿›åˆ¶æ–‡ä»¶æ·»åŠ å†…çœæ•°æ®ï¼Œè¿™äº›æ•°æ®å¯ä½¿ç”¨ <code>pyo3-introspection</code> crate æå–ï¼Œä»¥ç”Ÿæˆ <a href="https://typing.readthedocs.io/en/latest/source/stubs.html">ç±»å‹å­˜æ ¹</a>ã€‚</p>
<p>æ­¤å¤–ï¼Œæ­¤åŠŸèƒ½è¿˜æ·»åŠ äº† <code>pyo3::inspect</code> æ¨¡å—ï¼Œä»¥åŠ <code>IntoPy::type_output</code> å’Œ <code>FromPyObject::type_input</code> APIï¼Œç”¨äºä¸º Rust ç±»å‹ç”Ÿæˆ Python ç±»å‹â€œæ³¨è§£â€ã€‚</p>
<p>è¿™æ˜¯ä¸º PyO3 æ·»åŠ ç”Ÿæˆç±»å‹æ³¨è§£è‡ªåŠ¨æ”¯æŒçš„ç¬¬ä¸€æ­¥ï¼Œä½†ä»æœ‰å·¥ä½œéœ€è¦å®Œæˆã€‚æ¬¢è¿åœ¨ <a href="https://github.com/PyO3/pyo3/issues/2454">issue #2454</a> ä¸­æä¾›åé¦ˆæˆ–ååŠ©ã€‚</p>
<h3 id="py-clone"><a class="header" href="#py-clone"><code>py-clone</code></a></h3>
<p>æ­¤åŠŸèƒ½ä¸ºç®€åŒ–è¿ç§»è€Œå¼•å…¥ã€‚å‘ç°å»¶è¿Ÿå¼•ç”¨è®¡æ•°ï¼ˆPyO3 è¿‡å»ä½¿ç”¨çš„æ–¹å¼ï¼‰æ— æ³•ä¿è¯å®‰å…¨æ€§ï¼Œå› æ­¤åœ¨æœªè¿æ¥åˆ° Python è§£é‡Šå™¨æ—¶æ— æ³• <code>Clone</code> <code>Py&lt;T&gt;</code> å®ä¾‹ï¼ˆä¼š panicï¼‰ã€‚ä¸ºé¿å…è¿ç§»è¿‡ç¨‹ä¸­æ— é¢„è­¦åœ°å¼•å…¥æ–° panicï¼Œ<code>Clone</code> çš„å®ç°ç°åœ¨ç”±è¯¥åŠŸèƒ½æ§åˆ¶ã€‚</p>
<h3 id="pyo3_disable_reference_pool"><a class="header" href="#pyo3_disable_reference_pool"><code>pyo3_disable_reference_pool</code></a></h3>
<p>è¿™æ˜¯ä¸€ä¸ªé¢å‘æ€§èƒ½çš„æ¡ä»¶ç¼–è¯‘æ ‡å¿—ï¼Œä¾‹å¦‚é€šè¿‡ <code>$RUSTFLAGS</code> è®¾ç½®ï¼Œå®ƒä¼šç¦ç”¨å…¨å±€å¼•ç”¨æ± ï¼Œå‡å°‘è·¨ Python-Rust è¾¹ç•Œçš„å¼€é”€ã€‚ä½†å¦‚æœå¯ç”¨æ­¤åŠŸèƒ½ï¼Œå½“æœªè¿æ¥åˆ° Python è§£é‡Šå™¨æ—¶ <code>Drop</code> ä¸€ä¸ª <code>Py&lt;T&gt;</code> å®ä¾‹ä¼šå¯¼è‡´è¿›ç¨‹ç»ˆæ­¢ã€‚</p>
<h3 id="macros"><a class="header" href="#macros"><code>macros</code></a></h3>
<p>æ­¤åŠŸèƒ½å¯ç”¨å¯¹ <code>pyo3-macros</code> crate çš„ä¾èµ–ï¼Œè¯¥ crate æä¾› PyO3 API ä¸­çš„è¿‡ç¨‹å®éƒ¨åˆ†ï¼š</p>
<ul>
<li><code>#[pymodule]</code></li>
<li><code>#[pyfunction]</code></li>
<li><code>#[pyclass]</code></li>
<li><code>#[pymethods]</code></li>
<li><code>#[derive(FromPyObject)]</code></li>
</ul>
<p>åŒæ—¶è¿˜æä¾› <code>py_run!</code> å®ã€‚</p>
<p>è¿™äº›å®éœ€è¦è¾ƒå¤šä¾èµ–é¡¹ï¼Œè€Œä»…éœ€ä½¿ç”¨ PyO3 è¿›è¡Œ Python FFI çš„ç”¨æˆ·å¯èƒ½å¹¶ä¸éœ€è¦ã€‚ç¦ç”¨æ­¤åŠŸèƒ½å¯ä½¿è¿™äº›ç”¨æˆ·çš„æ„å»ºæ›´å¿«ï¼Œå› ä¸ºç¦ç”¨åå°†ä¸ä¼šæ„å»ºè¿™äº›ä¾èµ–é¡¹ã€‚</p>
<blockquote>
<p>æ­¤åŠŸèƒ½é»˜è®¤å¯ç”¨ã€‚è¦ç¦ç”¨ï¼Œè¯·åœ¨ Cargo.toml ä¸­å°† <code>pyo3</code> æ¡ç›®çš„ <code>default-features</code> è®¾ç½®ä¸º <code>false</code>ã€‚</p>
</blockquote>
<h3 id="multiple-pymethods"><a class="header" href="#multiple-pymethods"><code>multiple-pymethods</code></a></h3>
<p>æ­¤åŠŸèƒ½å…è®¸æ¯ä¸ª <code>#[pyclass]</code> æ‹¥æœ‰å¤šä¸ª <code>#[pymethods]</code> å—ã€‚</p>
<p>å¤§å¤šæ•°ç”¨æˆ·åªéœ€ä¸ºæ¯ä¸ª <code>#[pyclass]</code> ä½¿ç”¨ä¸€ä¸ª <code>#[pymethods]</code> å—å³å¯ã€‚æ­¤å¤–ï¼Œè¯¥åŠŸèƒ½ä¾èµ–çš„ <code>inventory</code> åœ¨æŸäº›å¹³å°ï¼ˆå¦‚ Wasmï¼‰ä¸Šä¸å—æ”¯æŒã€‚å› æ­¤æ­¤åŠŸèƒ½é»˜è®¤æœªå¯ç”¨ï¼Œä»¥å‡å°‘å¤§å¤šæ•°ç”¨æˆ·çš„ä¾èµ–é¡¹å¹¶åŠ å¿«ç¼–è¯‘é€Ÿåº¦ã€‚</p>
<p>æ›´å¤šä¿¡æ¯è¯·è§ <a href="#implementation-details">#[pyclass] çš„å®ç°ç»†èŠ‚</a>ã€‚</p>
<h3 id="nightly"><a class="header" href="#nightly"><code>nightly</code></a></h3>
<p><code>nightly</code> åŠŸèƒ½éœ€è¦ä½¿ç”¨ nightly ç‰ˆæœ¬çš„ Rust ç¼–è¯‘å™¨ã€‚å®ƒå…è®¸ PyO3 ä½¿ç”¨ <code>auto_traits</code> å’Œ <code>negative_impls</code> ç‰¹æ€§ï¼Œä»¥ä¿®å¤ <code>Python::detach</code> å‡½æ•°ã€‚</p>
<h3 id="resolve-config"><a class="header" href="#resolve-config"><code>resolve-config</code></a></h3>
<p><code>pyo3-build-config</code> crate çš„ <code>resolve-config</code> åŠŸèƒ½æ§åˆ¶å…¶æ„å»ºè„šæœ¬æ˜¯å¦è‡ªåŠ¨è§£æ Python è§£é‡Šå™¨ / æ„å»ºé…ç½®ã€‚æ­¤åŠŸèƒ½ä¸»è¦ç”¨äºæ„å»º PyO3 æœ¬èº«ã€‚é»˜è®¤æƒ…å†µä¸‹æ­¤åŠŸèƒ½æœªå¯ç”¨ï¼Œè¿™æ„å‘³ç€ä½ å¯ä»¥è‡ªç”±åœ°å°† <code>pyo3-build-config</code> ä½œä¸ºç‹¬ç«‹åº“ä½¿ç”¨ï¼Œä»¥è¯»å–æˆ–å†™å…¥ PyO3 æ„å»ºé…ç½®æ–‡ä»¶ï¼Œæˆ–è§£æ Python è§£é‡Šå™¨çš„å…ƒæ•°æ®ã€‚</p>
<h2 id="å¯é€‰ä¾èµ–"><a class="header" href="#å¯é€‰ä¾èµ–">å¯é€‰ä¾èµ–</a></h2>
<p>è¿™äº›åŠŸèƒ½å¯ç”¨ Python ç±»å‹ä¸å…¶ä»– Rust crate ç±»å‹ä¹‹é—´çš„è½¬æ¢ï¼Œä¾¿äºæ— ç¼æ¥å…¥ Rust ç”Ÿæ€ç³»ç»Ÿã€‚</p>
<h3 id="anyhow"><a class="header" href="#anyhow"><code>anyhow</code></a></h3>
<p>æ·»åŠ å¯¹ <a href="https://docs.rs/anyhow">anyhow</a> çš„ä¾èµ–ã€‚å¯ç”¨ä» <a href="https://docs.rs/anyhow">anyhow</a> çš„ <a href="https://docs.rs/anyhow/latest/anyhow/struct.Error.html"><code>Error</code></a> ç±»å‹åˆ° <a href="{{#PYO3_DOCS_URL}}/pyo3/struct.PyErr.html"><code>PyErr</code></a> çš„è½¬æ¢ï¼Œä»¥ç®€åŒ–é”™è¯¯å¤„ç†ã€‚</p>
<h3 id="arc_lock"><a class="header" href="#arc_lock"><code>arc_lock</code></a></h3>
<p>ä¸ºæ‰€æœ‰æ‰©å±• <a href="https://docs.rs/lock_api/latest/lock_api/struct.Mutex.html"><code>lock_api::Mutex</code></a> æˆ– <a href="https://docs.rs/lock_api/latest/lock_api/struct.ReentrantMutex.html"><code>parking_lot::ReentrantMutex</code></a> å¹¶è¢«åŒ…è£¹åœ¨ <a href="https://doc.rust-lang.org/std/sync/struct.Arc.html"><code>Arc</code></a> ä¸­çš„äº’æ–¥é”å¯ç”¨ PyO3 çš„ <code>MutexExt</code> traitã€‚ç±»ä¼¼äº <a href="https://docs.rs/parking_lot/latest/parking_lot/type.Mutex.html#method.lock_arc"><code>Arc&lt;parking_lot::Mutex&gt;</code></a>ã€‚</p>
<h3 id="bigdecimal"><a class="header" href="#bigdecimal"><code>bigdecimal</code></a></h3>
<p>æ·»åŠ å¯¹ <a href="https://docs.rs/bigdecimal">bigdecimal</a> çš„ä¾èµ–ï¼Œå¹¶å¯ç”¨è½¬æ¢è‡³å…¶ <a href="https://docs.rs/bigdecimal/latest/bigdecimal/struct.BigDecimal.html"><code>BigDecimal</code></a> ç±»å‹ã€‚</p>
<h3 id="bytes"><a class="header" href="#bytes"><code>bytes</code></a></h3>
<p>æ·»åŠ å¯¹ <a href="https://docs.rs/bytes/latest/bytes">bytes</a> çš„ä¾èµ–ï¼Œå¹¶å¯ç”¨è½¬æ¢è‡³å…¶ <a href="https://docs.rs/bytes/latest/bytes/struct.Bytes.html"><code>Bytes</code></a> ç±»å‹ã€‚</p>
<h3 id="chrono"><a class="header" href="#chrono"><code>chrono</code></a></h3>
<p>æ·»åŠ å¯¹ <a href="https://docs.rs/chrono">chrono</a> çš„ä¾èµ–ã€‚å¯ç”¨ä» <a href="https://docs.rs/chrono">chrono</a> ç±»å‹åˆ° Python çš„è½¬æ¢ï¼š</p>
<ul>
<li><a href="https://docs.rs/chrono/latest/chrono/struct.TimeDelta.html">TimeDelta</a> -&gt; <a href="{{#PYO3_DOCS_URL}}/pyo3/types/struct.PyDelta.html"><code>PyDelta</code></a></li>
<li><a href="https://docs.rs/chrono/latest/chrono/offset/struct.FixedOffset.html">FixedOffset</a> -&gt; <a href="{{#PYO3_DOCS_URL}}/pyo3/types/struct.PyDelta.html"><code>PyDelta</code></a></li>
<li><a href="https://docs.rs/chrono/latest/chrono/offset/struct.Utc.html">Utc</a> -&gt; <a href="{{#PYO3_DOCS_URL}}/pyo3/types/struct.PyTzInfo.html"><code>PyTzInfo</code></a></li>
<li><a href="https://docs.rs/chrono/latest/chrono/naive/struct.NaiveDate.html">NaiveDate</a> -&gt; <a href="{{#PYO3_DOCS_URL}}/pyo3/types/struct.PyDate.html"><code>PyDate</code></a></li>
<li><a href="https://docs.rs/chrono/latest/chrono/naive/struct.NaiveTime.html">NaiveTime</a> -&gt; <a href="{{#PYO3_DOCS_URL}}/pyo3/types/struct.PyTime.html"><code>PyTime</code></a></li>
<li><a href="https://docs.rs/chrono/latest/chrono/struct.DateTime.html">DateTime</a> -&gt; <a href="{{#PYO3_DOCS_URL}}/pyo3/types/struct.PyDateTime.html"><code>PyDateTime</code></a></li>
</ul>
<h3 id="chrono-local"><a class="header" href="#chrono-local"><code>chrono-local</code></a></h3>
<p>å¯ç”¨ä¸ <a href="https://docs.rs/chrono/latest/chrono/struct.Local.html">Local</a> æ—¶åŒºçš„ç›¸äº’è½¬æ¢ã€‚è½¬æ¢æ—¶å°†ä½¿ç”¨ <a href="https://docs.rs/iana-time-zone/latest/iana_time_zone/fn.get_timezone.html"><code>iana_time_zone::get_timezone()</code></a> ç¡®å®šçš„ç³»ç»Ÿå½“å‰æ—¶åŒºã€‚</p>
<p><code>chrono::DateTime&lt;Local&gt;</code> å¯ä»ä»¥ä¸‹ä»»ä¸€ç§æƒ…å†µè½¬æ¢è€Œæ¥ï¼š</p>
<ul>
<li>å…·æœ‰ <code>tzinfo</code> ç­‰åŒäºå½“å‰ç³»ç»Ÿæ—¶åŒºçš„ <code>datetime</code> å¯¹è±¡ã€‚</li>
<li>â€œæœ´ç´ â€çš„ <code>datetime</code> å¯¹è±¡ï¼ˆæ—  <code>tzinfo</code>ï¼‰ï¼Œå› ä¸ºæƒ¯ä¾‹ä¸Šæœ´ç´  datetime å¯¹è±¡åº”è¢«è§†ä¸ºä½¿ç”¨ç³»ç»Ÿæ—¶åŒºã€‚</li>
</ul>
<p>è½¬æ¢ä¸º Python æ—¶ï¼Œ<code>Local</code> æ—¶åŒºä¿¡æ¯å°†è½¬æ¢ä¸ºä¸å½“å‰ç³»ç»Ÿæ—¶åŒºåŒ¹é…çš„ <code>zoneinfo.ZoneInfo</code>ã€‚</p>
<h3 id="chrono-tz"><a class="header" href="#chrono-tz"><code>chrono-tz</code></a></h3>
<p>æ·»åŠ å¯¹ <a href="https://docs.rs/chrono-tz">chrono-tz</a> çš„ä¾èµ–ã€‚
å¯ç”¨ä¸ <a href="https://docs.rs/chrono-tz/latest/chrono_tz/enum.Tz.html"><code>Tz</code></a> çš„ç›¸äº’è½¬æ¢ã€‚</p>
<h3 id="either"><a class="header" href="#either"><code>either</code></a></h3>
<p>æ·»åŠ å¯¹ <a href="https://docs.rs/either">either</a> çš„ä¾èµ–ã€‚å¯ç”¨è½¬æ¢è‡³ <a href="https://docs.rs/either">either</a> çš„ <a href="https://docs.rs/either/latest/either/enum.Either.html"><code>Either</code></a> ç±»å‹ã€‚</p>
<h3 id="eyre"><a class="header" href="#eyre"><code>eyre</code></a></h3>
<p>æ·»åŠ å¯¹ <a href="https://docs.rs/eyre">eyre</a> çš„ä¾èµ–ã€‚å¯ç”¨ä» <a href="https://docs.rs/eyre">eyre</a> çš„ <a href="https://docs.rs/eyre/latest/eyre/struct.Report.html"><code>Report</code></a> ç±»å‹åˆ° <a href="{{#PYO3_DOCS_URL}}/pyo3/struct.PyErr.html"><code>PyErr</code></a> çš„è½¬æ¢ï¼Œä»¥ç®€åŒ–é”™è¯¯å¤„ç†ã€‚</p>
<h3 id="hashbrown"><a class="header" href="#hashbrown"><code>hashbrown</code></a></h3>
<p>æ·»åŠ å¯¹ <a href="https://docs.rs/hashbrown">hashbrown</a> çš„ä¾èµ–ï¼Œå¹¶å¯ç”¨è½¬æ¢è‡³å…¶ <a href="https://docs.rs/hashbrown/latest/hashbrown/struct.HashMap.html"><code>HashMap</code></a> å’Œ <a href="https://docs.rs/hashbrown/latest/hashbrown/struct.HashSet.html"><code>HashSet</code></a> ç±»å‹ã€‚</p>
<h3 id="indexmapæ·»åŠ å¯¹-indexmap-çš„ä¾èµ–å¹¶å¯ç”¨è½¬æ¢ä¸ºå®ƒçš„-indexmap-ç±»å‹çš„åŠŸèƒ½"><a class="header" href="#indexmapæ·»åŠ å¯¹-indexmap-çš„ä¾èµ–å¹¶å¯ç”¨è½¬æ¢ä¸ºå®ƒçš„-indexmap-ç±»å‹çš„åŠŸèƒ½"><code>indexmap</code>æ·»åŠ å¯¹ <a href="https://docs.rs/indexmap">indexmap</a> çš„ä¾èµ–ï¼Œå¹¶å¯ç”¨è½¬æ¢ä¸ºå®ƒçš„ <a href="https://docs.rs/indexmap/latest/indexmap/map/struct.IndexMap.html"><code>IndexMap</code></a> ç±»å‹çš„åŠŸèƒ½ã€‚</a></h3>
<h3 id="jiff-02"><a class="header" href="#jiff-02"><code>jiff-02</code></a></h3>
<p>æ·»åŠ å¯¹ <a href="https://docs.rs/jiff/0.2">jiff@0.2</a> çš„ä¾èµ–ï¼Œå¹¶è¦æ±‚ MSRV ä¸º 1.70ã€‚å¯ç”¨ä» <a href="https://docs.rs/jiff">jiff</a> ç±»å‹åˆ° Python çš„è½¬æ¢ï¼š</p>
<ul>
<li><a href="https://docs.rs/jiff/0.2/jiff/struct.SignedDuration.html">SignedDuration</a> -&gt; <a href="{{#PYO3_DOCS_URL}}/pyo3/types/struct.PyDelta.html"><code>PyDelta</code></a></li>
<li><a href="https://docs.rs/jiff/0.2/jiff/tz/struct.TimeZone.html">TimeZone</a> -&gt; <a href="{{#PYO3_DOCS_URL}}/pyo3/types/struct.PyTzInfo.html"><code>PyTzInfo</code></a></li>
<li><a href="https://docs.rs/jiff/0.2/jiff/tz/struct.Offset.html">Offset</a> -&gt; <a href="{{#PYO3_DOCS_URL}}/pyo3/types/struct.PyTzInfo.html"><code>PyTzInfo</code></a></li>
<li><a href="https://docs.rs/jiff/0.2/jiff/civil/struct.Date.html">Date</a> -&gt; <a href="{{#PYO3_DOCS_URL}}/pyo3/types/struct.PyDate.html"><code>PyDate</code></a></li>
<li><a href="https://docs.rs/jiff/0.2/jiff/civil/struct.Time.html">Time</a> -&gt; <a href="{{#PYO3_DOCS_URL}}/pyo3/types/struct.PyTime.html"><code>PyTime</code></a></li>
<li><a href="https://docs.rs/jiff/0.2/jiff/civil/struct.DateTime.html">DateTime</a> -&gt; <a href="{{#PYO3_DOCS_URL}}/pyo3/types/struct.PyDateTime.html"><code>PyDateTime</code></a></li>
<li><a href="https://docs.rs/jiff/0.2/jiff/struct.Zoned.html">Zoned</a> -&gt; <a href="{{#PYO3_DOCS_URL}}/pyo3/types/struct.PyDateTime.html"><code>PyDateTime</code></a></li>
<li><a href="https://docs.rs/jiff/0.2/jiff/struct.Timestamp.html">Timestamp</a> -&gt; <a href="{{#PYO3_DOCS_URL}}/pyo3/types/struct.PyDateTime.html"><code>PyDateTime</code></a></li>
<li><a href="https://docs.rs/jiff/0.2/jiff/civil/struct.ISOWeekDate.html">ISOWeekDate</a> -&gt; <a href="{{#PYO3_DOCS_URL}}/pyo3/types/struct.PyDate.html"><code>PyDate</code></a></li>
</ul>
<h3 id="lock_api"><a class="header" href="#lock_api"><code>lock_api</code></a></h3>
<p>æ·»åŠ å¯¹ <a href="https://docs.rs/lock_api">lock_api</a> çš„ä¾èµ–ï¼Œå¹¶ä¸ºæ‰€æœ‰æ‰©å±•è‡ª <a href="https://docs.rs/lock_api/latest/lock_api/struct.Mutex.html"><code>lock_api::Mutex</code></a> å’Œ <a href="https://docs.rs/lock_api/latest/lock_api/struct.ReentrantMutex.html"><code>parking_lot::ReentrantMutex</code></a> çš„äº’æ–¥é”ï¼ˆå¦‚ <code>parking_lot</code> æˆ– <code>spin</code>ï¼‰å¯ç”¨ Pyo3 çš„ <code>MutexExt</code> traitã€‚</p>
<h3 id="num-bigint"><a class="header" href="#num-bigint"><code>num-bigint</code></a></h3>
<p>æ·»åŠ å¯¹ <a href="https://docs.rs/num-bigint">num-bigint</a> çš„ä¾èµ–ï¼Œå¹¶å¯ç”¨è½¬æ¢ä¸ºå®ƒçš„ <a href="https://docs.rs/num-bigint/latest/num_bigint/struct.BigInt.html"><code>BigInt</code></a> å’Œ <a href="https://docs.rs/num-bigint/latest/num_bigint/struct.BigUint.html"><code>BigUint</code></a> ç±»å‹çš„åŠŸèƒ½ã€‚</p>
<h3 id="num-complex"><a class="header" href="#num-complex"><code>num-complex</code></a></h3>
<p>æ·»åŠ å¯¹ <a href="https://docs.rs/num-complex">num-complex</a> çš„ä¾èµ–ï¼Œå¹¶å¯ç”¨è½¬æ¢ä¸ºå®ƒçš„ <a href="https://docs.rs/num-complex/latest/num_complex/struct.Complex.html"><code>Complex</code></a> ç±»å‹çš„åŠŸèƒ½ã€‚</p>
<h3 id="num-rational"><a class="header" href="#num-rational"><code>num-rational</code></a></h3>
<p>æ·»åŠ å¯¹ <a href="https://docs.rs/num-rational">num-rational</a> çš„ä¾èµ–ï¼Œå¹¶å¯ç”¨è½¬æ¢ä¸ºå®ƒçš„ <a href="https://docs.rs/num-rational/latest/num_rational/struct.Ratio.html"><code>Ratio</code></a> ç±»å‹çš„åŠŸèƒ½ã€‚</p>
<h3 id="ordered-float"><a class="header" href="#ordered-float"><code>ordered-float</code></a></h3>
<p>æ·»åŠ å¯¹ <a href="https://docs.rs/ordered-float">ordered-float</a> çš„ä¾èµ–ï¼Œå¹¶å¯ç”¨ <a href="https://docs.rs/ordered-float">ordered-float</a> ç±»å‹ä¸ Python ä¹‹é—´çš„è½¬æ¢ï¼š</p>
<ul>
<li><a href="https://docs.rs/ordered-float/latest/ordered_float/struct.NotNan.html">NotNan</a> -&gt; <a href="{{#PYO3_DOCS_URL}}/pyo3/types/struct.PyFloat.html"><code>PyFloat</code></a></li>
<li><a href="https://docs.rs/ordered-float/latest/ordered_float/struct.OrderedFloat.html">OrderedFloat</a> -&gt; <a href="{{#PYO3_DOCS_URL}}/pyo3/types/struct.PyFloat.html"><code>PyFloat</code></a></li>
</ul>
<h3 id="parking-lot"><a class="header" href="#parking-lot"><code>parking-lot</code></a></h3>
<p>æ·»åŠ å¯¹ <a href="https://docs.rs/parking_lot">parking_lot</a> çš„ä¾èµ–ï¼Œå¹¶ä¸º <a href="https://docs.rs/parking_lot/latest/parking_lot/struct.Once.html"><code>parking_lot::Once</code></a>ã€<a href="https://docs.rs/parking_lot/latest/parking_lot/type.Mutex.html"><code>parking_lot::Mutex</code></a> å’Œ <a href="https://docs.rs/parking_lot/latest/parking_lot/type.ReentrantMutex.html"><code>parking_lot::ReentrantMutex</code></a> ç±»å‹å¯ç”¨ Pyo3 çš„ <code>OnceExt</code> ä¸ <code>MutexExt</code> traitã€‚</p>
<h3 id="rust_decimal"><a class="header" href="#rust_decimal"><code>rust_decimal</code></a></h3>
<p>æ·»åŠ å¯¹ <a href="https://docs.rs/rust_decimal">rust_decimal</a> çš„ä¾èµ–ï¼Œå¹¶å¯ç”¨è½¬æ¢ä¸ºå®ƒçš„ <a href="https://docs.rs/rust_decimal/latest/rust_decimal/struct.Decimal.html"><code>Decimal</code></a> ç±»å‹çš„åŠŸèƒ½ã€‚</p>
<h3 id="time"><a class="header" href="#time"><code>time</code></a></h3>
<p>æ·»åŠ å¯¹ <a href="https://docs.rs/time">time</a> çš„ä¾èµ–ï¼Œå¹¶è¦æ±‚ MSRV ä¸º 1.67.1ã€‚å¯ç”¨ <a href="https://docs.rs/time">time</a> ç±»å‹ä¸ Python ä¹‹é—´çš„è½¬æ¢ï¼š</p>
<ul>
<li><a href="https://docs.rs/time/0.3.38/time/struct.Date.html">Date</a> -&gt; <a href="{{#PYO3_DOCS_URL}}/pyo3/types/struct.PyDate.html"><code>PyDate</code></a></li>
<li><a href="https://docs.rs/time/0.3.38/time/struct.Time.html">Time</a> -&gt; <a href="{{#PYO3_DOCS_URL}}/pyo3/types/struct.PyTime.html"><code>PyTime</code></a></li>
<li><a href="https://docs.rs/time/0.3.38/time/struct.OffsetDateTime.html">OffsetDateTime</a> -&gt; <a href="{{#PYO3_DOCS_URL}}/pyo3/types/struct.PyDateTime.html"><code>PyDateTime</code></a></li>
<li><a href="https://docs.rs/time/0.3.38/time/struct.PrimitiveDateTime.html">PrimitiveDateTime</a> -&gt; <a href="{{#PYO3_DOCS_URL}}/pyo3/types/struct.PyDateTime.html"><code>PyDateTime</code></a></li>
<li><a href="https://docs.rs/time/0.3.38/time/struct.Duration.html">Duration</a> -&gt; <a href="{{#PYO3_DOCS_URL}}/pyo3/types/struct.PyDelta.html"><code>PyDelta</code></a></li>
<li><a href="https://docs.rs/time/0.3.38/time/struct.UtcOffset.html">UtcOffset</a> -&gt; <a href="{{#PYO3_DOCS_URL}}/pyo3/types/struct.PyTzInfo.html"><code>PyTzInfo</code></a></li>
<li><a href="https://docs.rs/time/0.3.38/time/struct.UtcDateTime.html">UtcDateTime</a> -&gt; <a href="{{#PYO3_DOCS_URL}}/pyo3/types/struct.PyDateTime.html"><code>PyDateTime</code></a></li>
</ul>
<h3 id="serde"><a class="header" href="#serde"><code>serde</code></a></h3>
<p>é€šè¿‡ <a href="https://serde.rs/">serde</a> å¯ç”¨ <code>Py&lt;T&gt;</code> å¯¹è±¡çš„åºåˆ—åŒ–ä¸ååºåˆ—åŒ–åŠŸèƒ½ã€‚è¿™å…è®¸åœ¨åŒ…å«å¯¹ <code>#[pyclass]</code> å®ä¾‹å¼•ç”¨çš„ç»“æ„ä½“ä¸Šä½¿ç”¨ <a href="https://serde.rs/derive.html"><code>#[derive(Serialize, Deserialize)</code></a>ï¼š</p>
<pre><code class="language-rust no_run"><span class="boring">#[cfg(feature = "serde")]
</span><span class="boring">#[allow(dead_code)]
</span><span class="boring">mod serde_only {
</span><span class="boring">use pyo3::prelude::*;
</span><span class="boring">use serde::{Deserialize, Serialize};
</span>

#[pyclass]
#[derive(Serialize, Deserialize)]
struct Permission {
    name: String,
}


#[pyclass]
#[derive(Serialize, Deserialize)]
struct User {
    username: String,
    permissions: Vec&lt;Py&lt;Permission&gt;&gt;,
}
<span class="boring">}</span></code></pre>
<h3 id="smallvec"><a class="header" href="#smallvec"><code>smallvec</code></a></h3>
<p>æ·»åŠ å¯¹ <a href="https://docs.rs/smallvec">smallvec</a> çš„ä¾èµ–ï¼Œå¹¶å¯ç”¨è½¬æ¢ä¸ºå®ƒçš„ <a href="https://docs.rs/smallvec/latest/smallvec/struct.SmallVec.html"><code>SmallVec</code></a> ç±»å‹çš„åŠŸèƒ½ã€‚</p>
<h3 id="uuid"><a class="header" href="#uuid"><code>uuid</code></a></h3>
<p>æ·»åŠ å¯¹ <a href="https://docs.rs/uuid">uuid</a> çš„ä¾èµ–ï¼Œå¹¶å¯ç”¨è½¬æ¢ä¸ºå®ƒçš„ <a href="https://docs.rs/uuid/latest/uuid/struct.Uuid.html"><code>Uuid</code></a> ç±»å‹çš„åŠŸèƒ½ã€‚</p>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="æ€§èƒ½"><a class="header" href="#æ€§èƒ½">æ€§èƒ½</a></h1>
<p>ä¸ºäº†è·å¾—æœ€ä½³æ€§èƒ½ï¼Œäº†è§£ PyO3 API çš„ä¸€äº›æŠ€å·§å’Œéœ€è¦æ³¨æ„çš„é™·é˜±æ˜¯éå¸¸æœ‰ç”¨çš„ã€‚</p>
<h2 id="extract-ä¸-cast"><a class="header" href="#extract-ä¸-cast"><code>extract</code> ä¸ <code>cast</code></a></h2>
<p>ä½¿ç”¨ PyO3 å®ç°çš„ Python é£æ ¼ API é€šå¸¸æ˜¯å¤šæ€çš„ï¼Œå³å®ƒä»¬æ¥å— <code>&amp;Bound&lt;'_, PyAny&gt;</code> å¹¶å°è¯•å°†å…¶è½¬æ¢ä¸ºå¤šä¸ªæ›´å…·ä½“çš„ç±»å‹ï¼Œç„¶ååœ¨è¿™äº›ç±»å‹ä¸Šæ‰§è¡Œè¯·æ±‚çš„æ“ä½œã€‚è¿™é€šå¸¸ä¼šå¯¼è‡´ä¸€è¿ä¸²çš„ <code>extract</code> è°ƒç”¨ï¼Œä¾‹å¦‚ï¼š</p>
<pre><code class="language-rust no_run"><span class="boring">#![allow(dead_code)]
</span><span class="boring">use pyo3::prelude::*;
</span><span class="boring">use pyo3::{exceptions::PyTypeError, types::PyList};
</span>

fn frobnicate_list&lt;'py&gt;(list: &amp;Bound&lt;'_, PyList&gt;) -&gt; PyResult&lt;Bound&lt;'py, PyAny&gt;&gt; {
    todo!()
}


fn frobnicate_vec&lt;'py&gt;(vec: Vec&lt;Bound&lt;'py, PyAny&gt;&gt;) -&gt; PyResult&lt;Bound&lt;'py, PyAny&gt;&gt; {
    todo!()
}


#[pyfunction]
fn frobnicate&lt;'py&gt;(value: &amp;Bound&lt;'py, PyAny&gt;) -&gt; PyResult&lt;Bound&lt;'py, PyAny&gt;&gt; {
    if let Ok(list) = value.extract::&lt;Bound&lt;'_, PyList&gt;&gt;() {
        frobnicate_list(&amp;list)
    } else if let Ok(vec) = value.extract::&lt;Vec&lt;Bound&lt;'_, PyAny&gt;&gt;&gt;() {
        frobnicate_vec(vec)
    } else {
        Err(PyTypeError::new_err("Cannot frobnicate that type."))
    }
}</code></pre>
<p>è¿™ç§å†™æ³•ä¸å¤ªç†æƒ³ï¼Œå› ä¸º <code>FromPyObject&lt;T&gt;</code> trait è¦æ±‚ <code>extract</code> è¿”å› <code>Result&lt;T, PyErr&gt;</code> ç±»å‹ã€‚å¯¹äº <code>PyList</code> è¿™æ ·çš„åŸç”Ÿç±»å‹ï¼Œå¦‚æœå¿½ç•¥é”™è¯¯å€¼ï¼Œåˆ™ä½¿ç”¨ <code>cast</code>ï¼ˆ<code>extract</code> å†…éƒ¨ä¼šè°ƒç”¨å®ƒï¼‰ä¼šæ›´å¿«ã€‚è¿™æ ·å¯ä»¥é¿å…å°† <code>PyDowncastError</code> è½¬æ¢ä¸º <code>PyErr</code> çš„é«˜æˆæœ¬æ“ä½œï¼Œè€Œè¿™æ˜¯æ»¡è¶³ <code>FromPyObject</code> åˆçº¦æ‰€å¿…éœ€çš„ï¼Œä¾‹å¦‚ï¼š</p>
<pre><code class="language-rust no_run"><span class="boring">#![allow(dead_code)]
</span><span class="boring">use pyo3::prelude::*;
</span><span class="boring">use pyo3::{exceptions::PyTypeError, types::PyList};
</span><span class="boring">fn frobnicate_list&lt;'py&gt;(list: &amp;Bound&lt;'_, PyList&gt;) -&gt; PyResult&lt;Bound&lt;'py, PyAny&gt;&gt; { todo!() }
</span><span class="boring">fn frobnicate_vec&lt;'py&gt;(vec: Vec&lt;Bound&lt;'py, PyAny&gt;&gt;) -&gt; PyResult&lt;Bound&lt;'py, PyAny&gt;&gt; { todo!() }
</span><span class="boring">
</span>#[pyfunction]
fn frobnicate&lt;'py&gt;(value: &amp;Bound&lt;'py, PyAny&gt;) -&gt; PyResult&lt;Bound&lt;'py, PyAny&gt;&gt; {
    // ä½¿ç”¨ `cast` è€Œä¸æ˜¯ `extract`ï¼Œå› ä¸ºå°† `PyDowncastError` è½¬æ¢ä¸º `PyErr` æˆæœ¬è¾ƒé«˜ã€‚
    if let Ok(list) = value.cast::&lt;PyList&gt;() {
        frobnicate_list(list)
    } else if let Ok(vec) = value.extract::&lt;Vec&lt;Bound&lt;'_, PyAny&gt;&gt;&gt;() {
        frobnicate_vec(vec)
    } else {
        Err(PyTypeError::new_err("Cannot frobnicate that type."))
    }
}</code></pre>
<h2 id="å¯¹-bound-çš„è®¿é—®æ„å‘³ç€å¯¹-python-token-çš„è®¿é—®"><a class="header" href="#å¯¹-bound-çš„è®¿é—®æ„å‘³ç€å¯¹-python-token-çš„è®¿é—®">å¯¹ Bound çš„è®¿é—®æ„å‘³ç€å¯¹ Python token çš„è®¿é—®</a></h2>
<p>å½“æˆ‘ä»¬å·²ç»é™„åŠ åˆ°è§£é‡Šå™¨æ—¶ï¼Œè°ƒç”¨ <code>Python::attach</code> å®é™…ä¸Šæ˜¯æ— æ“ä½œçš„ï¼Œä½†æ£€æŸ¥è¿™ä¸€ç‚¹ä»ç„¶æœ‰å¼€é”€ã€‚å¦‚æœæ— æ³•è®¿é—®ç°æœ‰çš„ Python tokenï¼ˆä¾‹å¦‚åœ¨å®ç°å·²æœ‰ trait æ—¶ï¼‰ï¼Œä½†å¯ä»¥è®¿é—® Python ç»‘å®šçš„å¼•ç”¨ï¼Œåˆ™å¯ä»¥é€šè¿‡ <code>Bound::py</code> åˆ©ç”¨å¯¹ç»‘å®šå¼•ç”¨çš„è®¿é—®æ¥é›¶æˆæœ¬è·å– Python tokenï¼Œä»è€Œé¿å…è¯¥å¼€é”€ã€‚</p>
<p>ä¾‹å¦‚ï¼Œä¸è¦è¿™æ ·å†™ï¼š</p>
<pre><code class="language-rust no_run"><span class="boring">#![allow(dead_code)]
</span><span class="boring">use pyo3::prelude::*;
</span><span class="boring">use pyo3::types::PyList;
</span>

struct Foo(Py&lt;PyList&gt;);


struct FooBound&lt;'py&gt;(Bound&lt;'py, PyList&gt;);


impl PartialEq&lt;Foo&gt; for FooBound&lt;'_&gt; {
    fn eq(&amp;self, other: &amp;Foo) -&gt; bool {
        Python::attach(|py| {
            let len = other.0.bind(py).len();
            self.0.len() == len
        })
    }
}</code></pre>
<p>è€Œåº”ä½¿ç”¨æ›´é«˜æ•ˆçš„å†™æ³•ï¼š</p>
<pre><code class="language-rust no_run"><span class="boring">#![allow(dead_code)]
</span><span class="boring">use pyo3::prelude::*;
</span><span class="boring">use pyo3::types::PyList;
</span><span class="boring">struct Foo(Py&lt;PyList&gt;);
</span><span class="boring">struct FooBound&lt;'py&gt;(Bound&lt;'py, PyList&gt;);
</span><span class="boring">
</span>impl PartialEq&lt;Foo&gt; for FooBound&lt;'_&gt; {
    fn eq(&amp;self, other: &amp;Foo) -&gt; bool {
        // å¯¹ `&amp;Bound&lt;'py, PyAny&gt;` çš„è®¿é—®æ„å‘³ç€å¯ä»¥é›¶æˆæœ¬è®¿é—® `Python&lt;'py&gt;`ã€‚
        let py = self.0.py();
        let len = other.0.bind(py).len();
        self.0.len() == len
    }
}</code></pre>
<h2 id="è°ƒç”¨-python-å¯è°ƒç”¨å¯¹è±¡__call__"><a class="header" href="#è°ƒç”¨-python-å¯è°ƒç”¨å¯¹è±¡__call__">è°ƒç”¨ Python å¯è°ƒç”¨å¯¹è±¡ï¼ˆ<code>__call__</code>ï¼‰</a></h2>
<p>CPython æ”¯æŒå¤šç§è°ƒç”¨åè®®ï¼š<a href="https://docs.python.org/3/c-api/call.html#the-tp-call-protocol"><code>tp_call</code></a> å’Œ <a href="https://docs.python.org/3/c-api/call.html#the-vectorcall-protocol"><code>vectorcall</code></a>ã€‚<a href="https://docs.python.org/3/c-api/call.html#the-vectorcall-protocol"><code>vectorcall</code></a> æ˜¯ä¸€ç§æ›´é«˜æ•ˆçš„åè®®ï¼Œèƒ½å¤Ÿå®ç°æ›´å¿«çš„è°ƒç”¨ã€‚
PyO3 ä¼šå°½é‡ä½¿ç”¨ <a href="https://docs.python.org/3/c-api/call.html#the-vectorcall-protocol"><code>vectorcall</code></a> è°ƒç”¨çº¦å®šæ¥åˆ†æ´¾ Python çš„ <code>call</code>ï¼Œä»¥å®ç°æœ€å¤§æ€§èƒ½ï¼Œå¦åˆ™å›é€€åˆ° <a href="https://docs.python.org/3/c-api/call.html#the-tp-call-protocol"><code>tp_call</code></a>ã€‚
è¿™æ˜¯é€šè¿‡ï¼ˆå†…éƒ¨ï¼‰<code>PyCallArgs</code> trait å®ç°çš„ã€‚å®ƒå®šä¹‰äº† Rust ç±»å‹å¦‚ä½•ä½œä¸º Python <code>call</code> çš„å‚æ•°ä½¿ç”¨ã€‚ç›®å‰è¯¥ trait å·²ä¸ºä»¥ä¸‹ç±»å‹å®ç°ï¼š</p>
<ul>
<li>Rust å…ƒç»„ï¼Œå…¶ä¸­æ¯ä¸ªæˆå‘˜å®ç°äº† <code>IntoPyObject</code></li>
<li><code>Bound&lt;'_, PyTuple&gt;</code></li>
<li><code>Py&lt;PyTuple&gt;</code></li>
</ul>
<p>Rust å…ƒç»„å¯ä»¥åˆ©ç”¨ <a href="https://docs.python.org/3/c-api/call.html#the-vectorcall-protocol"><code>vectorcall</code></a>ï¼Œè€Œ <code>Bound&lt;'_, PyTuple&gt;</code> å’Œ <code>Py&lt;PyTuple&gt;</code> åªèƒ½ä½¿ç”¨ <a href="https://docs.python.org/3/c-api/call.html#the-tp-call-protocol"><code>tp_call</code></a>ã€‚ä¸ºäº†è·å¾—æœ€é«˜æ€§èƒ½ï¼Œå»ºè®®ä¼˜å…ˆä½¿ç”¨ Rust å…ƒç»„ä½œä¸ºå‚æ•°ã€‚</p>
<h2 id="é•¿æ—¶é—´çº¯-rust-å·¥ä½œæ—¶ä»è§£é‡Šå™¨åˆ†ç¦»"><a class="header" href="#é•¿æ—¶é—´çº¯-rust-å·¥ä½œæ—¶ä»è§£é‡Šå™¨åˆ†ç¦»">é•¿æ—¶é—´çº¯ Rust å·¥ä½œæ—¶ä»è§£é‡Šå™¨åˆ†ç¦»</a></h2>
<p>å½“æ‰§è¡Œä¸éœ€è¦ä¸ Python è§£é‡Šå™¨äº¤äº’çš„ Rust ä»£ç æ—¶ï¼Œåº”ä½¿ç”¨ <a href="{{#PYO3_DOCS_URL}}/pyo3/marker/struct.Python.html#method.detach"><code>Python::detach</code></a>ï¼Œä»¥å…è®¸ Python è§£é‡Šå™¨ç»§ç»­è¿è¡Œï¼Œè€Œä¸å¿…ç­‰å¾…å½“å‰çº¿ç¨‹ã€‚</p>
<p>åœ¨å¯ç”¨ GIL çš„æ„å»ºä¸­ï¼Œè¿™ä¸€ç‚¹å¯¹æœ€ä½³æ€§èƒ½è‡³å…³é‡è¦ï¼Œå› ä¸ºåŒä¸€æ—¶é—´åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹å¤„äºé™„åŠ çŠ¶æ€ã€‚</p>
<p>åœ¨è‡ªç”±çº¿ç¨‹æ„å»ºä¸­ï¼Œè¿™ä»ç„¶æ˜¯æœ€ä½³å®è·µï¼Œå› ä¸ºå­˜åœ¨ä¸€äº›â€œåœæ­¢ä¸–ç•Œâ€äº‹ä»¶ï¼ˆå¦‚åƒåœ¾å›æ”¶ï¼‰ï¼Œæ‰€æœ‰é™„åŠ åˆ° Python è§£é‡Šå™¨çš„çº¿ç¨‹éƒ½å¿…é¡»ç­‰å¾…ã€‚</p>
<p>ä½œä¸ºç»éªŒæ³•åˆ™ï¼Œé™„åŠ å’Œåˆ†ç¦» Python è§£é‡Šå™¨æ‰€éœ€æ—¶é—´å°äº 1 æ¯«ç§’ï¼Œå› æ­¤ä»»ä½•é¢„æœŸè€—æ—¶è¶…è¿‡å‡ æ¯«ç§’çš„å·¥ä½œéƒ½å¯ä»¥ä»åˆ†ç¦»è§£é‡Šå™¨ä¸­å—ç›Šã€‚</p>
<h2 id="ç¦ç”¨å…¨å±€å¼•ç”¨æ± "><a class="header" href="#ç¦ç”¨å…¨å±€å¼•ç”¨æ± ">ç¦ç”¨å…¨å±€å¼•ç”¨æ± </a></h2>
<p>PyO3 ä½¿ç”¨å…¨å±€å¯å˜çŠ¶æ€æ¥è·Ÿè¸ª <code>impl&lt;T&gt; Drop for Py&lt;T&gt;</code> åœ¨æœªé™„åŠ åˆ°è§£é‡Šå™¨æ—¶è¢«è°ƒç”¨æ‰€å¯¼è‡´çš„å»¶è¿Ÿå¼•ç”¨è®¡æ•°æ›´æ–°ã€‚å½“åŸºäº PyO3 çš„ä»£ç ä¸‹æ¬¡é™„åŠ åˆ°è§£é‡Šå™¨æ—¶ï¼Œè·å–å¹¶åº”ç”¨è¿™äº›å¼•ç”¨è®¡æ•°æ›´æ–°æ‰€éœ€çš„åŒæ­¥æ“ä½œç›¸å¯¹æ˜‚è´µï¼Œå¯èƒ½ä¼šæˆä¸ºè·¨è¶Š Python-Rust è¾¹ç•Œæˆæœ¬çš„é‡è¦éƒ¨åˆ†ã€‚</p>
<p>å¯ä»¥é€šè¿‡è®¾ç½® <code>pyo3_disable_reference_pool</code> æ¡ä»¶ç¼–è¯‘æ ‡å¿—æ¥é¿å…æ­¤åŠŸèƒ½ã€‚è¿™å°†å®Œå…¨ç§»é™¤å…¨å±€å¼•ç”¨æ± åŠå…¶ç›¸å…³å¼€é”€ã€‚ç„¶è€Œï¼Œå®ƒ <em>ä¸ä¼š</em> ç§»é™¤ <code>Py&lt;T&gt;</code> çš„ <code>Drop</code> å®ç°ï¼Œå› ä¸ºè¯¥å®ç°å¯¹äºä¸ä¸è€ƒè™‘ PyO3 çš„ç°æœ‰ Rust ä»£ç äº’æ“ä½œæ˜¯å¿…è¦çš„ã€‚ä¸ºåœ¨è¿™äº›æƒ…å†µä¸‹ä¿æŒä¸æ›´å¹¿æ³› Rust ç”Ÿæ€ç³»ç»Ÿçš„å…¼å®¹æ€§ï¼Œæˆ‘ä»¬ä¿ç•™äº†è¯¥å®ç°ï¼Œä½†åœ¨æœªé™„åŠ åˆ°è§£é‡Šå™¨æ—¶è°ƒç”¨ <code>Drop</code> ä¼šä¸­æ­¢ç¨‹åºã€‚å¦‚æœåŒæ—¶è¿˜å¯ç”¨äº† <code>pyo3_leak_on_drop_without_reference_pool</code>ï¼Œåˆ™åœ¨æœªé™„åŠ åˆ° Python æ—¶è¢«ä¸¢å¼ƒçš„å¯¹è±¡å°†è¢«æ³„æ¼â€”â€”è¿™å§‹ç»ˆæ˜¯å†…å­˜å®‰å…¨çš„ï¼Œä½†é•¿æœŸæ¥çœ‹å¯èƒ½å¯¼è‡´èµ„æºè€—å°½ç­‰ä¸è‰¯åæœã€‚</p>
<p>åœ¨ä½¿ç”¨æ­¤è®¾ç½®æ—¶ï¼Œå¿…é¡»ç‰¢è®°è¿™ä¸€é™åˆ¶ï¼Œå°¤å…¶æ˜¯å°† Python ä»£ç åµŒå…¥ Rust åº”ç”¨ç¨‹åºæ—¶ï¼Œå¾ˆå®¹æ˜“æ„å¤–åœ°ä¸¢å¼ƒ <code>Python::attach</code> è¿”å›çš„ <code>Py&lt;T&gt;</code>ï¼ˆæˆ–åŒ…å«å®ƒçš„ç±»å‹ï¼Œå¦‚ <code>PyErr</code>ã€<code>PyBackedStr</code> æˆ– <code>PyBackedBytes</code>ï¼‰ï¼Œè€Œæ²¡æœ‰äº‹å…ˆé‡æ–°é™„åŠ ã€‚ä¾‹å¦‚ï¼Œä»¥ä¸‹ä»£ç ï¼š</p>
<pre><code class="language-rust ignore"><span class="boring">use pyo3::prelude::*;
</span><span class="boring">use pyo3::types::PyList;
</span>let numbers: Py&lt;PyList&gt; = Python::attach(|py| PyList::empty(py).unbind());


Python::attach(|py| {
    numbers.bind(py).append(23).unwrap();
});


Python::attach(|py| {
    numbers.bind(py).append(42).unwrap();
});</code></pre>
<p>å¦‚æœåˆ—è¡¨æ²¡æœ‰é€šè¿‡ä»¥ä¸‹æ–¹å¼æ˜¾å¼é‡Šæ”¾ï¼š</p>
<pre><code class="language-rust"><span class="boring">use pyo3::prelude::*;
</span><span class="boring">use pyo3::types::PyList;
</span>let numbers: Py&lt;PyList&gt; = Python::attach(|py| PyList::empty(py).unbind());


Python::attach(|py| {
    numbers.bind(py).append(23).unwrap();
});


Python::attach(|py| {
    numbers.bind(py).append(42).unwrap();
});


Python::attach(move |py| {
    drop(numbers);
});</code></pre>
<p>ç¨‹åºå°†ä¼šä¸­æ­¢ã€‚</p>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="ç±»å‹å­˜æ ¹ç”Ÿæˆpyi-æ–‡ä»¶å’Œå†…çœåŠŸèƒ½"><a class="header" href="#ç±»å‹å­˜æ ¹ç”Ÿæˆpyi-æ–‡ä»¶å’Œå†…çœåŠŸèƒ½">ç±»å‹å­˜æ ¹ç”Ÿæˆï¼ˆ<code>*.pyi</code> æ–‡ä»¶ï¼‰å’Œå†…çœåŠŸèƒ½</a></h1>
<p><em>æ­¤åŠŸèƒ½ä»åœ¨ç§¯æå¼€å‘ä¸­ã€‚å‚è§ <a href="https://github.com/PyO3/pyo3/issues/5137">ç›¸å…³ issue</a>ã€‚</em></p>
<p><em>æœ‰å…³ç±»å‹å­˜æ ¹åŠå…¶åœ¨ç¨³å®šç‰ˆ PyO3 ä¸­ä½¿ç”¨çš„æ–‡æ¡£ï¼Œè¯·å‚è§ <a href="#ä¸ºæ‚¨çš„-python-åŒ…æä¾›ç±»å‹æç¤ºå’Œ-ide-æç¤º">æ­¤é¡µé¢</a>ã€‚</em></p>
<p>PyO3 æ­£åœ¨è¿›è¡Œæ”¯æŒç”Ÿæˆ <a href="https://typing.python.org/en/latest/spec/distributing.html#stub-files">ç±»å‹å­˜æ ¹æ–‡ä»¶</a> çš„å·¥ä½œã€‚</p>
<p>å…¶å·¥ä½œåŸç†å¦‚ä¸‹ï¼š</p>
<ol>
<li>PyO3 å®ï¼ˆ<code>#[pyclass]</code>ï¼‰ç”Ÿæˆå¸¸é‡ JSON å­—ç¬¦ä¸²ï¼Œå¦‚æœå¯ç”¨äº† <code>experimental-inspect</code> åŠŸèƒ½ï¼Œè¿™äº›å­—ç¬¦ä¸²å°†ç”± rustc åŒ…å«åœ¨æ„å»ºçš„äºŒè¿›åˆ¶æ–‡ä»¶ä¸­ã€‚</li>
<li><code>pyo3-introspection</code> crate å¯è§£æç”Ÿæˆçš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œæå– JSON å­—ç¬¦ä¸²ï¼Œå¹¶ä»ä¸­æ„å»ºå­˜æ ¹æ–‡ä»¶ã€‚</li>
<li>ï¼»å°šæœªå®Œæˆï¼½åƒ <code>maturin</code> è¿™æ ·çš„æ„å»ºå·¥å…·åœ¨å…¶ CLI API ä¸­æš´éœ² <code>pyo3-introspection</code> çš„åŠŸèƒ½ã€‚</li>
</ol>
<p>ä¾‹å¦‚ï¼Œä¸‹é¢çš„ Rust ä»£ç </p>
<pre><code class="language-rust">#[pymodule]
pub mod example {
    use pyo3::prelude::*;


    #[pymodule_export]
    pub const CONSTANT: &amp;str = "FOO";


    #[pyclass(eq)]
    #[derive(Eq)]
    struct Class {
        value: usize
    }


    #[pymethods]
    impl Class {
        #[new]
        fn new(value: usize) -&gt; Self {
            Self { value }
        }


        #[getter]
        fn value(&amp;self) -&gt; usize {
            self.value
        }
    }


    #[pyfunction]
    #[pyo3(signature = (arg: "list[int]") -&gt; "list[int]")]
    fn list_of_int_identity(arg: Bound&lt;'_, PyAny&gt;) -&gt; Bound&lt;'_, PyAny&gt; {
        arg
    }
}</code></pre>
<p>å°†ç”Ÿæˆä»¥ä¸‹å­˜æ ¹æ–‡ä»¶ï¼š</p>
<pre><code class="language-python">import typing


CONSTANT: typing.Final = "FOO"


class Class:
    def __init__(self, value: int) -&gt; None: ...


    @property
    def value(self) -&gt; int: ...


    def __eq__(self, other: Class) -&gt; bool: ...
    def __ne__(self, other: Class) -&gt; bool: ...


def list_of_int_identity(arg: list[int]) -&gt; list[int]: ...
</code></pre>
<p>å”¯ä¸€æ–°å¢çš„è¯­æ³•æ˜¯ï¼Œ<code>#[pyo3(signature = ...)]</code> å±æ€§ç°åœ¨å¯ä»¥åŒ…å«ç±»å‹æ³¨è§£ï¼Œå¦‚ <code>#[pyo3(signature = (arg: "list[int]") -&gt; "list[int]")]</code>ï¼ˆæ³¨æ„ç±»å‹æ³¨è§£å‘¨å›´çš„ <code>""</code>ï¼‰ã€‚å½“ PyO3 æ— æ³•è‡ªè¡Œæ¨å¯¼å‡ºæ­£ç¡®çš„ç±»å‹æ³¨è§£æ—¶ï¼Œè¿™ä¼šéå¸¸æœ‰ç”¨ã€‚</p>
<h2 id="é™åˆ¶ä¸ä¸è¶³"><a class="header" href="#é™åˆ¶ä¸ä¸è¶³">é™åˆ¶ä¸ä¸è¶³</a></h2>
<ul>
<li>éœ€è¦å¯ç”¨ <code>experimental-inspect</code> åŠŸèƒ½ä»¥ç”Ÿæˆå†…çœç‰‡æ®µã€‚</li>
<li>è®¸å¤šåŠŸèƒ½å°šå¾…å®ç°ã€‚æœ‰å…³åˆ—è¡¨ï¼Œè¯·å‚è§ <a href="https://github.com/PyO3/pyo3/issues/5137">ç›¸å…³ issue</a>ã€‚</li>
<li>å†…çœä»…æ”¯æŒä½¿ç”¨å†…è” Rust æ¨¡å—å£°æ˜çš„ Python æ¨¡å—ã€‚ä¸æ”¯æŒé€šè¿‡å‡½æ•°å£°æ˜çš„æ¨¡å—ã€‚</li>
<li>å¿…é¡»ä¸º <code>FromPyObject::INPUT_TYPE</code> å’Œ <code>IntoPyObject::OUTPUT_TYPE</code> å®ç°ï¼Œä»¥ä¾¿ PyO3 è·å–æ­£ç¡®çš„è¾“å…¥/è¾“å‡ºç±»å‹æ³¨è§£ã€‚</li>
<li>ç”±äº <code>FromPyObject::INPUT_TYPE</code> å’Œ <code>IntoPyObject::OUTPUT_TYPE</code> æ˜¯ <code>const</code>ï¼Œç›®å‰è¿˜æ— æ³•ä¸ºå®¹å™¨æ„å»ºæ™ºèƒ½æ³›å‹æ³¨è§£ï¼Œä¾‹å¦‚ <code>concat!("list[", T::OUTPUT_TYPE, "]")</code>ã€‚å‚è§ <a href="https://github.com/rust-lang/rust/issues/76560">æ­¤è·Ÿè¸ª issue</a>ã€‚</li>
<li>PyO3 æ— æ³•å†…çœ <code>#[pymodule]</code> å’Œ <code>#[pymodule_init]</code> å‡½æ•°çš„å†…å®¹ã€‚å¦‚æœå­˜åœ¨è¿™äº›å‡½æ•°ï¼Œæ¨¡å—å°†è¢«æ ‡è®°ä¸ºä¸å®Œæ•´ï¼Œå¹¶æ·»åŠ ä¸€ä¸ªä¼ªé€ çš„ <code>def __getattr__(name: str) -&gt; Incomplete: ...</code> å‡½æ•°ï¼Œéµå¾ª<a href="https://typing.python.org/en/latest/guides/writing_stubs.html#incomplete-stubs">æœ€ä½³å®è·µ</a>ã€‚</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="é«˜çº§ä¸»é¢˜"><a class="header" href="#é«˜çº§ä¸»é¢˜">é«˜çº§ä¸»é¢˜</a></h1>
<h2 id="ffi"><a class="header" href="#ffi">FFI</a></h2>
<p>PyO3 é€šè¿‡ <code>ffi</code> æ¨¡å—æš´éœ²äº†å¤§é‡ Python çš„ C APIã€‚</p>
<p>C API å¤©ç”Ÿæ˜¯ä¸å®‰å…¨çš„ï¼Œéœ€è¦ä½ è‡ªå·±ç®¡ç†å¼•ç”¨è®¡æ•°ã€é”™è¯¯ä»¥åŠç‰¹å®šçš„ä¸å˜é‡ã€‚åœ¨ä½¿ç”¨è¯¥ API çš„ä»»ä½•å‡½æ•°ä¹‹å‰ï¼Œè¯·åŠ¡å¿…å‚è€ƒ <a href="https://docs.python.org/3/c-api/">C API å‚è€ƒæ‰‹å†Œ</a> å’Œ <a href="https://doc.rust-lang.org/nightly/nomicon/ffi.html">The Rustonomicon</a>ã€‚</p>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="æ„å»ºä¸åˆ†å‘"><a class="header" href="#æ„å»ºä¸åˆ†å‘">æ„å»ºä¸åˆ†å‘</a></h1>
<p>æœ¬ç« å°†è¯¦ç»†ä»‹ç»å¦‚ä½•ä½¿ç”¨ PyO3 æ„å»ºå’Œåˆ†å‘é¡¹ç›®ã€‚å…·ä½“å®ç°æ–¹å¼å–å†³äºé¡¹ç›®çš„ç±»å‹ï¼šæ˜¯ä»¥ Rust å®ç°çš„ Python æ¨¡å—ï¼Œè¿˜æ˜¯åµŒå…¥ Python çš„ Rust å¯æ‰§è¡Œç¨‹åºã€‚å¯¹äºè¿™ä¸¤ç±»é¡¹ç›®ï¼Œéƒ½å­˜åœ¨ä¸€äº›å…±æ€§é—®é¢˜ï¼Œä¾‹å¦‚ç›®æ ‡ Python ç‰ˆæœ¬çš„é€‰æ‹©å’Œåº”ä½¿ç”¨çš„<a href="https://zh.wikipedia.org/wiki/é“¾æ¥å™¨_(è®¡ç®—)">é“¾æ¥å™¨</a>å‚æ•°ã€‚</p>
<p>æœ¬ç« å†…å®¹é¢å‘å·²ç»é˜…è¯»è¿‡ PyO3 <a href="#pyo3-ç”¨æˆ·æŒ‡å—">README</a> çš„ç”¨æˆ·ï¼Œä¾æ¬¡ä»‹ç»é’ˆå¯¹ Python æ¨¡å—å’Œ Rust å¯æ‰§è¡Œç¨‹åºå¯åšçš„å„ç§é€‰æ‹©ï¼Œæœ€åè¿˜æœ‰ä¸€èŠ‚å…³äºä½¿ç”¨ PyO3 è¿›è¡Œäº¤å‰ç¼–è¯‘çš„å†…å®¹ã€‚</p>
<p>å¦æœ‰ä¸€ä¸ªä¸“é—¨çš„å­ç« èŠ‚ä»‹ç»<a href="#æ”¯æŒå¤šä¸ª-python-ç‰ˆæœ¬">æ”¯æŒå¤šä¸ª Python ç‰ˆæœ¬</a>çš„æ–¹æ³•ã€‚</p>
<h2 id="é…ç½®-python-ç‰ˆæœ¬"><a class="header" href="#é…ç½®-python-ç‰ˆæœ¬">é…ç½® Python ç‰ˆæœ¬</a></h2>
<p>PyO3 ä½¿ç”¨ä¸€ä¸ªæ„å»ºè„šæœ¬ï¼ˆç”± <a href="https://github.com/PyO3/pyo3/tree/main/pyo3-build-config"><code>pyo3-build-config</code></a> crate æ”¯æŒï¼‰æ¥ç¡®å®š Python ç‰ˆæœ¬å¹¶è®¾ç½®æ­£ç¡®çš„é“¾æ¥å™¨å‚æ•°ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œå®ƒä¼šæŒ‰ä»¥ä¸‹é¡ºåºå°è¯•ï¼š</p>
<ul>
<li>å½“å‰æ¿€æ´»çš„ Python è™šæ‹Ÿç¯å¢ƒã€‚</li>
<li><code>python</code> å¯æ‰§è¡Œæ–‡ä»¶ï¼ˆå¦‚æœå®ƒæ˜¯ Python 3 è§£é‡Šå™¨ï¼‰ã€‚</li>
<li><code>python3</code> å¯æ‰§è¡Œæ–‡ä»¶ã€‚</li>
</ul>
<p>ä½ å¯ä»¥é€šè¿‡è®¾ç½® <code>PYO3_PYTHON</code> ç¯å¢ƒå˜é‡æ¥è¦†ç›– Python è§£é‡Šå™¨ï¼Œä¾‹å¦‚ï¼š<code>PYO3_PYTHON=python3.7</code>ã€<code>PYO3_PYTHON=/usr/bin/python3.9</code>ï¼Œç”šè‡³æ˜¯ PyPy è§£é‡Šå™¨ <code>PYO3_PYTHON=pypy3</code>ã€‚</p>
<p>ä¸€æ—¦å®šä½åˆ° Python è§£é‡Šå™¨ï¼Œ<code>pyo3-build-config</code> å°±ä¼šè¿è¡Œè¯¥è§£é‡Šå™¨ï¼ŒæŸ¥è¯¢ <code>sysconfig</code> æ¨¡å—ä¸­çš„ä¿¡æ¯ï¼Œä»¥é…ç½®å…¶ä½™çš„ç¼–è¯‘è¿‡ç¨‹ã€‚</p>
<p>è¦éªŒè¯ PyO3 å°†ä½¿ç”¨çš„é…ç½®ï¼Œå¯ä»¥è®¾ç½®ç¯å¢ƒå˜é‡ <code>PYO3_PRINT_CONFIG=1</code> åè¿è¡Œç¼–è¯‘ã€‚ä»¥ä¸‹æ˜¯ä¸€ä¸ªç¤ºä¾‹è¾“å‡ºï¼š</p>
<pre><code class="language-console">$ PYO3_PRINT_CONFIG=1 cargo build
   Compiling pyo3 v0.14.1 (/home/david/dev/pyo3)
error: failed to run custom build command for `pyo3 v0.14.1 (/home/david/dev/pyo3)`

Caused by:
  process didn't exit successfully: `/home/david/dev/pyo3/target/debug/build/pyo3-7a8cf4fe22e959b7/build-script-build` (exit status: 101)
  --- stdout
  cargo:rerun-if-env-changed=PYO3_CROSS
  cargo:rerun-if-env-changed=PYO3_CROSS_LIB_DIR
  cargo:rerun-if-env-changed=PYO3_CROSS_PYTHON_VERSION
  cargo:rerun-if-env-changed=PYO3_PRINT_CONFIG

  -- PYO3_PRINT_CONFIG=1 is set, printing configuration and halting compile --
  implementation=CPython
  version=3.8
  shared=true
  abi3=false
  lib_name=python3.8
  lib_dir=/usr/lib
  executable=/usr/bin/python
  pointer_width=64
  build_flags=
  suppress_build_script_link_lines=false
</code></pre>
<p><code>PYO3_ENVIRONMENT_SIGNATURE</code> ç¯å¢ƒå˜é‡å¯åœ¨å…¶å€¼æ›´æ”¹æ—¶è§¦å‘é‡æ–°æ„å»ºï¼Œé™¤æ­¤ä¹‹å¤–æ²¡æœ‰å…¶ä»–ä½œç”¨ã€‚</p>
<h3 id="è¿›é˜¶é…ç½®æ–‡ä»¶"><a class="header" href="#è¿›é˜¶é…ç½®æ–‡ä»¶">è¿›é˜¶ï¼šé…ç½®æ–‡ä»¶</a></h3>
<p>å¦‚æœå°†ä¸Šè¿° <code>PYO3_PRINT_CONFIG</code> è¾“å‡ºçš„é…ç½®ä¿å­˜ä¸ºæ–‡ä»¶ï¼Œå°±å¯ä»¥æ‰‹åŠ¨ä¿®æ”¹å†…å®¹ï¼Œå¹¶é€šè¿‡ <code>PYO3_CONFIG_FILE</code> ç¯å¢ƒå˜é‡é‡æ–°å¯¼å…¥ PyO3ã€‚</p>
<p>å¦‚æœä½ çš„æ„å»ºç¯å¢ƒè¶³å¤Ÿç‰¹æ®Šï¼Œå¯¼è‡´ PyO3 é»˜è®¤çš„é…ç½®æ£€æµ‹æœºåˆ¶å¤±æ•ˆï¼Œä½¿ç”¨é…ç½®æ–‡ä»¶å¯ä»¥æä¾›è¶³å¤Ÿçš„çµæ´»æ€§ä»¥ä½¿ PyO3 æ­£å¸¸å·¥ä½œã€‚æœ‰å…³æ”¯æŒçš„å®Œæ•´é€‰é¡¹ï¼Œè¯·å‚é˜… <a href="https://docs.rs/pyo3-build-config/{{#PYO3_DOCS_VERSION}}/pyo3_build_config/struct.InterpreterConfig.html"><code>InterpreterConfig</code> ç»“æ„ä½“</a> çš„æ–‡æ¡£ã€‚</p>
<h2 id="æ„å»º-python-æ‰©å±•æ¨¡å—"><a class="header" href="#æ„å»º-python-æ‰©å±•æ¨¡å—">æ„å»º Python æ‰©å±•æ¨¡å—</a></h2>
<p>Python æ‰©å±•æ¨¡å—çš„ç¼–è¯‘æ–¹å¼å–å†³äºå…¶ç›®æ ‡æ“ä½œç³»ç»Ÿï¼ˆå’Œæ¶æ„ï¼‰ã€‚é™¤äº†å¤šç§æ“ä½œç³»ç»Ÿï¼ˆå’Œæ¶æ„ï¼‰ä¹‹å¤–ï¼Œè¿˜æœ‰è®¸å¤šæ´»è·ƒæ”¯æŒçš„ä¸åŒ Python ç‰ˆæœ¬ã€‚ä¸Šä¼ è‡³ <a href="https://pypi.org/">PyPI</a> çš„åŒ…é€šå¸¸å¸Œæœ›ä¸Šä¼ è¦†ç›–å¤šç§ OS/arch/version ç»„åˆçš„é¢„ç¼–è¯‘â€œwheelâ€åŒ…ï¼Œä»¥ä¾¿æ‰€æœ‰å¹³å°ä¸Šçš„ç”¨æˆ·éƒ½ä¸éœ€è¦è‡ªè¡Œç¼–è¯‘ã€‚åŒ…æä¾›è€…å¯ä»¥é€‰æ‹©å¯ç”¨â€œabi3â€å—é™ Python APIï¼Œè¿™ä½¿å¾—ä»–ä»¬çš„ wheel åŒ…å¯ä»¥åœ¨å¤šä¸ª Python ç‰ˆæœ¬ä¸Šä½¿ç”¨ï¼Œä»è€Œå‡å°‘éœ€è¦ç¼–è¯‘çš„ wheel æ•°é‡ï¼Œä½†ä¼šé™åˆ¶å¯ç”¨çš„åŠŸèƒ½ã€‚</p>
<p>æœ‰å¤šç§æ–¹æ³•å¯ä»¥å®ç°è¿™ä¸€ç‚¹ï¼šå¯ä»¥ä½¿ç”¨ <code>cargo</code> æ¥æ„å»ºæ‰©å±•æ¨¡å—ï¼ˆå¹¶è¾…ä»¥ä¸€äº›æ‰‹åŠ¨æ“ä½œï¼Œæ“ä½œæ–¹å¼éšæ“ä½œç³»ç»Ÿä¸åŒè€Œå¼‚ï¼‰ã€‚PyO3 ç”Ÿæ€ç³»ç»Ÿæä¾›äº†ä¸¤ç§æ‰“åŒ…å·¥å…· <a href="https://github.com/PyO3/maturin"><code>maturin</code></a> å’Œ <a href="https://github.com/PyO3/setuptools-rust"><code>setuptools-rust</code></a>ï¼Œå®ƒä»¬å¯ä»¥å±è”½æ“ä½œç³»ç»Ÿå·®å¼‚ï¼Œå¹¶æ”¯æŒæ„å»ºç”¨äº PyPI ä¸Šä¼ çš„ wheel åŒ…ã€‚</p>
<p>PyO3 æä¾›äº†ä¸€äº› Cargo ç‰¹æ€§ï¼ˆfeatureï¼‰æ¥é…ç½®æ„å»º Python æ‰©å±•æ¨¡å—çš„é¡¹ç›®ï¼š</p>
<ul>
<li><code>extension-module</code> ç‰¹æ€§ï¼Œæ„å»º Python æ‰©å±•æ¨¡å—æ—¶å¿…é¡»å¯ç”¨ã€‚</li>
<li><code>abi3</code> ç‰¹æ€§åŠå…¶ç‰ˆæœ¬ç‰¹å®šçš„ <code>abi3-pyXY</code> å˜ä½“ï¼Œç”¨äºå¯ç”¨å—é™ Python APIï¼Œä»¥ä¾¿åœ¨å•ä¸ª wheel ä¸­æ”¯æŒå¤šä¸ª Python ç‰ˆæœ¬ã€‚</li>
</ul>
<p>æœ¬èŠ‚å°†å…ˆåˆ†åˆ«ä»‹ç»è¿™ä¸¤ç§æ‰“åŒ…å·¥å…·ï¼Œç„¶åæè¿°ä¸ä½¿ç”¨è¿™äº›å·¥å…·æ—¶çš„æ‰‹åŠ¨æ„å»ºæ–¹æ³•ã€‚æ¥ç€è§£é‡Š <code>extension-module</code> ç‰¹æ€§ï¼Œæœ€åä»‹ç» PyO3 çš„ <code>abi3</code> ç‰¹æ€§ã€‚</p>
<h3 id="æ‰“åŒ…å·¥å…·"><a class="header" href="#æ‰“åŒ…å·¥å…·">æ‰“åŒ…å·¥å…·</a></h3>
<p>PyO3 ç”Ÿæ€ç³»ç»Ÿä¸»è¦æœ‰ä¸¤ä¸ªå·¥å…·å¯ç”¨æ¥æŠ½è±¡ Python æ‰©å±•æ¨¡å—çš„å¼€å‘æµç¨‹ï¼š</p>
<ul>
<li><a href="https://github.com/PyO3/maturin"><code>maturin</code></a> æ˜¯ä¸€ä¸ªå‘½ä»¤è¡Œå·¥å…·ï¼Œç”¨äºæ„å»ºã€æ‰“åŒ…å’Œä¸Šä¼  Python æ¨¡å—ã€‚å®ƒå¯¹é¡¹ç›®ç»“æ„æœ‰æ˜ç¡®çš„çº¦å®šï¼Œå› æ­¤å‡ ä¹æ— éœ€é¢å¤–é…ç½®ã€‚å¯¹äºä»é›¶å¼€å§‹æ„å»º Python æ‰©å±•ä¸”ä¸éœ€è¦çµæ´»æ€§çš„ç”¨æˆ·æ¥è¯´ï¼Œè¿™æ˜¯ä¸€ä¸ªç†æƒ³çš„é€‰æ‹©ã€‚</li>
<li><a href="https://github.com/PyO3/setuptools-rust"><code>setuptools-rust</code></a> æ˜¯ <code>setuptools</code> çš„æ’ä»¶ï¼Œä¸º <code>setup.py</code> é…ç½®æ–‡ä»¶æ·»åŠ äº†é¢å¤–çš„å…³é”®å­—å‚æ•°ã€‚ç›¸æ¯” <code>maturin</code> éœ€è¦æ›´å¤šé…ç½®ï¼Œä½†è¿™ä¸ºé‚£äº›éœ€å°† Rust æ·»åŠ åˆ°ç°æœ‰ Python åŒ…ï¼ˆä¸èƒ½æ»¡è¶³ <code>maturin</code> çº¦æŸï¼‰çš„ç”¨æˆ·æä¾›äº†æ›´å¤§çš„çµæ´»æ€§ã€‚</li>
</ul>
<p>è¯·æŸ¥é˜…å„é¡¹ç›®çš„æ–‡æ¡£ï¼Œäº†è§£å¦‚ä½•å¼€å§‹ä½¿ç”¨ä»¥åŠå¦‚ä½•ä¸Šä¼  wheel åˆ° PyPI çš„å®Œæ•´ç»†èŠ‚ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè™½ç„¶ <code>maturin</code> å¯ä»¥å¼€ç®±å³ç”¨åœ°æ„å»ºç¬¦åˆ <a href="https://github.com/pypa/manylinux">manylinux</a> æ ‡å‡†çš„ wheelï¼Œä½† <code>setuptools-rust</code> éœ€è¦æ›´å¤šå·¥ä½œï¼Œ<a href="https://setuptools-rust.readthedocs.io/en/latest/building_wheels.html">ä¾èµ– Docker</a> æ¥å®ç°è¿™ä¸€ç›®æ ‡ã€‚</p>
<p>PyO3 ä»“åº“ä¸­è¿˜æœ‰ <a href="https://github.com/PyO3/pyo3/tree/main/examples/maturin-starter"><code>maturin-starter</code></a> å’Œ <a href="https://github.com/PyO3/pyo3/tree/main/examples/setuptools-rust-starter"><code>setuptools-rust-starter</code></a> ç¤ºä¾‹ã€‚</p>
<h3 id="æ‰‹åŠ¨æ„å»º"><a class="header" href="#æ‰‹åŠ¨æ„å»º">æ‰‹åŠ¨æ„å»º</a></h3>
<p>è¦æ‰‹åŠ¨æ„å»ºåŸºäº PyO3 çš„ Python æ‰©å±•æ¨¡å—ï¼Œé¦–å…ˆåœ¨ä½¿ç”¨äº† PyO3 çš„ <code>extension-module</code> ç‰¹æ€§ä¸”å…·æœ‰ <a href="https://doc.rust-lang.org/cargo/reference/cargo-targets.html#the-crate-type-field"><code>cdylib</code> crate ç±»å‹</a>çš„åº“é¡¹ç›®ä¸­æ­£å¸¸è¿è¡Œ <code>cargo build</code>ã€‚</p>
<p>æ„å»ºå®Œæˆåï¼Œå°† Cargo <code>target/</code> ç›®å½•ä¸­çš„å…±äº«åº“åˆ›å»ºç¬¦å·é“¾æ¥ï¼ˆæˆ–å¤åˆ¶å¹¶é‡å‘½åï¼‰åˆ°ç›®æ ‡è¾“å‡ºç›®å½•ï¼š</p>
<ul>
<li>åœ¨ macOS ä¸Šï¼Œå°† <code>libyour_module.dylib</code> é‡å‘½åä¸º <code>your_module.so</code>ã€‚</li>
<li>åœ¨ Windows ä¸Šï¼Œå°† <code>libyour_module.dll</code> é‡å‘½åä¸º <code>your_module.pyd</code>ã€‚</li>
<li>åœ¨ Linux ä¸Šï¼Œå°† <code>libyour_module.so</code> é‡å‘½åä¸º <code>your_module.so</code>ã€‚</li>
</ul>
<p>ç„¶ååœ¨è¾“å‡ºç›®å½•ä¸­æ‰“å¼€ Python shellï¼Œå°±å¯ä»¥æ‰§è¡Œ <code>import your_module</code> äº†ã€‚</p>
<p>å¦‚æœè¦å°†åº“æ‰“åŒ…åˆ†å‘ï¼Œåº”åœ¨æ–‡ä»¶åä¸­åŒ…å«<a href="#platform-tags">å¹³å°æ ‡ç­¾</a>ä»¥æ ‡æ˜è¯¥åº“æ‰€ç¼–è¯‘çš„ç›®æ ‡ Python è§£é‡Šå™¨ã€‚è¿™å¯ä»¥é˜²æ­¢ä¸å…¼å®¹çš„è§£é‡Šå™¨å°è¯•å¯¼å…¥ä½ çš„åº“ã€‚å¦‚æœä½ æ­£åœ¨ä¸º PyPy ç¼–è¯‘ï¼Œåˆ™<em>å¿…é¡»</em>åŒ…å«å¹³å°æ ‡ç­¾ï¼Œå¦åˆ™ PyPy ä¼šå¿½ç•¥è¯¥æ¨¡å—ã€‚</p>
<h4 id="bazel-æ„å»º"><a class="header" href="#bazel-æ„å»º">Bazel æ„å»º</a></h4>
<p>è¦åœ¨ Bazel ä¸­ä½¿ç”¨ PyO3ï¼Œéœ€è¦æ‰‹åŠ¨é…ç½® PyO3ã€PyO3-ffi å’Œ PyO3-macrosï¼Œç‰¹åˆ«æ˜¯ç¡®ä¿ä½¿ç”¨æ­£ç¡®çš„ Python æ ‡å¿—æ¥ç¼–è¯‘ä½ æ‰“ç®—ä½¿ç”¨çš„ç‰ˆæœ¬ã€‚ä¾‹å¦‚å‚è€ƒï¼š</p>
<ol>
<li><a href="https://github.com/abrisco/rules_pyo3">github.com/abrisco/rules_pyo3</a> â€”â€” ç”¨äºæ„å»ºæ‰©å±•æ¨¡å—çš„é€šç”¨è§„åˆ™ã€‚</li>
<li><a href="https://github.com/OliverFM/pytorch_with_gazelle">github.com/OliverFM/pytorch_with_gazelle</a> â€”â€” ä¸€ä¸ªä½¿ç”¨ PyO3ã€PyTorch å’Œ Gazelle ç”Ÿæˆ Python æ„å»ºæ–‡ä»¶çš„æœ€å°ç¤ºä¾‹ä»“åº“ã€‚</li>
<li><a href="https://github.com/TheButlah/rules_pyo3">github.com/TheButlah/rules_pyo3</a> â€”â€” ç¨æ˜¾è¿‡æ—¶ã€‚</li>
</ol>
<h4 id="å¹³å°æ ‡ç­¾"><a class="header" href="#å¹³å°æ ‡ç­¾">å¹³å°æ ‡ç­¾</a></h4>
<p>é™¤äº†ä¸Šè¿°å»ºè®®çš„ <code>.so</code> æˆ– <code>.pyd</code> æ‰©å±•åå¤–ï¼ˆä¾æ“ä½œç³»ç»Ÿè€Œå®šï¼‰ï¼Œä½ è¿˜å¯ä»¥åœ¨å…±äº«åº“æ‰©å±•åå‰åŠ ä¸Šå¹³å°æ ‡ç­¾ï¼Œä»¥è¡¨æ˜å®ƒå…¼å®¹çš„è§£é‡Šå™¨ã€‚ä½ å¯ä»¥é€šè¿‡ <code>sysconfig</code> æ¨¡å—æŸ¥è¯¢è§£é‡Šå™¨çš„å¹³å°æ ‡ç­¾ã€‚ä»¥ä¸‹æ˜¯ä¸€äº›ç¤ºä¾‹è¾“å‡ºï¼š</p>
<pre><code class="language-bash"># Python 3.10 ä¸Šçš„ macOS
.cpython-310-darwin.so

# Linux ä¸Šçš„ PyPy 7.3 (å¯¹åº” Python 3.9)
$ python -c 'import sysconfig; print(sysconfig.get_config_var("EXT_SUFFIX"))'
.pypy39-pp73-x86_64-linux-gnu.so
</code></pre>
<p>å› æ­¤ï¼Œä¾‹å¦‚åœ¨ macOS ä¸Š CPython 3.10 çš„æœ‰æ•ˆæ¨¡å—åº“åç§°ä¸º <code>your_module.cpython-310-darwin.so</code>ï¼Œè€Œåœ¨ Linux ä¸Šä¸º PyPy 7.3 ç¼–è¯‘çš„ç­‰æ•ˆåç§°ä¸º <code>your_module.pypy39-pp73-x86_64-linux-gnu.so</code>ã€‚</p>
<p>æœ‰å…³å¹³å°æ ‡ç­¾çš„æ›´å¤šèƒŒæ™¯ä¿¡æ¯ï¼Œè¯·å‚é˜… <a href="https://peps.python.org/pep-3149/">PEP 3149</a>ã€‚</p>
<h4 id="macos"><a class="header" href="#macos">macOS</a></h4>
<p>åœ¨ macOS ä¸Šï¼Œç”±äº <code>extension-module</code> ç‰¹æ€§ç¦ç”¨äº†å¯¹ <code>libpython</code> çš„é“¾æ¥ï¼ˆ<a href="#the-extension-module-feature">è§ä¸‹ä¸€èŠ‚</a>ï¼‰ï¼Œéœ€è¦è®¾ç½®ä¸€äº›é¢å¤–çš„é“¾æ¥å™¨å‚æ•°ã€‚<code>maturin</code> å’Œ <code>setuptools-rust</code> éƒ½ä¼šè‡ªåŠ¨ä¸º PyO3 ä¼ é€’è¿™äº›å‚æ•°ï¼Œä½†æ‰‹åŠ¨æ„å»ºçš„é¡¹ç›®éœ€è¦ç›´æ¥è®¾ç½®è¿™äº›å‚æ•°æ‰èƒ½æ”¯æŒ macOSã€‚</p>
<p>è®¾ç½®æ­£ç¡®é“¾æ¥å™¨å‚æ•°æœ€ç®€å•çš„æ–¹æ³•æ˜¯åœ¨é¡¹ç›®ä¸­æ·»åŠ ä¸€ä¸ª <a href="https://doc.rust-lang.org/cargo/reference/build-scripts.html"><code>build.rs</code></a>ï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p>
<pre><code class="language-rust ignore">fn main() {
    pyo3_build_config::add_extension_module_link_args();
}</code></pre>
<p>è®°å¾—åŒæ—¶å°† <code>pyo3-build-config</code> æ·»åŠ åˆ° <code>Cargo.toml</code> çš„ <code>build-dependencies</code> éƒ¨åˆ†ã€‚</p>
<p>å¦ä¸€ç§ä¸ä½¿ç”¨ <code>pyo3-build-config</code> çš„æ–¹æ³•æ˜¯åœ¨ cargo é…ç½®æ–‡ä»¶ï¼ˆå¦‚ <code>.cargo/config.toml</code>ï¼‰ä¸­æ·»åŠ ä»¥ä¸‹å†…å®¹ï¼š</p>
<pre><code class="language-toml">[target.x86_64-apple-darwin]
rustflags = [
  "-C", "link-arg=-undefined",
  "-C", "link-arg=dynamic_lookup",
]

[target.aarch64-apple-darwin]
rustflags = [
  "-C", "link-arg=-undefined",
  "-C", "link-arg=dynamic_lookup",
]
```ä½¿ç”¨ MacOS ç³»ç»Ÿè‡ªå¸¦çš„ python3ï¼ˆ`/usr/bin/python3`ï¼Œè€Œéé€šè¿‡ homebrewã€pyenvã€nix ç­‰æ–¹å¼å®‰è£…çš„ Pythonï¼‰å¯èƒ½ä¼šå¯¼è‡´è¿è¡Œæ—¶é”™è¯¯ï¼Œä¾‹å¦‚ `Library not loaded: @rpath/Python3.framework/Versions/3.8/Python3`ã€‚

è®¾ç½®æ­£ç¡®é“¾æ¥å‚æ•°æœ€ç®€å•çš„æ–¹æ³•æ˜¯æ·»åŠ ä¸€ä¸ª `build.rs` æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ï¼š

```rust,ignore
fn main() {
    pyo3_build_config::add_python_framework_link_args();
}
</code></pre>
<p>æˆ–è€…ä¹Ÿå¯ä»¥åœ¨ <code>.cargo/config.toml</code> ä¸­æ·»åŠ å¦‚ä¸‹é…ç½®ï¼š</p>
<pre><code class="language-toml">[build]
rustflags = [
  "-C", "link-args=-Wl,-rpath,/Library/Developer/CommandLineTools/Library/Frameworks",
]
</code></pre>
<p>å…³äº MacOS é“¾æ¥é—®é¢˜çš„æ›´å¤šè®¨è®ºå’Œè§£å†³æ–¹æ¡ˆï¼Œ<a href="https://github.com/PyO3/pyo3/issues/1800#issuecomment-906786649">è¯·å‚è§æ­¤é—®é¢˜</a>ã€‚</p>
<p>æœ€åï¼Œè¯·æ³¨æ„åœ¨ MacOS ä¸Šä½¿ç”¨ <code>extension-module</code> ç‰¹æ€§æ—¶ï¼Œå¦‚æœä¸åŠ ä¸Š <code>--no-default-features</code> æ ‡å¿—ï¼Œ<code>cargo test</code> å°†ä¼šå¤±è´¥ï¼ˆè¯¦è§ <a href="https://pyo3.rs/main/faq.html#i-cant-run-cargo-test-or-i-cant-build-in-a-cargo-workspace-im-having-linker-issues-like-symbol-not-found-or-undefined-reference-to-_pyexc_systemerror">å¸¸è§é—®é¢˜è§£ç­”</a>ï¼‰ã€‚</p>
<h3 id="extension-module-ç‰¹æ€§"><a class="header" href="#extension-module-ç‰¹æ€§"><code>extension-module</code> ç‰¹æ€§</a></h3>
<p>PyO3 çš„ <code>extension-module</code> ç‰¹æ€§ç”¨äºåœ¨ Unix ç›®æ ‡å¹³å°ä¸Šç¦ç”¨å¯¹ <code>libpython</code> çš„<a href="https://en.wikipedia.org/wiki/Linker_(computing)">é“¾æ¥</a>ã€‚</p>
<p>è¿™æ˜¯å¿…è¦çš„ï¼Œå› ä¸ºé»˜è®¤æƒ…å†µä¸‹ PyO3 ä¼šé“¾æ¥åˆ° <code>libpython</code>ï¼Œè¿™ä½¿å¾—äºŒè¿›åˆ¶æ–‡ä»¶ã€æµ‹è¯•å’Œç¤ºä¾‹å¯ä»¥â€œå¼€ç®±å³ç”¨â€ã€‚ç„¶è€Œï¼Œä¸ºäº†ç¬¦åˆ <a href="https://www.python.org/dev/peps/pep-0513/">manylinux</a> æ ‡å‡†ï¼ŒUnix ä¸Šçš„ Python æ‰©å±•æ¨¡å—ä¸å¾—é“¾æ¥ <code>libpython</code>ã€‚</p>
<p>ä¸é“¾æ¥ <code>libpython</code> çš„ç¼ºç‚¹æ˜¯ï¼Œé‚£äº›é€šå¸¸éœ€è¦åµŒå…¥ Python çš„äºŒè¿›åˆ¶æ–‡ä»¶ã€æµ‹è¯•å’Œç¤ºä¾‹å°†æ— æ³•æ„å»ºã€‚å¦‚æœä½ åœ¨ä¸€ä¸ªé¡¹ç›®ä¸­åŒæ—¶åŒ…å«æ‰©å±•æ¨¡å—å’Œå…¶ä»–è¾“å‡ºï¼Œåˆ™éœ€è¦ä½¿ç”¨å¯é€‰çš„ Cargo ç‰¹æ€§ï¼Œåœ¨æ„å»ºéæ‰©å±•æ¨¡å—æ—¶ç¦ç”¨ <code>extension-module</code>ã€‚æœ‰å…³ç¤ºä¾‹è§£å†³æ–¹æ¡ˆï¼Œè¯·å‚è§ <a href="#i-cant-run-cargo-test-or-i-cant-build-in-a-cargo-workspace-im-having-linker-issues-like-symbol-not-found-or-undefined-reference-to-_pyexc_systemerror">å¸¸è§é—®é¢˜è§£ç­”</a>ã€‚</p>
<h3 id="py_limited_apiabi3"><a class="header" href="#py_limited_apiabi3"><code>Py_LIMITED_API</code>/<code>abi3</code></a></h3>
<p>é»˜è®¤æƒ…å†µä¸‹ï¼ŒPython æ‰©å±•æ¨¡å—åªèƒ½ç”¨äºä¸å…¶ç¼–è¯‘æ—¶æ‰€ä½¿ç”¨çš„ Python ç‰ˆæœ¬ç›¸åŒçš„ç¯å¢ƒä¸­ã€‚ä¾‹å¦‚ï¼Œä¸º Python 3.5 æ„å»ºçš„æ‰©å±•æ¨¡å—æ— æ³•åœ¨ Python 3.8 ä¸­å¯¼å…¥ã€‚<a href="https://www.python.org/dev/peps/pep-0384/">PEP 384</a> å¼•å…¥äº†â€œå—é™ Python APIâ€çš„æ¦‚å¿µï¼Œå®ƒæ‹¥æœ‰ç¨³å®šçš„ ABIï¼Œä½¿ç”¨è¯¥ API æ„å»ºçš„æ‰©å±•æ¨¡å—å¯ä»¥åœ¨å¤šä¸ª Python ç‰ˆæœ¬ä¸­ä½¿ç”¨ã€‚è¿™ä¹Ÿè¢«ç§°ä¸º <code>abi3</code>ã€‚</p>
<p>ä½¿ç”¨å—é™ Python API æ„å»ºæ‰©å±•æ¨¡å—çš„ä¼˜åŠ¿åœ¨äºï¼Œè½¯ä»¶åŒ…åˆ†å‘è€…åªéœ€ä¸ºæ¯ä¸ªæ“ä½œç³»ç»Ÿ/æ¶æ„æ„å»ºå¹¶åˆ†å‘ä¸€ä¸ªç‰ˆæœ¬ï¼Œç”¨æˆ·å°±å¯ä»¥åœ¨å…¶æ‰€æœ‰ç¬¦åˆæœ€ä½ç‰ˆæœ¬è¦æ±‚çš„ Python ç‰ˆæœ¬ä¸Šå®‰è£…ä½¿ç”¨ã€‚ç¼ºç‚¹æ˜¯ PyO3 æ— æ³•ä½¿ç”¨é‚£äº›ä¾èµ–äºå·²çŸ¥ç¡®åˆ‡ Python ç‰ˆæœ¬æ‰èƒ½å¯ç”¨çš„ä¼˜åŒ–ã€‚æ˜¯å¦å¯¹æ­¤æ•æ„Ÿå–å†³äºä½ çš„æ‰©å±•æ¨¡å—çš„å…·ä½“æƒ…å†µã€‚ä½ ä¹Ÿå¯ä»¥è®¾è®¡ä½ çš„æ‰©å±•æ¨¡å—ï¼Œä½¿å…¶æ—¢å¯åˆ†å‘ <code>abi3</code> è½®å­ï¼Œåˆå…è®¸ä»æºç ç¼–è¯‘çš„ç”¨æˆ·è·å¾—é¢å¤–çš„ä¼˜åŒ– â€”â€” è¯·å‚é˜…æœ¬æŒ‡å—ä¸­çš„ <a href="#æ”¯æŒå¤šä¸ª-python-ç‰ˆæœ¬">å¤š Python ç‰ˆæœ¬æ”¯æŒ</a> éƒ¨åˆ†ï¼Œç‰¹åˆ«æ˜¯ <code>#[cfg(Py_LIMITED_API)]</code> æ ‡å¿—ã€‚</p>
<p>åœ¨æ„å»º Python è½®å­åŒ…æ—¶ä½¿ç”¨ <code>abi3</code>ï¼Œéœ€è¦å®Œæˆä»¥ä¸‹ä¸‰ä¸ªæ­¥éª¤ï¼š</p>
<ol>
<li>
<p>åœ¨ <code>pyo3</code> ä¸­å¯ç”¨ <code>abi3</code> ç‰¹æ€§ã€‚è¿™ç¡®ä¿ <code>pyo3</code> åªè°ƒç”¨å±äºç¨³å®š API çš„ Python C-API å‡½æ•°ï¼Œå¹¶ä¸”åœ¨ Windows ä¸Šä¹Ÿç¡®ä¿é¡¹ç›®é“¾æ¥åˆ°æ­£ç¡®çš„å…±äº«å¯¹è±¡ï¼ˆå…¶ä»–å¹³å°æ— éœ€ç‰¹æ®Šè¡Œä¸ºï¼‰ï¼š</p>
<pre><code class="language-toml">[dependencies]
pyo3 = { {{#PYO3_CRATE_VERSION}}, features = ["abi3"] }
</code></pre>
</li>
<li>
<p>ç¡®ä¿æ„å»ºå‡ºçš„å…±äº«å¯¹è±¡è¢«æ­£ç¡®æ ‡è®°ä¸º <code>abi3</code>ã€‚è¿™é€šè¿‡å‘ŠçŸ¥æ„å»ºç³»ç»Ÿä½ æ­£åœ¨ä½¿ç”¨å—é™ API æ¥å®ç°ã€‚<a href="https://github.com/PyO3/maturin"><code>maturin</code></a> &gt;= 0.9.0 å’Œ <a href="https://github.com/PyO3/setuptools-rust"><code>setuptools-rust</code></a> &gt;= 0.11.4 å‡æ”¯æŒ <code>abi3</code> è½®å­ã€‚</p>
<p>æ›´å¤šä¿¡æ¯è¯·å‚è§ <a href="https://github.com/PyO3/maturin/pull/353">ç›¸å…³ PR</a> å’Œ <a href="https://github.com/PyO3/setuptools-rust/pull/82">å¦ä¸€ä¸ª PR</a>ã€‚</p>
</li>
<li>
<p>ç¡®ä¿ <code>.whl</code> æ–‡ä»¶è¢«æ­£ç¡®æ ‡è®°ä¸º <code>abi3</code>ã€‚å¯¹äºä½¿ç”¨ <code>setuptools</code> çš„é¡¹ç›®ï¼Œå¯é€šè¿‡å‘ <code>setup.py bdist_wheel</code> ä¼ é€’ <code>--py-limited-api=cp3x</code> å‚æ•°å®ç°ï¼ˆå…¶ä¸­ <code>x</code> æ˜¯è½®å­æ‰€æ”¯æŒçš„æœ€ä½ Python ç‰ˆæœ¬ï¼Œä¾‹å¦‚æ”¯æŒ Python 3.5 æ—¶ä½¿ç”¨ <code>--py-limited-api=cp35</code>ï¼‰ã€‚</p>
</li>
</ol>
<h4 id="abi3-çš„æœ€ä½-python-ç‰ˆæœ¬"><a class="header" href="#abi3-çš„æœ€ä½-python-ç‰ˆæœ¬"><code>abi3</code> çš„æœ€ä½ Python ç‰ˆæœ¬</a></h4>
<p>ç”±äºå•ä¸ª <code>abi3</code> è½®å­å¯ç”¨äºå¤šä¸ªä¸åŒçš„ Python ç‰ˆæœ¬ï¼ŒPyO3 æä¾›äº† <code>abi3-py37</code>ã€<code>abi3-py38</code>ã€<code>abi3-py39</code> ç­‰ç‰¹æ€§æ ‡å¿—æ¥è®¾ç½®ä½ çš„ <code>abi3</code> è½®å­æ‰€éœ€çš„æœ€ä½ Python ç‰ˆæœ¬ã€‚ä¾‹å¦‚ï¼Œå¦‚æœä½ è®¾ç½®äº† <code>abi3-py37</code> ç‰¹æ€§ï¼Œä½ çš„æ‰©å±•è½®å­å°±å¯ä»¥åœ¨ Python 3.7 åŠä»¥ä¸Šç‰ˆæœ¬ä¸­ä½¿ç”¨ã€‚<code>maturin</code> å’Œ <code>setuptools-rust</code> ä¼šå°†è½®å­å‘½åä¸ºç±»ä¼¼ <code>my-extension-1.0-cp37-abi3-manylinux2020_x86_64.whl</code> çš„å½¢å¼ã€‚</p>
<p>ç”±äºä½ çš„æ‰©å±•æ¨¡å—å¯èƒ½åœ¨å¤šä¸ªä¸åŒçš„ Python ç‰ˆæœ¬ä¸­è¿è¡Œï¼Œæœ‰æ—¶ä½ å¯èƒ½éœ€è¦åœ¨è¿è¡Œæ—¶æ£€æŸ¥ Python ç‰ˆæœ¬æ¥å®šåˆ¶è¡Œä¸ºã€‚è¯·å‚é˜…æœ¬æŒ‡å— <a href="#checking-the-python-version-at-runtime">æ”¯æŒè¿è¡Œæ—¶å¤š Python ç‰ˆæœ¬</a> çš„ç›¸å…³éƒ¨åˆ†ã€‚</p>
<p>PyO3 ä»…èƒ½å°†ä½ çš„æ‰©å±•æ¨¡å—é“¾æ¥åˆ°ç­‰äºæˆ–ä½äºä½ å½“å‰ä¸»æœº Python ç‰ˆæœ¬çš„ <code>abi3</code> ç‰ˆæœ¬ã€‚ä¾‹å¦‚ï¼Œå¦‚æœä½ è®¾ç½®äº† <code>abi3-py38</code> å¹¶å°è¯•ä½¿ç”¨ Python 3.7 ä¸»æœºç¼–è¯‘ï¼Œæ„å»ºå°†å¤±è´¥ã€‚</p>
<blockquote>
<p>æ³¨æ„ï¼šå¦‚æœä½ åŒæ—¶è®¾ç½®äº†å¤šä¸ª <code>abi3</code> ç‰ˆæœ¬ç‰¹æ€§æ ‡å¿—ï¼Œæœ€ä½ç‰ˆæœ¬å§‹ç»ˆç”Ÿæ•ˆã€‚ä¾‹å¦‚ï¼Œå½“åŒæ—¶è®¾ç½® <code>abi3-py37</code> å’Œ <code>abi3-py38</code> æ—¶ï¼ŒPyO3 å°†æ„å»ºä¸€ä¸ªæ”¯æŒ Python 3.7 åŠä»¥ä¸Šç‰ˆæœ¬çš„è½®å­ã€‚</p>
</blockquote>
<h4 id="åœ¨æ²¡æœ‰-python-è§£é‡Šå™¨çš„æƒ…å†µä¸‹æ„å»º-abi3-æ‰©å±•"><a class="header" href="#åœ¨æ²¡æœ‰-python-è§£é‡Šå™¨çš„æƒ…å†µä¸‹æ„å»º-abi3-æ‰©å±•">åœ¨æ²¡æœ‰ Python è§£é‡Šå™¨çš„æƒ…å†µä¸‹æ„å»º <code>abi3</code> æ‰©å±•</a></h4>
<p>ä½œä¸ºä¸€ä¸ªé«˜çº§ç‰¹æ€§ï¼Œä½ å¯ä»¥é€šè¿‡è®¾ç½®ç¯å¢ƒå˜é‡ <code>PYO3_NO_PYTHON</code> åœ¨ä¸è°ƒç”¨ Python è§£é‡Šå™¨çš„æƒ…å†µä¸‹æ„å»º PyO3 è½®å­ã€‚æ­¤å¤–ï¼Œå¦‚æœæ„å»ºä¸»æœºä¸Šçš„ Python è§£é‡Šå™¨æœªæ‰¾åˆ°ã€ç‰ˆæœ¬è¿‡æ—§æˆ–ä¸å¯ç”¨ï¼ŒPyO3 ä»ä¼šåœ¨æ˜¾ç¤ºè­¦å‘Šä¿¡æ¯åå°è¯•ç¼–è¯‘ <code>abi3</code> æ‰©å±•æ¨¡å—ã€‚åœ¨ç±» Unix ç³»ç»Ÿä¸Šï¼Œæ­¤åŠŸèƒ½æ— æ¡ä»¶å¯ç”¨ï¼›åœ¨ Windows ä¸Šï¼Œä½ è¿˜å¿…é¡»è®¾ç½® <code>RUSTFLAGS</code> ç¯å¢ƒå˜é‡ï¼Œä½¿å…¶åŒ…å« <code>-L native=/path/to/python/libs</code>ï¼Œä»¥ä¾¿é“¾æ¥å™¨èƒ½æ‰¾åˆ° <code>python3.lib</code>ã€‚</p>
<p>å¦‚æœ <code>python3.dll</code> å¯¼å…¥åº“ä¸å¯ç”¨ï¼Œå¯ä»¥å¯ç”¨å®éªŒæ€§çš„ <code>generate-import-lib</code> crate ç‰¹æ€§ï¼ŒPyO3 å°†è‡ªåŠ¨åˆ›å»ºå¹¶ä½¿ç”¨æ‰€éœ€åº“ã€‚</p>
<p><em>æ³¨æ„</em>ï¼šMSVC ç›®æ ‡éœ€è¦ <code>llvm-dlltool</code> å·¥å…·ï¼ˆLLVM binutils çš„ä¸€éƒ¨åˆ†ï¼‰ä½äº <code>PATH</code> ä¸­ï¼Œæ‰èƒ½ä½¿è‡ªåŠ¨å¯¼å…¥åº“ç”ŸæˆåŠŸèƒ½æ­£å¸¸å·¥ä½œã€‚</p>
<h4 id="ç¼ºå¤±çš„åŠŸèƒ½"><a class="header" href="#ç¼ºå¤±çš„åŠŸèƒ½">ç¼ºå¤±çš„åŠŸèƒ½</a></h4>
<p>ç”±äº Python API çš„é™åˆ¶ï¼Œå½“ä¸º <code>abi3</code> ç¼–è¯‘æ—¶ï¼Œéƒ¨åˆ† <code>pyo3</code> åŠŸèƒ½æ— æ³•ä½¿ç”¨ï¼ŒåŒ…æ‹¬ï¼š</p>
<ul>
<li><code>#[pyo3(text_signature = "...")]</code> åœ¨ Python 3.10 ä¹‹å‰ä¸æ”¯æŒç±»ã€‚</li>
<li>ç±»ä¸Šçš„ <code>dict</code> å’Œ <code>weakref</code> é€‰é¡¹åœ¨ Python 3.9 ä¹‹å‰ä¸å—æ”¯æŒã€‚</li>
<li>ç¼“å†²åŒº API åœ¨ Python 3.11 ä¹‹å‰ä¸å—æ”¯æŒã€‚</li>
<li>ä¾èµ–äºå·²çŸ¥ç¡®åˆ‡ Python ç‰ˆæœ¬çš„ä¼˜åŒ–åŠŸèƒ½ã€‚</li>
</ul>
<h2 id="åœ¨-rust-ä¸­åµŒå…¥-python"><a class="header" href="#åœ¨-rust-ä¸­åµŒå…¥-python">åœ¨ Rust ä¸­åµŒå…¥ Python</a></h2>
<p>å¦‚æœä½ æƒ³åœ¨ Rust ç¨‹åºä¸­åµŒå…¥ Python è§£é‡Šå™¨ï¼Œæœ‰ä¸¤ç§æ¨¡å¼å¯é€‰ï¼šåŠ¨æ€åµŒå…¥å’Œé™æ€åµŒå…¥ã€‚æˆ‘ä»¬å°†åœ¨æ¥ä¸‹æ¥çš„éƒ¨åˆ†ä»‹ç»è¿™ä¸¤ç§æ¨¡å¼ï¼Œå®ƒä»¬ä¹Ÿä¼šå½±å“ä½ çš„ç¨‹åºåˆ†å‘æ–¹å¼ã€‚ä¸å…¶è‡ªè¡Œå­¦ä¹ å¦‚ä½•å®ç°ï¼Œä½ å¯èƒ½æ›´æ„¿æ„ä½¿ç”¨åƒ <a href="https://github.com/indygreg/PyOxidizer">PyOxidizer</a> è¿™æ ·çš„é¡¹ç›®ï¼Œå°†ä½ çš„åº”ç”¨ç¨‹åºåŠå…¶æ‰€æœ‰ä¾èµ–æ‰“åŒ…æˆå•ä¸ªæ–‡ä»¶ã€‚</p>
<p>PyO3 ä¼šæ ¹æ®ä½ é…ç½® PyO3 ä½¿ç”¨çš„ Python å‘è¡Œç‰ˆï¼ˆ<a href="#configuring-the-python-version">è§ä¸Šæ–‡</a>ï¼‰æ˜¯å¦åŒ…å«å…±äº«åº“æˆ–é™æ€åº“ï¼Œè‡ªåŠ¨åœ¨è¿™ä¸¤ç§é“¾æ¥æ¨¡å¼ä¹‹é—´åˆ‡æ¢ã€‚é™æ€åº“é€šå¸¸å‡ºç°åœ¨ä»æºç ç¼–è¯‘ä¸”æœªä½¿ç”¨ <code>--enable-shared</code> é…ç½®é€‰é¡¹çš„ Python å‘è¡Œç‰ˆä¸­ã€‚</p>
<h3 id="åŠ¨æ€åµŒå…¥-python-è§£é‡Šå™¨"><a class="header" href="#åŠ¨æ€åµŒå…¥-python-è§£é‡Šå™¨">åŠ¨æ€åµŒå…¥ Python è§£é‡Šå™¨</a></h3>
<p>åŠ¨æ€åµŒå…¥ Python è§£é‡Šå™¨æ¯”é™æ€åµŒå…¥å®¹æ˜“å¾—å¤šã€‚è¿™é€šè¿‡å°†ä½ çš„ç¨‹åºé“¾æ¥åˆ° Python å…±äº«åº“ï¼ˆå¦‚ UNIX ä¸Šçš„ <code>libpython.3.9.so</code> æˆ– Windows ä¸Šçš„ <code>python39.dll</code>ï¼‰æ¥å®ç°ã€‚Python è§£é‡Šå™¨çš„å®ç°ä½äºå…±äº«åº“ä¸­ã€‚è¿™æ„å‘³ç€å½“æ“ä½œç³»ç»Ÿè¿è¡Œä½ çš„ Rust ç¨‹åºæ—¶ï¼Œä¹Ÿéœ€è¦èƒ½å¤Ÿæ‰¾åˆ° Python å…±äº«åº“ã€‚</p>
<p>è¿™ç§åµŒå…¥æ–¹å¼éå¸¸é€‚åˆéœ€è¦è®¿é—® Python è§£é‡Šå™¨çš„ Rust æµ‹è¯•ã€‚å¯¹äºå®‰è£…åœ¨ Python è™šæ‹Ÿç¯å¢ƒï¼ˆvirtualenvï¼‰ä¸­çš„ Rust è½¯ä»¶ä¹Ÿéå¸¸é€‚ç”¨ï¼Œå› ä¸ºè™šæ‹Ÿç¯å¢ƒä¼šè®¾ç½®åˆé€‚çš„ç¯å¢ƒå˜é‡ä»¥å®šä½æ­£ç¡®çš„ Python å…±äº«åº“ã€‚</p>
<p>è‹¥è¦å°†ç¨‹åºåˆ†å‘ç»™éæŠ€æœ¯ç”¨æˆ·ï¼Œä½ è¿˜éœ€è¦è€ƒè™‘å°† Python å…±äº«åº“ä¸€å¹¶åŒ…å«åœ¨å‘å¸ƒåŒ…ä¸­ï¼Œå¹¶è®¾ç½®åŒ…è£…è„šæœ¬ä»¥è®¾ç½®æ­£ç¡®çš„ç¯å¢ƒå˜é‡ï¼ˆå¦‚ UNIX ä¸Šçš„ <code>LD_LIBRARY_PATH</code> æˆ– Windows ä¸Šçš„ <code>PATH</code>ï¼‰ã€‚</p>
<p>è¯·æ³¨æ„ï¼šPyPy æ— æ³•è¢«åµŒå…¥åˆ° Rustï¼ˆæˆ–å…¶ä»–ä»»ä½•è½¯ä»¶ï¼‰ä¸­ã€‚å¯¹æ­¤çš„æ”¯æŒæ­£åœ¨ <a href="https://github.com/pypy/pypy/issues/3836">PyPy é—®é¢˜è¿½è¸ªå™¨</a> ä¸­è·Ÿè¸ªã€‚</p>
<h3 id="é™æ€åµŒå…¥-python-è§£é‡Šå™¨"><a class="header" href="#é™æ€åµŒå…¥-python-è§£é‡Šå™¨">é™æ€åµŒå…¥ Python è§£é‡Šå™¨</a></h3>
<p>é™æ€åµŒå…¥ Python è§£é‡Šå™¨æ„å‘³ç€å°† Python é™æ€åº“çš„å†…å®¹ç›´æ¥åŒ…å«åœ¨ä½ çš„ Rust äºŒè¿›åˆ¶æ–‡ä»¶ä¸­ã€‚è¿™æ„å‘³ç€ä½ åœ¨åˆ†å‘ç¨‹åºæ—¶åªéœ€è¦æä¾›äºŒè¿›åˆ¶æ–‡ä»¶ï¼šPython è§£é‡Šå™¨å·²ç»å†…åµŒåœ¨äºŒè¿›åˆ¶æ–‡ä»¶ä¸­ï¼</p>
<p>åœ¨ Windows ä¸Šå‡ ä¹ä»ä¸åšé™æ€é“¾æ¥ï¼Œå› æ­¤ Python å‘è¡Œç‰ˆé€šå¸¸ä¸åŒ…å«é™æ€åº“ã€‚ä»¥ä¸‹ä¿¡æ¯ä»…é€‚ç”¨äº UNIX ç³»ç»Ÿã€‚</p>
<p>Python é™æ€åº“é€šå¸¸åä¸º <code>libpython.a</code>ã€‚é™æ€é“¾æ¥å­˜åœ¨è®¸å¤šå¤æ‚é—®é¢˜ï¼Œå¦‚ä¸‹æ‰€åˆ—ã€‚å› æ­¤ï¼ŒPyO3 ç›®å‰å°šæœªå¯¹è¯¥åµŒå…¥æ¨¡å¼æä¾›ä¸€æµæ”¯æŒã€‚æ›´å¤šè¯¦æƒ…ä»¥åŠé‡åˆ°é—®é¢˜æ—¶çš„è®¨è®ºï¼Œè¯·å‚è§ <a href="https://github.com/PyO3/pyo3/issues/416">PyO3 GitHub ä¸Šçš„ issue 416</a>ã€‚</p>
<p>å½“é™æ€åµŒå…¥è§£é‡Šå™¨æ—¶ï¼Œ<a href="#auto-initialize"><code>auto-initialize</code></a> åŠŸèƒ½ä¼šè¢«åˆ»æ„ç¦ç”¨ï¼Œå› ä¸ºæ–°ç”¨æˆ·åœ¨è¿è¡Œæµ‹è¯•ç¨‹åºæ—¶å¸¸å¸¸ä¼šæ— æ„ä¸­æ‰§è¡Œé™æ€é“¾æ¥ã€‚è€Œä½¿ç”¨åŠ¨æ€åµŒå…¥æ–¹å¼å°è¯• PyO3 åˆ™è¦ç®€å•å¾—å¤šã€‚</p>
<p>å·²çŸ¥çš„å¤æ‚é—®é¢˜åŒ…æ‹¬ï¼š</p>
<ul>
<li>
<p>ä¸ºäº†å¯¼å…¥å·²ç¼–è¯‘çš„æ‰©å±•æ¨¡å—ï¼ˆä¾‹å¦‚å…¶ä»–ç”¨ Rust æˆ– C ç¼–å†™çš„æ‰©å±•æ¨¡å—ï¼‰ï¼Œä½ çš„äºŒè¿›åˆ¶æ–‡ä»¶åœ¨ç¼–è¯‘æœŸé—´å¿…é¡»è®¾ç½®æ­£ç¡®çš„é“¾æ¥å™¨æ ‡å¿—ï¼Œä»¥å¯¼å‡º <code>libpython.a</code> çš„åŸå§‹å†…å®¹ï¼Œä¾›æ‰©å±•æ¨¡å—ä½¿ç”¨ï¼ˆä¾‹å¦‚ <code>-Wl,--export-dynamic</code>ï¼‰ã€‚</p>
</li>
<li>
<p>åˆ›å»º <code>libpython.a</code> æ‰€ä½¿ç”¨çš„ C ç¼–è¯‘å™¨å’Œç¼–è¯‘æ ‡å¿—å¿…é¡»ä¸ä½ çš„ Rust ç¼–è¯‘å™¨å’Œæ ‡å¿—å…¼å®¹ï¼Œå¦åˆ™ä¼šå‡ºç°ç¼–è¯‘å¤±è´¥ã€‚</p>
<p>æ˜æ˜¾ä¸åŒçš„ç¼–è¯‘å™¨ç‰ˆæœ¬å¯èƒ½ä¼šå‡ºç°å¦‚ä¸‹é”™è¯¯ï¼š</p>
<pre><code class="language-text">lto1: fatal error: bytecode stream in file 'rust-numpy/target/release/deps/libpyo3-6a7fb2ed970dbf26.rlib' generated with LTO version 6.0 instead of the expected 6.2
</code></pre>
<p>æ ‡å¿—ä¸åŒ¹é…å¯èƒ½å¯¼è‡´å¦‚ä¸‹é”™è¯¯ï¼š</p>
<pre><code class="language-text">/usr/bin/ld: /usr/lib/gcc/x86_64-linux-gnu/9/../../../x86_64-linux-gnu/libpython3.9.a(zlibmodule.o): relocation R_X86_64_32 against `.data' can not be used when making a PIE object; recompile with -fPIE
</code></pre>
</li>
</ul>
<p>å¦‚æœä½ åœ¨é™æ€é“¾æ¥è§£é‡Šå™¨æ—¶é‡åˆ°ä¸Šè¿°æˆ–å…¶ä»–é—®é¢˜ï¼Œè¯·åœ¨ <a href="https://github.com/PyO3/pyo3/issues/416">PyO3 GitHub çš„ issue 416</a> ä¸­è¿›è¡Œè®¨è®ºã€‚å¸Œæœ›å°†æ¥æ­¤è®¨è®ºèƒ½ç§¯ç´¯è¶³å¤Ÿçš„ä¿¡æ¯å’Œè§£å†³æ–¹æ¡ˆï¼Œä½¿å¾— PyO3 èƒ½å¤Ÿä¸ºé™æ€åµŒå…¥æä¾›ä¸€æµæ”¯æŒã€‚</p>
<h3 id="åœ¨åµŒå…¥-python-è§£é‡Šå™¨æ—¶å¯¼å…¥ä½ çš„æ¨¡å—"><a class="header" href="#åœ¨åµŒå…¥-python-è§£é‡Šå™¨æ—¶å¯¼å…¥ä½ çš„æ¨¡å—">åœ¨åµŒå…¥ Python è§£é‡Šå™¨æ—¶å¯¼å…¥ä½ çš„æ¨¡å—</a></h3>
<p>å½“ä½ è¿è¡Œå¸¦æœ‰åµŒå…¥è§£é‡Šå™¨çš„ Rust äºŒè¿›åˆ¶æ–‡ä»¶æ—¶ï¼Œä»»ä½•é€šè¿‡ <code>#[pymodule]</code> åˆ›å»ºçš„æ¨¡å—éƒ½æ— æ³•ç›´æ¥è¢«å¯¼å…¥ï¼Œé™¤éåœ¨åˆå§‹åŒ–åµŒå…¥è§£é‡Šå™¨ä¹‹å‰å°†å…¶æ·»åŠ åˆ°ä¸€ä¸ªåä¸º <code>PyImport_Inittab</code> çš„è¡¨ä¸­ã€‚å¦åˆ™ï¼ŒåµŒå…¥è§£é‡Šå™¨ä¸­çš„ Python è¯­å¥ï¼ˆå¦‚ <code>import your_new_module</code>ï¼‰å°†å¤±è´¥ã€‚ä½ å¯ä»¥åœ¨åˆå§‹åŒ– Python è§£é‡Šå™¨å‰è°ƒç”¨å® <a href="{{#PYO3_DOCS_URL}}/pyo3/macro.append_to_inittab.html"><code>append_to_inittab</code></a>ï¼Œå°†ä½ çš„æ¨¡å—åŠ å…¥è¯¥è¡¨ã€‚ï¼ˆPython è§£é‡Šå™¨ä¼šåœ¨è°ƒç”¨ <code>Python::initialize</code>ã€<code>with_embedded_python_interpreter</code> æˆ–åœ¨å¯ç”¨ <a href="#auto-initialize"><code>auto-initialize</code></a> åŠŸèƒ½æ—¶è°ƒç”¨ <code>Python::attach</code> æ—¶è¢«åˆå§‹åŒ–ã€‚ï¼‰</p>
<h2 id="äº¤å‰ç¼–è¯‘"><a class="header" href="#äº¤å‰ç¼–è¯‘">äº¤å‰ç¼–è¯‘</a></h2>
<p>å¾—ç›Šäº Rust å¼ºå¤§çš„äº¤å‰ç¼–è¯‘æ”¯æŒï¼Œä½¿ç”¨ PyO3 è¿›è¡Œäº¤å‰ç¼–è¯‘ç›¸å¯¹ç®€å•ã€‚å¼€å§‹å‰ï¼Œä½ éœ€è¦å‡†å¤‡ä»¥ä¸‹è½¯ä»¶ï¼š</p>
<ul>
<li>ç›®æ ‡å¹³å°çš„å·¥å…·é“¾ã€‚</li>
<li>åœ¨ Cargo <code>.config</code> ä¸­ä¸ºä½ çš„ç›®æ ‡å¹³å°å’Œæ‰€ç”¨å·¥å…·é“¾é…ç½®åˆé€‚çš„é€‰é¡¹ã€‚</li>
<li>å·²ä¸ºç›®æ ‡å¹³å°ç¼–è¯‘å¥½çš„ Python è§£é‡Šå™¨ï¼ˆæ„å»º â€œabi3â€ æ‰©å±•æ¨¡å—æ—¶å¯é€‰ï¼‰ã€‚</li>
<li>ä¸»æœºå¹³å°ä¸Šçš„ Python è§£é‡Šå™¨ï¼Œå¹¶é€šè¿‡ <code>PATH</code> æˆ–è®¾ç½® <a href="#configuring-the-python-version"><code>PYO3_PYTHON</code></a> å˜é‡å¯è®¿é—®ï¼ˆæ„å»º â€œabi3â€ æ‰©å±•æ¨¡å—æ—¶å¯é€‰ï¼‰ã€‚</li>
</ul>
<p>å®Œæˆä¸Šè¿°å‡†å¤‡åï¼Œä½ å¯ä»¥ä½¿ç”¨ Cargo çš„ <code>--target</code> æ ‡å¿—æ¥æ„å»ºäº¤å‰ç¼–è¯‘çš„ PyO3 æ¨¡å—ã€‚PyO3 çš„æ„å»ºè„šæœ¬ä¼šæ ¹æ®ä½ çš„ä¸»æœºå’Œç›®æ ‡å¹³å°è‡ªåŠ¨æ£€æµ‹æ˜¯å¦æ­£åœ¨è¿›è¡Œäº¤å‰ç¼–è¯‘ã€‚</p>
<p>åœ¨äº¤å‰ç¼–è¯‘æ—¶ï¼ŒPyO3 çš„æ„å»ºè„šæœ¬æ— æ³•è¿è¡Œç›®æ ‡å¹³å°çš„ Python è§£é‡Šå™¨æ¥æŸ¥è¯¢é…ç½®ï¼Œå› æ­¤ä½ å¯èƒ½éœ€è¦è®¾ç½®ä¸€äº›é¢å¤–çš„ç¯å¢ƒå˜é‡ï¼š</p>
<ul>
<li><code>PYO3_CROSS</code>ï¼šå­˜åœ¨æ—¶å¼ºåˆ¶ PyO3 æŒ‰äº¤å‰ç¼–è¯‘æ¨¡å¼é…ç½®ã€‚</li>
<li><code>PYO3_CROSS_LIB_DIR</code>ï¼šå¯è®¾ä¸ºåŒ…å«ç›®æ ‡å¹³å° libpython åŠ¨æ€å…±äº«å¯¹è±¡ï¼ˆDSOï¼‰åŠå¯¹åº” <code>_sysconfigdata*.py</code> æ–‡ä»¶ï¼ˆç±» Unix ç›®æ ‡ï¼‰æˆ– Python DLL å¯¼å…¥åº“ï¼ˆWindows ç›®æ ‡ï¼‰çš„ç›®å½•ã€‚ä»…å½“è¾“å‡ºäºŒè¿›åˆ¶æ–‡ä»¶éœ€è¦æ˜¾å¼é“¾æ¥ libpythonï¼ˆä¾‹å¦‚ç›®æ ‡ä¸º Windows å’Œ Android æˆ–åµŒå…¥ Python è§£é‡Šå™¨ï¼‰æˆ–å¿…é¡»ä» <code>_sysconfigdata*.py</code> è·å–è§£é‡Šå™¨é…ç½®æ—¶æ‰éœ€è¦è®¾ç½®è¯¥å˜é‡ã€‚</li>
<li><code>PYO3_CROSS_PYTHON_VERSION</code>ï¼šç›®æ ‡ Python å®‰è£…çš„ä¸»ç‰ˆæœ¬å’Œæ¬¡ç‰ˆæœ¬ï¼ˆå¦‚ 3.9ï¼‰ã€‚ä»…å½“ PyO3 æ— æ³•ä» <code>abi3-py3*</code> åŠŸèƒ½ä¸­ç¡®å®šç›®æ ‡ç‰ˆæœ¬ï¼Œæˆ–æœªè®¾ç½® <code>PYO3_CROSS_LIB_DIR</code>ï¼Œæˆ– <code>PYO3_CROSS_LIB_DIR</code> ä¸­å­˜åœ¨å¤šä¸ª Python ç‰ˆæœ¬æ—¶ï¼Œæ‰éœ€è¦è®¾ç½®è¯¥å˜é‡ã€‚</li>
<li><code>PYO3_CROSS_PYTHON_IMPLEMENTATION</code>ï¼šç›®æ ‡ Python å®‰è£…çš„å®ç°åç§°ï¼ˆâ€œCPythonâ€ æˆ– â€œPyPyâ€ï¼‰ã€‚é»˜è®¤å‡è®¾ä¸º CPythonï¼Œé™¤éæœªè®¾ç½®æ­¤å˜é‡ä¸” PyO3 å¯é€šè¿‡ <code>_sysconfigdata*.py</code> è·å–è§£é‡Šå™¨é…ç½®ï¼ˆå½“ä¸ºç±» Unix ç›®æ ‡è®¾ç½®äº† <code>PYO3_CROSS_LIB_DIR</code> æ—¶ï¼‰ã€‚</li>
</ul>
<p>ä¸€ä¸ªå®éªŒæ€§çš„ <code>pyo3</code> crate åŠŸèƒ½ <code>generate-import-lib</code> å…è®¸ç”¨æˆ·åœ¨ä¸è®¾ç½® <code>PYO3_CROSS_LIB_DIR</code> ç¯å¢ƒå˜é‡æˆ–æä¾›ä»»ä½• Windows Python åº“æ–‡ä»¶çš„æƒ…å†µä¸‹ï¼Œäº¤å‰ç¼–è¯‘ Windows å¹³å°çš„æ‰©å±•æ¨¡å—ã€‚å®ƒé€šè¿‡å¤–éƒ¨çš„ <a href="https://docs.rs/python3-dll-a/latest/python3_dll_a/"><code>python3-dll-a</code></a> crate ä¸º MinGW-w64 å’Œ MSVC ç¼–è¯‘ç›®æ ‡ç”Ÿæˆ Python DLL çš„å¯¼å…¥åº“ã€‚<code>python3-dll-a</code> ä½¿ç”¨ binutils çš„ <code>dlltool</code> ç¨‹åºä¸º MinGW-w64 ç›®æ ‡ç”Ÿæˆ DLL å¯¼å…¥åº“ã€‚å¯ä»¥é€šè¿‡è®¾ç½® <code>PYO3_MINGW_DLLTOOL</code> ç¯å¢ƒå˜é‡ï¼Œè¦†ç›–äº¤å‰ç›®æ ‡çš„é»˜è®¤ <code>dlltool</code> å‘½ä»¤åã€‚<em>æ³¨æ„</em>ï¼šMSVC ç›®æ ‡è¦æ±‚ä¸»æœºç³»ç»Ÿä¸Šå®‰è£…æœ‰ LLVM binutils æˆ– MSVC æ„å»ºå·¥å…·ã€‚æ›´å…·ä½“åœ°è¯´ï¼Œå½“ç›®æ ‡ä¸º <code>*-pc-windows-msvc</code> æ—¶ï¼Œ<code>python3-dll-a</code> è¦æ±‚ <code>llvm-dlltool</code> æˆ– <code>lib.exe</code> å¯æ‰§è¡Œæ–‡ä»¶åœ¨ <code>PATH</code> ä¸­ã€‚è‹¥è®¾ç½®äº† <code>ZIG_COMMAND</code> ç¯å¢ƒå˜é‡æŒ‡å‘å·²å®‰è£…çš„ Zig ç¨‹åºï¼ˆå¦‚ <code>"zig"</code> æˆ– <code>"python -m ziglang"</code>ï¼‰ï¼Œåˆ™å¯ä½¿ç”¨ Zig ç¼–è¯‘å™¨æ›¿ä»£ <code>llvm-dlltool</code>ã€‚</p>
<p>ä¸€ä¸ªç¤ºä¾‹å¯èƒ½å¦‚ä¸‹ï¼ˆå‡è®¾ç›®æ ‡ sysroot ä½äº <code>/home/pyo3/cross/sysroot</code>ï¼Œç›®æ ‡ä¸º <code>armv7</code>ï¼‰ï¼š</p>
<pre><code class="language-sh">export PYO3_CROSS_LIB_DIR="/home/pyo3/cross/sysroot/usr/lib"

cargo build --target armv7-unknown-linux-gnueabihf
</code></pre>
<p>å¦‚æœäº¤å‰åº“ç›®å½•ä¸­å­˜åœ¨å¤šä¸ª Python ç‰ˆæœ¬ï¼Œä¸”æ— æ³•è®¾ç½®æ›´ç²¾ç¡®çš„ä½ç½®æ¥åŒæ—¶åŒ…å« <code>libpython</code> DSO å’Œ <code>_sysconfigdata*.py</code> æ–‡ä»¶ï¼Œå¯ä»¥æ˜¾å¼æŒ‡å®šæ‰€éœ€ç‰ˆæœ¬ï¼š</p>
<pre><code class="language-sh">export PYO3_CROSS_PYTHON_VERSION=3.8
export PYO3_CROSS_LIB_DIR="/home/pyo3/cross/sysroot/usr/lib"

cargo build --target armv7-unknown-linux-gnueabihf
</code></pre>
<p>å¦ä¸€ä¸ªä½¿ç”¨ç›¸åŒ sysroot ä½†æ„å»º Windows ç›®æ ‡çš„ä¾‹å­ï¼š</p>
<pre><code class="language-sh">export PYO3_CROSS_PYTHON_VERSION=3.9
export PYO3_CROSS_LIB_DIR="/home/pyo3/cross/sysroot/usr/lib"

cargo build --target x86_64-pc-windows-gnu
</code></pre>
<p>åœ¨ä¸Šè¿°ç¤ºä¾‹ä¸­ï¼Œä¹Ÿå¯ä»¥å¯ç”¨ä»»æ„ <code>abi3-py3*</code> åŠŸèƒ½æ¥æ›¿ä»£è®¾ç½® <code>PYO3_CROSS_PYTHON_VERSION</code>ã€‚</p>
<p>åœ¨ä¸º Unix å’Œ macOS ç›®æ ‡äº¤å‰ç¼–è¯‘æ‰©å±•æ¨¡å—æ—¶ï¼Œæˆ–åœ¨ä¸º Windows äº¤å‰ç¼–è¯‘æ‰©å±•æ¨¡å—ä¸”å¯ç”¨äº†å®éªŒæ€§ crate åŠŸèƒ½ <code>generate-import-lib</code> æ—¶ï¼Œé€šå¸¸å¯ä»¥çœç•¥ <code>PYO3_CROSS_LIB_DIR</code>ã€‚</p>
<p>ä»¥ä¸‹èµ„æºå¯¹äº¤å‰ç¼–è¯‘ä¹Ÿå¯èƒ½æœ‰å¸®åŠ©ï¼š</p>
<ul>
<li><a href="https://github.com/japaric/rust-cross">github.com/japaric/rust-cross</a> æ˜¯ Rust äº¤å‰ç¼–è¯‘å…¥é—¨æŒ‡å—ã€‚</li>
<li><a href="https://github.com/rust-embedded/cross">github.com/rust-embedded/cross</a> ä½¿ç”¨ Docker ç®€åŒ– Rust äº¤å‰ç¼–è¯‘æµç¨‹ã€‚</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="æ”¯æŒå¤šä¸ª-python-ç‰ˆæœ¬"><a class="header" href="#æ”¯æŒå¤šä¸ª-python-ç‰ˆæœ¬">æ”¯æŒå¤šä¸ª Python ç‰ˆæœ¬</a></h1>
<p>PyO3 æ”¯æŒæ‰€æœ‰å½“å‰æ­£åœ¨ç§¯æç»´æŠ¤çš„ Python 3 å’Œ PyPy ç‰ˆæœ¬ã€‚å°½å¯èƒ½åœ°ï¼Œè¿™äº›å…¼å®¹æ€§ç»†èŠ‚ç”± PyO3 å†…éƒ¨å¤„ç†ï¼Œå› æ­¤ä½ çš„ crate ä»£ç æ— éœ€é’ˆå¯¹ä¸åŒç‰ˆæœ¬ä¹‹é—´çš„å·®å¼‚è¿›è¡Œè°ƒæ•´ã€‚ç„¶è€Œï¼Œéšç€ Python åœ¨ä¸åŒç‰ˆæœ¬ä¹‹é—´åŠŸèƒ½çš„æ¼”è¿›ä¸å˜åŒ–ï¼ŒPyO3 æ— æ³•ä¸ºæ¯ä¸ª Python ç‰ˆæœ¬æä¾›å®Œå…¨ä¸€è‡´çš„ APIã€‚è¿™å¯èƒ½è¦æ±‚ä½ åœ¨ crate ä¸­æ·»åŠ æ¡ä»¶ç¼–è¯‘é€»è¾‘ï¼Œæˆ–åœ¨è¿è¡Œæ—¶æ£€æŸ¥ Python ç‰ˆæœ¬ã€‚</p>
<p>æœ¬æŒ‡å—çš„è¿™ä¸€éƒ¨åˆ†é¦–å…ˆä»‹ç» <code>pyo3-build-config</code> crateï¼Œä½ å¯ä»¥å°†å…¶ä½œä¸º <code>build-dependency</code> å¼•å…¥ï¼Œä»¥æ·»åŠ é¢å¤–çš„ <code>#[cfg]</code> æ ‡å¿—ï¼Œä»è€Œåœ¨ç¼–è¯‘æ—¶æ”¯æŒå¤šä¸ª Python ç‰ˆæœ¬ã€‚</p>
<p>å…¶æ¬¡ï¼Œæˆ‘ä»¬å°†å±•ç¤ºå¦‚ä½•åœ¨è¿è¡Œæ—¶æ£€æŸ¥ Python ç‰ˆæœ¬ã€‚è¿™åœ¨ä½¿ç”¨ <code>abi3</code> ç‰¹æ€§æ„å»ºé’ˆå¯¹å¤šä¸ªç‰ˆæœ¬çš„æ‰©å±•æ—¶ç‰¹åˆ«æœ‰ç”¨ï¼Œå› ä¸ºç¼–è¯‘æ—¶æ‰€é’ˆå¯¹çš„ Python API å¯èƒ½ä¸å®é™…è¿è¡Œæ—¶ä½¿ç”¨çš„ä¸ä¸€è‡´ã€‚</p>
<h2 id="é’ˆå¯¹ä¸åŒ-python-ç‰ˆæœ¬çš„æ¡ä»¶ç¼–è¯‘"><a class="header" href="#é’ˆå¯¹ä¸åŒ-python-ç‰ˆæœ¬çš„æ¡ä»¶ç¼–è¯‘">é’ˆå¯¹ä¸åŒ Python ç‰ˆæœ¬çš„æ¡ä»¶ç¼–è¯‘</a></h2>
<p><code>pyo3-build-config</code> æš´éœ²äº†å¤šä¸ª <a href="https://doc.rust-lang.org/rust-by-example/attribute/cfg.html"><code>#[cfg]</code> æ ‡å¿—</a>ï¼Œå¯ç”¨äºæ ¹æ®ç‰¹å®š Python ç‰ˆæœ¬æœ‰æ¡ä»¶åœ°ç¼–è¯‘ä»£ç ã€‚PyO3 æœ¬èº«ä¾èµ–äºè¯¥ crateï¼Œå› æ­¤ä½¿ç”¨å®ƒå¯ç¡®ä¿ä½ çš„ä»£ç é…ç½®ä¸ PyO3 æ­£åœ¨æ„å»ºçš„ç›®æ ‡ Python ç‰ˆæœ¬ç›¸åŒ¹é…ã€‚</p>
<p>è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥ç¼–å†™å¦‚ä¸‹ä»£ç ï¼š</p>
<pre><code class="language-rust ignore">#[cfg(Py_3_7)]
fn function_only_supported_on_python_3_7_and_up() {}

#[cfg(not(Py_3_8))]
fn function_only_supported_before_python_3_8() {}

#[cfg(not(Py_LIMITED_API))]
fn function_incompatible_with_abi3_feature() {}</code></pre>
<p>æ¥ä¸‹æ¥çš„éƒ¨åˆ†å°†é¦–å…ˆè¯´æ˜å¦‚ä½•åœ¨æ„å»ºæµç¨‹ä¸­æ·»åŠ è¿™äº› <code>#[cfg]</code> æ ‡å¿—ï¼Œç„¶åæ›´è¯¦ç»†åœ°ä»‹ç»ä¸€äº›å¸¸è§çš„æ ‡å¿—ä½¿ç”¨æ¨¡å¼ã€‚</p>
<p>å¦‚éœ€æŸ¥çœ‹æ‰€æœ‰å¯ç”¨ <code>#[cfg]</code> æ ‡å¿—çš„å®Œæ•´å‚è€ƒï¼Œè¯·å‚é˜… <a href="https://docs.rs/pyo3-build-config"><code>pyo3-build-cfg</code> æ–‡æ¡£</a>ã€‚</p>
<h3 id="ä½¿ç”¨-pyo3-build-config"><a class="header" href="#ä½¿ç”¨-pyo3-build-config">ä½¿ç”¨ <code>pyo3-build-config</code></a></h3>
<p>ä½ åªéœ€ä¸¤ä¸ªæ­¥éª¤å³å¯ä½¿ç”¨è¿™äº› <code>#[cfg]</code> æ ‡å¿—ï¼š</p>
<ol>
<li>
<p>åœ¨ <code>Cargo.toml</code> ä¸­å°† <code>pyo3-build-config</code> æ·»åŠ ä¸ºæ„å»ºä¾èµ–é¡¹ï¼Œå¹¶å¯ç”¨ <a href="#resolve-config"><code>resolve-config</code></a> ç‰¹æ€§ï¼š</p>
<pre><code class="language-toml">[build-dependencies]
pyo3-build-config = { {{#PYO3_CRATE_VERSION}}, features = ["resolve-config"] }
</code></pre>
</li>
<li>
<p>åœ¨ä½ çš„ crate ä¸­æ·»åŠ ä¸€ä¸ª <a href="https://doc.rust-lang.org/cargo/reference/build-scripts.html"><code>build.rs</code></a> æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p>
<pre><code class="language-rust ignore">fn main() {
    // å¦‚æœä½ å·²æœ‰ build.rs æ–‡ä»¶ï¼Œåªéœ€æ·»åŠ è¿™ä¸€è¡Œã€‚
    pyo3_build_config::use_pyo3_cfgs();
}</code></pre>
</li>
</ol>
<p>å®Œæˆè¿™ä¸¤ä¸ªæ­¥éª¤åï¼Œä½ å°±å¯ä»¥å¼€å§‹ä¸ºä»£ç æ·»åŠ æ³¨è§£äº†ï¼</p>
<h3 id="pyo3-build-cfg-æ ‡å¿—çš„å¸¸è§ç”¨æ³•"><a class="header" href="#pyo3-build-cfg-æ ‡å¿—çš„å¸¸è§ç”¨æ³•"><code>pyo3-build-cfg</code> æ ‡å¿—çš„å¸¸è§ç”¨æ³•</a></h3>
<p><code>pyo3-build-cfg</code> æ·»åŠ çš„ <code>#[cfg]</code> æ ‡å¿—å¯ä»¥ä¸ Rust <code>#[cfg]</code> å±æ€§ä¸­çš„æ‰€æœ‰é€»è¾‘ç»„åˆä½¿ç”¨ï¼Œå®ç°éå¸¸ç²¾ç¡®çš„æ¡ä»¶ä»£ç ç”Ÿæˆã€‚ä»¥ä¸‹æ˜¯å‡ ä¸ªå¸¸è§çš„ä½¿ç”¨æ¨¡å¼ï¼š</p>
<pre><code class="language-text">#[cfg(Py_3_7)]
</code></pre>
<p>è¯¥ <code>#[cfg]</code> æ ‡è®°ä»…åœ¨ Python 3.7 åŠä»¥ä¸Šç‰ˆæœ¬ä¸­æ‰åŒ…å«çš„ä»£ç ã€‚ç±»ä¼¼çš„è¿˜æœ‰ <code>Py_3_8</code>ã€<code>Py_3_9</code>ã€<code>Py_3_10</code> ç­‰ï¼Œå¯¹åº”å„ä¸ªæ¬¡ç‰ˆæœ¬ã€‚</p>
<pre><code class="language-text">#[cfg(not(Py_3_7))]
</code></pre>
<p>è¯¥ <code>#[cfg]</code> æ ‡è®°ä»…åœ¨ Python 3.7 ä¹‹å‰çš„ç‰ˆæœ¬ï¼ˆä¸åŒ…å« Python 3.7ï¼‰ä¸­æ‰åŒ…å«çš„ä»£ç ã€‚</p>
<pre><code class="language-text">#[cfg(not(Py_LIMITED_API))]
</code></pre>
<p>è¯¥ <code>#[cfg]</code> æ ‡è®°çš„ä»£ç ä»…åœ¨ä½¿ç”¨å®Œæ•´ Python APIï¼ˆå³æœªå¯ç”¨ PyO3 çš„ <code>abi3</code> ç‰¹æ€§ï¼‰æ—¶å¯ç”¨ã€‚è¿™åœ¨ä½ æƒ³ä»¥ <code>abi3</code> è½®å­å‘å¸ƒæ‰©å±•æ¨¡å—çš„åŒæ—¶ï¼Œå…è®¸ç”¨æˆ·ä»æºç ç¼–è¯‘ä»¥åˆ©ç”¨å®Œæ•´ API æä¾›çš„ä¼˜åŒ–æ—¶éå¸¸æœ‰ç”¨ã€‚</p>
<pre><code class="language-text">#[cfg(any(Py_3_9, not(Py_LIMITED_API)))]
</code></pre>
<p>è¯¥ <code>#[cfg]</code> æ ‡è®°çš„ä»£ç åœ¨è¿è¡Œ Python 3.9 æˆ–æ›´æ–°ç‰ˆæœ¬æ—¶ï¼Œæˆ–åœ¨æ—§ç‰ˆ Python ä¸­ä½¿ç”¨å®Œæ•´ API æ—¶å¯ç”¨ã€‚ç±»ä¼¼çš„æ¨¡å¼å¸¸è§äºé‚£äº›åœ¨æŸä¸ªç‰¹å®šæ¬¡ç‰ˆæœ¬ä¸­æ‰åŠ å…¥å—é™ Python API çš„åŠŸèƒ½ã€‚</p>
<pre><code class="language-text">#[cfg(PyPy)]
</code></pre>
<p>è¯¥ <code>#[cfg]</code> æ ‡è®°çš„ä»£ç è¿è¡Œåœ¨ PyPy ä¸Šã€‚</p>
<h2 id="åœ¨è¿è¡Œæ—¶æ£€æŸ¥-python-ç‰ˆæœ¬"><a class="header" href="#åœ¨è¿è¡Œæ—¶æ£€æŸ¥-python-ç‰ˆæœ¬">åœ¨è¿è¡Œæ—¶æ£€æŸ¥ Python ç‰ˆæœ¬</a></h2>
<p>å½“ä½¿ç”¨ PyO3 çš„ <code>abi3</code> ç‰¹æ€§æ„å»ºæ—¶ï¼Œä½ çš„æ‰©å±•æ¨¡å—ä¼šé’ˆå¯¹æŸä¸ªç‰¹å®šçš„ <a href="#minimum-python-version-for-abi3">æœ€ä½ Python ç‰ˆæœ¬</a> è¿›è¡Œç¼–è¯‘ï¼Œä½†å¯èƒ½åœ¨æ›´æ–°çš„ Python ç‰ˆæœ¬ä¸Šè¿è¡Œã€‚</p>
<p>ä¾‹å¦‚ï¼Œä½¿ç”¨ PyO3 çš„ <code>abi3-py38</code> ç‰¹æ€§æ—¶ï¼Œä½ çš„æ‰©å±•ä¼šè¢«å½“ä½œé’ˆå¯¹ Python 3.8 ç¼–è¯‘ï¼Œå¦‚æœä½¿ç”¨äº† <code>pyo3-build-config</code>ï¼Œ<code>#[cfg(Py_3_8)]</code> å°†ä¼šç”Ÿæ•ˆã€‚è€Œä½ çš„ç”¨æˆ·ä»ç„¶å¯ä»¥åœ¨ Python 3.9 ä¸Šè‡ªç”±å®‰è£…å¹¶è¿è¡Œè¿™ä¸ª abi3 æ‰©å±•ã€‚</p>
<p>è¿™ç§æƒ…å†µæ— æ³•åœ¨ç¼–è¯‘æ—¶æ£€æµ‹åˆ°ï¼Œå› æ­¤ä½ å¿…é¡»å›é€€åˆ°è¿è¡Œæ—¶æ£€æŸ¥ã€‚</p>
<p>PyO3 æä¾›äº† <a href="building-and-distribution/{{#PYO3_DOCS_URL}}/pyo3/marker/struct.Python.html#method.version"><code>Python::version()</code></a> å’Œ <a href="building-and-distribution/{{#PYO3_DOCS_URL}}/pyo3/marker/struct.Python.html#method.version_info"><code>Python::version_info()</code></a> ä¸¤ä¸ª API æ¥æŸ¥è¯¢å½“å‰è¿è¡Œçš„ Python ç‰ˆæœ¬ã€‚ä¾‹å¦‚ï¼Œä½ å¯ä»¥è¿™æ ·åšï¼š</p>
<pre><code class="language-rust">use pyo3::Python;

Python::attach(|py| {
    // PyO3 æ”¯æŒ Python 3.7 åŠä»¥ä¸Šç‰ˆæœ¬ã€‚
    assert!(py.version_info() &gt;= (3, 7));
    assert!(py.version_info() &gt;= (3, 7, 0));
});</code></pre>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="pyo3-ç”Ÿæ€ç³»ç»Ÿ"><a class="header" href="#pyo3-ç”Ÿæ€ç³»ç»Ÿ">PyO3 ç”Ÿæ€ç³»ç»Ÿ</a></h1>
<p>æœ¬æŒ‡å—çš„è¿™ä¸€éƒ¨åˆ†ä»‹ç»äº†å±äº PyO3 ä¸»é¡¹ç›®ä¹‹å¤–çš„ crateï¼Œå®ƒä»¬æä¾›äº†ä½ å¯èƒ½ä¼šè§‰å¾—æœ‰ç”¨çš„é™„åŠ åŠŸèƒ½ã€‚</p>
<p>ç”±äºè¿™äº›é¡¹ç›®ç‹¬ç«‹äº PyO3 ä»“åº“è¿›è¡Œæ¼”è¿›ï¼Œå› æ­¤è¿™äº›æ–‡ç« çš„å†…å®¹å¯èƒ½ä¼šéšç€æ—¶é—´æ¨ç§»è€Œè¿‡æ—¶ï¼›å¦‚é‡æ­¤ç±»æƒ…å†µï¼Œè¯·åœ¨ PyO3 GitHub ä¸Šæäº¤ issue ä»¥é€šçŸ¥ç»´æŠ¤è€…ã€‚</p>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="æ—¥å¿—è®°å½•"><a class="header" href="#æ—¥å¿—è®°å½•">æ—¥å¿—è®°å½•</a></h1>
<p>ç†æƒ³æƒ…å†µä¸‹ï¼Œåº”ç”¨ç¨‹åºçš„ Python å’Œ Rust éƒ¨åˆ†åº”ä½¿ç”¨ç›¸åŒçš„é…ç½®ï¼Œå°†æ—¥å¿—è¾“å‡ºåˆ°åŒä¸€ä¸ªåœ°æ–¹ã€‚</p>
<p>æœ¬æŒ‡å—çš„è¿™ä¸€éƒ¨åˆ†ç®€è¦ä»‹ç»äº†å¦‚ä½•å°†ä¸¤ç§è¯­è¨€çš„æ—¥å¿—ç”Ÿæ€ç³»ç»Ÿè¿æ¥åœ¨ä¸€èµ·ã€‚å¯¹äº Python æ‰©å±•æ¨¡å—ï¼Œæ¨èçš„æ–¹æ³•æ˜¯ä½¿ç”¨ <code>pyo3-log</code> åº“ï¼Œå°† Rust çš„æ—¥å¿—æ¶ˆæ¯å‘é€åˆ° Pythonã€‚å¯¹äºå¸Œæœ›åå‘æ“ä½œã€å°† Python æ—¥å¿—æ¶ˆæ¯å‘é€åˆ° Rust çš„ç”¨æˆ·ï¼Œè¯·å‚é˜…æœ¬æŒ‡å—æœ«å°¾çš„è¯´æ˜ã€‚</p>
<h2 id="ä½¿ç”¨-pyo3-log-å°†-rust-æ—¥å¿—å‘é€åˆ°-python"><a class="header" href="#ä½¿ç”¨-pyo3-log-å°†-rust-æ—¥å¿—å‘é€åˆ°-python">ä½¿ç”¨ <code>pyo3-log</code> å°† Rust æ—¥å¿—å‘é€åˆ° Python</a></h2>
<p><a href="https://crates.io/crates/pyo3-log">pyo3-log</a> åº“å…è®¸å°† Rust ä¾§çš„æ¶ˆæ¯å‘é€åˆ° Python çš„ <a href="https://docs.python.org/3/library/logging.html">logging</a> ç³»ç»Ÿã€‚è¿™ä¸»è¦é€‚ç”¨äºä¸º Python ç¨‹åºç¼–å†™åŸç”Ÿæ‰©å±•ã€‚</p>
<p>ä½¿ç”¨ <a href="https://docs.rs/pyo3-log/*/pyo3_log/fn.init.html"><code>pyo3_log::init</code></a> å¯ä»¥ä»¥é»˜è®¤é…ç½®å®‰è£…æ—¥å¿—è®°å½•å™¨ã€‚ä¹Ÿå¯ä»¥è°ƒæ•´å…¶é…ç½®ï¼ˆä¸»è¦æ˜¯ä¸ºäº†ä¼˜åŒ–æ€§èƒ½ï¼‰ã€‚</p>
<pre><code class="language-rust no_run">#[pyo3::pymodule]
mod my_module {
    use log::info;
    use pyo3::prelude::*;


    #[pyfunction]
    fn log_something() {
        // è¿™å°†ä½¿ç”¨ my_module ä¸­å®‰è£…çš„è®°å½•å™¨ï¼Œå°† info æ¶ˆæ¯å‘é€åˆ° Python çš„æ—¥å¿—ç³»ç»Ÿã€‚
        info!("Something!");
    }


    #[pymodule_init]
    fn init(m: &amp;Bound&lt;'_, PyModule&gt;) -&gt; PyResult&lt;()&gt; {
        // è¿™æ˜¯å®‰è£… Rust -&gt; Python æ—¥å¿—è®°å½•å™¨çš„å¥½æ—¶æœºã€‚
        pyo3_log::init();
    }
}</code></pre>
<p>ç„¶åç”± Python ä¾§å®é™…å°†æ¶ˆæ¯è¾“å‡ºåˆ°æŸä¸ªä½ç½®ã€‚</p>
<pre><code class="language-python">import logging
import my_module


FORMAT = '%(levelname)s %(name)s %(asctime)-15s %(filename)s:%(lineno)d %(message)s'
logging.basicConfig(format=FORMAT)
logging.getLogger().setLevel(logging.INFO)
my_module.log_something()
</code></pre>
<p>é‡è¦çš„æ˜¯ï¼Œå¿…é¡»å…ˆåˆå§‹åŒ– Python çš„æ—¥å¿—è®°å½•å™¨ï¼Œç„¶åå†è°ƒç”¨ä»»ä½•å¯èƒ½äº§ç”Ÿæ—¥å¿—çš„ Rust å‡½æ•°ã€‚å¦‚æœæ— æ³•æ»¡è¶³æ­¤é™åˆ¶ï¼Œå¯é€šè¿‡æŸ¥é˜…æœ‰å…³ <a href="https://docs.rs/pyo3-log/*/pyo3_log/#performance-filtering-and-caching">caching</a> çš„æ–‡æ¡£æ¥è§£å†³ã€‚</p>
<h2 id="python-åˆ°-rust-çš„æ–¹å‘"><a class="header" href="#python-åˆ°-rust-çš„æ–¹å‘">Python åˆ° Rust çš„æ–¹å‘</a></h2>
<p>è¦è®© Python çš„æ—¥å¿—ç”± Rust å¤„ç†ï¼Œåªéœ€æ³¨å†Œä¸€ä¸ª Rust å‡½æ•°æ¥å¤„ç†ä» Python æ ¸å¿ƒæ—¥å¿—æ¨¡å—å‘å‡ºçš„æ—¥å¿—å³å¯ã€‚</p>
<p>è¿™ä¸€åŠŸèƒ½å·²åœ¨ <a href="https://crates.io/crates/pyo3-pylogger">pyo3-pylogger</a> åº“ä¸­å®ç°ã€‚</p>
<pre><code class="language-rust no_run">use log::{info, warn};
use pyo3::prelude::*;


fn main() -&gt; PyResult&lt;()&gt; {
    // å°†å®¿ä¸»å¤„ç†ç¨‹åºæ³¨å†Œåˆ° Python æ—¥å¿—å™¨ï¼Œå¹¶æä¾›ä¸€ä¸ªæ—¥å¿—ç›®æ ‡
    // åœ¨æ­¤å¤„å°†åç§°è®¾ç½®ä¸ºé€‚åˆæ‚¨åº”ç”¨çš„åç§°
    pyo3_pylogger::register("example_application_py_logger");


    // åˆå§‹åŒ–ä¸€ä¸ªæ—¥å¿—å™¨
    env_logger::Builder::from_env(env_logger::Env::default().default_filter_or("trace")).init();


    // ä» Rust è¾“å‡ºä¸€äº›æ—¥å¿—ã€‚
    info!("Just some normal information!");
    warn!("Something spooky happened!");


    // ä» Python è¾“å‡ºä¸€äº›æ—¥å¿—
    Python::attach(|py| {
        py.run(
            "
import logging
logging.error('Something bad happened')
",
            None,
            None,
        )
    })
}</code></pre>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="è·Ÿè¸ªtracing"><a class="header" href="#è·Ÿè¸ªtracing">è·Ÿè¸ªï¼ˆTracingï¼‰</a></h1>
<p>å‡ºäºæ€§èƒ½åŸå› è€Œä¸º Python é¡¹ç›®ç¼–å†™æ‰©å±•æ¨¡å—çš„å¼€å‘è€…ï¼Œå¯èƒ½å¸Œæœ›æ¥å…¥ [Rust çš„ <code>tracing</code> ç”Ÿæ€ç³»ç»Ÿ]ï¼Œä»¥æ·±å…¥äº†è§£å…¶æ‰©å±•æ¨¡å—çš„æ€§èƒ½è¡¨ç°ã€‚</p>
<p>æœ¬æŒ‡å—çš„è¿™ä¸€éƒ¨åˆ†ä»‹ç»äº†å‡ ä¸ªæä¾›äº†å®ç°æ–¹å¼çš„ crateã€‚å®ƒä»¬åŸºäº <a href="https://docs.rs/tracing-subscriber/*/tracing_subscriber/"><code>tracing_subscriber</code></a> æ„å»ºï¼Œå¹¶ä¸”éœ€è¦åœ¨ Python å’Œ Rust ä¸¤ç«¯éƒ½è¿›è¡Œä»£ç ä¿®æ”¹ä»¥å®Œæˆé›†æˆã€‚è¯·æ³¨æ„ï¼Œæ¯ä¸ªæ‰©å±•æ¨¡å—å¿…é¡»ç‹¬ç«‹é…ç½®å…¶ <code>tracing</code> é›†æˆï¼›ä¸€ä¸ªæ‰©å±•æ¨¡å—æ— æ³•çœ‹åˆ°æ¥è‡ªå¦ä¸€ä¸ªæ¨¡å—çš„ <code>tracing</code> æ•°æ®ã€‚</p>
<h2 id="pyo3-tracing-subscriberæ–‡æ¡£"><a class="header" href="#pyo3-tracing-subscriberæ–‡æ¡£"><code>pyo3-tracing-subscriber</code>ï¼ˆ<a href="https://docs.rs/pyo3-tracing-subscriber">æ–‡æ¡£</a>ï¼‰</a></h2>
<p><a href="https://crates.io/crates/pyo3-tracing-subscriber"><code>pyo3-tracing-subscriber</code></a> æä¾›äº†ä¸€ç§è®© Python é¡¹ç›®é…ç½® <code>tracing_subscriber</code> çš„æ–¹æ³•ã€‚å®ƒæš´éœ²äº†å‡ ä¸ª <code>tracing_subscriber</code> çš„å±‚ï¼ˆlayerï¼‰ï¼š</p>
<ul>
<li><code>tracing_subscriber::fmt</code>ï¼šå°†äººç±»å¯è¯»çš„è¾“å‡ºå†™å…¥æ–‡ä»¶æˆ– stdout</li>
<li><code>opentelemetry-stdout</code>ï¼šå°† OTLP æ ¼å¼çš„è¾“å‡ºå†™å…¥æ–‡ä»¶æˆ– stdout</li>
<li><code>opentelemetry-otlp</code>ï¼šå°† OTLP æ ¼å¼çš„è¾“å‡ºå‘é€åˆ° OTLP ç«¯ç‚¹</li>
</ul>
<p>æ‰©å±•æ¨¡å—å¿…é¡»è°ƒç”¨ <a href="https://docs.rs/pyo3-tracing-subscriber/*/pyo3_tracing_subscriber/fn.add_submodule.html"><code>pyo3_tracing_subscriber::add_submodule</code></a>ï¼Œä»¥å¯¼å‡ºé…ç½®å’Œåˆå§‹åŒ– <code>tracing</code> æ‰€éœ€çš„ Python ç±»ã€‚</p>
<p>åœ¨ Python ç«¯ï¼Œä½¿ç”¨ <code>Tracing</code> ä¸Šä¸‹æ–‡ç®¡ç†å™¨æ¥åˆå§‹åŒ– tracingï¼Œå¹¶åœ¨ä¸Šä¸‹æ–‡ç®¡ç†å™¨çš„ä»£ç å—ä¸­è¿è¡Œ Rust ä»£ç ã€‚<code>Tracing</code> æ¥æ”¶ä¸€ä¸ª <code>GlobalTracingConfig</code> å®ä¾‹ï¼Œç”¨äºæè¿°è¦ä½¿ç”¨çš„å±‚ã€‚</p>
<p>ç¤ºä¾‹ä»£ç è¯·å‚è§ <a href="https://crates.io/crates/pyo3-tracing-subscriber">crates.io ä¸Šçš„ README</a>ã€‚</p>
<h2 id="pyo3-python-tracing-subscriberæ–‡æ¡£"><a class="header" href="#pyo3-python-tracing-subscriberæ–‡æ¡£"><code>pyo3-python-tracing-subscriber</code>ï¼ˆ<a href="https://docs.rs/pyo3-python-tracing-subscriber">æ–‡æ¡£</a>ï¼‰</a></h2>
<p>åç§°ç›¸ä¼¼çš„ <a href="https://crates.io/crates/pyo3-python-tracing-subscriber"><code>pyo3-python-tracing-subscriber</code></a> åœ¨ Rust ä¸­å®ç°äº†ä¸€ä¸ª shimï¼Œç”¨äºå°† <code>tracing</code> æ•°æ®è½¬å‘åˆ°åœ¨ Python ä¸­å®šä¹‰å¹¶ä¼ å…¥çš„ <code>Layer</code> å®ç°ã€‚</p>
<p>æ‰©å±•æ¨¡å—é›†æˆ <code>pyo3-python-tracing-subscriber</code> çš„æ–¹å¼æœ‰å¾ˆå¤šï¼Œä¸€ä¸ªç®€å•çš„ä¾‹å­å¯èƒ½å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre><code class="language-rust no_run">#[tracing::instrument]
#[pyfunction]
fn fibonacci(index: usize, use_memoized: bool) -&gt; PyResult&lt;usize&gt; {
    // ...
}

#[pyfunction]
pub fn initialize_tracing(py_impl: Bound&lt;'_, PyAny&gt;) {
    tracing_subscriber::registry()
        .with(pyo3_python_tracing_subscriber::PythonCallbackLayerBridge::new(py_impl))
        .init();
}</code></pre>
<p>æ‰©å±•æ¨¡å—å¿…é¡»æä¾›æŸç§æœºåˆ¶ï¼Œå…è®¸ Python ä¼ å…¥ä¸€ä¸ªæˆ–å¤šä¸ªå®ç°äº† [<strong><code>Layer</code> æ¥å£</strong>] çš„ Python å¯¹è±¡ã€‚ç„¶åï¼Œåº”ä½¿ç”¨è¿™äº› Python å¯¹è±¡æ„å»º <a href="https://docs.rs/pyo3-python-tracing-subscriber/*/pyo3_python_tracing_subscriber/struct.PythonCallbackLayerBridge.html"><code>pyo3_python_tracing_subscriber::PythonCallbackLayerBridge</code></a> å®ä¾‹ï¼Œå¹¶å¦‚ä¸Šæ‰€ç¤ºåˆå§‹åŒ– <code>tracing_subscriber</code>ã€‚</p>
<p>Python å¯¹è±¡å®ç°çš„æ˜¯ <code>Layer</code> æ¥å£çš„ä¸€ä¸ªå˜ä½“ï¼š</p>
<ul>
<li><code>on_new_span()</code> å¯ä»¥è¿”å›ä¸€äº›çŠ¶æ€ï¼Œè¯¥çŠ¶æ€å°†è¢«å­˜å‚¨åœ¨ Rust çš„ span ä¸­</li>
<li>å…¶ä»–å›è°ƒä¼šå°†è¯¥çŠ¶æ€ä½œä¸ºé¢å¤–çš„ä½ç½®å‚æ•°ä¼ å…¥</li>
</ul>
<p>ä¸€ä¸ªç®€å•çš„ <code>Layer</code> å®ç°å¯èƒ½å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre><code class="language-python">import rust_extension

class MyPythonLayer:
    def __init__(self):
        pass

    # `on_new_span` å¯ä»¥è¿”å›ä¸€äº›çŠ¶æ€
    def on_new_span(self, span_attrs: str, span_id: str) -&gt; int:
        print(f"[on_new_span]: {span_attrs} | {span_id}")
        return random.randint(1, 1000)

    # `on_new_span` è¿”å›çš„çŠ¶æ€ä¼šä½œä¸ºé¢å¤–å‚æ•°ä¼ å…¥å…¶ä»–æ–¹æ³•
    def on_event(self, event: str, state: int):
        print(f"[on_event]: {event} | {state}")

    def on_close(self, span_id: str, state: int):
        print(f"[on_close]: {span_id} | {state}")

    def on_record(self, span_id: str, values: str, state: int):
        print(f"[on_record]: {span_id} | {values} | {state}")

def main():
    rust_extension.initialize_tracing(MyPythonLayer())
    print("10th fibonacci number: ", rust_extension.fibonacci(10, True))
</code></pre>
<p><code>pyo3-python-tracing-subscriber</code> æä¾›äº† [å®Œæ•´çš„ç¤ºä¾‹]ï¼Œå±•ç¤ºäº†é›†æˆçš„ Rust ç«¯å’Œ Python ç«¯ä»£ç ã€‚</p>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="ä½¿ç”¨-async-å’Œ-await-1"><a class="header" href="#ä½¿ç”¨-async-å’Œ-await-1">ä½¿ç”¨ <code>async</code> å’Œ <code>await</code></a></h1>
<p><em><code>async</code>/<code>await</code> æ”¯æŒç›®å‰æ­£åœ¨é›†æˆåˆ° PyO3 ä¸­ã€‚è¯·å‚é˜… <a href="#ä½¿ç”¨-async-å’Œ-await">ä¸“ç”¨æ–‡æ¡£</a></em></p>
<p>å¦‚æœä½ æ­£åœ¨ä½¿ç”¨çš„ Python åº“ç”¨åˆ°äº†å¼‚æ­¥å‡½æ•°ï¼Œæˆ–å¸Œæœ›ä¸ºä¸€ä¸ªå¼‚æ­¥çš„ Rust åº“æä¾› Python ç»‘å®šï¼Œé‚£ä¹ˆ <a href="https://github.com/PyO3/pyo3-async-runtimes"><code>pyo3-async-runtimes</code></a> å¾ˆå¯èƒ½æä¾›äº†ä½ éœ€è¦çš„å·¥å…·ã€‚å®ƒæ”¯æŒ Python å’Œ Rust ä¹‹é—´å¼‚æ­¥å‡½æ•°çš„ç›¸äº’è½¬æ¢ï¼Œå¹¶åŸç”Ÿæ”¯æŒæµè¡Œçš„ Rust è¿è¡Œæ—¶ï¼Œä¾‹å¦‚ <a href="https://tokio.rs/"><code>tokio</code></a> å’Œ <a href="https://async.rs/"><code>async-std</code></a>ã€‚æ­¤å¤–ï¼Œæ‰€æœ‰å¼‚æ­¥ Python ä»£ç éƒ½è¿è¡Œåœ¨é»˜è®¤çš„ <code>asyncio</code> äº‹ä»¶å¾ªç¯ä¸Šï¼Œå› æ­¤ <code>pyo3-async-runtimes</code> åº”è¯¥èƒ½å¾ˆå¥½åœ°ä¸ç°æœ‰çš„ Python åº“ååŒå·¥ä½œã€‚</p>
<h2 id="é™„åŠ ä¿¡æ¯"><a class="header" href="#é™„åŠ ä¿¡æ¯">é™„åŠ ä¿¡æ¯</a></h2>
<ul>
<li>ä½¿ç”¨ <code>pyo3-async-runtimes</code> æ—¶ï¼Œç®¡ç†äº‹ä»¶å¾ªç¯å¼•ç”¨å¯èƒ½è¾ƒä¸ºå¤æ‚ã€‚è¯·å‚é˜… API æ–‡æ¡£ä¸­çš„ <a href="https://docs.rs/pyo3-async-runtimes/#event-loop-references-and-contextvars">äº‹ä»¶å¾ªç¯å¼•ç”¨</a> éƒ¨åˆ†ï¼Œä»¥æ›´å¥½åœ°ç†è§£è¯¥åº“å¦‚ä½•ç®¡ç†äº‹ä»¶å¾ªç¯å¼•ç”¨ã€‚</li>
<li>ç”±äº Python éœ€è¦æ§åˆ¶ä¸»çº¿ç¨‹ï¼Œæµ‹è¯• <code>pyo3-async-runtimes</code> çš„åº“å’Œåº”ç”¨ç¨‹åºéœ€è¦è‡ªå®šä¹‰çš„æµ‹è¯•ç¯å¢ƒã€‚ä½ å¯ä»¥åœ¨ <a href="https://docs.rs/pyo3-async-runtimes/latest/pyo3_async_runtimes/testing"><code>testing</code> æ¨¡å—çš„ API æ–‡æ¡£</a> ä¸­æ‰¾åˆ°æµ‹è¯•æŒ‡å—ã€‚</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="å¸¸è§é—®é¢˜ä¸æ•…éšœæ’æŸ¥"><a class="header" href="#å¸¸è§é—®é¢˜ä¸æ•…éšœæ’æŸ¥">å¸¸è§é—®é¢˜ä¸æ•…éšœæ’æŸ¥</a></h1>
<p>å¾ˆæŠ±æ­‰æ‚¨åœ¨ä½¿ç”¨ PyO3 æ—¶é‡åˆ°é—®é¢˜ã€‚å¦‚æœæ‚¨æ— æ³•åœ¨ä¸‹æ–¹åˆ—è¡¨ä¸­æ‰¾åˆ°é—®é¢˜çš„è§£å†³æ–¹æ¡ˆï¼Œä¹Ÿå¯ä»¥é€šè¿‡ <a href="https://github.com/PyO3/pyo3/discussions">GitHub Discussions</a> æˆ– <a href="https://discord.gg/33kcChzH7f">Discord</a> å¯»æ±‚å¸®åŠ©ã€‚</p>
<h2 id="åœ¨ä½¿ç”¨-stdsynconcelockstdsynclazylocklazy_static-å’Œ-once_cell-æ—¶å‡ºç°æ­»é”"><a class="header" href="#åœ¨ä½¿ç”¨-stdsynconcelockstdsynclazylocklazy_static-å’Œ-once_cell-æ—¶å‡ºç°æ­»é”">åœ¨ä½¿ç”¨ <code>std::sync::OnceLock</code>ã€<code>std::sync::LazyLock</code>ã€<code>lazy_static</code> å’Œ <code>once_cell</code> æ—¶å‡ºç°æ­»é”</a></h2>
<p><code>OnceLock</code>ã€<code>LazyLock</code> åŠå…¶ç¬¬ä¸‰æ–¹å‰èº«å®ç°æœºåˆ¶ä¾èµ–é˜»å¡æ¥ç¡®ä¿ä»…æœ‰ä¸€ä¸ªçº¿ç¨‹å¯¹å®ƒä»¬è¿›è¡Œåˆå§‹åŒ–ã€‚ç”±äº Python è§£é‡Šå™¨ä¼šå¼•å…¥é¢å¤–çš„é”ï¼ˆPython GIL å’Œ GC éƒ½å¯èƒ½è¦æ±‚æ‰€æœ‰å…¶ä»–çº¿ç¨‹æš‚åœï¼‰ï¼Œè¿™å¯èƒ½å¯¼è‡´ä»¥ä¸‹æ–¹å¼çš„æ­»é”ï¼š</p>
<ol>
<li>ä¸€ä¸ªè¿æ¥åˆ° Python è§£é‡Šå™¨çš„çº¿ç¨‹ï¼ˆçº¿ç¨‹ Aï¼‰å¼€å§‹åˆå§‹åŒ– <code>OnceLock</code> çš„å€¼ã€‚</li>
<li>åˆå§‹åŒ–ä»£ç è°ƒç”¨äº†æŸäº› Python APIï¼Œä¾‹å¦‚ <code>Python::import</code>ï¼Œè¿™ä¼šä¸´æ—¶è„±ç¦»è§£é‡Šå™¨ã€‚</li>
<li>å¦ä¸€ä¸ªçº¿ç¨‹ï¼ˆçº¿ç¨‹ Bï¼‰è¿æ¥åˆ° Python è§£é‡Šå™¨ï¼Œå¹¶å°è¯•è®¿é—®åŒä¸€ä¸ª <code>OnceLock</code> å€¼ã€‚</li>
<li>çº¿ç¨‹ B è¢«é˜»å¡ï¼Œå› ä¸ºå®ƒåœ¨ç­‰å¾… <code>OnceLock</code> çš„åˆå§‹åŒ–é”é‡Šæ”¾ã€‚</li>
<li>åœ¨éè‡ªç”±çº¿ç¨‹æ¨¡å¼çš„ Python ä¸­ï¼Œçº¿ç¨‹ A ç°åœ¨ä¹Ÿè¢«é˜»å¡ï¼Œå› ä¸ºå®ƒéœ€è¦é‡æ–°è¿æ¥åˆ°è§£é‡Šå™¨ï¼ˆè·å–çº¿ç¨‹ B ä»ç„¶æŒæœ‰çš„ GILï¼‰ã€‚</li>
<li>å‘ç”Ÿæ­»é”ã€‚</li>
</ol>
<p>PyO3 æä¾›äº†ä¸€ä¸ªåä¸º <a href="{{#PYO3_DOCS_URL}}/pyo3/sync/struct.PyOnceLock.html"><code>PyOnceLock</code></a> çš„ç»“æ„ä½“ï¼Œå®ƒå®ç°äº†åŸºäºè¿™äº›ç±»å‹çš„å•æ¬¡åˆå§‹åŒ– APIï¼Œå¹¶é¿å…äº†æ­»é”ã€‚æ‚¨è¿˜å¯ä»¥ä½¿ç”¨ <a href="{{#PYO3_DOCS_URL}}/pyo3/sync/trait.OnceExt.html"><code>OnceExt</code></a> å’Œ <a href="{{#PYO3_DOCS_URL}}/pyo3/sync/trait.OnceLockExt.html"><code>OnceLockExt</code></a> æ‰©å±• traitï¼Œå®ƒä»¬ä¸ºæ­¤ç›®çš„æä¾›äº†æ ‡å‡†åº“ç±»å‹çš„æ–°æ–¹æ³•ï¼Œä»è€Œé¿å…ä¸ Python è§£é‡Šå™¨æ­»é”çš„é£é™©ã€‚è¿™æ„å‘³ç€å½“æ‚¨é‡åˆ°ä¸Šè¿°æè¿°çš„æ­»é”é—®é¢˜æ—¶ï¼Œå¯ä»¥ä½¿ç”¨å®ƒä»¬æ¥æ›¿ä»£å…¶ä»–é€‰æ‹©ã€‚æœ‰å…³ <a href="{{#PYO3_DOCS_URL}}/pyo3/sync/struct.PyOnceLock.html"><code>PyOnceLock</code></a> å’Œ <a href="{{#PYO3_DOCS_URL}}/pyo3/sync/trait.OnceExt.html"><code>OnceExt</code></a> çš„æ›´å¤šè¯¦ç»†ä¿¡æ¯å’Œä½¿ç”¨ç¤ºä¾‹ï¼Œè¯·å‚é˜…ç›¸å…³æ–‡æ¡£ã€‚</p>
<h2 id="æ— æ³•è¿è¡Œ-cargo-testæˆ–æ— æ³•åœ¨-cargo-å·¥ä½œåŒºä¸­æ„å»ºå‡ºç°symbol-not-foundæˆ–undefined-reference-to-_pyexc_systemerrorç­‰é“¾æ¥é”™è¯¯"><a class="header" href="#æ— æ³•è¿è¡Œ-cargo-testæˆ–æ— æ³•åœ¨-cargo-å·¥ä½œåŒºä¸­æ„å»ºå‡ºç°symbol-not-foundæˆ–undefined-reference-to-_pyexc_systemerrorç­‰é“¾æ¥é”™è¯¯">æ— æ³•è¿è¡Œ <code>cargo test</code>ï¼›æˆ–æ— æ³•åœ¨ Cargo å·¥ä½œåŒºä¸­æ„å»ºï¼šå‡ºç°â€œSymbol not foundâ€æˆ–â€œUndefined reference to _PyExc_SystemErrorâ€ç­‰é“¾æ¥é”™è¯¯</a></h2>
<p>ç›®å‰ <a href="https://github.com/PyO3/pyo3/issues/340">#340</a> ä¼šå¯¼è‡´åœ¨å¯ç”¨ <code>extension-module</code> åŠŸèƒ½æ—¶ <code>cargo test</code> å› é“¾æ¥é”™è¯¯è€Œå¤±è´¥ã€‚å½“åœ¨ Cargo å·¥ä½œåŒºä¸­æ„å»ºä¸”å¦ä¸€ä¸ª crate ä¹Ÿä½¿ç”¨ PyO3 æ—¶ï¼Œä¹Ÿå¯èƒ½å‡ºç°é“¾æ¥é”™è¯¯ï¼ˆè§ <a href="https://github.com/PyO3/pyo3/issues/2521">#2521</a>ï¼‰ã€‚ç›®å‰ï¼Œæˆ‘ä»¬æœ‰ä¸‰ç§æ–¹æ³•å¯ä»¥ç»•è¿‡è¿™äº›é—®é¢˜ã€‚</p>
<ol>
<li>
<p>å°† <code>extension-module</code> åŠŸèƒ½è®¾ä¸ºå¯é€‰ï¼Œä½¿ç”¨ <code>maturin develop --features "extension-module"</code> æ„å»ºï¼š</p>
<pre><code class="language-toml">[dependencies.pyo3]
{{#PYO3_CRATE_VERSION}}

[features]
extension-module = ["pyo3/extension-module"]
</code></pre>
</li>
<li>
<p>å°† <code>extension-module</code> åŠŸèƒ½è®¾ä¸ºå¯é€‰å¹¶è®¾ä¸ºé»˜è®¤ï¼Œä½¿ç”¨ <code>cargo test --no-default-features</code> è¿è¡Œæµ‹è¯•ï¼š</p>
<pre><code class="language-toml">[dependencies.pyo3]
{{#PYO3_CRATE_VERSION}}

[features]
extension-module = ["pyo3/extension-module"]
default = ["extension-module"]
</code></pre>
</li>
<li>
<p>å¦‚æœæ‚¨æ­£åœ¨ä½¿ç”¨ <a href="https://maturin.rs/metadata.html"><code>pyproject.toml</code></a> æ–‡ä»¶æ§åˆ¶ maturin è®¾ç½®ï¼Œè¯·æ·»åŠ ä»¥ä¸‹éƒ¨åˆ†ï¼š</p>
<pre><code class="language-toml">[tool.maturin]
features = ["pyo3/extension-module"]
# æˆ–è€…å¯¹äº maturin 0.12:
# cargo-extra-args = ["--features", "pyo3/extension-module"]
</code></pre>
</li>
</ol>
<h2 id="æ— æ³•è¿è¡Œ-cargo-testæ— æ³•åœ¨-tests-ç›®å½•ä¸­çš„æµ‹è¯•é‡Œæ‰¾åˆ°æ‚¨çš„-crate"><a class="header" href="#æ— æ³•è¿è¡Œ-cargo-testæ— æ³•åœ¨-tests-ç›®å½•ä¸­çš„æµ‹è¯•é‡Œæ‰¾åˆ°æ‚¨çš„-crate">æ— æ³•è¿è¡Œ <code>cargo test</code>ï¼šæ— æ³•åœ¨ <code>tests/</code> ç›®å½•ä¸­çš„æµ‹è¯•é‡Œæ‰¾åˆ°æ‚¨çš„ crate</a></h2>
<p>Rust ä¹¦ç±å»ºè®®å°†<a href="https://doc.rust-lang.org/book/ch11-03-test-organization.html#integration-tests">é›†æˆæµ‹è¯•æ”¾åœ¨ <code>tests/</code> ç›®å½•ä¸­</a>ã€‚</p>
<p>å¯¹äºä¸€ä¸ª <code>extension-module</code> é¡¹ç›®ï¼Œå¦‚æœæ‚¨çš„ <code>Cargo.toml</code> ä¸­å°† <code>crate-type</code> è®¾ç½®ä¸ºäº† <code>"cdylib"</code>ï¼Œç¼–è¯‘å™¨å°†æ— æ³•æ‰¾åˆ°æ‚¨çš„ crateï¼Œå¹¶æ˜¾ç¤ºå¦‚ <code>E0432</code> æˆ– <code>E0463</code> çš„é”™è¯¯ï¼š</p>
<pre><code class="language-text">error[E0432]: unresolved import `my_crate`
 --&gt; tests/test_my_crate.rs:1:5
  |
1 | use my_crate;
  |     ^^^^^^^^^^^^ no external crate `my_crate`
</code></pre>
<p>æœ€ä½³çš„è§£å†³æ–¹æ¡ˆæ˜¯è®©æ‚¨çš„ crate ç±»å‹åŒæ—¶åŒ…å« <code>rlib</code> å’Œ <code>cdylib</code>ï¼š</p>
<pre><code class="language-toml"># Cargo.toml
[lib]
crate-type = ["cdylib", "rlib"]
</code></pre>
<h2 id="æ‰§è¡Œ-rust-ä»£ç æ—¶-ctrl-c-æ— æ•ˆ"><a class="header" href="#æ‰§è¡Œ-rust-ä»£ç æ—¶-ctrl-c-æ— æ•ˆ">æ‰§è¡Œ Rust ä»£ç æ—¶ Ctrl-C æ— æ•ˆ</a></h2>
<p>è¿™æ˜¯å› ä¸º Ctrl-C ä¼šè§¦å‘ SIGINT ä¿¡å·ï¼Œè¯¥ä¿¡å·ç”±è°ƒç”¨çš„ Python è¿›ç¨‹å¤„ç†ï¼Œä½† Python ä»…è®¾ç½®ä¸€ä¸ªæ ‡å¿—ï¼Œç¨åæ‰ä¼šå¤„ç†ã€‚åœ¨ä» Python è°ƒç”¨çš„ Rust ä»£ç æ‰§è¡ŒæœŸé—´ï¼Œè¯¥æ ‡å¿—ä¸ä¼šè¢«æ£€æŸ¥ï¼Œåªæœ‰å½“æ§åˆ¶æƒè¿”å› Python è§£é‡Šå™¨æ—¶æ‰ä¼šæ£€æŸ¥ã€‚</p>
<p>æ‚¨å¯ä»¥é€šè¿‡è°ƒç”¨ <code>Python::check_signals</code> ç»™ Python è§£é‡Šå™¨æœºä¼šæ­£ç¡®å¤„ç†è¯¥ä¿¡å·ã€‚å¦‚æœæ‚¨æœ‰ä¸€ä¸ªé•¿æ—¶é—´è¿è¡Œçš„ Rust å‡½æ•°ï¼Œå»ºè®®å®šæœŸè°ƒç”¨æ­¤å‡½æ•°ï¼Œä»¥ä¾¿ç”¨æˆ·èƒ½å¤Ÿå–æ¶ˆæ‰§è¡Œã€‚</p>
<h2 id="pyo3get-å…‹éš†äº†æˆ‘çš„å­—æ®µ"><a class="header" href="#pyo3get-å…‹éš†äº†æˆ‘çš„å­—æ®µ"><code>#[pyo3(get)]</code> å…‹éš†äº†æˆ‘çš„å­—æ®µ</a></h2>
<p>æ‚¨å¯èƒ½æœ‰ä¸€ä¸ªç±»ä¼¼ä¸‹é¢çš„åµŒå¥—ç»“æ„ä½“ï¼š</p>
<pre><code class="language-rust no_run"><span class="boring">use pyo3::prelude::*;
</span>#[pyclass]
#[derive(Clone)]
struct Inner {/* å­—æ®µçœç•¥ */}

#[pyclass]
struct Outer {
    #[pyo3(get)]
    inner: Inner,
}

#[pymethods]
impl Outer {
    #[new]
    fn __new__() -&gt; Self {
        Self { inner: Inner {} }
    }
}</code></pre>
<p>å½“ Python ä»£ç è®¿é—® <code>Outer</code> çš„å­—æ®µæ—¶ï¼ŒPyO3 æ¯æ¬¡è®¿é—®éƒ½ä¼šè¿”å›ä¸€ä¸ªæ–°å¯¹è±¡ï¼ˆæ³¨æ„å®ƒä»¬çš„åœ°å€ä¸åŒï¼‰ï¼š</p>
<pre><code class="language-python">outer = Outer()

a = outer.inner
b = outer.inner

assert a is b, f"a: {a}\nb: {b}"
</code></pre>
<pre><code class="language-text">AssertionError: a: &lt;builtins.Inner object at 0x00000238FFB9C7B0&gt;
b: &lt;builtins.Inner object at 0x00000238FFB9C830&gt;
</code></pre>
<p>å¦‚æœè¯¥å­—æ®µæ˜¯å¯å˜çš„ï¼Œè¿™å¯èƒ½ä¼šç‰¹åˆ«ä»¤äººå›°æƒ‘ï¼Œå› ä¸ºè·å–å­—æ®µå¹¶ä¿®æ”¹å®ƒä¸ä¼šæŒä¹…åŒ–â€”â€”ä¸‹ä¸€æ¬¡è®¿é—®ä¼šå¾—åˆ°åŸå§‹å¯¹è±¡çš„å…¨æ–°å…‹éš†ã€‚é—æ†¾çš„æ˜¯ï¼ŒPython å’Œ Rust åœ¨æ‰€æœ‰æƒä¸Šå¹¶ä¸ä¸€è‡´â€”â€”å¦‚æœ PyO3 å‘ Python ä»£ç æä¾›å¯¹ï¼ˆå¯èƒ½ä¸´æ—¶çš„ï¼‰Rust å¯¹è±¡çš„å¼•ç”¨ï¼ŒPython ä»£ç å°±å¯èƒ½æ— é™æœŸåœ°ä¿ç•™è¯¥å¼•ç”¨ã€‚å› æ­¤è¿”å› Rust å¯¹è±¡éœ€è¦å…‹éš†ã€‚</p>
<p>å¦‚æœæ‚¨ä¸å¸Œæœ›å‘ç”Ÿå…‹éš†ï¼Œä¸€ç§è§£å†³æ–¹æ³•æ˜¯å°†å­—æ®µåˆ†é…åœ¨ Python å †ä¸Šå¹¶å­˜å‚¨å¯¹è¯¥å¯¹è±¡çš„å¼•ç”¨ï¼Œä½¿ç”¨ <a href="{{#PYO3_DOCS_URL}}/pyo3/struct.Py.html"><code>Py&lt;...&gt;</code></a>ï¼š</p>
<pre><code class="language-rust no_run"><span class="boring">use pyo3::prelude::*;
</span>#[pyclass]
struct Inner {/* å­—æ®µçœç•¥ */}

#[pyclass]
struct Outer {
    inner: Py&lt;Inner&gt;,
}

#[pymethods]
impl Outer {
    #[new]
    fn __new__(py: Python&lt;'_&gt;) -&gt; PyResult&lt;Self&gt; {
        Ok(Self {
            inner: Py::new(py, Inner {})?,
        })
    }

    #[getter]
    fn inner(&amp;self, py: Python&lt;'_&gt;) -&gt; Py&lt;Inner&gt; {
        self.inner.clone_ref(py)
    }
}</code></pre>
<p>è¿™æ¬¡ <code>a</code> å’Œ <code>b</code> <em>ç¡®å®æ˜¯åŒä¸€ä¸ªå¯¹è±¡</em>ï¼š</p>
<pre><code class="language-python">outer = Outer()

a = outer.inner
b = outer.inner

assert a is b, f"a: {a}\nb: {b}"
print(f"a: {a}\nb: {b}")
</code></pre>
<pre><code class="language-text">a: &lt;builtins.Inner object at 0x0000020044FCC670&gt;
b: &lt;builtins.Inner object at 0x0000020044FCC670&gt;
</code></pre>
<p>è¿™ç§æ–¹æ³•çš„ç¼ºç‚¹æ˜¯ï¼Œä»»ä½•å¯¹ <code>Outer</code> ç»“æ„ä½“è¿›è¡Œæ“ä½œçš„ Rust ä»£ç éƒ½å¯èƒ½éœ€è¦è¿æ¥åˆ° Python è§£é‡Šå™¨æ‰èƒ½å¤„ç† <code>inner</code> å­—æ®µã€‚ï¼ˆå¦‚æœ <code>Inner</code> å¸¦æœ‰ <code>#[pyclass(frozen)]</code> ä¸”å®ç°äº† <code>Sync</code>ï¼Œåˆ™å¯ä»¥ä½¿ç”¨ <code>Py::get</code> ä» <code>Py&lt;Inner&gt;</code> è®¿é—® <code>Inner</code> å†…å®¹è€Œæ— éœ€è¿æ¥è§£é‡Šå™¨ã€‚ï¼‰</p>
<h2 id="æˆ‘æƒ³ä½¿ç”¨ä»ä¾èµ–é¡¹é‡æ–°å¯¼å‡ºçš„-pyo3-crateä½†è¿‡ç¨‹å®å¤±è´¥"><a class="header" href="#æˆ‘æƒ³ä½¿ç”¨ä»ä¾èµ–é¡¹é‡æ–°å¯¼å‡ºçš„-pyo3-crateä½†è¿‡ç¨‹å®å¤±è´¥">æˆ‘æƒ³ä½¿ç”¨ä»ä¾èµ–é¡¹é‡æ–°å¯¼å‡ºçš„ <code>pyo3</code> crateï¼Œä½†è¿‡ç¨‹å®å¤±è´¥</a></h2>
<p>æ‰€æœ‰ PyO3 è¿‡ç¨‹å®ï¼ˆ<code>#[pyclass]</code>ã€<code>#[pyfunction]</code>ã€<code>#[derive(FromPyObject)]</code> ç­‰ï¼‰éƒ½æœŸæœ›åœ¨ crate æ ¹ä¸‹èƒ½ä»¥ <code>pyo3</code> è¿™ä¸ªåç§°è®¿é—®åˆ° <code>pyo3</code> crateï¼Œè¿™åœ¨ <code>pyo3</code> æ˜¯æ‚¨ crate çš„ç›´æ¥ä¾èµ–æ—¶æ˜¯æ­£å¸¸çš„ã€‚</p>
<p>ç„¶è€Œï¼Œå½“ä¾èµ–é¡¹è¢«é‡å‘½åï¼Œæˆ–æ‚¨çš„ crate ä»…é—´æ¥ä¾èµ–äº <code>pyo3</code> æ—¶ï¼Œæ‚¨éœ€è¦è®©å®ä»£ç çŸ¥é“è¯¥åœ¨å“ªé‡ŒæŸ¥æ‰¾è¿™ä¸ª crateã€‚è¿™æ˜¯é€šè¿‡ <code>crate</code> å±æ€§å®Œæˆçš„ï¼š</p>
<pre><code class="language-rust no_run"><span class="boring">use pyo3::prelude::*;
</span><span class="boring">pub extern crate pyo3;
</span><span class="boring">mod reexported { pub use ::pyo3; }
</span><span class="boring">#[allow(dead_code)]
</span>#[pyclass]
#[pyo3(crate = "reexported::pyo3")]
struct MyClass;</code></pre>
<h2 id="æˆ‘è¯•å›¾ä»-rust-è°ƒç”¨-pythonä½†å¾—åˆ°äº†-status_dll_not_found-æˆ–-status_entrypoint_not_found"><a class="header" href="#æˆ‘è¯•å›¾ä»-rust-è°ƒç”¨-pythonä½†å¾—åˆ°äº†-status_dll_not_found-æˆ–-status_entrypoint_not_found">æˆ‘è¯•å›¾ä» Rust è°ƒç”¨ Pythonï¼Œä½†å¾—åˆ°äº† <code>STATUS_DLL_NOT_FOUND</code> æˆ– <code>STATUS_ENTRYPOINT_NOT_FOUND</code></a></h2>
<p>è¿™åœ¨ Windows ä¸Šå‘ç”Ÿï¼ŒåŸå› æ˜¯é“¾æ¥ Python DLL å¤±è´¥æˆ–é“¾æ¥äº†é”™è¯¯çš„ DLLã€‚Windows ä¸Šçš„ Python DLL é€šå¸¸å‘½åä¸ºï¼š</p>
<ul>
<li><code>python3X.dll</code> å¯¹äº Python 3.Xï¼Œä¾‹å¦‚ Python 3.10 å¯¹åº” <code>python310.dll</code></li>
<li>ä½¿ç”¨ PyO3 çš„ <code>abi3</code> åŠŸèƒ½æ—¶ä¸º <code>python3.dll</code></li>
</ul>
<p>å¿…é¡»èƒ½å¤Ÿæ ¹æ® <a href="https://learn.microsoft.com/en-us/windows/win32/dlls/dynamic-link-library-search-order#standard-search-order-for-unpackaged-apps">Windows DLL æœç´¢é¡ºåº</a> æ‰¾åˆ°è¯¥ DLLã€‚å®ç°æ­¤ç›®çš„çš„ä¸€äº›æ–¹æ³•åŒ…æ‹¬ï¼š</p>
<ul>
<li>å°† Python DLL æ”¾åœ¨æ„å»ºäº§ç‰©çš„åŒä¸€æ–‡ä»¶å¤¹ä¸­</li>
<li>å°†åŒ…å« Python DLL çš„ç›®å½•æ·»åŠ åˆ° <code>PATH</code> ç¯å¢ƒå˜é‡ä¸­ï¼Œä¾‹å¦‚ <code>C:\Users\&lt;You&gt;\AppData\Local\Programs\Python\Python310</code></li>
<li>å¦‚æœæ­¤é—®é¢˜å‡ºç°åœ¨æ‚¨<em>åˆ†å‘</em>ç¨‹åºæ—¶ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨ <a href="https://github.com/indygreg/PyOxidizer">PyOxidizer</a> å°†å…¶ä¸äºŒè¿›åˆ¶æ–‡ä»¶æ‰“åŒ…åœ¨ä¸€èµ·</li>
</ul>
<p>å¦‚æœé“¾æ¥äº†é”™è¯¯çš„ DLLï¼Œå¯èƒ½æ˜¯å› ä¸ºå¦ä¸€ä¸ªç¨‹åºå°†è‡ªå·±åŠå…¶ Python DLL æ·»åŠ åˆ°äº† <code>PATH</code>ã€‚è¯·è°ƒæ•´ <code>PATH</code> å˜é‡é¡ºåºï¼Œä½¿æ­£ç¡®çš„ DLL ä¼˜å…ˆã€‚</p>
<blockquote>
<p><strong>æ³¨æ„</strong>ï¼šå¯¹ <code>PATH</code>ï¼ˆæˆ–ä»»ä½•å…¶ä»–ç¯å¢ƒå˜é‡ï¼‰çš„æ›´æ”¹åœ¨ç°æœ‰ shell ä¸­ä¸å¯è§ã€‚è¯·é‡å¯ shell ä»¥ä½¿æ›´æ”¹ç”Ÿæ•ˆã€‚</p>
</blockquote>
<p>å¯¹äºé«˜çº§æ•…éšœæ’æŸ¥ï¼Œå¯ä»¥ä½¿ç”¨ <a href="https://www.dependencywalker.com/">Dependency Walker</a> æ¥è¯Šæ–­é“¾æ¥é”™è¯¯ã€‚</p>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="ä»æ—§ç‰ˆæœ¬-pyo3-è¿ç§»"><a class="header" href="#ä»æ—§ç‰ˆæœ¬-pyo3-è¿ç§»">ä»æ—§ç‰ˆæœ¬ PyO3 è¿ç§»</a></h1>
<p>æœ¬æŒ‡å—å¯å¸®åŠ©æ‚¨å°†ä»£ç ä»ä¸€ä¸ª PyO3 ç‰ˆæœ¬å‡çº§åˆ°ä¸‹ä¸€ä¸ªç‰ˆæœ¬ï¼Œä»¥åº”å¯¹ç ´åæ€§å˜æ›´ã€‚<br>å…³äºæ‰€æœ‰å˜æ›´çš„è¯¦ç»†åˆ—è¡¨ï¼Œè¯·å‚é˜… <a href="#æ›´æ–°æ—¥å¿—">å˜æ›´æ—¥å¿—</a>ã€‚</p>
<h2 id="ä»-026-åˆ°-027"><a class="header" href="#ä»-026-åˆ°-027">ä» 0.26.* åˆ° 0.27</a></h2>
<h3 id="frompyobject-é‡æ„ä»¥æå‡çµæ´»æ€§å’Œæ•ˆç‡"><a class="header" href="#frompyobject-é‡æ„ä»¥æå‡çµæ´»æ€§å’Œæ•ˆç‡"><code>FromPyObject</code> é‡æ„ä»¥æå‡çµæ´»æ€§å’Œæ•ˆç‡</a></h3>
<details open="">
<summary><small>ç‚¹å‡»å±•å¼€</small></summary>
<p>éšç€ PyO3 0.23 ä¸­ç§»é™¤äº† <code>gil-ref</code> APIï¼Œç°åœ¨å¯ä»¥å®Œå…¨åˆ†ç¦» Python ç”Ÿå‘½å‘¨æœŸ <code>'py</code> å’Œè¾“å…¥ç”Ÿå‘½å‘¨æœŸ <code>'a</code>ã€‚è¿™å…è®¸ä»è¾“å…¥æ•°æ®ä¸­å€Ÿç”¨ï¼Œè€Œä¸ä¼šå°†ç”Ÿå‘½å‘¨æœŸå»¶é•¿è‡³ä¸è§£é‡Šå™¨ç»‘å®šã€‚</p>
<p><code>FromPyObject</code> ç°åœ¨æ¥å—ä¸€ä¸ªé¢å¤–çš„ç”Ÿå‘½å‘¨æœŸå‚æ•° <code>'a</code>ï¼Œç”¨äºæè¿°è¾“å…¥æ•°æ®çš„ç”Ÿå‘½å‘¨æœŸã€‚<code>extract</code> æ–¹æ³•çš„å‚æ•°ç±»å‹ä» <code>&amp;Bound&lt;'py, PyAny&gt;</code> å˜æ›´ä¸º <code>Borrowed&lt;'a, 'py, PyAny&gt;</code>ã€‚è¿™æ˜¯å› ä¸º <code>&amp;'a Bound&lt;'py, PyAny&gt;</code> ä¼šç”±äºå¼•ç”¨ç±»å‹å¯¼è‡´éšå¼çº¦æŸ <code>'py: 'a</code>ã€‚</p>
<p>è¿™ç§æ–°å½¢å¼æ—©åœ¨ 0.22 ç‰ˆæœ¬ä¸­å°±å·²é€šè¿‡å†…éƒ¨çš„ <code>FromPyObjectBound</code> trait éƒ¨åˆ†å®ç°ï¼Œç°åœ¨å·²æ‰©å±•è‡³æ‰€æœ‰ç±»å‹ã€‚</p>
<p>å¤§å¤šæ•°å®ç°åªéœ€æ·»åŠ ä¸€ä¸ªçœç•¥çš„ç”Ÿå‘½å‘¨æœŸå³å¯å®Œæˆè¿ç§»ã€‚</p>
<p>æ­¤å¤–ï¼Œ<code>FromPyObject</code> æ–°å¢äº†ä¸€ä¸ªå…³è”ç±»å‹ <code>Error</code>ï¼Œç”¨äºè¡¨ç¤ºè½¬æ¢å¤±è´¥æ—¶çš„é”™è¯¯ç±»å‹ã€‚åœ¨è¿ç§»è¿‡ç¨‹ä¸­ä½¿ç”¨ <code>PyErr</code> æ˜¯ä¸€ä¸ªä¸é”™çš„é»˜è®¤é€‰æ‹©ï¼Œåç»­å¯å¼•å…¥è‡ªå®šä¹‰é”™è¯¯ç±»å‹ä»¥é¿å…ä¸å¿…è¦çš„ Python å¼‚å¸¸å¯¹è±¡åˆ›å»ºï¼Œå¹¶æå‡ç±»å‹å®‰å…¨æ€§ã€‚</p>
<p>è¿ç§»å‰ï¼š</p>
<pre><code class="language-rust ignore">impl&lt;'py&gt; FromPyObject&lt;'py&gt; for IpAddr {
    fn extract_bound(obj: &amp;Bound&lt;'py, PyAny&gt;) -&gt; PyResult&lt;Self&gt; {
        ...
    }
}</code></pre>
<p>è¿ç§»åï¼š</p>
<pre><code class="language-rust ignore">impl&lt;'py&gt; FromPyObject&lt;'_, 'py&gt; for IpAddr {
    type Error = PyErr;

    fn extract(obj: Borrowed&lt;'_, 'py, PyAny&gt;) -&gt; Result&lt;Self, Self::Error&gt; {
        ...
        // ç”±äº `Borrowed` å®ç°äº† `Deref` åˆ° `&amp;Bound`ï¼Œå‡½æ•°ä½“é€šå¸¸æ— éœ€ä¿®æ”¹ï¼Œ
        // æˆ–ä»…éœ€å¶å°”æ·»åŠ  `&amp;`
    }
}</code></pre>
<p>åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œå¯èƒ½éœ€è¦æ›´å¤šæ­¥éª¤ã€‚å¯¹äºæ³›å‹ç±»å‹ï¼Œéœ€è¦è°ƒæ•´çº¦æŸæ¡ä»¶ï¼Œå…·ä½“çº¦æŸå–å†³äºç±»å‹çš„ä½¿ç”¨æ–¹å¼ã€‚</p>
<p>å¯¹äºç®€å•çš„åŒ…è£…ç±»å‹ï¼Œé€šå¸¸å¯ä»¥ç›´æ¥è½¬å‘çº¦æŸã€‚</p>
<p>è¿ç§»å‰ï¼š</p>
<pre><code class="language-rust ignore">struct MyWrapper&lt;T&gt;(T);

impl&lt;'py, T&gt; FromPyObject&lt;'py&gt; for MyWrapper&lt;T&gt;
where
    T: FromPyObject&lt;'py&gt;
{
    fn extract_bound(obj: &amp;Bound&lt;'py, PyAny&gt;) -&gt; PyResult&lt;Self&gt; {
        ob.extract().map(MyWrapper)
    }
}</code></pre>
<p>è¿ç§»åï¼š</p>
<pre><code class="language-rust"><span class="boring">use pyo3::prelude::*;
</span><span class="boring">#[allow(dead_code)]
</span><span class="boring">pub struct MyWrapper&lt;T&gt;(T);
</span>impl&lt;'a, 'py, T&gt; FromPyObject&lt;'a, 'py&gt; for MyWrapper&lt;T&gt;
where
    T: FromPyObject&lt;'a, 'py&gt;
{
    type Error = T::Error;

    fn extract(obj: Borrowed&lt;'a, 'py, PyAny&gt;) -&gt; Result&lt;Self, Self::Error&gt; {
        obj.extract().map(MyWrapper)
    }
}</code></pre>
<p>å¯¹äºåœ¨æå–è¿‡ç¨‹ä¸­éœ€è¦åˆ›å»ºä¸´æ—¶ Python å¼•ç”¨çš„å®¹å™¨ç±»å‹ï¼ˆä¾‹å¦‚ä» <code>PyList</code> æå–ï¼‰ï¼Œéœ€è¦æ›´å¼ºçš„çº¦æŸã€‚ä¸ºæ­¤å¼•å…¥äº† <code>FromPyObjectOwned</code> traitã€‚å¯¹äºä»»ä½•å®ç°äº† <code>FromPyObject</code> ä¸”æœªä»è¾“å…¥å€Ÿç”¨çš„ç±»å‹ï¼Œéƒ½ä¼šè‡ªåŠ¨å®ç°è¯¥ traitã€‚å»ºè®®åœ¨è¿™äº›åœºæ™¯ä¸‹å°†å…¶ç”¨ä½œ trait boundã€‚</p>
<p>è¿ç§»å‰ï¼š</p>
<pre><code class="language-rust ignore">struct MyVec&lt;T&gt;(Vec&lt;T&gt;);
impl&lt;'py, T&gt; FromPyObject&lt;'py&gt; for Vec&lt;T&gt;
where
    T: FromPyObject&lt;'py&gt;,
{
    fn extract_bound(obj: &amp;Bound&lt;'py, PyAny&gt;) -&gt; PyResult&lt;Self&gt; {
        let mut v = MyVec(Vec::new());
        for item in obj.try_iter()? {
            v.0.push(item?.extract::&lt;T&gt;()?);
        }
        Ok(v)
    }
}</code></pre>
<p>è¿ç§»åï¼š</p>
<pre><code class="language-rust"><span class="boring">use pyo3::prelude::*;
</span><span class="boring">#[allow(dead_code)]
</span><span class="boring">pub struct MyVec&lt;T&gt;(Vec&lt;T&gt;);
</span>impl&lt;'py, T&gt; FromPyObject&lt;'_, 'py&gt; for MyVec&lt;T&gt;
where
    T: FromPyObjectOwned&lt;'py&gt; // ğŸ‘ˆ åªèƒ½æå–æ‹¥æœ‰æ‰€æœ‰æƒçš„å€¼ï¼Œå› ä¸ºä¸‹é¢æ¯ä¸ª `item`
                              //    éƒ½æ˜¯ä¸´æ—¶çš„ã€ç”Ÿå‘½å‘¨æœŸçŸ­æš‚çš„æ‹¥æœ‰æƒå¼•ç”¨
{
    type Error = PyErr;

    fn extract(obj: Borrowed&lt;'_, 'py, PyAny&gt;) -&gt; Result&lt;Self, Self::Error&gt; {
        let mut v = MyVec(Vec::new());
        for item in obj.try_iter()? {
            v.0.push(item?.extract::&lt;T&gt;().map_err(Into::into)?); // éœ€è¦ `map_err`ï¼Œå› ä¸º `?` ä½¿ç”¨ `From` è€Œé `Into` ğŸ™
        }
        Ok(v)
    }
}</code></pre>
<p>è¿™ä¸ <code>serde</code> çš„ <a href="https://docs.rs/serde/latest/serde/trait.Deserialize.html"><code>Deserialize</code></a> å’Œ <a href="https://docs.rs/serde/latest/serde/de/trait.DeserializeOwned.html"><code>DeserializeOwned</code></a> trait éå¸¸ç›¸ä¼¼ï¼Œè¯¦è§ <a href="https://serde.rs/lifetimes.html">æ­¤å¤„</a>ã€‚</p>
</details>
<h2 id="downcast-å’Œ-downcasterror-æ›¿æ¢ä¸º-cast-å’Œ-casterror"><a class="header" href="#downcast-å’Œ-downcasterror-æ›¿æ¢ä¸º-cast-å’Œ-casterror"><code>.downcast()</code> å’Œ <code>DowncastError</code> æ›¿æ¢ä¸º <code>.cast()</code> å’Œ <code>CastError</code></a></h2>
<p><code>.downcast()</code> ç³»åˆ—å‡½æ•°åŸæœ¬ä»…åœ¨ <code>Bound&lt;PyAny&gt;</code> ä¸Šå¯ç”¨ã€‚åœ¨æŸäº›è¾¹ç¼˜æƒ…å†µï¼ˆç‰¹åˆ«æ˜¯ä¸ <code>.downcast_into()</code> ç›¸å…³ï¼‰ä¸‹ï¼Œè¿™éœ€è¦ä½¿ç”¨ <code>.as_any().downcast()</code> æˆ– <code>.into_any().downcast_into()</code> é“¾å¼è°ƒç”¨ã€‚æ­¤å¤–ï¼Œ<code>DowncastError</code> ç”Ÿæˆçš„ Python å¼‚å¸¸æ¶ˆæ¯ç”±äºä½¿ç”¨äº† Rust ç±»å‹åç§°è€Œä¸å¤Ÿâ€œPythonicâ€ã€‚</p>
<p><code>.cast()</code> ç³»åˆ—å‡½æ•°ç°åœ¨å¯åœ¨æ‰€æœ‰ <code>Bound</code> å’Œ <code>Borrowed</code> æ™ºèƒ½æŒ‡é’ˆä¸Šä½¿ç”¨ï¼ˆæ— è®ºå…¶ç±»å‹ï¼‰ï¼Œå¹¶ä¸”å…¶é”™è¯¯æ¶ˆæ¯åœ¨è¿è¡Œæ—¶ç”±å®é™…ç±»å‹åŠ¨æ€ç”Ÿæˆã€‚è¿™ä¸º PyO3 æ¨¡å—çš„ä½œè€…å’Œä½¿ç”¨è€…å¸¦æ¥äº†æ›´å‹å¥½çš„ä½“éªŒã€‚</p>
<p>è¿ç§»æ–¹æ³•ï¼šå°† <code>.downcast()</code> æ›¿æ¢ä¸º <code>.cast()</code>ï¼Œå°† <code>DowncastError</code> æ›¿æ¢ä¸º <code>CastError</code>ï¼ˆç±»ä¼¼åœ°ï¼Œ<code>.downcast_into()</code> æ›¿æ¢ä¸º <code>.cast_into()</code>ï¼Œ<code>DowncastIntoError</code> æ›¿æ¢ä¸º <code>CastIntoError</code> ç­‰ï¼‰ã€‚</p>
<p><code>CastError</code> éœ€è¦ä¸€ä¸ª Python <code>type</code> å¯¹è±¡ï¼ˆæˆ–å…¶ä»–ä¸ <code>isinstance()</code> å…¼å®¹çš„â€œç±»ä¿¡æ¯â€å¯¹è±¡ï¼‰ä½œä¸ºç¬¬äºŒä¸ªå‚æ•°ï¼Œå› æ­¤åœ¨æå°‘æ•°æ‰‹åŠ¨æ„é€  <code>DowncastError</code> çš„æƒ…å†µä¸‹ï¼Œä»£ç å¯èƒ½éœ€è¦å°‘é‡è°ƒæ•´ã€‚</p>
<h2 id="pytypecheck-ç°åœ¨æ˜¯ä¸€ä¸ª-unsafe-trait"><a class="header" href="#pytypecheck-ç°åœ¨æ˜¯ä¸€ä¸ª-unsafe-trait"><code>PyTypeCheck</code> ç°åœ¨æ˜¯ä¸€ä¸ª <code>unsafe trait</code></a></h2>
<p>ç”±äº <code>PyTypeCheck</code> æ˜¯ç”¨äºä¿æŠ¤ <code>.cast()</code> å‡½æ•°ä»¥å°† Python å¯¹è±¡è§†ä¸ºç‰¹å®šå…·ä½“ç±»å‹çš„ traitï¼Œå› æ­¤å…¶å®ç°æ˜¯ <code>unsafe</code> çš„ã€‚</p>
<p>è¿™æœ¬åº”ä»ä¸€å¼€å§‹å°±æ˜¯è¿™æ ·ï¼Œæ­¤å‰åœ¨åˆå§‹å®ç°ä¸­é—æ¼äº†è¿™ä¸€ç‚¹ï¼Œæ­¤æ¬¡å‘å¸ƒä¸­å·²äºˆä»¥çº æ­£ã€‚</p>
<h2 id="ä»-025-åˆ°-026"><a class="header" href="#ä»-025-åˆ°-026">ä» 0.25.* åˆ° 0.26</a></h2>
<h3 id="é‡å‘½å-pythonwith_gilpythonallow_threads-å’Œ-pyo3prepare_freethreaded_python"><a class="header" href="#é‡å‘½å-pythonwith_gilpythonallow_threads-å’Œ-pyo3prepare_freethreaded_python">é‡å‘½å <code>Python::with_gil</code>ã€<code>Python::allow_threads</code> å’Œ <code>pyo3::prepare_freethreaded_python</code></a></h3>
<details open="">
<summary><small>ç‚¹å‡»å±•å¼€</small></summary>
<p>è¿™äº› API çš„åç§°æ˜¯åœ¨å…¨å±€è§£é‡Šå™¨é”ï¼ˆGILï¼‰å¼ºåˆ¶å¯ç”¨çš„èƒŒæ™¯ä¸‹åˆ›å»ºçš„ã€‚éšç€ Python 3.13 ä¸­è‡ªç”±çº¿ç¨‹çš„å¼•å…¥ï¼Œè¿™ç§æƒ…å†µå·²ä¸å¤å­˜åœ¨ï¼Œè¿™äº›å‘½åä¸å†å…·æœ‰æ™®éæ„ä¹‰ã€‚<br>å› æ­¤ï¼Œæˆ‘ä»¬é€‰æ‹©å°†å…¶é‡å‘½åä¸ºè‡ªç”±çº¿ç¨‹å¼•å…¥çš„æ›´ç°ä»£æœ¯è¯­ï¼š</p>
<ul>
<li><code>Python::with_gil</code> ç°åœ¨ç§°ä¸º <code>Python::attach</code>ï¼Œå®ƒå°† Python çº¿ç¨‹çŠ¶æ€é™„åŠ åˆ°å½“å‰çº¿ç¨‹ã€‚åœ¨å¯ç”¨ GIL çš„æ„å»ºä¸­ï¼Œåªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½é™„åŠ åˆ°è§£é‡Šå™¨ï¼›åœ¨è‡ªç”±çº¿ç¨‹æ¨¡å¼ä¸‹å¯ä»¥æœ‰å¤šä¸ªã€‚</li>
<li><code>Python::allow_threads</code> ç°åœ¨ç§°ä¸º <code>Python::detach</code>ï¼Œå®ƒåˆ†ç¦»ä¹‹å‰é™„åŠ çš„çº¿ç¨‹çŠ¶æ€ã€‚</li>
<li><code>pyo3::prepare_freethreaded_python</code> ç°åœ¨ç§°ä¸º <code>Python::initialize</code>ã€‚</li>
</ul>
</details>
<h3 id="å¼ƒç”¨-pyobject-ç±»å‹åˆ«å"><a class="header" href="#å¼ƒç”¨-pyobject-ç±»å‹åˆ«å">å¼ƒç”¨ <code>PyObject</code> ç±»å‹åˆ«å</a></h3>
<details open="">
<summary><small>ç‚¹å‡»å±•å¼€</small></summary>
<p>ç±»å‹åˆ«å <code>PyObject</code>ï¼ˆå³ <code>Py&lt;PyAny&gt;</code>ï¼‰ç»å¸¸ä¸åŒåçš„ FFI å®šä¹‰ <code>pyo3::ffi::PyObject</code> æ··æ·†ã€‚å› æ­¤æˆ‘ä»¬å†³å®šå¼ƒç”¨å…¶ä½¿ç”¨ã€‚è¿ç§»æ—¶åªéœ€å°†å…¶æ›¿æ¢ä¸ºç›®æ ‡ç±»å‹ <code>Py&lt;PyAny&gt;</code> å³å¯ã€‚</p>
</details>
<h3 id="ä½¿ç”¨-pyoncelock-æ›¿ä»£-giloncecell"><a class="header" href="#ä½¿ç”¨-pyoncelock-æ›¿ä»£-giloncecell">ä½¿ç”¨ <code>PyOnceLock</code> æ›¿ä»£ <code>GILOnceCell</code></a></h3>
<details open="">
<summary><small>ç‚¹å‡»å±•å¼€</small></summary>
<p>ç±»ä¼¼äºä¸Šè¿°å¯¹ <code>Python::with_gil</code> åŠç›¸å…³ API çš„é‡å‘½åï¼Œ<code>GILOnceCell</code> ç±»å‹æœ€åˆæ˜¯ä¸ºå— GIL é™åˆ¶çš„ Python è§£é‡Šå™¨è®¾è®¡çš„ã€‚é™¤åç§°å¤–ï¼Œå®ƒå…è®¸â€œä¸€æ¬¡æ€§â€åˆå§‹åŒ–å‘ç”Ÿç«äº‰ï¼Œå› ä¸ºè¿™ç§ç«äº‰ç”± GIL åè°ƒï¼Œåœ¨å®é™…ä¸­æä¸å¯èƒ½å‡ºç°é—®é¢˜ã€‚</p>
<p>éšç€è‡ªç”±çº¿ç¨‹ Python çš„å¼•å…¥ï¼Œç«äº‰æ€§åˆå§‹åŒ–è¡Œä¸ºæ›´æœ‰å¯èƒ½å¼•å‘é—®é¢˜ã€‚å› æ­¤å¼•å…¥äº†æ–°çš„ç±»å‹ <code>PyOnceLock</code>ï¼Œå®ƒèƒ½åœ¨æ­£ç¡®é™„åŠ åˆ° Python è§£é‡Šå™¨çš„åŒæ—¶ï¼Œç¡®ä¿çœŸæ­£çš„å•æ¬¡åˆå§‹åŒ–ã€‚å®ƒæš´éœ²çš„ API ä¸ <code>GILOnceCell</code> ç›¸åŒï¼Œå› æ­¤é€šå¸¸æ˜¯ç›´æ¥æ›¿æ¢ã€‚ä½†å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœæ­¤å‰æ„å¤–ä¾èµ–äº† <code>GILOnceCell</code> çš„ç«äº‰åˆå§‹åŒ–è¡Œä¸ºï¼ˆä¾‹å¦‚ç”±äºå¾ªç¯å¼•ç”¨ï¼‰ï¼Œé‚£ä¹ˆ <code>PyOnceLock</code> æ›´å¼ºçš„â€œä»…ä¸€æ¬¡â€ä¿è¯å¯èƒ½å¯¼è‡´æ­»é”ï¼Œéœ€è¦é‡æ„ä»£ç ã€‚</p>
<p>è¿ç§»å‰ï¼š</p>
<pre><code class="language-rust"><span class="boring">#![allow(deprecated)]
</span><span class="boring">use pyo3::prelude::*;
</span><span class="boring">use pyo3::sync::GILOnceCell;
</span><span class="boring">use pyo3::types::PyType;
</span><span class="boring">fn main() -&gt; PyResult&lt;()&gt; {
</span><span class="boring">Python::attach(|py| {
</span>static DECIMAL_TYPE: GILOnceCell&lt;Py&lt;PyType&gt;&gt; = GILOnceCell::new();
DECIMAL_TYPE.import(py, "decimal", "Decimal")?;
<span class="boring">Ok(())
</span><span class="boring">})
</span><span class="boring">}</span></code></pre>
<p>è¿ç§»åï¼š</p>
<pre><code class="language-rust"><span class="boring">use pyo3::prelude::*;
</span><span class="boring">use pyo3::sync::PyOnceLock;
</span><span class="boring">use pyo3::types::PyType;
</span><span class="boring">fn main() -&gt; PyResult&lt;()&gt; {
</span><span class="boring">Python::attach(|py| {
</span>static DECIMAL_TYPE: PyOnceLock&lt;Py&lt;PyType&gt;&gt; = PyOnceLock::new();
DECIMAL_TYPE.import(py, "decimal", "Decimal")?;
<span class="boring">Ok(())
</span><span class="boring">})
</span><span class="boring">}</span></code></pre>
</details>
<h3 id="å¼ƒç”¨-gilprotected"><a class="header" href="#å¼ƒç”¨-gilprotected">å¼ƒç”¨ <code>GILProtected</code></a></h3>
<details open="">
<summary><small>ç‚¹å‡»å±•å¼€</small></summary>
<p>ä½œä¸ºä¸ GIL é™åˆ¶çš„ Python è®¾è®¡çš„å¹¶å‘åŸè¯­ç›¸å…³çš„å¦ä¸€é¡¹æ¸…ç†å·¥ä½œï¼Œ<code>GILProtected</code> ç±»å‹ç°å·²è¢«å¼ƒç”¨ã€‚å»ºè®®ä½¿ç”¨ä¸è‡ªç”±çº¿ç¨‹ Python å…¼å®¹çš„å¹¶å‘åŸè¯­ï¼Œå¦‚ <a href="https://doc.rust-lang.org/std/sync/struct.Mutex.html"><code>std::sync::Mutex</code></a>ï¼ˆç»“åˆ PyO3 çš„ <a href="{{#PYO3_DOCS_URL}}/pyo3/sync/trait.MutexExt.html"><code>MutexExt</code></a> traitï¼‰ã€‚</p>
<p>è¿ç§»å‰ï¼š</p>
<pre><code class="language-rust"><span class="boring">#![allow(deprecated)]
</span><span class="boring">use pyo3::prelude::*;
</span><span class="boring">fn main() {
</span><span class="boring">#[cfg(not(Py_GIL_DISABLED))] {
</span>use pyo3::sync::GILProtected;
use std::cell::RefCell;
<span class="boring">Python::attach(|py| {
</span>static NUMBERS: GILProtected&lt;RefCell&lt;Vec&lt;i32&gt;&gt;&gt; = GILProtected::new(RefCell::new(Vec::new()));
Python::attach(|py| {
    NUMBERS.get(py).borrow_mut().push(42);
});
<span class="boring">})
</span><span class="boring">}
</span><span class="boring">}</span></code></pre>
<p>è¿ç§»åï¼š</p>
<pre><code class="language-rust"><span class="boring">use pyo3::prelude::*;
</span>use pyo3::sync::MutexExt;
use std::sync::Mutex;
<span class="boring">fn main() {
</span><span class="boring">Python::attach(|py| {
</span>static NUMBERS: Mutex&lt;Vec&lt;i32&gt;&gt; = Mutex::new(Vec::new());
Python::attach(|py| {
    NUMBERS.lock_py_attached(py).expect("no poisoning").push(42);
});
<span class="boring">})
</span><span class="boring">}
</span>```&lt;/details&gt;

## `PyMemoryError` ç°åœ¨åœ¨è½¬æ¢ä¸º `io::Error` æ—¶æ˜ å°„åˆ° `io::ErrorKind::OutOfMemory`

&lt;details&gt;
&lt;summary&gt;&lt;small&gt;ç‚¹å‡»å±•å¼€&lt;/small&gt;&lt;/summary&gt;

æ­¤å‰ï¼Œå°† `PyMemoryError` è½¬æ¢ä¸º Rust çš„ `io::Error` æ—¶ï¼Œé”™è¯¯ç±»å‹ï¼ˆkindï¼‰ä¸º `Other`ã€‚ç°åœ¨ï¼Œå®ƒä¼šç”Ÿæˆç±»å‹ä¸º `OutOfMemory` çš„é”™è¯¯ã€‚  
ç±»ä¼¼åœ°ï¼Œå°†ç±»å‹ä¸º `OutOfMemory` çš„ `io::Error` è½¬æ¢å› Python é”™è¯¯æ—¶ï¼Œæ­¤å‰ä¼šå¾—åˆ°ä¸€ä¸ªé€šç”¨çš„ `PyOSError`ï¼Œè€Œç°åœ¨åˆ™ä¼šå¾—åˆ° `PyMemoryError`ã€‚

è¿™ä¸€æ›´æ”¹ä½¿é”™è¯¯è½¬æ¢æ›´åŠ ç²¾ç¡®ï¼Œå¹¶åœ¨ Python å’Œ Rust ä¹‹é—´ç»Ÿä¸€äº†å†…å­˜è€—å°½é”™è¯¯çš„è¯­ä¹‰ã€‚
&lt;/details&gt;

# ä» 0.24.* å‡çº§åˆ° 0.25

## `AsPyPointer` çš„ç§»é™¤

&lt;details&gt;
&lt;summary&gt;&lt;small&gt;ç‚¹å‡»å±•å¼€&lt;/small&gt;&lt;/summary&gt;

`AsPyPointer` trait ä¸»è¦æ˜¯å·²è¢«ç§»é™¤çš„ gil-refs API çš„é—ç•™äº§ç‰©ã€‚æœ€åå‰©ä½™çš„ç”¨é€”æ˜¯ GC APIï¼ˆå³ `PyVisit::call`ï¼‰ä»¥åŠå¯¹è±¡èº«ä»½æ¯”è¾ƒï¼ˆ`PyAnyMethods::is` å’Œ `Py::is`ï¼‰ã€‚

`PyVisit::call` å·²æ›´æ–°ä¸ºæ¥å— `T: Into&lt;Option&lt;&amp;Py&lt;T&gt;&gt;&gt;`ï¼Œè¿™ä½¿å¾—å¯ä»¥ä¼ å…¥ç±»å‹ä¸º `&amp;Py&lt;T&gt;`ã€`&amp;Option&lt;Py&lt;T&gt;&gt;` æˆ– `Option&lt;&amp;Py&lt;T&gt;&gt;` çš„å‚æ•°ã€‚è¿ç§»æ—¶é€šå¸¸æ— éœ€ä¿®æ”¹ä»£ç ã€‚

`PyAnyMethods::is` / `Py::is` å·²æ›´æ–°ä¸ºæ¥å— `T: AsRef&lt;Py&lt;PyAny&gt;&gt;`ã€‚æ­¤å¤–ï¼Œè¿˜ä¸º `Py`ã€`Bound` å’Œ `Borrowed` æ·»åŠ äº† `AsRef&lt;Py&lt;PyAny&gt;&gt;` çš„å®ç°ã€‚ç”±äºå·²å­˜åœ¨ `AsRef&lt;Bound&lt;PyAny&gt;&gt; for Bound&lt;T&gt;` çš„å®ç°ï¼Œè¿™å¯èƒ½ä¼šåœ¨éæ³›å‹ä»£ç ä¸­å¼•èµ·ç±»å‹æ¨æ–­é—®é¢˜ã€‚å¯ä»¥é€šè¿‡å°†è¿™äº›è°ƒç”¨ä¸­çš„ `as_ref` æ›¿æ¢ä¸º `as_any` æ¥è½»æ¾å®Œæˆè¿ç§»ã€‚
&lt;/details&gt;

# ä» 0.23.* å‡çº§åˆ° 0.24

&lt;details&gt;
&lt;summary&gt;&lt;small&gt;ç‚¹å‡»å±•å¼€&lt;/small&gt;&lt;/summary&gt;

ä» 0.23 åˆ° 0.24 æ²¡æœ‰éœ€è¦åœ¨æ­¤æŒ‡å—ä¸­ç‰¹åˆ«è®°å½•çš„é‡å¤§å˜æ›´ã€‚
&lt;/details&gt;

# ä» 0.22.* å‡çº§åˆ° 0.23

&lt;details&gt;
&lt;summary&gt;&lt;small&gt;ç‚¹å‡»å±•å¼€&lt;/small&gt;&lt;/summary&gt;

PyO3 0.23 å¯¹å†…éƒ¨å®ç°è¿›è¡Œäº†é‡å¤§é‡æ„ï¼Œå¸¦æ¥ä¸¤ä¸ªä¸»è¦æ”¹è¿›ï¼š

- æ”¯æŒ Python 3.13 çš„æ–°è‡ªç”±çº¿ç¨‹æ„å»ºç‰ˆæœ¬ï¼ˆåˆç§° "3.13t"ï¼‰
- ä½¿ç”¨æ–°çš„ `IntoPyObject` trait é‡æ„åˆ° Python çš„ç±»å‹è½¬æ¢

è¿™ä¸¤é¡¹å˜æ›´éƒ½è¾ƒä¸ºé‡è¦ï¼Œæˆ‘ä»¬å·²å°½åŠ›ç¡®ä¿å°½å¯èƒ½å¤šçš„ç°æœ‰ä»£ç æ— éœ€ä¿®æ”¹å³å¯ç»§ç»­è¿è¡Œã€‚å‡çº§æ—¶å¯èƒ½åœ¨ä»¥ä¸‹ä¸‰ä¸ªæ–¹é¢æ„Ÿå—åˆ°å½±å“ï¼š

- PyO3 çš„æ•°æ®ç»“æ„ [ç°åœ¨æ˜¯çº¿ç¨‹å®‰å…¨çš„](#free-threaded-python-support)ï¼Œä¸å†ä¾èµ– GIL è¿›è¡ŒåŒæ­¥ã€‚ç‰¹åˆ«æ˜¯ï¼Œ`#[pyclass]` ç±»å‹ [ç°åœ¨å¿…é¡»å®ç° `Sync`](./class/thread-safety.md)ã€‚
- æ‚¨ä»£ç åº“ä¸­çš„æŸäº›ç±»å‹å¯èƒ½éœ€è¦å®ç° [`IntoPyObject` trait](#new-intopyobject-trait-unifies-to-python-conversions)ã€‚å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ [`#[derive(IntoPyObject)]`](#intopyobject-and-intopyobjectref-derive-macros) å®ã€‚ç”±äº `IntoPy` å’Œ `ToPyObject` trait è¢«æ›¿æ¢ï¼Œä¼šè§¦å‘å¤§é‡å¼ƒç”¨è­¦å‘Šã€‚
- [æœ€ç»ˆç§»é™¤äº† `gil-refs` åŠŸèƒ½](#gil-refs-feature-removed) ä¹Ÿä¼šå¯¼è‡´å¤§é‡å¼ƒç”¨è­¦å‘Šï¼Œä½†è¿™ä¸º PyO3 çš„ "Bound" API æ¸…ç†å’Œç®€åŒ–è…¾å‡ºäº†ç©ºé—´ã€‚

ä¸‹æ–‡å°†æ›´æ·±å…¥åœ°è®¨è®ºæ¯é¡¹å˜æ›´çš„åŸç†å’Œç»†èŠ‚ã€‚
&lt;/details&gt;

## è‡ªç”±çº¿ç¨‹ Python æ”¯æŒ

&lt;details&gt;
&lt;summary&gt;&lt;small&gt;ç‚¹å‡»å±•å¼€&lt;/small&gt;&lt;/summary&gt;

PyO3 0.23 å¼•å…¥äº†å¯¹ CPython 3.13 æ–°çš„è‡ªç”±çº¿ç¨‹æ„å»ºç‰ˆæœ¬ï¼ˆåˆç§° "3.13t"ï¼‰çš„åˆæ­¥æ”¯æŒã€‚

ç”±äºè¯¥æ„å»ºå…è®¸å¤šä¸ª Python çº¿ç¨‹åŒæ—¶æ“ä½œåº•å±‚ Rust æ•°æ®ï¼Œ`#[pyclass]` å®ç°åœ¨è¦æ±‚å…¶ä½œç”¨çš„ç±»å‹å®ç° `Sync`ã€‚

é™¤äº† `#[pyclass]` çš„è¿™ä¸€å˜æ›´å¤–ï¼ŒPyO3 çš„å¤§å¤šæ•°åŠŸèƒ½ä»ä¿æŒä¸å˜ï¼Œå› ä¸ºå˜æ›´ä¸»è¦é›†ä¸­åœ¨ä½¿å†…éƒ¨æ•°æ®ç»“æ„çº¿ç¨‹å®‰å…¨ã€‚ä¾‹å¦‚ `GILOnceCell` ç±»å‹ï¼Œè¿‡å»ä¾èµ– GIL æ¥ä¿è¯å•æ¬¡åˆå§‹åŒ–çš„åŒæ­¥æ€§ï¼Œç°åœ¨æ”¹ç”¨å†…éƒ¨é”æ¥ç¡®ä¿ä»…ä¸€æ¬¡å†™å…¥æˆåŠŸï¼Œä½†å®ƒå…è®¸åˆå§‹åŒ–é—­åŒ…çš„å¤šæ¬¡ç«äº‰æ‰§è¡Œã€‚æ›´æ¨èçš„åšæ³•æ˜¯ä½¿ç”¨ `std::sync::OnceLock` æ­é… `pyo3::sync::OnceLockExt` traitï¼Œè¯¥ trait æä¾›äº† `OnceLock::get_or_init_py_attached`ï¼Œå¯ä¿è¯åˆå§‹åŒ–é—­åŒ…åªæ‰§è¡Œä¸€æ¬¡ä¸”ä¸ä¼šä¸ GIL æ­»é”ã€‚

æœªæ¥ç‰ˆæœ¬çš„ PyO3 å¾ˆå¯èƒ½ä¼šæ·»åŠ æ›´å¤š trait å’Œæ•°æ®ç»“æ„ï¼Œä»¥ç®€åŒ–è‡ªç”±çº¿ç¨‹ Python çš„ä½¿ç”¨ã€‚

ä»¥ä¸‹åŠŸèƒ½åœ¨è‡ªç”±çº¿ç¨‹æ„å»ºä¸­ä¸å¯ç”¨ï¼š

- `GILProtected` ç±»å‹ï¼Œå®ƒä¾èµ– GIL æ¥å®ç°å†…éƒ¨å†…å®¹çš„åŒæ­¥è®¿é—®
- `PyList::get_item_unchecked`ï¼Œç”±äºæ£€æŸ¥æ—¶ä¸ä½¿ç”¨æ—¶ä¹‹é—´å­˜åœ¨ç«äº‰ï¼Œæ— æ³•å®‰å…¨ä½¿ç”¨

å¦‚æœæ‚¨çš„ä»£ç ä½¿ç”¨äº†è¿™äº›åŠŸèƒ½ï¼Œåˆ™éœ€è¦å¤„ç†å®ƒä»¬åœ¨è‡ªç”±çº¿ç¨‹æ„å»ºä¸‹çš„ä¸å¯ç”¨æ€§ã€‚ä¸€ç§æ–¹æ³•æ˜¯é€šè¿‡æ¡ä»¶ç¼–è¯‘â€”â€”æ‰©å±•å¯ä»¥ä½¿ç”¨ `pyo3-build-config` æ¥è·å– `#[cfg(Py_GIL_DISABLED)]` å®ˆæŠ¤æ¡ä»¶ã€‚

è¯¦æƒ…è¯·å‚è§[å…³äºè‡ªç”±çº¿ç¨‹ Python çš„æŒ‡å—ç« èŠ‚](free-threading.md)ï¼Œäº†è§£å¦‚ä½•åœ¨æ‚¨çš„ PyO3 æ‰©å±•ä¸­æ”¯æŒè‡ªç”±çº¿ç¨‹ Pythonã€‚
&lt;/details&gt;

## æ–°çš„ `IntoPyObject` trait ç»Ÿä¸€äº†åˆ° Python çš„è½¬æ¢

&lt;details&gt;
&lt;summary&gt;&lt;small&gt;ç‚¹å‡»å±•å¼€&lt;/small&gt;&lt;/summary&gt;

PyO3 0.23 å¼•å…¥äº†ä¸€ä¸ªæ–°çš„ `IntoPyObject` traitï¼Œç”¨äºå°† Rust ç±»å‹è½¬æ¢ä¸º Python å¯¹è±¡ï¼Œå–ä»£äº†åŸæœ‰çš„ `IntoPy` å’Œ `ToPyObject` traitã€‚è¯¥æ–° trait çš„ä¸»è¦ç‰¹æ€§åŒ…æ‹¬ï¼š

- è½¬æ¢ç°åœ¨å¯ä»¥è¿”å›é”™è¯¯
- å®ƒè¢«è®¾è®¡ä¸ºå¯¹ `T`ï¼ˆå€¼ç±»å‹ï¼‰å’Œ `&amp;T`ï¼ˆå¼•ç”¨ç±»å‹ï¼‰éƒ½èƒ½é«˜æ•ˆå·¥ä½œ
- ç›¸æ¯” `IntoPy&lt;T&gt;`ï¼Œæ³›å‹ `T` è¢«ç§»è‡³å…³è”ç±»å‹ï¼Œå› æ­¤ï¼š
  - ç°åœ¨è½¬æ¢æŸä¸ªç±»å‹åªæœ‰ä¸€ç§æ–¹å¼
  - è¾“å‡ºç±»å‹æ›´ç²¾ç¡®ï¼Œå¯è¿”å›ä»»æ„ Python ç±»å‹è€Œä¸ä»…é™äº `PyAny`
- å­—èŠ‚é›†åˆç°åœ¨ä¸“é—¨è½¬æ¢ä¸º `PyBytes`ï¼Œè¯¦è§[ä¸‹æ–‡](#to-python-conversions-changed-for-byte-collections-vecu8-u8-n-and-smallvecu8-n)
- `()`ï¼ˆå•å…ƒç±»å‹ï¼‰ç°åœ¨ä»…åœ¨ `#[pyfunction]` å’Œ `#[pymethods]` çš„è¿”å›ä½ç½®è¢«ç‰¹åŒ–ä¸ºè¿”å› `None`ï¼›åœ¨æ™®é€šä½¿ç”¨ä¸­ï¼Œå®ƒä¼šè½¬æ¢ä¸ºä¸€ä¸ªç©ºçš„ `PyTuple`

æ‰€æœ‰ PyO3 å†…ç½®ç±»å‹ä»¥åŠ `#[pyclass]` ç±»å‹éƒ½å·²å®ç°äº† `IntoPyObject`ã€‚å…¶ä»–ç±»å‹éœ€è¦é€‚é… `IntoPyObject` çš„å®ç°ï¼Œä»¥ä¿æŒä¸ Python API çš„å…¼å®¹æ€§ã€‚åœ¨è®¸å¤šæƒ…å†µä¸‹ï¼Œå¯ä»¥ä½¿ç”¨æ–°çš„ [`#[derive(IntoPyObject)]`](#intopyobject-and-intopyobjectref-derive-macros) å®ä»£æ›¿[æ‰‹åŠ¨å®ç°](#intopyobject-manual-implementation)ã€‚

ç”±äº `IntoPyObject::into_pyobject` å¯èƒ½è¿”å› `Bound` æˆ– `Borrowed`ï¼Œæ‚¨å¯èƒ½ä¼šå‘ç° [`BoundObject`](conversions/traits.md#boundobject-for-conversions-that-may-be-bound-or-borrowed) trait æœ‰åŠ©äºç¼–å†™èƒ½é€šç”¨å¤„ç†è¿™ä¸¤ç§æ™ºèƒ½æŒ‡é’ˆçš„ä»£ç ã€‚

éšç€ `IntoPyObject` çš„å¼•å…¥ï¼Œæ—§çš„è½¬æ¢ trait `ToPyObject` å’Œ `IntoPy` å·²è¢«å¼ƒç”¨ï¼Œå°†åœ¨æœªæ¥çš„ PyO3 ç‰ˆæœ¬ä¸­ç§»é™¤ã€‚

### `IntoPyObject` å’Œ `IntoPyObjectRef` æ´¾ç”Ÿå®

è¦å®ç°è¯¥æ–° traitï¼Œå¯ä½¿ç”¨å¦‚ä¸‹æ–°çš„ `IntoPyObject` å’Œ `IntoPyObjectRef` æ´¾ç”Ÿå®ï¼š

```rust,no_run
<span class="boring">use pyo3::prelude::*;
</span>#[derive(IntoPyObject, IntoPyObjectRef)]
struct Struct {
    count: usize,
    obj: Py&lt;PyAny&gt;,
}</code></pre>
<p><code>IntoPyObjectRef</code> æ´¾ç”Ÿå®ä¸ºå¼•ç”¨ç±»å‹ï¼ˆå¦‚ä¸Šä¾‹ä¸­çš„ <code>&amp;Struct</code>ï¼‰ç”Ÿæˆå®ç°ï¼Œä»¥æ›¿ä»£ <code>ToPyObject</code> traitã€‚</p>
<h4 id="intopyobject-æ‰‹åŠ¨å®ç°"><a class="header" href="#intopyobject-æ‰‹åŠ¨å®ç°"><code>IntoPyObject</code> æ‰‹åŠ¨å®ç°</a></h4>
<p>æ­¤å‰ï¼š</p>
<pre><code class="language-rust ignore"><span class="boring">use pyo3::prelude::*;
</span><span class="boring">#[allow(dead_code)]
</span>struct MyPyObjectWrapper(PyObject);

impl IntoPy&lt;PyObject&gt; for MyPyObjectWrapper {
    fn into_py(self, py: Python&lt;'_&gt;) -&gt; PyObject {
        self.0
    }
}

impl ToPyObject for MyPyObjectWrapper {
    fn to_object(&amp;self, py: Python&lt;'_&gt;) -&gt; PyObject {
        self.0.clone_ref(py)
    }
}</code></pre>
<p>ä¹‹åï¼š</p>
<pre><code class="language-rust no_run"><span class="boring">#![allow(deprecated)]
</span><span class="boring">use pyo3::prelude::*;
</span><span class="boring">#[allow(dead_code)]
</span><span class="boring">struct MyPyObjectWrapper(PyObject);
</span>
impl&lt;'py&gt; IntoPyObject&lt;'py&gt; for MyPyObjectWrapper {
    type Target = PyAny; // Python ç±»å‹
    type Output = Bound&lt;'py, Self::Target&gt;; // å¤šæ•°æƒ…å†µä¸‹ä¸º `Bound`
    type Error = std::convert::Infallible;

    fn into_pyobject(self, py: Python&lt;'py&gt;) -&gt; Result&lt;Self::Output, Self::Error&gt; {
        Ok(self.0.into_bound(py))
    }
}

// `ToPyObject` çš„å®ç°åº”è½¬æ¢ä¸ºå¼•ç”¨ç±»å‹çš„å®ç°
impl&lt;'a, 'py&gt; IntoPyObject&lt;'py&gt; for &amp;'a MyPyObjectWrapper {
    type Target = PyAny;
    type Output = Borrowed&lt;'a, 'py, Self::Target&gt;; // `Borrowed` å¯ç”¨äºä¼˜åŒ–å¼•ç”¨è®¡æ•°
    type Error = std::convert::Infallible;

    fn into_pyobject(self, py: Python&lt;'py&gt;) -&gt; Result&lt;Self::Output, Self::Error&gt; {
        Ok(self.0.bind_borrowed(py))
    }
}</code></pre>
</details>
<h3 id="å­—èŠ‚é›†åˆçš„åˆ°-python-è½¬æ¢å˜æ›´vecu8u8-n-å’Œ-smallvecu8-n"><a class="header" href="#å­—èŠ‚é›†åˆçš„åˆ°-python-è½¬æ¢å˜æ›´vecu8u8-n-å’Œ-smallvecu8-n">å­—èŠ‚é›†åˆçš„åˆ° Python è½¬æ¢å˜æ›´ï¼ˆ<code>Vec&lt;u8&gt;</code>ã€<code>[u8; N]</code> å’Œ <code>SmallVec&lt;[u8; N]&gt;</code>ï¼‰</a></h3>
<details>
<summary><small>ç‚¹å‡»å±•å¼€</small></summary>
<p>éšç€ <code>IntoPyObject</code> trait çš„å¼•å…¥ï¼ŒPyO3 çš„å®åœ¨ç”Ÿæˆ Python å€¼æ—¶ç°åœ¨ä¼˜å…ˆä½¿ç”¨ <code>IntoPyObject</code> å®ç°ï¼Œè€Œé <code>IntoPy&lt;PyObject&gt;</code>ã€‚è¿™é€‚ç”¨äº <code>#[pyfunction]</code> å’Œ <code>#[pymethods]</code> çš„è¿”å›å€¼ï¼Œä»¥åŠé€šè¿‡ <code>#[pyo3(get)]</code> è®¿é—®çš„å­—æ®µã€‚</p>
<p>è¿™ä¸€å˜æ›´å½±å“è¿”å›ä»¥ä¸‹_å­—èŠ‚_é›†åˆçš„å‡½æ•°å’Œæ–¹æ³•ï¼š</p>
<ul>
<li><code>Vec&lt;u8&gt;</code></li>
<li><code>[u8; N]</code></li>
<li><code>SmallVec&lt;[u8; N]&gt;</code></li>
</ul>
<p>åœ¨æ–°çš„ <code>IntoPyObject</code> å®ç°ä¸­ï¼Œå®ƒä»¬ç°åœ¨å°†è½¬æ¢ä¸º <code>PyBytes</code> è€Œé <code>PyList</code>ã€‚æ‰€æœ‰å…¶ä»– <code>T</code> ç±»å‹ä¸å—å½±å“ï¼Œä»è½¬æ¢ä¸º <code>PyList</code>ã€‚</p>
<pre><code class="language-rust no_run"><span class="boring">#![allow(dead_code)]
</span><span class="boring">use pyo3::prelude::*;
</span>#[pyfunction]
fn foo() -&gt; Vec&lt;u8&gt; { // æ­¤å‰è½¬æ¢ä¸º `PyList`ï¼Œç°åœ¨è½¬æ¢ä¸º `PyBytes`
    vec![0, 1, 2, 3]
}

#[pyfunction]
fn bar() -&gt; Vec&lt;u16&gt; { // ä¸å—å½±å“ï¼Œè¿”å› `PyList`
    vec![0, 1, 2, 3]
}</code></pre>
<p>å¦‚æœä¸éœ€è¦æ­¤è½¬æ¢è¡Œä¸ºï¼Œå¯è€ƒè™‘ä½¿ç”¨ <code>PyList::new</code> æ‰‹åŠ¨æ„é€ åˆ—è¡¨ã€‚</p>
<p>ä»¥ä¸‹ç±»å‹æ­¤å‰ä»…å¯¹ <code>u8</code> å®ç°ï¼Œç°åœ¨å…è®¸å…¶ä»– <code>T</code> è½¬æ¢ä¸º <code>PyList</code>ï¼š</p>
<ul>
<li><code>&amp;[T]</code></li>
<li><code>Cow&lt;[T]&gt;</code></li>
</ul>
</details>è¿™çº¯ç²¹æ˜¯é¢å¤–çš„ï¼Œä»…ç”¨äºæ‰©å±•å¯èƒ½çš„è¿”å›ç±»å‹ã€‚

<h3 id="ç§»é™¤-gil-refs-åŠŸèƒ½"><a class="header" href="#ç§»é™¤-gil-refs-åŠŸèƒ½">ç§»é™¤ <code>gil-refs</code> åŠŸèƒ½</a></h3>
<details>
<summary><small>ç‚¹å‡»å±•å¼€</small></summary>
<p>PyO3 0.23 å®Œæˆäº†å¯¹â€œGIL Refsâ€API çš„ç§»é™¤ï¼Œè½¬è€Œä½¿ç”¨åœ¨ PyO3 0.21 ä¸­å¼•å…¥çš„æ–°çš„â€œBoundâ€APIã€‚</p>
<p>éšç€æ—§ API çš„ç§»é™¤ï¼Œè®¸å¤šä¹‹å‰å¸¦æœ‰ <code>_bound</code> åç¼€å¼•å…¥çš„â€œBoundâ€API æ–¹æ³•ä¸å†éœ€è¦è¿™äº›åç¼€ï¼Œå› ä¸ºè¿™äº›åç§°å·²è¢«é‡Šæ”¾ã€‚ä¾‹å¦‚ï¼Œ<code>PyTuple::new_bound</code> ç°åœ¨ä»…ä¸º <code>PyTuple::new</code>ï¼ˆç°æœ‰åç§°ä»ç„¶ä¿ç•™ä½†å·²å¼ƒç”¨ï¼‰ã€‚</p>
<p>ä¹‹å‰ï¼š</p>
<pre><code class="language-rust ignore"><span class="boring">#![allow(deprecated)]
</span><span class="boring">use pyo3::prelude::*;
</span><span class="boring">use pyo3::types::PyTuple;
</span><span class="boring">fn main() {
</span><span class="boring">Python::attach(|py| {
</span>// ä¾‹å¦‚ï¼ŒPyTupleã€‚è®¸å¤šæ­¤ç±» API å·²æ›´æ”¹ã€‚
let tup = PyTuple::new_bound(py, [1, 2, 3]);
<span class="boring">})
</span><span class="boring">}</span></code></pre>
<p>ä¹‹åï¼š</p>
<pre><code class="language-rust"><span class="boring">use pyo3::prelude::*;
</span><span class="boring">use pyo3::types::PyTuple;
</span><span class="boring">fn main() {
</span><span class="boring">Python::attach(|py| {
</span>// ä¾‹å¦‚ï¼ŒPyTupleã€‚è®¸å¤šæ­¤ç±» API å·²æ›´æ”¹ã€‚
let tup = PyTuple::new(py, [1, 2, 3]);
<span class="boring">})
</span><span class="boring">}</span></code></pre>
<h4 id="intopydict-trait-è°ƒæ•´ä»¥ç§»é™¤-gil-refs"><a class="header" href="#intopydict-trait-è°ƒæ•´ä»¥ç§»é™¤-gil-refs"><code>IntoPyDict</code> trait è°ƒæ•´ä»¥ç§»é™¤ <code>gil-refs</code></a></h4>
<p>ä½œä¸ºæ­¤ API ç®€åŒ–çš„ä¸€éƒ¨åˆ†ï¼Œ<code>IntoPyDict</code> trait ç»å†äº†ä¸€ä¸ªå°çš„ç ´åæ€§å˜æ›´ï¼š<code>IntoPyDict::into_py_dict_bound</code> æ–¹æ³•å·²é‡å‘½åä¸º <code>IntoPyDict::into_py_dict</code>ã€‚åŒæ—¶ï¼Œå®ƒç°åœ¨ä¹Ÿæ˜¯å¯å¤±è´¥çš„ï¼Œè¿™æ˜¯ <code>IntoPyObject</code> trait æ·»åŠ å¸¦æ¥çš„å˜åŒ–ã€‚</p>
<p>å¦‚æœä½ æ›¾ä¸ºä½ è‡ªå·±çš„ç±»å‹å®ç° <code>IntoPyDict</code>ï¼Œä½ åº”è¯¥å®ç° <code>into_py_dict</code> è€Œä¸æ˜¯ <code>into_py_dict_bound</code>ã€‚æ—§åç§°ä»ç„¶å¯ä»¥è°ƒç”¨ä½†å·²å¼ƒç”¨ã€‚</p>
<p>ä¹‹å‰ï¼š</p>
<pre><code class="language-rust ignore"><span class="boring">use pyo3::prelude::*;
</span><span class="boring">use pyo3::types::{PyDict, IntoPyDict};
</span><span class="boring">use std::collections::HashMap;
</span>

struct MyMap&lt;K, V&gt;(HashMap&lt;K, V&gt;);


impl&lt;K, V&gt; IntoPyDict for MyMap&lt;K, V&gt;
where
    K: ToPyObject,
    V: ToPyObject,
{
    fn into_py_dict_bound(self, py: Python&lt;'_&gt;) -&gt; Bound&lt;'_, PyDict&gt; {
        let dict = PyDict::new_bound(py);
        for (key, value) in self.0 {
            dict.set_item(key, value)
                .expect("Failed to set_item on dict");
        }
        dict
    }
}</code></pre>
<p>ä¹‹åï¼š</p>
<pre><code class="language-rust no_run"><span class="boring">use pyo3::prelude::*;
</span><span class="boring">use pyo3::types::{PyDict, IntoPyDict};
</span><span class="boring">use std::collections::HashMap;
</span>

<span class="boring">#[allow(dead_code)]
</span>struct MyMap&lt;K, V&gt;(HashMap&lt;K, V&gt;);


impl&lt;'py, K, V&gt; IntoPyDict&lt;'py&gt; for MyMap&lt;K, V&gt;
where
    K: IntoPyObject&lt;'py&gt;,
    V: IntoPyObject&lt;'py&gt;,
{
    fn into_py_dict(self, py: Python&lt;'py&gt;) -&gt; PyResult&lt;Bound&lt;'py, PyDict&gt;&gt; {
        let dict = PyDict::new(py);
        for (key, value) in self.0 {
            dict.set_item(key, value)?;
        }
        Ok(dict)
    }
}</code></pre>
</details>
<h2 id="ä»-021-å‡çº§åˆ°-022"><a class="header" href="#ä»-021-å‡çº§åˆ°-022">ä» 0.21.* å‡çº§åˆ° 0.22</a></h2>
<h3 id="ç»§ç»­å¼ƒç”¨-gil-refs-åŠŸèƒ½"><a class="header" href="#ç»§ç»­å¼ƒç”¨-gil-refs-åŠŸèƒ½">ç»§ç»­å¼ƒç”¨ <code>gil-refs</code> åŠŸèƒ½</a></h3>
<details>
<summary><small>ç‚¹å‡»å±•å¼€</small></summary>
<p>ç»§ PyO3 0.21 å¼•å…¥â€œBoundâ€API å¹¶è®¡åˆ’ç§»é™¤â€œGIL Refsâ€API ä¹‹åï¼Œæ‰€æœ‰ä¸ GIL Refs ç›¸å…³çš„åŠŸèƒ½ç°åœ¨éƒ½è¢«é™åˆ¶åœ¨ <code>gil-refs</code> åŠŸèƒ½ä¸‹ï¼Œå¹¶åœ¨ä½¿ç”¨æ—¶å‘å‡ºå¼ƒç”¨è­¦å‘Šã€‚</p>
<p>è¯·å‚é˜… <a href="#from-021-to-022">0.21 è¿ç§»æ¡ç›®</a> è·å–å‡çº§å¸®åŠ©ã€‚</p>
</details>
<h3 id="å¼ƒç”¨å°¾éƒ¨å¯é€‰å‚æ•°çš„éšå¼é»˜è®¤å€¼"><a class="header" href="#å¼ƒç”¨å°¾éƒ¨å¯é€‰å‚æ•°çš„éšå¼é»˜è®¤å€¼">å¼ƒç”¨å°¾éƒ¨å¯é€‰å‚æ•°çš„éšå¼é»˜è®¤å€¼</a></h3>
<details>
<summary><small>ç‚¹å‡»å±•å¼€</small></summary>
<p>ä» <code>pyo3</code> 0.22 å¼€å§‹ï¼Œå°¾éƒ¨ <code>Option&lt;T&gt;</code> ç±»å‹å‚æ•°çš„éšå¼ <code>None</code> é»˜è®¤å€¼å·²è¢«å¼ƒç”¨ã€‚è¿ç§»æ—¶ï¼Œè¯·åœ¨å—å½±å“çš„å‡½æ•°æˆ–æ–¹æ³•ä¸Šæ·»åŠ  <code>#[pyo3(signature = (...))]</code> å±æ€§ï¼Œå¹¶æ˜ç¡®æŒ‡å®šæ‰€éœ€è¡Œä¸ºã€‚è¿ç§»è­¦å‘Šä¼šæŒ‡å‡ºä¿æŒå½“å‰è¡Œä¸ºæ‰€éœ€çš„ç­¾åã€‚åˆ° 0.23 ç‰ˆæœ¬ï¼Œä»»ä½•åŒ…å« <code>Option&lt;T&gt;</code> ç±»å‹å‚æ•°çš„å‡½æ•°éƒ½å°†è¦æ±‚æ˜ç¡®æŒ‡å®šç­¾åï¼Œä»¥é˜²æ­¢è¡Œä¸ºå‘ç”Ÿæ„å¤–ä¸”æœªå¯Ÿè§‰çš„å˜åŒ–ã€‚åˆ° 0.24 ç‰ˆæœ¬ï¼Œæ­¤é™åˆ¶å°†å†æ¬¡æ”¾å®½ï¼Œ<code>Option&lt;T&gt;</code> ç±»å‹å‚æ•°å°†è¢«è§†ä¸ºæ™®é€šå‚æ•°ï¼Œä¸å†æœ‰ç‰¹æ®Šå¤„ç†ã€‚</p>
<p>ä¹‹å‰ï¼š</p>
<pre><code class="language-rust no_run"><span class="boring">#![allow(deprecated, dead_code)]
</span><span class="boring">use pyo3::prelude::*;
</span>#[pyfunction]
fn increment(x: u64, amount: Option&lt;u64&gt;) -&gt; u64 {
    x + amount.unwrap_or(1)
}</code></pre>
<p>ä¹‹åï¼š</p>
<pre><code class="language-rust no_run"><span class="boring">#![allow(dead_code)]
</span><span class="boring">use pyo3::prelude::*;
</span>#[pyfunction]
#[pyo3(signature = (x, amount=None))]
fn increment(x: u64, amount: Option&lt;u64&gt;) -&gt; u64 {
    x + amount.unwrap_or(1)
}</code></pre>
</details>
<h3 id="pyclone-ç°åœ¨å—é™äº-py-clone-åŠŸèƒ½"><a class="header" href="#pyclone-ç°åœ¨å—é™äº-py-clone-åŠŸèƒ½"><code>Py::clone</code> ç°åœ¨å—é™äº <code>py-clone</code> åŠŸèƒ½</a></h3>
<details>
<summary><small>ç‚¹å‡»å±•å¼€</small></summary>
å¦‚æœä½ ä¾èµ– `impl<t> Clone for Py<t>` æ¥æ»¡è¶³ç°æœ‰ Rust ä»£ç ï¼ˆéåŸºäº PyO3 ç¼–å†™çš„ä»£ç ï¼‰æ–½åŠ çš„ trait è¦æ±‚ï¼Œåˆ™å¿…é¡»å¯ç”¨æ–°å¼•å…¥çš„åŠŸèƒ½ `py-clone`ã€‚
<p>ç„¶è€Œï¼Œè¯·æ³¨æ„å…¶è¡Œä¸ºä¸ä¹‹å‰ç‰ˆæœ¬ä¸åŒã€‚å¦‚æœåœ¨æœªæŒæœ‰ GIL çš„æƒ…å†µä¸‹è°ƒç”¨ <code>Clone</code>ï¼Œæˆ‘ä»¬æ›¾å°è¯•å»¶è¿Ÿè¿™äº›å¼•ç”¨è®¡æ•°å¢é‡çš„åº”ç”¨ï¼Œç›´åˆ°åŸºäº PyO3 çš„ä»£ç é‡æ–°è·å– GIL ä¸ºæ­¢ã€‚è¿™è¢«è¯æ˜æ— æ³•ä»¥å®‰å…¨çš„æ–¹å¼å®ç°ï¼Œå› æ­¤å·²ç§»é™¤ã€‚ç°åœ¨ï¼Œå¦‚æœåœ¨æœªæŒæœ‰ GIL çš„æƒ…å†µä¸‹è°ƒç”¨ <code>Clone</code>ï¼Œæˆ‘ä»¬ä¼šç›´æ¥è§¦å‘ panicï¼Œè€Œè°ƒç”¨ä»£ç å¯èƒ½å¹¶æœªä¸ºæ­¤åšå¥½å‡†å¤‡ã€‚</p>
<p>å»ºè®®é€æ­¥å¼ƒç”¨ <code>py-clone</code> åŠŸèƒ½ã€‚æœ€ç®€å•çš„æ–¹å¼æ˜¯å°† <code>Py&lt;T&gt;</code> åŒ…è£…ä¸º <code>Arc&lt;Py&lt;T&gt;&gt;</code>ï¼Œå¹¶é€šè¿‡å…‹éš† Arc æ¥å®ç°ã€‚</p>
<p>ä¸æ­¤ç›¸å…³ï¼Œæˆ‘ä»¬ä¹Ÿæ·»åŠ äº†ä¸€ä¸ª <code>pyo3_disable_reference_pool</code> æ¡ä»¶ç¼–è¯‘æ ‡å¿—ï¼Œç”¨äºç§»é™¤ <code>impl&lt;T&gt; Drop for Py&lt;T&gt;</code> æ‰€éœ€çš„å»¶è¿Ÿå¼•ç”¨è®¡æ•°é€’å‡åŸºç¡€è®¾æ–½ã€‚å®ƒä»¬ä¼¼ä¹ä¸æ„æˆå®‰å…¨æ€§éšæ‚£ï¼Œæœ€åæƒ…å†µä¹Ÿåªæ˜¯å†…å­˜æ³„æ¼ã€‚ä½†æ˜¯ï¼Œå…¨å±€åŒæ­¥ä¼šåœ¨è·¨ Python-Rust è¾¹ç•Œæ—¶å¸¦æ¥æ˜¾è‘—å¼€é”€ã€‚å¯ç”¨æ­¤åŠŸèƒ½å°†æ¶ˆé™¤è¿™äº›æˆæœ¬ï¼Œå¹¶åœ¨æœªæŒæœ‰ GIL æ—¶è°ƒç”¨ <code>Drop</code> å®ç°æ—¶ç›´æ¥ç»ˆæ­¢è¿›ç¨‹ã€‚</p>

<h3 id="ä¸ºç®€å•æšä¸¾çš„æ¯”è¾ƒè¦æ±‚æ˜¾å¼é€‰æ‹©å¯ç”¨"><a class="header" href="#ä¸ºç®€å•æšä¸¾çš„æ¯”è¾ƒè¦æ±‚æ˜¾å¼é€‰æ‹©å¯ç”¨">ä¸ºç®€å•æšä¸¾çš„æ¯”è¾ƒè¦æ±‚æ˜¾å¼é€‰æ‹©å¯ç”¨</a></h3>
<details>
<summary><small>ç‚¹å‡»å±•å¼€</small></summary>
<p>ä» <code>pyo3</code> 0.22 å¼€å§‹ï¼Œæ–°çš„ <code>#[pyo3(eq)]</code> é€‰é¡¹å…è®¸ä½¿ç”¨ Rust çš„ <code>PartialEq</code> è‡ªåŠ¨å®ç° Python ç­‰å€¼æ¯”è¾ƒã€‚åœ¨æ­¤ä¹‹å‰ï¼Œç®€å•æšä¸¾ä¼šè‡ªåŠ¨æ ¹æ®å…¶åˆ¤åˆ«ç¬¦ï¼ˆdiscriminantï¼‰å®ç°ç­‰å€¼æ¯”è¾ƒã€‚ä¸ºäº†ä½¿ PyO3 æ›´ä¸€è‡´ï¼Œç°åœ¨å¼ƒç”¨è¿™ç§è‡ªåŠ¨ç­‰å€¼å®ç°ï¼Œæ”¹ä¸ºè¦æ±‚æ‰€æœ‰ <code>#[pyclass]</code> ç±»å‹æ˜¾å¼é€‰æ‹©å¯ç”¨ã€‚ç±»ä¼¼åœ°ï¼Œç®€å•æšä¸¾æ›¾æ”¯æŒä¸æ•´æ•°æ¯”è¾ƒï¼Œä½†è¯¥åŠŸèƒ½ä¸å— Rust <code>PartialEq</code> æ´¾ç”Ÿæ”¯æŒï¼Œå› æ­¤å·²å•ç‹¬æ‹†åˆ†ä¸º <code>#[pyo3(eq_int)]</code> å±æ€§ã€‚</p>
<p>è¿ç§»æ—¶ï¼Œè¯·åœ¨ç®€å•æšä¸¾ç±»ä¸Šæ·»åŠ  <code>#[pyo3(eq, eq_int)]</code> å±æ€§ã€‚</p>
<p>ä¹‹å‰ï¼š</p>
<pre><code class="language-rust no_run"><span class="boring">#![allow(deprecated, dead_code)]
</span><span class="boring">use pyo3::prelude::*;
</span>#[pyclass]
enum SimpleEnum {
    VariantA,
    VariantB = 42,
}</code></pre>
<p>ä¹‹åï¼š</p>
<pre><code class="language-rust no_run"><span class="boring">#![allow(dead_code)]
</span><span class="boring">use pyo3::prelude::*;
</span>#[pyclass(eq, eq_int)]
#[derive(PartialEq)]
enum SimpleEnum {
    VariantA,
    VariantB = 42,
}</code></pre>
</details>
<h3 id="pytypename-é‡æ„ä»¥æ›´å¥½åœ°åŒ¹é…-python-çš„-__name__"><a class="header" href="#pytypename-é‡æ„ä»¥æ›´å¥½åœ°åŒ¹é…-python-çš„-__name__"><code>PyType::name</code> é‡æ„ä»¥æ›´å¥½åœ°åŒ¹é… Python çš„ <code>__name__</code></a></h3>
<details>
<summary><small>ç‚¹å‡»å±•å¼€</small></summary>
<p>è¯¥å‡½æ•°ä¹‹å‰ä¼šå°è¯•ç›´æ¥ä» Python ç±»å‹å¯¹è±¡çš„ C API å­—æ®µï¼ˆ<code>tp_name</code>ï¼‰è¯»å–å†…å®¹ï¼Œæ­¤æ—¶ä¼šè¿”å› <code>Cow::Borrowed</code>ã€‚ä½† <code>tp_name</code> çš„å†…å®¹è¯­ä¹‰ä¸æ˜ç¡®ã€‚</p>
<p>ç°åœ¨ <code>PyType::name()</code> è¿”å›ç›¸å½“äº Python ä¸­ <code>__name__</code> çš„å€¼ï¼Œå¹¶è¿”å› <code>PyResult&lt;Bound&lt;'py, PyString&gt;&gt;</code>ã€‚</p>
<p>æœ€æ¥è¿‘ PyO3 0.21 ç‰ˆæœ¬ <code>PyType::name()</code> çš„æ–°å‡½æ•°æ˜¯ <code>PyType::fully_qualified_name()</code>ï¼Œå…¶ç­‰ä»·äºå°† <code>__module__</code> å’Œ <code>__qualname__</code> è¿æ¥ä¸º <code>module.qualname</code>ã€‚</p>
<p>ä¹‹å‰ï¼š</p>
<pre><code class="language-rust ignore"><span class="boring">#![allow(deprecated, dead_code)]
</span><span class="boring">use pyo3::prelude::*;
</span><span class="boring">use pyo3::types::{PyBool};
</span><span class="boring">fn main() -&gt; PyResult&lt;()&gt; {
</span>Python::with_gil(|py| {
    let bool_type = py.get_type_bound::&lt;PyBool&gt;();
    let name = bool_type.name()?.into_owned();
    println!("Hello, {}", name);


    let mut name_upper = bool_type.name()?;
    name_upper.to_mut().make_ascii_uppercase();
    println!("Hello, {}", name_upper);


    Ok(())
})
<span class="boring">}</span></code></pre>
<p>ä¹‹åï¼š</p>
<pre><code class="language-rust ignore"><span class="boring">#![allow(dead_code)]
</span><span class="boring">use pyo3::prelude::*;
</span><span class="boring">use pyo3::types::{PyBool};
</span><span class="boring">fn main() -&gt; PyResult&lt;()&gt; {
</span>Python::with_gil(|py| {
    let bool_type = py.get_type_bound::&lt;PyBool&gt;();
    let name = bool_type.name()?;
    println!("Hello, {}", name);


    // ï¼ˆå¦‚æœéœ€è¦å®Œæ•´çš„ç‚¹åˆ†è·¯å¾„ï¼Œè¯·å°† `name()` æ›¿æ¢ä¸º `fully_qualified_name()`ï¼‰
    let mut name_upper = bool_type.fully_qualified_name()?.to_string();
    name_upper.make_ascii_uppercase();
    println!("Hello, {}", name_upper);


    Ok(())
})
<span class="boring">}</span></code></pre>
</details>
<h2 id="ä»-020-å‡çº§åˆ°-021"><a class="header" href="#ä»-020-å‡çº§åˆ°-021">ä» 0.20.* å‡çº§åˆ° 0.21</a></h2>
<details>
<summary><small>ç‚¹å‡»å±•å¼€</small></summary>
<p>PyO3 0.21 å¼•å…¥äº†ä¸€ä¸ªæ–°çš„ <code>Bound&lt;'py, T&gt;</code> æ™ºèƒ½æŒ‡é’ˆï¼Œç”¨äºæ›¿ä»£ç°æœ‰çš„â€œGIL Refsâ€API æ¥ä¸ Python å¯¹è±¡äº¤äº’ã€‚ä¾‹å¦‚ï¼Œåœ¨ PyO3 0.20 ä¸­ä½¿ç”¨ <code>&amp;'py PyAny</code> ä¸ Python å¯¹è±¡äº¤äº’ï¼Œè€Œåœ¨ PyO3 0.21 ä¸­æ›´æ–°ä¸º <code>Bound&lt;'py, PyAny&gt;</code>ã€‚æ­¤å˜æ›´å°† Rust çš„æ‰€æœ‰æƒè¯­ä¹‰ä» PyO3 å†…éƒ¨ç§»åˆ°ç”¨æˆ·ä»£ç ä¸­ã€‚è¿™ä¸€æ”¹å˜ä¿®å¤äº†<a href="https://github.com/PyO3/pyo3/issues/3668">ä¸ gevent äº¤äº’ä¸­å·²çŸ¥çš„å®‰å…¨æ€§è¾¹ç•Œæƒ…å†µ</a>ï¼Œå¹¶æå‡äº† CPU å’Œ <a href="https://github.com/PyO3/pyo3/issues/1056">å†…å­˜æ€§èƒ½</a>ã€‚å®Œæ•´è®¨è®ºå†å²è§ <a href="https://github.com/PyO3/pyo3/issues/3382">https://github.com/PyO3/pyo3/issues/3382</a>ã€‚</p>
<p>â€œGIL Refâ€ <code>&amp;'py PyAny</code> ä»¥åŠç±»ä¼¼ <code>&amp;'py PyDict</code> çš„ç±»å‹ä»ä½œä¸ºå·²å¼ƒç”¨ API å¯ç”¨ã€‚ç”±äºæ–° API çš„ä¼˜åŠ¿ï¼Œå»ºè®®æ‰€æœ‰ç”¨æˆ·å°½å¿«å‡çº§ã€‚</p>
<p>é™¤äº†ä¸»è¦ API ç±»å‹é‡æ„å¤–ï¼ŒPyO3 è¿˜å¯¹å…¶ä»–ä¸€äº› API è¿›è¡Œäº†å°‘é‡ç ´åæ€§è°ƒæ•´ï¼Œä»¥å¼¥è¡¥æ­£ç¡®æ€§å’Œå®‰å…¨æ€§ä¸Šçš„æ¼æ´ã€‚</p>
<p>æ¨èçš„å‡çº§åˆ° PyO3 0.21 çš„æ­¥éª¤å¦‚ä¸‹ï¼š</p>
<ol>
<li>å¯ç”¨ <code>gil-refs</code> åŠŸèƒ½ä»¥å±è”½ä¸ API å˜æ›´ç›¸å…³çš„å¼ƒç”¨è­¦å‘Š</li>
<li>ä¿®å¤æ‰€æœ‰å…¶ä»– PyO3 0.21 è¿ç§»æ­¥éª¤ä¸­æŒ‡å‡ºçš„é—®é¢˜</li>
<li>ç¦ç”¨ <code>gil-refs</code> åŠŸèƒ½å¹¶è¿ç§»åˆ°æ–° APIä»¥ä¸‹å„èŠ‚æŒ‰æ­¤é¡ºåºæ’åˆ—ã€‚</li>
</ol>
</details>
<h3 id="å¯ç”¨-gil-refs-åŠŸèƒ½"><a class="header" href="#å¯ç”¨-gil-refs-åŠŸèƒ½">å¯ç”¨ <code>gil-refs</code> åŠŸèƒ½</a></h3>
<details>
<summary><small>ç‚¹å‡»å±•å¼€</small></summary>
<p>ä¸ºäº†å°½å¯èƒ½å¹³æ»‘åœ°è¿‡æ¸¡ PyO3 ç”Ÿæ€ç³»ç»Ÿï¼Œä½¿å…¶è„±ç¦» GIL Refs APIï¼Œåœ¨ PyO3 0.21 ç‰ˆæœ¬ä¸­ï¼Œæ‰€æœ‰æ¶ˆè´¹æˆ–äº§ç”Ÿ GIL Refs çš„ API å‡æœªæ›´æ”¹ã€‚å–è€Œä»£ä¹‹çš„æ˜¯å¼•å…¥äº†ä½¿ç”¨ <code>Bound&lt;T&gt;</code> æ™ºèƒ½æŒ‡é’ˆçš„å˜ä½“ã€‚ä¾‹å¦‚ï¼Œ<code>PyTuple::new_bound</code> è¿”å› <code>Bound&lt;PyTuple&gt;</code>ï¼Œç”¨ä»¥æ›¿ä»£ <code>PyTuple::new</code>ã€‚GIL Refs ç›¸å…³ API å·²è¢«å¼ƒç”¨ï¼Œä½†ä¸ºäº†ä¾¿äºè¿ç§»ï¼Œå¯ä»¥é€šè¿‡å¯ç”¨ <code>gil-refs</code> åŠŸèƒ½æ¥ç¦ç”¨è¿™äº›å¼ƒç”¨è­¦å‘Šã€‚</p>
<blockquote>
<p>å”¯ä¸€ä¸€ä¸ªå°±åœ°ä¿®æ”¹ç°æœ‰ API çš„ä¾‹å¤–æ˜¯ <code>pyo3::intern!</code> å®ã€‚å‡ ä¹æ‰€æœ‰å¯¹è¿™ä¸ªå®çš„ä½¿ç”¨éƒ½ä¸éœ€è¦æ›´æ–°ä»£ç æ¥é€‚åº”å…¶æ”¹ä¸ºç«‹å³è¿”å› <code>&amp;Bound&lt;PyString&gt;</code> çš„å˜åŒ–ï¼Œè€Œæ·»åŠ ä¸€ä¸ª <code>intern_bound!</code> æ›¿ä»£å®è¢«è®¤ä¸ºä¼šç»™ç”¨æˆ·å¸¦æ¥é¢å¤–è´Ÿæ‹…ã€‚</p>
</blockquote>
<p>å»ºè®®ç”¨æˆ·åœ¨å‡çº§åˆ° PyO3 0.21 æ—¶é¦–å…ˆæ‰§è¡Œæ­¤æ­¥éª¤ï¼Œä»¥é¿å…å¼ƒç”¨è­¦å‘Šå¹²æ‰°å…¶ä»–è¿ç§»æ­¥éª¤çš„è§£å†³ã€‚</p>
<p>ä¹‹å‰ï¼š</p>
<pre><code class="language-toml"># Cargo.toml
[dependencies]
pyo3 = "0.20"
</code></pre>
<p>ä¹‹åï¼š</p>
<pre><code class="language-toml"># Cargo.toml
[dependencies]
pyo3 = { version = "0.21", features = ["gil-refs"] }
</code></pre>
</details>
<h3 id="pytypeinfo-å’Œ-pytryfrom-å·²è¢«è°ƒæ•´"><a class="header" href="#pytypeinfo-å’Œ-pytryfrom-å·²è¢«è°ƒæ•´"><code>PyTypeInfo</code> å’Œ <code>PyTryFrom</code> å·²è¢«è°ƒæ•´</a></h3>
<details>
<summary><small>ç‚¹å‡»å±•å¼€</small></summary>
<p><code>PyTryFrom</code> trait çš„è®¾è®¡å·²æ˜¾é™ˆæ—§ï¼Œå…¶ <code>try_from</code> æ–¹æ³•åœ¨ Rust 2021 ç‰ˆæœ¬çš„é¢„å¯¼å…¥ï¼ˆpreludeï¼‰ä¸­ä¸ <code>TryFrom::try_from</code> å†²çªã€‚æ­¤å¤–ï¼Œå®ƒçš„è®¸å¤šåŠŸèƒ½ä¹Ÿä¸ <code>PyTypeInfo</code> é‡å¤ã€‚</p>
<p>ä½œä¸º GIL Refs API å¼ƒç”¨å·¥ä½œçš„ä¸€éƒ¨åˆ†ï¼Œä¸ºä½¿ PyO3 çš„ trait ä½“ç³»æ›´ç´§å‡‘ï¼Œ<code>PyTypeInfo</code> trait æ–°å¢äº†ä¸€ä¸ªæ›´ç®€å•çš„è¾…åŠ© trait <code>PyTypeCheck</code>ã€‚<code>PyAny::downcast</code> å’Œ <code>PyAny::downcast_exact</code> æ–¹æ³•ä¸å†ä½¿ç”¨ <code>PyTryFrom</code> ä½œä¸ºçº¦æŸï¼Œè€Œæ˜¯åˆ†åˆ«ä½¿ç”¨ <code>PyTypeCheck</code> å’Œ <code>PyTypeInfo</code>ã€‚</p>
<p>è¿ç§»æ–¹æ³•ï¼šå°†æ‰€æœ‰ç±»å‹è½¬æ¢ä» <code>try_from(obj)</code> æ”¹ä¸ºä½¿ç”¨ <code>obj.downcast()</code>ï¼ˆ<code>downcast_exact</code> åŒç†ï¼‰ã€‚</p>
<p>ä¹‹å‰ï¼š</p>
<pre><code class="language-rust ignore"><span class="boring">#![allow(deprecated)]
</span><span class="boring">use pyo3::prelude::*;
</span><span class="boring">use pyo3::types::{PyInt, PyList};
</span><span class="boring">fn main() -&gt; PyResult&lt;()&gt; {
</span>Python::with_gil(|py| {
    let list = PyList::new(py, 0..5);
    let b = &lt;PyInt as PyTryFrom&gt;::try_from(list.get_item(0).unwrap())?;
    Ok(())
})
<span class="boring">}</span></code></pre>
<p>ä¹‹åï¼š</p>
<pre><code class="language-rust ignore"><span class="boring">use pyo3::prelude::*;
</span><span class="boring">use pyo3::types::{PyInt, PyList};
</span><span class="boring">fn main() -&gt; PyResult&lt;()&gt; {
</span>Python::with_gil(|py| {
    // æ³¨æ„ PyList::new å·²è¢«å¼ƒç”¨ï¼Œåº”ä½¿ç”¨ PyList::new_boundï¼Œè¿™æ˜¯ GIL Refs API ç§»é™¤çš„ä¸€éƒ¨åˆ†
    // è¯¦è§ä¸‹æ–‡å…³äºè¿ç§»åˆ° Bound&lt;T&gt; çš„ç« èŠ‚ã€‚
    #[allow(deprecated)]
    let list = PyList::new(py, 0..5);
    let b = list.get_item(0).unwrap().downcast::&lt;PyInt&gt;()?;
    Ok(())
})
<span class="boring">}</span></code></pre>
</details>
<h3 id="iteranextoutput-å·²è¢«å¼ƒç”¨"><a class="header" href="#iteranextoutput-å·²è¢«å¼ƒç”¨"><code>Iter(A)NextOutput</code> å·²è¢«å¼ƒç”¨</a></h3>
<details>
<summary><small>ç‚¹å‡»å±•å¼€</small></summary>
<p><code>__next__</code> å’Œ <code>__anext__</code> é­”æ³•æ–¹æ³•ç°åœ¨å¯ä»¥åƒå…¶ä»–æ‰€æœ‰ <code>#[pymethods]</code> ä¸€æ ·ï¼Œç›´æ¥è¿”å›ä»»ä½•å¯è½¬æ¢ä¸º Python å¯¹è±¡çš„ç±»å‹ã€‚å› æ­¤ï¼Œ<code>__next__</code> ä½¿ç”¨çš„ <code>IterNextOutput</code> ä»¥åŠ <code>__anext__</code> ä½¿ç”¨çš„ <code>IterANextOutput</code> å‡è¢«å¼ƒç”¨ã€‚æœ€é‡è¦çš„æ˜¯ï¼Œè¿™ä¸€æ›´æ”¹å…è®¸ <code>__anext__</code> ç›´æ¥è¿”å›ä¸€ä¸ªå¯ç­‰å¾…å¯¹è±¡ï¼ˆawaitableï¼‰ï¼Œè€Œæ— éœ€å°†å…¶æ— æ„ä¹‰åœ°åŒ…è£¹åœ¨ <code>Yield</code> æˆ– <code>Some</code> ä¸­ã€‚åªæœ‰è¿”å›ç±»å‹ <code>Option&lt;T&gt;</code> å’Œ <code>Result&lt;Option&lt;T&gt;, E&gt;</code> ä»ä»¥ç‰¹æ®Šæ–¹å¼å¤„ç†ï¼š<code>Some(val)</code> è¡¨ç¤ºäº§ç”Ÿ <code>val</code>ï¼Œ<code>None</code> è¡¨ç¤ºåœæ­¢è¿­ä»£ã€‚</p>
<p>ä»¥ä¸€ä¸ªä½¿ç”¨ <code>IterNextOutput</code> å®ç° Python è¿­ä»£å™¨ä¸ºä¾‹ï¼š</p>
<pre><code class="language-rust ignore">use pyo3::prelude::*;
use pyo3::iter::IterNextOutput;


#[pyclass]
struct PyClassIter {
    count: usize,
}


#[pymethods]
impl PyClassIter {
    fn __next__(&amp;mut self) -&gt; IterNextOutput&lt;usize, &amp;'static str&gt; {
        if self.count &lt; 5 {
            self.count += 1;
            IterNextOutput::Yield(self.count)
        } else {
            IterNextOutput::Return("done")
        }
    }
}</code></pre>
<p>å¦‚æœä¸éœ€è¦é€šè¿‡ <code>StopIteration</code> è¿”å› <code>"done"</code>ï¼Œåˆ™åº”æ”¹å†™ä¸ºï¼š</p>
<pre><code class="language-rust no_run">use pyo3::prelude::*;


#[pyclass]
struct PyClassIter {
    count: usize,
}


#[pymethods]
impl PyClassIter {
    fn __next__(&amp;mut self) -&gt; Option&lt;usize&gt; {
        if self.count &lt; 5 {
            self.count += 1;
            Some(self.count)
        } else {
            None
        }
    }
}</code></pre>
<p>è¿™ç§å†™æ³•è¿˜æœ‰é¢å¤–ä¼˜ç‚¹ï¼šå®ƒåœ¨ä¹‹å‰ç‰ˆæœ¬çš„ PyO3 ä¸­å·²ç»å¯ç”¨ï¼Œä¸ Rust çš„ <a href="https://doc.rust-lang.org/stable/std/iter/trait.Iterator.html"><code>Iterator</code> trait</a> ç­¾åä¸€è‡´ï¼Œå¹¶å…è®¸åœ¨ CPython ä¸­ä½¿ç”¨å¿«é€Ÿè·¯å¾„ï¼Œå®Œå…¨é¿å…æŠ›å‡º <code>StopIteration</code> å¼‚å¸¸çš„å¼€é”€ã€‚æ³¨æ„ï¼Œé€šè¿‡ä½¿ç”¨ <a href="https://doc.rust-lang.org/stable/std/option/enum.Option.html#method.transpose"><code>Option::transpose</code></a> å’Œ <code>Result&lt;Option&lt;T&gt;, E&gt;</code> å˜ä½“ï¼Œæ­¤å½¢å¼ä¹Ÿå¯ç”¨äºåŒ…è£…å¯èƒ½å‡ºé”™çš„è¿­ä»£å™¨ã€‚</p>
<p>æˆ–è€…ï¼Œä¹Ÿå¯ä»¥åƒåœ¨ Python ä¸­ä¸€æ ·ï¼Œé€šè¿‡â€œæŠ›å‡ºâ€<code>StopIteration</code> å¼‚å¸¸æ¥å®ç°ï¼š</p>
<pre><code class="language-rust no_run">use pyo3::prelude::*;
use pyo3::exceptions::PyStopIteration;


#[pyclass]
struct PyClassIter {
    count: usize,
}


#[pymethods]
impl PyClassIter {
    fn __next__(&amp;mut self) -&gt; PyResult&lt;usize&gt; {
        if self.count &lt; 5 {
            self.count += 1;
            Ok(self.count)
        } else {
            Err(PyStopIteration::new_err("done"))
        }
    }
}</code></pre>
<p>æœ€åï¼Œå¼‚æ­¥è¿­ä»£å™¨å¯ä»¥ç›´æ¥è¿”å›ä¸€ä¸ªå¯ç­‰å¾…å¯¹è±¡ï¼Œè€Œæ— éœ€æ··æ·†çš„åŒ…è£…ï¼š</p>
<pre><code class="language-rust no_run">use pyo3::prelude::*;


#[pyclass]
struct PyClassAwaitable {
    number: usize,
}


#[pymethods]
impl PyClassAwaitable {
    fn __next__(&amp;self) -&gt; usize {
        self.number
    }


    fn __await__(slf: Py&lt;Self&gt;) -&gt; Py&lt;Self&gt; {
        slf
    }
}


#[pyclass]
struct PyClassAsyncIter {
    number: usize,
}


#[pymethods]
impl PyClassAsyncIter {
    fn __anext__(&amp;mut self) -&gt; PyClassAwaitable {
        self.number += 1;
        PyClassAwaitable {
            number: self.number,
        }
    }


    fn __aiter__(slf: Py&lt;Self&gt;) -&gt; Py&lt;Self&gt; {
        slf
    }
}</code></pre>
</details>
<h3 id="pytypename-å·²é‡å‘½åä¸º-pytypequalname"><a class="header" href="#pytypename-å·²é‡å‘½åä¸º-pytypequalname"><code>PyType::name</code> å·²é‡å‘½åä¸º <code>PyType::qualname</code></a></h3>
<details>
<summary><small>ç‚¹å‡»å±•å¼€</small></summary>
<p><code>PyType::name</code> å·²é‡å‘½åä¸º <code>PyType::qualname</code>ï¼Œä»¥è¡¨æ˜å…¶ç¡®å®è¿”å›çš„æ˜¯<a href="https://docs.python.org/3/glossary.html#term-qualified-name">é™å®šåç§°</a>ï¼Œä¸ <code>__qualname__</code> å±æ€§ä¸€è‡´ã€‚æ–°æ·»åŠ çš„ <code>PyType::name</code> æ–¹æ³•ç°åœ¨è¿”å›åŒ…å«æ¨¡å—åç§°çš„å®Œæ•´åç§°ï¼Œå¯¹åº”å±æ€§å±‚é¢çš„ <code>__module__.__name__</code>ã€‚</p>
</details>
<h3 id="pycell-å·²è¢«å¼ƒç”¨"><a class="header" href="#pycell-å·²è¢«å¼ƒç”¨"><code>PyCell</code> å·²è¢«å¼ƒç”¨</a></h3>
<details>
<summary><small>ç‚¹å‡»å±•å¼€</small></summary>
<p>ç”¨ Rust å®ç°çš„ Python å¯¹è±¡çš„äº¤äº’ä¸å†éœ€è¦é€šè¿‡ <code>PyCell&lt;T&gt;</code>ã€‚ç°åœ¨ï¼Œæ— è®º <code>T</code> æ˜¯åŸç”Ÿ Python å¯¹è±¡è¿˜æ˜¯ç”¨ <code>#[pyclass]</code> å®šä¹‰çš„ Rust ç±»å‹ï¼Œä¸ Python å¯¹è±¡çš„äº¤äº’éƒ½ä¸€è‡´åœ°é€šè¿‡ <code>Bound&lt;T&gt;</code> æˆ– <code>Py&lt;T&gt;</code> è¿›è¡Œã€‚ä½¿ç”¨ <code>Bound::new</code> æˆ– <code>Py::new</code> åˆ›å»ºå¯¹è±¡ï¼Œå¹¶ä½¿ç”¨ <code>Bound::borrow(_mut)</code> / <code>Py::borrow(_mut)</code> æ¥å€Ÿç”¨å†…éƒ¨çš„ Rust å¯¹è±¡ã€‚</p>
</details>
<h3 id="ä»-gil-refs-api-è¿ç§»åˆ°-boundt"><a class="header" href="#ä»-gil-refs-api-è¿ç§»åˆ°-boundt">ä» GIL Refs API è¿ç§»åˆ° <code>Bound&lt;T&gt;</code></a></h3>
<details>
<summary><small>ç‚¹å‡»å±•å¼€</small></summary>
<p>ä¸ºäº†å°½é‡å‡å°‘å¯¹ä½¿ç”¨ GIL Refs API çš„ä»£ç é€ æˆç ´åï¼ŒPyO3 å¼•å…¥äº† <code>Bound&lt;T&gt;</code> æ™ºèƒ½æŒ‡é’ˆï¼Œå¹¶ä¸ºæ‰€æœ‰æ¥æ”¶æˆ–è¿”å› GIL Refs çš„å‡½æ•°æä¾›äº†å¯¹åº”çš„æ›¿ä»£ç‰ˆæœ¬ã€‚è¿™ä½¿ä»£ç å¯ä»¥é€šè¿‡ç”¨æ–° API æ›¿æ¢æ—§çš„å¼ƒç”¨ API æ¥é€æ­¥è¿ç§»ã€‚</p>
<p>è¦è¯†åˆ«éœ€è¦è¿ç§»çš„éƒ¨åˆ†ï¼Œå¯ä¸´æ—¶å…³é—­ <code>gil-refs</code> åŠŸèƒ½ï¼Œä»¥æŸ¥çœ‹å‡ ä¹æ‰€æœ‰ä½¿ç”¨æ¥å—æˆ–äº§ç”Ÿ GIL Refs çš„ API<a href="#cases-where-pyo3-cannot-emit-gil-ref-deprecation-warnings">ä½ç½®</a>ä¸Šçš„å¼ƒç”¨è­¦å‘Šã€‚é€šè¿‡ä¸€ä¸ªæˆ–å¤šä¸ª PRï¼Œå¯ä»¥ä¾ç…§å¼ƒç”¨æç¤ºé€æ­¥æ›´æ–°ä»£ç ã€‚æ ¹æ®å¼€å‘ç¯å¢ƒä¸åŒï¼Œå…³é—­ <code>gil-refs</code> åŠŸèƒ½å¯èƒ½ä¼šå¼•å…¥<a href="#deactivating-the-gil-refs-feature">ä¸€äº›ç‰¹å®šçš„é”™è¯¯</a>ï¼Œå› æ­¤å¯èƒ½éœ€è¦å…ˆä¿®å¤è¿™äº›é”™è¯¯ã€‚</p>
<p>ä¾‹å¦‚ï¼Œä»¥ä¸‹ API å‡å·²è·å¾—æ›´æ–°çš„å˜ä½“ï¼š</p>
<ul>
<li><code>PyList::new</code>ã€<code>PyTuple::new</code> ç­‰æ„é€ å‡½æ•°ï¼Œå¯¹åº”æ›¿ä»£ä¸º <code>PyList::new_bound</code>ã€<code>PyTuple::new_bound</code> ç­‰ã€‚</li>
<li><code>FromPyObject::extract</code> æœ‰äº†æ–°çš„ <code>FromPyObject::extract_bound</code>ï¼ˆè§ä¸‹æ–‡ï¼‰ã€‚</li>
<li><code>PyTypeInfo</code> trait æ–°å¢äº† <code>_bound</code> æ–¹æ³•ï¼Œç”¨äºæ¥æ”¶æˆ–è¿”å› <code>Bound&lt;T&gt;</code>ã€‚</li>
</ul>
<p>ç”±äºæ–°çš„ <code>Bound&lt;T&gt;</code> API å°†æ‰€æœ‰æƒä» PyO3 æ¡†æ¶ç§»äº¤åˆ°äº†ç”¨æˆ·ä»£ç ä¸­ï¼Œå› æ­¤åœ¨åˆ‡æ¢åˆ°æ–° API æ—¶ï¼Œç”¨æˆ·ä»£ç å¯èƒ½éœ€è¦è¿›è¡Œå¦‚ä¸‹è°ƒæ•´ï¼š</p>
<ul>
<li>ä»£ç å¯èƒ½éœ€è¦æ·»åŠ å¶å°”çš„ <code>&amp;</code> æ¥å€Ÿç”¨æ–°çš„æ™ºèƒ½æŒ‡é’ˆ <code>&amp;Bound&lt;T&gt;</code> è¿›è¡Œä¼ é€’ï¼ˆæˆ–ä½¿ç”¨ <code>.clone()</code>ï¼Œå…¶ä»£ä»·æ˜¯è½»å¾®å¢åŠ  Python å¼•ç”¨è®¡æ•°ï¼‰ã€‚</li>
<li><code>Bound&lt;PyList&gt;</code> å’Œ <code>Bound&lt;PyTuple&gt;</code> ä¸æ”¯æŒ <code>list[0]</code> ç´¢å¼•ï¼Œè€Œåº”ä½¿ç”¨ <code>list.get_item(0)</code>ã€‚</li>
<li><code>Bound&lt;PyTuple&gt;::iter_borrowed</code> æ¯” <code>Bound&lt;PyTuple&gt;::iter</code> ç¨å¾®æ›´é«˜æ•ˆã€‚<code>Bound&lt;PyTuple&gt;</code> çš„é»˜è®¤è¿­ä»£æ— æ³•è¿”å›å€Ÿç”¨å¼•ç”¨ï¼Œå› ä¸º Rust ç›®å‰å°šæœªæ”¯æŒâ€œå‡ºå€Ÿè¿­ä»£å™¨â€ï¼ˆlending iteratorsï¼‰ã€‚åŒç†ï¼Œ<code>Bound&lt;PyTuple&gt;::get_borrowed_item</code> æ¯” <code>get_item</code> æ›´é«˜æ•ˆã€‚</li>
<li><code>&amp;Bound&lt;T&gt;</code> ä¸å†å®ç° <code>FromPyObject</code>ï¼ˆå°½ç®¡æœªæ¥åœ¨ GIL Refs API å®Œå…¨ç§»é™¤åå¯èƒ½å®ç°ï¼‰ã€‚åº”ä½¿ç”¨ <code>bound_any.downcast::&lt;T&gt;()</code> æ›¿ä»£ <code>bound_any.extract::&lt;&amp;Bound&lt;T&gt;&gt;()</code>ã€‚</li>
<li><code>Bound&lt;PyString&gt;::to_str</code> ç°åœ¨ä» <code>Bound&lt;PyString&gt;</code> æœ¬èº«å€Ÿç”¨ï¼Œè€Œéä»åŸæœ‰çš„ <code>'py</code> ç”Ÿå‘½å‘¨æœŸå€Ÿç”¨ï¼Œå› æ­¤åœ¨æŸäº›ä¹‹å‰ <code>&amp;PyString</code> ä»…ä½œä¸ºä¸´æ—¶å€¼ä½¿ç”¨çš„åœ°æ–¹ï¼Œç°åœ¨éœ€è¦å°†æ™ºèƒ½æŒ‡é’ˆä½œä¸ºå€¼å­˜å‚¨ã€‚ï¼ˆ<a href="#deactivating-the-gil-refs-feature">ä¸‹æ–‡</a> ä¸­å¯¹æ­¤æœ‰æ›´å¤šç»†èŠ‚è¯´æ˜ã€‚ï¼‰</li>
</ul>
</details>- `.extract::&lt;&amp;str&gt;()` ç°åœ¨ä¼šä»æº Python å¯¹è±¡å€Ÿç”¨ã€‚æœ€ç®€å•çš„å‡çº§æ–¹å¼æ˜¯æ”¹ä¸ºä½¿ç”¨ `.extract::<pybackedstr>()`ï¼Œå®ƒå¯ä»¥ä¿ç•™å¯¹ Python å¼•ç”¨çš„æ‰€æœ‰æƒã€‚æ›´å¤šä¿¡æ¯è¯·å‚è§[å…³äºåœç”¨ `gil-refs` ç‰¹æ€§çš„ç« èŠ‚](#deactivating-the-gil-refs-feature)ã€‚
<p>è¦åœ¨ <code>&amp;PyAny</code> å’Œ <code>&amp;Bound&lt;PyAny&gt;</code> ä¹‹é—´è½¬æ¢ï¼Œè¯·ä½¿ç”¨ <code>as_borrowed()</code> æ–¹æ³•ï¼š</p>
<pre><code class="language-rust ignore">let gil_ref: &amp;PyAny = ...;
let bound: &amp;Bound&lt;PyAny&gt; = &amp;gil_ref.as_borrowed();</code></pre>
<p>è¦åœ¨ <code>Py&lt;T&gt;</code> å’Œ <code>Bound&lt;T&gt;</code> ä¹‹é—´è½¬æ¢ï¼Œè¯·ä½¿ç”¨ <code>bind()</code> / <code>into_bound()</code> æ–¹æ³•ï¼›è¦ä» <code>Bound&lt;T&gt;</code> å›åˆ° <code>Py&lt;T&gt;</code>ï¼Œè¯·ä½¿ç”¨ <code>as_unbound()</code> / <code>unbind()</code> æ–¹æ³•ã€‚</p>
<pre><code class="language-rust ignore">let obj: Py&lt;PyList&gt; = ...;
let bound: &amp;Bound&lt;'py, PyList&gt; = obj.bind(py);
let bound: Bound&lt;'py, PyList&gt; = obj.into_bound(py);

let obj: &amp;Py&lt;PyList&gt; = bound.as_unbound();
let obj: Py&lt;PyList&gt; = bound.unbind();</code></pre>
<div class="warning">
<p>âš ï¸ è­¦å‘Šï¼šæ‚¬å‚æŒ‡é’ˆé™·é˜± ğŸ’£</p>
<blockquote>
<p>ç”±äºæ‰€æœ‰æƒçš„å˜æ›´ï¼Œé‚£äº›ä½¿ç”¨ <code>.as_ptr()</code> å°† <code>&amp;PyAny</code> å’Œå…¶ä»– GIL å¼•ç”¨è½¬æ¢ä¸º <code>*mut pyo3_ffi::PyObject</code> çš„ä»£ç ï¼Œç°åœ¨éœ€è¦ç‰¹åˆ«æ³¨æ„é¿å…åœ¨ <code>Bound&lt;PyAny&gt;</code> æŒæœ‰æ‰€æœ‰æƒçš„æƒ…å†µä¸‹åˆ›å»ºæ‚¬å‚æŒ‡é’ˆã€‚</p>
<p>ä¾‹å¦‚ï¼Œåœ¨è¿ç§»åˆ° <code>Bound&lt;PyAny&gt;</code> æ™ºèƒ½æŒ‡é’ˆæ—¶ï¼Œä»¥ä¸‹ä½¿ç”¨ <code>Option&lt;&amp;PyAny&gt;</code> çš„æ¨¡å¼å¾ˆå®¹æ˜“äº§ç”Ÿæ‚¬å‚æŒ‡é’ˆï¼š</p>
<pre><code class="language-rust ignore">let opt: Option&lt;&amp;PyAny&gt; = ...;
let p: *mut ffi::PyObject = opt.map_or(std::ptr::null_mut(), |any| any.as_ptr());</code></pre>
<p>æ­£ç¡®çš„è¿ç§»æ–¹å¼æ˜¯ä½¿ç”¨ <code>.as_ref()</code>ï¼Œä»¥é¿å…åœ¨ <code>map_or</code> é—­åŒ…ä¸­æå‰ææ„ <code>Bound&lt;PyAny&gt;</code>ï¼š</p>
<pre><code class="language-rust ignore">let opt: Option&lt;Bound&lt;PyAny&gt;&gt; = ...;
let p: *mut ffi::PyObject = opt.as_ref().map_or(std::ptr::null_mut(), Bound::as_ptr);</code></pre>
</blockquote>
</div>

<h4 id="è¿ç§»-frompyobject-çš„å®ç°"><a class="header" href="#è¿ç§»-frompyobject-çš„å®ç°">è¿ç§» <code>FromPyObject</code> çš„å®ç°</a></h4>
<p><code>FromPyObject</code> æ–°å¢äº†ä¸€ä¸ªæ–¹æ³• <code>extract_bound</code>ï¼Œå…¶å‚æ•°ä¸º <code>&amp;Bound&lt;'py, PyAny&gt;</code> è€Œé <code>&amp;PyAny</code>ã€‚<code>extract</code> å’Œ <code>extract_bound</code> éƒ½å·²è¢«æä¾›äº†å½¼æ­¤çš„é»˜è®¤å®ç°ï¼Œä»¥é¿å…åœ¨å‡çº§åˆ° 0.21 æ—¶ç«‹åˆ»ç ´åç°æœ‰ä»£ç ã€‚</p>
<p>æ‰€æœ‰ <code>FromPyObject</code> çš„å®ç°éƒ½åº”ä» <code>extract</code> è¿ç§»åˆ° <code>extract_bound</code>ã€‚</p>
<p>è¿ç§»å‰ï¼š</p>
<pre><code class="language-rust ignore">impl&lt;'py&gt; FromPyObject&lt;'py&gt; for MyType {
    fn extract(obj: &amp;'py PyAny) -&gt; PyResult&lt;Self&gt; {
        /* ... */
    }
}</code></pre>
<p>è¿ç§»åï¼š</p>
<pre><code class="language-rust ignore">impl&lt;'py&gt; FromPyObject&lt;'py&gt; for MyType {
    fn extract_bound(obj: &amp;Bound&lt;'py, PyAny&gt;) -&gt; PyResult&lt;Self&gt; {
        /* ... */
    }
}</code></pre>
<p>é¢„è®¡åœ¨ 0.22 ç‰ˆæœ¬ä¸­ï¼Œ<code>extract_bound</code> å°†ä¸å†æä¾›é»˜è®¤å®ç°ï¼›åœ¨ 0.23 ç‰ˆæœ¬ä¸­ï¼Œ<code>extract</code> å°†è¢«å®Œå…¨ç§»é™¤ã€‚</p>
<h4 id="pyo3-æ— æ³•å‘å‡º-gil-å¼•ç”¨å¼ƒç”¨è­¦å‘Šçš„åœºæ™¯"><a class="header" href="#pyo3-æ— æ³•å‘å‡º-gil-å¼•ç”¨å¼ƒç”¨è­¦å‘Šçš„åœºæ™¯">PyO3 æ— æ³•å‘å‡º GIL å¼•ç”¨å¼ƒç”¨è­¦å‘Šçš„åœºæ™¯</a></h4>
<p>å°½ç®¡ PyO3 äº§ç”Ÿäº†å¤§é‡å¼ƒç”¨è­¦å‘Šä»¥å¸®åŠ©ç”¨æˆ·ä» GIL å¼•ç”¨è¿ç§»åˆ° Bound APIï¼Œä½†ä»æœ‰ä¸€äº›æƒ…å†µä¸‹æ— æ³•è‡ªåŠ¨è­¦å‘Š GIL å¼•ç”¨çš„ä½¿ç”¨ã€‚åœ¨å¤„ç†å®Œæ‰€æœ‰å¼ƒç”¨è­¦å‘Šåï¼Œå»ºè®®æ‰‹åŠ¨æ£€æŸ¥ä»¥ä¸‹æƒ…å†µï¼š</p>
<ul>
<li><code>FromPyObject</code> trait çš„å…·ä½“å®ç°æ— æ³•è¢«æ ‡è®°ä¸ºå¼ƒç”¨ï¼Œå› æ­¤ PyO3 æ— æ³•è­¦å‘Šç±»ä¼¼ <code>.extract&lt;&amp;PyAny&gt;()</code> è¿™æ ·äº§ç”Ÿ GIL å¼•ç”¨çš„ä»£ç æ¨¡å¼ã€‚</li>
<li><code>#[pyfunction]</code> å‚æ•°ä¸­çš„ GIL å¼•ç”¨ä¼šå‘å‡ºè­¦å‘Šï¼Œä½†å¦‚æœ GIL å¼•ç”¨è¢«åŒ…è£¹åœ¨å…¶ä»–å®¹å™¨ä¸­ï¼ˆä¾‹å¦‚ <code>Vec&lt;&amp;PyAny&gt;</code>ï¼‰ï¼ŒPyO3 å°±æ— æ³•å‘å‡ºè­¦å‘Šã€‚</li>
<li><code>wrap_pyfunction!(function)(py)</code> è¿™ç§å»¶è¿Ÿä¼ å‚å½¢å¼çš„å®è°ƒç”¨ä¸­ï¼Œå½“ä¼ å…¥ <code>py: Python&lt;'py&gt;</code> æ—¶ä¼šäº§ç”Ÿ GIL å¼•ç”¨ï¼Œä½†ç”±äºç±»å‹æ¨å¯¼çš„é™åˆ¶ï¼ŒPyO3 æ— æ³•é’ˆå¯¹æ­¤æƒ…å†µå‘å‡ºè­¦å‘Šã€‚</li>
</ul>

<h3 id="åœç”¨-gil-refs-ç‰¹æ€§"><a class="header" href="#åœç”¨-gil-refs-ç‰¹æ€§">åœç”¨ <code>gil-refs</code> ç‰¹æ€§</a></h3>
<details>
<summary><small>ç‚¹å‡»å±•å¼€</small></summary>
<p>ä½œä¸ºè¿ç§»çš„æœ€åä¸€æ­¥ï¼Œåœç”¨ <code>gil-refs</code> ç‰¹æ€§å°†ä¸ºä»£ç å¸¦æ¥æœ€ä½³æ€§èƒ½ï¼Œå¹¶ä¸º PyO3 0.22 å»ºç«‹å‘å‰å…¼å®¹çš„ APIã€‚</p>
<p>æ­¤æ—¶ï¼ŒåŸå…ˆéœ€è¦ç®¡ç† GIL å¼•ç”¨å†…å­˜çš„ä»£ç å¯ä»¥å®‰å…¨åœ°ç§»é™¤å¯¹ <code>GILPool</code> çš„ä½¿ç”¨ï¼ˆè¯¥å¯¹è±¡ç”± <code>Python::new_pool</code> å’Œ <code>Python::with_pool</code> è°ƒç”¨åˆ›å»ºï¼‰ã€‚å¼ƒç”¨è­¦å‘Šå°†é«˜äº®è¿™äº›ä½¿ç”¨åœºæ™¯ã€‚</p>
<p>ç¦ç”¨è¯¥ç‰¹æ€§åï¼Œåªæœ‰ä¸€ç§æƒ…å†µä¼šå¯¼è‡´ä»£ç è¡Œä¸ºå˜åŒ–ï¼šå¯¹äºé‚£äº›ç›´æ¥ä»è¾“å…¥æ•°æ®å€Ÿç”¨çš„ç±»å‹ï¼ŒPyO3 åœ¨æ²¡æœ‰ GIL å¼•ç”¨çš„æƒ…å†µä¸‹æ— æ³•å®ç° <code>FromPyObject</code> traitï¼ˆç›®å‰æ­£å¤„äºç§»é™¤ GIL å¼•ç”¨ API çš„è¿‡ç¨‹ä¸­ï¼‰ã€‚ä¸»è¦å—å½±å“çš„ç±»å‹åŒ…æ‹¬ <code>&amp;str</code>ã€<code>Cow&lt;'_, str&gt;</code>ã€<code>&amp;[u8]</code>ã€<code>Cow&lt;'_, u8&gt;</code>ã€‚</p>
<p>ä¸ºäº†åœ¨ GIL å¼•ç”¨ API è¢«ç§»é™¤çš„è¿‡ç¨‹ä¸­ä¿æŒ PyO3 æ ¸å¿ƒåŠŸèƒ½çš„å¯ç”¨æ€§ï¼Œç¦ç”¨ <code>gil-refs</code> ç‰¹æ€§åï¼Œ<code>&amp;str</code>ã€<code>Cow&lt;'_, str&gt;</code>ã€<code>&amp;[u8]</code>ã€<code>Cow&lt;'_, u8&gt;</code> çš„ <code>FromPyObject</code> å®ç°å°†è¢«ç§»è‡³ä¸€ä¸ªæ–°çš„ä¸´æ—¶ trait <code>FromPyObjectBound</code>ã€‚è¯¥ trait æ˜¯æœªæ¥ <code>FromPyObject</code> çš„é¢„æœŸå½¢æ€ï¼Œé¢å¤–å¼•å…¥äº†ä¸€ä¸ªç”Ÿå‘½å‘¨æœŸ <code>'a</code>ï¼Œä»¥æ”¯æŒè¿™äº›ç±»å‹ä» Python å¯¹è±¡ä¸­å€Ÿç”¨æ•°æ®ã€‚</p>
<p>PyO3 0.21 å¼•å…¥äº† <a href="{{#PYO3_DOCS_URL}}/pyo3/pybacked/struct.PyBackedStr.html"><code>PyBackedStr</code></a> å’Œ <a href="{{#PYO3_DOCS_URL}}/pyo3/pybacked/struct.PyBackedBytes.html"><code>PyBackedBytes</code></a> ç±»å‹æ¥åº”å¯¹è¿™ä¸€å˜åŒ–ã€‚é¿å… <code>&amp;str</code> æå–å¸¦æ¥çš„ç”Ÿå‘½å‘¨æœŸé—®é¢˜çš„æœ€ç®€å•æ–¹å¼å°±æ˜¯ä½¿ç”¨è¿™ä¸¤ä¸ªç±»å‹ã€‚å¯¹äºæ›´å¤æ‚çš„ç±»å‹ï¼ˆå¦‚ <code>Vec&lt;&amp;str&gt;</code>ï¼‰ï¼Œç°åœ¨å·²ç»æ— æ³•ç›´æ¥ä» Python å¯¹è±¡ä¸­æå–ï¼Œæ¨èçš„å‡çº§è·¯å¾„æ˜¯ä½¿ç”¨ <code>Vec&lt;PyBackedStr&gt;</code>ã€‚</p>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œç”±äºæå–è¿™äº›ç±»å‹ç°åœ¨ç»‘å®šåˆ°äº†è¾“å…¥å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸï¼Œä¸€äº›éå¸¸å¸¸è§çš„æ¨¡å¼å¯èƒ½éœ€è¦æ‹†åˆ†ä¸ºå¤šè¡Œ Rust ä»£ç ã€‚ä¾‹å¦‚ï¼Œä»¥ä¸‹ç›´æ¥åœ¨ <code>.getattr()</code> ç»“æœä¸Šè°ƒç”¨ <code>.extract::&lt;&amp;str&gt;()</code> çš„ä»£ç ç‰‡æ®µï¼Œåœ¨åœç”¨ <code>gil-refs</code> ç‰¹æ€§åéœ€è¦è¿›è¡Œè°ƒæ•´ã€‚</p>
<p>è¿ç§»å‰ï¼š</p>
<pre><code class="language-rust ignore"><span class="boring">#[cfg(feature = "gil-refs")] {
</span><span class="boring">use pyo3::prelude::*;
</span><span class="boring">use pyo3::types::{PyList, PyType};
</span><span class="boring">fn example&lt;'py&gt;(py: Python&lt;'py&gt;) -&gt; PyResult&lt;()&gt; {
</span>#[allow(deprecated)] // GIL Ref API
let obj: &amp;'py PyType = py.get_type::&lt;PyList&gt;();
let name: &amp;'py str = obj.getattr("__name__")?.extract()?;
assert_eq!(name, "list");
<span class="boring">Ok(())
</span><span class="boring">}
</span><span class="boring">Python::with_gil(example).unwrap();
</span><span class="boring">}</span></code></pre>
<p>è¿ç§»åï¼š</p>
<pre><code class="language-rust ignore"><span class="boring">#[cfg(any(not(Py_LIMITED_API), Py_3_10))] {
</span><span class="boring">use pyo3::prelude::*;
</span><span class="boring">use pyo3::types::{PyList, PyType};
</span><span class="boring">fn example&lt;'py&gt;(py: Python&lt;'py&gt;) -&gt; PyResult&lt;()&gt; {
</span>let obj: Bound&lt;'py, PyType&gt; = py.get_type_bound::&lt;PyList&gt;();
let name_obj: Bound&lt;'py, PyAny&gt; = obj.getattr("__name__")?;
// æ•°æ®çš„ç”Ÿå‘½å‘¨æœŸä¸å†æ˜¯ `'py`ï¼Œè€Œæ˜¯ä¸Šæ–‡ `name_obj` æ™ºèƒ½æŒ‡é’ˆçš„æ›´çŸ­ç”Ÿå‘½å‘¨æœŸ
let name: &amp;'_ str = name_obj.extract()?;
assert_eq!(name, "list");
<span class="boring">Ok(())
</span><span class="boring">}
</span><span class="boring">Python::with_gil(example).unwrap();
</span><span class="boring">}</span></code></pre>
<p>å¦‚æœå¸Œæœ›å®Œå…¨é¿å…å¤„ç†ç”Ÿå‘½å‘¨æœŸé—®é¢˜ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨æ–°çš„ <code>PyBackedStr</code> ç±»å‹ï¼Œå®ƒå­˜å‚¨å¯¹ Python <code>str</code> çš„å¼•ç”¨ä½†æ— éœ€é™„åŠ ç”Ÿå‘½å‘¨æœŸã€‚ç‰¹åˆ«æ˜¯å¯¹äºä½äº 3.10 ç‰ˆæœ¬ Python çš„ <code>abi3</code> æ„å»ºï¼Œ<code>PyBackedStr</code> éå¸¸æœ‰ç”¨ã€‚ç”±äºæ—§ç‰ˆæœ¬ <code>abi3</code> CPython API çš„é™åˆ¶ï¼ŒPyO3 æ— æ³•åœ¨è¿™äº›ç‰ˆæœ¬ä¸Šä¸º <code>&amp;str</code> æä¾› <code>FromPyObjectBound</code> å®ç°ã€‚å› æ­¤ï¼Œå¯¹äºæ—§ç‰ˆ <code>abi3</code> æ„å»ºï¼Œæœ€ç®€å•çš„è¿ç§»æ–¹å¼æ˜¯å°†æ‰€æœ‰ <code>.extract::&lt;&amp;str&gt;()</code> æ›¿æ¢ä¸º <code>.extract::&lt;PyBackedStr&gt;()</code>ã€‚æˆ–è€…ï¼Œä¹Ÿå¯ä½¿ç”¨ <code>.extract::&lt;Cow&lt;str&gt;&gt;()</code>ã€<code>.extract::&lt;String&gt;()</code> å°†æ•°æ®å¤åˆ¶åˆ° Rust ä¸­ã€‚</p>
<p>ä»¥ä¸‹ç¤ºä¾‹ä¸ä¸Šé¢ç±»ä¼¼ï¼Œä½†æœ€ç»ˆæå–ç±»å‹ä¸º <code>PyBackedStr</code>ï¼š</p>
<pre><code class="language-rust ignore"><span class="boring">use pyo3::prelude::*;
</span><span class="boring">use pyo3::types::{PyList, PyType};
</span><span class="boring">fn example&lt;'py&gt;(py: Python&lt;'py&gt;) -&gt; PyResult&lt;()&gt; {
</span>use pyo3::pybacked::PyBackedStr;
let obj: Bound&lt;'py, PyType&gt; = py.get_type_bound::&lt;PyList&gt;();
let name: PyBackedStr = obj.getattr("__name__")?.extract()?;
assert_eq!(&amp;*name, "list");
<span class="boring">Ok(())
</span><span class="boring">}
</span><span class="boring">Python::with_gil(example).unwrap();</span></code></pre>
</details>
<h2 id="ä»-019-å‡çº§åˆ°-020"><a class="header" href="#ä»-019-å‡çº§åˆ°-020">ä» 0.19.* å‡çº§åˆ° 0.20</a></h2>
<h3 id="åœæ­¢æ”¯æŒæ—§æŠ€æœ¯"><a class="header" href="#åœæ­¢æ”¯æŒæ—§æŠ€æœ¯">åœæ­¢æ”¯æŒæ—§æŠ€æœ¯</a></h3>
<details>
<summary><small>ç‚¹å‡»å±•å¼€</small></summary>
<p>PyO3 0.20 å°†æœ€ä½ Rust ç‰ˆæœ¬æå‡è‡³ 1.56ã€‚è¿™ä½¿å¾—é¡¹ç›®å¯ä»¥ä½¿ç”¨æ›´æ–°çš„è¯­è¨€ç‰¹æ€§ï¼Œå¹¶ç®€åŒ–äº†ç»´æŠ¤å·¥ä½œã€‚</p>
</details>
<h3 id="pydictget_item-ç°åœ¨è¿”å›-result"><a class="header" href="#pydictget_item-ç°åœ¨è¿”å›-result"><code>PyDict::get_item</code> ç°åœ¨è¿”å› <code>Result</code></a></h3>
<details>
<summary><small>ç‚¹å‡»å±•å¼€</small></summary>
<p>åœ¨ PyO3 0.19 åŠæ›´æ—©ç‰ˆæœ¬ä¸­ï¼Œ<code>PyDict::get_item</code> ä½¿ç”¨äº†ä¼šæŠ‘åˆ¶æ‰€æœ‰å¼‚å¸¸å¹¶åœ¨å‡ºé”™æ—¶è¿”å› <code>None</code> çš„ Python APIã€‚è¿™åŒ…æ‹¬åœ¨æŸ¥æ‰¾é”®æ—¶å…¶ <code>__hash__</code> å’Œ <code>__eq__</code> æ–¹æ³•ä¸­å‡ºç°çš„é”™è¯¯ã€‚</p>
<p>Python æ ¸å¿ƒå¼€å‘è€…çš„æœ€æ–°å»ºè®®æ˜¯é¿å…ä½¿ç”¨ä¼šæŠ‘åˆ¶å¼‚å¸¸çš„ APIï¼Œè€Œåº”è®©å¼‚å¸¸å‘ä¸ŠæŠ›å‡ºã€‚<code>PyDict::get_item_with_error</code> å·²ç»å®ç°äº†è¿™ä¸€æ¨èè¡Œä¸ºï¼Œå› æ­¤è¯¥ API è¢«é‡å‘½åä¸º <code>PyDict::get_item</code>ã€‚</p>
<p>è¿ç§»å‰ï¼š</p>
<pre><code class="language-rust ignore">use pyo3::prelude::*;
use pyo3::exceptions::PyTypeError;
use pyo3::types::{PyDict, IntoPyDict};

<span class="boring">fn main() {
</span><span class="boring">let _ =
</span>Python::with_gil(|py| {
    let dict: &amp;PyDict = [("a", 1)].into_py_dict(py);
    // `a` åœ¨å­—å…¸ä¸­ï¼Œå€¼ä¸º 1
    assert!(dict.get_item("a").map_or(Ok(false), |x| x.eq(1))?);
    // `b` ä¸åœ¨å­—å…¸ä¸­
    assert!(dict.get_item("b").is_none());
    // `dict` ä¸å¯å“ˆå¸Œï¼Œå› æ­¤æ­¤å¤„ä¼šæŠ›å‡º `TypeError`
    assert!(dict
        .get_item_with_error(dict)
        .unwrap_err()
        .is_instance_of::&lt;PyTypeError&gt;(py));
});
<span class="boring">}</span></code></pre>
<p>è¿ç§»åï¼š</p>
<pre><code class="language-rust ignore">use pyo3::prelude::*;
use pyo3::exceptions::PyTypeError;
use pyo3::types::{PyDict, IntoPyDict};

<span class="boring">fn main() {
</span><span class="boring">let _ =
</span>Python::with_gil(|py| -&gt; PyResult&lt;()&gt; {
    let dict: &amp;PyDict = [("a", 1)].into_py_dict(py);
    // `a` åœ¨å­—å…¸ä¸­ï¼Œå€¼ä¸º 1
    assert!(dict.get_item("a")?.map_or(Ok(false), |x| x.eq(1))?);
    // `b` ä¸åœ¨å­—å…¸ä¸­
    assert!(dict.get_item("b")?.is_none());
    // `dict` ä¸å¯å“ˆå¸Œï¼Œå› æ­¤æ­¤å¤„ä¼šæŠ›å‡º `TypeError`
    assert!(dict
        .get_item(dict)
        .unwrap_err()
        .is_instance_of::&lt;PyTypeError&gt;(py));

    Ok(())
});
<span class="boring">}</span></code></pre>
</details>### åœ¨å¯é€‰å‚æ•°ä¹‹åä¸å†æ¥å—å¿…éœ€å‚æ•°
<details>
<summary><small>ç‚¹å‡»å±•å¼€</small></summary>
<p>å°¾éšçš„ <code>Option&lt;T&gt;</code> å‚æ•°å…·æœ‰è‡ªåŠ¨é»˜è®¤å€¼ <code>None</code>ã€‚ä¸ºäº†é¿å…åœ¨ä¿®æ”¹å‡½æ•°ç­¾åæ—¶äº§ç”Ÿæ„å¤–è¡Œä¸ºï¼Œä» PyO3 0.18 å¼€å§‹ï¼Œè‹¥åœ¨ <code>Option&lt;T&gt;</code> å‚æ•°ä¹‹åå­˜åœ¨å¿…éœ€å‚æ•°ï¼Œä¸”æœªä½¿ç”¨ <code>#[pyo3(signature = (...))]</code> æ˜¾å¼æŒ‡å®šé»˜è®¤å€¼ï¼Œåˆ™ä¼šè§¦å‘å¼ƒç”¨è­¦å‘Šã€‚åœ¨ PyO3 0.20 ä¸­ï¼Œè¿™å°†æˆä¸ºç¡¬æ€§é”™è¯¯ã€‚</p>
<p>ä¿®æ”¹å‰ï¼š</p>
<pre><code class="language-rust ignore">#[pyfunction]
fn x_or_y(x: Option&lt;u64&gt;, y: u64) -&gt; u64 {
    x.unwrap_or(y)
}</code></pre>
<p>ä¿®æ”¹åï¼š</p>
<pre><code class="language-rust no_run"><span class="boring">#![allow(dead_code)]
</span><span class="boring">use pyo3::prelude::*;
</span>

#[pyfunction]
#[pyo3(signature = (x, y))] // x å’Œ y éƒ½æ²¡æœ‰é»˜è®¤å€¼ï¼Œå‡ä¸ºå¿…éœ€å‚æ•°
fn x_or_y(x: Option&lt;u64&gt;, y: u64) -&gt; u64 {
    x.unwrap_or(y)
}</code></pre>
</details>
<h3 id="ç§»é™¤å·²å¼ƒç”¨çš„å‡½æ•°å½¢å¼"><a class="header" href="#ç§»é™¤å·²å¼ƒç”¨çš„å‡½æ•°å½¢å¼">ç§»é™¤å·²å¼ƒç”¨çš„å‡½æ•°å½¢å¼</a></h3>
<details>
<summary><small>ç‚¹å‡»å±•å¼€</small></summary>
<p>åœ¨ PyO3 0.18 ä¸­ï¼Œ<code>#[pymethods]</code> çš„ <code>#[args]</code> å±æ€§ä»¥åŠç›´æ¥åœ¨ <code>#[pyfunction]</code> ä¸­æŒ‡å®šå‡½æ•°ç­¾åçš„æ–¹å¼å·²è¢«å¼ƒç”¨ã€‚è¯¥åŠŸèƒ½å·²åœ¨ PyO3 0.20 ä¸­ç§»é™¤ã€‚</p>
<p>ä¿®æ”¹å‰ï¼š</p>
<pre><code class="language-rust ignore">#[pyfunction]
#[pyo3(a, b = "0", "/")]
fn add(a: u64, b: u64) -&gt; u64 {
    a + b
}</code></pre>
<p>ä¿®æ”¹åï¼š</p>
<pre><code class="language-rust no_run"><span class="boring">#![allow(dead_code)]
</span><span class="boring">use pyo3::prelude::*;
</span>

#[pyfunction]
#[pyo3(signature = (a, b=0, /))]
fn add(a: u64, b: u64) -&gt; u64 {
    a + b
}</code></pre>
</details>
<h3 id="ç§»é™¤-intopypointer-trait"><a class="header" href="#ç§»é™¤-intopypointer-trait">ç§»é™¤ <code>IntoPyPointer</code> trait</a></h3>
<details>
<summary><small>ç‚¹å‡»å±•å¼€</small></summary>
<p>æä¾› <code>into_ptr</code> æ–¹æ³•çš„ trait <code>IntoPyPointer</code> å·²è¢«ç§»é™¤ã€‚<code>into_ptr</code> ç°åœ¨ä½œä¸ºå›ºæœ‰æ–¹æ³•ç›´æ¥å­˜åœ¨äºæ­¤å‰å®ç°è¯¥ trait çš„æ‰€æœ‰ç±»å‹ä¸Šã€‚</p>
</details>
<h3 id="aspypointer-ç°åœ¨ä¸º-unsafe-trait"><a class="header" href="#aspypointer-ç°åœ¨ä¸º-unsafe-trait"><code>AsPyPointer</code> ç°åœ¨ä¸º <code>unsafe</code> trait</a></h3>
<details>
<summary><small>ç‚¹å‡»å±•å¼€</small></summary>
<p>trait <code>AsPyPointer</code> ç°åœ¨è¢«æ ‡è®°ä¸º <code>unsafe trait</code>ï¼Œæ„å‘³ç€ä»»ä½•å¤–éƒ¨å®ç°éƒ½å¿…é¡»ä½¿ç”¨ <code>unsafe impl</code> æ ‡è®°ï¼Œå¹¶ç¡®ä¿å§‹ç»ˆè¿”å›æœ‰æ•ˆçš„æŒ‡é’ˆã€‚</p>
</details>
<h2 id="ä»-018-å‡çº§åˆ°-019"><a class="header" href="#ä»-018-å‡çº§åˆ°-019">ä» 0.18.* å‡çº§åˆ° 0.19</a></h2>
<h3 id="ç°åœ¨ç¦æ­¢åœ¨-__traverse__-å®ç°ä¸­è®¿é—®-python"><a class="header" href="#ç°åœ¨ç¦æ­¢åœ¨-__traverse__-å®ç°ä¸­è®¿é—®-python">ç°åœ¨ç¦æ­¢åœ¨ <code>__traverse__</code> å®ç°ä¸­è®¿é—® <code>Python</code></a></h3>
<details>
<summary><small>ç‚¹å‡»å±•å¼€</small></summary>
<p>åœ¨ Python åƒåœ¾å›æ”¶çš„ <code>__traverse__</code> å®ç°è¿‡ç¨‹ä¸­ï¼Œä»…å…è®¸éå† <code>#[pyclass]</code> çš„æˆå‘˜ï¼Œå…¶ä»–ä»»ä½•æ“ä½œå‡è¢«ç¦æ­¢ã€‚è¿™æ„å‘³ç€ä¸å…è®¸è°ƒç”¨ Python å‡½æ•°æˆ–å…¶ä»– APIã€‚</p>
<p>æ—©æœŸç‰ˆæœ¬çš„ PyO3 å…è®¸è®¿é—® <code>Python</code>ï¼ˆä¾‹å¦‚é€šè¿‡ <code>Python::with_gil</code>ï¼‰ï¼Œè¿™å¯èƒ½å¯¼è‡´ Python è§£é‡Šå™¨å´©æºƒæˆ–å¹²æ‰°åƒåœ¾å›æ”¶ç®—æ³•ã€‚</p>
<p>ç°åœ¨ï¼Œå°è¯•è·å– GIL å°†è§¦å‘ panicã€‚è¯¦æƒ…è¯·è§ <a href="https://github.com/PyO3/pyo3/issues/3165">#3165</a>ã€‚</p>
<pre><code class="language-rust ignore"><span class="boring">use pyo3::prelude::*;
</span>

#[pyclass]
struct SomeClass {}


impl SomeClass {
    fn __traverse__(&amp;self, pyo3::class::gc::PyVisit&lt;'_&gt;) -&gt; Result&lt;(), pyo3::class::gc::PyTraverseError&gt;` {
        Python::with_gil(|| { /*...*/ })  // é”™è¯¯ï¼šæ­¤å¤„å°† panic
    }
}</code></pre>
</details>
<h3 id="å½“å†…éƒ¨é”™è¯¯ä¸ºç®€å•-pyerr-æ—¶anyhowerror--eyrereport-è½¬æ¢æ›´æ™ºèƒ½"><a class="header" href="#å½“å†…éƒ¨é”™è¯¯ä¸ºç®€å•-pyerr-æ—¶anyhowerror--eyrereport-è½¬æ¢æ›´æ™ºèƒ½">å½“å†…éƒ¨é”™è¯¯ä¸ºâ€œç®€å•â€ <code>PyErr</code> æ—¶ï¼Œ<code>anyhow::Error</code> / <code>eyre::Report</code> è½¬æ¢æ›´æ™ºèƒ½</a></h3>
<details>
<summary><small>ç‚¹å‡»å±•å¼€</small></summary>
<p>å½“ä» <code>anyhow::Error</code> æˆ– <code>eyre::Report</code> è½¬æ¢ä¸º <code>PyErr</code> æ—¶ï¼Œå¦‚æœå†…éƒ¨é”™è¯¯æ˜¯ä¸€ä¸ªâ€œç®€å•â€çš„ <code>PyErr</code>ï¼ˆå³æ²¡æœ‰æºé”™è¯¯ï¼‰ï¼Œåˆ™è¯¥å†…éƒ¨é”™è¯¯å°†ç›´æ¥ç”¨ä½œ <code>PyErr</code>ï¼Œè€Œä¸æ˜¯å°†å…¶åŒ…è£…åœ¨ä¸€ä¸ªæ–°çš„ <code>PyRuntimeError</code> ä¸­å¹¶å°†åŸä¿¡æ¯è½¬ä¸ºå­—ç¬¦ä¸²ã€‚</p>
<pre><code class="language-rust ignore"><span class="boring">#[cfg(feature = "anyhow")]
</span><span class="boring">#[allow(dead_code)]
</span><span class="boring">mod anyhow_only {
</span><span class="boring">use pyo3::prelude::*;
</span><span class="boring">use pyo3::exceptions::PyValueError;
</span>#[pyfunction]
fn raise_err() -&gt; anyhow::Result&lt;()&gt; {
    Err(PyValueError::new_err("original error message").into())
}


fn main() {
    Python::with_gil(|py| {
        let rs_func = wrap_pyfunction!(raise_err, py).unwrap();
        pyo3::py_run!(
            py,
            rs_func,
            r"
        try:
            rs_func()
        except Exception as e:
            print(repr(e))
        "
        );
    })
}
<span class="boring">}</span></code></pre>
<p>æ­¤å‰ï¼Œä¸Šè¿°ä»£ç ä¼šè¾“å‡º <code>RuntimeError('ValueError: original error message')</code>ï¼Œè¿™å¯èƒ½ä¼šä»¤äººå›°æƒ‘ã€‚</p>
<p>ç°åœ¨ï¼ŒåŒæ ·çš„ä»£ç å°†è¾“å‡º <code>ValueError: original error message</code>ï¼Œæ›´åŠ ç›´è§‚ã€‚</p>
<p>ç„¶è€Œï¼Œå¦‚æœ <code>anyhow::Error</code> æˆ– <code>eyre::Report</code> åŒ…å«æºé”™è¯¯ï¼Œåˆ™åŸå§‹å¼‚å¸¸ä»å°†è¢«åŒ…è£…åœ¨ <code>PyRuntimeError</code> ä¸­ã€‚</p>
</details>
<h3 id="å·²ç§»é™¤å¼ƒç”¨çš„-pythonacquire_gilå¿…é¡»æ”¹ç”¨-pythonwith_gil"><a class="header" href="#å·²ç§»é™¤å¼ƒç”¨çš„-pythonacquire_gilå¿…é¡»æ”¹ç”¨-pythonwith_gil">å·²ç§»é™¤å¼ƒç”¨çš„ <code>Python::acquire_gil</code>ï¼Œå¿…é¡»æ”¹ç”¨ <code>Python::with_gil</code></a></h3>
<details>
<summary><small>ç‚¹å‡»å±•å¼€</small></summary>
<p>è™½ç„¶ <a href="https://docs.rs/pyo3/0.18.3/pyo3/marker/struct.Python.html#method.acquire_gil"><code>Python::acquire_gil</code></a> æä¾›çš„ API çœ‹ä¼¼æ–¹ä¾¿ï¼Œä½†å®ƒå­˜åœ¨ä¸€å®šçš„è„†å¼±æ€§ï¼Œå› ä¸º <a href="https://docs.rs/pyo3/0.18.3/pyo3/marker/struct.Python.html"><code>Python</code></a> token çš„è®¾è®¡ä¾èµ–äºæ­£ç¡®çš„åµŒå¥—ç»“æ„ï¼Œè‹¥ä½¿ç”¨ä¸å½“ä¼šå¯¼è‡´ panicï¼Œä¾‹å¦‚ï¼š</p>
<pre><code class="language-rust ignore"><span class="boring">#![allow(dead_code, deprecated)]
</span><span class="boring">use pyo3::prelude::*;
</span>

#[pyclass]
struct SomeClass {}


struct ObjectAndGuard {
    object: Py&lt;SomeClass&gt;,
    guard: GILGuard,
}


impl ObjectAndGuard {
    fn new() -&gt; Self {
        let guard = Python::acquire_gil();
        let object = Py::new(guard.python(), SomeClass {}).unwrap();


        Self { object, guard }
    }
}


let first = ObjectAndGuard::new();
let second = ObjectAndGuard::new();
// ç”±äº `second` å†…éƒ¨çš„ guard ä»å­˜æ´»ï¼Œæ­¤å¤„ä¼š panic
drop(first);
drop(second);</code></pre>
<p>æ›¿ä»£æ–¹æ¡ˆæ˜¯ <a href="https://docs.rs/pyo3/0.18.3/pyo3/marker/struct.Python.html#method.with_gil"><code>Python::with_gil</code></a>ï¼Œè™½ç„¶ç”¨èµ·æ¥æ›´ç¹çï¼Œä½†å…¶è®¾è®¡ä¸Šå¼ºåˆ¶äº†æ­£ç¡®çš„åµŒå¥—ç»“æ„ï¼Œä¾‹å¦‚ï¼š</p>
<pre><code class="language-rust ignore"><span class="boring">#![allow(dead_code)]
</span><span class="boring">use pyo3::prelude::*;
</span>

#[pyclass]
struct SomeClass {}


struct Object {
    object: Py&lt;SomeClass&gt;,
}


impl Object {
    fn new(py: Python&lt;'_&gt;) -&gt; Self {
        let object = Py::new(py, SomeClass {}).unwrap();


        Self { object }
    }
}


// è¦ä¹ˆå¼ºåˆ¶æˆ‘ä»¬åœ¨å†æ¬¡è·å– GIL å‰é‡Šæ”¾å®ƒ
let first = Python::with_gil(|py| Object::new(py));
let second = Python::with_gil(|py| Object::new(py));
drop(first);
drop(second);


// è¦ä¹ˆç¡®ä¿å†…éƒ¨é”åœ¨å¤–éƒ¨é”ä¹‹å‰é‡Šæ”¾
Python::with_gil(|py| {
    let first = Object::new(py);
    let second = Python::with_gil(|py| Object::new(py));
    drop(first);
    drop(second);
});</code></pre>
<p>æ­¤å¤–ï¼Œ<code>Python::acquire_gil</code> æä¾›å¯¹ <code>GILGuard</code> çš„æ‰€æœ‰æƒï¼Œè¯¥å¯¹è±¡å¯è¢«è‡ªç”±å­˜å‚¨å’Œä¼ é€’ã€‚è¿™é€šå¸¸å¹¶æ— å¸®åŠ©ï¼Œåè€Œå¯èƒ½å¯¼è‡´é”é•¿æœŸæŒæœ‰ï¼Œé˜»å¡ç¨‹åºå…¶ä»–éƒ¨åˆ†çš„æ‰§è¡Œã€‚è€Œ <code>Python::with_gil</code> æä¾›çš„ Python token å…·æœ‰ç”Ÿæˆæ€§ç”Ÿå‘½å‘¨æœŸï¼ˆgenerative lifetimeï¼‰ï¼Œåªèƒ½å‘ä¸‹ä¼ é€’è°ƒç”¨é“¾ï¼Œä»è€Œé¿å…äº†è¯¥é—®é¢˜ã€‚é€šå¸¸ï¼Œä»»ä½• GIL ç»‘å®šçš„å¼•ç”¨ <code>&amp;'py PyAny</code> ä¹Ÿå¯é€šè¿‡ <a href="https://docs.rs/pyo3/0.22.5/pyo3/types/struct.PyAny.html#method.py"><code>PyAny::py</code></a> æ–¹æ³•è·å¾— <code>Python&lt;'py&gt;</code> tokenï¼Œä»è€Œå®Œå…¨é¿å…æ­¤ç±»é—®é¢˜ã€‚</p>
</details>
<h2 id="ä»-017-å‡çº§åˆ°-018"><a class="header" href="#ä»-017-å‡çº§åˆ°-018">ä» 0.17.* å‡çº§åˆ° 0.18</a></h2>
<h3 id="option_-å‚æ•°ä¹‹åçš„å¿…éœ€å‚æ•°å°†ä¸å†è‡ªåŠ¨æ¨æ–­"><a class="header" href="#option_-å‚æ•°ä¹‹åçš„å¿…éœ€å‚æ•°å°†ä¸å†è‡ªåŠ¨æ¨æ–­"><code>Option&lt;_&gt;</code> å‚æ•°ä¹‹åçš„å¿…éœ€å‚æ•°å°†ä¸å†è‡ªåŠ¨æ¨æ–­</a></h3>
<details>
<summary><small>ç‚¹å‡»å±•å¼€</small></summary>
<p>åœ¨ <code>#[pyfunction]</code> å’Œ <code>#[pymethods]</code> ä¸­ï¼Œå¦‚æœåƒ <code>i32</code> è¿™æ ·çš„â€œå¿…éœ€â€å‡½æ•°å‚æ•°å‡ºç°åœ¨ <code>Option&lt;_&gt;</code> å‚æ•°ä¹‹åï¼Œåˆ™è¯¥ <code>Option&lt;_&gt;</code> ä¼šéšå¼åœ°è¢«è§†ä¸ºå¿…éœ€å‚æ•°ï¼ˆæ‰€æœ‰å°¾éšçš„ <code>Option&lt;_&gt;</code> å‚æ•°åŸæœ¬è¢«è§†ä¸ºå¯é€‰ï¼Œå…·æœ‰ <code>None</code> çš„é»˜è®¤å€¼ï¼‰ã€‚</p>
<p>ä» PyO3 0.18 å¼€å§‹ï¼Œæ­¤è¡Œä¸ºå·²è¢«å¼ƒç”¨ï¼Œæœªæ¥ç‰ˆæœ¬å°†è¦æ±‚ä½¿ç”¨ <a href="#å‡½æ•°ç­¾å"><code>#[pyo3(signature = (...))]</code> é€‰é¡¹</a> æ˜¾å¼å£°æ˜å¼€å‘è€…çš„æ„å›¾ã€‚</p>
<p>æ­¤å‰ï¼Œåœ¨ä»¥ä¸‹ç¤ºä¾‹ä¸­ï¼Œx å¿…é¡»ç”± Python ä»£ç æ˜¾å¼ä¼ å…¥ï¼š</p>
<pre><code class="language-rust compile_fail ignore"><span class="boring">#![allow(dead_code)]
</span><span class="boring">use pyo3::prelude::*;
</span>

#[pyfunction]
fn required_argument_after_option(x: Option&lt;i32&gt;, y: i32) {}</code></pre>
<p>ä¿®æ”¹åï¼Œéœ€æ˜¾å¼æŒ‡å®šé¢„æœŸçš„ Python ç­¾åï¼š</p>
<pre><code class="language-rust no_run"><span class="boring">#![allow(dead_code)]
</span><span class="boring">use pyo3::prelude::*;
</span>

// å¦‚æœ x ç¡®å®åº”ä¸ºå¿…éœ€å‚æ•°
#[pyfunction(signature = (x, y))]
fn required_argument_after_option_a(x: Option&lt;i32&gt;, y: i32) {}


// å¦‚æœ x åº”ä¸ºå¯é€‰å‚æ•°ï¼Œåˆ™ y ä¹Ÿéœ€æœ‰é»˜è®¤å€¼
#[pyfunction(signature = (x=None, y=0))]
fn required_argument_after_option_b(x: Option&lt;i32&gt;, y: i32) {}</code></pre>
</details>
<h3 id="__text_signature__-ç°åœ¨ä¼šä¸º-pyfunction-å’Œ-pymethods-è‡ªåŠ¨ç”Ÿæˆ"><a class="header" href="#__text_signature__-ç°åœ¨ä¼šä¸º-pyfunction-å’Œ-pymethods-è‡ªåŠ¨ç”Ÿæˆ"><code>__text_signature__</code> ç°åœ¨ä¼šä¸º <code>#[pyfunction]</code> å’Œ <code>#[pymethods]</code> è‡ªåŠ¨ç”Ÿæˆ</a></h3>
<details>
<summary><small>ç‚¹å‡»å±•å¼€</small></summary>
<p>è¿‡å»ï¼Œå”¯ä¸€æ”¯æŒè®¾ç½®ç”Ÿæˆ Python å‡½æ•°çš„ <code>__text_signature__</code> å±æ€§çš„æ–¹å¼æ˜¯ <a href="#making-the-function-signature-available-to-python"><code>#[pyo3(text_signature = "...")]</code> é€‰é¡¹</a>ã€‚</p>
<p>ç°åœ¨ï¼ŒPyO3 èƒ½å¤ŸåŸºäºå‡½æ•°çš„ Rust ç­¾åï¼ˆæˆ–æ–°çš„ <a href="#å‡½æ•°ç­¾å"><code>#[pyo3(signature = (...))]</code> é€‰é¡¹</a>ï¼‰è‡ªåŠ¨ä¸ºæ‰€æœ‰å‡½æ•°å¡«å…… <code>__text_signature__</code>ã€‚è¿™äº›è‡ªåŠ¨ç”Ÿæˆçš„ <code>__text_signature__</code> å€¼å½“å‰å¯¹äºæ‰€æœ‰é»˜è®¤å€¼ç»Ÿä¸€æ˜¾ç¤ºä¸º <code>...</code>ã€‚åœ¨å‡çº§åˆ° PyO3 0.18 æ—¶ï¼Œè®¸å¤š <code>#[pyo3(text_signature = "...")]</code> é€‰é¡¹å¯ä»¥è¢«åˆ é™¤ã€‚ä½†ç›®å‰ï¼Œå¯¹äºåŒ…å«é»˜è®¤å€¼çš„å‡½æ•°ï¼Œæ‰‹åŠ¨å®ç°å¯èƒ½ä»æ›´å—é’çã€‚</p>
<p>ä¾‹å¦‚ï¼š</p>
<pre><code class="language-rust"><span class="boring">use pyo3::prelude::*;
</span>

// æ­¤å¤„çš„ `text_signature` é€‰é¡¹å·²ä¸å†å¿…è¦ï¼Œå› ä¸º PyO3 ä¼šè‡ªåŠ¨ç”Ÿæˆå®Œå…¨ç›¸åŒçš„å€¼ã€‚
#[pyfunction(text_signature = "(a, b, c)")]
fn simple_function(a: i32, b: i32, c: i32) {}


// åœ¨ PyO3 0.18 ä¸­ï¼Œæ­¤å¤„ `text_signature` ä»æœ‰ä»·å€¼ï¼Œå› ä¸ºè‡ªåŠ¨ç”Ÿæˆçš„ç­¾åä¼šæ˜¯ "(a, b=..., c=...)"ã€‚
#[pyfunction(signature = (a, b = 1, c = 2), text_signature = "(a, b=1, c=2)")]
fn function_with_defaults(a: i32, b: i32, c: i32) {}


<span class="boring">fn main() {
</span><span class="boring">    Python::attach(|py| {
</span><span class="boring">        let simple = wrap_pyfunction!(simple_function, py).unwrap();
</span><span class="boring">        assert_eq!(simple.getattr("__text_signature__").unwrap().to_string(), "(a, b, c)");
</span><span class="boring">        let defaulted = wrap_pyfunction!(function_with_defaults, py).unwrap();
</span><span class="boring">        assert_eq!(defaulted.getattr("__text_signature__").unwrap().to_string(), "(a, b=1, c=2)");
</span><span class="boring">    })
</span><span class="boring">}
</span>```&lt;/details&gt;

# ä» 0.16.* å‡çº§åˆ° 0.17

## `PyMapping` å’Œ `PySequence` ç±»å‹çš„ç±»å‹æ£€æŸ¥å·²æ›´æ”¹

&lt;details&gt;
&lt;summary&gt;&lt;small&gt;ç‚¹å‡»å±•å¼€&lt;/small&gt;&lt;/summary&gt;

æ­¤å‰ï¼Œ`PyMapping` å’Œ `PySequence` çš„ç±»å‹æ£€æŸ¥ï¼ˆåœ¨ `PyTryFrom` ä¸­å®ç°ï¼‰ä½¿ç”¨çš„æ˜¯ Python C-API å‡½æ•° `PyMapping_Check` å’Œ `PySequence_Check`ã€‚é—æ†¾çš„æ˜¯ï¼Œè¿™äº›å‡½æ•°ä¸è¶³ä»¥å‡†ç¡®åŒºåˆ†è¿™äº›ç±»å‹ï¼Œå¯¼è‡´è¡Œä¸ºä¸ä¸€è‡´ï¼ˆå‚è§ [pyo3/pyo3#2072](https://github.com/PyO3/pyo3/issues/2072)ï¼‰ã€‚

PyO3 0.17 å°†è¿™äº›å‘ä¸‹è½¬å‹æ£€æŸ¥æ›´æ”¹ä¸ºæ˜¾å¼æµ‹è¯•ç±»å‹æ˜¯å¦ä¸ºå¯¹åº”çš„æŠ½è±¡åŸºç±» `collections.abc.Mapping` æˆ– `collections.abc.Sequence` çš„å­ç±»ã€‚è¯·æ³¨æ„ï¼Œè¿™éœ€è¦è°ƒç”¨ Python è¿è¡Œæ—¶ï¼Œå› æ­¤ç›¸æ¯”ä¹‹å‰çš„æ–¹æ³•å¯èƒ½ä¼šå¸¦æ¥æ€§èƒ½å¼€é”€ã€‚å¦‚æœæ€§èƒ½æŸå¤±æˆä¸ºä¸€ä¸ªé—®é¢˜ï¼Œä½ å¯ä»¥è‡ªè¡Œæ‰§è¡Œæ£€æŸ¥ï¼Œå¹¶ä½¿ç”¨ `try_from_unchecked`ï¼ˆä¸å®‰å…¨æ–¹æ³•ï¼‰ã€‚

å¦ä¸€ä¸ªå‰¯ä½œç”¨æ˜¯ï¼Œåœ¨ Rust ä¸­ä½¿ç”¨ PyO3 å®šä¹‰çš„ pyclass å¿…é¡»è¢«**æ³¨å†Œ**åˆ°å¯¹åº”çš„ Python æŠ½è±¡åŸºç±»ï¼Œå‘ä¸‹è½¬å‹æ‰èƒ½æˆåŠŸã€‚ä¸ºæ­¤æ–°å¢äº† `PySequence::register` å’Œ `PyMapping::register` æ–¹æ³•ï¼Œä¾¿äºä» Rust ä»£ç ä¸­å®Œæˆæ³¨å†Œã€‚å®ƒä»¬ç­‰ä»·äºåœ¨ Python ä¸­è°ƒç”¨ `collections.abc.Mapping.register(MappingPyClass)` æˆ– `collections.abc.Sequence.register(SequencePyClass)`ã€‚

ä¾‹å¦‚ï¼Œå¯¹äºä¸€ä¸ªåœ¨ Rust ä¸­å®šä¹‰çš„æ˜ å°„ç±»ï¼š

```rust,compile_fail
use pyo3::prelude::*;
use std::collections::HashMap;

#[pyclass(mapping)]
struct Mapping {
    index: HashMap&lt;String, usize&gt;,
}

#[pymethods]
impl Mapping {
    #[new]
    fn new(elements: Option&lt;&amp;PyList&gt;) -&gt; PyResult&lt;Self&gt; {
    // ...
    // æ­¤æ˜ å°„ pyclass çš„å®ç°è¢«æˆªæ–­ â€”â€” åŸºæœ¬ä¸Šæ˜¯ HashMap çš„å°è£…
}</code></pre>
<p>ä½ å¿…é¡»åœ¨å‘ä¸‹è½¬å‹ç”Ÿæ•ˆå‰å°†ç±»æ³¨å†Œåˆ° <code>collections.abc.Mapping</code>ï¼š</p>
<pre><code class="language-rust compile_fail">let m = Py::new(py, Mapping { index }).unwrap();
assert!(m.as_ref(py).downcast::&lt;PyMapping&gt;().is_err());
PyMapping::register::&lt;Mapping&gt;(py).unwrap();
assert!(m.as_ref(py).downcast::&lt;PyMapping&gt;().is_ok());</code></pre>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæœªæ¥å½“ pyclass èƒ½å¤Ÿç›´æ¥ç»§æ‰¿æŠ½è±¡åŸºç±»æ—¶ï¼Œè¿™ä¸€è¦æ±‚å¯èƒ½ä¼šè¢«ç§»é™¤ï¼ˆå‚è§ <a href="https://github.com/PyO3/pyo3/issues/991">pyo3/pyo3#991</a>ï¼‰ã€‚</p>
</details>
<h3 id="multiple-pymethods-åŠŸèƒ½ç°åœ¨éœ€è¦-rust-162"><a class="header" href="#multiple-pymethods-åŠŸèƒ½ç°åœ¨éœ€è¦-rust-162"><code>multiple-pymethods</code> åŠŸèƒ½ç°åœ¨éœ€è¦ Rust 1.62</a></h3>
<details>
<summary><small>ç‚¹å‡»å±•å¼€</small></summary>
<p>ç”±äº <code>multiple-pymethods</code> åŠŸèƒ½æ‰€ä¾èµ–çš„ <code>inventory</code> crate å­˜åœ¨é™åˆ¶ï¼Œè¯¥åŠŸèƒ½ç°åœ¨éœ€è¦ Rust 1.62ã€‚æ›´å¤šä¿¡æ¯è¯·å‚è§ <a href="https://github.com/dtolnay/inventory/issues/32">dtolnay/inventory#32</a>ã€‚</p>
</details>
<h3 id="æ–°å¢-impl-intopypypystring-for-str"><a class="header" href="#æ–°å¢-impl-intopypypystring-for-str">æ–°å¢ <code>impl IntoPy&lt;Py&lt;PyString&gt;&gt; for &amp;str</code></a></h3>
<details>
<summary><small>ç‚¹å‡»å±•å¼€</small></summary>
<p>è¿™å¯èƒ½ä¼šå¯¼è‡´ç±»å‹æ¨æ–­é”™è¯¯ã€‚</p>
<p>ä»¥å‰ï¼š</p>
<pre><code class="language-rust compile_fail"><span class="boring">use pyo3::prelude::*;
</span><span class="boring">
</span><span class="boring">fn main() {
</span>Python::with_gil(|py| {
    // æ— æ³•æ¨æ–­æ˜¯ `Py&lt;PyAny&gt;` è¿˜æ˜¯ `Py&lt;PyString&gt;`
    let _test = "test".into_py(py);
});
<span class="boring">}</span></code></pre>
<p>å‡çº§åï¼Œå¯èƒ½éœ€è¦æ·»åŠ ç±»å‹æ³¨è§£ï¼š</p>
<pre><code class="language-rust ignore"><span class="boring">#![allow(deprecated)]
</span><span class="boring">use pyo3::prelude::*;
</span><span class="boring">
</span><span class="boring">fn main() {
</span>Python::with_gil(|py| {
    let _test: Py&lt;PyAny&gt; = "test".into_py(py);
});
<span class="boring">}</span></code></pre>
</details>
<h3 id="pyproto-åŠŸèƒ½ç°åœ¨é»˜è®¤ç¦ç”¨"><a class="header" href="#pyproto-åŠŸèƒ½ç°åœ¨é»˜è®¤ç¦ç”¨"><code>pyproto</code> åŠŸèƒ½ç°åœ¨é»˜è®¤ç¦ç”¨</a></h3>
<details>
<summary><small>ç‚¹å‡»å±•å¼€</small></summary>
<p>ä¸ºå°†æ¥ç§»é™¤å·²åºŸå¼ƒçš„ <code>#[pyproto]</code> å±æ€§å®åšå‡†å¤‡ï¼Œè¯¥åŠŸèƒ½ç°åœ¨é»˜è®¤å…³é—­ï¼Œéœ€é€šè¿‡æ‰‹åŠ¨å¯ç”¨åŠŸèƒ½æ ‡å¿—æ¥å¼€å¯ã€‚è¿™ä¹Ÿä¸ºä¸ä½¿ç”¨è¯¥åºŸå¼ƒå®çš„ä»£ç å¸¦æ¥è½»å¾®çš„ç¼–è¯‘æ—¶é—´ä¼˜åŒ–ã€‚</p>
</details>
<h3 id="pytypeobject-trait-å·²è¢«åºŸå¼ƒ"><a class="header" href="#pytypeobject-trait-å·²è¢«åºŸå¼ƒ"><code>PyTypeObject</code> trait å·²è¢«åºŸå¼ƒ</a></h3>
<details>
<summary><small>ç‚¹å‡»å±•å¼€</small></summary>
<p><code>PyTypeObject</code> trait æ­¤å‰å‡ ä¹æ— ç”¨ï¼›å‡ ä¹æ‰€æœ‰åŠŸèƒ½æ—©å·²å­˜åœ¨äº <code>PyTypeInfo</code> trait ä¸Šï¼Œè€Œ <code>PyTypeObject</code> å¯¹å…¶ä»…æœ‰ç©ºç™½å®ç°ã€‚åœ¨ PyO3 0.17 ä¸­ï¼Œæœ€åä¸€ä¸ªæ–¹æ³• <code>PyTypeObject::type_object</code> å·²è¿ç§»åˆ° <code>PyTypeInfo::type_object</code>ã€‚</p>
<p>è¿ç§»æ–¹å¼æ˜¯å°† trait è¾¹ç•Œå’Œå¯¼å…¥ä» <code>PyTypeObject</code> æ”¹ä¸º <code>PyTypeInfo</code>ã€‚</p>
<p>ä¹‹å‰ï¼š</p>
<pre><code class="language-rust ignore">use pyo3::Python;
use pyo3::type_object::PyTypeObject;
use pyo3::types::PyType;

fn get_type_object&lt;T: PyTypeObject&gt;(py: Python&lt;'_&gt;) -&gt; &amp;PyType {
    T::type_object(py)
}</code></pre>
<p>ä¹‹åï¼š</p>
<pre><code class="language-rust ignore">use pyo3::{Python, PyTypeInfo};
use pyo3::types::PyType;

fn get_type_object&lt;T: PyTypeInfo&gt;(py: Python&lt;'_&gt;) -&gt; &amp;PyType {
    T::type_object(py)
}

<span class="boring">Python::with_gil(|py| { get_type_object::&lt;pyo3::types::PyList&gt;(py); });</span></code></pre>
</details>
<h3 id="implt-const-n-usize-intopypyobject-for-t-n-ç°åœ¨è¦æ±‚-t-intopy-è€Œé-t-topyobject"><a class="header" href="#implt-const-n-usize-intopypyobject-for-t-n-ç°åœ¨è¦æ±‚-t-intopy-è€Œé-t-topyobject"><code>impl&lt;T, const N: usize&gt; IntoPy&lt;PyObject&gt; for [T; N]</code> ç°åœ¨è¦æ±‚ <code>T: IntoPy</code> è€Œé <code>T: ToPyObject</code></a></h3>
<details>
<summary><small>ç‚¹å‡»å±•å¼€</small></summary>
<p>å¦‚æœè¿™å¼•å‘é”™è¯¯ï¼Œåªéœ€ä¸º <code>T</code> å®ç° <code>IntoPy</code> å³å¯ã€‚ç”±äº pyclass å·²ç»å®ç°äº† <code>IntoPy</code>ï¼Œä½ å¯èƒ½æ— éœ€æ‹…å¿ƒè¿™ä¸€ç‚¹ã€‚</p>
</details>
<h3 id="æ¯ä¸ª-pymodule-ç°åœ¨æ¯ä¸ªè¿›ç¨‹ä¸­åªèƒ½åˆå§‹åŒ–ä¸€æ¬¡"><a class="header" href="#æ¯ä¸ª-pymodule-ç°åœ¨æ¯ä¸ªè¿›ç¨‹ä¸­åªèƒ½åˆå§‹åŒ–ä¸€æ¬¡">æ¯ä¸ª <code>#[pymodule]</code> ç°åœ¨æ¯ä¸ªè¿›ç¨‹ä¸­åªèƒ½åˆå§‹åŒ–ä¸€æ¬¡</a></h3>
<details>
<summary><small>ç‚¹å‡»å±•å¼€</small></summary>
<p>ä¸ºäº†è®© PyO3 æ¨¡å—åœ¨å­˜åœ¨ Python å­è§£é‡Šå™¨æ—¶ä¿æŒå®‰å…¨ï¼Œç›®å‰å¿…é¡»æ˜ç¡®ç¦ç”¨åŒä¸€è¿›ç¨‹å†…å¤šæ¬¡åˆå§‹åŒ– <code>#[pymodule]</code> çš„èƒ½åŠ›ã€‚å°è¯•é‡å¤åˆå§‹åŒ–ç°åœ¨ä¼šæŠ›å‡º <code>ImportError</code>ã€‚</p>
</details>
<h2 id="ä»-015-å‡çº§åˆ°-016"><a class="header" href="#ä»-015-å‡çº§åˆ°-016">ä» 0.15.* å‡çº§åˆ° 0.16</a></h2>
<!-- rumdl-disable MD024 - same heading used above -->
<h3 id="æ”¾å¼ƒå¯¹æ—§æŠ€æœ¯çš„æ”¯æŒ"><a class="header" href="#æ”¾å¼ƒå¯¹æ—§æŠ€æœ¯çš„æ”¯æŒ">æ”¾å¼ƒå¯¹æ—§æŠ€æœ¯çš„æ”¯æŒ</a></h3>
<!-- rumdl-enable MD024 -->
<details>
<summary><small>ç‚¹å‡»å±•å¼€</small></summary>
<p>PyO3 0.16 å°†æœ€ä½ Rust ç‰ˆæœ¬æå‡è‡³ 1.48ï¼Œæœ€ä½ Python ç‰ˆæœ¬æå‡è‡³ 3.7ã€‚è¿™ä½¿å¾—é¡¹ç›®å¯ä»¥ä½¿ç”¨æ›´æ–°çš„è¯­è¨€ç‰¹æ€§ï¼ˆæ”¯æŒ 0.16 ä¸­çš„å…¶ä»–æ–°å¢åŠŸèƒ½ï¼‰ï¼Œå¹¶ç®€åŒ–äº†ç»´æŠ¤å·¥ä½œã€‚</p>
</details>
<h3 id="pyproto-å·²è¢«åºŸå¼ƒ"><a class="header" href="#pyproto-å·²è¢«åºŸå¼ƒ"><code>#[pyproto]</code> å·²è¢«åºŸå¼ƒ</a></h3>
<details>
<summary><small>ç‚¹å‡»å±•å¼€</small></summary>
<p>åœ¨ PyO3 0.15 ä¸­ï¼Œ<code>#[pymethods]</code> å±æ€§å®å¢åŠ äº†å¯¹å®ç°â€œé­”æ³•æ–¹æ³•â€ï¼ˆå¦‚ <code>__str__</code>ï¼Œåˆç§°â€œåŒä¸‹åˆ’çº¿æ–¹æ³•â€ï¼‰çš„æ”¯æŒã€‚å½“æ—¶è¯¥å®ç°å°šæœªå®Œå…¨å®šå‹ï¼Œä»æœ‰ä¸€äº›è¾¹ç•Œæƒ…å†µå¾…å†³å®šï¼Œå› æ­¤ä¿ç•™äº†åŸæœ‰çš„ <code>#[pyproto]</code> å±æ€§å®ä»¥è¦†ç›–è¿™äº›æƒ…å†µã€‚</p>
<p>åœ¨ PyO3 0.16 ä¸­ï¼Œ<code>#[pymethods]</code> çš„å®ç°å·²ç»å®Œæˆï¼Œç°å·²æˆä¸ºå®ç°é­”æ³•æ–¹æ³•çš„æ¨èæ–¹å¼ã€‚ä¸ºäº†è®© PyO3 é¡¹ç›®æŒç»­å‘å±•ï¼Œ<code>#[pyproto]</code> å·²è¢«åºŸå¼ƒï¼ˆé¢„è®¡åœ¨ PyO3 0.18 ä¸­ç§»é™¤ï¼‰ã€‚</p>
<p>ä» <code>#[pyproto]</code> è¿ç§»åˆ° <code>#[pymethods]</code> å¾ˆç®€å•ï¼›åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œåªéœ€å°†åŸæœ‰æ–¹æ³•ä» <code>#[pyproto]</code> trait å®ç°ä¸­ç›´æ¥å¤åˆ¶åˆ° <code>#[pymethods]</code> å—ä¸­å³å¯ã€‚</p>
<p>ä¹‹å‰ï¼š</p>
<pre><code class="language-rust compile_fail">use pyo3::prelude::*;
use pyo3::class::{PyObjectProtocol, PyIterProtocol};
use pyo3::types::PyString;

#[pyclass]
struct MyClass {}

#[pyproto]
impl PyObjectProtocol for MyClass {
    fn __str__(&amp;self) -&gt; &amp;'static [u8] {
        b"hello, world"
    }
}

#[pyproto]
impl PyIterProtocol for MyClass {
    fn __iter__(slf: PyRef&lt;self&gt;) -&gt; PyResult&lt;&amp;PyAny&gt; {
        PyString::new(slf.py(), "hello, world").iter()
    }
}</code></pre>
<p>ä¹‹åï¼š</p>
<pre><code class="language-rust compile_fail">use pyo3::prelude::*;
use pyo3::types::PyString;

#[pyclass]
struct MyClass {}

#[pymethods]
impl MyClass {
    fn __str__(&amp;self) -&gt; &amp;'static [u8] {
        b"hello, world"
    }

    fn __iter__(slf: PyRef&lt;self&gt;) -&gt; PyResult&lt;&amp;PyAny&gt; {
        PyString::new(slf.py(), "hello, world").iter()
    }
}</code></pre>
</details>
<h3 id="ç§»é™¤äº†å¯¹è±¡åŒ…è£…å™¨çš„-partialeq-å®ç°"><a class="header" href="#ç§»é™¤äº†å¯¹è±¡åŒ…è£…å™¨çš„-partialeq-å®ç°">ç§»é™¤äº†å¯¹è±¡åŒ…è£…å™¨çš„ <code>PartialEq</code> å®ç°</a></h3>
<details>
<summary><small>ç‚¹å‡»å±•å¼€</small></summary>
<p>Python å¯¹è±¡åŒ…è£…å™¨ <code>Py</code> å’Œ <code>PyAny</code> åŸå…ˆå®ç°äº† <code>PartialEq</code>ï¼Œä½¿å¾— <code>object_a == object_b</code> å¯¹åº”äº Python ä¸­çš„ <code>is</code> æ“ä½œç¬¦ï¼ˆæŒ‡é’ˆç›¸ç­‰æ€§åˆ¤æ–­ï¼‰ï¼Œè€Œé <code>==</code> æ“ä½œç¬¦ã€‚æ­¤è¡Œä¸ºå·²è¢«ç§»é™¤ï¼Œå–è€Œä»£ä¹‹çš„æ˜¯æ–°æ–¹æ³•ï¼šåº”ä½¿ç”¨ <code>object_a.is(object_b)</code>ã€‚</p>
<p>è¿™ä¸€æ›´æ”¹è¿˜æœ‰ä¸€ä¸ªä¼˜åŠ¿ï¼šä¸å†è¦æ±‚ <code>object_a</code> å’Œ <code>object_b</code> å…·æœ‰ç›¸åŒçš„åŒ…è£…ç±»å‹ï¼Œä½ ç°åœ¨å¯ä»¥ç›´æ¥æ¯”è¾ƒ <code>Py&lt;T&gt;</code> å’Œ <code>&amp;PyAny</code>ï¼Œè€Œæ— éœ€è½¬æ¢ã€‚</p>
<p>è‹¥è¦æ£€æŸ¥ Python å¯¹è±¡çš„ç›¸ç­‰æ€§ï¼ˆå³ Python çš„ <code>==</code> æ“ä½œç¬¦ï¼‰ï¼Œè¯·ä½¿ç”¨æ–°æ–¹æ³• <code>eq()</code>ã€‚</p>
</details>
<h3 id="å®¹å™¨é­”æ³•æ–¹æ³•ç°åœ¨ä¸-python-è¡Œä¸ºä¸€è‡´"><a class="header" href="#å®¹å™¨é­”æ³•æ–¹æ³•ç°åœ¨ä¸-python-è¡Œä¸ºä¸€è‡´">å®¹å™¨é­”æ³•æ–¹æ³•ç°åœ¨ä¸ Python è¡Œä¸ºä¸€è‡´</a></h3>
<details>
<summary><small>ç‚¹å‡»å±•å¼€</small></summary>
<p>åœ¨ PyO3 0.15 ä¸­ï¼Œ<code>#[pymethods]</code> ä¸­çš„ <code>__getitem__</code>ã€<code>__setitem__</code> å’Œ <code>__delitem__</code> åªä¼šä¸º <code>#[pyclass]</code> ç”Ÿæˆ<strong>æ˜ å°„ï¼ˆmappingï¼‰</strong> çš„å®ç°ã€‚ä¸ºäº†ä¸ Python è¡Œä¸ºä¸€è‡´ï¼Œè¿™äº›æ–¹æ³•ç°åœ¨ä¼šåŒæ—¶ç”Ÿæˆ<strong>æ˜ å°„ï¼ˆmappingï¼‰</strong> å’Œ<strong>åºåˆ—ï¼ˆsequenceï¼‰</strong> çš„å®ç°ã€‚</p>
<p>è¿™æ„å‘³ç€å®ç°äº†è¿™äº› <code>#[pymethods]</code> çš„ç±»ç°åœ¨ä¹Ÿä¼šè¢«è§†ä¸ºåºåˆ—ï¼Œå°±åƒåŸç”Ÿ Python <code>class</code> ä¸€æ ·ã€‚è¿™å¯èƒ½å¯¼è‡´ä¸€äº›ç»†å¾®çš„è¡Œä¸ºå·®å¼‚ï¼š</p>
<ul>
<li>PyO3 å…è®¸å°†è¿™äº›ç±»çš„å®ä¾‹è½¬æ¢ä¸º <code>PySequence</code> å’Œ <code>PyMapping</code>ã€‚</li>
<li>Python ä¼šä¸ºè¿™ç±»ç±»æä¾›é»˜è®¤çš„ <code>__iter__</code> å®ç°ï¼ˆå¦‚æœç±»æœ¬èº«æœªå®šä¹‰ï¼‰ï¼Œè¯¥å®ç°ä¼šåå¤è°ƒç”¨ <code>__getitem__</code> å¹¶ä¼ å…¥æ•´æ•°ç´¢å¼•ï¼ˆä» 0 å¼€å§‹ï¼‰ï¼Œç›´åˆ°æŠ›å‡º <code>IndexError</code> ä¸ºæ­¢ã€‚</li>
</ul>
<p>è¯¦ç»†è¯´æ˜å¦‚ä¸‹ï¼Œè€ƒè™‘ä»¥ä¸‹ Python ç±»ï¼š</p>
<pre><code class="language-python">class ExampleContainer:

    def __len__(self):
        return 5

    def __getitem__(self, idx: int) -&gt; int:
        if idx &lt; 0 or idx &gt; 5:
            raise IndexError()
        return idx
</code></pre>
<p>è¯¥ç±»å®ç°äº†ä¸€ä¸ª Python <a href="https://docs.python.org/3/glossary.html#term-sequence">åºåˆ—</a>ã€‚</p>
<p><code>__len__</code> å’Œ <code>__getitem__</code> ä¹Ÿå¯ç”¨äºå®ç° Python <a href="https://docs.python.org/3/glossary.html#term-mapping">æ˜ å°„</a>ã€‚åœ¨ Python C-API ä¸­ï¼Œè¿™äº›æ–¹æ³•å¹¶ä¸å…±äº«ï¼šåºåˆ—çš„ <code>__len__</code> å’Œ <code>__getitem__</code> ç”± <code>sq_length</code> å’Œ <code>sq_item</code> æ§½ä½å®šä¹‰ï¼Œè€Œæ˜ å°„å¯¹åº”çš„åˆ™æ˜¯ <code>mp_length</code> å’Œ <code>mp_subscript</code>ã€‚<code>__setitem__</code> å’Œ <code>__delitem__</code> ä¹Ÿæœ‰ç±»ä¼¼çš„åŒºåˆ†ã€‚</p>
</details>å› ä¸º Python ä¸­æ²¡æœ‰è¿™æ ·çš„åŒºåˆ†ï¼Œå®ç°è¿™äº›æ–¹æ³•ä¼šåŒæ—¶å¡«å……æ˜ å°„ï¼ˆmappingï¼‰å’Œåºåˆ—ï¼ˆsequenceï¼‰çš„æ§½ä½ã€‚ä¾‹å¦‚ï¼Œä¸€ä¸ªå®ç°äº† `__len__` çš„ Python ç±»å°†åŒæ—¶å¡«å…… `sq_length` å’Œ `mp_length` æ§½ä½ã€‚
<p>PyO3 åœ¨ 0.16 ç‰ˆæœ¬ä¸­çš„é»˜è®¤è¡Œä¸ºå·²æ›´æ¥è¿‘äºè¿™ç§ Python è¡Œä¸ºã€‚</p>

<h3 id="wrap_pymodule-å’Œ-wrap_pyfunction-ç°åœ¨æ­£ç¡®åœ°éµå¾ªå¯è§æ€§è§„åˆ™"><a class="header" href="#wrap_pymodule-å’Œ-wrap_pyfunction-ç°åœ¨æ­£ç¡®åœ°éµå¾ªå¯è§æ€§è§„åˆ™"><code>wrap_pymodule!</code> å’Œ <code>wrap_pyfunction!</code> ç°åœ¨æ­£ç¡®åœ°éµå¾ªå¯è§æ€§è§„åˆ™</a></h3>
<details>
<summary><small>ç‚¹å‡»å±•å¼€</small></summary>
<p>åœ¨ PyO3 0.16 ä¹‹å‰ï¼Œ<code>wrap_pymodule!</code> å’Œ <code>wrap_pyfunction!</code> å®å¯ä»¥ä½¿ç”¨é‚£äº›æ ¹æ® Rust å¯è§æ€§è§„åˆ™æ— æ³•è®¿é—®çš„æ¨¡å—å’Œå‡½æ•°ã€‚</p>
<p>ä¾‹å¦‚ï¼Œä»¥ä¸‹ä»£ç åœ¨ 0.16 ç‰ˆæœ¬ä¹‹å‰æ˜¯åˆæ³•çš„ï¼Œä½†ä» 0.16 å¼€å§‹ä¼šè¢«æ‹’ç»ï¼Œå› ä¸º <code>wrap_pymodule!</code> å®æ— æ³•è®¿é—® <code>private_submodule</code> å‡½æ•°ï¼š</p>
<pre><code class="language-rust compile_fail">mod foo {
    use pyo3::prelude::*;

    #[pymodule]
    fn private_submodule(_py: Python&lt;'_&gt;, m: &amp;PyModule) -&gt; PyResult&lt;()&gt; {
        Ok(())
    }
}

use pyo3::prelude::*;
use foo::*;

#[pymodule]
fn my_module(_py: Python&lt;'_&gt;, m: &amp;PyModule) -&gt; PyResult&lt;()&gt; {
    m.add_wrapped(wrap_pymodule!(private_submodule))?;
    Ok(())
}</code></pre>
<p>è¦ä¿®å¤æ­¤é—®é¢˜ï¼Œè¯·ä½¿ç§æœ‰å­æ¨¡å—å¯è§ï¼Œä¾‹å¦‚ä½¿ç”¨ <code>pub</code> æˆ– <code>pub(crate)</code>ã€‚</p>
<pre><code class="language-rust ignore">mod foo {
    use pyo3::prelude::*;

    #[pymodule]
    pub(crate) fn private_submodule(_py: Python&lt;'_&gt;, m: &amp;PyModule) -&gt; PyResult&lt;()&gt; {
        Ok(())
    }
}

use pyo3::prelude::*;
use pyo3::wrap_pymodule;
use foo::*;

#[pymodule]
fn my_module(_py: Python&lt;'_&gt;, m: &amp;PyModule) -&gt; PyResult&lt;()&gt; {
    m.add_wrapped(wrap_pymodule!(private_submodule))?;
    Ok(())
}</code></pre>
</details>
<h2 id="ä»-014-å‡çº§åˆ°-015"><a class="header" href="#ä»-014-å‡çº§åˆ°-015">ä» 0.14.* å‡çº§åˆ° 0.15</a></h2>
<h3 id="åºåˆ—ç´¢å¼•çš„å˜æ›´"><a class="header" href="#åºåˆ—ç´¢å¼•çš„å˜æ›´">åºåˆ—ç´¢å¼•çš„å˜æ›´</a></h3>
<details>
<summary><small>ç‚¹å‡»å±•å¼€</small></summary>
<p>å¯¹äºæ‰€æœ‰æ¥å—åºåˆ—ç´¢å¼•çš„ç±»å‹ï¼ˆ<code>PyList</code>ã€<code>PyTuple</code> å’Œ <code>PySequence</code>ï¼‰ï¼ŒAPI å·²ç»Ÿä¸€ä¸ºä»…æ¥å— <code>usize</code> ç±»å‹çš„ç´¢å¼•ï¼Œä»¥ç¬¦åˆ Rust çš„ç´¢å¼•æƒ¯ä¾‹ã€‚ä¹‹å‰å³ä½¿åœ¨æ”¯æŒ <code>isize</code> çš„ API ä¸­ä¹Ÿä»…éƒ¨åˆ†æ”¯æŒè´Ÿæ•°ç´¢å¼•ï¼Œç°åœ¨è¿™äº› API å‡ä¸å†æ”¯æŒè´Ÿæ•°ç´¢å¼•ã€‚</p>
<p>æ­¤å¤–ï¼Œ<code>get_item</code> æ–¹æ³•ç°åœ¨åœ¨ç´¢å¼•æ— æ•ˆæ—¶æ€»æ˜¯è¿”å› <code>PyResult</code>ï¼Œè€Œä¸å†å¼•å‘ panicã€‚<code>Index</code> trait å·²è¢«å®ç°ï¼Œæä¾›äº†ä¸ Rust å‘é‡ç›¸åŒçš„ panic è¡Œä¸ºã€‚</p>
<p>è¯·æ³¨æ„ï¼Œ<em>åˆ‡ç‰‡</em> ç´¢å¼•ï¼ˆå¦‚ <code>PySequence::get_slice</code> ç­‰æ–¹æ³•æ‰€æ¥å—ï¼‰ä»ç»§æ‰¿ Python çš„è¡Œä¸ºï¼šç´¢å¼•ä¼šè¢«é™åˆ¶åœ¨å®é™…é•¿åº¦èŒƒå›´å†…ï¼Œè¶…å‡ºèŒƒå›´ä¹Ÿä¸ä¼š panic æˆ–è¿”å›é”™è¯¯ã€‚</p>
<p>å¯¹è¿™äº›ç±»å‹é‡‡ç”¨ Rust çš„ç´¢å¼•çº¦å®šçš„å¦ä¸€ä¸ªå¥½å¤„æ˜¯ï¼Œå®ƒä»¬ç°åœ¨ä¹Ÿå¯ä»¥ä½œä¸ºç»Ÿä¸€ API çš„ä¸€éƒ¨åˆ†ï¼Œæ”¯æŒ Rust çš„ç´¢å¼•æ“ä½œç¬¦ï¼š</p>
<pre><code class="language-rust ignore">#![allow(deprecated)]
use pyo3::{Python, types::PyList};

Python::with_gil(|py| {
    let list = PyList::new(py, &amp;[1, 2, 3]);
    assert_eq!(list[0..2].to_string(), "[1, 2]");
});</code></pre>
</details>
<h2 id="ä»-013-å‡çº§åˆ°-014"><a class="header" href="#ä»-013-å‡çº§åˆ°-014">ä» 0.13.* å‡çº§åˆ° 0.14</a></h2>
<h3 id="auto-initialize-åŠŸèƒ½ç°åœ¨éœ€è¦æ˜¾å¼å¯ç”¨"><a class="header" href="#auto-initialize-åŠŸèƒ½ç°åœ¨éœ€è¦æ˜¾å¼å¯ç”¨"><code>auto-initialize</code> åŠŸèƒ½ç°åœ¨éœ€è¦æ˜¾å¼å¯ç”¨</a></h3>
<details>
<summary><small>ç‚¹å‡»å±•å¼€</small></summary>
<p>å¯¹äºåœ¨ Rust ä¸­åµŒå…¥ Python çš„é¡¹ç›®ï¼Œé™¤éå¯ç”¨äº† <a href="#auto-initialize"><code>auto-initialize</code> åŠŸèƒ½</a>ï¼Œå¦åˆ™ PyO3 ä¸å†åœ¨é¦–æ¬¡è°ƒç”¨ <code>Python::with_gil</code>ï¼ˆæˆ– <code>Python::acquire_gil</code>ï¼‰æ—¶è‡ªåŠ¨åˆå§‹åŒ– Python è§£é‡Šå™¨ã€‚</p>
</details>
<h3 id="æ–°å¢-multiple-pymethods-åŠŸèƒ½"><a class="header" href="#æ–°å¢-multiple-pymethods-åŠŸèƒ½">æ–°å¢ <code>multiple-pymethods</code> åŠŸèƒ½</a></h3>
<details>
<summary><small>ç‚¹å‡»å±•å¼€</small></summary>
<p><code>#[pymethods]</code> å·²ç»è¿‡é‡æ„ï¼Œé‡‡ç”¨æ›´ç®€å•çš„é»˜è®¤å®ç°ï¼Œç§»é™¤äº†å¯¹ <code>inventory</code> crate çš„ä¾èµ–ã€‚è¿™å‡å°‘äº†å¤§å¤šæ•°ç”¨æˆ·çš„ä¾èµ–é¡¹å’Œç¼–è¯‘æ—¶é—´ã€‚</p>
<p>æ–°é»˜è®¤å®ç°çš„é™åˆ¶æ˜¯æ— æ³•æ”¯æŒåŒä¸€ <code>#[pyclass]</code> æœ‰å¤šä¸ª <code>#[pymethods]</code> å—ã€‚å¦‚æœéœ€è¦è¯¥åŠŸèƒ½ï¼Œå¿…é¡»å¯ç”¨ <code>multiple-pymethods</code> åŠŸèƒ½ï¼Œä»¥åˆ‡æ¢å›åŸºäº <code>inventory</code> çš„å®ç°ã€‚</p>
</details>
<h3 id="å·²å¼ƒç”¨çš„-pyproto-æ–¹æ³•"><a class="header" href="#å·²å¼ƒç”¨çš„-pyproto-æ–¹æ³•">å·²å¼ƒç”¨çš„ <code>#[pyproto]</code> æ–¹æ³•</a></h3>
<details>
<summary><small>ç‚¹å‡»å±•å¼€</small></summary>
<p>ä¸€äº›åè®®æ–¹æ³•ï¼ˆå³ <code>__dunder__</code> æ–¹æ³•ï¼‰ï¼Œä¾‹å¦‚ <code>__bytes__</code> å’Œ <code>__format__</code>ï¼Œé•¿æœŸä»¥æ¥å¯ä»¥é€šè¿‡ä¸¤ç§æ–¹å¼åœ¨ PyO3 ä¸­å®ç°ï¼šä½¿ç”¨ <code>#[pyproto]</code>ï¼ˆä¾‹å¦‚æœ¬å¤„åˆ—å‡ºçš„æ–¹æ³•å¯¹åº”çš„ <code>PyObjectProtocol</code>ï¼‰ï¼Œæˆ–ç›´æ¥åœ¨ <code>#[pymethods]</code> ä¸­ç¼–å†™ã€‚ä½†è¿™ç§æƒ…å†µä»…é€‚ç”¨äºå°‘æ•°å‡ ä¸ª <code>#[pyproto]</code> æ–¹æ³•ï¼ˆç”±äº PyO3 å½“å‰ä¸ Python C API äº¤äº’çš„æŠ€æœ¯åŸå› ï¼‰ã€‚</p>
<p>ä¸ºäº†åšæŒâ€œä¸€ç§æ˜ç¡®çš„æ–¹æ³•åšä¸€ä»¶äº‹â€çš„åŸåˆ™ï¼Œè¿™äº›æ–¹æ³•çš„ <code>#[pyproto]</code> å½¢å¼å·²è¢«å¼ƒç”¨ã€‚</p>
<p>è¿ç§»æ–¹æ³•æ˜¯å°†å—å½±å“çš„æ–¹æ³•ä» <code>#[pyproto]</code> å—ç§»è‡³ <code>#[pymethods]</code> å—å³å¯ã€‚</p>
<p>ä¹‹å‰ï¼š</p>
<pre><code class="language-rust compile_fail">use pyo3::prelude::*;
use pyo3::class::basic::PyObjectProtocol;

#[pyclass]
struct MyClass {}

#[pyproto]
impl PyObjectProtocol for MyClass {
    fn __bytes__(&amp;self) -&gt; &amp;'static [u8] {
        b"hello, world"
    }
}</code></pre>
<p>ä¹‹åï¼š</p>
<pre><code class="language-rust no_run">use pyo3::prelude::*;

#[pyclass]
struct MyClass {}

#[pymethods]
impl MyClass {
    fn __bytes__(&amp;self) -&gt; &amp;'static [u8] {
        b"hello, world"
    }
}</code></pre>
</details>
<h2 id="ä»-012-å‡çº§åˆ°-013"><a class="header" href="#ä»-012-å‡çº§åˆ°-013">ä» 0.12.* å‡çº§åˆ° 0.13</a></h2>
<h3 id="æœ€ä½-rust-ç‰ˆæœ¬å‡çº§è‡³-rust-145"><a class="header" href="#æœ€ä½-rust-ç‰ˆæœ¬å‡çº§è‡³-rust-145">æœ€ä½ Rust ç‰ˆæœ¬å‡çº§è‡³ Rust 1.45</a></h3>
<details>
<summary><small>ç‚¹å‡»å±•å¼€</small></summary>
<p>PyO3 <code>0.13</code> ä½¿ç”¨äº†åœ¨ Rust 1.40 è‡³ 1.45 ä¹‹é—´ç¨³å®šçš„æ–° Rust è¯­è¨€ç‰¹æ€§ã€‚å¦‚æœä½ ä½¿ç”¨çš„ Rust ç¼–è¯‘å™¨æ—©äº 1.45 ç‰ˆæœ¬ï¼Œåˆ™å¿…é¡»æ›´æ–°å·¥å…·é“¾æ‰èƒ½ç»§ç»­ä½¿ç”¨ PyO3ã€‚</p>
</details>
<h3 id="è¿è¡Œæ—¶å˜æ›´ä»¥æ”¯æŒ-cpython-æœ‰é™-api"><a class="header" href="#è¿è¡Œæ—¶å˜æ›´ä»¥æ”¯æŒ-cpython-æœ‰é™-api">è¿è¡Œæ—¶å˜æ›´ä»¥æ”¯æŒ CPython æœ‰é™ API</a></h3>
<details>
<summary><small>ç‚¹å‡»å±•å¼€</small></summary>
<p>åœ¨ PyO3 <code>0.13</code> ä¸­å¢åŠ äº†å¯¹ç¼–è¯‘ CPython æœ‰é™ API çš„æ”¯æŒã€‚è¿™å¯¹æ‰€æœ‰ PyO3 ç”¨æˆ·éƒ½äº§ç”Ÿäº†ä¸€äº›å½±å“ï¼Œå…·ä½“å¦‚ä¸‹ã€‚</p>
<p>å…¶ä¸­æœ€å¤§çš„ä¸€ç‚¹æ˜¯ï¼Œæ‰€æœ‰ç”± PyO3 åˆ›å»ºçš„ç±»å‹ç°åœ¨éƒ½æ˜¯ CPython æ‰€ç§°çš„â€œå †ç±»å‹â€ï¼ˆheap typesï¼‰ã€‚å…¶å…·ä½“å½±å“åŒ…æ‹¬ï¼š</p>
<ul>
<li>å¦‚æœä½ æƒ³ä» Rust å­ç±»åŒ–è¿™äº›ç±»å‹ï¼Œå¿…é¡»ä½¿ç”¨ <code>#[pyclass(subclass)]</code> æ ‡è®°å®ƒä»¬ï¼Œå°±åƒä½ æƒ³å…è®¸ä» Python ä»£ç ä¸­å­ç±»åŒ–å®ƒä»¬ä¸€æ ·ã€‚</li>
<li>ç±»å‹å¯¹è±¡ç°åœ¨æ˜¯å¯å˜çš„â€”â€”Python ä»£ç å¯ä»¥ä¸ºå…¶è®¾ç½®å±æ€§ã€‚</li>
<li>å¯¹äºæœªä½¿ç”¨ <code>#[pyclass(module="mymodule")]</code> çš„ç±»å‹ï¼Œå…¶ <code>__module__</code> ä¸å†è¿”å› <code>builtins</code>ï¼Œè€Œæ˜¯ä¼šå¼•å‘ <code>AttributeError</code>ã€‚</li>
</ul>
</details>
<h2 id="ä»-011-å‡çº§åˆ°-012"><a class="header" href="#ä»-011-å‡çº§åˆ°-012">ä» 0.11.* å‡çº§åˆ° 0.12</a></h2>
<h3 id="pyerr-å·²ç»è¿‡é‡æ„"><a class="header" href="#pyerr-å·²ç»è¿‡é‡æ„"><code>PyErr</code> å·²ç»è¿‡é‡æ„</a></h3>
<details>
<summary><small>ç‚¹å‡»å±•å¼€</small></summary>
<p>åœ¨ PyO3 <code>0.12</code> ä¸­ï¼Œ<code>PyErr</code> ç±»å‹è¢«é‡æ–°å®ç°ï¼Œä»¥æ›´å¥½åœ°ä¸æ ‡å‡† Rust é”™è¯¯å¤„ç†ç”Ÿæ€ç³»ç»Ÿå…¼å®¹ã€‚å…·ä½“è€Œè¨€ï¼Œ<code>PyErr</code> ç°åœ¨å®ç°äº† <code>Error + Send + Sync</code>ï¼Œè¿™æ˜¯ Rust ä¸­é”™è¯¯ç±»å‹çš„æ ‡å‡† traitã€‚</p>
<p>å°½ç®¡è¿™å¯¼è‡´ä¸€äº› API è¢«ç§»é™¤ï¼Œä½†æ–°çš„ <code>PyErr</code> ç±»å‹ç°åœ¨åº”è¯¥æ›´å®¹æ˜“ä½¿ç”¨ã€‚ä»¥ä¸‹éƒ¨åˆ†è¯¦ç»†åˆ—å‡ºäº†å˜æ›´å†…å®¹ä»¥åŠå¦‚ä½•è¿ç§»åˆ°æ–° APIã€‚</p>
</details>
<h4 id="pyerrnew-å’Œ-pyerrfrom_type-ç°åœ¨è¦æ±‚å…¶å‚æ•°å®ç°-send--sync"><a class="header" href="#pyerrnew-å’Œ-pyerrfrom_type-ç°åœ¨è¦æ±‚å…¶å‚æ•°å®ç°-send--sync"><code>PyErr::new</code> å’Œ <code>PyErr::from_type</code> ç°åœ¨è¦æ±‚å…¶å‚æ•°å®ç° <code>Send + Sync</code></a></h4>
<details>
<summary><small>ç‚¹å‡»å±•å¼€</small></summary>
<p>å¯¹å¤§å¤šæ•°ä½¿ç”¨åœºæ™¯è€Œè¨€æ— éœ€ä¿®æ”¹ã€‚å¦‚æœä½ å°è¯•ç”¨ä¸€ä¸ªä¸æ»¡è¶³ <code>Send + Sync</code> çš„å€¼æ„é€  <code>PyErr</code>ï¼Œä½ éœ€è¦å…ˆåˆ›å»º Python å¯¹è±¡ï¼Œç„¶åä½¿ç”¨ <code>PyErr::from_instance</code>ã€‚</p>
<p>ç±»ä¼¼åœ°ï¼Œä»»ä½•å®ç°äº† <code>PyErrArguments</code> çš„ç±»å‹ç°åœ¨ä¹Ÿå¿…é¡»æ»¡è¶³ <code>Send + Sync</code>ã€‚</p>
</details>
<h4 id="pyerr-çš„å†…éƒ¨å­—æ®µç°åœ¨ä¸ºç§æœ‰"><a class="header" href="#pyerr-çš„å†…éƒ¨å­—æ®µç°åœ¨ä¸ºç§æœ‰"><code>PyErr</code> çš„å†…éƒ¨å­—æ®µç°åœ¨ä¸ºç§æœ‰</a></h4>
<details>
<summary><small>ç‚¹å‡»å±•å¼€</small></summary>
<p>ä¸å†å…è®¸ç›´æ¥è®¿é—® <code>PyErr</code> çš„ <code>.ptype</code>ã€<code>.pvalue</code> å’Œ <code>.ptraceback</code> å­—æ®µã€‚ä½ åº”è¯¥æ”¹ç”¨æ–°çš„æ–¹æ³• <code>PyErr::ptype</code>ã€<code>PyErr::pvalue</code> å’Œ <code>PyErr::ptraceback</code>ã€‚</p>
</details>
<h4 id="pyerrvalue-å’Œ-pyerrfrom_value-å·²è¢«ç§»é™¤"><a class="header" href="#pyerrvalue-å’Œ-pyerrfrom_value-å·²è¢«ç§»é™¤"><code>PyErrValue</code> å’Œ <code>PyErr::from_value</code> å·²è¢«ç§»é™¤</a></h4>
<details>
<summary><small>ç‚¹å‡»å±•å¼€</small></summary>
<p>ç”±äºè¿™äº› API å±äºå·²è¢«é‡æ„çš„ <code>PyErr</code> å†…éƒ¨æœºåˆ¶ï¼Œå› æ­¤ä¸å†å­˜åœ¨ã€‚</p>
<p>å¦‚æœä½ æ›¾ä½¿ç”¨è¿™äº› APIï¼Œå»ºè®®æ”¹ç”¨ <code>PyException::new_err</code>ï¼ˆè§ <a href="#exception-types-have-been-reworked">å¼‚å¸¸ç±»å‹é‡æ„éƒ¨åˆ†</a>ï¼‰ã€‚</p>
</details>
<h4 id="ç§»é™¤äº†-pyerr-åˆ°-pyresultt-çš„-into-å®ç°"><a class="header" href="#ç§»é™¤äº†-pyerr-åˆ°-pyresultt-çš„-into-å®ç°">ç§»é™¤äº† <code>PyErr</code> åˆ° <code>PyResult&lt;T&gt;</code> çš„ <code>Into</code> å®ç°</a></h4>
<details>
<summar y=""><small>ç‚¹å‡»å±•å¼€</small>
<p>è¯¥å®ç°æ˜¯å†—ä½™çš„ã€‚è¯·ç›´æ¥æ„é€  <code>Result::Err</code> å˜ä½“å³å¯ã€‚</p>
<p>ä¹‹å‰ï¼š</p>
<pre><code class="language-rust compile_fail">let result: PyResult&lt;()&gt; = PyErr::new::&lt;TypeError, _&gt;("error message").into();</code></pre>
<p>ä¹‹åï¼ˆåŒæ—¶ä½¿ç”¨é‡æ„åçš„å¼‚å¸¸ç±»å‹ï¼›è§ä¸‹ä¸€éƒ¨åˆ†ï¼‰ï¼š</p>
<pre><code class="language-rust no_run"><span class="boring">use pyo3::{PyResult, exceptions::PyTypeError};
</span>let result: PyResult&lt;()&gt; = Err(PyTypeError::new_err("error message"));</code></pre>

<h3 id="å¼‚å¸¸ç±»å‹å·²é‡æ„"><a class="header" href="#å¼‚å¸¸ç±»å‹å·²é‡æ„">å¼‚å¸¸ç±»å‹å·²é‡æ„</a></h3>
<details>
<summary><small>ç‚¹å‡»å±•å¼€</small></summary>
<p>ä»¥å‰å¼‚å¸¸ç±»å‹æ˜¯é›¶å¤§å°çš„æ ‡è®°ç±»å‹ï¼Œä»…ç”¨äºæ„é€  <code>PyErr</code>ã€‚åœ¨ PyO3 0.12 ä¸­ï¼Œè¿™äº›ç±»å‹å·²è¢«æ›¿æ¢ä¸ºå®Œæ•´å®šä¹‰ï¼Œå¯ä»¥åƒ <code>PyAny</code>ã€<code>PyDict</code> ç­‰ä¸€æ ·ä½¿ç”¨ã€‚è¿™ä½¿å¾—èƒ½å¤Ÿä¸ Python å¼‚å¸¸å¯¹è±¡è¿›è¡Œäº¤äº’ã€‚</p>
<p>æ–°ç±»å‹çš„åç§°å‡ä»¥ â€œPyâ€ ä¸ºå‰ç¼€ã€‚ä¾‹å¦‚ï¼Œä¹‹å‰ï¼š</p>
<pre><code class="language-rust ignore">let err: PyErr = TypeError::py_err("error message");</code></pre>
<p>ä¹‹åï¼š</p>
<pre><code class="language-rust ignore"><span class="boring">use pyo3::{PyErr, PyResult, Python, type_object::PyTypeObject};
</span><span class="boring">use pyo3::exceptions::{PyBaseException, PyTypeError};
</span><span class="boring">Python::with_gil(|py| -&gt; PyResult&lt;()&gt; {
</span>let err: PyErr = PyTypeError::new_err("error message");

// ä½¿ç”¨ PyErr çš„ Display ç‰¹æ€§ï¼ŒPyO3 0.12 çš„æ–°åŠŸèƒ½
assert_eq!(err.to_string(), "TypeError: error message");

// ç°åœ¨å¯ä»¥ä¸å¼‚å¸¸å®ä¾‹äº¤äº’ï¼ŒPyO3 0.12 çš„æ–°åŠŸèƒ½
let instance: &amp;PyBaseException = err.instance(py);
assert_eq!(
    instance.getattr("__class__")?,
    PyTypeError::type_object(py).as_ref()
);
<span class="boring">Ok(())
</span><span class="boring">}).unwrap();</span></code></pre>
</details>
<h3 id="frompy-å·²è¢«ç§»é™¤"><a class="header" href="#frompy-å·²è¢«ç§»é™¤"><code>FromPy</code> å·²è¢«ç§»é™¤</a></h3>
<details>
<summary><small>ç‚¹å‡»å±•å¼€</small></summary>
<p>ä¸ºäº†ç®€åŒ– PyO3 çš„è½¬æ¢ traitï¼Œ<code>FromPy</code> trait å·²è¢«ç§»é™¤ã€‚ä»¥å‰æœ‰ä¸¤ç§æ–¹å¼å®šä¹‰ç±»å‹çš„è½¬ Python è½¬æ¢ï¼š<code>FromPy&lt;T&gt; for PyObject</code> å’Œ <code>IntoPy&lt;PyObject&gt; for T</code>ã€‚</p>
<p>ç°åœ¨å®šä¹‰è½¬æ¢çš„å”¯ä¸€æ–¹å¼æ˜¯ <code>IntoPy</code>ï¼Œå› æ­¤ä¸‹æ¸¸ crate å¯èƒ½éœ€è¦ç›¸åº”è°ƒæ•´ã€‚</p>
<p>ä¹‹å‰ï¼š</p>
<pre><code class="language-rust compile_fail"><span class="boring">use pyo3::prelude::*;
</span>struct MyPyObjectWrapper(PyObject);


impl FromPy&lt;MyPyObjectWrapper&gt; for PyObject {
    fn from_py(other: MyPyObjectWrapper, _py: Python&lt;'_&gt;) -&gt; Self {
        other.0
    }
}</code></pre>
<p>ä¹‹åï¼š</p>
<pre><code class="language-rust ignore"><span class="boring">use pyo3::prelude::*;
</span><span class="boring">#[allow(dead_code)]
</span>struct MyPyObjectWrapper(PyObject);


<span class="boring">#[allow(deprecated)]
</span>impl IntoPy&lt;PyObject&gt; for MyPyObjectWrapper {
    fn into_py(self, _py: Python&lt;'_&gt;) -&gt; PyObject {
        self.0
    }
}</code></pre>
<p>åŒæ ·ï¼Œä½¿ç”¨ <code>FromPy</code> trait çš„ä»£ç å¯ä»¥è½»æ¾é‡å†™ä¸ºä½¿ç”¨ <code>IntoPy</code>ã€‚</p>
<p>ä¹‹å‰ï¼š</p>
<pre><code class="language-rust compile_fail"><span class="boring">use pyo3::prelude::*;
</span><span class="boring">Python::with_gil(|py| {
</span>let obj = PyObject::from_py(1.234, py);
<span class="boring">})</span></code></pre>
<p>ä¹‹åï¼š</p>
<pre><code class="language-rust ignore"><span class="boring">#![allow(deprecated)]
</span><span class="boring">use pyo3::prelude::*;
</span><span class="boring">Python::with_gil(|py| {
</span>let obj: PyObject = 1.234.into_py(py);
<span class="boring">})</span></code></pre>
</details>
<h3 id="pyobject-ç°åœ¨æ˜¯-pypyany-çš„ç±»å‹åˆ«å"><a class="header" href="#pyobject-ç°åœ¨æ˜¯-pypyany-çš„ç±»å‹åˆ«å"><code>PyObject</code> ç°åœ¨æ˜¯ <code>Py&lt;PyAny&gt;</code> çš„ç±»å‹åˆ«å</a></h3>
<details>
<summary><small>ç‚¹å‡»å±•å¼€</small></summary>
<p>ä»ä½¿ç”¨è§’åº¦æ¥çœ‹ï¼Œè¿™ä¸€æ”¹åŠ¨å½±å“æå°ã€‚å¦‚æœä½ æ›¾ä¸º <code>PyObject</code> å’Œ <code>Py&lt;T&gt;</code> éƒ½å®ç°äº† traitï¼Œç°åœ¨å¯èƒ½åªéœ€è¦ç§»é™¤ <code>PyObject</code> çš„å®ç°å³å¯ã€‚</p>
</details>
<h3 id="aspyref-å·²è¢«ç§»é™¤"><a class="header" href="#aspyref-å·²è¢«ç§»é™¤"><code>AsPyRef</code> å·²è¢«ç§»é™¤</a></h3>
<details>
<summary><small>ç‚¹å‡»å±•å¼€</small></summary>
<p>ç”±äº <code>PyObject</code> ç°åœ¨åªæ˜¯ä¸€ä¸ªç±»å‹åˆ«åï¼Œ<code>AsPyRef</code> å”¯ä¸€å‰©ä¸‹çš„å®ç°è€…æ˜¯ <code>Py&lt;T&gt;</code>ã€‚å› æ­¤ä¸å†éœ€è¦è¯¥ traitï¼Œ<code>AsPyRef::as_ref</code> æ–¹æ³•å·²ç›´æ¥ç§»è‡³ <code>Py::as_ref</code>ã€‚</p>
<p>é™¤äº†ç§»é™¤æœªä½¿ç”¨ <code>pyo3::prelude::*</code> çš„ä»£ç ä¸­çš„ <code>use pyo3::AsPyRef</code> å¤–ï¼Œåº”æ— éœ€å…¶ä»–ä»£ç ä¿®æ”¹ã€‚</p>
<p>ä¹‹å‰ï¼š</p>
<pre><code class="language-rust ignore">use pyo3::{AsPyRef, Py, types::PyList};
<span class="boring">pyo3::Python::with_gil(|py| {
</span>let list_py: Py&lt;PyList&gt; = PyList::empty(py).into();
let list_ref: &amp;PyList = list_py.as_ref(py);
<span class="boring">})</span></code></pre>
<p>ä¹‹åï¼š</p>
<pre><code class="language-rust ignore">use pyo3::{Py, types::PyList};
<span class="boring">pyo3::Python::with_gil(|py| {
</span>let list_py: Py&lt;PyList&gt; = PyList::empty(py).into();
let list_ref: &amp;PyList = list_py.as_ref(py);
<span class="boring">})</span></code></pre>
</details>
<h2 id="ä»-010-å‡çº§åˆ°-011"><a class="header" href="#ä»-010-å‡çº§åˆ°-011">ä» 0.10.* å‡çº§åˆ° 0.11</a></h2>
<h3 id="ç¨³å®šç‰ˆ-rust"><a class="header" href="#ç¨³å®šç‰ˆ-rust">ç¨³å®šç‰ˆ Rust</a></h3>
<details>
<summary><small>ç‚¹å‡»å±•å¼€</small></summary>
<p>PyO3 ç°åœ¨æ”¯æŒç¨³å®šçš„ Rust å·¥å…·é“¾ã€‚æœ€ä½è¦æ±‚ç‰ˆæœ¬ä¸º 1.39.0ã€‚</p>
</details>
<h3 id="pyclass-ç»“æ„ä½“ç°åœ¨å¿…é¡»æ˜¯-send-æˆ–æ ‡è®°ä¸º-unsendable"><a class="header" href="#pyclass-ç»“æ„ä½“ç°åœ¨å¿…é¡»æ˜¯-send-æˆ–æ ‡è®°ä¸º-unsendable"><code>#[pyclass]</code> ç»“æ„ä½“ç°åœ¨å¿…é¡»æ˜¯ <code>Send</code> æˆ–æ ‡è®°ä¸º <code>unsendable</code></a></h3>
<details>
<summary><small>ç‚¹å‡»å±•å¼€</small></summary>
<p>ç”±äº Python è§£é‡Šå™¨å¯ä»¥åœ¨çº¿ç¨‹é—´ä¼ é€’ <code>#[pyclass]</code> ç»“æ„ä½“ï¼Œå®ƒä»¬å¿…é¡»å®ç° <code>Send</code> æˆ–è¢«å£°æ˜ä¸º <code>unsendable</code>ï¼ˆé€šè¿‡ <code>#[pyclass(unsendable)]</code>ï¼‰ã€‚æ³¨æ„ <code>unsendable</code> æ˜¯åœ¨ PyO3 <code>0.11.1</code> ä¸­æ·»åŠ çš„ï¼Œåœ¨ PyO3 <code>0.11.0</code> ä¸­å§‹ç»ˆè¦æ±‚ <code>Send</code>ã€‚</p>
<p>è¿™å¯èƒ½ä¼šâ€œç ´åâ€ä¸€äº›ä¹‹å‰å¯ä»¥ç¼–è¯‘ä½†å®é™…ä¸Šæ˜¯ä¸å®‰å…¨çš„ä»£ç ã€‚æœ‰ä¸¤ç§ä¿®å¤æ–¹å¼ï¼š</p>
<ol>
<li>
<p>å¦‚æœä½ è®¤ä¸ºä½ çš„ <code>#[pyclass]</code> ç¡®å®åº”è¯¥æ˜¯å¯ <code>Send</code> çš„ï¼Œè¯·å®ç° <code>Send</code>ã€‚ä¸€ç§å¸¸è§ä¸”æ›´å®‰å…¨çš„æ–¹æ³•æ˜¯ä½¿ç”¨çº¿ç¨‹å®‰å…¨ç±»å‹ã€‚ä¾‹å¦‚ï¼Œç”¨ <code>Arc</code> æ›¿ä»£ <code>Rc</code>ï¼Œç”¨ <code>Mutex</code> æ›¿ä»£ <code>RefCell</code>ï¼Œç”¨ <code>Box&lt;dyn Send + T&gt;</code> æ›¿ä»£ <code>Box&lt;dyn T&gt;</code>ã€‚</p>
<p>ä¹‹å‰ï¼š</p>
<pre><code class="language-rust compile_fail">use pyo3::prelude::*;
use std::rc::Rc;
use std::cell::RefCell;

#[pyclass]
struct NotThreadSafe {
    shared_bools: Rc&lt;RefCell&lt;Vec&lt;bool&gt;&gt;&gt;,
    closure: Box&lt;dyn Fn()&gt;,
}</code></pre>
<p>ä¹‹åï¼š</p>
<pre><code class="language-rust ignore"><span class="boring">#![allow(dead_code)]
</span>use pyo3::prelude::*;
use std::sync::{Arc, Mutex};

#[pyclass]
struct ThreadSafe {
    shared_bools: Arc&lt;Mutex&lt;Vec&lt;bool&gt;&gt;&gt;,
    closure: Box&lt;dyn Fn() + Send&gt;,
}</code></pre>
<p>å¦‚æœä½ æ— æ³•æ›´æ”¹ <code>#[pyclass]</code> ä»¥è‡ªåŠ¨å®ç° <code>Send</code>ï¼ˆä¾‹å¦‚ï¼Œå½“å®ƒåŒ…å«è£¸æŒ‡é’ˆæ—¶ï¼‰ï¼Œå¯ä»¥ä½¿ç”¨ <code>unsafe impl Send</code>ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œéœ€ç¡®ä¿ç»“æ„ä½“å®é™…ä¸Šæ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚æ›´å¤šä¿¡æ¯è¯·å‚è§ <a href="https://doc.rust-lang.org/nomicon/send-and-sync.html">the Rustonomicon</a>ã€‚</p>
</li>
<li>
<p>å¦‚æœä½ è®¤ä¸ºä½ çš„ <code>#[pyclass]</code> ä¸åº”è¢«å…¶ä»–çº¿ç¨‹è®¿é—®ï¼Œå¯ä»¥ä½¿ç”¨ <code>unsendable</code> æ ‡å¿—ã€‚æ ‡è®°ä¸º <code>unsendable</code> çš„ç±»åœ¨è¢«å…¶ä»–çº¿ç¨‹è®¿é—®æ—¶ä¼š panicï¼Œä»è€Œä½¿å‘ Python è§£é‡Šå™¨æš´éœ²ä¸å¯å‘é€å¯¹è±¡æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚</p>
<p>ä¹‹å‰ï¼š</p>
<pre><code class="language-rust compile_fail">use pyo3::prelude::*;

#[pyclass]
struct Unsendable {
    pointers: Vec&lt;*mut std::ffi::c_char&gt;,
}</code></pre>
<p>ä¹‹åï¼š</p>
<pre><code class="language-rust no_run"><span class="boring">#![allow(dead_code)]
</span>use pyo3::prelude::*;

#[pyclass(unsendable)]
struct Unsendable {
    pointers: Vec&lt;*mut std::ffi::c_char&gt;,
}</code></pre>
</li>
</ol>
</details>
<h3 id="æ‰€æœ‰-pyobject-å’Œ-pyt-æ–¹æ³•ç°åœ¨éƒ½éœ€è¦-python-ä½œä¸ºå‚æ•°"><a class="header" href="#æ‰€æœ‰-pyobject-å’Œ-pyt-æ–¹æ³•ç°åœ¨éƒ½éœ€è¦-python-ä½œä¸ºå‚æ•°">æ‰€æœ‰ <code>PyObject</code> å’Œ <code>Py&lt;T&gt;</code> æ–¹æ³•ç°åœ¨éƒ½éœ€è¦ <code>Python</code> ä½œä¸ºå‚æ•°</a></h3>
<details>
<summary><small>ç‚¹å‡»å±•å¼€</small></summary>
<p>ä»¥å‰ï¼Œä¸€äº›æ–¹æ³•å¦‚ <code>Object::get_refcnt</code> ä¸éœ€è¦ <code>Python</code> å‚æ•°ï¼ˆä»¥ç¡®ä¿å½“å‰çº¿ç¨‹æŒæœ‰ Python GILï¼‰ã€‚ä»æŠ€æœ¯ä¸Šè®²ï¼Œè¿™æ˜¯ä¸å®‰å…¨çš„ã€‚è¿ç§»æ—¶ï¼Œåªéœ€å°† <code>py</code> å‚æ•°ä¼ é€’ç»™è¿™äº›æ–¹æ³•çš„è°ƒç”¨å³å¯ã€‚</p>
<p>ä¹‹å‰ï¼š</p>
<pre><code class="language-rust compile_fail"><span class="boring">pyo3::Python::attach(|py| {
</span>py.None().get_refcnt();
<span class="boring">})</span></code></pre>
<p>ä¹‹åï¼š</p>
<pre><code class="language-rust"><span class="boring">pyo3::Python::attach(|py| {
</span>py.None().get_refcnt(py);
<span class="boring">})</span></code></pre>
</details>
<h2 id="ä»-09-å‡çº§åˆ°-010"><a class="header" href="#ä»-09-å‡çº§åˆ°-010">ä» 0.9.* å‡çº§åˆ° 0.10</a></h2>
<h3 id="objectprotocol-å·²ç§»é™¤"><a class="header" href="#objectprotocol-å·²ç§»é™¤"><code>ObjectProtocol</code> å·²ç§»é™¤</a></h3>
<details>
<summary><small>ç‚¹å‡»å±•å¼€</small></summary>
<p>æ‰€æœ‰æ–¹æ³•éƒ½å·²ç§»è‡³ <a href="{{#PYO3_DOCS_URL}}/pyo3/types/struct.PyAny.html"><code>PyAny</code></a>ã€‚å¹¶ä¸”ç”±äºç°åœ¨æ‰€æœ‰åŸç”Ÿç±»å‹ï¼ˆä¾‹å¦‚ <code>PyList</code>ï¼‰éƒ½å®ç°äº† <code>Deref&lt;Target=PyAny&gt;</code>ï¼Œä½ åªéœ€ä»ä»£ç ä¸­ç§»é™¤ <code>ObjectProtocol</code> å³å¯ã€‚å¦‚æœä½ é€šè¿‡ <code>use pyo3::prelude::*</code> ä½¿ç”¨ <code>ObjectProtocol</code>ï¼Œåˆ™æ— éœ€ä»»ä½•æ›´æ”¹ã€‚</p>
<p>ä¹‹å‰ï¼š</p>
<pre><code class="language-rust compile_fail ignore">use pyo3::ObjectProtocol;

<span class="boring">pyo3::Python::with_gil(|py| {
</span>let obj = py.eval("lambda: 'Hi :)'", None, None).unwrap();
let hi: &amp;pyo3::types::PyString = obj.call0().unwrap().downcast().unwrap();
assert_eq!(hi.len().unwrap(), 5);
<span class="boring">})</span></code></pre>
<p>ä¹‹åï¼š</p>
<pre><code class="language-rust ignore"><span class="boring">pyo3::Python::with_gil(|py| {
</span>let obj = py.eval("lambda: 'Hi :)'", None, None).unwrap();
let hi: &amp;pyo3::types::PyString = obj.call0().unwrap().downcast().unwrap();
assert_eq!(hi.len().unwrap(), 5);
<span class="boring">})</span></code></pre>
</details>
<h3 id="ç”¨æˆ·ä»£ç ä¸­ä¸å†éœ€è¦-featurespecialization"><a class="header" href="#ç”¨æˆ·ä»£ç ä¸­ä¸å†éœ€è¦-featurespecialization">ç”¨æˆ·ä»£ç ä¸­ä¸å†éœ€è¦ <code>#![feature(specialization)]</code></a></h3>
<details>
<summary><small>ç‚¹å‡»å±•å¼€</small></summary>
<p>è™½ç„¶ PyO3 æœ¬èº«ä»éœ€è¦ specialization å’Œ nightly Rustï¼Œä½†ç°åœ¨ä½ çš„ crate ä¸­ä¸å†éœ€è¦ä½¿ç”¨ <code>#![feature(specialization)]</code>ã€‚</p>
</details>
<h2 id="ä»-08-å‡çº§åˆ°-09"><a class="header" href="#ä»-08-å‡çº§åˆ°-09">ä» 0.8.* å‡çº§åˆ° 0.9</a></h2>
<h3 id="new-æ¥å£"><a class="header" href="#new-æ¥å£"><code>#[new]</code> æ¥å£</a></h3>
<details>
<summary><small>ç‚¹å‡»å±•å¼€</small></summary>
<p><a href="https://docs.rs/pyo3/0.8.5/pyo3/type_object/struct.PyRawObject.html"><code>PyRawObject</code></a> å·²è¢«ç§»é™¤ï¼Œæˆ‘ä»¬çš„æ„é€ å‡½æ•°è¯­æ³•å·²æ›´æ”¹ã€‚</p>
<p>ä¹‹å‰ï¼š</p>
<pre><code class="language-rust compile_fail">#[pyclass]
struct MyClass {}

#[pymethods]
impl MyClass {
    #[new]
    fn new(obj: &amp;PyRawObject) {
        obj.init(MyClass {})
    }
}</code></pre>
<p>ä¹‹åï¼š</p>
<pre><code class="language-rust no_run"><span class="boring">use pyo3::prelude::*;
</span>#[pyclass]
struct MyClass {}

#[pymethods]
impl MyClass {
    #[new]
    fn new() -&gt; Self {
        MyClass {}
    }
}</code></pre>
<p>åŸºæœ¬ä¸Šä½ å¯ä»¥ç›´æ¥è¿”å› <code>Self</code> æˆ– <code>Result&lt;Self&gt;</code>ã€‚æ›´å¤šä¿¡æ¯è¯·å‚è§æœ¬æŒ‡å—çš„<a href="#constructor">æ„é€ å‡½æ•°ç« èŠ‚</a>ã€‚</p>
</details>
<h3 id="pycell"><a class="header" href="#pycell">PyCell</a></h3>
<details>
<summary><small>ç‚¹å‡»å±•å¼€</small></summary>
<p>PyO3 0.9 å¼•å…¥äº† <code>PyCell</code>ï¼Œè¿™æ˜¯ä¸€ä¸ªç±»ä¼¼äº <a href="https://doc.rust-lang.org/std/cell/struct.RefCell.html"><code>RefCell</code></a> çš„å¯¹è±¡åŒ…è£…å™¨ï¼Œç”¨äºç¡®ä¿ Rust å…³äºå¼•ç”¨åˆ«åçš„è§„åˆ™å¾—ä»¥éµå®ˆã€‚æ›´å¤šç»†èŠ‚è¯·å‚è§ <a href="https://doc.rust-lang.org/book/ch04-02-references-and-borrowing.html#the-rules-of-references">Rust ä¹¦ç±ä¸­å…³äºå¼•ç”¨è§„åˆ™çš„éƒ¨åˆ†</a></p>
<p>å¯¹äº <code>#[pymethods]</code> æˆ– <code>#[pyfunction]</code>ï¼Œç°æœ‰ä»£ç åº”æ— éœ€æ›´æ”¹å³å¯ç»§ç»­å·¥ä½œã€‚å½“ä½ çš„å‡½æ•°ä½¿ç”¨æ–¹å¼è¿åäº† Rust çš„å¼•ç”¨è§„åˆ™æ—¶ï¼Œä¼šè‡ªåŠ¨å¼•å‘ Python å¼‚å¸¸ã€‚</p>
<p>ç¤ºä¾‹å¦‚ä¸‹ï¼š</p>
<pre><code class="language-rust"><span class="boring">use pyo3::prelude::*;
</span>
#[pyclass]
struct Names {
    names: Vec&lt;String&gt;,
}

#[pymethods]
impl Names {
    #[new]
    fn new() -&gt; Self {
        Names { names: vec![] }
    }
    fn merge(&amp;mut self, other: &amp;mut Names) {
        self.names.append(&amp;mut other.names)
    }
}
<span class="boring">Python::attach(|py| {
</span><span class="boring">    let names = Py::new(py, Names::new()).unwrap();
</span><span class="boring">    pyo3::py_run!(py, names, r"
</span><span class="boring">    try:
</span><span class="boring">       names.merge(names)
</span><span class="boring">       assert False, 'Unreachable'
</span><span class="boring">    except RuntimeError as e:
</span><span class="boring">       assert str(e) == 'Already borrowed'
</span><span class="boring">    ");
</span><span class="boring">})</span></code></pre>
<p><code>Names</code> æœ‰ä¸€ä¸ª <code>merge</code> æ–¹æ³•ï¼Œå®ƒæ¥å— <code>&amp;mut self</code> å’Œå¦ä¸€ä¸ª <code>&amp;mut Self</code> ç±»å‹çš„å‚æ•°ã€‚ç»™å®šæ­¤ <code>#[pyclass]</code>ï¼Œåœ¨ Python ä¸­è°ƒç”¨ <code>names.merge(names)</code> ä¼šå¼•å‘ <a href="{{#PYO3_DOCS_URL}}/pyo3/pycell/struct.PyBorrowMutError.html"><code>PyBorrowMutError</code></a> å¼‚å¸¸ï¼Œå› ä¸ºå®ƒéœ€è¦å¯¹ <code>names</code> è¿›è¡Œä¸¤æ¬¡å¯å˜å€Ÿç”¨ã€‚</p>
<p>ç„¶è€Œï¼Œå¯¹äº <code>#[pyproto]</code> å’ŒæŸäº›å‡½æ•°ï¼Œä½ éœ€è¦æ‰‹åŠ¨ä¿®å¤ä»£ç ã€‚</p>
<h4 id="å¯¹è±¡åˆ›å»º"><a class="header" href="#å¯¹è±¡åˆ›å»º">å¯¹è±¡åˆ›å»º</a></h4>
<p>åœ¨ 0.8 ç‰ˆä¸­ï¼Œå¯¹è±¡åˆ›å»ºä½¿ç”¨ <code>PyRef::new</code> å’Œ <code>PyRefMut::new</code>ã€‚åœ¨ 0.9 ç‰ˆä¸­ï¼Œä¸¤è€…éƒ½å·²ç§»é™¤ã€‚è¦å‡çº§ä»£ç ï¼Œè¯·æ”¹ç”¨ <code>PyCell::new</code>ã€‚å¦‚æœä½ éœ€è¦ <a href="{{#PYO3_DOCS_URL}}/pyo3/pycell/struct.PyRef.html"><code>PyRef</code></a> æˆ– <a href="{{#PYO3_DOCS_URL}}/pyo3/pycell/struct.PyRef.html"><code>PyRefMut</code></a>ï¼Œåªéœ€åœ¨æ–°åˆ›å»ºçš„ <code>PyCell</code> ä¸Šè°ƒç”¨ <code>.borrow()</code> æˆ– <code>.borrow_mut()</code>ã€‚</p>
<p>ä¹‹å‰ï¼š</p>
<pre><code class="language-rust compile_fail"><span class="boring">use pyo3::prelude::*;
</span><span class="boring">#[pyclass]
</span><span class="boring">struct MyClass {}
</span><span class="boring">Python::with_gil(|py| {
</span>let obj_ref = PyRef::new(py, MyClass {}).unwrap();
<span class="boring">})</span></code></pre>
<p>ä¹‹åï¼š</p>
<pre><code class="language-rust ignore"><span class="boring">use pyo3::prelude::*;
</span><span class="boring">#[pyclass]
</span><span class="boring">struct MyClass {}
</span><span class="boring">Python::with_gil(|py| {
</span>let obj = PyCell::new(py, MyClass {}).unwrap();
let obj_ref = obj.borrow();
<span class="boring">})</span></code></pre>
<h4 id="å¯¹è±¡æå–"><a class="header" href="#å¯¹è±¡æå–">å¯¹è±¡æå–</a></h4>
<p>å¯¹äº <code>PyClass</code> ç±»å‹ <code>T</code>ï¼Œ<code>&amp;T</code> å’Œ <code>&amp;mut T</code> ä¸å†å…·æœ‰ <a href="{{#PYO3_DOCS_URL}}/pyo3/conversion/trait.FromPyObject.html"><code>FromPyObject</code></a> çš„å®ç°ã€‚ä½ åº”è¯¥åˆ†åˆ«æå– <code>PyRef&lt;T&gt;</code> æˆ– <code>PyRefMut&lt;T&gt;</code>ã€‚å¦‚æœ <code>T</code> å®ç°äº† <code>Clone</code>ï¼Œä½ å¯ä»¥ç›´æ¥æå– <code>T</code> æœ¬èº«ã€‚æ­¤å¤–ï¼Œä½ ä¹Ÿå¯ä»¥æå– <code>&amp;PyCell&lt;T&gt;</code>ï¼Œå°½ç®¡è¿™ç§æƒ…å†µå¾ˆå°‘éœ€è¦ã€‚</p>
<p>ä¹‹å‰ï¼š</p>
<pre><code class="language-compile_fail">let obj: &amp;PyAny = create_obj();
let obj_ref: &amp;MyClass = obj.extract().unwrap();
let obj_ref_mut: &amp;mut MyClass = obj.extract().unwrap();
</code></pre>
<p>ä¹‹åï¼š</p>
<pre><code class="language-rust ignore"><span class="boring">use pyo3::prelude::*;
</span><span class="boring">use pyo3::types::IntoPyDict;
</span><span class="boring">#[pyclass] #[derive(Clone)] struct MyClass {}
</span><span class="boring">#[pymethods] impl MyClass { #[new]fn new() -&gt; Self { MyClass {} }}
</span><span class="boring">Python::with_gil(|py| {
</span><span class="boring">let typeobj = py.get_type::&lt;MyClass&gt;();
</span><span class="boring">let d = [("c", typeobj)].into_py_dict(py);
</span><span class="boring">let create_obj = || py.eval("c()", None, Some(d)).unwrap();
</span>let obj: &amp;PyAny = create_obj();
let obj_cell: &amp;PyCell&lt;MyClass&gt; = obj.extract().unwrap();
let obj_cloned: MyClass = obj.extract().unwrap(); // é€šè¿‡å…‹éš†å¯¹è±¡æå–
{
    let obj_ref: PyRef&lt;'_, MyClass&gt; = obj.extract().unwrap();
    // ç”±äº Rust çš„å¼•ç”¨è§„åˆ™ï¼Œæˆ‘ä»¬éœ€è¦åœ¨æå– PyRefMut ä¹‹å‰å…ˆé‡Šæ”¾ obj_ref
}
let obj_ref_mut: PyRefMut&lt;'_, MyClass&gt; = obj.extract().unwrap();
<span class="boring">})
</span>```#### `#[pyproto]`

`#[pyproto]` å®ç°ä¸­çš„å¤§å¤šæ•°æ–¹æ³•å‚æ•°éƒ½éœ€è¦å®ç° [`FromPyObject`]ã€‚
å› æ­¤ï¼Œå¦‚æœæ‚¨çš„åè®®æ–¹æ³•æ¥å— `&amp;T` æˆ– `&amp;mut T`ï¼ˆå…¶ä¸­ `T: PyClass`ï¼‰ï¼Œè¯·æ”¹ç”¨ [`PyRef`] æˆ– [`PyRefMut`]ã€‚

ä¹‹å‰ï¼š

```rust,compile_fail
<span class="boring">use pyo3::prelude::*;
</span><span class="boring">use pyo3::class::PySequenceProtocol;
</span>#[pyclass]
struct ByteSequence {
    elements: Vec&lt;u8&gt;,
}
#[pyproto]
impl PySequenceProtocol for ByteSequence {
    fn __concat__(&amp;self, other: &amp;Self) -&gt; PyResult&lt;Self&gt; {
        let mut elements = self.elements.clone();
        elements.extend_from_slice(&amp;other.elements);
        Ok(Self { elements })
    }
}</code></pre>
<p>ä¹‹åï¼š</p>
<pre><code class="language-rust compile_fail"><span class="boring">use pyo3::prelude::*;
</span><span class="boring">use pyo3::class::PySequenceProtocol;
</span>#[pyclass]
struct ByteSequence {
    elements: Vec&lt;u8&gt;,
}
#[pyproto]
impl PySequenceProtocol for ByteSequence {
    fn __concat__(&amp;self, other: PyRef&lt;'p, Self&gt;) -&gt; PyResult&lt;Self&gt; {
        let mut elements = self.elements.clone();
        elements.extend_from_slice(&amp;other.elements);
        Ok(Self { elements })
    }
}</code></pre>
</details>
<style>
    /* ç«‹å³åœ¨ h3 æ ‡é¢˜ä¸‹æ–¹æ¸²æŸ“ details */
    h3:has(+ details) {
        margin-bottom: 0;
    }

    /* è®© summary æ–‡æœ¬æç¤ºå…¶å¯ç‚¹å‡»ï¼Œå¹¶é€šè¿‡å‘ä¸‹å¡«å……å¢åŠ å¯ç‚¹å‡»åŒºåŸŸ */
    details > summary {
        cursor: pointer;
        padding-bottom: 0.5em;
    }

    /* å‡å°‘ç´§æ¥åœ¨å¯ç‚¹å‡»åŒºåŸŸä¸‹æ–¹æ®µè½çš„ä¸Šè¾¹è·ï¼Œä»¥é¿å…å¤§ç©ºç™½ */
    details > summary + p {
        margin-block-start: 0.5em;
    }

    /* ç¨å¾®ç´§å‡‘åœ°æ’åˆ—æœªå±•å¼€çŠ¶æ€ä¸‹çš„ç›¸é‚»æ ‡é¢˜ */
    h3 + details:not([open]) + h3 {
        margin-top: 1.5em;
    }
</style>
</summar></details></pybackedstr></t></t></details><div style="break-before: page; page-break-before: always;"></div>
<h1 id="åœ¨-python-ä¸­ä½¿ç”¨å¸¦æœ‰-trait-çº¦æŸçš„-rust-å‡½æ•°"><a class="header" href="#åœ¨-python-ä¸­ä½¿ç”¨å¸¦æœ‰-trait-çº¦æŸçš„-rust-å‡½æ•°">åœ¨ Python ä¸­ä½¿ç”¨å¸¦æœ‰ trait çº¦æŸçš„ Rust å‡½æ•°</a></h1>
<p>PyO3 å…è®¸å°†æŸäº›å‡½æ•°å’Œç±»è½»æ¾åœ°ä» Rust è½¬æ¢ä¸º Pythonï¼ˆå‚è§<a href="#rust-ç±»å‹åˆ°-python-ç±»å‹çš„æ˜ å°„">è½¬æ¢è¡¨</a>ï¼‰ã€‚<br>ç„¶è€Œï¼Œå½“ Rust ä»£ç éœ€è¦ä»¥å®ç°äº†ç‰¹å®š trait çš„ç±»å‹ä½œä¸ºå‚æ•°æ—¶ï¼Œå°†å…¶è½¬æ¢ä¸º Python å¹¶ä¸æ€»æ˜¯ç›´æ¥å¯è¡Œã€‚</p>
<p>æœ¬æ•™ç¨‹è§£é‡Šäº†å¦‚ä½•å°†æ¥å— trait ä½œä¸ºå‚æ•°çš„ Rust å‡½æ•°è½¬æ¢ï¼Œä»¥ä¾¿åœ¨ Python ä¸­ä½¿ç”¨å®ç°äº†ç›¸åŒæ–¹æ³•çš„ç±»ã€‚</p>
<p>è¿™æœ‰ä»€ä¹ˆç”¨ï¼Ÿ</p>
<h2 id="ä¼˜ç‚¹"><a class="header" href="#ä¼˜ç‚¹">ä¼˜ç‚¹</a></h2>
<ul>
<li>è®© Python ç”¨æˆ·ä¹Ÿèƒ½ä½¿ç”¨ä½ çš„ Rust ä»£ç </li>
<li>å¯ä»¥å€ŸåŠ©å€Ÿç”¨æ£€æŸ¥å™¨åœ¨ Rust ä¸­ç¼–å†™å¤æ‚çš„ç®—æ³•</li>
</ul>
<h3 id="ç¼ºç‚¹"><a class="header" href="#ç¼ºç‚¹">ç¼ºç‚¹</a></h3>
<ul>
<li>æ€§èƒ½ä¸å¦‚åŸç”Ÿ Rustï¼ˆéœ€è¦è¿›è¡Œç±»å‹è½¬æ¢ï¼Œä¸”éƒ¨åˆ†ä»£ç åœ¨ Python ä¸­è¿è¡Œï¼‰</li>
<li>éœ€è¦è°ƒæ•´ä½ çš„ä»£ç æ‰èƒ½æš´éœ²å‡ºæ¥</li>
</ul>
<h2 id="ç¤ºä¾‹"><a class="header" href="#ç¤ºä¾‹">ç¤ºä¾‹</a></h2>
<p>æˆ‘ä»¬ä»¥ä¸€ä¸ªåŸºæœ¬ç¤ºä¾‹å¼€å§‹ï¼šå®ç°ä¸€ä¸ªå¯¹ç»™å®šæ¨¡å‹è¿›è¡Œæ“ä½œçš„ä¼˜åŒ–æ±‚è§£å™¨ã€‚</p>
<p>å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ª <code>solve</code> å‡½æ•°ï¼Œå®ƒæ“ä½œä¸€ä¸ªæ¨¡å‹å¹¶æ”¹å˜å…¶çŠ¶æ€ã€‚<br>è¯¥å‡½æ•°çš„å‚æ•°å¯ä»¥æ˜¯ä»»ä½•å®ç°äº† <code>Model</code> trait çš„æ¨¡å‹ï¼š</p>
<pre><code class="language-rust no_run"><span class="boring">#![allow(dead_code)]
</span>pub trait Model {
    fn set_variables(&amp;mut self, inputs: &amp;Vec&lt;f64&gt;);
    fn compute(&amp;mut self);
    fn get_results(&amp;self) -&gt; Vec&lt;f64&gt;;
}


pub fn solve&lt;T: Model&gt;(model: &amp;mut T) {
    println!("ç¥å¥‡çš„æ±‚è§£å™¨ï¼Œå°†æ¨¡å‹å˜ä¸ºå·²æ±‚è§£çŠ¶æ€");
}</code></pre>
<p>å‡è®¾æˆ‘ä»¬æœ‰ä»¥ä¸‹é™åˆ¶ï¼š</p>
<ul>
<li>æˆ‘ä»¬ä¸èƒ½ä¿®æ”¹è¿™æ®µä»£ç ï¼Œå› ä¸ºå®ƒå·²åœ¨å¤šä¸ª Rust æ¨¡å‹ä¸Šè¿è¡Œã€‚</li>
<li>æˆ‘ä»¬è¿˜æœ‰è®¸å¤š Python æ¨¡å‹ï¼Œä½†ç”±äºè¯¥æ±‚è§£å™¨åœ¨ Python ä¸­ä¸å¯ç”¨ï¼Œæ— æ³•æ±‚è§£å®ƒä»¬ã€‚</li>
</ul>
<p>å°†å…¶å®ç°åœ¨ Python ä¸­ä¼šå¾ˆç¹çä¸”å®¹æ˜“å‡ºé”™ï¼Œå› ä¸ºæ‰€æœ‰åŠŸèƒ½å·²ç»åœ¨ Rust ä¸­å®ç°äº†ã€‚</p>
<p>æˆ‘ä»¬å¦‚ä½•é€šè¿‡ PyO3 å°†æ­¤æ±‚è§£å™¨æš´éœ²ç»™ Pythonï¼Ÿ</p>
<h2 id="ä¸º-python-ç±»å®ç°-trait-çº¦æŸ"><a class="header" href="#ä¸º-python-ç±»å®ç°-trait-çº¦æŸ">ä¸º Python ç±»å®ç° trait çº¦æŸ</a></h2>
<p>å¦‚æœä¸€ä¸ª Python ç±»å®ç°äº†ä¸ <code>Model</code> trait ç›¸åŒçš„ä¸‰ä¸ªæ–¹æ³•ï¼Œé‚£ä¹ˆé€»è¾‘ä¸Šå®ƒåº”è¯¥å¯ä»¥é€‚é…ä½¿ç”¨è¯¥æ±‚è§£å™¨ã€‚<br>ä½†ä¸èƒ½ç›´æ¥ä¼ å…¥ <code>Py&lt;PyAny&gt;</code>ï¼Œå› ä¸ºå®ƒå¹¶æœªå®ç° Rust traitï¼ˆå³ä½¿ Python æ¨¡å‹å…·æœ‰æ‰€éœ€çš„æ–¹æ³•ï¼‰ã€‚</p>
<p>ä¸ºäº†å®ç°è¯¥ traitï¼Œæˆ‘ä»¬å¿…é¡»ç¼–å†™ä¸€ä¸ª Rust è°ƒç”¨ Python æ¨¡å‹çš„åŒ…è£…å™¨ã€‚<br>æ–¹æ³•ç­¾åå¿…é¡»ä¸ trait ä¸€è‡´ï¼ŒåŒæ—¶è®°ä½æˆ‘ä»¬ä¸èƒ½ä¸ºäº†åœ¨ Python ä¸­å¯ç”¨è€Œä¿®æ”¹åŸå§‹çš„ Rust traitã€‚</p>
<p>æˆ‘ä»¬æƒ³è¦æš´éœ²çš„ Python æ¨¡å‹å¦‚ä¸‹ï¼Œå®ƒå·²ç»åŒ…å«æ‰€æœ‰å¿…éœ€çš„æ–¹æ³•ï¼š</p>
<pre><code class="language-python">class Model:
    def set_variables(self, inputs):
        self.inputs = inputs
    def compute(self):
        self.results = [elt**2 - 3 for elt in self.inputs]
    def get_results(self):
        return self.results
</code></pre>
<p>ä»¥ä¸‹åŒ…è£…å™¨å°†ä» Rust è°ƒç”¨ Python æ¨¡å‹ï¼Œå¹¶ä½¿ç”¨ä¸€ä¸ªç»“æ„ä½“æ¥ä¿å­˜ä½œä¸º <code>PyAny</code> å¯¹è±¡çš„æ¨¡å‹ï¼š</p>
<pre><code class="language-rust no_run"><span class="boring">#![allow(dead_code)]
</span>use pyo3::prelude::*;
use pyo3::types::PyList;


<span class="boring">pub trait Model {
</span><span class="boring">  fn set_variables(&amp;mut self, inputs: &amp;Vec&lt;f64&gt;);
</span><span class="boring">  fn compute(&amp;mut self);
</span><span class="boring">  fn get_results(&amp;self) -&gt; Vec&lt;f64&gt;;
</span><span class="boring">}
</span>

struct UserModel {
    model: Py&lt;PyAny&gt;,
}


impl Model for UserModel {
    fn set_variables(&amp;mut self, var: &amp;Vec&lt;f64&gt;) {
        println!("Rust æ­£åœ¨è°ƒç”¨ Python è®¾ç½®å˜é‡");
        Python::attach(|py| {
            self.model
                .bind(py)
                .call_method("set_variables", (PyList::new(py, var).unwrap(),), None)
                .unwrap();
        })
    }


    fn get_results(&amp;self) -&gt; Vec&lt;f64&gt; {
        println!("Rust æ­£åœ¨è°ƒç”¨ Python è·å–ç»“æœ");
        Python::attach(|py| {
            self.model
                .bind(py)
                .call_method("get_results", (), None)
                .unwrap()
                .extract()
                .unwrap()
        })
    }


    fn compute(&amp;mut self) {
        println!("Rust æ­£åœ¨è°ƒç”¨ Python æ‰§è¡Œè®¡ç®—");
        Python::attach(|py| {
            self.model
                .bind(py)
                .call_method("compute", (), None)
                .unwrap();
        })
    }
}</code></pre>
<p>ç°åœ¨è¿™éƒ¨åˆ†å·²å®ç°ï¼Œè®©æˆ‘ä»¬å°†æ¨¡å‹åŒ…è£…å™¨æš´éœ²ç»™ Pythonã€‚<br>æ·»åŠ  PyO3 æ³¨è§£å¹¶æ·»åŠ æ„é€ å‡½æ•°ï¼š</p>
<pre><code class="language-rust no_run"><span class="boring">#![allow(dead_code)]
</span><span class="boring">fn main() {}
</span><span class="boring">pub trait Model {
</span><span class="boring">  fn set_variables(&amp;mut self, inputs: &amp;Vec&lt;f64&gt;);
</span><span class="boring">  fn compute(&amp;mut self);
</span><span class="boring">  fn get_results(&amp;self) -&gt; Vec&lt;f64&gt;;
</span><span class="boring">}
</span><span class="boring">use pyo3::prelude::*;
</span>

#[pyclass]
struct UserModel {
    model: Py&lt;PyAny&gt;,
}


#[pymethods]
impl UserModel {
    #[new]
    pub fn new(model: Py&lt;PyAny&gt;) -&gt; Self {
        UserModel { model }
    }
}


#[pymodule]
mod trait_exposure {
    #[pymodule_export]
    use super::UserModel;
}</code></pre>
<p>ç°åœ¨æˆ‘ä»¬ä¸º trait å®ç°æ·»åŠ  PyO3 æ³¨è§£ï¼š</p>
<pre><code class="language-rust ignore">#[pymethods]
impl Model for UserModel {
    // ä¹‹å‰çš„ trait å®ç°
}</code></pre>
<p>ç„¶è€Œï¼Œä¸Šè¿°ä»£ç æ— æ³•ç¼–è¯‘ã€‚<br>ç¼–è¯‘é”™è¯¯å¦‚ä¸‹ï¼š<code>error: #[pymethods] cannot be used on trait impl blocks</code></p>
<p>è¿™å¾ˆéº»çƒ¦ï¼<br>ä½†æˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸ºè¿™äº›å‡½æ•°ç¼–å†™ç¬¬äºŒä¸ªåŒ…è£…å™¨æ¥ç›´æ¥è°ƒç”¨å®ƒä»¬ã€‚<br>è¯¥åŒ…è£…å™¨è¿˜å°†å¤„ç† Python å’Œ Rust ä¹‹é—´çš„ç±»å‹è½¬æ¢ã€‚</p>
<pre><code class="language-rust no_run"><span class="boring">#![allow(dead_code)]
</span><span class="boring">use pyo3::prelude::*;
</span><span class="boring">use pyo3::types::PyList;
</span><span class="boring">
</span><span class="boring">pub trait Model {
</span><span class="boring">  fn set_variables(&amp;mut self, inputs: &amp;Vec&lt;f64&gt;);
</span><span class="boring">  fn compute(&amp;mut self);
</span><span class="boring">  fn get_results(&amp;self) -&gt; Vec&lt;f64&gt;;
</span><span class="boring">}
</span><span class="boring">
</span><span class="boring">#[pyclass]
</span><span class="boring">struct UserModel {
</span><span class="boring">    model: Py&lt;PyAny&gt;,
</span><span class="boring">}
</span><span class="boring">
</span><span class="boring">impl Model for UserModel {
</span><span class="boring"> fn set_variables(&amp;mut self, var: &amp;Vec&lt;f64&gt;) {
</span><span class="boring">     println!("Rust æ­£åœ¨è°ƒç”¨ Python è®¾ç½®å˜é‡");
</span><span class="boring">     Python::attach(|py| {
</span><span class="boring">         self.model.bind(py)
</span><span class="boring">             .call_method("set_variables", (PyList::new(py, var).unwrap(),), None)
</span><span class="boring">             .unwrap();
</span><span class="boring">     })
</span><span class="boring"> }
</span><span class="boring">
</span><span class="boring"> fn get_results(&amp;self) -&gt; Vec&lt;f64&gt; {
</span><span class="boring">     println!("Rust æ­£åœ¨è°ƒç”¨ Python è·å–ç»“æœ");
</span><span class="boring">     Python::attach(|py| {
</span><span class="boring">         self.model
</span><span class="boring">             .bind(py)
</span><span class="boring">             .call_method("get_results", (), None)
</span><span class="boring">             .unwrap()
</span><span class="boring">             .extract()
</span><span class="boring">             .unwrap()
</span><span class="boring">     })
</span><span class="boring"> }
</span><span class="boring">
</span><span class="boring"> fn compute(&amp;mut self) {
</span><span class="boring">     println!("Rust æ­£åœ¨è°ƒç”¨ Python æ‰§è¡Œè®¡ç®—");
</span><span class="boring">     Python::attach(|py| {
</span><span class="boring">         self.model
</span><span class="boring">             .bind(py)
</span><span class="boring">             .call_method("compute", (), None)
</span><span class="boring">             .unwrap();
</span><span class="boring">     })
</span><span class="boring">
</span><span class="boring"> }
</span><span class="boring">}
</span>

#[pymethods]
impl UserModel {
    pub fn set_variables(&amp;mut self, var: Vec&lt;f64&gt;) {
        println!("Python è°ƒç”¨ Rust è®¾ç½®å˜é‡");
        Model::set_variables(self, &amp;var)
    }


    pub fn get_results(&amp;mut self) -&gt; Vec&lt;f64&gt; {
        println!("Python è°ƒç”¨ Rust è·å–ç»“æœ");
        Model::get_results(self)
    }


    pub fn compute(&amp;mut self) {
        println!("Python è°ƒç”¨ Rust æ‰§è¡Œè®¡ç®—");
        Model::compute(self)
    }
}</code></pre>
<p>æ­¤åŒ…è£…å™¨å¤„ç†äº† PyO3 è¦æ±‚ä¸ trait ä¹‹é—´çš„ç±»å‹è½¬æ¢ã€‚<br>ä¸ºæ»¡è¶³ PyO3 è¦æ±‚ï¼Œè¯¥åŒ…è£…å™¨å¿…é¡»ï¼š</p>
<ul>
<li>è¿”å› <code>PyResult</code> ç±»å‹çš„å¯¹è±¡</li>
<li>æ–¹æ³•ç­¾åä¸­åªèƒ½ä½¿ç”¨å€¼ï¼Œä¸èƒ½ä½¿ç”¨å¼•ç”¨</li>
</ul>
<p>ç°åœ¨è¿è¡Œ Python æ–‡ä»¶ï¼š</p>
<pre><code class="language-python">class Model:
    def set_variables(self, inputs):
        self.inputs = inputs
    def compute(self):
        self.results = [elt**2 - 3 for elt in self.inputs]
    def get_results(self):
        return self.results


if __name__=="__main__":
  import trait_exposure


  myModel = Model()
  my_rust_model = trait_exposure.UserModel(myModel)
  my_rust_model.set_variables([2.0])
  print("ä» Python æ‰“å°å€¼: ", myModel.inputs)
  my_rust_model.compute()
  print("é€šè¿‡ Rust ä» Python æ‰“å°å€¼: ", my_rust_model.get_results())
  print("ç›´æ¥ä» Python æ‰“å°å€¼: ", myModel.get_results())
</code></pre>
<p>è¾“å‡ºç»“æœä¸ºï¼š</p>
<pre><code class="language-block">Set variables from Python calling Rust
Set variables from Rust calling Python
Print value from Python:  [2.0]
Compute from Python calling Rust
Compute from Rust calling Python
Get results from Python calling Rust
Get results from Rust calling Python
Print value from Python through Rust:  [1.0]
Print value directly from Python:  [1.0]
</code></pre>
<p>æˆ‘ä»¬ç°åœ¨å·²æˆåŠŸå°†å®ç°äº† <code>Model</code> trait çš„ Rust æ¨¡å‹æš´éœ²ç»™äº† Pythonï¼</p>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬å°†æš´éœ² <code>solve</code> å‡½æ•°ï¼Œä½†åœ¨é‚£ä¹‹å‰ï¼Œå…ˆè°ˆè°ˆç±»å‹é”™è¯¯ã€‚</p>
<h2 id="python-ä¸­çš„ç±»å‹é”™è¯¯"><a class="header" href="#python-ä¸­çš„ç±»å‹é”™è¯¯">Python ä¸­çš„ç±»å‹é”™è¯¯</a></h2>
<p>å½“ä½ åœ¨ Python ä¸­ä½¿ç”¨ç±»å‹é”™è¯¯æ—¶ä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿå¦‚ä½•æ”¹å–„é”™è¯¯æç¤ºä¿¡æ¯ï¼Ÿ</p>
<h3 id="python-å‡½æ•°å‚æ•°ç±»å‹é”™è¯¯"><a class="header" href="#python-å‡½æ•°å‚æ•°ç±»å‹é”™è¯¯">Python å‡½æ•°å‚æ•°ç±»å‹é”™è¯¯</a></h3>
<p>å‡è®¾ç¬¬ä¸€ç§æƒ…å†µï¼Œåœ¨ä½ çš„ Python æ–‡ä»¶ä¸­ä½¿ç”¨ <code>my_rust_model.set_variables(2.0)</code> è€Œä¸æ˜¯ <code>my_rust_model.set_variables([2.0])</code>ã€‚</p>
<p>Rust ç­¾åæœŸæœ›ä¸€ä¸ªå‘é‡ï¼Œå¯¹åº” Python ä¸­çš„åˆ—è¡¨ã€‚<br>å¦‚æœä¼ å…¥å•ä¸ªå€¼è€Œéå‘é‡ï¼Œä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ</p>
<p>åœ¨æ‰§è¡Œ Python æ—¶ï¼Œæˆ‘ä»¬ä¼šå¾—åˆ°ï¼š</p>
<pre><code class="language-block">File "main.py", line 15, in &lt;module&gt;
   my_rust_model.set_variables(2)
TypeError
</code></pre>
<p>è¿™æ˜¯ä¸€ä¸ªç±»å‹é”™è¯¯ï¼ŒPython æ˜ç¡®æŒ‡å‡ºäº†é—®é¢˜ï¼Œå› æ­¤å¾ˆå®¹æ˜“è¯†åˆ«å’Œè§£å†³ã€‚</p>
<h3 id="python-æ–¹æ³•ç­¾åç±»å‹é”™è¯¯"><a class="header" href="#python-æ–¹æ³•ç­¾åç±»å‹é”™è¯¯">Python æ–¹æ³•ç­¾åç±»å‹é”™è¯¯</a></h3>
<p>ç°åœ¨å‡è®¾æˆ‘ä»¬çš„ Model ç±»ä¸­æŸä¸ªæ–¹æ³•çš„è¿”å›ç±»å‹é”™è¯¯ï¼Œä¾‹å¦‚ <code>get_results</code> æ–¹æ³•åœ¨ Rust ä¸­é¢„æœŸè¿”å›ä¸€ä¸ª <code>Vec&lt;f64&gt;</code>ï¼Œå³ Python ä¸­çš„åˆ—è¡¨ã€‚</p>
<pre><code class="language-python">class Model:
    def set_variables(self, inputs):
        self.inputs = inputs
    def compute(self):
        self.results = [elt**2 -3 for elt in self.inputs]
    def get_results(self):
        return self.results[0]
        #return self.results &lt;-- è¿™æ‰æ˜¯æ­£ç¡®çš„è¾“å‡º
</code></pre>
<p>è¿™ä¸ªè°ƒç”¨ä¼šå¯¼è‡´ä»¥ä¸‹ panicï¼š</p>
<pre><code class="language-block">pyo3_runtime.PanicException: called `Result::unwrap()` on an `Err` value: PyErr { type: Py(0x10dcf79f0, PhantomData) }
</code></pre>
<p>è¿™ä¸ªé”™è¯¯ä¿¡æ¯å¯¹ä¸äº†è§£ Rust çš„ Python ç”¨æˆ·ï¼Œæˆ–ä¸çŸ¥é“ä½¿ç”¨äº† PyO3 çš„äººæ¥è¯´æ¯«æ— å¸®åŠ©ã€‚</p>
<p>ä½†æ—¢ç„¶æˆ‘ä»¬è´Ÿè´£å°† Rust ä»£ç æä¾›ç»™ Python ä½¿ç”¨ï¼Œå°±å¯ä»¥å¯¹æ­¤åšäº›æ”¹è¿›ã€‚é—®é¢˜åœ¨äºæˆ‘ä»¬åœ¨ä»»ä½•å¯èƒ½çš„åœ°æ–¹éƒ½è°ƒç”¨äº† <code>unwrap</code>ï¼Œå› æ­¤ PyO3 çš„ä»»ä½• panic éƒ½ä¼šç›´æ¥ä¼ é€’ç»™æœ€ç»ˆç”¨æˆ·ã€‚</p>
<p>è®©æˆ‘ä»¬ä¿®æ”¹æ‰§è¡Œç±»å‹è½¬æ¢çš„ä»£ç ï¼Œä»¥ä¾¿å‘ Python ç”¨æˆ·æä¾›æ›´æœ‰å¸®åŠ©çš„é”™è¯¯ä¿¡æ¯ï¼š</p>
<p>æˆ‘ä»¬åœ¨ <code>get_results</code> æ–¹æ³•ä¸­ä½¿ç”¨äº†ä»¥ä¸‹è°ƒç”¨ä»¥æ‰§è¡Œç±»å‹è½¬æ¢ï¼š</p>
<pre><code class="language-rust no_run"><span class="boring">#![allow(dead_code)]
</span><span class="boring">use pyo3::prelude::*;
</span><span class="boring">use pyo3::types::PyList;
</span><span class="boring">
</span><span class="boring">pub trait Model {
</span><span class="boring">  fn set_variables(&amp;mut self, inputs: &amp;Vec&lt;f64&gt;);
</span><span class="boring">  fn compute(&amp;mut self);
</span><span class="boring">  fn get_results(&amp;self) -&gt; Vec&lt;f64&gt;;
</span><span class="boring">}
</span><span class="boring">
</span><span class="boring">#[pyclass]
</span><span class="boring">struct UserModel {
</span><span class="boring">    model: Py&lt;PyAny&gt;,
</span><span class="boring">}
</span>
impl Model for UserModel {
    fn get_results(&amp;self) -&gt; Vec&lt;f64&gt; {
        println!("Rust calling Python to get the results");
        Python::attach(|py| {
            self.model
                .bind(py)
                .call_method("get_results", (), None)
                .unwrap()
                .extract()
                .unwrap()
        })
    }
<span class="boring">    fn set_variables(&amp;mut self, var: &amp;Vec&lt;f64&gt;) {
</span><span class="boring">        println!("Rust calling Python to set the variables");
</span><span class="boring">        Python::attach(|py| {
</span><span class="boring">            self.model.bind(py)
</span><span class="boring">                .call_method("set_variables", (PyList::new(py, var).unwrap(),), None)
</span><span class="boring">                .unwrap();
</span><span class="boring">        })
</span><span class="boring">    }
</span><span class="boring">
</span><span class="boring">    fn compute(&amp;mut self) {
</span><span class="boring">        println!("Rust calling Python to perform the computation");
</span><span class="boring">        Python::attach(|py| {
</span><span class="boring">            self.model
</span><span class="boring">                .bind(py)
</span><span class="boring">                .call_method("compute", (), None)
</span><span class="boring">                .unwrap();
</span><span class="boring">        })
</span><span class="boring">    }
</span>}</code></pre>
<p>è®©æˆ‘ä»¬é€æ­¥æ‹†è§£å®ƒï¼Œä»¥å®ç°æ›´å¥½çš„é”™è¯¯å¤„ç†ï¼š</p>
<pre><code class="language-rust no_run"><span class="boring">#![allow(dead_code)]
</span><span class="boring">use pyo3::prelude::*;
</span><span class="boring">use pyo3::types::PyList;
</span><span class="boring">
</span><span class="boring">pub trait Model {
</span><span class="boring">  fn set_variables(&amp;mut self, inputs: &amp;Vec&lt;f64&gt;);
</span><span class="boring">  fn compute(&amp;mut self);
</span><span class="boring">  fn get_results(&amp;self) -&gt; Vec&lt;f64&gt;;
</span><span class="boring">}
</span><span class="boring">
</span><span class="boring">#[pyclass]
</span><span class="boring">struct UserModel {
</span><span class="boring">    model: Py&lt;PyAny&gt;,
</span><span class="boring">}
</span>
impl Model for UserModel {
    fn get_results(&amp;self) -&gt; Vec&lt;f64&gt; {
        println!("Get results from Rust calling Python");
        Python::attach(|py| {
            let py_result: Bound&lt;'_, PyAny&gt; = self
                .model
                .bind(py)
                .call_method("get_results", (), None)
                .unwrap();

            if py_result.get_type().name().unwrap() != "list" {
                panic!(
                    "Expected a list for the get_results() method signature, got {}",
                    py_result.get_type().name().unwrap()
                );
            }
            py_result.extract()
        })
        .unwrap()
    }
<span class="boring">    fn set_variables(&amp;mut self, var: &amp;Vec&lt;f64&gt;) {
</span><span class="boring">        println!("Rust calling Python to set the variables");
</span><span class="boring">        Python::attach(|py| {
</span><span class="boring">            let py_model = self.model.bind(py)
</span><span class="boring">                .call_method("set_variables", (PyList::new(py, var).unwrap(),), None)
</span><span class="boring">                .unwrap();
</span><span class="boring">        })
</span><span class="boring">    }
</span><span class="boring">
</span><span class="boring">    fn compute(&amp;mut self) {
</span><span class="boring">        println!("Rust calling Python to perform the computation");
</span><span class="boring">        Python::attach(|py| {
</span><span class="boring">            self.model
</span><span class="boring">                .bind(py)
</span><span class="boring">                .call_method("compute", (), None)
</span><span class="boring">                .unwrap();
</span><span class="boring">        })
</span><span class="boring">    }
</span>}</code></pre>
<p>é€šè¿‡è¿™æ ·åšï¼Œä½ å¯ä»¥æ•è· Python è®¡ç®—çš„ç»“æœå¹¶æ£€æŸ¥å…¶ç±»å‹ï¼Œä»¥ä¾¿åœ¨æ‰§è¡Œ <code>unwrap</code> ä¹‹å‰æä¾›æ›´æ¸…æ™°çš„é”™è¯¯ä¿¡æ¯ã€‚</p>
<p>å½“ç„¶ï¼Œè¿™å¹¶æœªæ¶µç›–æ‰€æœ‰å¯èƒ½çš„é”™è¯¯è¾“å‡ºæƒ…å†µï¼šç”¨æˆ·å¯èƒ½ä¼šè¿”å›ä¸€ä¸ªå­—ç¬¦ä¸²åˆ—è¡¨ï¼Œè€Œä¸æ˜¯æµ®ç‚¹æ•°åˆ—è¡¨ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œç”±äº PyO3 çš„åŸå› ä»ç„¶ä¼šå‘ç”Ÿè¿è¡Œæ—¶ panicï¼Œä½†é Rust ç”¨æˆ·ä¼šæ›´éš¾ç†è§£é”™è¯¯ä¿¡æ¯ã€‚</p>
<p>å¼€å‘è€…åœ¨æš´éœ² Rust ä»£ç æ—¶ï¼Œéœ€è¦è‡ªè¡Œå†³å®šåœ¨ Python ç±»å‹é”™è¯¯å¤„ç†å’Œæ”¹è¿›é”™è¯¯æ¶ˆæ¯æ–¹é¢æŠ•å…¥å¤šå°‘ç²¾åŠ›ã€‚</p>
<h2 id="æœ€ç»ˆä»£ç -1"><a class="header" href="#æœ€ç»ˆä»£ç -1">æœ€ç»ˆä»£ç </a></h2>
<p>ç°åœ¨ï¼Œè®©æˆ‘ä»¬å°† <code>solve()</code> å‡½æ•°æš´éœ²å‡ºæ¥ï¼Œä½¿å…¶å¯ä»¥ä» Python è°ƒç”¨ã€‚</p>
<p>æˆ‘ä»¬ä¸èƒ½ç›´æ¥å°† <code>solve</code> å‡½æ•°æš´éœ²ç»™ Pythonï¼Œå› ä¸ºç±»å‹è½¬æ¢æ— æ³•å®Œæˆâ€”â€”å®ƒéœ€è¦ä¸€ä¸ªå®ç°äº† <code>Model</code> trait çš„å¯¹è±¡ä½œä¸ºè¾“å…¥ã€‚</p>
<p>ç„¶è€Œï¼Œ<code>UserModel</code> å·²ç»å®ç°äº†è¯¥ traitã€‚å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥ç¼–å†™ä¸€ä¸ªå‡½æ•°åŒ…è£…å™¨ï¼Œæ¥æ”¶å·²ç»è¢«æš´éœ²ç»™ Python çš„ <code>UserModel</code> ä½œä¸ºå‚æ•°ï¼Œä»è€Œè°ƒç”¨æ ¸å¿ƒå‡½æ•° <code>solve</code>ã€‚</p>
<p>æ­¤å¤–ï¼Œè¿˜éœ€è¦å°†ç»“æ„ä½“å£°æ˜ä¸º <code>pub</code>ï¼ˆå…¬å…±ï¼‰ã€‚</p>
<pre><code class="language-rust no_run"><span class="boring">#![allow(dead_code)]
</span><span class="boring">fn main() {}
</span>use pyo3::prelude::*;
use pyo3::types::PyList;

pub trait Model {
    fn set_variables(&amp;mut self, var: &amp;Vec&lt;f64&gt;);
    fn get_results(&amp;self) -&gt; Vec&lt;f64&gt;;
    fn compute(&amp;mut self);
}

pub fn solve&lt;T: Model&gt;(model: &amp;mut T) {
    println!("Magic solver that mutates the model into a resolved state");
}

#[pyfunction]
#[pyo3(name = "solve")]
pub fn solve_wrapper(model: &amp;mut UserModel) {
    solve(model);
}

#[pyclass]
pub struct UserModel {
    model: Py&lt;PyAny&gt;,
}

#[pymethods]
impl UserModel {
    #[new]
    pub fn new(model: Py&lt;PyAny&gt;) -&gt; Self {
        UserModel { model }
    }

    pub fn set_variables(&amp;mut self, var: Vec&lt;f64&gt;) {
        println!("Set variables from Python calling Rust");
        Model::set_variables(self, &amp;var)
    }

    pub fn get_results(&amp;mut self) -&gt; Vec&lt;f64&gt; {
        println!("Get results from Python calling Rust");
        Model::get_results(self)
    }

    pub fn compute(&amp;mut self) {
        Model::compute(self)
    }
}

#[pymodule]
mod trait_exposure {
    #[pymodule_export]
    use super::{UserModel, solve_wrapper};
}

impl Model for UserModel {
    fn set_variables(&amp;mut self, var: &amp;Vec&lt;f64&gt;) {
        println!("Rust calling Python to set the variables");
        Python::attach(|py| {
            self.model
                .bind(py)
                .call_method("set_variables", (PyList::new(py, var).unwrap(),), None)
                .unwrap();
        })
    }

    fn get_results(&amp;self) -&gt; Vec&lt;f64&gt; {
        println!("Get results from Rust calling Python");
        Python::attach(|py| {
            let py_result: Bound&lt;'_, PyAny&gt; = self
                .model
                .bind(py)
                .call_method("get_results", (), None)
                .unwrap();

            if py_result.get_type().name().unwrap() != "list" {
                panic!(
                    "Expected a list for the get_results() method signature, got {}",
                    py_result.get_type().name().unwrap()
                );
            }
            py_result.extract()
        })
        .unwrap()
    }

    fn compute(&amp;mut self) {
        println!("Rust calling Python to perform the computation");
        Python::attach(|py| {
            self.model
                .bind(py)
                .call_method("compute", (), None)
                .unwrap();
        })
    }
}</code></pre>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="ä¸ºæ‚¨çš„-python-åŒ…æä¾›ç±»å‹æç¤ºå’Œ-ide-æç¤º"><a class="header" href="#ä¸ºæ‚¨çš„-python-åŒ…æä¾›ç±»å‹æç¤ºå’Œ-ide-æç¤º">ä¸ºæ‚¨çš„ Python åŒ…æä¾›ç±»å‹æç¤ºå’Œ IDE æç¤º</a></h1>
<p>PyO3 æä¾›äº†ä¸€ä¸ªæ˜“äºä½¿ç”¨çš„æ¥å£ï¼Œç”¨äºåœ¨ Rust ä¸­ç¼–å†™åŸç”Ÿ Python åº“ã€‚é…å¥—çš„ Maturin å…è®¸æ‚¨å°†å®ƒä»¬æ„å»ºå¹¶å‘å¸ƒä¸ºä¸€ä¸ªåŒ…ã€‚ç„¶è€Œï¼Œä¸ºäº†æ›´å¥½çš„ç”¨æˆ·ä½“éªŒï¼ŒPython åº“åº”ä¸ºå…¶æ‰€æœ‰å…¬å…±å®ä½“æä¾›ç±»å‹æç¤ºå’Œæ–‡æ¡£ï¼Œä»¥ä¾¿ IDE å¯ä»¥åœ¨å¼€å‘æœŸé—´æ˜¾ç¤ºè¿™äº›ä¿¡æ¯ï¼Œä¸”ç±»å‹åˆ†æå·¥å…·ï¼ˆå¦‚ <code>mypy</code>ï¼‰èƒ½å¤Ÿä½¿ç”¨å®ƒä»¬æ¥æ­£ç¡®éªŒè¯ä»£ç ã€‚</p>
<p>ç›®å‰è§£å†³æ­¤é—®é¢˜çš„æœ€ä½³æ–¹æ¡ˆæ˜¯æ‰‹åŠ¨ç»´æŠ¤ <code>*.pyi</code> æ–‡ä»¶ï¼Œå¹¶éšåŒ…ä¸€èµ·å‘å¸ƒã€‚</p>
<p>PyO3 æ­£åœ¨è‡´åŠ›äºå®ç°è‡ªåŠ¨ç”Ÿæˆè¿™äº›æ–‡ä»¶ã€‚æœ‰å…³è‡ªåŠ¨ç”Ÿæˆå½“å‰çŠ¶æ€çš„è¯´æ˜ï¼Œè¯·å‚é˜… <a href="#ç±»å‹å­˜æ ¹ç”Ÿæˆpyi-æ–‡ä»¶å’Œå†…çœåŠŸèƒ½">ç±»å‹å­˜æ ¹ç”Ÿæˆ</a> æ–‡æ¡£ã€‚</p>
<h2 id="pyi-æ–‡ä»¶ç®€ä»‹"><a class="header" href="#pyi-æ–‡ä»¶ç®€ä»‹"><code>pyi</code> æ–‡ä»¶ç®€ä»‹</a></h2>
<p><code>pyi</code> æ–‡ä»¶ï¼ˆâ€œPython Interfaceâ€çš„ç¼©å†™ï¼‰åœ¨å¤§å¤šæ•°ç›¸å…³æ–‡æ¡£ä¸­è¢«ç§°ä¸ºâ€œå­˜æ ¹æ–‡ä»¶ï¼ˆstub filesï¼‰â€ã€‚å…³äºå®ƒæ˜¯ä»€ä¹ˆçš„ä¸€ä¸ªéå¸¸å¥½çš„å®šä¹‰å¯ä»¥åœ¨ <a href="https://github.com/python/mypy/wiki/Creating-Stubs-For-Python-Modules">æ—§ç‰ˆ MyPy æ–‡æ¡£</a> ä¸­æ‰¾åˆ°ï¼š</p>
<blockquote>
<p>å­˜æ ¹æ–‡ä»¶åªåŒ…å«æ¨¡å—å…¬å…±æ¥å£çš„æè¿°ï¼Œè€Œä¸åŒ…å«ä»»ä½•å®ç°ã€‚</p>
</blockquote>
<p>æ­¤å¤–ï¼Œå®˜æ–¹ Python typing æ–‡æ¡£ä¸­ä¹Ÿæœ‰å…³äºç±»å‹å­˜æ ¹çš„ <a href="https://typing.readthedocs.io/en/latest/source/stubs.html">è¯¦å°½æ–‡æ¡£</a>ã€‚</p>
<p>å¤§å¤šæ•° Python å¼€å‘è€…å¯èƒ½å·²ç»é‡åˆ°è¿‡å®ƒä»¬ï¼Œä¾‹å¦‚åœ¨å°è¯•å¯¹ä»»ä½•å†…ç½®ç±»å‹ä½¿ç”¨ IDE çš„â€œè½¬åˆ°å®šä¹‰â€åŠŸèƒ½æ—¶ã€‚ä¾‹å¦‚ï¼Œä¸€äº›æ ‡å‡†å¼‚å¸¸çš„å®šä¹‰å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre><code class="language-python">class BaseException(object):
    args: Tuple[Any, ...]
    __cause__: BaseException | None
    __context__: BaseException | None
    __suppress_context__: bool
    __traceback__: TracebackType | None
    def __init__(self, *args: object) -&gt; None: ...
    def __str__(self) -&gt; str: ...
    def __repr__(self) -&gt; str: ...
    def with_traceback(self: _TBE, tb: TracebackType | None) -&gt; _TBE: ...


class SystemExit(BaseException):
    code: int


class Exception(BaseException): ...


class StopIteration(Exception):
    value: Any
</code></pre>
<p>å¦‚æˆ‘ä»¬æ‰€è§ï¼Œè¿™äº›ä¸æ˜¯åŒ…å«å®ç°çš„å®Œæ•´å®šä¹‰ï¼Œè€Œä»…ä»…æ˜¯æ¥å£çš„æè¿°ã€‚é€šå¸¸è¿™æ­£æ˜¯åº“ç”¨æˆ·æ‰€éœ€çš„ä¸€åˆ‡ã€‚</p>
<h3 id="pep-ä¸­æ€ä¹ˆè¯´"><a class="header" href="#pep-ä¸­æ€ä¹ˆè¯´">PEP ä¸­æ€ä¹ˆè¯´ï¼Ÿ</a></h3>
<p>åœ¨ç¼–å†™æœ¬æ–‡æ¡£æ—¶ï¼Œ<code>pyi</code> æ–‡ä»¶åœ¨å››ä¸ª PEP ä¸­è¢«æåŠã€‚</p>
<p><a href="https://www.python.org/dev/peps/pep-0008/#function-annotations">PEP8 - Python ä»£ç é£æ ¼æŒ‡å— - # å‡½æ•°æ³¨è§£</a>ï¼ˆæœ€åä¸€æ®µï¼‰å»ºè®®æ‰€æœ‰ç¬¬ä¸‰æ–¹åº“çš„åˆ›å»ºè€…æä¾›å­˜æ ¹æ–‡ä»¶ï¼Œä½œä¸ºç±»å‹æ£€æŸ¥å·¥å…·äº†è§£åŒ…çš„ä¿¡æ¯æ¥æºã€‚</p>
<blockquote>
<p>ï¼ˆâ€¦â€¦ï¼‰é¢„è®¡ç¬¬ä¸‰æ–¹åº“åŒ…çš„ç”¨æˆ·å¯èƒ½å¸Œæœ›åœ¨å…¶åŒ…ä¸Šè¿è¡Œç±»å‹æ£€æŸ¥å™¨ã€‚ä¸ºæ­¤ï¼Œ<a href="https://www.python.org/dev/peps/pep-0484">PEP 484</a> å»ºè®®ä½¿ç”¨å­˜æ ¹æ–‡ä»¶ï¼š.pyi æ–‡ä»¶ï¼Œç±»å‹æ£€æŸ¥å™¨ä¼šä¼˜å…ˆè¯»å–è¿™äº›æ–‡ä»¶è€Œä¸æ˜¯ç›¸åº”çš„ .py æ–‡ä»¶ã€‚ï¼ˆâ€¦â€¦ï¼‰</p>
</blockquote>
<p><a href="https://www.python.org/dev/peps/pep-0484/#stub-files">PEP484 - ç±»å‹æç¤º - # å­˜æ ¹æ–‡ä»¶</a> å°†å­˜æ ¹æ–‡ä»¶å®šä¹‰å¦‚ä¸‹ï¼š</p>
<blockquote>
<p>å­˜æ ¹æ–‡ä»¶æ˜¯ä»…ç”¨äºç±»å‹æ£€æŸ¥å™¨è€Œéè¿è¡Œæ—¶çš„ã€åŒ…å«ç±»å‹æç¤ºçš„æ–‡ä»¶ã€‚</p>
</blockquote>
<p>å…¶ä¸­åŒ…å«å¯¹å®ƒä»¬çš„è§„èŒƒè¯´æ˜ï¼ˆå¼ºçƒˆæ¨èé˜…è¯»ï¼Œå› ä¸ºå®ƒåŒ…å«è‡³å°‘ä¸€ä¸ªåœ¨æ™®é€š Python ä»£ç ä¸­ä¸ä¼šä½¿ç”¨çš„ç‰¹æ€§ï¼‰ï¼Œä»¥åŠä¸€äº›å…³äºå­˜æ ¹æ–‡ä»¶åº”å¦‚ä½•å­˜å‚¨çš„é€šç”¨ä¿¡æ¯ã€‚</p>
<p><a href="https://www.python.org/dev/peps/pep-0561/">PEP561 - åˆ†å‘å’Œæ‰“åŒ…ç±»å‹ä¿¡æ¯</a> è¯¦ç»†æè¿°äº†å¦‚ä½•æ„å»ºæ”¯æŒç±»å‹æ£€æŸ¥çš„åŒ…ã€‚ç‰¹åˆ«æ˜¯å…¶ä¸­åŒ…å«äº†å­˜æ ¹æ–‡ä»¶å¿…é¡»å¦‚ä½•åˆ†å‘æ‰èƒ½è®©ç±»å‹æ£€æŸ¥å™¨ä½¿ç”¨çš„å…·ä½“ä¿¡æ¯ã€‚</p>
<p><a href="https://www.python.org/dev/peps/pep-0560/">PEP560 - typing æ¨¡å—ä¸æ³›å‹ç±»å‹çš„æ ¸å¿ƒæ”¯æŒ</a> æè¿°äº† Python ç±»å‹ç³»ç»Ÿå†…éƒ¨å¦‚ä½•æ”¯æŒæ³›å‹çš„ç»†èŠ‚ï¼ŒåŒ…æ‹¬è¿è¡Œæ—¶è¡Œä¸ºå’Œä¸é™æ€ç±»å‹æ£€æŸ¥å™¨çš„é›†æˆã€‚</p>
<h2 id="å¦‚ä½•æ“ä½œ"><a class="header" href="#å¦‚ä½•æ“ä½œ">å¦‚ä½•æ“ä½œï¼Ÿ</a></h2>
<p><a href="https://www.python.org/dev/peps/pep-0561/">PEP561</a> æ‰¿è®¤äº†ä¸‰ç§åˆ†å‘ç±»å‹ä¿¡æ¯çš„æ–¹å¼ï¼š</p>
<ul>
<li><code>inline</code> â€”â€” ç±»å‹æç¤ºç›´æ¥æ”¾åœ¨æºç ï¼ˆpyï¼‰æ–‡ä»¶ä¸­ï¼›</li>
<li><code>ç‹¬ç«‹çš„å­˜æ ¹æ–‡ä»¶åŒ…</code> â€”â€” ç±»å‹æç¤ºæ”¾åœ¨ <code>pyi</code> æ–‡ä»¶ä¸­ï¼Œå¹¶å‘å¸ƒåœ¨ç‹¬ç«‹çš„å•ç‹¬åŒ…ä¸­ï¼›</li>
<li><code>åŒ…å†…åµŒå­˜æ ¹æ–‡ä»¶</code> â€”â€” ç±»å‹æç¤ºæ”¾åœ¨ <code>pyi</code> æ–‡ä»¶ä¸­ï¼Œå¹¶ä¸æºæ–‡ä»¶ä¸€èµ·å‘å¸ƒåœ¨åŒä¸€ä¸ªåŒ…ä¸­ã€‚</li>
</ul>
<p>ç¬¬ä¸€ç§æ–¹å¼åœ¨ PyO3 ä¸­è¾ƒä¸ºå›°éš¾ï¼Œå› ä¸ºæˆ‘ä»¬æ²¡æœ‰ <code>py</code> æ–‡ä»¶ã€‚å¾…è¯¥æ–¹å¼è¢«ç ”ç©¶å¹¶å®ç°å¿…è¦çš„æ›´æ”¹åï¼Œæœ¬æ–‡æ¡£å°†è¿›è¡Œæ›´æ–°ã€‚</p>
<p>ç¬¬äºŒç§æ–¹å¼å®¹æ˜“å®ç°ï¼Œæ•´ä¸ªå·¥ä½œå¯ä»¥å®Œå…¨ä¸ä¸»åº“ä»£ç åˆ†ç¦»ã€‚å­˜æ ¹æ–‡ä»¶åŒ…çš„ç¤ºä¾‹ä»“åº“å¯åœ¨ <a href="https://www.python.org/dev/peps/pep-0561/#references">PEP561 å‚è€ƒéƒ¨åˆ†</a> æ‰¾åˆ°ï¼š<a href="https://github.com/ethanhs/stub-package">å­˜æ ¹åŒ…ä»“åº“</a></p>
<p>ç¬¬ä¸‰ç§æ–¹å¼å°†åœ¨ä¸‹æ–‡æè¿°ã€‚</p>
<h3 id="å°†-pyi-æ–‡ä»¶åŒ…å«åœ¨æ‚¨çš„-pyo3maturin-æ„å»ºåŒ…ä¸­"><a class="header" href="#å°†-pyi-æ–‡ä»¶åŒ…å«åœ¨æ‚¨çš„-pyo3maturin-æ„å»ºåŒ…ä¸­">å°† <code>pyi</code> æ–‡ä»¶åŒ…å«åœ¨æ‚¨çš„ PyO3/Maturin æ„å»ºåŒ…ä¸­</a></h3>
<p>å½“æºæ–‡ä»¶ä¸å­˜æ ¹æ–‡ä»¶ä½äºåŒä¸€åŒ…ä¸­æ—¶ï¼Œå®ƒä»¬åº”å½¼æ­¤ç›¸é‚»æ”¾ç½®ã€‚æˆ‘ä»¬éœ€è¦ä¸€ç§æ–¹å¼é€šè¿‡ Maturin å®ç°è¿™ä¸€ç‚¹ã€‚æ­¤å¤–ï¼Œä¸ºäº†æ ‡è®°æˆ‘ä»¬çš„åŒ…æ”¯æŒç±»å‹æç¤ºï¼Œæˆ‘ä»¬éœ€è¦åœ¨åŒ…ä¸­æ·»åŠ ä¸€ä¸ªåä¸º <code>py.typed</code> çš„ç©ºæ–‡ä»¶ã€‚</p>
<h4 id="å¦‚æœæ‚¨ä¸éœ€è¦æ·»åŠ å…¶ä»–-python-æ–‡ä»¶"><a class="header" href="#å¦‚æœæ‚¨ä¸éœ€è¦æ·»åŠ å…¶ä»–-python-æ–‡ä»¶">å¦‚æœæ‚¨ä¸éœ€è¦æ·»åŠ å…¶ä»– Python æ–‡ä»¶</a></h4>
<p>å¦‚æœé™¤äº† <code>pyi</code> æ–‡ä»¶å¤–æ‚¨ä¸éœ€è¦å‘åŒ…ä¸­æ·»åŠ ä»»ä½•å…¶ä»– Python æ–‡ä»¶ï¼ŒMaturin å¯ä»¥ä¸ºæ‚¨å®Œæˆå¤§éƒ¨åˆ†å·¥ä½œã€‚å¦‚ <a href="https://github.com/PyO3/maturin/#mixed-rustpython-projects">Maturin æŒ‡å—</a> æ–‡æ¡£æ‰€è¿°ï¼Œæ‚¨åªéœ€åœ¨é¡¹ç›®æ ¹ç›®å½•åˆ›å»ºä¸€ä¸ªåä¸º <code>&lt;module_name&gt;.pyi</code> çš„å­˜æ ¹æ–‡ä»¶ï¼Œå…¶ä½™å·¥ä½œå°†ç”± Maturin è‡ªåŠ¨å®Œæˆã€‚</p>
<pre><code class="language-text">my-rust-project/
â”œâ”€â”€ Cargo.toml
â”œâ”€â”€ my_project.pyi  # &lt;&lt;&lt; åœ¨æ­¤å¤„ä¸º my_project æ¨¡å—ä¸­çš„ Rust å‡½æ•°æ·»åŠ ç±»å‹å­˜æ ¹
â”œâ”€â”€ pyproject.toml
â””â”€â”€ src
    â””â”€â”€ lib.rs
</code></pre>
<p>æœ‰å…³ <code>pyi</code> æ–‡ä»¶çš„ç¤ºä¾‹ï¼Œè¯·å‚è§ <a href="#my_projectpyi-content"><code>my_project.pyi</code> å†…å®¹</a> ç« èŠ‚ã€‚</p>
<h4 id="å¦‚æœæ‚¨éœ€è¦å…¶ä»–-python-æ–‡ä»¶"><a class="header" href="#å¦‚æœæ‚¨éœ€è¦å…¶ä»–-python-æ–‡ä»¶">å¦‚æœæ‚¨éœ€è¦å…¶ä»– Python æ–‡ä»¶</a></h4>
<p>å¦‚æœæ‚¨éœ€è¦å‘åŒ…ä¸­æ·»åŠ é™¤ <code>pyi</code> ä¹‹å¤–çš„å…¶ä»– Python æ–‡ä»¶ï¼Œä¹Ÿå¯ä»¥åšåˆ°ï¼Œä½†éœ€è¦é¢å¤–çš„å·¥ä½œã€‚Maturin æä¾›äº†ä¸€ç§æ–¹ä¾¿çš„æ–¹å¼æ¥å‘åŒ…ä¸­æ·»åŠ æ–‡ä»¶ï¼ˆ<a href="https://github.com/PyO3/maturin/blob/0dee40510083c03607834c821eea76964140a126/Readme.md#mixed-rustpython-projects">æ–‡æ¡£</a>ï¼‰ã€‚æ‚¨åªéœ€åœ¨ <code>Cargo.toml</code> æ–‡ä»¶æ—è¾¹åˆ›å»ºä¸€ä¸ªä¸æ¨¡å—åŒåçš„æ–‡ä»¶å¤¹ï¼ˆå¦‚éœ€è‡ªå®šä¹‰ï¼Œè¯·å‚é˜…ä¸Šè¿°æ–‡æ¡£é“¾æ¥ï¼‰ã€‚</p>
<p>æ–‡ä»¶ç»“æ„å¦‚ä¸‹ï¼š</p>
<pre><code class="language-text">my-project
â”œâ”€â”€ Cargo.toml
â”œâ”€â”€ my_project
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ my_project.pyi
â”‚   â”œâ”€â”€ other_python_file.py
â”‚   â””â”€â”€ py.typed
â”œâ”€â”€ pyproject.toml
â”œâ”€â”€ Readme.md
â””â”€â”€ src
    â””â”€â”€ lib.rs
</code></pre>
<p>è®©æˆ‘ä»¬æ›´è¯¦ç»†åœ°è¯´æ˜åŒ…æ–‡ä»¶å¤¹å†…çš„å„ä¸ªæ–‡ä»¶ã€‚</p>
<h5 id="__init__py-å†…å®¹"><a class="header" href="#__init__py-å†…å®¹"><code>__init__.py</code> å†…å®¹</a></h5>
<p>ç°åœ¨æˆ‘ä»¬è‡ªè¡ŒæŒ‡å®šåŒ…å†…å®¹ï¼Œå› æ­¤å¿…é¡»æä¾› <code>__init__.py</code> æ–‡ä»¶ï¼Œä»¥ä¾¿è¯¥æ–‡ä»¶å¤¹è¢«è¯†åˆ«ä¸ºåŒ…ï¼Œå¹¶ä¸”æˆ‘ä»¬å¯ä»¥ä»ä¸­å¯¼å…¥å†…å®¹ã€‚æˆ‘ä»¬å¯ä»¥å§‹ç»ˆä½¿ç”¨ Maturin åœ¨æœªæŒ‡å®š Python æºæ–‡ä»¶å¤¹æ—¶ä¸ºæˆ‘ä»¬ç”Ÿæˆçš„å†…å®¹ã€‚å¯¹äº PyO3 ç»‘å®šï¼Œå®ƒåº”è¯¥æ˜¯ï¼š</p>
<pre><code class="language-python">from .my_project import *
</code></pre>
<p>è¿™æ ·ï¼Œæˆ‘ä»¬åŸç”Ÿæ¨¡å—å…¬å¼€çš„æ‰€æœ‰å†…å®¹éƒ½å¯ä»¥ç›´æ¥ä»åŒ…ä¸­å¯¼å…¥ã€‚</p>
<h5 id="pytyped-æ–‡ä»¶è¦æ±‚"><a class="header" href="#pytyped-æ–‡ä»¶è¦æ±‚"><code>py.typed</code> æ–‡ä»¶è¦æ±‚</a></h5>
<p>å¦‚ <a href="https://www.python.org/dev/peps/pep-0561/">PEP561</a> æ‰€è¿°ï¼š</p>
<blockquote>
<p>å¸Œæœ›æ”¯æŒå…¶ä»£ç ç±»å‹æ£€æŸ¥çš„åŒ…ç»´æŠ¤è€…ï¼Œå¿…é¡»åœ¨å…¶æ”¯æŒç±»å‹çš„åŒ…ä¸­æ·»åŠ ä¸€ä¸ªåä¸º py.typed çš„æ ‡è®°æ–‡ä»¶ã€‚è¯¥æ ‡è®°å…·æœ‰é€’å½’æ€§ï¼šå¦‚æœé¡¶çº§åŒ…åŒ…å«å®ƒï¼Œå…¶æ‰€æœ‰å­åŒ…ä¹Ÿå¿…é¡»æ”¯æŒç±»å‹æ£€æŸ¥ã€‚</p>
</blockquote>
<p>å¦‚æœæˆ‘ä»¬ä¸åŒ…å«è¯¥æ–‡ä»¶ï¼ŒæŸäº› IDE ä»å¯èƒ½ä¼šä½¿ç”¨æˆ‘ä»¬çš„ <code>pyi</code> æ–‡ä»¶æ˜¾ç¤ºæç¤ºï¼Œä½†ç±»å‹æ£€æŸ¥å™¨å¯èƒ½ä¸ä¼šã€‚MyPy åœ¨è¿™ç§æƒ…å†µä¸‹ä¼šæŠ¥é”™ï¼š</p>
<pre><code class="language-text">error: Skipping analyzing "my_project": found module but no type hints or library stubs
</code></pre>
<p>è¯¥æ–‡ä»¶åªæ˜¯ä¸€ä¸ªæ ‡è®°æ–‡ä»¶ï¼Œå› æ­¤åº”ä¸ºç©ºã€‚</p>
<h5 id="my_projectpyi-å†…å®¹"><a class="header" href="#my_projectpyi-å†…å®¹"><code>my_project.pyi</code> å†…å®¹</a></h5>
<p>è¿™æ˜¯æˆ‘ä»¬æ¨¡å—çš„å­˜æ ¹æ–‡ä»¶ã€‚æœ¬æ–‡æ¡£å¹¶ä¸æ—¨åœ¨è¯´æ˜å¦‚ä½•ç¼–å†™å®ƒä»¬ï¼Œå› ä¸ºæ‚¨å¯ä»¥æ‰¾åˆ°å¤§é‡ç›¸å…³æ–‡æ¡£ï¼Œä»å·²å¼•ç”¨çš„ <a href="https://www.python.org/dev/peps/pep-0484/#stub-files">PEP484</a> å¼€å§‹ã€‚</p>
<p>ç¤ºä¾‹å¦‚ä¸‹ï¼š</p>
<pre><code class="language-python">class Car:
    """
    è¡¨ç¤ºä¸€è¾†æ±½è½¦çš„ç±»ã€‚

    :param body_type: è½¦èº«ç±»å‹åç§°ï¼Œä¾‹å¦‚ä¸¤å¢è½¦ã€ä¸‰å¢è½¦
    :param horsepower: å‘åŠ¨æœºé©¬åŠ›æ•°å€¼
    """
    def __init__(self, body_type: str, horsepower: int) -&gt; None: ...


    @classmethod
    def from_unique_name(cls, name: str) -&gt; 'Car':
        """
        æ ¹æ®å”¯ä¸€åç§°åˆ›å»ºä¸€è¾†æ±½è½¦

        :param name: è¦åˆ›å»ºçš„æ±½è½¦çš„å‹å·åç§°
        :return: å¸¦æœ‰é»˜è®¤æ•°æ®çš„ Car å®ä¾‹
        """


    def best_color(self) -&gt; str:
        """
        è·å–æœ€é€‚åˆè¯¥æ±½è½¦çš„é¢œè‰²ã€‚

        :return: æˆ‘ä»¬çš„ä¼˜ç§€ç®—æ³•è®¤ä¸ºæœ€é€‚åˆæ­¤è½¦çš„é¢œè‰²åç§°
        """
</code></pre>
<h3 id="æ”¯æŒæ³›å‹"><a class="header" href="#æ”¯æŒæ³›å‹">æ”¯æŒæ³›å‹</a></h3>
<p>ç±»å‹æ³¨è§£åœ¨ Python ä¸­ä¹Ÿå¯ä»¥æ˜¯æ³›å‹çš„ã€‚å®ƒä»¬åœ¨å¤„ç†ä¸åŒç±»å‹çš„åŒæ—¶ä¿æŒç±»å‹å®‰å…¨æ€§æ–¹é¢éå¸¸æœ‰ç”¨ã€‚é€šå¸¸ï¼Œæ³›å‹ç±»ä¼šç»§æ‰¿è‡ª <code>typing.Generic</code> å…ƒç±»ã€‚</p>
<p>ä¾‹å¦‚ï¼Œä»¥ä¸‹ <code>.pyi</code> æ–‡ä»¶å®šä¹‰äº†ä¸€ä¸ªå¯ä»¥æ¥å—å¤šç§ç±»å‹è½®å­çš„ <code>Car</code>ï¼š</p>
<pre><code class="language-python">from typing import Generic, TypeVar


W = TypeVar('W')


class Car(Generic[W]):
    def __init__(self, wheels: list[W]) -&gt; None: ...


    def get_wheels(self) -&gt; list[W]: ...


    def change_wheel(self, wheel_number: int, wheel: W) -&gt; None: ...
</code></pre>
<p>è¿™æ ·ä¸€æ¥ï¼Œæœ€ç»ˆç”¨æˆ·ä¾¿å¯ä»¥ä½¿ç”¨å˜é‡å¦‚ <code>truck: Car[SteelWheel] = ...</code> å’Œ <code>f1_car: Car[AlloyWheel] = ...</code> æ¥æŒ‡å®šç±»å‹ã€‚</p>
<p>æ­¤å¤–ï¼Œåœ¨ Python 3.12+ ä¸­æœ‰ä¸€ç§ç‰¹æ®Šçš„è¯­æ³•ç”¨äºæŒ‡å®šæ³›å‹ç±»å‹ï¼š</p>
<pre><code class="language-python">class Car[W]:
    def __init__(self, wheels: list[W]) -&gt; None: ...


    def get_wheels(self) -&gt; list[W]: ...
```#### è¿è¡Œæ—¶è¡Œä¸º

å­˜æ ¹æ–‡ä»¶ï¼ˆ`pyi`ï¼‰ä»…å¯¹é™æ€ç±»å‹æ£€æŸ¥å™¨æœ‰ç”¨ï¼Œåœ¨è¿è¡Œæ—¶ä¼šè¢«å¿½ç•¥ã€‚å› æ­¤ï¼Œå³ä½¿åœ¨å­˜æ ¹æ–‡ä»¶ä¸­æŒ‡å®šäº†ï¼ŒPyO3 ç±»ä¹Ÿä¸ä¼šç»§æ‰¿è‡ª `typing.Generic`ã€‚

è¿™å¯èƒ½ä¼šå¯¼è‡´ä¸€äº›è¿è¡Œæ—¶é—®é¢˜ï¼Œå› ä¸ºåƒ `f1_car: Car[AlloyWheel] = ...` è¿™æ ·çš„å˜é‡æ³¨è§£ä¼šä½¿ Python è°ƒç”¨æœªå®šä¹‰çš„é­”æœ¯æ–¹æ³•ã€‚

ä¸ºå…‹æœæ­¤é™åˆ¶ï¼Œå®ç°è€…å¯ä»¥åœ¨ Rust ä¸­å°† `generic` å‚æ•°ä¼ é€’ç»™ `pyclass`ï¼š

```rust ignore
#[pyclass(generic)]
</code></pre>
<h4 id="é«˜çº§ç”¨æˆ·"><a class="header" href="#é«˜çº§ç”¨æˆ·">é«˜çº§ç”¨æˆ·</a></h4>
<p><code>#[pyclass(generic)]</code> å®ç°äº†ä¸€ç§éå¸¸ç®€å•çš„è¿è¡Œæ—¶è¡Œä¸ºï¼Œå¯æ¥å—ä»»æ„æ³›å‹å‚æ•°ã€‚é«˜çº§ç”¨æˆ·å¯ä»¥é€‰æ‹©æ‰‹åŠ¨ä¸ºæ³›å‹ç±»å®ç° <a href="https://docs.python.org/3/reference/datamodel.html#emulating-generic-types"><code>__class_getitem__</code></a>ï¼Œä»¥è·å¾—æ›´ç²¾ç»†çš„æ§åˆ¶ã€‚</p>
<pre><code class="language-rust ignore">impl MyClass {
    #[classmethod]
    #[pyo3(signature = (key, /))]
    pub fn __class_getitem__(
        cls: &amp;Bound&lt;'_, PyType&gt;,
        key: &amp;Bound&lt;'_, PyAny&gt;,
    ) -&gt; PyResult&lt;Py&lt;PyAny&gt;&gt; {
        /* å®ç°ç»†èŠ‚ */
    }
}</code></pre>
<p>è¯·æ³¨æ„ï¼Œåœ¨å®ç° <code>__class_getitem__</code> æ—¶ï¼Œä½¿ç”¨ <a href="{{#PYO3_DOCS_URL}}/pyo3/types/struct.PyGenericAlias.html"><code>pyo3::types::PyGenericAlias</code></a> å¯èƒ½ä¼šæœ‰æ‰€å¸®åŠ©ï¼Œå› ä¸ºå®ƒå¯ä»¥ä» Rust åˆ›å»º <a href="https://docs.python.org/3/library/types.html#types.GenericAlias"><code>types.GenericAlias</code></a> å¯¹è±¡ã€‚</p>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="æ›´æ–°æ—¥å¿—"><a class="header" href="#æ›´æ–°æ—¥å¿—">æ›´æ–°æ—¥å¿—</a></h1>
<p>æ‰€æœ‰å¯¹æœ¬é¡¹ç›®çš„é‡è¦æ›´æ”¹éƒ½å°†è®°å½•åœ¨æ­¤æ–‡ä»¶ä¸­ã€‚æœ‰å…³æ›´æ–°åˆ°æ–°ç‰ˆæœ¬ PyO3 çš„å¸®åŠ©ï¼Œè¯·å‚é˜…<a href="https://pyo3.rs/latest/migration.html">è¿ç§»æŒ‡å—</a>ã€‚</p>
<p>è¯¥æ ¼å¼åŸºäº <a href="https://keepachangelog.com/en/1.0.0/">Keep a Changelog</a>ï¼Œæœ¬é¡¹ç›®éµå¾ª <a href="https://semver.org/spec/v2.0.0.html">è¯­ä¹‰åŒ–ç‰ˆæœ¬æ§åˆ¶</a>ã€‚</p>
<p>è¦æŸ¥çœ‹å°šæœªå‘å¸ƒçš„æ›´æ”¹ï¼Œè¯·å‚é˜… <a href="https://pyo3.rs/main/changelog.html">ä¸»åˆ†æ”¯ä¸Šçš„æ›´æ–°æ—¥å¿—æŒ‡å—</a>ã€‚</p>
<!-- towncrier release notes start -->
<h2 id="0272---2025-11-30"><a class="header" href="#0272---2025-11-30">[0.27.2] - 2025-11-30</a></h2>
<h3 id="æ›´æ”¹"><a class="header" href="#æ›´æ”¹">æ›´æ”¹</a></h3>
<ul>
<li>ç¦ç”¨åœ¨ GraalPy ä¸Šå¯¹ <code>PyDict</code> çš„å­ç±»åŒ–ï¼ˆç›®å‰ä¸æ”¯æŒï¼Œå¯èƒ½åœ¨è¿è¡Œæ—¶å´©æºƒï¼‰ã€‚<a href="https://github.com/PyO3/pyo3/pull/5653">#5653</a></li>
</ul>
<h3 id="ä¿®å¤"><a class="header" href="#ä¿®å¤">ä¿®å¤</a></h3>
<ul>
<li>ä¿®å¤åœ¨ Rust 1.92+ ä¸Šå¯ç”¨ debug æ–­è¨€å’Œä¼˜åŒ–æ—¶ç¼–è¯‘å¯¼è‡´çš„å´©æºƒé—®é¢˜ã€‚<a href="https://github.com/PyO3/pyo3/pull/5638">#5638</a></li>
<li>ä¿®å¤ PyPy ä¸Š <code>PyDictObject</code> çš„ FFI å®šä¹‰ã€‚<a href="https://github.com/PyO3/pyo3/pull/5653">#5653</a></li>
</ul>
<h2 id="0271---2025-10-21"><a class="header" href="#0271---2025-10-21">[0.27.1] - 2025-10-21</a></h2>
<h3 id="ä¿®å¤-1"><a class="header" href="#ä¿®å¤-1">ä¿®å¤</a></h3>
<ul>
<li>ä¿®å¤ <code>#[pyfunction]</code> å¼•èµ·çš„ <code>clippy:declare_interior_mutable_const</code> è­¦å‘Šã€‚<a href="https://github.com/PyO3/pyo3/pull/5538">#5538</a></li>
<li>åœ¨å…¬å…± API ä¸­æš´éœ² <code>pyo3::types::PySendResult</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/5539">#5539</a></li>
</ul>
<h2 id="0270---2025-10-19"><a class="header" href="#0270---2025-10-19">[0.27.0] - 2025-10-19</a></h2>
<h3 id="æ‰“åŒ…"><a class="header" href="#æ‰“åŒ…">æ‰“åŒ…</a></h3>
<ul>
<li>æ‰©å±•å¯é€‰ä¾èµ– <code>hashbrown</code> æ”¯æŒçš„ç‰ˆæœ¬èŒƒå›´ï¼ŒåŒ…å« 0.16 ç‰ˆæœ¬ã€‚<a href="https://github.com/PyO3/pyo3/pull/5428">#5428</a></li>
<li>å°†å¯é€‰ä¾èµ– <code>num-bigint</code> çš„æœ€ä½ç‰ˆæœ¬æå‡è‡³ 0.4.4ã€‚<a href="https://github.com/PyO3/pyo3/pull/5471">#5471</a></li>
<li>å¢åŠ å¯¹ Python 3.14 æ­£å¼ç‰ˆçš„æµ‹è¯•ã€‚<a href="https://github.com/PyO3/pyo3/pull/5499">#5499</a></li>
<li>åœæ­¢æ”¯æŒ PyPy 3.9 å’Œ 3.10ã€‚<a href="https://github.com/PyO3/pyo3/pull/5516">#5516</a></li>
<li>åœ¨ç”¨æ—§ç‰ˆæœ¬ PyO3 æ„å»ºè¿‡æ–° Python ç‰ˆæœ¬æ—¶æä¾›æ›´æ¸…æ™°çš„é”™è¯¯ä¿¡æ¯ã€‚<a href="https://github.com/PyO3/pyo3/pull/5519">#5519</a></li>
</ul>
<h3 id="æ–°å¢"><a class="header" href="#æ–°å¢">æ–°å¢</a></h3>
<ul>
<li>æ·»åŠ  <code>FromPyObjectOwned</code>ï¼Œåœ¨æ•°æ®æœªä» Python å€Ÿç”¨æ—¶ï¼Œä½œä¸º <code>FromPyObject</code> çš„ä¾¿æ· trait çº¦æŸã€‚<a href="https://github.com/PyO3/pyo3/pull/4390">#4390</a></li>
<li>æ·»åŠ  <code>Borrowed::extract</code>ï¼Œä¸ <code>PyAnyMethods::extract</code> ç›¸åŒï¼Œä½†ä¸ä¼šå› è§£å¼•ç”¨è€Œé™åˆ¶ç”Ÿå‘½å‘¨æœŸã€‚<a href="https://github.com/PyO3/pyo3/pull/4390">#4390</a></li>
<li><code>experimental-inspect</code>ï¼šåŸºç¡€æ”¯æŒ <code>#[derive(IntoPyObject)]</code>ï¼ˆæš‚ä¸æ”¯æŒç»“æ„ä½“å­—æ®µï¼‰ã€‚<a href="https://github.com/PyO3/pyo3/pull/5365">#5365</a></li>
<li><code>experimental-inspect</code>ï¼šæ”¯æŒ <code>#[pyo3(get, set)]</code> å’Œ <code>#[pyclass(get_all, set_all)]</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/5370">#5370</a></li>
<li>æ·»åŠ  <code>PyTypeCheck::classinfo_object</code>ï¼Œè¿”å›å¯ç”¨äº <code>isinstance</code> æˆ– <code>issubclass</code> çš„å¯¹è±¡ã€‚<a href="https://github.com/PyO3/pyo3/pull/5387">#5387</a></li>
<li>å³ä½¿å¯ç”¨å—é™ APIï¼Œä¹Ÿåœ¨ <code>datetime.*</code> ç±»å‹ä¸Šå®ç° <code>PyTypeInfo</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/5388">#5388</a></li>
<li>åœ¨ <code>PyIterator</code>ã€<code>PyMapping</code> å’Œ <code>PySequence</code> ä¸Šå®ç° <code>PyTypeInfo</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/5402">#5402</a></li>
<li>åœ¨ä½¿ç”¨ç¨³å®š ABI æ—¶ï¼Œä¸º <code>PyCode</code> å®ç° <code>PyTypeInfo</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/5403">#5403</a></li>
<li>åœ¨ä½¿ç”¨ç¨³å®š ABI æ—¶ï¼Œä¸º <code>PyWeakrefReference</code> å®ç° <code>PyTypeInfo</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/5404">#5404</a></li>
<li>æ·»åŠ  <code>pyo3::sync::RwLockExt</code> traitï¼Œç±»ä¼¼äº <code>pyo3::sync::MutexExt</code>ï¼Œä½†ç”¨äºè¯»å†™é”ã€‚<a href="https://github.com/PyO3/pyo3/pull/5435">#5435</a></li>
<li>æ·»åŠ  <code>PyString::from_bytes</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/5437">#5437</a></li>
<li>ä¸º <code>PyBytes</code> å®ç° <code>AsRef&lt;[u8]&gt;</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/5445">#5445</a></li>
<li>æ·»åŠ  <code>CastError</code> å’Œ <code>CastIntoError</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/5468">#5468</a></li>
<li>æ·»åŠ  <code>PyCapsuleMethods::pointer_checked</code> å’Œ <code>PyCapsuleMethods::is_valid_checked</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/5474">#5474</a></li>
<li>æ·»åŠ  <code>Borrowed::cast</code>ã€<code>Borrowed::cast_exact</code> å’Œ <code>Borrowed::cast_unchecked</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/5475">#5475</a></li>
<li>æ·»åŠ å¯¹ <code>jiff::civil::ISOWeekDate</code> çš„è½¬æ¢æ”¯æŒã€‚<a href="https://github.com/PyO3/pyo3/pull/5478">#5478</a></li>
<li>æ·»åŠ å¯¹ <code>&amp;Cstr</code>ã€<code>Cstring</code> å’Œ <code>Cow&lt;Cstr&gt;</code> çš„è½¬æ¢æ”¯æŒã€‚<a href="https://github.com/PyO3/pyo3/pull/5482">#5482</a></li>
<li>æ·»åŠ  <code>#[pyclass(skip_from_py_object)]</code> é€‰é¡¹ï¼Œç”¨äºå–æ¶ˆ <code>FromPyObject: PyClass + Clone</code> çš„é»˜è®¤å®ç°ã€‚<a href="https://github.com/PyO3/pyo3/pull/5488">#5488</a></li>
<li>æ·»åŠ  <code>PyErr::add_note</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/5489">#5489</a></li>
<li>ä¸º <code>Cow&lt;Path&gt;</code> å’Œ <code>Cow&lt;OsStr&gt;</code> æ·»åŠ  <code>FromPyObject</code> å®ç°ã€‚<a href="https://github.com/PyO3/pyo3/pull/5497">#5497</a></li>
<li>æ·»åŠ  <code>#[pyclass(from_py_object)]</code> pyclass é€‰é¡¹ï¼Œå…è®¸æŒ‰å€¼æå– pyclassï¼ˆéœ€è¦ <code>Clone</code>ï¼‰ã€‚<a href="https://github.com/PyO3/pyo3/pull/5506">#5506</a></li>
</ul>
<h3 id="æ›´æ”¹-1"><a class="header" href="#æ›´æ”¹-1">æ›´æ”¹</a></h3>
<ul>
<li>é‡æ„ <code>FromPyObject</code> trait ä»¥æé«˜çµæ´»æ€§å’Œæ€§èƒ½ï¼š<a href="https://github.com/PyO3/pyo3/pull/4390">#4390</a>
<ul>
<li>ä¸º <code>FromPyObject</code> æ·»åŠ ç¬¬äºŒä¸ªç”Ÿå‘½å‘¨æœŸï¼Œä»¥å…è®¸ä» Python å¯¹è±¡å€Ÿç”¨æ•°æ®ï¼ˆä¾‹å¦‚ï¼Œä» Python <code>str</code> å€Ÿç”¨ <code>&amp;str</code>ï¼‰ã€‚</li>
<li>ä½¿ç”¨ <code>extract</code> ä»£æ›¿ <code>extract_bound</code>ï¼Œç°åœ¨æ¥å— <code>Borrowed&lt;'a, 'py, PyAny&gt;</code>ã€‚</li>
</ul>
</li>
<li>ä¼˜åŒ– <code>bytes</code> å’Œ <code>bytearray</code> ç±»å‹çš„ <code>Vec&lt;u8&gt;</code> å’Œ <code>[u8; N]</code> çš„ <code>FromPyObject</code> å®ç°ã€‚<a href="https://github.com/PyO3/pyo3/pull/5244">#5244</a></li>
<li>å¼ƒç”¨ <code>#[pyfn]</code> å±æ€§ã€‚<a href="https://github.com/PyO3/pyo3/pull/5384">#5384</a></li>
<li>åœ¨ç±»å‹è½¬æ¢å¤±è´¥æ—¶åŠ¨æ€è·å–ç±»å‹åç§°ï¼Œè€Œéä½¿ç”¨ <code>PyTypeCheck::NAME</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/5387">#5387</a></li>
<li>å¼ƒç”¨ <code>PyTypeCheck::NAME</code>ï¼Œæ¨èä½¿ç”¨å¯è¿è¡Œæ—¶æä¾›ç±»å‹ä¿¡æ¯çš„ <code>PyTypeCheck::classinfo_object</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/5387">#5387</a></li>
<li>ç°åœ¨ <code>PyClassGuard(Mut)</code> å’Œ <code>PyRef(Mut)</code> çš„æå–ä¼šè¿”å›ä¸€ä¸ªä¸é€æ˜çš„ Rust é”™è¯¯ã€‚<a href="https://github.com/PyO3/pyo3/pull/5413">#5413</a></li>
<li>ä½¿ç”¨ <code>#[pymodule_use]</code> å¯¼å‡ºå®ç° <code>PyTypeInfo</code> çš„ç±»å‹æ—¶ï¼ŒåŠ¨æ€è·å–ç±»å‹åç§°ã€‚<a href="https://github.com/PyO3/pyo3/pull/5414">#5414</a></li>
<li>æ”¹è¿› <code>PyBuffer&lt;T&gt;</code> çš„ <code>Debug</code> è¾“å‡ºæ ¼å¼ã€‚<a href="https://github.com/PyO3/pyo3/pull/5442">#5442</a></li>
<li><code>experimental-inspect</code>ï¼šä¿®æ”¹äºŒè¿›åˆ¶æ–‡ä»¶ä¸­çš„å†…çœæ•°æ®ç”Ÿæˆæ–¹å¼ï¼Œé¿å…æŒ‡é’ˆé—´æ¥å¹¶ç®€åŒ–è§£æã€‚<a href="https://github.com/PyO3/pyo3/pull/5450">#5450</a></li>
<li>é’ˆå¯¹é™„åŠ åˆ° Python è§£é‡Šå™¨çš„æƒ…å†µä¼˜åŒ– <code>Py&lt;T&gt;::drop</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/5454">#5454</a></li>
<li>ä½¿ç”¨ <code>CastError</code> å’Œ <code>CastIntoError</code> æ›¿ä»£ <code>DowncastError</code> å’Œ <code>DowncastIntoError</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/5468">#5468</a></li>
<li>åœ¨ <code>GraalPy</code> ä¸Šä¸º 128 ä½æ•´æ•°è½¬æ¢å¯ç”¨å¿«é€Ÿè·¯å¾„ã€‚<a href="https://github.com/PyO3/pyo3/pull/5471">#5471</a></li>
<li>å¼ƒç”¨ <code>PyAnyMethods::downcast</code>ï¼Œæ¨èä½¿ç”¨ <code>Bound::cast</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/5472">#5472</a></li>
<li>å°† <code>PyTypeCheck</code> è®¾ä¸º <code>unsafe trait</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/5473">#5473</a></li>
<li>å¼ƒç”¨ä¸å®‰å…¨çš„ <code>PyCapsuleMethods</code> æ–¹æ³•ï¼š<code>pointer()</code>ã€<code>reference()</code> å’Œ <code>is_valid()</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/5474">#5474</a></li>
<li>ç¼©çŸ­ <code>PyCapsuleMethods::reference</code> è¿”å›å€¼çš„ç”Ÿå‘½å‘¨æœŸã€‚<a href="https://github.com/PyO3/pyo3/pull/5474">#5474</a></li>
<li><code>PyCapsuleMethods::name</code> ç°åœ¨è¿”å› <code>CapsuleName</code> åŒ…è£…ç±»å‹è€Œé <code>&amp;CStr</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/5474">#5474</a></li>
<li>å¼ƒç”¨ <code>import_exception_bound</code>ï¼Œæ¨èä½¿ç”¨ <code>import_exception</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/5480">#5480</a></li>
<li><code>PyList::get_item_unchecked</code>ã€<code>PyTuple::get_item_unchecked</code> å’Œ <code>PyTuple::get_borrowed_item_unchecked</code> ä¸å†æ£€æŸ¥ç´¢å¼•ä½ç½®æ˜¯å¦ä¸º null å€¼ã€‚<a href="https://github.com/PyO3/pyo3/pull/5494">#5494</a></li>
<li>å…è®¸å°† naive datetime è½¬æ¢ä¸º chrono çš„ <code>DateTime&lt;Local&gt;</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/5507">#5507</a></li>
</ul>
<h3 id="ç§»é™¤"><a class="header" href="#ç§»é™¤">ç§»é™¤</a></h3>
<ul>
<li>ç§»é™¤ <code>FromPyObjectBound</code> traitã€‚<a href="https://github.com/PyO3/pyo3/pull/4390">#4390</a></li>
</ul>
<h3 id="ä¿®å¤-2"><a class="header" href="#ä¿®å¤-2">ä¿®å¤</a></h3>
<ul>
<li>ä¿®å¤åœ¨ <code>wasm32-wasip2</code> ä¸Šçš„ç¼–è¯‘å¤±è´¥é—®é¢˜ã€‚<a href="https://github.com/PyO3/pyo3/pull/5368">#5368</a></li>
<li>ä¿®å¤ Windows ä¸Šé UTF-8 å­—ç¬¦ä¸²çš„ <code>OsStr</code> è½¬æ¢é—®é¢˜ã€‚<a href="https://github.com/PyO3/pyo3/pull/5444">#5444</a></li>
<li>ä¿®å¤å›  git å¿½ç•¥çš„æ„å»ºäº§ç‰© <code>emscripten/pybuilddir.txt</code> å¯¼è‡´çš„ <code>cargo vendor</code> é—®é¢˜ã€‚<a href="https://github.com/PyO3/pyo3/pull/5456">#5456</a></li>
<li>åœæ­¢åœ¨ <code>#[pyfunction]</code> å®ç”Ÿæˆçš„ä»£ç ä¸­æ³„éœ² <code>PyMethodDef</code> å®ä¾‹ã€‚<a href="https://github.com/PyO3/pyo3/pull/5459">#5459</a></li>
<li>ä¸å†å¯¼å‡º 32 ä½ Python 3.14 ä¸Šä¸å­˜åœ¨çš„ FFI ç»“æ„ä½“ <code>PyObjectObFlagsAndRefcnt</code> çš„å®šä¹‰ã€‚<a href="https://github.com/PyO3/pyo3/pull/5499">#5499</a></li>
<li>ä¿®å¤åœ¨ Windows ä¸Šä½¿ç”¨ maturin å†…ç½® sysconfig ç»“åˆ <code>generate-import-lib</code> åŠŸèƒ½æ„å»º <code>abi3</code> è§£é‡Šå™¨æ—¶çš„å¤±è´¥é—®é¢˜ã€‚<a href="https://github.com/PyO3/pyo3/pull/5503">#5503</a></li>
<li>ä¿®å¤ PyPy ä¸Š <code>PyModule_ExecDef</code> å’Œ <code>PyModule_FromDefAndSpec2</code> çš„ FFI å®šä¹‰ã€‚<a href="https://github.com/PyO3/pyo3/pull/5529">#5529</a></li>
</ul>
<h2 id="0260---2025-08-29"><a class="header" href="#0260---2025-08-29">[0.26.0] - 2025-08-29</a></h2>
<h3 id="æ‰“åŒ…-1"><a class="header" href="#æ‰“åŒ…-1">æ‰“åŒ…</a></h3>
<ul>
<li>å°† <code>hashbrown</code> ä¾èµ–å‡çº§è‡³ 0.15ã€‚<a href="https://github.com/PyO3/pyo3/pull/5152">#5152</a></li>
<li>æ›´æ–°æœ€ä½æ”¯æŒ Rust ç‰ˆæœ¬ï¼ˆMSRVï¼‰ä¸º 1.74ã€‚<a href="https://github.com/PyO3/pyo3/pull/5171">#5171</a></li>
<li>ä¸ºæ›¿ä»£è§£é‡Šå™¨è®¾ç½®ä¸ CPython ç›¸åŒçš„æœ€å¤§æ”¯æŒç‰ˆæœ¬ã€‚<a href="https://github.com/PyO3/pyo3/pull/5192">#5192</a></li>
<li>æ·»åŠ å¯é€‰çš„ <code>bytes</code> ä¾èµ–ä»¥æ”¯æŒ <code>bytes::Bytes</code> çš„è½¬æ¢ã€‚<a href="https://github.com/PyO3/pyo3/pull/5252">#5252</a></li>
<li>å‘å¸ƒæ–° crate <code>pyo3-introspection</code>ï¼Œä¸ <code>experimental-inspect</code> åŠŸèƒ½é…å¥—ä½¿ç”¨ã€‚<a href="https://github.com/PyO3/pyo3/pull/5300">#5300</a></li>
<li><code>PYO3_BUILD_EXTENSION_MODULE</code> ç°åœ¨ä¸ <code>extension-module</code> åŠŸèƒ½ä½œç”¨ç›¸åŒã€‚æœªæ¥ maturin å’Œ setuptools-rust å°†è‡ªåŠ¨è®¾ç½®è¯¥ç¯å¢ƒå˜é‡ï¼Œä½¿ç”¨è‡ªå®šä¹‰æ„å»ºç³»ç»Ÿçš„ç”¨æˆ·ä¹Ÿéœ€æ‰‹åŠ¨è®¾ç½®ã€‚<a href="https://github.com/PyO3/pyo3/pull/5343">#5343</a></li>
</ul>
<h3 id="æ–°å¢-1"><a class="header" href="#æ–°å¢-1">æ–°å¢</a></h3>
<ul>
<li>æ·»åŠ  <code>#[pyo3(warn(message = "...", category = ...))]</code> å±æ€§ï¼Œç”¨äºè‡ªåŠ¨ä¸º <code>#[pyfunction]</code> å’Œ <code>#[pymethods]</code> ç”Ÿæˆè­¦å‘Šä¿¡æ¯ã€‚<a href="https://github.com/PyO3/pyo3/pull/4364">#4364</a></li>
<li>æ·»åŠ  <code>PyMutex</code>ï¼Œåœ¨ Python 3.13 åŠä»¥ä¸Šç‰ˆæœ¬å¯ç”¨ã€‚<a href="https://github.com/PyO3/pyo3/pull/4523">#4523</a></li>
<li>æ·»åŠ  FFI å®šä¹‰ <code>PyMutex_IsLocked</code>ï¼Œåœ¨ Python 3.14 åŠä»¥ä¸Šç‰ˆæœ¬å¯ç”¨ã€‚<a href="https://github.com/PyO3/pyo3/pull/4523">#4523</a></li>
<li>æ·»åŠ  <code>PyString::from_encoded_object</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/5017">#5017</a></li>
<li><code>experimental-inspect</code>ï¼šæ·»åŠ åŸºæœ¬çš„è¾“å…¥ç±»å‹æ³¨è§£æ”¯æŒã€‚<a href="https://github.com/PyO3/pyo3/pull/5089">#5089</a>- æ·»åŠ æ¥è‡ª CPython 3.13 çš„ <code>PyFrameObject</code> çš„ FFI å‡½æ•°å®šä¹‰ã€‚<a href="https://github.com/PyO3/pyo3/pull/5154">#5154</a></li>
<li><code>experimental-inspect</code>ï¼šä¸ºä½¿ç”¨ <code>#[pymodule]</code> æˆ– <code>#[pymodule_init]</code> å‡½æ•°åˆ›å»ºçš„æ¨¡å—æ ‡è®°ä¸ºä¸å®Œæ•´çŠ¶æ€ã€‚<a href="https://github.com/PyO3/pyo3/pull/5207">#5207</a></li>
<li><code>experimental-inspect</code>ï¼šæ·»åŠ åŸºæœ¬çš„è¿”å›ç±»å‹æ”¯æŒã€‚<a href="https://github.com/PyO3/pyo3/pull/5208">#5208</a></li>
<li>æ·»åŠ  <code>PyCode::compile</code> å’Œ <code>PyCodeMethods::run</code> ä»¥åˆ›å»ºå’Œæ‰§è¡Œä»£ç å¯¹è±¡ã€‚<a href="https://github.com/PyO3/pyo3/pull/5217">#5217</a></li>
<li>æ·»åŠ ç”¨äºçº¿ç¨‹å®‰å…¨å•æ¬¡åˆå§‹åŒ–çš„ <code>PyOnceLock</code> ç±»å‹ã€‚<a href="https://github.com/PyO3/pyo3/pull/5223">#5223</a></li>
<li>æ·»åŠ  <code>PyClassGuard(Mut)</code> pyclass æŒæœ‰å™¨ï¼Œæœªæ¥å°†å–ä»£ <code>PyRef(Mut)</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/5233">#5233</a></li>
<li><code>experimental-inspect</code>ï¼šå…è®¸åœ¨ <code>#[pyo3(signature)]</code> ç­¾åå±æ€§ä¸­ä½¿ç”¨æ³¨è§£ã€‚<a href="https://github.com/PyO3/pyo3/pull/5241">#5241</a></li>
<li>ä¸º parking_lot / lock_api çš„ <code>ReentrantMutex</code> å®ç° <code>MutexExt</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/5258">#5258</a></li>
<li><code>experimental-inspect</code>ï¼šæ”¯æŒç±»å…³è”å¸¸é‡ã€‚<a href="https://github.com/PyO3/pyo3/pull/5272">#5272</a></li>
<li>æ·»åŠ æ›¿ä»£ <code>PyAnyMethods::downcast</code> ç³»åˆ—å‡½æ•°çš„ <code>Bound::cast</code> å‡½æ•°æ—ã€‚<a href="https://github.com/PyO3/pyo3/pull/5289">#5289</a></li>
<li>æ·»åŠ  FFI å®šä¹‰ <code>Py_Version</code> å’Œ <code>Py_IsFinalizing</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/5317">#5317</a></li>
<li><code>experimental-inspect</code>ï¼šä¸º <code>#[pyclass]</code> æ·»åŠ è¾“å‡ºç±»å‹æ³¨è§£ã€‚<a href="https://github.com/PyO3/pyo3/pull/5320">#5320</a></li>
<li><code>experimental-inspect</code>ï¼šæ”¯æŒ <code>#[pyclass(eq, eq_int, ord, hash, str)]</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/5338">#5338</a></li>
<li><code>experimental-inspect</code>ï¼šä¸º <code>#[derive(FromPyObject)]</code> æ·»åŠ åŸºæœ¬æ”¯æŒï¼ˆå°šä¸æ”¯æŒç»“æ„ä½“å­—æ®µï¼‰ã€‚<a href="https://github.com/PyO3/pyo3/pull/5339">#5339</a></li>
<li>æ·»åŠ  <code>Python::try_attach</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/5342">#5342</a></li>
</ul>
<h3 id="å˜æ›´"><a class="header" href="#å˜æ›´">å˜æ›´</a></h3>
<ul>
<li>å¯¹äºæœªä½¿ç”¨ <code>#[new]</code> çš„ <code>#[pyclass]</code>ï¼Œåœ¨ Python 3.10 åŠä»¥ä¸Šç‰ˆæœ¬ä¸­ä½¿ç”¨ <code>Py_TPFLAGS_DISALLOW_INSTANTIATION</code> æ›¿ä»£æ€»æ˜¯å¤±è´¥çš„ <code>__new__</code> æ–¹æ³•ã€‚<a href="https://github.com/PyO3/pyo3/pull/4568">#4568</a></li>
<li><code>PyModule::from_code</code> ç°åœ¨è‹¥ <code>file_name</code> ä¸ºç©ºï¼Œåˆ™é»˜è®¤ä¸º <code>&lt;string&gt;</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/4777">#4777</a></li>
<li>å¼ƒç”¨ <code>PyString::from_object</code>ï¼Œæ¨èä½¿ç”¨ <code>PyString::from_encoded_object</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/5017">#5017</a></li>
<li>å½“ä½¿ç”¨ <code>abi3</code> æ„å»ºä¸”ç›®æ ‡ Python ç‰ˆæœ¬é«˜äº PyO3 æ”¯æŒçš„ç‰ˆæœ¬æ—¶ï¼Œè‡ªåŠ¨å›é€€åˆ°æ”¯æŒçš„æœ€æ–°ç‰ˆæœ¬çš„ abi3 æ„å»ºã€‚<a href="https://github.com/PyO3/pyo3/pull/5144">#5144</a></li>
<li>å°† <code>is_instance_of</code> çš„ trait bound ä» <code>PyTypeInfo</code> æ›´æ”¹ä¸º <code>PyTypeCheck</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/5146">#5146</a></li>
<li>è®¸å¤š PyO3 è¿‡ç¨‹å®ç°åœ¨ä¼šæŠ¥å‘Šå¤šä¸ªé”™è¯¯è€Œéä»…ç¬¬ä¸€ä¸ªã€‚<a href="https://github.com/PyO3/pyo3/pull/5159">#5159</a></li>
<li>æ›´æ”¹ <code>MutexExt</code> çš„è¿”å›ç±»å‹ä¸ºå…³è”ç±»å‹ã€‚<a href="https://github.com/PyO3/pyo3/pull/5201">#5201</a></li>
<li>ä½¿ç”¨ <code>PyCallArgs</code> å®ç° <code>Py::call</code> åŠå…¶ç›¸å…³å‡½æ•°ï¼Œä½¿å…¶ä¸å¯¹åº”çš„ <code>Bound</code> æ–¹æ³•ç­‰æ•ˆã€‚<a href="https://github.com/PyO3/pyo3/pull/5206">#5206</a></li>
<li>å°† <code>Python::with_gil</code> é‡å‘½åä¸º <code>Python::attach</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/5209">#5209</a></li>
<li>å°† <code>Python::allow_threads</code> é‡å‘½åä¸º <code>Python::detach</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/5221">#5221</a></li>
<li>å¼ƒç”¨ <code>GILOnceCell</code> ç±»å‹ï¼Œæ¨èä½¿ç”¨ <code>PyOnceLock</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/5223">#5223</a></li>
<li>å°† <code>pyo3::prepare_freethreaded_python</code> é‡å‘½åä¸º <code>Python::initialize</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/5247">#5247</a></li>
<li>åœ¨ <code>PyMemoryError</code> ä¸ <code>io::ErrorKind::OutOfMemory</code> ä¹‹é—´è¿›è¡Œè½¬æ¢ã€‚<a href="https://github.com/PyO3/pyo3/pull/5256">#5256</a></li>
<li>å¼ƒç”¨ <code>GILProtected</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/5285">#5285</a></li>
<li>å°† <code>#[pyclass]</code> æ–‡æ¡£å­—ç¬¦ä¸²æ ¼å¼åŒ–ä»å¯¼å…¥æ—¶ç§»è‡³ç¼–è¯‘æ—¶ã€‚<a href="https://github.com/PyO3/pyo3/pull/5286">#5286</a></li>
<li>è‹¥ Python è§£é‡Šå™¨æ­£åœ¨å…³é—­ï¼Œåˆ™ <code>Python::attach</code> ç°åœ¨ä¼šè§¦å‘ panicã€‚<a href="https://github.com/PyO3/pyo3/pull/5317">#5317</a></li>
<li>ä¸º <code>#[pyclass]</code> ç±»å‹åœ¨ <code>PyTypeInfo::type_object</code> ä¸­æ·»åŠ å¿«é€Ÿè·¯å¾„ã€‚<a href="https://github.com/PyO3/pyo3/pull/5324">#5324</a></li>
<li>å¼ƒç”¨ <code>PyObject</code> ä½œä¸º <code>Py&lt;PyAny&gt;</code> çš„ç±»å‹åˆ«åã€‚<a href="https://github.com/PyO3/pyo3/pull/5325">#5325</a></li>
<li>å°† <code>Python::with_gil_unchecked</code> é‡å‘½åä¸º <code>Python::attach_unchecked</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/5340">#5340</a></li>
<li>å°† <code>Python::assume_gil_acquired</code> é‡å‘½åä¸º <code>Python::assume_attached</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/5354">#5354</a></li>
</ul>
<h3 id="ç§»é™¤-1"><a class="header" href="#ç§»é™¤-1">ç§»é™¤</a></h3>
<ul>
<li>ç§»é™¤ <code>PyFrameObject</code> å†…éƒ¨ç»“æ„çš„ FFI å®šä¹‰ã€‚<a href="https://github.com/PyO3/pyo3/pull/5154">#5154</a></li>
<li>ç§»é™¤ FFI å®šä¹‰ <code>PyGetSetDef</code> çš„ <code>Eq</code> å’Œ <code>PartialEq</code> å®ç°ã€‚<a href="https://github.com/PyO3/pyo3/pull/5196">#5196</a></li>
<li>ç§»é™¤ç§æœ‰çš„ FFI å®šä¹‰ <code>_Py_IsCoreInitialized</code> å’Œ <code>_Py_InitializeMain</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/5317">#5317</a></li>
</ul>
<h3 id="ä¿®å¤-3"><a class="header" href="#ä¿®å¤-3">ä¿®å¤</a></h3>
<ul>
<li>åœ¨è‡ªç”±çº¿ç¨‹æ„å»ºä¸­ï¼Œ<code>PyByteArray::to_vec</code> ä½¿ç”¨ä¸´ç•ŒåŒºä»¥æ¨¡æ‹Ÿ GIL å¯ç”¨æ—¶çš„â€œå®‰å…¨æ€§â€ã€‚<a href="https://github.com/PyO3/pyo3/pull/4742">#4742</a></li>
<li>ä¿®å¤å°† <code>bigdecimal</code> è½¬æ¢ä¸º Python æ—¶çš„ç²¾åº¦ä¸¢å¤±é—®é¢˜ã€‚<a href="https://github.com/PyO3/pyo3/pull/5198">#5198</a></li>
<li>ä¸å†å°† win7 ç›®æ ‡è§†ä¸ºäº¤å‰ç¼–è¯‘ã€‚<a href="https://github.com/PyO3/pyo3/pull/5210">#5210</a></li>
<li>å¯¹äº Python &lt; 3.14 çš„ WASM ç›®æ ‡ä¸å†éœ€è¦å¼‚å¸¸å¤„ç†æ”¯æŒã€‚<a href="https://github.com/PyO3/pyo3/pull/5239">#5239</a></li>
<li>ä¿®å¤ Python è§£é‡Šå™¨æœ€ç»ˆåŒ–åï¼Œ<code>PyBuffer&lt;T&gt;</code> è¢« drop æ—¶çš„æ®µé”™è¯¯ã€‚<a href="https://github.com/PyO3/pyo3/pull/5242">#5242</a></li>
<li><code>experimental-inspect</code>ï¼šæ”¹è¿›è‡ªåŠ¨ç”Ÿæˆå¯¼å…¥çš„åŠŸèƒ½ã€‚<a href="https://github.com/PyO3/pyo3/pull/5251">#5251</a></li>
<li><code>experimental-inspect</code>ï¼šä¿®å¤ <code>__richcmp__</code>ã€<code>__concat__</code>ã€<code>__repeat__</code>ã€<code>__inplace_concat__</code> å’Œ <code>__inplace_repeat__</code> çš„å†…çœåŠŸèƒ½ã€‚<a href="https://github.com/PyO3/pyo3/pull/5273">#5273</a></li>
<li>ä¿®å¤ä½¿ç”¨ <code>PyRef::into_super</code> å°†å¯å˜å­ç±»è½¬æ¢ä¸ºå†»ç»“åŸºç±»æ—¶å‘ç”Ÿçš„å€Ÿç”¨æ³„éœ²é—®é¢˜ã€‚<a href="https://github.com/PyO3/pyo3/pull/5281">#5281</a></li>
<li>ä¿®å¤ FFI å®šä¹‰ <code>Py_Exit</code>ï¼ˆè¯¥å‡½æ•°æ°¸ä¸è¿”å›ï¼ŒåŸè¿”å›å€¼ä¸º <code>()</code>ï¼Œç°æ”¹ä¸º <code>!</code>ï¼‰ã€‚<a href="https://github.com/PyO3/pyo3/pull/5317">#5317</a></li>
<li><code>experimental-inspect</code>ï¼šä¿®å¤å¤„ç†è¢« <code>#[cfg(...)]</code> å±æ€§å±è”½çš„æ¨¡å—æˆå‘˜çš„é—®é¢˜ã€‚<a href="https://github.com/PyO3/pyo3/pull/5318">#5318</a></li>
</ul>
<h2 id="0251---2025-06-12"><a class="header" href="#0251---2025-06-12">[0.25.1] - 2025-06-12</a></h2>
<h3 id="æ‰“åŒ…-2"><a class="header" href="#æ‰“åŒ…-2">æ‰“åŒ…</a></h3>
<ul>
<li>æ·»åŠ å¯¹ Windows on ARM64 çš„æ”¯æŒã€‚<a href="https://github.com/PyO3/pyo3/pull/5145">#5145</a></li>
<li>æ·»åŠ  <code>chrono-local</code> ç‰¹æ€§ï¼Œç”¨äºå¯é€‰åœ°è½¬æ¢ chrono çš„ <code>Local</code> æ—¶åŒºå’Œ <code>DateTime&lt;Local&gt;</code> å®ä¾‹ã€‚<a href="https://github.com/PyO3/pyo3/pull/5174">#5174</a></li>
</ul>
<h3 id="æ–°å¢-2"><a class="header" href="#æ–°å¢-2">æ–°å¢</a></h3>
<ul>
<li>æ·»åŠ  FFI å®šä¹‰ <code>PyBytes_AS_STRING</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/5121">#5121</a></li>
<li>æ·»åŠ å¯¹æ¨¡å—å…³è”å¸¸é‡å†…çœçš„æ”¯æŒã€‚<a href="https://github.com/PyO3/pyo3/pull/5150">#5150</a></li>
</ul>
<h3 id="å˜æ›´-1"><a class="header" href="#å˜æ›´-1">å˜æ›´</a></h3>
<ul>
<li>åœ¨ GraalPy ä¸Šå¯ç”¨ â€œvectorcallâ€ FFI å®šä¹‰ã€‚<a href="https://github.com/PyO3/pyo3/pull/5121">#5121</a></li>
<li>åœ¨ GraalPy ä¸Šä½¿ç”¨ <code>Py_Is</code> å‡½æ•°ã€‚<a href="https://github.com/PyO3/pyo3/pull/5121">#5121</a></li>
</ul>
<h3 id="ä¿®å¤-4"><a class="header" href="#ä¿®å¤-4">ä¿®å¤</a></h3>
<ul>
<li>å½“æœªä½¿ç”¨ <code>experimental-async</code> ç‰¹æ€§æ—¶ï¼Œä¸º <code>async</code> å£°æ˜æä¾›æ›´æ¸…æ™°çš„ç¼–è¯‘é”™è¯¯æç¤ºã€‚<a href="https://github.com/PyO3/pyo3/pull/5156">#5156</a></li>
<li>ä¿®å¤åœ¨å¤§ç«¯æ¶æ„ä¸Š <code>uuid::Uuid</code> çš„ <code>FromPyObject</code> å®ç°ã€‚<a href="https://github.com/PyO3/pyo3/pull/5161">#5161</a></li>
<li>ä¿®å¤ Python 3.14 ä¸ 32 ä½ x86 æ¶æ„ä¸Šçš„æ®µé”™è¯¯ã€‚<a href="https://github.com/PyO3/pyo3/pull/5180">#5180</a></li>
</ul>
<h2 id="0250---2025-05-14"><a class="header" href="#0250---2025-05-14">[0.25.0] - 2025-05-14</a></h2>
<h3 id="æ‰“åŒ…-3"><a class="header" href="#æ‰“åŒ…-3">æ‰“åŒ…</a></h3>
<ul>
<li>æ”¯æŒ Python 3.14.0b1ã€‚<a href="https://github.com/PyO3/pyo3/pull/4811">#4811</a></li>
<li>å‡çº§æ”¯æŒçš„ GraalPy ç‰ˆæœ¬è‡³ 24.2ã€‚<a href="https://github.com/PyO3/pyo3/pull/5116">#5116</a></li>
<li>æ·»åŠ å¯é€‰ä¾èµ– <code>bigdecimal</code>ï¼Œä»¥æ”¯æŒ <code>bigdecimal::BigDecimal</code> çš„ç±»å‹è½¬æ¢ã€‚<a href="https://github.com/PyO3/pyo3/pull/5011">#5011</a></li>
<li>æ·»åŠ å¯é€‰ä¾èµ– <code>time</code>ï¼Œä»¥æ”¯æŒ <code>time</code> ç±»å‹çš„è½¬æ¢ã€‚<a href="https://github.com/PyO3/pyo3/pull/5057">#5057</a></li>
<li>ç§»é™¤ <code>cfg-if</code> ä¾èµ–ã€‚<a href="https://github.com/PyO3/pyo3/pull/5110">#5110</a></li>
<li>æ·»åŠ å¯é€‰ä¾èµ– <code>ordered_float</code>ï¼Œä»¥æ”¯æŒ <code>ordered_float::NotNan</code> å’Œ <code>ordered_float::OrderedFloat</code> çš„è½¬æ¢ã€‚<a href="https://github.com/PyO3/pyo3/pull/5114">#5114</a></li>
</ul>
<h3 id="æ–°å¢-3"><a class="header" href="#æ–°å¢-3">æ–°å¢</a></h3>
<ul>
<li>ä¸º <code>experimental-inspect</code> ç‰¹æ€§æ·»åŠ åˆæ­¥çš„ç±»å‹å­˜æ ¹ç”ŸæˆåŠŸèƒ½ã€‚<a href="https://github.com/PyO3/pyo3/pull/3977">#3977</a></li>
<li>æ·»åŠ  <code>#[pyclass(generic)]</code> é€‰é¡¹ä»¥æ”¯æŒè¿è¡Œæ—¶æ³›å‹ç±»å‹ã€‚<a href="https://github.com/PyO3/pyo3/pull/4926">#4926</a></li>
<li>ä¸º <code>parking_lot</code> å’Œ <code>lock_api</code> å®ç° <code>OnceExt</code> å’Œ <code>MutexExt</code>ã€‚é€šè¿‡å¯ç”¨ <code>arc_lock</code>ã€<code>lock_api</code> æˆ– <code>parking_lot</code> cargo ç‰¹æ€§æ¥ä½¿ç”¨è¿™äº›æ‰©å±• traitã€‚<a href="https://github.com/PyO3/pyo3/pull/5044">#5044</a></li>
<li>å®ç° <code>Borrowed&lt;T&gt;</code> â†’ <code>Py&lt;T&gt;</code> çš„ <code>From</code>/<code>Into</code> è½¬æ¢ã€‚<a href="https://github.com/PyO3/pyo3/pull/5054">#5054</a></li>
<li>æ·»åŠ  <code>PyTzInfo</code> æ„é€ å‡½æ•°ã€‚<a href="https://github.com/PyO3/pyo3/pull/5055">#5055</a></li>
<li>æ·»åŠ  FFI å®šä¹‰ <code>PY_INVALID_STACK_EFFECT</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/5064">#5064</a></li>
<li>ä¸º <code>Py&lt;T&gt;</code>ã€<code>Bound&lt;T&gt;</code> å’Œ <code>Borrowed&lt;T&gt;</code> å®ç° <code>AsRef&lt;Py&lt;PyAny&gt;&gt;</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/5071">#5071</a></li>
<li>æ·»åŠ  FFI å®šä¹‰ <code>PyModule_Add</code> å’Œ <code>compat::PyModule_Add</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/5085">#5085</a></li>
<li>æ·»åŠ  FFI å®šä¹‰ <code>Py_HashBuffer</code>ã€<code>Py_HashPointer</code> å’Œ <code>PyObject_GenericHash</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/5086">#5086</a></li>
<li>åœ¨å£°æ˜å¼æ¨¡å—ä¸­æ”¯æŒ <code>#[pymodule_export]</code> åº”ç”¨äº <code>const</code> é¡¹ã€‚<a href="https://github.com/PyO3/pyo3/pull/5096">#5096</a></li>
<li>æ·»åŠ  <code>#[pyclass(immutable_type)]</code> é€‰é¡¹ï¼ˆPython 3.14+ å¯ç”¨ <code>abi3</code> æ—¶ï¼Œæˆ– 3.10+ å…¶ä»–æƒ…å†µï¼‰ä»¥åˆ›å»ºä¸å¯å˜ç±»å‹å¯¹è±¡ã€‚<a href="https://github.com/PyO3/pyo3/pull/5101">#5101</a></li>
<li>æ”¯æŒåœ¨ <code>#[derive(IntoPyObject)]</code> ä¸Šä½¿ç”¨ <code>#[pyo3(rename_all)]</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/5112">#5112</a></li>
<li>æ·»åŠ  <code>PyRange</code> åŒ…è£…å™¨ã€‚<a href="https://github.com/PyO3/pyo3/pull/5117">#5117</a></li>
</ul>
<h3 id="å˜æ›´-2"><a class="header" href="#å˜æ›´-2">å˜æ›´</a></h3>
<ul>
<li>å…è®¸åœ¨å¯ç”¨ <code>abi3</code> ç‰¹æ€§æ—¶ä½¿ç”¨ <code>datetime</code> ç±»å‹ã€‚<a href="https://github.com/PyO3/pyo3/pull/4970">#4970</a></li>
<li>å¼ƒç”¨ <code>timezone_utc</code>ï¼Œæ¨èä½¿ç”¨ <code>PyTzInfo::utc</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/5055">#5055</a></li>
<li>é™ä½éƒ¨åˆ† CPython å®ç°ç»†èŠ‚çš„å¯è§æ€§ï¼š<a href="https://github.com/PyO3/pyo3/pull/5064">#5064</a>
<ul>
<li>FFI å®šä¹‰ <code>PyCodeObject</code> ç°åœ¨åœ¨æ‰€æœ‰ Python ç‰ˆæœ¬ä¸Šå‡ä¸ºä¸é€æ˜ç»“æ„ä½“ã€‚  - FFI å®šä¹‰ <code>PyFutureFeatures</code> ç°åœ¨ä»…å®šä¹‰åˆ° Python 3.10 ä¸ºæ­¢ï¼ˆå®ƒåœ¨ CPython å¤´æ–‡ä»¶ä¸­å­˜åœ¨ï¼Œä½†åœ¨ 3.11 å’Œ 3.12 ä¸­æœªä½¿ç”¨ï¼‰ã€‚</li>
</ul>
</li>
<li>å°† <code>PyAnyMethods::is</code> æ›´æ”¹ä¸ºæ¥å— <code>other: &amp;Bound&lt;T&gt;</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/5071">#5071</a></li>
<li>å°† <code>Py::is</code> æ›´æ”¹ä¸ºæ¥å— <code>other: &amp;Py&lt;T&gt;</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/5071">#5071</a></li>
<li>å°† <code>PyVisit::call</code> æ›´æ”¹ä¸ºæ¥å— <code>T: Into&lt;Option&lt;&amp;Py&lt;T&gt;&gt;&gt;</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/5071">#5071</a></li>
<li>åœ¨ PyPy 3.10 åŠæ›´é«˜ç‰ˆæœ¬ä¸Šæš´éœ² <code>PyDateTime_DATE_GET_TZINFO</code> å’Œ <code>PyDateTime_TIME_GET_TZINFO</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/5079">#5079</a></li>
<li>ä¸º <code>with_gil</code> å’Œ <code>with_gil_unchecked</code> æ·»åŠ  <code>#[track_caller]</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/5109">#5109</a></li>
<li>ä½¿ç”¨ <code>std::thread::park()</code> ä»£æ›¿ <code>libc::pause()</code> æˆ– <code>sleep(9999999)</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/5115">#5115</a></li>
</ul>
<h3 id="å·²ç§»é™¤"><a class="header" href="#å·²ç§»é™¤">å·²ç§»é™¤</a></h3>
<ul>
<li>ç§»é™¤ PyO3 0.23 ä¸­å·²å¼ƒç”¨çš„æ‰€æœ‰åŠŸèƒ½ã€‚<a href="https://github.com/PyO3/pyo3/pull/4982">#4982</a></li>
<li>ç§»é™¤å·²å¼ƒç”¨çš„ <code>IntoPy</code> å’Œ <code>ToPyObject</code> traitã€‚<a href="https://github.com/PyO3/pyo3/pull/5010">#5010</a></li>
<li>ä» <code>pyo3-ffi</code> ä¸­ç§»é™¤æœªè¢«å…¬å…± API å¼•ç”¨çš„ç§æœ‰ç±»å‹ï¼ˆå³ä»¥ <code>_Py</code> å¼€å¤´çš„ç±»å‹ï¼‰ï¼š<code>_PyLocalMonitors</code>ã€<code>_Py_GlobalMonitors</code>ã€<code>_PyCoCached</code>ã€<code>_PyCoLineInstrumentationData</code>ã€<code>_PyCoMonitoringData</code>ã€<code>_PyCompilerSrcLocation</code>ã€<code>_PyErr_StackItem</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/5064">#5064</a></li>
<li>ç§»é™¤ FFI å®šä¹‰ <code>PyCode_GetNumFree</code>ï¼ˆç”±äºå¯¹ä»£ç å¯¹è±¡çš„äº†è§£ï¼ŒPyO3 æ— æ³•æ”¯æŒï¼‰ã€‚<a href="https://github.com/PyO3/pyo3/pull/5064">#5064</a></li>
<li>ç§»é™¤ <code>AsPyPointer</code> traitã€‚<a href="https://github.com/PyO3/pyo3/pull/5071">#5071</a></li>
<li>ç§»é™¤å¯¹å·²å¼ƒç”¨çš„å­—ç¬¦ä¸²å½¢å¼ <code>from_py_with</code> çš„æ”¯æŒã€‚<a href="https://github.com/PyO3/pyo3/pull/5097">#5097</a></li>
<li>ç§»é™¤ç§æœ‰é™æ€å˜é‡çš„ FFI å®šä¹‰ï¼š<code>_PyMethodWrapper_Type</code>ã€<code>_PyCoroWrapper_Type</code>ã€<code>_PyImport_FrozenBootstrap</code>ã€<code>_PyImport_FrozenStdlib</code>ã€<code>_PyImport_FrozenTest</code>ã€<code>_PyManagedBuffer_Type</code>ã€<code>_PySet_Dummy</code>ã€<code>_PyWeakref_ProxyType</code> å’Œ <code>_PyWeakref_CallableProxyType</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/5105">#5105</a></li>
<li>åœ¨ Python 3.14 åŠæ›´é«˜ç‰ˆæœ¬ä¸Šç§»é™¤ FFI å®šä¹‰ <code>PyASCIIObjectState</code>ã€<code>PyUnicode_IS_ASCII</code>ã€<code>PyUnicode_IS_COMPACT</code> å’Œ <code>PyUnicode_IS_COMPACT_ASCII</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/5133">#5133</a></li>
</ul>
<h3 id="å·²ä¿®å¤"><a class="header" href="#å·²ä¿®å¤">å·²ä¿®å¤</a></h3>
<ul>
<li>åœ¨ä» sysconfigdata è¯»å–ä¿¡æ¯æ—¶ï¼Œæ­£ç¡®è·å–åŸºäº conda çš„ Python å®‰è£…çš„å…±äº«çŠ¶æ€ã€‚<a href="https://github.com/PyO3/pyo3/pull/5037">#5037</a></li>
<li>ä¿®å¤å½“ä½¿ç”¨ä»…è¢«ä¸¤ä¸ª derive ä¹‹ä¸€è¯†åˆ«çš„ <code>#[pyo3()]</code> é€‰é¡¹æ—¶ï¼Œ<code>#[derive(IntoPyObject, FromPyObject)]</code> å¯¼è‡´çš„ç¼–è¯‘å¤±è´¥ã€‚<a href="https://github.com/PyO3/pyo3/pull/5070">#5070</a></li>
<li>ä¿®å¤åœ¨ PyPy å’Œ GraalPy ä¸Šä½¿ç”¨æŸäº›åŠŸèƒ½ç»„åˆæ—¶å› ç¼ºå°‘ FFI å®šä¹‰å¯¼è‡´çš„å„ç§ç¼–è¯‘é”™è¯¯ã€‚<a href="https://github.com/PyO3/pyo3/pull/5091">#5091</a></li>
<li>åœ¨å°†æ—¶åŒºè½¬æ¢ä¸º Python æ—¶ï¼Œå¯¹ Python &lt;3.9 å›é€€ä½¿ç”¨ <code>backports.zoneinfo</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/5120">#5120</a></li>
</ul>
<h2 id="0242---2025-04-21"><a class="header" href="#0242---2025-04-21">[0.24.2] - 2025-04-21</a></h2>
<h3 id="å·²ä¿®å¤-1"><a class="header" href="#å·²ä¿®å¤-1">å·²ä¿®å¤</a></h3>
<ul>
<li>ä¿®å¤åœ¨ <code>macro_rules</code> ä¸Šä¸‹æ–‡ä¸­å±•å¼€ <code>#[pyfunction]</code> å’Œ <code>#[pymethods]</code> æ—¶å¯¼è‡´çš„ <code>unused_imports</code> lint æç¤ºã€‚<a href="https://github.com/PyO3/pyo3/pull/5030">#5030</a></li>
<li>ä¿®å¤åœ¨ Python 3.13 ä¸Šï¼Œ<code>PyCodeObject::_co_instrumentation_version</code> FFI ç»“æ„æˆå‘˜åœ¨ <code>uintptr_t</code> ä¸æ˜¯ 64 ä½çš„ç³»ç»Ÿä¸Šçš„å¤§å°é—®é¢˜ã€‚<a href="https://github.com/PyO3/pyo3/pull/5048">#5048</a></li>
<li>ä¿®å¤ç»“æ„ä½“ç±»å‹æšä¸¾å˜ä½“å­—æ®µåœ¨ Python ç»‘å®šä¸­é”™è¯¯åœ°å°†åŸå§‹æ ‡è¯†ç¬¦æš´éœ²ä¸º <code>r#ident</code> çš„é—®é¢˜ã€‚<a href="https://github.com/PyO3/pyo3/pull/5050">#5050</a></li>
</ul>
<h2 id="0241---2025-03-31"><a class="header" href="#0241---2025-03-31">[0.24.1] - 2025-03-31</a></h2>
<h3 id="æ–°å¢-4"><a class="header" href="#æ–°å¢-4">æ–°å¢</a></h3>
<ul>
<li>æ·»åŠ  <code>abi3-py313</code> åŠŸèƒ½ã€‚<a href="https://github.com/PyO3/pyo3/pull/4969">#4969</a></li>
<li>æ·»åŠ  <code>PyAnyMethods::getattr_opt</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/4978">#4978</a></li>
<li>ä¸ºæ‰€æœ‰æ”¯æŒçš„æ•°å­—ç±»å‹ï¼ˆi32ã€u32ã€i64ã€u64ã€isizeã€usizeï¼‰æ·»åŠ  <code>PyInt::new</code> æ„é€ å‡½æ•°ã€‚<a href="https://github.com/PyO3/pyo3/pull/4984">#4984</a></li>
<li>æ·»åŠ  <code>pyo3::sync::with_critical_section2</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/4992">#4992</a></li>
<li>ä¸º <code>Borrowed&lt;'_, 'py, PyTuple&gt;</code>ã€<code>&amp;Bound&lt;'py, PyTuple&gt;</code> å’Œ <code>&amp;Py&lt;PyTuple&gt;</code> å®ç° <code>PyCallArgs</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/5013">#5013</a></li>
</ul>
<h3 id="å·²ä¿®å¤-2"><a class="header" href="#å·²ä¿®å¤-2">å·²ä¿®å¤</a></h3>
<ul>
<li>ä¿®å¤åŸç”Ÿç±»å‹çš„ <code>is_type_of</code> æœªä½¿ç”¨ä¸ <code>is_type_of_bound</code> ç›¸åŒçš„ç‰¹æ®ŠåŒ–æ£€æŸ¥çš„é—®é¢˜ã€‚<a href="https://github.com/PyO3/pyo3/pull/4981">#4981</a></li>
<li>ä¿®å¤ <code>#[pymethods]</code> ä¸­ <code>Probe</code> ç±»çš„å‘½åé—®é¢˜ã€‚<a href="https://github.com/PyO3/pyo3/pull/4988">#4988</a></li>
<li>ä¿®å¤å½“å¿…å¡«çš„ <code>#[pyfunction]</code> å‚æ•°ä¸º <code>Option&lt;&amp;str&gt;</code> å’Œ <code>Option&lt;&amp;T&gt;</code>ï¼ˆé’ˆå¯¹ <code>#[pyclass]</code> ç±»å‹ï¼‰æ—¶çš„ç¼–è¯‘å¤±è´¥ã€‚<a href="https://github.com/PyO3/pyo3/pull/5002">#5002</a></li>
<li>ä¿®å¤ <code>PyString::from_object</code> åœ¨ <code>encoding</code> å’Œ <code>errors</code> å‚æ•°æœªä»¥ null ç»“å°¾æ—¶å¯¼è‡´çš„è¶Šç•Œè¯»å–ã€‚<a href="https://github.com/PyO3/pyo3/pull/5008">#5008</a></li>
<li>ä¿®å¤å½“ <code>#[pyfunction]</code> çš„ <code>crate</code> ä¹‹åè¿˜æœ‰å…¶ä»–é€‰é¡¹æ—¶çš„ç¼–è¯‘é”™è¯¯ã€‚<a href="https://github.com/PyO3/pyo3/pull/5015">#5015</a></li>
</ul>
<h2 id="0240---2025-03-09"><a class="header" href="#0240---2025-03-09">[0.24.0] - 2025-03-09</a></h2>
<h3 id="æ‰“åŒ…-4"><a class="header" href="#æ‰“åŒ…-4">æ‰“åŒ…</a></h3>
<ul>
<li>å‘ Cargo åŒ…å…ƒæ•°æ®ä¸­æ·»åŠ æ”¯æŒçš„ CPython/PyPy ç‰ˆæœ¬ã€‚<a href="https://github.com/PyO3/pyo3/pull/4756">#4756</a></li>
<li>å°† <code>target-lexicon</code> ä¾èµ–å‡çº§è‡³ 0.13ã€‚<a href="https://github.com/PyO3/pyo3/pull/4822">#4822</a></li>
<li>æ·»åŠ å¯é€‰çš„ <code>jiff</code> ä¾èµ–ä»¥æ”¯æŒ <code>jiff</code> æ—¥æœŸæ—¶é—´ç±»å‹çš„è½¬æ¢ã€‚<a href="https://github.com/PyO3/pyo3/pull/4823">#4823</a></li>
<li>æ·»åŠ å¯é€‰çš„ <code>uuid</code> ä¾èµ–ä»¥æ”¯æŒ <code>uuid::Uuid</code> çš„è½¬æ¢ã€‚<a href="https://github.com/PyO3/pyo3/pull/4864">#4864</a></li>
<li>å°†æœ€ä½æ”¯æŒçš„ <code>inventory</code> ç‰ˆæœ¬æå‡è‡³ 0.3.5ã€‚<a href="https://github.com/PyO3/pyo3/pull/4954">#4954</a></li>
</ul>
<h3 id="æ–°å¢-5"><a class="header" href="#æ–°å¢-5">æ–°å¢</a></h3>
<ul>
<li>æ·»åŠ  <code>PyIterator::send</code> æ–¹æ³•ï¼Œå…è®¸å‘ Python ç”Ÿæˆå™¨å‘é€å€¼ã€‚<a href="https://github.com/PyO3/pyo3/pull/4746">#4746</a></li>
<li>æ·»åŠ  <code>PyCallArgs</code> trait ä»¥å‘ Python è°ƒç”¨åè®®ä¼ å‚ã€‚è¿™ä½¿å¾—å¯¹æŸäº›ç±»å‹ä½¿ç”¨æ›´å¿«çš„è°ƒç”¨çº¦å®šï¼Œä»è€Œæå‡æ€§èƒ½ã€‚<a href="https://github.com/PyO3/pyo3/pull/4768">#4768</a></li>
<li>ä¸º <code>#[derive(FromPyObject)]</code> æ·»åŠ  <code>#[pyo3(default = ...')]</code> é€‰é¡¹ï¼Œç”¨äºä¸ºå‘½åç»“æ„ä½“å­—æ®µè®¾ç½®é»˜è®¤å€¼ã€‚<a href="https://github.com/PyO3/pyo3/pull/4829">#4829</a></li>
<li>æ·»åŠ  <code>#[pyo3(into_py_with = ...)]</code> é€‰é¡¹ç”¨äº <code>#[derive(IntoPyObject, IntoPyObjectRef)]</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/4850">#4850</a></li>
<li>æ·»åŠ  FFI å®šä¹‰ <code>PyThreadState_GetFrame</code> å’Œ <code>PyFrame_GetBack</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/4866">#4866</a></li>
<li>ä¼˜åŒ– <code>BoundListIterator</code>ã€<code>BoundTupleIterator</code> å’Œ <code>BorrowedTupleIterator</code> çš„ <code>last</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/4878">#4878</a></li>
<li>ä¼˜åŒ– <code>PyDict</code>ã€<code>PyList</code>ã€<code>PyTuple</code> å’Œ <code>PySet</code> çš„ <code>Iterator::count()</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/4878">#4878</a></li>
<li>ä¼˜åŒ– <code>BoundTupleIterator</code> çš„ <code>nth</code>ã€<code>nth_back</code>ã€<code>advance_by</code> å’Œ <code>advance_back_by</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/4897">#4897</a></li>
<li>æ·»åŠ å¯¹ <code>types.GenericAlias</code> ä½œä¸º <code>pyo3::types::PyGenericAlias</code> çš„æ”¯æŒã€‚<a href="https://github.com/PyO3/pyo3/pull/4917">#4917</a></li>
<li>æ·»åŠ  <code>MutextExt</code> trait ä»¥å¸®åŠ©åœ¨é”å®š <code>std::sync::Mutex</code> æ—¶é¿å… GIL æ­»é”ã€‚<a href="https://github.com/PyO3/pyo3/pull/4934">#4934</a></li>
<li>ä¸º <code>#[derive(FromPyObject)]</code> æ·»åŠ  <code>#[pyo3(rename_all = "...")]</code> é€‰é¡¹ã€‚<a href="https://github.com/PyO3/pyo3/pull/4941">#4941</a></li>
</ul>
<h3 id="æ›´æ”¹-2"><a class="header" href="#æ›´æ”¹-2">æ›´æ”¹</a></h3>
<ul>
<li>ä¼˜åŒ– <code>BoundListIterator</code> çš„ <code>nth</code>ã€<code>nth_back</code>ã€<code>advance_by</code> å’Œ <code>advance_back_by</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/4810">#4810</a></li>
<li>åœ¨ <code>PyObject</code> çš„ <code>From&lt;Py&lt;T&gt;&gt;</code> å’Œ <code>From&lt;Bound&lt;'py, T&gt;&gt;</code> çš„æ³›å‹å®ç°ä¸­ä½¿ç”¨ <code>DerefToPyAny</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/4593">#4593</a></li>
<li>åœ¨ Rust 1.83+ ä¸Šå°† <code>io::ErrorKind::IsADirectory</code>/<code>NotADirectory</code> æ˜ å°„åˆ°ç›¸åº”çš„ Python å¼‚å¸¸ã€‚<a href="https://github.com/PyO3/pyo3/pull/4747">#4747</a></li>
<li><code>PyAnyMethods::call</code> åŠå…¶ç›¸å…³æ–¹æ³•ç°åœ¨å¯¹å…¶ä½ç½®å‚æ•°è¦æ±‚ <code>PyCallArgs</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/4768">#4768</a></li>
<li>åœ¨ 3.12+ çš„ç¨³å®š ABI ä¸Šæš´éœ² <code>PyObject_Vectorcall(Method)</code> çš„ FFI å®šä¹‰ã€‚<a href="https://github.com/PyO3/pyo3/pull/4853">#4853</a></li>
<li><code>#[pyo3(from_py_with = ...)]</code> ç°åœ¨æ¥å—è·¯å¾„è€Œéå­—ç¬¦ä¸²å­—é¢é‡ã€‚<a href="https://github.com/PyO3/pyo3/pull/4860">#4860</a></li>
<li>åœ¨ <code>PyErr</code> çš„ Debug å®ç°ä¸­æ ¼å¼åŒ– Python tracebackã€‚<a href="https://github.com/PyO3/pyo3/pull/4900">#4900</a></li>
<li>å°† <code>PathBuf</code> å’Œ <code>Path</code> è½¬æ¢ä¸º Python çš„ <code>pathlib.Path</code> è€Œä¸æ˜¯ <code>PyString</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/4925">#4925</a></li>
<li>æ”¾å®½å¯¹éæ ‡å‡† Python ç‰ˆæœ¬çš„è§£æã€‚<a href="https://github.com/PyO3/pyo3/pull/4949">#4949</a></li>
<li>å½“è§£é‡Šå™¨å…³é—­æ—¶ï¼ŒPyO3 çº¿ç¨‹ç°åœ¨ä¼šæŒ‚èµ·è€Œä¸æ˜¯è°ƒç”¨ <code>pthread_exit</code> å°è¯•è·å– GILã€‚è¿™æ¨¡æ‹Ÿäº† <a href="https://github.com/python/cpython/issues/87135">Python 3.14</a> çš„è¡Œä¸ºï¼Œé¿å…äº†æœªå®šä¹‰è¡Œä¸ºå’Œå´©æºƒã€‚<a href="https://github.com/PyO3/pyo3/pull/4874">#4874</a></li>
</ul>
<h3 id="å·²ç§»é™¤-1"><a class="header" href="#å·²ç§»é™¤-1">å·²ç§»é™¤</a></h3>
<ul>
<li>ç§»é™¤ <code>PyAny</code> å’Œå…¶ä»–â€œåŸç”Ÿâ€ç±»å‹çš„ <code>Deref</code> å®ç°ã€‚<a href="https://github.com/PyO3/pyo3/pull/4593">#4593</a></li>
<li>ç§»é™¤éšå¼å¯é€‰å‚æ•°çš„é»˜è®¤è¡Œä¸ºï¼ˆè§ #2935ï¼‰ã€‚<a href="https://github.com/PyO3/pyo3/pull/4729">#4729</a></li>
<li>ç§»é™¤å¯¹ç®€å•æšä¸¾çš„å·²å¼ƒç”¨çš„éšå¼ eq å›é€€ã€‚<a href="https://github.com/PyO3/pyo3/pull/4730">#4730</a></li>
</ul>
<h3 id="å·²ä¿®å¤-3"><a class="header" href="#å·²ä¿®å¤-3">å·²ä¿®å¤</a></h3>
<ul>
<li>ä¿®æ­£ <code>PyIter_Send</code> çš„ FFI å®šä¹‰ï¼Œä½¿å…¶è¿”å› <code>PySendResult</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/4746">#4746</a></li>
<li>ä¿®å¤åœ¨è‡ªç”±çº¿ç¨‹æ„å»ºä¸­ç”¨äºå¯å˜ pyclass å®ä¾‹çš„è¿è¡Œæ—¶å€Ÿç”¨æ£€æŸ¥å™¨çš„çº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚<a href="https://github.com/PyO3/pyo3/pull/4948">#4948</a></li>
</ul>
<h2 id="0235---2025-02-22"><a class="header" href="#0235---2025-02-22">[0.23.5] - 2025-02-22</a></h2>
<h3 id="æ‰“åŒ…-5"><a class="header" href="#æ‰“åŒ…-5">æ‰“åŒ…</a></h3>
<ul>
<li>æ·»åŠ å¯¹ PyPy3.11 çš„æ”¯æŒã€‚<a href="https://github.com/PyO3/pyo3/pull/4760">#4760</a></li>
</ul>
<h3 id="å·²ä¿®å¤-4"><a class="header" href="#å·²ä¿®å¤-4">å·²ä¿®å¤</a></h3>
<ul>
<li>ä¿®å¤è‡ªç”±çº¿ç¨‹æ„å»ºä¸­ freelist pyclass çš„çº¿ç¨‹ä¸å®‰å…¨å®ç°ã€‚<a href="https://github.com/PyO3/pyo3/pull/4902">#4902</a></li>
<li>é‡æ–°å¯ç”¨ä¸€é¡¹å˜é€šæ–¹æ³•ï¼Œç”¨äºè§£å†³ CPython åœ¨é€šè¿‡ <code>Python::py_run</code> æ‰§è¡Œçš„ä»£ç ä¸­æœªå°† <code>__builtins__</code> æ·»åŠ åˆ° <code>__globals__</code> çš„é—®é¢˜ï¼ˆè¯¥æ–¹æ³•åœ¨ PyO3 0.23.0 ä¸­è¢«ç§»é™¤ï¼‰ã€‚<a href="https://github.com/PyO3/pyo3/pull/4921">#4921</a></li>
</ul>
<h2 id="0234---2025-01-10"><a class="header" href="#0234---2025-01-10">[0.23.4] - 2025-01-10</a></h2>
<h3 id="æ–°å¢-6"><a class="header" href="#æ–°å¢-6">æ–°å¢</a></h3>
<ul>
<li>æ·»åŠ  <code>PyList::locked_for_each</code>ï¼Œåœ¨è‡ªç”±çº¿ç¨‹æ„å»ºä¸­ä½¿ç”¨ä¸´ç•ŒåŒºé”å®šåˆ—è¡¨ã€‚<a href="https://github.com/PyO3/pyo3/pull/4789">#4789</a></li>
<li>æ·»åŠ  <code>pyo3_build_config::add_python_framework_link_args</code> æ„å»ºè„šæœ¬ APIï¼Œç”¨äºåœ¨ä½¿ç”¨ macOS ç³»ç»Ÿ Python æ—¶è®¾ç½® rpathã€‚<a href="https://github.com/PyO3/pyo3/pull/4833">#4833</a></li>
</ul>
<h3 id="æ›´æ”¹--ä½¿ç”¨-datetimefold-æ¥åŒºåˆ†åœ¨è½¬æ¢ä¸ºå’Œä»-chronodatetimetz-æ—¶çš„æ­§ä¹‰æ—¶é—´è€Œä¸æ˜¯æŠ¥é”™4791"><a class="header" href="#æ›´æ”¹--ä½¿ç”¨-datetimefold-æ¥åŒºåˆ†åœ¨è½¬æ¢ä¸ºå’Œä»-chronodatetimetz-æ—¶çš„æ­§ä¹‰æ—¶é—´è€Œä¸æ˜¯æŠ¥é”™4791">æ›´æ”¹- ä½¿ç”¨ <code>datetime.fold</code> æ¥åŒºåˆ†åœ¨è½¬æ¢ä¸ºå’Œä» <code>chrono::DateTime&lt;Tz&gt;</code> æ—¶çš„æ­§ä¹‰æ—¶é—´ï¼ˆè€Œä¸æ˜¯æŠ¥é”™ï¼‰ã€‚<a href="https://github.com/PyO3/pyo3/pull/4791">#4791</a></a></h3>
<ul>
<li>ä¼˜åŒ–è‡ªç”±çº¿ç¨‹æ„å»ºä¸‹çš„ PyList è¿­ä»£æ€§èƒ½ã€‚<a href="https://github.com/PyO3/pyo3/pull/4789">#4789</a></li>
</ul>
<h3 id="å·²ä¿®å¤-5"><a class="header" href="#å·²ä¿®å¤-5">å·²ä¿®å¤</a></h3>
<ul>
<li>ä¿®å¤å°è¯•è®¿é—®æ¥è‡ª Python çš„ <code>PyErr</code> å†…å®¹æ—¶ä¸å¿…è¦çš„å†…éƒ¨ <code>py.allow_threads</code> GIL åˆ‡æ¢é—®é¢˜ï¼ˆå¯èƒ½å¯¼è‡´æ„å¤–æ­»é”ï¼‰ã€‚<a href="https://github.com/PyO3/pyo3/pull/4766">#4766</a></li>
<li>ä¿®å¤åœ¨è‡ªç”±çº¿ç¨‹æ„å»ºä¸‹ <code>BoundDictIterator</code> ä¸­å¯¹å­—å…¸å†…éƒ¨æ•°æ®çš„çº¿ç¨‹ä¸å®‰å…¨è®¿é—®ã€‚<a href="https://github.com/PyO3/pyo3/pull/4788">#4788</a></li>
<li>ä¿®å¤åœ¨è‡ªç”±çº¿ç¨‹æ„å»ºä¸‹ <code>BoundDictIterator</code> ä¸­ä¸å¿…è¦çš„ä¸´ç•ŒåŒºã€‚<a href="https://github.com/PyO3/pyo3/pull/4788">#4788</a></li>
<li>ä¿®å¤è‡ªç”±çº¿ç¨‹æ„å»ºä¸‹åˆ—è¡¨è¿­ä»£ä¸­å­˜åœ¨çš„â€œæ£€æŸ¥-ä½¿ç”¨â€æ—¶é—´å·®é—®é¢˜ã€‚<a href="https://github.com/PyO3/pyo3/pull/4789">#4789</a></li>
<li>ä¿®å¤å½“ <code>Tz</code> ä¸º <code>chrono_tz::Tz</code> æ—¶ <code>chrono::DateTime&lt;Tz&gt;</code> è½¬æ¢ä¸º Python å¯¹è±¡çš„é—®é¢˜ã€‚<a href="https://github.com/PyO3/pyo3/pull/4790">#4790</a></li>
<li>ä¿®å¤ <code>#[pyclass]</code> æ— æ³•å‘½åä¸º <code>Probe</code> çš„é—®é¢˜ã€‚<a href="https://github.com/PyO3/pyo3/pull/4794">#4794</a></li>
<li>ä¿®å¤æœªå°† Windows ä¸Šä» x64 åˆ° aarch64 çš„äº¤å‰ç¼–è¯‘è¯†åˆ«ä¸ºäº¤å‰ç¼–è¯‘çš„é—®é¢˜ã€‚<a href="https://github.com/PyO3/pyo3/pull/4800">#4800</a></li>
<li>ä¿®å¤åœ¨ GraalPy ä¸­ç»§æ‰¿å†…ç½®ç±»æ—¶ç¼ºå°‘ç»“æ„ä½“å­—æ®µçš„é—®é¢˜ã€‚<a href="https://github.com/PyO3/pyo3/pull/4802">#4802</a></li>
<li>ä¿®å¤å¯ç”¨ <code>abi3</code> åŠŸèƒ½æ—¶ä¸º PyPy ç”Ÿæˆå¯¼å…¥åº“çš„é—®é¢˜ã€‚<a href="https://github.com/PyO3/pyo3/pull/4806">#4806</a></li>
<li>ä¿®å¤å¯ç”¨ <code>abi3</code> åŠŸèƒ½æ—¶ä¸º python3.13t ç”Ÿæˆå¯¼å…¥åº“çš„é—®é¢˜ã€‚<a href="https://github.com/PyO3/pyo3/pull/4808">#4808</a></li>
<li>ä¿®å¤åœ¨ <code>derive(FromPyObject)</code> ä¸­å¯¹ <code>r#box</code> ç­‰åŸå§‹æ ‡è¯†ç¬¦çš„ç¼–è¯‘å¤±è´¥é—®é¢˜ã€‚<a href="https://github.com/PyO3/pyo3/pull/4814">#4814</a></li>
<li>ä¿®å¤ <code>#[pyclass]</code> æšä¸¾å˜ä½“è¶…è¿‡ 12 ä¸ªå­—æ®µæ—¶çš„ç¼–è¯‘å¤±è´¥é—®é¢˜ã€‚<a href="https://github.com/PyO3/pyo3/pull/4832">#4832</a></li>
</ul>
<h2 id="0233---2024-12-03"><a class="header" href="#0233---2024-12-03">[0.23.3] - 2024-12-03</a></h2>
<h3 id="æ‰“åŒ…-6"><a class="header" href="#æ‰“åŒ…-6">æ‰“åŒ…</a></h3>
<ul>
<li>å°†å¯é€‰ä¾èµ– <code>python3-dll-a</code> å‡çº§è‡³ 0.2.11 ç‰ˆæœ¬ã€‚<a href="https://github.com/PyO3/pyo3/pull/4749">#4749</a></li>
</ul>
<h3 id="å·²ä¿®å¤-6"><a class="header" href="#å·²ä¿®å¤-6">å·²ä¿®å¤</a></h3>
<ul>
<li>ä¿®å¤åœ¨å¯ç”¨ <code>abi3</code> åŠŸèƒ½æ—¶ä¸º Python 3.13t ç¼–è¯‘æ—¶ Windows ä¸Šçš„æœªè§£æç¬¦å·é“¾æ¥é”™è¯¯ã€‚<a href="https://github.com/PyO3/pyo3/pull/4733">#4733</a></li>
<li>ä¿®å¤åœ¨ä½¿ç”¨ <code>generate-import-lib</code> åŠŸèƒ½ä¸º Python 3.13t ç¼–è¯‘æ—¶ Windows ä¸Šçš„æœªè§£æç¬¦å·é“¾æ¥é”™è¯¯ã€‚<a href="https://github.com/PyO3/pyo3/pull/4749">#4749</a></li>
<li>ä¿®å¤ PyO3 0.23.0 ä¸­çš„ç¼–è¯‘æ—¶å›å½’é—®é¢˜ï¼šæ›´æ”¹ <code>PYO3_CONFIG_FILE</code> æ—¶ä¸ä¼šä¸ºæ–°è§£é‡Šå™¨é‡æ–°é…ç½® PyO3ã€‚<a href="https://github.com/PyO3/pyo3/pull/4758">#4758</a></li>
</ul>
<h2 id="0232---2024-11-25"><a class="header" href="#0232---2024-11-25">[0.23.2] - 2024-11-25</a></h2>
<h3 id="æ–°å¢-7"><a class="header" href="#æ–°å¢-7">æ–°å¢</a></h3>
<ul>
<li>æ·»åŠ  <code>IntoPyObjectExt</code> traitã€‚<a href="https://github.com/PyO3/pyo3/pull/4708">#4708</a></li>
</ul>
<h3 id="å·²ä¿®å¤-7"><a class="header" href="#å·²ä¿®å¤-7">å·²ä¿®å¤</a></h3>
<ul>
<li>ä¿®å¤åœ¨å¯ç”¨ <code>abi3</code> æˆ– <code>abi3-pyxx</code> åŠŸèƒ½æ—¶ä¸ºè‡ªç”±çº¿ç¨‹ Python æ„å»ºæ—¶çš„ç¼–è¯‘å¤±è´¥é—®é¢˜ã€‚<a href="https://github.com/PyO3/pyo3/pull/4719">#4719</a></li>
<li>ä¿®å¤ <code>#[pyclass]</code> å’Œ <code>#[derive(IntoPyObject)]</code> å®ä¸­çš„ <code>ambiguous_associated_items</code> æ£€æŸ¥è­¦å‘Šé”™è¯¯ã€‚<a href="https://github.com/PyO3/pyo3/pull/4725">#4725</a></li>
</ul>
<h2 id="0231---2024-11-16"><a class="header" href="#0231---2024-11-16">[0.23.1] - 2024-11-16</a></h2>
<p>é‡æ–°å‘å¸ƒ 0.23.0ï¼Œä¿®å¤äº† docs.rs æ„å»ºé—®é¢˜ã€‚</p>
<h2 id="0230---2024-11-15"><a class="header" href="#0230---2024-11-15">[0.23.0] - 2024-11-15</a></h2>
<h3 id="æ‰“åŒ…-7"><a class="header" href="#æ‰“åŒ…-7">æ‰“åŒ…</a></h3>
<ul>
<li>ç§»é™¤å¯¹ PyPy 3.7 å’Œ 3.8 çš„æ”¯æŒã€‚<a href="https://github.com/PyO3/pyo3/pull/4582">#4582</a></li>
<li>æ‰©å±•å¯é€‰ä¾èµ– <code>hashbrown</code> çš„æ”¯æŒç‰ˆæœ¬èŒƒå›´ä»¥åŒ…å« 0.15 ç‰ˆæœ¬ã€‚<a href="https://github.com/PyO3/pyo3/pull/4604">#4604</a></li>
<li>å°†å¯é€‰ä¾èµ– <code>eyre</code> çš„æœ€ä½ç‰ˆæœ¬æå‡è‡³ 0.6.8ã€‚<a href="https://github.com/PyO3/pyo3/pull/4617">#4617</a></li>
<li>å°†å¯é€‰ä¾èµ– <code>hashbrown</code> çš„æœ€ä½ç‰ˆæœ¬æå‡è‡³ 0.14.5ã€‚<a href="https://github.com/PyO3/pyo3/pull/4617">#4617</a></li>
<li>å°†å¯é€‰ä¾èµ– <code>indexmap</code> çš„æœ€ä½ç‰ˆæœ¬æå‡è‡³ 2.5.0ã€‚<a href="https://github.com/PyO3/pyo3/pull/4617">#4617</a></li>
<li>å°†å¯é€‰ä¾èµ– <code>num-complex</code> çš„æœ€ä½ç‰ˆæœ¬æå‡è‡³ 0.4.6ã€‚<a href="https://github.com/PyO3/pyo3/pull/4617">#4617</a></li>
<li>å°†å¯é€‰ä¾èµ– <code>chrono-tz</code> çš„æœ€ä½ç‰ˆæœ¬æå‡è‡³ 0.10ã€‚<a href="https://github.com/PyO3/pyo3/pull/4617">#4617</a></li>
<li>æ”¯æŒè‡ªç”±çº¿ç¨‹çš„ Python 3.13tã€‚<a href="https://github.com/PyO3/pyo3/pull/4588">#4588</a></li>
</ul>
<h3 id="æ–°å¢-8"><a class="header" href="#æ–°å¢-8">æ–°å¢</a></h3>
<ul>
<li>æ·»åŠ  <code>IntoPyObject</code>ï¼ˆå¯å¤±è´¥ï¼‰è½¬æ¢ traitï¼Œç”¨äºä» Rust å€¼è½¬æ¢ä¸º Python å€¼ã€‚<a href="https://github.com/PyO3/pyo3/pull/4060">#4060</a></li>
<li>æ·»åŠ  <code>#[pyclass(str="&lt;format string&gt;")]</code> é€‰é¡¹ï¼ŒåŸºäº <code>Display</code> å®ç°æˆ–æ ¼å¼å­—ç¬¦ä¸²ç”Ÿæˆ <code>__str__</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/4233">#4233</a></li>
<li>ä¸º <code>Bound&lt;'py, PyInt&gt;</code> å®ç° <code>PartialEq</code>ï¼Œæ”¯æŒ <code>u8</code>, <code>u16</code>, <code>u32</code>, <code>u64</code>, <code>u128</code>, <code>usize</code>, <code>i8</code>, <code>i16</code>, <code>i32</code>, <code>i64</code>, <code>i128</code> å’Œ <code>isize</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/4317">#4317</a></li>
<li>ä¸º <code>Bound&lt;'py, PyFloat&gt;</code> å®ç° <code>PartialEq&lt;f64&gt;</code> å’Œ <code>PartialEq&lt;f32&gt;</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/4348">#4348</a></li>
<li>ä¸º <code>Bound&lt;T: PyClass&gt;</code> æ·»åŠ  <code>as_super</code> å’Œ <code>into_super</code> æ–¹æ³•ã€‚<a href="https://github.com/PyO3/pyo3/pull/4351">#4351</a></li>
<li>æ·»åŠ  FFI å®šä¹‰ <code>PyCFunctionFast</code> å’Œ <code>PyCFunctionFastWithKeywords</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/4415">#4415</a></li>
<li>ä¸º Python 3.13 åŠæ›´é«˜ç‰ˆæœ¬æ·»åŠ  <code>PyMutex</code> çš„ FFI å®šä¹‰ã€‚<a href="https://github.com/PyO3/pyo3/pull/4421">#4421</a></li>
<li>æ·»åŠ  <code>PyDict::locked_for_each</code> ä»¥åœ¨è‡ªç”±çº¿ç¨‹ Python ä¸­é«˜æ•ˆè¿­ä»£ã€‚<a href="https://github.com/PyO3/pyo3/pull/4439">#4439</a></li>
<li>ä¸º Python 3.13 åŠæ›´æ–°ç‰ˆæœ¬æ·»åŠ  FFI å®šä¹‰ï¼š<code>PyObject_GetOptionalAttr</code>, <code>PyObject_GetOptionalAttrString</code>, <code>PyObject_HasAttrWithError</code>, <code>PyObject_HasAttrStringWithError</code>, <code>Py_CONSTANT_*</code> å¸¸é‡, <code>Py_GetConstant</code>, <code>Py_GetConstantBorrowed</code>, å’Œ <code>PyType_GetModuleByDef</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/4447">#4447</a></li>
<li>ä¸º Python 3.13 åŠæ›´æ–°ç‰ˆæœ¬ä¸­å¯ç”¨çš„ Python ä¸´ç•ŒåŒº API æ·»åŠ  FFI å®šä¹‰ã€‚<a href="https://github.com/PyO3/pyo3/pull/4477">#4477</a></li>
<li>æ·»åŠ  <code>IntoPyObject</code> çš„æ´¾ç”Ÿå®ã€‚<a href="https://github.com/PyO3/pyo3/pull/4495">#4495</a></li>
<li>æ·»åŠ  <code>Borrowed::as_ptr</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/4520">#4520</a></li>
<li>æ·»åŠ  <code>PyImport_AddModuleRef</code> çš„ FFI å®šä¹‰ã€‚<a href="https://github.com/PyO3/pyo3/pull/4529">#4529</a></li>
<li>æ·»åŠ  <code>PyAnyMethods::try_iter</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/4553">#4553</a></li>
<li>æ·»åŠ  <code>pyo3::sync::with_critical_section</code>ï¼Œå°è£… Python 3.13 å¼•å…¥çš„ä¸´ç•ŒåŒº APIã€‚<a href="https://github.com/PyO3/pyo3/pull/4587">#4587</a></li>
<li>æ·»åŠ  <code>#[pymodule(gil_used = false)]</code> é€‰é¡¹ï¼Œå£°æ˜æ¨¡å—æ”¯æŒè‡ªç”±çº¿ç¨‹æ„å»ºã€‚<a href="https://github.com/PyO3/pyo3/pull/4588">#4588</a></li>
<li>æ·»åŠ  <code>PyModule::gil_used</code> æ–¹æ³•ï¼Œç”¨äºå£°æ˜æ¨¡å—æ”¯æŒè‡ªç”±çº¿ç¨‹æ„å»ºã€‚<a href="https://github.com/PyO3/pyo3/pull/4588">#4588</a></li>
<li>æ·»åŠ  FFI å®šä¹‰ <code>PyDateTime_CAPSULE_NAME</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/4634">#4634</a></li>
<li>æ·»åŠ  <code>PyMappingProxy</code> ç±»å‹ä»¥è¡¨ç¤º Python çš„ <code>mappingproxy</code> ç±»ã€‚<a href="https://github.com/PyO3/pyo3/pull/4644">#4644</a></li>
<li>æ·»åŠ  FFI å®šä¹‰ <code>PyList_Extend</code> å’Œ <code>PyList_Clear</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/4667">#4667</a></li>
<li>æ·»åŠ  <code>IntoPyObjectRef</code> çš„æ´¾ç”Ÿå®ã€‚<a href="https://github.com/PyO3/pyo3/pull/4674">#4674</a></li>
<li>æ·»åŠ  <code>pyo3::sync::OnceExt</code> å’Œ <code>pyo3::sync::OnceLockExt</code> traitã€‚<a href="https://github.com/PyO3/pyo3/pull/4676">#4676</a></li>
</ul>
<h3 id="å˜æ›´-3"><a class="header" href="#å˜æ›´-3">å˜æ›´</a></h3>
<ul>
<li>å¯¹ <code>#[pyfunction]</code> å’Œ <code>#[pymethods]</code> çš„è¿”å›ç±»å‹ä¼˜å…ˆä½¿ç”¨ <code>IntoPyObject</code> è€Œé <code>IntoPy&lt;Py&lt;PyAny&gt;&gt;&gt;</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/4060">#4060</a></li>
<li>æŠ¥å‘Š <code>#[pyclass]</code> å’Œ <code>#[pyo3(..)]</code> å±æ€§ä¸­çš„å¤šä¸ªé”™è¯¯ã€‚<a href="https://github.com/PyO3/pyo3/pull/4243">#4243</a></li>
<li>åµŒå¥—çš„å£°æ˜å¼ <code>#[pymodule]</code> å°†è‡ªåŠ¨è¢«è§†ä¸ºå­æ¨¡å—ï¼ˆä¸å†ç”Ÿæˆ <code>PyInit_</code> å…¥å£ç‚¹ï¼‰ã€‚<a href="https://github.com/PyO3/pyo3/pull/4308">#4308</a></li>
<li>å¼ƒç”¨ <code>PyAnyMethods::is_ellipsis</code>ï¼ˆ<code>Py::is_ellipsis</code> å·²åœ¨ PyO3 0.20 ä¸­å¼ƒç”¨ï¼‰ã€‚<a href="https://github.com/PyO3/pyo3/pull/4322">#4322</a></li>
<li>å¼ƒç”¨ <code>PyLong</code>ï¼Œå»ºè®®ä½¿ç”¨ <code>PyInt</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/4347">#4347</a></li>
<li>å°† <code>IntoPyDict::into_py_dict_bound</code> é‡å‘½åä¸º <code>IntoPyDict::into_py_dict</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/4388">#4388</a></li>
<li><code>PyModule::from_code</code> ç°åœ¨æ¥å— <code>&amp;CStr</code> å‚æ•°è€Œé <code>&amp;str</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/4404">#4404</a></li>
<li>åœ¨ä¸º Python 3.10 åŠä»¥ä¸Šç‰ˆæœ¬çš„ abi3 ç¼–è¯‘æ—¶ï¼Œ<code>#[pyfunction]</code> ä½¿ç”¨ Python çš„ â€œfastcallâ€ è°ƒç”¨çº¦å®šã€‚<a href="https://github.com/PyO3/pyo3/pull/4415">#4415</a></li>
<li>ä» FFI å®šä¹‰çš„ <code>PyObject</code> ç»“æ„ä½“ä¸­ç§»é™¤ <code>Copy</code> å’Œ <code>Clone</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/4434">#4434</a></li>
<li><code>Python::eval</code> å’Œ <code>Python::run</code> ç°åœ¨æ¥å— <code>&amp;CStr</code> è€Œé <code>&amp;str</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/4435">#4435</a></li>
<li>ä» PyO3 å…¬å…± API ä¸­å¼ƒç”¨ <code>IPowModulo</code>, <code>PyClassAttributeDef</code>, <code>PyGetterDef</code>, <code>PyMethodDef</code>, <code>PyMethodDefType</code>, å’Œ <code>PySetterDef</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/4441">#4441</a></li>
<li><code>Vec&lt;u8&gt;</code>, <code>&amp;[u8]</code>, <code>[u8; N]</code>, <code>Cow&lt;[u8]&gt;</code> å’Œ <code>SmallVec&lt;[u8; N]&gt;</code> çš„ <code>IntoPyObject</code> å®ç°ç°åœ¨è½¬æ¢ä¸º Python <code>bytes</code>ï¼Œè€Œéæ•´æ•°åˆ—è¡¨ã€‚<a href="https://github.com/PyO3/pyo3/pull/4442">#4442</a></li>
<li>å°è¯•ç»§æ‰¿ä¸æ”¯æŒç»§æ‰¿çš„ç±»æ—¶å‘å‡ºç¼–è¯‘æ—¶é”™è¯¯ã€‚<a href="https://github.com/PyO3/pyo3/pull/4453">#4453</a></li>
<li>ç”±äº <code>IntoPyObject</code> è¿ç§»ï¼Œ<code>IntoPyDict::into_py_dict</code> ç°åœ¨æ˜¯å¯å¤±è´¥çš„ã€‚<a href="https://github.com/PyO3/pyo3/pull/4493">#4493</a></li>
<li><code>abi3</code> åŠŸèƒ½ç°åœ¨ä¼šè¦†ç›–é€šè¿‡ <code>PYO3_BUILD_CONFIG</code> æä¾›çš„é…ç½®æ–‡ä»¶ã€‚<a href="https://github.com/PyO3/pyo3/pull/4497">#4497</a></li>
<li>åœ¨è‡ªç”±çº¿ç¨‹ Python ä¸­ç¦ç”¨ <code>GILProtected</code> ç»“æ„ä½“ã€‚<a href="https://github.com/PyO3/pyo3/pull/4504">#4504</a></li>
<li>æ›´æ–°å›  CPython ä¸­å·²å¼ƒç”¨æˆ–ç§»é™¤è€Œæ›´æ–°çš„å‡½æ•°å’Œç»“æ„ä½“å­—æ®µçš„ FFI å®šä¹‰ã€‚<a href="https://github.com/PyO3/pyo3/pull/4534">#4534</a></li>
<li>åœ¨è‡ªç”±çº¿ç¨‹ Python ä¸­ç¦ç”¨ <code>PyListMethods::get_item_unchecked</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/4539">#4539</a></li>
<li>æ·»åŠ  <code>GILOnceCell::import</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/4542">#4542</a></li>
<li>å¼ƒç”¨ <code>PyAnyMethods::iter</code>ï¼Œå»ºè®®ä½¿ç”¨ <code>PyAnyMethods::try_iter</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/4553">#4553</a></li>
<li><code>#[pyclass]</code> å®ç°åœ¨è¦æ±‚ç±»å‹ä¸º <code>Sync</code>ï¼ˆ<code>#[pyclass(unsendable)]</code> ç±»å‹é™¤å¤–ï¼‰ã€‚<a href="https://github.com/PyO3/pyo3/pull/4566">#4566</a></li>
<li><code>PyList::new</code> å’Œ <code>PyTuple::new</code> ç°åœ¨æ˜¯å¯å¤±è´¥çš„ï¼Œå½’å› äº <code>IntoPyObject</code> è¿ç§»ã€‚<a href="https://github.com/PyO3/pyo3/pull/4580">#4580</a>- <code>PyErr::matches</code> ç”±äº <code>IntoPyObject</code> çš„è¿ç§»ç°åœ¨å¯èƒ½å¤±è´¥ã€‚<a href="https://github.com/PyO3/pyo3/pull/4595">#4595</a></li>
<li>å¼ƒç”¨ <code>ToPyObject</code>ï¼Œæ¨èä½¿ç”¨ <code>IntoPyObject</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/4595">#4595</a></li>
<li>å¼ƒç”¨ <code>PyWeakrefMethods::get_option</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/4597">#4597</a></li>
<li>å°è£… <code>PyWeakrefMethods</code> traitã€‚<a href="https://github.com/PyO3/pyo3/pull/4598">#4598</a></li>
<li>ä» PyO3 çš„å…¬å…± API ä¸­ç§»é™¤ <code>PyNativeTypeInitializer</code> å’Œ <code>PyObjectInit</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/4611">#4611</a></li>
<li>å¼ƒç”¨ <code>IntoPy</code>ï¼Œæ¨èä½¿ç”¨ <code>IntoPyObject</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/4618">#4618</a></li>
<li>åœ¨ Python 3.11 åŠæ›´æ—©ç‰ˆæœ¬ä¸­ï¼Œ<code>PyErr::take()</code> å’Œ <code>PyErr::fetch()</code> ä¼šç«‹å³è§„èŒƒåŒ–å¼‚å¸¸ã€‚<a href="https://github.com/PyO3/pyo3/pull/4655">#4655</a></li>
<li>å°† <code>IntoPy::type_output</code> ç§»åŠ¨åˆ° <code>IntoPyObject::type_output</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/4657">#4657</a></li>
<li>å°† <code>PyMapping::keys</code>ã€<code>PyMapping::values</code> å’Œ <code>PyMapping::items</code> çš„è¿”å›ç±»å‹ä» <code>Bound&lt;'py, PySequence&gt;</code> æ”¹ä¸º <code>Bound&lt;'py, PyList&gt;</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/4661">#4661</a></li>
<li>å¤æ‚æšä¸¾ç°åœ¨å…è®¸å­—æ®µç±»å‹é€šè¿‡å¼•ç”¨æˆ–å€¼å®ç° <code>IntoPyObject</code>ï¼ŒåŒæ—¶ä¸ <code>Clone</code> ä¸€èµ·ä½¿ç”¨ã€‚è¿™ä½¿å¾— <code>Py&lt;T&gt;</code> å¯ä½œä¸ºå­—æ®µç±»å‹ä½¿ç”¨ã€‚<a href="https://github.com/PyO3/pyo3/pull/4694">#4694</a></li>
</ul>
<h3 id="å·²ç§»é™¤-2"><a class="header" href="#å·²ç§»é™¤-2">å·²ç§»é™¤</a></h3>
<ul>
<li>ç§»é™¤ PyO3 0.20 ä¸­å·²å¼ƒç”¨çš„æ‰€æœ‰åŠŸèƒ½ã€‚<a href="https://github.com/PyO3/pyo3/pull/4322">#4322</a></li>
<li>ç§»é™¤ PyO3 0.21 ä¸­å·²å¼ƒç”¨çš„æ‰€æœ‰åŠŸèƒ½ã€‚<a href="https://github.com/PyO3/pyo3/pull/4323">#4323</a></li>
<li>å¼ƒç”¨ <code>PyUnicode</code>ï¼Œæ¨èä½¿ç”¨ <code>PyString</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/4370">#4370</a></li>
<li>ç§»é™¤å·²å¼ƒç”¨çš„ <code>gil-refs</code> åŠŸèƒ½ã€‚<a href="https://github.com/PyO3/pyo3/pull/4378">#4378</a></li>
<li>ç§»é™¤ç§æœ‰ FFI å®šä¹‰ <code>_Py_IMMORTAL_REFCNT</code>ã€<code>_Py_IsImmortal</code>ã€<code>_Py_TPFLAGS_STATIC_BUILTIN</code>ã€<code>_Py_Dealloc</code>ã€<code>_Py_IncRef</code>ã€<code>_Py_DecRef</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/4447">#4447</a></li>
<li>ç§»é™¤ç§æœ‰ FFI å®šä¹‰ <code>_Py_c_sum</code>ã€<code>_Py_c_diff</code>ã€<code>_Py_c_neg</code>ã€<code>_Py_c_prod</code>ã€<code>_Py_c_quot</code>ã€<code>_Py_c_pow</code>ã€<code>_Py_c_abs</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/4521">#4521</a></li>
<li>ç§»é™¤ <code>PyWeakRef</code> å’Œ <code>PyWeakRefProxy</code> çš„ <code>_borrowed</code> æ–¹æ³•ã€‚<a href="https://github.com/PyO3/pyo3/pull/4528">#4528</a></li>
<li>ç§»é™¤ç§æœ‰ FFI å®šä¹‰ <code>_PyErr_ChainExceptions</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/4534">#4534</a></li>
</ul>
<h3 id="å·²ä¿®å¤-8"><a class="header" href="#å·²ä¿®å¤-8">å·²ä¿®å¤</a></h3>
<ul>
<li>ä¿®å¤äº¤å‰ç¼–è¯‘æ—¶æ— æ•ˆçš„åº“æœç´¢è·¯å¾„ <code>lib_dir</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/4389">#4389</a></li>
<li>ä¿®å¤ PyPy åœ¨ 3.10 ä¸Šçš„ FFI å®šä¹‰ <code>Py_Is</code>ï¼Œä»¥è°ƒç”¨ PyPy å®šä¹‰çš„å‡½æ•°ã€‚<a href="https://github.com/PyO3/pyo3/pull/4447">#4447</a></li>
<li>ä¿®å¤åœ¨ç®€å•æšä¸¾å˜ä½“ä¸Šä½¿ç”¨ <code>#[cfg]</code> å±æ€§æ—¶çš„ç¼–è¯‘å¤±è´¥ã€‚<a href="https://github.com/PyO3/pyo3/pull/4509">#4509</a></li>
<li>ä¿®å¤ <code>#[pymethods]</code> ç”Ÿæˆä»£ç ä¸­çš„ <code>non_snake_case</code> æ–¹æ³•åå¼•èµ·çš„ç¼–è¯‘å™¨è­¦å‘Šã€‚<a href="https://github.com/PyO3/pyo3/pull/4567">#4567</a></li>
<li>ä¿®å¤ <code>#[derive(FromPyObject)]</code> åœ¨å¸¦æœ‰ trait çº¦æŸçš„æ³›å‹ç»“æ„ä½“ä¸Šçš„ç¼–è¯‘é”™è¯¯ã€‚<a href="https://github.com/PyO3/pyo3/pull/4645">#4645</a></li>
<li>ä¿®å¤ <code>#[classmethod]</code> å’Œ <code>#[staticmethod]</code> åœ¨é­”æ³•æ–¹æ³•ä¸Šçš„ç¼–è¯‘é”™è¯¯ã€‚<a href="https://github.com/PyO3/pyo3/pull/4654">#4654</a></li>
<li>ä¿®å¤ç”Ÿæˆçš„å®ä»£ç ä¸­ <code>unsafe_op_in_unsafe_fn</code> çš„ç¼–è¯‘è­¦å‘Šã€‚<a href="https://github.com/PyO3/pyo3/pull/4674">#4674</a></li>
<li>ä¿®å¤åœ¨è‡ªå®šä¹‰ <code>__eq__</code> å®ç°çš„ <code>#[pyclass] enum</code> ä¸Šé”™è¯¯çš„å¼ƒç”¨è­¦å‘Šã€‚<a href="https://github.com/PyO3/pyo3/pull/4692">#4692</a></li>
<li>ä¿®å¤åœ¨å¤æ‚æšä¸¾ä¸Šç”Ÿæˆçš„ <code>__match_args__</code> è§¦å‘ <code>non_upper_case_globals</code> lint çš„é—®é¢˜ã€‚<a href="https://github.com/PyO3/pyo3/pull/4705">#4705</a></li>
</ul>
<h2 id="0225---2024-10-15"><a class="header" href="#0225---2024-10-15">[0.22.5] - 2024-10-15</a></h2>
<h3 id="å·²ä¿®å¤-9"><a class="header" href="#å·²ä¿®å¤-9">å·²ä¿®å¤</a></h3>
<ul>
<li>ä¿®å¤ 0.22.4 ä¸­ <code>__clear__</code> æ’æ§½å’Œ <code>clear</code> æ–¹æ³•ç”Ÿæˆä»£ç çš„å‘½åå†²çªé—®é¢˜ã€‚<a href="https://github.com/PyO3/pyo3/pull/4619">#4619</a></li>
</ul>
<h2 id="0224---2024-10-12"><a class="header" href="#0224---2024-10-12">[0.22.4] - 2024-10-12</a></h2>
<h3 id="æ–°å¢-9"><a class="header" href="#æ–°å¢-9">æ–°å¢</a></h3>
<ul>
<li>æ·»åŠ  FFI å®šä¹‰ <code>PyWeakref_GetRef</code> å’Œ <code>compat::PyWeakref_GetRef</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/4528">#4528</a></li>
</ul>
<h3 id="æ›´æ”¹-3"><a class="header" href="#æ›´æ”¹-3">æ›´æ”¹</a></h3>
<ul>
<li>å¼ƒç”¨ <code>PyWeakRef</code> å’Œ <code>PyWeakrefProxy</code> ä¸Šçš„ <code>_borrowed</code> æ–¹æ³•ï¼ˆå»ºè®®ç›´æ¥ä½¿ç”¨æ‹¥æœ‰å½¢å¼ï¼‰ã€‚<a href="https://github.com/PyO3/pyo3/pull/4590">#4590</a></li>
</ul>
<h3 id="å·²ä¿®å¤-10"><a class="header" href="#å·²ä¿®å¤-10">å·²ä¿®å¤</a></h3>
<ul>
<li>æ¢å¤åœ¨ Python 3.13 åŠæ›´é«˜ç‰ˆæœ¬ä¸Šè¢«ç§»é™¤çš„ç§æœ‰ FFI å‡½æ•° <code>_PyLong_NumBits</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/4450">#4450</a></li>
<li>ä¿®å¤ä½¿ç”¨ <code>#[pyclass(extends = ...)]</code> åˆ›å»ºçš„å­ç±»æœªè°ƒç”¨åŸºç±» <code>__traverse__</code> å‡½æ•°çš„é—®é¢˜ã€‚<a href="https://github.com/PyO3/pyo3/pull/4563">#4563</a></li>
<li>ä¿®å¤ 0.22.3 ä¸­åœ¨ <code>#![forbid(unsafe_code)]</code> ä¸‹æ— æ³•ç¼–è¯‘çš„é—®é¢˜ã€‚<a href="https://github.com/PyO3/pyo3/pull/4574">#4574</a></li>
<li>ä¿®å¤ <code>create_exception</code> å®å› ä¸ <code>gil-refs</code> åŠŸèƒ½äº¤äº’è€Œè§¦å‘çš„ lint å’Œç¼–è¯‘é”™è¯¯ã€‚<a href="https://github.com/PyO3/pyo3/pull/4589">#4589</a></li>
<li>é€šè¿‡æ³„éœ²å…¶å†…å®¹æ¥è§„é¿ <code>PyWeakRef</code> å’Œ <code>PyWeakrefProxy</code> ä¸Š <code>_borrowed</code> æ–¹æ³•å¯èƒ½çš„ä½¿ç”¨åé‡Šæ”¾é—®é¢˜ã€‚<a href="https://github.com/PyO3/pyo3/pull/4590">#4590</a></li>
<li>ä¿®å¤åœ¨ Python 3.10 ä¹‹å‰å¯¹é™æ€ç±»å‹è°ƒç”¨ <code>PyType_GetSlot</code> æ—¶çš„å´©æºƒé—®é¢˜ã€‚<a href="https://github.com/PyO3/pyo3/pull/4599">#4599</a></li>
</ul>
<h2 id="0223---2024-09-15"><a class="header" href="#0223---2024-09-15">[0.22.3] - 2024-09-15</a></h2>
<h3 id="æ–°å¢-10"><a class="header" href="#æ–°å¢-10">æ–°å¢</a></h3>
<ul>
<li>æ·»åŠ  <code>pyo3::ffi::compat</code> å‘½åç©ºé—´ï¼ŒåŒ…å«å¯¹ Python è¿‘æœŸç‰ˆæœ¬æ–°å¢ C API å‡½æ•°çš„å…¼å®¹å±‚ã€‚</li>
<li>åœ¨ Python 3.13 åŠæ›´æ–°ç‰ˆæœ¬ä¸Šæ·»åŠ  FFI å®šä¹‰ <code>PyDict_GetItemRef</code>ï¼Œå¹¶ä¸ºæ‰€æœ‰ç‰ˆæœ¬æä¾› <code>compat::PyDict_GetItemRef</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/4355">#4355</a></li>
<li>åœ¨ Python 3.13 åŠæ›´æ–°ç‰ˆæœ¬ä¸Šæ·»åŠ  FFI å®šä¹‰ <code>PyList_GetItemRef</code>ï¼Œå¹¶ä¸ºæ‰€æœ‰ç‰ˆæœ¬æä¾› <code>pyo3_ffi::compat::PyList_GetItemRef</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/4410">#4410</a></li>
<li>æ·»åŠ  FFI å®šä¹‰ <code>compat::Py_NewRef</code> å’Œ <code>compat::Py_XNewRef</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/4445">#4445</a></li>
<li>æ·»åŠ  FFI å®šä¹‰ <code>compat::PyObject_CallNoArgs</code> å’Œ <code>compat::PyObject_CallMethodNoArgs</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/4461">#4461</a></li>
<li>ä¸º <code>GilOnceCell&lt;Py&lt;T&gt;&gt;</code> æ·»åŠ  <code>clone_ref</code> æ–¹æ³•ã€‚<a href="https://github.com/PyO3/pyo3/pull/4511">#4511</a></li>
</ul>
<h3 id="æ›´æ”¹-4"><a class="header" href="#æ›´æ”¹-4">æ›´æ”¹</a></h3>
<ul>
<li>æ”¹è¿›åœ¨ <code>#[pymethods]</code> å†…å®šä¹‰çš„ <code>#[pyfunction]</code> çš„é”™è¯¯æç¤ºä¿¡æ¯ã€‚<a href="https://github.com/PyO3/pyo3/pull/4349">#4349</a></li>
<li>åœ¨å¯èƒ½çš„æƒ…å†µä¸‹ä½¿ç”¨ vectorcall è°ƒç”¨çº¦å®šä»¥æå‡è°ƒç”¨ Python çš„æ€§èƒ½ã€‚<a href="https://github.com/PyO3/pyo3/pull/4456">#4456</a></li>
<li>å½“å°è¯•å®ä¾‹åŒ–æ²¡æœ‰å®šä¹‰æ„é€ å‡½æ•°çš„ç±»æ—¶ï¼Œåœ¨å¼‚å¸¸æ¶ˆæ¯ä¸­åŒ…å«ç±»å‹åç§°ã€‚<a href="https://github.com/PyO3/pyo3/pull/4481">#4481</a></li>
</ul>
<h3 id="å·²ç§»é™¤-3"><a class="header" href="#å·²ç§»é™¤-3">å·²ç§»é™¤</a></h3>
<ul>
<li>ç§»é™¤ç§æœ‰ FFI å®šä¹‰ <code>_Py_PackageContext</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/4420">#4420</a></li>
</ul>
<h3 id="å·²ä¿®å¤-11"><a class="header" href="#å·²ä¿®å¤-11">å·²ä¿®å¤</a></h3>
<ul>
<li>ä¿®å¤åœ¨ <code>#![no_implicit_prelude]</code> ç¯å¢ƒä¸‹å£°æ˜å¼ <code>#[pymodule]</code> çš„ç¼–è¯‘å¤±è´¥ã€‚<a href="https://github.com/PyO3/pyo3/pull/4328">#4328</a></li>
<li>ä¿®å¤ <code>PyDict::get_item</code> ä¸­ä½¿ç”¨å€Ÿç”¨å¼•ç”¨çš„é—®é¢˜ï¼ˆåœ¨è‡ªç”±çº¿ç¨‹ Python ä¸­ä¸å®‰å…¨ï¼‰ã€‚<a href="https://github.com/PyO3/pyo3/pull/4355">#4355</a></li>
<li>ä¿®å¤ <code>#[pyclass(eq)]</code> å®åœ¨ç»“æ„ä½“å’Œæšä¸¾ä¸Šçš„å«ç”Ÿé—®é¢˜ã€‚<a href="https://github.com/PyO3/pyo3/pull/4359">#4359</a></li>
<li>ä¿®å¤ <code>#[pyfunction]</code> å’Œ <code>#[pymethods]</code> ç”Ÿæˆä»£ç çš„å«ç”Ÿ/èŒƒå›´é—®é¢˜ï¼Œè¯¥é—®é¢˜å½±å“äº†åœ¨ <code>macro_rules</code> ä¸Šä¸‹æ–‡ä¸­çš„å±•å¼€ã€‚<a href="https://github.com/PyO3/pyo3/pull/4382">#4382</a></li>
<li>ä¿®å¤ <code>#[pyclass]</code> ç”Ÿæˆä»£ç ä¸­çš„ <code>unsafe_code</code> lint é”™è¯¯ã€‚<a href="https://github.com/PyO3/pyo3/pull/4396">#4396</a></li>
<li>ä¿®å¤å¼‚æ­¥å‡½æ•°è¿”å›å…ƒç»„æ—¶ä»…è¿”å›ç¬¬ä¸€ä¸ªå…ƒç´ ç»™ Python çš„é—®é¢˜ã€‚<a href="https://github.com/PyO3/pyo3/pull/4407">#4407</a></li>
<li>ä¿®å¤ <code>PyList::get_item</code> ä¸­ä½¿ç”¨å€Ÿç”¨å¼•ç”¨çš„é—®é¢˜ï¼ˆåœ¨è‡ªç”±çº¿ç¨‹ Python ä¸­ä¸å®‰å…¨ï¼‰ã€‚<a href="https://github.com/PyO3/pyo3/pull/4410">#4410</a></li>
<li>ä¿®æ­£ FFI å®šä¹‰ <code>PyArg_ParseTupleAndKeywords</code>ï¼Œåœ¨ Python 3.13 åŠæ›´é«˜ç‰ˆæœ¬ä¸­ä½¿ç”¨ <code>*const *const c_char</code> è€Œé <code>*mut *mut c_char</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/4420">#4420</a></li>
<li>ä¿®å¤ <code>PyClassInitializer</code> çš„å®‰å…¨æ¼æ´ï¼šå¦‚æœé€šè¿‡ <code>PyClassInitializer::from(Py&lt;BaseClass&gt;).add_subclass(SubClass)</code> å‘å·²æœ‰å®ä¾‹æ·»åŠ å­ç±»ï¼Œåˆ™è§¦å‘ panicã€‚<a href="https://github.com/PyO3/pyo3/pull/4454">#4454</a></li>
<li>ä¿®å¤ <code>__traverse__</code> å¤„ç†ç¨‹åºå®ç°ä¸­éæ³•çš„å¼•ç”¨è®¡æ•°æ“ä½œã€‚<a href="https://github.com/PyO3/pyo3/pull/4479">#4479</a></li>
</ul>
<h2 id="0222---2024-07-17"><a class="header" href="#0222---2024-07-17">[0.22.2] - 2024-07-17</a></h2>
<h3 id="æ‰“åŒ…-8"><a class="header" href="#æ‰“åŒ…-8">æ‰“åŒ…</a></h3>
<ul>
<li>è¦æ±‚é€šè¿‡è®¾ç½®ç¯å¢ƒå˜é‡ <code>UNSAFE_PYO3_BUILD_FREE_THREADED=1</code> æ˜¾å¼å¯ç”¨è‡ªç”±çº¿ç¨‹ Pythonï¼ˆPyO3 å°šæœªæ”¯æŒï¼‰ã€‚<a href="https://github.com/PyO3/pyo3/pull/4327">#4327</a></li>
</ul>
<h3 id="æ›´æ”¹-5"><a class="header" href="#æ›´æ”¹-5">æ›´æ”¹</a></h3>
<ul>
<li>å¯¹æ‰€æœ‰ abi3 ç‰ˆæœ¬ä½¿ç”¨ FFI å‡½æ•°è°ƒç”¨è¿›è¡Œå¼•ç”¨è®¡æ•°ã€‚<a href="https://github.com/PyO3/pyo3/pull/4324">#4324</a></li>
<li><code>#[pymodule(...)]</code> ç°åœ¨å¯ç›´æ¥æ¥å—æ‰€æœ‰ç›¸å…³çš„ <code>#[pyo3(...)]</code> é€‰é¡¹ã€‚<a href="https://github.com/PyO3/pyo3/pull/4330">#4330</a></li>
</ul>
<h3 id="å·²ä¿®å¤-12"><a class="header" href="#å·²ä¿®å¤-12">å·²ä¿®å¤</a></h3>
<ul>
<li>ä¿®å¤åœ¨ <code>#![no_implicit_prelude]</code> ç¯å¢ƒä¸‹å£°æ˜å¼ <code>#[pymodule]</code> çš„ç¼–è¯‘å¤±è´¥ã€‚<a href="https://github.com/PyO3/pyo3/pull/4328">#4328</a></li>
<li>ä¿®å¤åœ¨ Rust &lt; 1.79 ä¸Šå›  c-string å­—é¢é‡å¯¼è‡´çš„ç¼–è¯‘å¤±è´¥ã€‚<a href="https://github.com/PyO3/pyo3/pull/4353">#4353</a></li>
</ul>
<h2 id="0221---2024-07-06"><a class="header" href="#0221---2024-07-06">[0.22.1] - 2024-07-06</a></h2>
<h3 id="æ–°å¢-11"><a class="header" href="#æ–°å¢-11">æ–°å¢</a></h3>
<ul>
<li>ä¸ºå£°æ˜å¼ <code>#[pymodule]</code> æ·»åŠ  <code>#[pyo3(submodule)]</code> é€‰é¡¹ã€‚<a href="https://github.com/PyO3/pyo3/pull/4301">#4301</a></li>
<li>ä¸º <code>Bound&lt;'py, PyBool&gt;</code> å®ç° <code>PartialEq&lt;bool&gt;</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/4305">#4305</a></li>
</ul>
<h3 id="å·²ä¿®å¤-13"><a class="header" href="#å·²ä¿®å¤-13">å·²ä¿®å¤</a></h3>
<ul>
<li>åœ¨ç”Ÿæˆçš„ç›¸ç­‰æ€§æ–¹æ³•ä¸­ï¼Œæ¯”è¾ƒä¸åŒç±»å‹æ—¶è¿”å› <code>NotImplemented</code> è€ŒéæŠ›å‡º <code>TypeError</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/4287">#4287</a></li>
<li>æ”¯æŒå…¨è·¯å¾„å½¢å¼ <code>#[pyo3::prelude::pymodule]</code> åŠç±»ä¼¼å½¢å¼åœ¨å£°æ˜å¼æ¨¡å—ä¸­ç”¨äº <code>#[pyclass]</code> å’Œ <code>#[pyfunction]</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/4288">#4288</a></li>
<li>ä¿®å¤åœ¨ Python &lt;3.13 ä¸”å¤§ç«¯å¹³å°ä¸Š 128 ä½æ•´æ•°çš„å›å½’é—®é¢˜ã€‚<a href="https://github.com/PyO3/pyo3/pull/4291">#4291</a></li>
<li>åœæ­¢ä¸ºå£°æ˜å¼æ¨¡å—ç”Ÿæˆæ°¸è¿œæ— æ³•è¦†ç›–çš„ä»£ç ã€‚<a href="https://github.com/PyO3/pyo3/pull/4297">#4297</a></li>
<li>ä¿®å¤ <code>#[setter]</code> å‡½æ•°ä¸Šå¯é€‰å‚æ•°å°¾éšäº§ç”Ÿçš„æ— æ•ˆå¼ƒç”¨è­¦å‘Šã€‚<a href="https://github.com/PyO3/pyo3/pull/4304">#4304</a></li>
</ul>
<h2 id="0220---2024-06-24"><a class="header" href="#0220---2024-06-24">[0.22.0] - 2024-06-24</a></h2>
<h3 id="æ‰“åŒ…-9"><a class="header" href="#æ‰“åŒ…-9">æ‰“åŒ…</a></h3>
<ul>
<li>å°† <code>heck</code> ä¾èµ–é¡¹æ›´æ–°è‡³ 0.5 ç‰ˆæœ¬ã€‚<a href="https://github.com/PyO3/pyo3/pull/3966">#3966</a></li>
<li>æ‰©å±•å¯é€‰ä¾èµ– <code>chrono-tz</code> æ”¯æŒçš„ç‰ˆæœ¬èŒƒå›´ï¼ŒåŒ…æ‹¬ 0.10 ç‰ˆæœ¬ã€‚<a href="https://github.com/PyO3/pyo3/pull/4061">#4061</a></li>
<li>æ›´æ–°æœ€ä½æ”¯æŒ Rust ç‰ˆæœ¬ï¼ˆMSRVï¼‰è‡³ 1.63ã€‚<a href="https://github.com/PyO3/pyo3/pull/4129">#4129</a>- æ·»åŠ å¯é€‰çš„ <code>num-rational</code> åŠŸèƒ½ï¼Œä»¥æ”¯æŒä¸ Python çš„ <code>fractions.Fraction</code> ç±»å‹ä¹‹é—´çš„è½¬æ¢ã€‚<a href="https://github.com/PyO3/pyo3/pull/4148">#4148</a></li>
<li>æ”¯æŒ Python 3.13ã€‚<a href="https://github.com/PyO3/pyo3/pull/4184">#4184</a></li>
</ul>
<h3 id="æ–°å¢-12"><a class="header" href="#æ–°å¢-12">æ–°å¢</a></h3>
<ul>
<li>æ·»åŠ  <code>PyWeakref</code>ã€<code>PyWeakrefReference</code> å’Œ <code>PyWeakrefProxy</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/3835">#3835</a></li>
<li>æ”¯æŒåœ¨å…·æœ‰å…ƒç»„å˜ä½“çš„æšä¸¾ä¸Šä½¿ç”¨ <code>#[pyclass]</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/4072">#4072</a></li>
<li>åœ¨ <code>Decimal</code> è½¬æ¢ä¸­æ·»åŠ å¯¹ç§‘å­¦è®¡æ•°æ³•çš„æ”¯æŒã€‚<a href="https://github.com/PyO3/pyo3/pull/4079">#4079</a></li>
<li>æ·»åŠ æ¡ä»¶ç¼–è¯‘æ ‡å¿— <code>pyo3_disable_reference_pool</code>ï¼Œä»¥é¿å…å…¨å±€å¼•ç”¨æ± çš„å¼€é”€ï¼ˆä»£ä»·æ˜¯å­˜åœ¨å·²çŸ¥é™åˆ¶ï¼Œè¯¦è§æŒ‡å—ä¸­çš„æ€§èƒ½ç« èŠ‚ï¼‰ã€‚<a href="https://github.com/PyO3/pyo3/pull/4095">#4095</a></li>
<li>æ·»åŠ  <code>#[pyo3(constructor = (...))]</code>ï¼Œç”¨äºä¸ºå¤æ‚æšä¸¾å˜ä½“è‡ªå®šä¹‰ç”Ÿæˆçš„æ„é€ å‡½æ•°ã€‚<a href="https://github.com/PyO3/pyo3/pull/4158">#4158</a></li>
<li>æ·»åŠ  <code>PyType::module</code>ï¼Œå…¶å§‹ç»ˆä¸ Python çš„ <code>__module__</code> ä¿æŒä¸€è‡´ã€‚<a href="https://github.com/PyO3/pyo3/pull/4196">#4196</a></li>
<li>æ·»åŠ  <code>PyType::fully_qualified_name</code>ï¼Œå…¶ä¸ <a href="https://peps.python.org/pep-0737">PEP 737</a> ä¸­å®šä¹‰çš„â€œå®Œå…¨é™å®šåç§°â€ç›¸åŒ¹é…ã€‚<a href="https://github.com/PyO3/pyo3/pull/4196">#4196</a></li>
<li>æ·»åŠ  <code>PyTypeMethods::mro</code> å’Œ <code>PyTypeMethods::bases</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/4197">#4197</a></li>
<li>æ·»åŠ  <code>#[pyclass(ord)]</code>ï¼Œä»¥åŸºäº <code>PartialOrd</code> å®ç°æ’åºã€‚<a href="https://github.com/PyO3/pyo3/pull/4202">#4202</a></li>
<li>ä¸º <code>PyBackedStr</code> å’Œ <code>PyBackedBytes</code> å®ç° <code>ToPyObject</code> å’Œ <code>IntoPy&lt;PyObject&gt;</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/4205">#4205</a></li>
<li>æ·»åŠ  <code>#[pyclass(hash)]</code> é€‰é¡¹ï¼Œä»¥åŸºäº <code>Hash</code> å®ç°ç”Ÿæˆ <code>__hash__</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/4206">#4206</a></li>
<li>æ·»åŠ  <code>#[pyclass(eq)]</code> é€‰é¡¹ï¼Œä»¥åŸºäº <code>PartialEq</code> ç”Ÿæˆ <code>__eq__</code>ï¼Œä»¥åŠ <code>#[pyclass(eq_int)]</code> é€‰é¡¹ï¼Œç”¨äºä¸ºç®€å•æšä¸¾åŸºäºå…¶åˆ¤åˆ«å€¼å®ç°ç›¸ç­‰æ€§ã€‚<a href="https://github.com/PyO3/pyo3/pull/4210">#4210</a></li>
<li>ä¸º <code>PyClassInitializer&lt;T&gt;</code> å®ç° <code>From&lt;Bound&lt;'py, T&gt;&gt;</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/4214">#4214</a></li>
<li>ä¸º <code>PyRef</code> å’Œ <code>PyRefMut</code> æ·»åŠ  <code>as_super</code> æ–¹æ³•ï¼Œç”¨äºé€šè¿‡å¼•ç”¨æ¥è®¿é—®åŸºç±»ã€‚<a href="https://github.com/PyO3/pyo3/pull/4219">#4219</a></li>
<li>ä¸º <code>Bound&lt;'py, PyString&gt;</code> å®ç° <code>PartialEq&lt;str&gt;</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/4245">#4245</a></li>
<li>åœ¨ PyPy ä¸Šå®ç° <code>PyModuleMethods::filename</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/4249">#4249</a></li>
<li>ä¸º <code>Bound&lt;'py, PyBytes&gt;</code> å®ç° <code>PartialEq&lt;[u8]&gt;</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/4250">#4250</a></li>
<li>æ·»åŠ  <code>pyo3_ffi::c_str</code> å®ï¼Œç”¨äºåœ¨ä¸æ”¯æŒ Rust 1.77 çš„ <code>c""</code> å­—é¢é‡çš„ç‰ˆæœ¬ä¸Šåˆ›å»º <code>'static CStr</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/4255">#4255</a></li>
<li>æ”¯æŒä¸ <code>numpy</code> 2.0 çš„ <code>numpy.bool</code> ç±»å‹è¿›è¡Œ <code>bool</code> è½¬æ¢ã€‚<a href="https://github.com/PyO3/pyo3/pull/4258">#4258</a></li>
<li>æ·»åŠ  <code>PyAnyMethods::{bitnot, matmul, floor_div, rem, divmod}</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/4264">#4264</a></li>
</ul>
<h3 id="æ›´æ”¹-6"><a class="header" href="#æ›´æ”¹-6">æ›´æ”¹</a></h3>
<ul>
<li>æ›´æ”¹ <code>PySliceIndices::slicelength</code> çš„ç±»å‹ä»¥åŠ <code>PySlice::indices()</code> çš„ <code>length</code> å‚æ•°çš„ç±»å‹ã€‚<a href="https://github.com/PyO3/pyo3/pull/3761">#3761</a></li>
<li>å¼ƒç”¨å¯¹å°¾éšå¯é€‰å‚æ•°çš„éšå¼é»˜è®¤å€¼ã€‚<a href="https://github.com/PyO3/pyo3/pull/4078">#4078</a></li>
<li>å°† Python å †å†…æŒ‡é’ˆçš„ <code>Clone</code> æ“ä½œç§»è‡³ <code>py-clone</code> ç‰¹æ€§åæ–¹ï¼Œå› ä¸ºå®ƒåœ¨æœªæŒæœ‰ GIL æ—¶å¿…é¡» panicï¼Œæ­¤ä¸ºä¸€é¡¹å¥å…¨æ€§ä¿®å¤ã€‚<a href="https://github.com/PyO3/pyo3/pull/4095">#4095</a></li>
<li>ä¸ºæ‰€æœ‰å¯èƒ½ panic çš„ <code>Py&lt;T&gt;</code>ã€<code>Bound&lt;'py, T&gt;</code> å’Œ <code>Borrowed&lt;'a, 'py, T&gt;</code> æ–¹æ³•æ·»åŠ  <code>#[track_caller]</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/4098">#4098</a></li>
<li>æ›´æ”¹ <code>PyAnyMethods::dir</code> ä¸ºå¯å¤±è´¥çš„ï¼Œè¿”å› <code>PyResult&lt;Bound&lt;'py, PyList&gt;&gt;</code>ï¼ˆ<code>PyAny::dir</code> åŒç†ï¼‰ã€‚<a href="https://github.com/PyO3/pyo3/pull/4100">#4100</a></li>
<li>å…¨å±€å¼•ç”¨æ± ï¼ˆç”¨äºè·Ÿè¸ªå¾…å¤„ç†çš„å¼•ç”¨è®¡æ•°é€’å‡ï¼‰ç°åœ¨æ”¹ä¸ºæ‡’åˆå§‹åŒ–ï¼Œä»¥é¿å…åœ¨æœªå®é™…ä½¿ç”¨è¯¥åŠŸèƒ½æ—¶äºå‡½æ•°å…¥å£å¤„è·å–äº’æ–¥é”çš„å¼€é”€ã€‚<a href="https://github.com/PyO3/pyo3/pull/4178">#4178</a></li>
<li>å½“ä¸ºæ—§äº Python 3.9 ç‰ˆæœ¬çš„ <code>abi3</code> ç¼–è¯‘æ—¶ï¼Œè‹¥ä½¿ç”¨ <code>weakref</code> æˆ– <code>dict</code>ï¼Œå°†å‘å‡ºé”™è¯¯ä¿¡æ¯ã€‚<a href="https://github.com/PyO3/pyo3/pull/4194">#4194</a></li>
<li>æ›´æ”¹ <code>PyType::name</code> ä»¥å§‹ç»ˆä¸ Python çš„ <code>__name__</code> ä¿æŒä¸€è‡´ã€‚<a href="https://github.com/PyO3/pyo3/pull/4196">#4196</a></li>
<li>ç§»é™¤ç”¨äºå¤æ•°çš„ CPython å†…éƒ¨ FFI è°ƒç”¨ï¼ŒåŒ…æ‹¬ï¼šaddã€subã€mulã€divã€negã€absã€powã€‚æ–°å¢ PyAnyMethods::{abs, pos, neg} <a href="https://github.com/PyO3/pyo3/pull/4201">#4201</a></li>
<li>å¼ƒç”¨ç®€å•æšä¸¾çš„éšå¼æ•´æ•°æ¯”è¾ƒï¼Œæ¨èä½¿ç”¨ <code>#[pyclass(eq_int)]</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/4210">#4210</a></li>
<li>è®¾ç½®å£°æ˜å¼æ¨¡å—çš„å­æ¨¡å— <code>#[pymodule]</code> å’Œ <code>#[pyclass]</code> çš„ <code>module=</code> å±æ€§ã€‚<a href="https://github.com/PyO3/pyo3/pull/4213">#4213</a></li>
<li>ä¸ºå¤æ‚æšä¸¾å˜ä½“çš„ <code>module</code> é€‰é¡¹è®¾ç½®ä¸å…¶æ‰€å±å¤æ‚æšä¸¾ç›¸åŒçš„å€¼ã€‚<a href="https://github.com/PyO3/pyo3/pull/4228">#4228</a></li>
<li>åœ¨ PyPy æˆ– GraalPy ä¸Šæ„å»º <code>abi3</code> ç‰¹æ€§æ—¶ï¼Œéµå¾ª Python â€œæœ‰é™ APIâ€ è§„èŒƒã€‚<a href="https://github.com/PyO3/pyo3/pull/4237">#4237</a></li>
<li>ä¼˜åŒ– <code>#[pyclass]</code> å­—æ®µä¸Š <code>#[pyo3(get)]</code> ç”Ÿæˆçš„ä»£ç ã€‚<a href="https://github.com/PyO3/pyo3/pull/4254">#4254</a></li>
<li><code>PyCFunction::new</code>ã€<code>PyCFunction::new_with_keywords</code> å’Œ <code>PyCFunction::new_closure</code> ç°åœ¨æ¥å— <code>'static CStr</code> ç±»å‹çš„ name å’Œ doc å‚æ•°ï¼ˆä¹‹å‰ä¸º <code>'static str</code>ï¼‰ã€‚<a href="https://github.com/PyO3/pyo3/pull/4255">#4255</a></li>
<li><code>experimental-declarative-modules</code> ç‰¹æ€§ç°å·²ç¨³å®šå¹¶é»˜è®¤å¯ç”¨ã€‚<a href="https://github.com/PyO3/pyo3/pull/4257">#4257</a></li>
</ul>
<h3 id="ä¿®å¤-5"><a class="header" href="#ä¿®å¤-5">ä¿®å¤</a></h3>
<ul>
<li>ä¿®å¤å½“ <code>PYO3_CROSS_LIB_DIR</code> è®¾ç½®ä¸ºä¸å­˜åœ¨è·¯å¾„æ—¶çš„ panicã€‚<a href="https://github.com/PyO3/pyo3/pull/4043">#4043</a></li>
<li>ä¿®å¤ä½¿ç”¨ <code>declarative-module</code> ç‰¹æ€§å¯¼å‡ºä½äºä¸åŒ Rust æ¨¡å—ä¸­ã€é€šè¿‡ <code>create_exception!</code> åˆ›å»ºçš„å¼‚å¸¸æ—¶çš„ç¼–è¯‘é”™è¯¯ã€‚<a href="https://github.com/PyO3/pyo3/pull/4086">#4086</a></li>
<li>ä¿®æ­£ <code>PY_VECTORCALL_ARGUMENTS_OFFSET</code> å’Œ <code>PyVectorcall_NARGS</code> çš„ FFI å®šä¹‰ï¼Œä»¥ä¿®å¤ä¸€ä¸ªè¯¯æŠ¥çš„æ–­è¨€ã€‚<a href="https://github.com/PyO3/pyo3/pull/4104">#4104</a></li>
<li>åœ¨ PyPy ä¸Šç¦ç”¨ <code>PyUnicode_DATA</code>ï¼šPyPy æœªæš´éœ²æ­¤ç¬¦å·ã€‚<a href="https://github.com/PyO3/pyo3/pull/4116">#4116</a></li>
<li>æ­£ç¡®å¤„ç† <code>#[pyo3(from_py_with = ...)]</code> å±æ€§ï¼Œä¸å†å¯¹åŒä¸‹åˆ’çº¿ï¼ˆ<code>__magic__</code>ï¼‰æ–¹æ³•å‚æ•°é™é»˜å¿½ç•¥ã€‚<a href="https://github.com/PyO3/pyo3/pull/4117">#4117</a></li>
<li>ä¿®å¤åœ¨å£°æ˜ä»¥ Python åä¸º Rust å…³é”®å­—çš„ç‹¬ç«‹å‡½æ•°æˆ–ç±»æ–¹æ³•æ—¶çš„ç¼–è¯‘é”™è¯¯ã€‚<a href="https://github.com/PyO3/pyo3/pull/4226">#4226</a></li>
<li>ä¿®å¤å£°æ˜å¼æ¨¡å—å¿½ç•¥ <code>mod</code> èŠ‚ç‚¹ä¸Šæ–‡æ¡£æ³¨é‡Šçš„é—®é¢˜ã€‚<a href="https://github.com/PyO3/pyo3/pull/4236">#4236</a></li>
<li>ä¿®å¤åœ¨ Python 3.9 ä¸Šä¸º <code>abi3</code> æ„å»ºæ—¶ï¼Œ<code>#[pyclass(dict)]</code> å®ä¾‹ç¼ºå°‘ <code>__dict__</code> å±æ€§çš„é—®é¢˜ã€‚<a href="https://github.com/PyO3/pyo3/pull/4251">#4251</a></li>
</ul>
<h2 id="0212---2024-04-16"><a class="header" href="#0212---2024-04-16">[0.21.2] - 2024-04-16</a></h2>
<h3 id="æ›´æ”¹-7"><a class="header" href="#æ›´æ”¹-7">æ›´æ”¹</a></h3>
<ul>
<li>å¼ƒç”¨ <code>PySet::empty()</code> çš„æŒæœ‰ GIL çš„æ„é€ å‡½æ•°ã€‚<a href="https://github.com/PyO3/pyo3/pull/4082">#4082</a></li>
</ul>
<h3 id="ä¿®å¤-6"><a class="header" href="#ä¿®å¤-6">ä¿®å¤</a></h3>
<ul>
<li>ä¿®å¤åœ¨ <code>#[pymethods]</code> ä¸­ä½¿ç”¨ <code>async fn</code> ä¸”æ¥æ”¶è€…ä¸º <code>&amp;self</code> ä¸”æœ‰å¤šä¸ªé¢å¤–å‚æ•°æ—¶çš„ç¼–è¯‘é”™è¯¯ã€‚<a href="https://github.com/PyO3/pyo3/pull/4035">#4035</a></li>
<li>æ”¹è¿› <code>__traverse__</code> ä¸­é”™è¯¯æ¥æ”¶å™¨ç±»å‹çš„é”™è¯¯æç¤ºä¿¡æ¯ã€‚<a href="https://github.com/PyO3/pyo3/pull/4045">#4045</a></li>
<li>ä¿®å¤ä½¿ç”¨ <code>experimental-declarative-modules</code> ç‰¹æ€§å¯¼å‡ºä½äºä¸åŒ Rust æ¨¡å—ä¸­çš„ <code>#[pyclass]</code> æ—¶çš„ç¼–è¯‘é”™è¯¯ã€‚<a href="https://github.com/PyO3/pyo3/pull/4054">#4054</a></li>
<li>ä¿®å¤åœ¨æœ‰æ–‡æ¡£çš„ <code>#[pymodule]</code> å‡½æ•°ä¸Šè§¦å‘ <code>missing_docs</code> lint çš„é—®é¢˜ã€‚<a href="https://github.com/PyO3/pyo3/pull/4067">#4067</a></li>
<li>ä¿®å¤åœ¨ AIX ä¸Šæ‰©å±•æ¨¡å—çš„æœªå®šä¹‰ç¬¦å·é”™è¯¯ï¼ˆé€šè¿‡é“¾æ¥ <code>libpython</code> è§£å†³ï¼‰ã€‚<a href="https://github.com/PyO3/pyo3/pull/4073">#4073</a></li>
</ul>
<h2 id="0211---2024-04-01"><a class="header" href="#0211---2024-04-01">[0.21.1] - 2024-04-01</a></h2>
<h3 id="æ–°å¢-13"><a class="header" href="#æ–°å¢-13">æ–°å¢</a></h3>
<ul>
<li>ä¸º <code>PyBackedStr</code> å’Œ <code>PyBackedBytes</code> å®ç° <code>Send</code> å’Œ <code>Sync</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/4007">#4007</a></li>
<li>ä¸º <code>PyBackedBytes</code> å’Œ <code>PyBackedStr</code> å®ç° <code>Clone</code>ã€<code>Debug</code>ã€<code>PartialEq</code>ã€<code>Eq</code>ã€<code>PartialOrd</code>ã€<code>Ord</code> å’Œ <code>Hash</code>ï¼Œå¹¶ä¸º <code>PyBackedStr</code> å®ç° <code>Display</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/4020">#4020</a></li>
<li>æ·»åŠ  <code>import_exception_bound!</code> å®ï¼Œç”¨äºå¯¼å…¥å¼‚å¸¸ç±»å‹è€Œä¸ä¸ºå®ƒä»¬ç”Ÿæˆ GIL Ref åŠŸèƒ½ã€‚<a href="https://github.com/PyO3/pyo3/pull/4027">#4027</a></li>
</ul>
<h3 id="æ›´æ”¹-8"><a class="header" href="#æ›´æ”¹-8">æ›´æ”¹</a></h3>
<ul>
<li>å¯¹åœ¨ <code>#[setter]</code> å‡½æ•°å‚æ•°ä¸­ä½¿ç”¨ GIL Refs çš„æƒ…å†µå‘å‡ºå¼ƒç”¨è­¦å‘Šã€‚<a href="https://github.com/PyO3/pyo3/pull/3998">#3998</a></li>
<li>ä¸ºè®¸å¤š <code>Bound</code> å’Œ <code>Borrowed</code> æ–¹æ³•æ·»åŠ  <code>#[inline]</code> æç¤ºã€‚<a href="https://github.com/PyO3/pyo3/pull/4024">#4024</a></li>
</ul>
<h3 id="ä¿®å¤-7"><a class="header" href="#ä¿®å¤-7">ä¿®å¤</a></h3>
<ul>
<li>å¤„ç† <code>#[pyo3(from_py_with = "")]</code> åœ¨ <code>#[setter]</code> æ–¹æ³•ä¸­çš„ä½¿ç”¨ã€‚<a href="https://github.com/PyO3/pyo3/pull/3995">#3995</a></li>
<li>å…è®¸åœ¨ <code>#[setter]</code> æ–¹æ³•ä¸­æå– <code>&amp;Bound</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/3998">#3998</a></li>
<li>ä¿®å¤ <code>#[pymodule]</code>ã€<code>#[pyfunction]</code> å’Œ <code>#[pyclass]</code> å®äº§ç”Ÿçš„ä¸€äº›æœªè¦†ç›–çš„ä»£ç å—ã€‚<a href="https://github.com/PyO3/pyo3/pull/4009">#4009</a></li>
<li>ä¿®å¤å½“ <code>pyo3::import_exception!</code> ä¸­å¼•ç”¨çš„ç±»ä¸å­˜åœ¨æ—¶ï¼Œpanic æ¶ˆæ¯ä¸­çš„æ‹¼å†™é”™è¯¯ã€‚<a href="https://github.com/PyO3/pyo3/pull/4012">#4012</a></li>
<li>ä¿®å¤åœ¨ä½¿ç”¨å¸¦æœ‰æ¥æ”¶è€…å’Œé¢å¤–å‚æ•°çš„å¼‚æ­¥ <code>#[pymethod]</code> æ—¶çš„ç¼–è¯‘é”™è¯¯ã€‚<a href="https://github.com/PyO3/pyo3/pull/4015">#4015</a></li>
</ul>
<h2 id="0210---2024-03-25"><a class="header" href="#0210---2024-03-25">[0.21.0] - 2024-03-25</a></h2>
<h3 id="æ–°å¢-14"><a class="header" href="#æ–°å¢-14">æ–°å¢</a></h3>
<ul>
<li>æ·»åŠ å¯¹ GraalPyï¼ˆ24.0 åŠä»¥ä¸Šç‰ˆæœ¬ï¼‰çš„æ”¯æŒã€‚<a href="https://github.com/PyO3/pyo3/pull/3247">#3247</a></li>
<li>æ·»åŠ  <code>PyMemoryView</code> ç±»å‹ã€‚<a href="https://github.com/PyO3/pyo3/pull/3514">#3514</a></li>
<li>åœ¨å¯ç”¨ <code>experimental-async</code> ç‰¹æ€§æ—¶ï¼Œå…è®¸ <code>#[pyfunction]</code> å’Œ <code>#[pymethods]</code> ä¸­ä½¿ç”¨ <code>async fn</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/3540">#3540</a> <a href="https://github.com/PyO3/pyo3/pull/3588">#3588</a> <a href="https://github.com/PyO3/pyo3/pull/3599">#3599</a> <a href="https://github.com/PyO3/pyo3/pull/3931">#3931</a></li>
<li>ä¸º <code>PyEllipsis</code>ã€<code>PyNone</code> å’Œ <code>PyNotImplemented</code> å®ç° <code>PyTypeInfo</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/3577">#3577</a></li>
<li>æ”¯æŒåœ¨å…·æœ‰éå•å…ƒå˜ä½“çš„æšä¸¾ä¸Šä½¿ç”¨ <code>#[pyclass]</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/3582">#3582</a></li>
<li>æ”¯æŒ <code>chrono</code> ç‰¹æ€§ä¸ <code>abi3</code> ç‰¹æ€§å…±ç”¨ã€‚<a href="https://github.com/PyO3/pyo3/pull/3664">#3664</a></li>
<li>ä¸º <code>std::duration::Duration</code> å®ç° <code>FromPyObject</code>ã€<code>IntoPy&lt;PyObject&gt;</code> å’Œ <code>ToPyObject</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/3670">#3670</a>- æ·»åŠ  <code>PyString::to_cow</code>ã€‚æ·»åŠ  <code>Py&lt;PyString&gt;::to_str</code>ã€<code>Py&lt;PyString&gt;::to_cow</code> å’Œ <code>Py&lt;PyString&gt;::to_string_lossy</code>ï¼Œä½œä¸ºåœ¨ GIL ç”Ÿå‘½å‘¨æœŸä¹‹å¤–å®‰å…¨è®¿é—® Python å­—ç¬¦ä¸²æ•°æ®çš„æ–¹æ³•ã€‚<a href="https://github.com/PyO3/pyo3/pull/3677">#3677</a></li>
<li>æ·»åŠ  <code>Bound&lt;T&gt;</code> å’Œ <code>Borrowed&lt;T&gt;</code> æ™ºèƒ½æŒ‡é’ˆï¼Œä½œä¸ºè®¿é—® Python å¯¹è±¡çš„æ–° APIã€‚<a href="https://github.com/PyO3/pyo3/pull/3686">#3686</a></li>
<li>æ·»åŠ  <code>PyNativeType::as_borrowed</code>ï¼Œç”¨äºå°†â€œGIL å¼•ç”¨â€è½¬æ¢ä¸ºæ–°çš„ <code>Bound</code> æ™ºèƒ½æŒ‡é’ˆã€‚<a href="https://github.com/PyO3/pyo3/pull/3692">#3692</a></li>
<li>æ·»åŠ  <code>FromPyObject::extract_bound</code> æ–¹æ³•ï¼Œç”¨äºå°† <code>FromPyObject</code> çš„å®ç°è¿ç§»åˆ° Bound APIã€‚<a href="https://github.com/PyO3/pyo3/pull/3706">#3706</a></li>
<li>æ·»åŠ  <code>gil-refs</code> ç‰¹æ€§ï¼Œå…è®¸ç»§ç»­ä½¿ç”¨å·²å¼ƒç”¨çš„ GIL å¼•ç”¨ APIã€‚<a href="https://github.com/PyO3/pyo3/pull/3707">#3707</a></li>
<li>ä¸º <code>PyAnyMethods</code> æ·»åŠ äºŒå…ƒè¿ç®—ç¬¦æ–¹æ³•ï¼ˆ<code>add</code>ã€<code>sub</code> ç­‰ï¼‰ã€‚<a href="https://github.com/PyO3/pyo3/pull/3712">#3712</a></li>
<li>æ·»åŠ  <code>chrono-tz</code> ç‰¹æ€§ï¼Œå…è®¸åœ¨ <code>chrono_tz::Tz</code> å’Œ <code>zoneinfo.ZoneInfo</code> ä¹‹é—´è¿›è¡Œè½¬æ¢ã€‚<a href="https://github.com/PyO3/pyo3/pull/3730">#3730</a></li>
<li>æ·»åŠ  FFI å®šä¹‰ <code>PyType_GetModuleByDef</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/3734">#3734</a></li>
<li>æ·»åŠ  <code>std::time::SystemTime</code> ä¸ <code>datetime.datetime</code> ä¹‹é—´çš„è½¬æ¢ã€‚<a href="https://github.com/PyO3/pyo3/pull/3736">#3736</a></li>
<li>æ·»åŠ  <code>Py::as_any</code> å’Œ <code>Py::into_any</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/3785">#3785</a></li>
<li>æ·»åŠ  <code>PyStringMethods::encode_utf8</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/3801">#3801</a></li>
<li>æ·»åŠ  <code>PyBackedStr</code> å’Œ <code>PyBackedBytes</code>ï¼Œåœ¨ Python å¯¹è±¡æ‹¥æœ‰æ•°æ®æ—¶ä½œä¸º <code>&amp;str</code> å’Œ <code>&amp;[u8]</code> çš„æ›¿ä»£æ–¹æ¡ˆã€‚<a href="https://github.com/PyO3/pyo3/pull/3802">#3802</a> <a href="https://github.com/PyO3/pyo3/pull/3991">#3991</a></li>
<li>å…è®¸åœ¨ Rust <code>mod</code> å—ä¸Šä½¿ç”¨ <code>#[pymodule]</code> å®ï¼Œé…åˆ <code>experimental-declarative-modules</code> ç‰¹æ€§ã€‚<a href="https://github.com/PyO3/pyo3/pull/3815">#3815</a></li>
<li>åœ¨å¯ç”¨ <code>abi3</code> ç‰¹æ€§æ—¶ï¼Œä¸º <code>set</code> å’Œ <code>frozenset</code> è¿­ä»£å™¨å®ç° <code>ExactSizeIterator</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/3849">#3849</a></li>
<li>æ·»åŠ  <code>Py::drop_ref</code>ï¼Œå¯åœ¨å·²æŒæœ‰ GIL æ—¶æ˜¾å¼é‡Šæ”¾ <code>Py</code> å¹¶ç«‹å³å‡å°‘ Python å¼•ç”¨è®¡æ•°ã€‚<a href="https://github.com/PyO3/pyo3/pull/3871">#3871</a></li>
<li>å…è®¸åœ¨æ¥æ”¶å•ä¸ª <code>&amp;Bound&lt;'_, PyModule&gt;</code> å‚æ•°çš„å‡½æ•°ä¸Šä½¿ç”¨ <code>#[pymodule]</code> å®ã€‚<a href="https://github.com/PyO3/pyo3/pull/3905">#3905</a></li>
<li>ä¸º <code>Cow&lt;str&gt;</code> å®ç° <code>FromPyObject</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/3928">#3928</a></li>
<li>ä¸º <code>GILOnceCell</code> å®ç° <code>Default</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/3971">#3971</a></li>
<li>æ·»åŠ  <code>PyDictMethods::into_mapping</code>ã€<code>PyListMethods::into_sequence</code> å’Œ <code>PyTupleMethods::into_sequence</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/3982">#3982</a></li>
</ul>
<h3 id="å˜æ›´-4"><a class="header" href="#å˜æ›´-4">å˜æ›´</a></h3>
<ul>
<li><code>PyDict::from_sequence</code> ç°åœ¨æ¥å—å•ä¸€ <code>&amp;PyAny</code> ç±»å‹å‚æ•°ï¼ˆä¹‹å‰æ¥å—ä¸¤ä¸ªå‚æ•° <code>Python</code> å’Œ <code>PyObject</code>ï¼‰ã€‚<a href="https://github.com/PyO3/pyo3/pull/3532">#3532</a></li>
<li>ä¸æ¨èä½¿ç”¨ <code>Py::is_ellipsis</code> å’Œ <code>PyAny::is_ellipsis</code>ï¼Œå»ºè®®æ”¹ç”¨ <code>any.is(py.Ellipsis())</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/3577">#3577</a></li>
<li>å°†éƒ¨åˆ† <code>PyTypeInfo</code> åŠŸèƒ½æ‹†åˆ†æˆæ–°çš„ <code>HasPyGilRef</code> å’Œ <code>PyTypeCheck</code> traitã€‚<a href="https://github.com/PyO3/pyo3/pull/3600">#3600</a></li>
<li>ä¸æ¨èä½¿ç”¨ <code>PyTryFrom</code> å’Œ <code>PyTryInto</code> traitï¼Œå»ºè®®é€šè¿‡ <code>PyTypeCheck</code> å’Œ <code>PyTypeInfo</code> trait ä½¿ç”¨ <code>any.downcast()</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/3601">#3601</a></li>
<li>å…è®¸å¼‚æ­¥æ–¹æ³•æ¥æ”¶ <code>&amp;self</code>/<code>&amp;mut self</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/3609">#3609</a></li>
<li><code>FromPyObject</code> å¯¹äºé›†åˆç±»å‹ç°åœ¨ä¹Ÿå¯ä»¥æ¥å— <code>frozenset</code> å¯¹è±¡ä½œä¸ºè¾“å…¥ã€‚<a href="https://github.com/PyO3/pyo3/pull/3632">#3632</a></li>
<li><code>FromPyObject</code> å¯¹äº <code>bool</code> ç°åœ¨ä¹Ÿå¯ä»¥æ¥å— NumPy çš„ <code>bool_</code> ç±»å‹ä½œä¸ºè¾“å…¥ã€‚<a href="https://github.com/PyO3/pyo3/pull/3638">#3638</a></li>
<li>ä¸º <code>PyNativeType</code> æ·»åŠ  <code>AsRefSource</code> å…³è”ç±»å‹ã€‚<a href="https://github.com/PyO3/pyo3/pull/3653">#3653</a></li>
<li>å°† <code>PyAny</code> å’Œ <code>Py&lt;PyAny&gt;</code> ä¸Šçš„ <code>.is_true</code> é‡å‘½åä¸º <code>.is_truthy</code>ï¼Œä»¥æ¾„æ¸…è¯¥æµ‹è¯•å¹¶éåŸºäºä¸ True å•ä¾‹çš„èº«ä»½æˆ–ç›¸ç­‰æ€§æ¯”è¾ƒã€‚<a href="https://github.com/PyO3/pyo3/pull/3657">#3657</a></li>
<li><code>PyType::name</code> ç°åœ¨æ˜¯ <code>PyType::qualname</code>ï¼Œè€Œ <code>PyType::name</code> é«˜æ•ˆåœ°è®¿é—®åŒ…å«æ¨¡å—åçš„å®Œæ•´åç§°ã€‚<a href="https://github.com/PyO3/pyo3/pull/3660">#3660</a></li>
<li><code>Iter(A)NextOutput</code> ç±»å‹ç°å·²å¼ƒç”¨ï¼Œ<code>__(a)next__</code> å¯ä»¥ç›´æ¥è¿”å›ä»»ä½•å¯è½¬æ¢ä¸º Python å¯¹è±¡çš„ç±»å‹ï¼Œå³ awaitable ä¸å†éœ€è¦åŒ…è£…åœ¨ <code>IterANextOutput</code> æˆ– <code>Option</code> ä¸­ã€‚<code>Option</code> ä»å¯ä½¿ç”¨ï¼Œè¿”å› <code>None</code> å°†è§¦å‘ <code>__next__</code> çš„å¿«é€Ÿè·¯å¾„ï¼Œåœæ­¢è¿­ä»£è€Œæ— éœ€å¼•å‘ <code>StopIteration</code> å¼‚å¸¸ã€‚<a href="https://github.com/PyO3/pyo3/pull/3661">#3661</a></li>
<li>ä¸º <code>chrono::DateTime&lt;Tz&gt;</code> ä¸­æ‰€æœ‰ <code>Tz</code> ç±»å‹å®ç° <code>FromPyObject</code>ï¼Œä¸å†ä»…é™äº <code>FixedOffset</code> å’Œ <code>Utc</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/3663">#3663</a></li>
<li>ä¸º <code>PyTzInfoAccess</code> trait æ·»åŠ ç”Ÿå‘½å‘¨æœŸå‚æ•°ã€‚å¯¹äºå·²å¼ƒç”¨çš„ GIL å¼•ç”¨ APIï¼Œè¯¥ trait ç°åœ¨å®ç°äº <code>&amp;'py PyTime</code> å’Œ <code>&amp;'py PyDateTime</code> è€Œé <code>PyTime</code> å’Œ <code>PyDate</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/3679">#3679</a></li>
<li>å½“åœ¨é”™è¯¯çº¿ç¨‹ä¸Šè°ƒç”¨æ—¶ï¼Œå¯¹ä¸å¯å‘é€çš„ pyclass çš„ <code>__traverse__</code> è°ƒç”¨å˜ä¸ºæ— æ“ä½œï¼Œä»è€Œé¿å…ç¡¬ä¸­æ­¢ï¼Œä½†å¯èƒ½é€ æˆå†…å­˜æ³„æ¼ã€‚<a href="https://github.com/PyO3/pyo3/pull/3689">#3689</a></li>
<li>å°† <code>PyNativeType</code> æ·»åŠ åˆ° <code>pyo3::prelude</code> ä¸­ã€‚<a href="https://github.com/PyO3/pyo3/pull/3692">#3692</a></li>
<li>é€šè¿‡é¿å…åœ¨ Python 3.10+ ä¸Šè°ƒç”¨ <code>__index__()</code> æ¥æå‡ <code>extract::&lt;i64&gt;</code>ï¼ˆåŠå…¶ä»–æ•´æ•°ç±»å‹ï¼‰çš„æ€§èƒ½ï¼Œç›´æ¥è½¬æ¢å€¼ä¸ºæ•´æ•°ï¼ŒæˆåŠŸæå–æ—¶æ€§èƒ½æå‡çº¦ 30%ã€‚<a href="https://github.com/PyO3/pyo3/pull/3742">#3742</a></li>
<li>å°† <code>FromPyObject</code> å¯¹äº <code>Py&lt;T&gt;</code> çš„è¾¹ç•Œæ”¾å®½ä¸ºä»…è¦æ±‚ <code>T: PyTypeCheck</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/3776">#3776</a></li>
<li><code>PySet</code> å’Œ <code>PyFrozenSet</code> è¿­ä»£å™¨ç°åœ¨å§‹ç»ˆç­‰æ•ˆäº <code>iter(set)</code> çš„è¿­ä»£ã€‚ï¼ˆç§»é™¤äº†æ— æ˜æ˜¾æ€§èƒ½ä¼˜åŠ¿çš„â€œå¿«é€Ÿè·¯å¾„â€ã€‚ï¼‰<a href="https://github.com/PyO3/pyo3/pull/3849">#3849</a></li>
<li>å½“ <code>gil-refs</code> ç‰¹æ€§æœªå¯ç”¨æ—¶ï¼Œå°† <code>FromPyObject</code> å¯¹äº <code>&amp;str</code>ã€<code>Cow&lt;str&gt;</code>ã€<code>&amp;[u8]</code> å’Œ <code>Cow&lt;[u8]&gt;</code> çš„å®ç°è½¬ç§»åˆ°ä¸´æ—¶ trait <code>FromPyObjectBound</code> ä¸Šã€‚<a href="https://github.com/PyO3/pyo3/pull/3928">#3928</a></li>
<li>ä¸æ¨èä½¿ç”¨ <code>GILPool</code>ã€<code>Python::with_pool</code> å’Œ <code>Python::new_pool</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/3947">#3947</a></li>
</ul>
<h3 id="ç§»é™¤-2"><a class="header" href="#ç§»é™¤-2">ç§»é™¤</a></h3>
<ul>
<li>ç§»é™¤ PyO3 0.19 ä¸­å·²å¼ƒç”¨çš„æ‰€æœ‰åŠŸèƒ½ã€‚<a href="https://github.com/PyO3/pyo3/pull/3603">#3603</a></li>
</ul>
<h3 id="ä¿®å¤-8"><a class="header" href="#ä¿®å¤-8">ä¿®å¤</a></h3>
<ul>
<li>åŒ¹é… PyPy 7.3.14ï¼Œç§»é™¤ PyPy ä¸“æœ‰çš„ç¬¦å· <code>Py_MAX_NDIMS</code>ï¼Œæ”¹ç”¨ <code>PyBUF_MAX_NDIM</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/3757">#3757</a></li>
<li>ä¿®å¤å½“ <code>sys.path</code> ä¸Šå­˜åœ¨æ— æ•ˆ <code>datetime</code> æ¨¡å—æ—¶ä½¿ç”¨ <code>datetime</code> ç±»å‹å¯¼è‡´çš„æ®µé”™è¯¯ã€‚<a href="https://github.com/PyO3/pyo3/pull/3818">#3818</a></li>
<li>ä¿®å¤å›  PyO3 å®è§¦å‘çš„ <code>non_local_definitions</code> lint è­¦å‘Šã€‚<a href="https://github.com/PyO3/pyo3/pull/3901">#3901</a></li>
<li>åœ¨ PyPy ä¸Šç¦ç”¨ <code>PyCode</code> å’Œ <code>PyCode_Type</code>ï¼šPyPy æœªæš´éœ² <code>PyCode_Type</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/3934">#3934</a></li>
</ul>
<h2 id="0210-beta0---2024-03-10"><a class="header" href="#0210-beta0---2024-03-10">[0.21.0-beta.0] - 2024-03-10</a></h2>
<p>PyO3 0.21 çš„é¢„å‘å¸ƒç‰ˆæœ¬ã€‚æœ‰å…³ 0.21.0-beta.0 ä¸æœ€ç»ˆç‰ˆæœ¬ä¹‹é—´çš„å˜æ›´ï¼Œè¯·å‚é˜… <a href="https://github.com/pyo3/pyo3/compare/v0.21.0-beta.0...v0.21.0">GitHub å·®å¼‚</a>ã€‚</p>
<h2 id="0203---2024-02-23"><a class="header" href="#0203---2024-02-23">[0.20.3] - 2024-02-23</a></h2>
<h3 id="æ‰“åŒ…-10"><a class="header" href="#æ‰“åŒ…-10">æ‰“åŒ…</a></h3>
<ul>
<li>æ·»åŠ  <code>portable-atomic</code> ä¾èµ–ã€‚<a href="https://github.com/PyO3/pyo3/pull/3619">#3619</a></li>
<li>åœ¨æ„å»ºæ—¶æ£€æŸ¥ Python æœ€é«˜ç‰ˆæœ¬ï¼Œå¯¹äºå°šæœªæ”¯æŒçš„ç‰ˆæœ¬ï¼Œè¦æ±‚é€šè¿‡ç¯å¢ƒå˜é‡ <code>PYO3_USE_ABI3_FORWARD_COMPATIBILITY=1</code> æ˜¾å¼é€‰æ‹©ä½¿ç”¨ <code>abi3</code> ç¨³å®š ABIã€‚<a href="https://github.com/PyO3/pyo3/pull/3821">#3821</a></li>
</ul>
<h3 id="ä¿®å¤-9"><a class="header" href="#ä¿®å¤-9">ä¿®å¤</a></h3>
<ul>
<li>ä½¿ç”¨ <code>portable-atomic</code> æ”¯æŒæ—  64 ä½åŸå­æ“ä½œçš„å¹³å°ã€‚<a href="https://github.com/PyO3/pyo3/pull/3619">#3619</a></li>
<li>ä¿®å¤åœ¨å¯ç”¨ <code>either</code> ç‰¹æ€§ä½†æœªå¯ç”¨ <code>experimental-inspect</code> æ—¶çš„ç¼–è¯‘å¤±è´¥ã€‚<a href="https://github.com/PyO3/pyo3/pull/3834">#3834</a></li>
</ul>
<h2 id="0202---2024-01-04"><a class="header" href="#0202---2024-01-04">[0.20.2] - 2024-01-04</a></h2>
<h3 id="æ‰“åŒ…-11"><a class="header" href="#æ‰“åŒ…-11">æ‰“åŒ…</a></h3>
<ul>
<li>å°† <code>pyo3</code> å’Œ <code>pyo3-ffi</code> å¯¹ <code>pyo3-build-config</code> çš„ä¾èµ–å›ºå®šä¸ºè¦æ±‚ç›¸åŒçš„è¡¥ä¸ç‰ˆæœ¬ï¼Œå³ <code>pyo3</code> 0.20.2 ä¸¥æ ¼ä¾èµ– <code>pyo3-build-config</code> 0.20.2ã€‚<a href="https://github.com/PyO3/pyo3/pull/3721">#3721</a></li>
</ul>
<h3 id="ä¿®å¤-10"><a class="header" href="#ä¿®å¤-10">ä¿®å¤</a></h3>
<ul>
<li>ä¿®å¤ <code>pyo3</code> 0.20.0 ä¸æœ€æ–° <code>pyo3-build-config</code> 0.20.X æ„å»ºæ—¶çš„ç¼–è¯‘å¤±è´¥ã€‚<a href="https://github.com/PyO3/pyo3/pull/3724">#3724</a></li>
<li>ä¿®å¤ docs.rs æ„å»ºã€‚<a href="https://github.com/PyO3/pyo3/pull/3722">#3722</a></li>
</ul>
<h2 id="0201---2023-12-30"><a class="header" href="#0201---2023-12-30">[0.20.1] - 2023-12-30</a></h2>
<h3 id="æ–°å¢-15"><a class="header" href="#æ–°å¢-15">æ–°å¢</a></h3>
<ul>
<li>æ·»åŠ å¯é€‰ <code>either</code> ç‰¹æ€§ï¼Œæ”¯æŒ <code>either::Either&lt;L, R&gt;</code> å’Œç±»å‹çš„è½¬æ¢ã€‚<a href="https://github.com/PyO3/pyo3/pull/3456">#3456</a></li>
<li>æ·»åŠ å¯é€‰ <code>smallvec</code> ç‰¹æ€§ï¼Œæ”¯æŒ <code>smallvec::SmallVec</code> çš„è½¬æ¢ã€‚<a href="https://github.com/PyO3/pyo3/pull/3507">#3507</a></li>
<li>ä¸º <code>GILOnceCell</code> æ·»åŠ  <code>take</code> å’Œ <code>into_inner</code> æ–¹æ³•ã€‚<a href="https://github.com/PyO3/pyo3/pull/3556">#3556</a></li>
<li><code>#[classmethod]</code> æ–¹æ³•ç°åœ¨ä¹Ÿå¯ä»¥æ¥æ”¶ <code>Py&lt;PyType&gt;</code> ä½œä¸ºç¬¬ä¸€ä¸ªå‚æ•°ã€‚<a href="https://github.com/PyO3/pyo3/pull/3587">#3587</a></li>
<li><code>#[pyfunction(pass_module)]</code> ç°åœ¨ä¹Ÿå¯ä»¥æ¥æ”¶ <code>Py&lt;PyModule&gt;</code> ä½œä¸ºç¬¬ä¸€ä¸ªå‚æ•°ã€‚<a href="https://github.com/PyO3/pyo3/pull/3587">#3587</a></li>
<li>ä¸º <code>GILProtected</code> æ·»åŠ  <code>traverse</code> æ–¹æ³•ã€‚<a href="https://github.com/PyO3/pyo3/pull/3616">#3616</a></li>
<li>æ·»åŠ  <code>abi3-py312</code> ç‰¹æ€§ã€‚<a href="https://github.com/PyO3/pyo3/pull/3687">#3687</a></li>
</ul>
<h3 id="ä¿®å¤-11"><a class="header" href="#ä¿®å¤-11">ä¿®å¤</a></h3>
<ul>
<li>ä¿®å¤å¯é€‰ <code>chrono</code> ä¾èµ–é¡¹çš„æœ€ä½ç‰ˆæœ¬è§„èŒƒã€‚<a href="https://github.com/PyO3/pyo3/pull/3512">#3512</a></li>
<li>æ¶ˆé™¤åœ¨ä½¿ç”¨ <code>Py&lt;Self&gt;</code> ä½œä¸º <code>self</code> æ¥æ”¶å™¨æ—¶è§¦å‘çš„ <code>clippy::unnecessary_fallible_conversions</code> æ–°è­¦å‘Šã€‚<a href="https://github.com/PyO3/pyo3/pull/3564">#3564</a></li>
</ul>
<h2 id="0200---2023-10-11"><a class="header" href="#0200---2023-10-11">[0.20.0] - 2023-10-11</a></h2>
<h3 id="æ‰“åŒ…-12"><a class="header" href="#æ‰“åŒ…-12">æ‰“åŒ…</a></h3>
<ul>
<li>
<p>ä»¥ Apache 2.0 æˆ– MIT è®¸å¯è¯åŒè®¸å¯ PyO3ï¼Œä½¿é¡¹ç›®å…¼å®¹ GPLv2ã€‚<a href="https://github.com/PyO3/pyo3/pull/3108">#3108</a></p>
</li>
<li>
<p>æ›´æ–°æœ€ä½æ”¯æŒ Rust ç‰ˆæœ¬ï¼ˆMSRVï¼‰ä¸º Rust 1.56ã€‚<a href="https://github.com/PyO3/pyo3/pull/3208">#3208</a></p>
</li>
<li>
<p>å°† <code>indoc</code> ä¾èµ–å‡çº§è‡³ 2.0ï¼Œ<code>unindent</code> ä¾èµ–å‡çº§è‡³ 0.2ã€‚<a href="https://github.com/PyO3/pyo3/pull/3237">#3237</a></p>
</li>
<li>
<p>å°† <code>syn</code> ä¾èµ–å‡çº§è‡³ 2.0ã€‚<a href="https://github.com/PyO3/pyo3/pull/3239">#3239</a></p>
</li>
<li>
<p>åœæ­¢æ”¯æŒ Python 3.7 çš„è°ƒè¯•æ„å»ºã€‚<a href="https://github.com/PyO3/pyo3/pull/3387">#3387</a></p>
</li>
<li>
<p>å‡çº§å¯é€‰ä¾èµ– <code>chrono</code> è‡³è¦æ±‚ 0.4.25 æˆ–æ›´é«˜ç‰ˆæœ¬ã€‚<a href="https://github.com/PyO3/pyo3/pull/3427">#3427</a></p>
</li>
<li>
<p>æ”¯æŒ Python 3.12ã€‚<a href="https://github.com/PyO3/pyo3/pull/3488">#3488</a>### æ–°å¢</p>
</li>
<li>
<p>åœ¨ <code>#[pymethods]</code> ä¸­æ”¯æŒ <code>__lt__</code>ã€<code>__le__</code>ã€<code>__eq__</code>ã€<code>__ne__</code>ã€<code>__gt__</code> å’Œ <code>__ge__</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/3203">#3203</a></p>
</li>
<li>
<p>æ·»åŠ  FFI å®šä¹‰ <code>Py_GETENV</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/3336">#3336</a></p>
</li>
<li>
<p>ä¸º <code>Py</code>ã€<code>PyAny</code>ã€<code>PyRef</code> å’Œ <code>PyRefMut</code> æ·»åŠ  <code>as_ptr</code> å’Œ <code>into_ptr</code> å›ºæœ‰æ–¹æ³•ã€‚<a href="https://github.com/PyO3/pyo3/pull/3359">#3359</a></p>
</li>
<li>
<p>ä¸º <code>PyTupleIterator</code> å’Œ <code>PyListIterator</code> å®ç° <code>DoubleEndedIterator</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/3366">#3366</a></p>
</li>
<li>
<p>æ·»åŠ  <code>#[pyclass(rename_all = "...")]</code> é€‰é¡¹ï¼šå…è®¸é‡å‘½åç»“æ„ä½“çš„æ‰€æœ‰ getter å’Œ setterï¼Œæˆ–æšä¸¾çš„æ‰€æœ‰å˜ä½“ã€‚æ”¯æŒçš„é‡å‘½åè§„åˆ™åŒ…æ‹¬ï¼šâ€œcamelCaseâ€ã€â€œkebab-caseâ€ã€â€œlowercaseâ€ã€â€œPascalCaseâ€ã€â€œSCREAMING-KEBAB-CASEâ€ã€â€œSCREAMING_SNAKE_CASEâ€ã€â€œsnake_caseâ€ã€â€œUPPERCASEâ€ã€‚<a href="https://github.com/PyO3/pyo3/pull/3384">#3384</a></p>
</li>
<li>
<p>åœ¨ Python 3.9 åŠæ›´é«˜ç‰ˆæœ¬ï¼ˆPyPy 3.10 åŠæ›´é«˜ç‰ˆæœ¬ï¼‰ä¸­æ·»åŠ  FFI å®šä¹‰ <code>PyObject_GC_IsTracked</code> å’Œ <code>PyObject_GC_IsFinalized</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/3403">#3403</a></p>
</li>
<li>
<p>æ·»åŠ å¯¹ <code>None</code>ã€<code>Ellipsis</code> å’Œ <code>NotImplemented</code> çš„ç±»å‹æ”¯æŒã€‚<a href="https://github.com/PyO3/pyo3/pull/3408">#3408</a></p>
</li>
<li>
<p>æ·»åŠ  <code>Py_mod_multiple_interpreters</code> å¸¸é‡åŠå…¶å¯èƒ½å€¼çš„ FFI å®šä¹‰ã€‚<a href="https://github.com/PyO3/pyo3/pull/3494">#3494</a></p>
</li>
<li>
<p>æ·»åŠ  <code>PyInterpreterConfig</code> ç»“æ„ä½“ã€å…¶å¸¸é‡ä»¥åŠ <code>Py_NewInterpreterFromConfig</code> çš„ FFI å®šä¹‰ã€‚<a href="https://github.com/PyO3/pyo3/pull/3502">#3502</a></p>
</li>
</ul>
<h3 id="æ›´æ”¹-9"><a class="header" href="#æ›´æ”¹-9">æ›´æ”¹</a></h3>
<ul>
<li>å°† <code>PySet::discard</code> çš„è¿”å›å€¼æ”¹ä¸º <code>PyResult&lt;bool&gt;</code>ï¼ˆä¹‹å‰æ— è¿”å›å€¼ï¼‰ã€‚<a href="https://github.com/PyO3/pyo3/pull/3281">#3281</a></li>
<li>ä¼˜åŒ– Rust å…ƒç»„åˆ° Python å…ƒç»„çš„ <code>IntoPy</code> å®ç°ã€‚<a href="https://github.com/PyO3/pyo3/pull/3321">#3321</a></li>
<li>æ›´æ”¹ <code>PyDict::get_item</code> ä¸å†æŠ‘åˆ¶ä»»æ„å¼‚å¸¸ï¼ˆè¿”å›ç±»å‹ç°åœ¨æ˜¯ <code>PyResult&lt;Option&lt;&amp;PyAny&gt;&gt;</code> è€Œé <code>Option&lt;&amp;PyAny&gt;</code>ï¼‰ï¼Œå¹¶å¼ƒç”¨ <code>PyDict::get_item_with_error</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/3330">#3330</a></li>
<li>å¼ƒç”¨åœ¨ Python 3.12 ä¸­å·²è¢«å¼ƒç”¨çš„ FFI å®šä¹‰ã€‚<a href="https://github.com/PyO3/pyo3/pull/3336">#3336</a></li>
<li><code>AsPyPointer</code> ç°åœ¨æ˜¯ä¸€ä¸ª <code>unsafe trait</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/3358">#3358</a></li>
<li>åœ¨ <code>PathBuf</code> çš„ <code>FromPyObject</code> å®ç°ä¸­æ¥å—æ‰€æœ‰ <code>os.PathLike</code> ç±»å‹çš„å€¼ã€‚<a href="https://github.com/PyO3/pyo3/pull/3374">#3374</a></li>
<li>åœ¨ <code>py.run()</code> å’Œ <code>py.eval()</code> ä¸­å¦‚æœç¼ºå¤±ï¼Œåˆ™å‘å…¨å±€å˜é‡æ·»åŠ  <code>__builtins__</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/3378">#3378</a></li>
<li>ä¼˜åŒ– <code>BigInt</code> å’Œ <code>BigUint</code> çš„ <code>FromPyObject</code> å®ç°ã€‚<a href="https://github.com/PyO3/pyo3/pull/3379">#3379</a></li>
<li><code>PyIterator::from_object</code> å’Œ <code>PyByteArray::from</code> ç°åœ¨æ¥å—å•ä¸€å‚æ•°ç±»å‹ä¸º <code>&amp;PyAny</code>ï¼ˆä¹‹å‰æ¥å—ä¸¤ä¸ªå‚æ•°ï¼š<code>Python</code> å’Œ <code>AsPyPointer</code>ï¼‰ã€‚<a href="https://github.com/PyO3/pyo3/pull/3389">#3389</a></li>
<li>åœ¨ <code>From&lt;&amp;T&gt; for PyObject</code> çš„æ³›å‹å®ç°ä¸­ï¼Œå°† <code>AsPyPointer</code> æ›¿æ¢ä¸º <code>AsRef&lt;PyAny&gt;</code> ä½œä¸ºçº¦æŸã€‚<a href="https://github.com/PyO3/pyo3/pull/3391">#3391</a></li>
<li>å°†æ³›å‹ <code>impl IntoPy&lt;PyObject&gt; for &amp;T where T: AsPyPointer</code> æ›¿æ¢ä¸º <code>impl IntoPy&lt;PyObject&gt;</code> å¯¹ <code>&amp;PyAny</code>ã€<code>&amp;T where T: AsRef&lt;PyAny&gt;</code> å’Œ <code>&amp;Py&lt;T&gt;</code> çš„å…·ä½“å®ç°ã€‚<a href="https://github.com/PyO3/pyo3/pull/3393">#3393</a></li>
<li>åœ¨ <code>From&lt;std::io::IntoInnerError&gt;</code> åˆ° <code>PyErr</code> çš„å®ç°ä¸­ä¿ç•™ <code>std::io::Error</code> çš„ç§ç±»ã€‚<a href="https://github.com/PyO3/pyo3/pull/3396">#3396</a></li>
<li>åœ¨ <code>From&lt;PyErr&gt;</code> åˆ° <code>OSError</code> å­ç±»çš„å®ç°ä¸­å°è¯•é€‰æ‹©ç›¸å…³çš„ <code>ErrorKind</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/3397">#3397</a></li>
<li>åœ¨ <code>From&lt;std::io::Error&gt;</code> åˆ° <code>PyErr</code> çš„å®ç°ä¸­ï¼Œè‹¥ <code>std::io::Error</code> æ˜¯åŸºäº Python å¼‚å¸¸æ„å»ºçš„ï¼Œåˆ™æ¢å¤åŸå§‹çš„ <code>PyErr</code>ï¼ˆä¹‹å‰ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„åŒ…è£… <code>std::io::Error</code> çš„å¼‚å¸¸ï¼‰ã€‚<a href="https://github.com/PyO3/pyo3/pull/3402">#3402</a></li>
<li>åœ¨ Python 3.9 åŠæ›´é«˜ç‰ˆæœ¬ä¸­ï¼Œ<code>#[pymodule]</code> åœ¨åŒä¸€ Python è§£é‡Šå™¨å†…é‡å¤å¯¼å…¥æ—¶å°†è¿”å›ç›¸åŒçš„æ¨¡å—å¯¹è±¡ã€‚<a href="https://github.com/PyO3/pyo3/pull/3446">#3446</a></li>
<li>åœ¨å°† <code>chrono</code> ç±»å‹è½¬æ¢ä¸º Python çš„ <code>datetime</code> ç±»å‹æ—¶æˆªæ–­é—°ç§’å¹¶å‘å‡ºè­¦å‘Šï¼ˆ<code>datetime</code> æ— æ³•è¡¨ç¤ºé—°ç§’ï¼‰ã€‚<a href="https://github.com/PyO3/pyo3/pull/3458">#3458</a></li>
<li>ä» <code>catch</code> å—å†…éƒ¨è°ƒç”¨ <code>#[pyfunction]</code> è¿”å›çš„ <code>Err</code> ç°åœ¨ä¼šæœ‰é None çš„ <code>__context__</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/3455">#3455</a></li>
<li>å¼ƒç”¨æœªè®°å½•çš„ <code>#[new]</code> å±æ€§çš„ <code>#[__new__]</code> å½¢å¼ã€‚<a href="https://github.com/PyO3/pyo3/pull/3505">#3505</a></li>
</ul>
<h3 id="ç§»é™¤-3"><a class="header" href="#ç§»é™¤-3">ç§»é™¤</a></h3>
<ul>
<li>ç§»é™¤ PyO3 0.18 ä¸­å¼ƒç”¨çš„æ‰€æœ‰åŠŸèƒ½ï¼ŒåŒ…æ‹¬ <code>#[pymethods]</code> çš„ <code>#[args]</code> å±æ€§ã€‚<a href="https://github.com/PyO3/pyo3/pull/3232">#3232</a></li>
<li>ç§»é™¤ <code>IntoPyPointer</code> traitï¼Œæ”¹ç”¨ <code>into_ptr</code> å›ºæœ‰æ–¹æ³•ã€‚<a href="https://github.com/PyO3/pyo3/pull/3385">#3385</a></li>
</ul>
<h3 id="ä¿®å¤-12"><a class="header" href="#ä¿®å¤-12">ä¿®å¤</a></h3>
<ul>
<li>æ­£ç¡®å¤„ç† <code>PySet::discard</code> ä¸­çš„å¼‚å¸¸ã€‚<a href="https://github.com/PyO3/pyo3/pull/3281">#3281</a></li>
<li><code>PyTuple::iter</code> è¿”å›çš„ <code>PyTupleIterator</code> ç±»å‹ç°åœ¨æ˜¯å…¬å¼€çš„ï¼Œå› æ­¤ä¸‹æ¸¸ crate å¯ä»¥å¼•ç”¨å®ƒã€‚<a href="https://github.com/PyO3/pyo3/pull/3366">#3366</a></li>
<li>ä¿®å¤ PyPy ä¸Š <code>PyOS_FSPath</code> çš„é“¾æ¥é—®é¢˜ã€‚<a href="https://github.com/PyO3/pyo3/pull/3374">#3374</a></li>
<li>ä¿®å¤ <code>PyTypeBuilder::build</code> ä¸­çš„å†…å­˜æ³„æ¼ã€‚<a href="https://github.com/PyO3/pyo3/pull/3401">#3401</a></li>
<li>åœ¨ Python 3.11 åŠä»¥ä¸Šç‰ˆæœ¬ä¸­ç¦ç”¨å·²ç§»é™¤çš„ FFI å®šä¹‰ <code>_Py_GetAllocatedBlocks</code>ã€<code>_PyObject_GC_Malloc</code> å’Œ <code>_PyObject_GC_Calloc</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/3403">#3403</a></li>
<li>ä¿®å¤åœ¨ä½¿ç”¨ CPython çš„è°ƒè¯•æ„å»ºè¿è¡Œæ—¶ä¸ GC ç›¸å…³çš„ <code>ResourceWarning</code> å’Œå´©æºƒé—®é¢˜ã€‚<a href="https://github.com/PyO3/pyo3/pull/3404">#3404</a></li>
<li><code>Option&lt;T&gt;</code> é»˜è®¤å‚æ•°çš„ <code>Some</code> åŒ…è£…ä¸ä¼šå†é‡å¤åŒ…è£… <code>Some(T)</code> æˆ–æ±‚å€¼ä¸º <code>None</code> çš„è¡¨è¾¾å¼ã€‚<a href="https://github.com/PyO3/pyo3/pull/3461">#3461</a></li>
<li>ä¿®å¤ <code>IterNextOutput::Return</code> åœ¨ PyPy ä¸Šä¸è¿”å›å€¼çš„é—®é¢˜ã€‚<a href="https://github.com/PyO3/pyo3/pull/3471">#3471</a></li>
<li>åœ¨ <code>#[pymethods]</code> å—å†…éƒ¨å‘å‡ºç¼–è¯‘é”™è¯¯è€Œä¸æ˜¯å¿½ç•¥å®è°ƒç”¨ã€‚<a href="https://github.com/PyO3/pyo3/pull/3491">#3491</a></li>
<li>å¯¹ <code>#[new]</code>ã€<code>#[classmethod]</code>ã€<code>#[staticmethod]</code> å’Œ <code>#[classattr]</code> çš„æ— æ•ˆå‚æ•°å‘å‡ºé”™è¯¯ã€‚<a href="https://github.com/PyO3/pyo3/pull/3484">#3484</a></li>
<li>åœ¨å¯ç”¨ <code>abi3</code> ç‰¹æ€§æ—¶ç¦ç”¨ <code>PyMarshal_WriteObjectToString</code> å’Œ <code>PyMarshal_ReadObjectFromString</code> çš„ç»„åˆä½¿ç”¨ã€‚<a href="https://github.com/PyO3/pyo3/pull/3490">#3490</a></li>
<li>ä¿®å¤ Python 3.11 åŠä»¥ä¸Šç‰ˆæœ¬ä¸­ <code>_PyFrameEvalFunction</code> çš„ FFI å®šä¹‰ï¼ˆç°åœ¨æ¥æ”¶ä¸€ä¸ª <code>_PyInterpreterFrame</code> ä¸é€æ˜ç»“æ„ä½“ï¼‰ã€‚<a href="https://github.com/PyO3/pyo3/pull/3500">#3500</a></li>
</ul>
<h2 id="0192---2023-08-01"><a class="header" href="#0192---2023-08-01">[0.19.2] - 2023-08-01</a></h2>
<h3 id="æ–°å¢-16"><a class="header" href="#æ–°å¢-16">æ–°å¢</a></h3>
<ul>
<li>ä¸º PyPy 3.9 åŠä»¥ä¸Šç‰ˆæœ¬æ·»åŠ  FFI å®šä¹‰ <code>PyState_AddModule</code>ã€<code>PyState_RemoveModule</code> å’Œ <code>PyState_FindModule</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/3295">#3295</a></li>
<li>æ·»åŠ  FFI å®šä¹‰ <code>_PyObject_CallFunction_SizeT</code> å’Œ <code>_PyObject_CallMethod_SizeT</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/3297">#3297</a></li>
<li>åœ¨ç”¨æˆ·æŒ‡å—ä¸­æ·»åŠ â€œæ€§èƒ½â€éƒ¨åˆ†ï¼Œæ±‡æ€»ä¸æ€§èƒ½ç›¸å…³çš„æŠ€å·§å’Œé—®é¢˜ã€‚<a href="https://github.com/PyO3/pyo3/pull/3304">#3304</a></li>
<li>ä¸ºæ‰€æœ‰ Python ç‰ˆæœ¬æ·»åŠ  <code>PyErr::Display</code>ï¼Œå¹¶ä¸º Python 3.12 æ·»åŠ  FFI ç¬¦å· <code>PyErr_DisplayException</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/3334">#3334</a></li>
<li>ä¸º Python 3.12 æ·»åŠ  FFI å®šä¹‰ <code>PyType_GetDict()</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/3339">#3339</a></li>
<li>æ·»åŠ  <code>PyAny::downcast_exact</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/3346">#3346</a></li>
<li>æ·»åŠ  <code>PySlice::full()</code> ç”¨äºæ„é€ å®Œæ•´åˆ‡ç‰‡ï¼ˆ<code>::</code>ï¼‰ã€‚<a href="https://github.com/PyO3/pyo3/pull/3353">#3353</a></li>
</ul>
<h3 id="æ›´æ”¹-10"><a class="header" href="#æ›´æ”¹-10">æ›´æ”¹</a></h3>
<ul>
<li>æ›´æ–° <code>PyErr</code> ä»¥é€‚é… 3.12 çš„ beta ç‰ˆæœ¬ï¼Œé¿å…ä½¿ç”¨å·²å¼ƒç”¨çš„ FFI æ–¹æ³•ã€‚<a href="https://github.com/PyO3/pyo3/pull/3306">#3306</a></li>
<li>æ›´æ–° Python 3.12.0b4 çš„ <code>object.h</code> çš„ FFI å®šä¹‰ã€‚<a href="https://github.com/PyO3/pyo3/pull/3335">#3335</a></li>
<li>æ›´æ–° <code>pyo3::ffi</code> ç»“æ„ä½“å®šä¹‰ä»¥å…¼å®¹ 3.12.0b4ã€‚<a href="https://github.com/PyO3/pyo3/pull/3342">#3342</a></li>
<li>ä¼˜åŒ–åœ¨é abi3 æ„å»ºä¸­ <code>float</code> åˆ° <code>f64</code>ï¼ˆä»¥åŠ <code>PyFloat::value</code>ï¼‰çš„è½¬æ¢æ€§èƒ½ã€‚<a href="https://github.com/PyO3/pyo3/pull/3345">#3345</a></li>
</ul>
<h3 id="ä¿®å¤-13"><a class="header" href="#ä¿®å¤-13">ä¿®å¤</a></h3>
<ul>
<li>ä¿®å¤ FixedOffset æ—¥æœŸæ—¶é—´é”™è¯¯è½¬æ¢åˆ°å’Œä» UTC çš„æ—¶åŒºè½¬æ¢ bugã€‚<a href="https://github.com/PyO3/pyo3/pull/3269">#3269</a></li>
<li>ä¿®å¤åœ¨ PyPy 3.10 ä¸Šè°ƒç”¨ <code>PyUnicodeDecodeError_Create</code> æ—¶å¼•å‘çš„ <code>SystemError</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/3297">#3297</a></li>
<li>ä¿®æ­£ FFI å®šä¹‰ <code>Py_EnterRecursiveCall</code> è¿”å› <code>c_int</code>ï¼ˆä¹‹å‰é”™è¯¯åœ°è¿”å› <code>()</code>ï¼‰ã€‚<a href="https://github.com/PyO3/pyo3/pull/3300">#3300</a></li>
<li>ä¿®å¤ <code>PyErr::matches</code> å’Œ <code>PyErr::is_instance</code> åœ¨æŸäº›æƒ…å†µä¸‹è¿”å›ä¸ <code>PyErr::get_type</code> ä¸ä¸€è‡´ç»“æœçš„é—®é¢˜ã€‚<a href="https://github.com/PyO3/pyo3/pull/3313">#3313</a></li>
<li>ä¿®å¤åœ¨å¼‚å¸¸ â€œè§„èŒƒåŒ–â€ åä» <code>PanicException</code> è§£é™¤æ ˆæ—¶ä¸¢å¤± panic æ¶ˆæ¯çš„é—®é¢˜ã€‚<a href="https://github.com/PyO3/pyo3/pull/3326">#3326</a></li>
<li>ä¿®å¤ <code>PyErr::from_value</code> å’Œ <code>PyErr::into_value</code> åœ¨è½¬æ¢æ—¶ä¸¢å¤± traceback çš„é—®é¢˜ã€‚<a href="https://github.com/PyO3/pyo3/pull/3328">#3328</a></li>
<li>ä¿®å¤ Python 3.12.0b4 ä¸Šå¯¹æ°¸ç”Ÿå¯¹è±¡ï¼ˆimmortal objectsï¼‰çš„å¼•ç”¨è®¡æ•°é—®é¢˜ã€‚<a href="https://github.com/PyO3/pyo3/pull/3335">#3335</a></li>
</ul>
<h2 id="0191---2023-07-03"><a class="header" href="#0191---2023-07-03">[0.19.1] - 2023-07-03</a></h2>
<h3 id="æ‰“åŒ…-13"><a class="header" href="#æ‰“åŒ…-13">æ‰“åŒ…</a></h3>
<ul>
<li>æ‰©å±•å¯é€‰ä¾èµ– <code>hashbrown</code> æ”¯æŒçš„ç‰ˆæœ¬èŒƒå›´ä»¥åŒ…å« 0.14 ç‰ˆæœ¬ã€‚<a href="https://github.com/PyO3/pyo3/pull/3258">#3258</a></li>
<li>æ‰©å±•å¯é€‰ä¾èµ– <code>indexmap</code> æ”¯æŒçš„ç‰ˆæœ¬èŒƒå›´ä»¥åŒ…å« 2.x ç‰ˆæœ¬ã€‚<a href="https://github.com/PyO3/pyo3/pull/3277">#3277</a></li>
<li>æ”¯æŒ PyPy 3.10ã€‚<a href="https://github.com/PyO3/pyo3/pull/3289">#3289</a></li>
</ul>
<h3 id="æ–°å¢-17"><a class="header" href="#æ–°å¢-17">æ–°å¢</a></h3>
<ul>
<li>æ·»åŠ  <code>pyo3::types::PyFrozenSetBuilder</code>ï¼Œå…è®¸é€é¡¹æ„å»º <code>PyFrozenSet</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/3156">#3156</a></li>
<li>æ·»åŠ å¯¹ Python çš„ <code>ipaddress.IPv4Address</code>/<code>ipaddress.IPv6Address</code> ä¸ <code>std::net::IpAddr</code> ä¹‹é—´ç›¸äº’è½¬æ¢çš„æ”¯æŒã€‚<a href="https://github.com/PyO3/pyo3/pull/3197">#3197</a></li>
<li>æ·»åŠ  <code>num-bigint</code> åŠŸèƒ½ä¸ <code>abi3</code> ç»“åˆä½¿ç”¨æ—¶çš„æ”¯æŒã€‚<a href="https://github.com/PyO3/pyo3/pull/3198">#3198</a></li>
<li>ä¸º Python 3.12 åŠä»¥åç‰ˆæœ¬çš„ FFI å®šä¹‰æ·»åŠ  <code>PyErr_GetRaisedException()</code> å’Œ <code>PyErr_SetRaisedException()</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/3248">#3248</a></li>
<li>æ·»åŠ  <code>Python::with_pool</code>ï¼Œä½œä¸º <code>Python::new_pool</code> æ›´å®‰å…¨ä½†åŠŸèƒ½æ›´æœ‰é™çš„æ›¿ä»£æ–¹æ¡ˆã€‚<a href="https://github.com/PyO3/pyo3/pull/3263">#3263</a></li>
<li>åœ¨ PyPy ä¸Šæ·»åŠ  <code>PyDict::get_item_with_error</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/3270">#3270</a>- å…è®¸ <code>#[new]</code> æ–¹æ³•è¿”å› <code>Py&lt;Self&gt;</code> ä»¥è¿”å›ç°æœ‰å®ä¾‹ã€‚<a href="https://github.com/PyO3/pyo3/pull/3287">#3287</a></li>
</ul>
<h3 id="ä¿®å¤-14"><a class="header" href="#ä¿®å¤-14">ä¿®å¤</a></h3>
<ul>
<li>ä¿®å¤åœ¨ä½¿ç”¨ <code>abi3</code> æˆ– PyPy æ—¶ï¼Œå®ç° <code>__complex__</code> çš„ç±»è½¬æ¢ä¸º <code>Complex</code> çš„é—®é¢˜ã€‚<a href="https://github.com/PyO3/pyo3/pull/3185">#3185</a></li>
<li>åœæ­¢åœ¨ <code>PyAny::hasattr</code> ä¸­æŠ‘åˆ¶æ— å…³å¼‚å¸¸ã€‚<a href="https://github.com/PyO3/pyo3/pull/3271">#3271</a></li>
<li>ä¿®å¤åœ¨åˆ›å»º <code>PySet</code> æˆ– <code>PyFrozenSet</code>ï¼Œæˆ–è¿”å›å†…éƒ¨è½¬æ¢ä¸ºè¿™äº›ç±»å‹çš„ç±»å‹ï¼ˆå¦‚ <code>HashSet</code> æˆ– <code>BTreeSet</code>ï¼‰æ—¶çš„å†…å­˜æ³„æ¼é—®é¢˜ã€‚<a href="https://github.com/PyO3/pyo3/pull/3286">#3286</a></li>
</ul>
<h2 id="0190---2023-05-31"><a class="header" href="#0190---2023-05-31">[0.19.0] - 2023-05-31</a></h2>
<h3 id="æ‰“åŒ…-14"><a class="header" href="#æ‰“åŒ…-14">æ‰“åŒ…</a></h3>
<ul>
<li>å°†å¯¹ <code>syn</code> çš„ä¾èµ–ç‰ˆæœ¬ç”±é”™è¯¯çš„ 1.0.56 æ­£ç¡®æ›´æ–°ä¸º 1.0.85ã€‚<a href="https://github.com/PyO3/pyo3/pull/3152">#3152</a></li>
</ul>
<h3 id="æ–°å¢-18"><a class="header" href="#æ–°å¢-18">æ–°å¢</a></h3>
<ul>
<li>åœ¨ <code>#[pymethods]</code> ä¸­ä¸º <code>#[new]</code> æ¥å— <code>text_signature</code> é€‰é¡¹ï¼Œå¹¶æ”¯æŒè‡ªåŠ¨ç”Ÿæˆç­¾åã€‚<a href="https://github.com/PyO3/pyo3/pull/2980">#2980</a></li>
<li>æ·»åŠ å¯¹ Python çš„ <code>decimal.Decimal</code> ä¸ <code>rust_decimal::Decimal</code> ç›¸äº’è½¬æ¢çš„æ”¯æŒã€‚<a href="https://github.com/PyO3/pyo3/pull/3016">#3016</a></li>
<li>åœ¨æ´¾ç”Ÿ <code>FromPyObject</code> æ—¶æ·»åŠ  <code>#[pyo3(from_item_all)]</code>ï¼Œç”¨äºæŒ‡å®šæ‰€æœ‰å­—æ®µä½¿ç”¨ <code>get_item</code> ä½œä¸ºè·å–å™¨ã€‚<a href="https://github.com/PyO3/pyo3/pull/3120">#3120</a></li>
<li>ä¸º Python 3.11 æ·»åŠ  <code>pyo3::exceptions::PyBaseExceptionGroup</code>ï¼Œä»¥åŠå¯¹åº”çš„ FFI å®šä¹‰ <code>PyExc_BaseExceptionGroup</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/3141">#3141</a></li>
<li>æ”¯æŒ <code>#[new]</code> ä¸ <code>#[classmethod]</code> ä¸€èµ·ä½¿ç”¨ï¼Œä»¥åˆ›å»ºæ¥æ”¶å­ç±»å‹ç±»/<code>PyType</code> ä½œä¸ºç¬¬ä¸€ä¸ªå‚æ•°çš„æ„é€ å‡½æ•°ã€‚<a href="https://github.com/PyO3/pyo3/pull/3157">#3157</a></li>
<li>ä¸ºå¸¦æœ‰ <code>#[pyclass(frozen)]</code> çš„ç±»æ·»åŠ  <code>PyClass::get</code> å’Œ <code>Py::get</code>ï¼Œæ”¯æŒä¸ GIL æ— å…³çš„è®¿é—®ã€‚<a href="https://github.com/PyO3/pyo3/pull/3158">#3158</a></li>
<li>æ·»åŠ  <code>PyAny::is_exact_instance</code> å’Œ <code>PyAny::is_exact_instance_of</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/3161">#3161</a></li>
</ul>
<h3 id="å˜æ›´-5"><a class="header" href="#å˜æ›´-5">å˜æ›´</a></h3>
<ul>
<li><code>PyAny::is_instance_of::&lt;T&gt;(obj)</code> ç°åœ¨ç­‰åŒäº <code>T::is_type_of(obj)</code>ï¼Œå¹¶æ”¹ä¸ºè¿”å› <code>bool</code> è€Œé <code>PyResult&lt;bool&gt;</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/2881">#2881</a></li>
<li>å¼ƒç”¨ <code>#[pyclass]</code> ç»“æ„ä½“ä¸Šçš„ <code>text_signature</code> é€‰é¡¹ã€‚<a href="https://github.com/PyO3/pyo3/pull/2980">#2980</a></li>
<li>ä¸å†å°†ä»…åŒ…å«åŸºæœ¬ <code>PyErr</code> è€Œæ— é“¾å¼é”™è¯¯çš„ <code>anyhow::Error</code>/<code>eyre::Report</code> åŒ…è£…ä¸º <code>PyRuntimeError</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/3004">#3004</a></li>
<li>å°† <code>#[getter]</code> å’Œ <code>#[setter]</code> æ›´æ”¹ä¸ºä½¿ç”¨ä¸€ä¸ªé€šç”¨çš„è°ƒç”¨â€œè·³æ¿â€ï¼Œä»¥ç•¥å¾®å‡å°‘ç”Ÿæˆä»£ç å¤§å°å’Œç¼–è¯‘æ—¶é—´ã€‚<a href="https://github.com/PyO3/pyo3/pull/3029">#3029</a></li>
<li>æ”¹è¿›è‡ªåŠ¨ç”Ÿæˆçš„ <code>text_signature</code> ä¸­å­—ç¬¦ä¸²ã€æ•°å­—å’Œå¸ƒå°”å€¼çš„é»˜è®¤å€¼æ˜¾ç¤ºã€‚<a href="https://github.com/PyO3/pyo3/pull/3050">#3050</a></li>
<li>æ”¹è¿›è‡ªåŠ¨ç”Ÿæˆçš„ <code>text_signature</code> ä¸­ <code>None</code> çš„é»˜è®¤å€¼æ˜¾ç¤ºã€‚<a href="https://github.com/PyO3/pyo3/pull/3066">#3066</a></li>
<li>å°† <code>PySequence::list</code> å’Œ <code>PySequence::tuple</code> é‡å‘½åä¸º <code>PySequence::to_list</code> å’Œ <code>PySequence::to_tuple</code>ã€‚ï¼ˆæ—§åç§°ä»ä¿ç•™ä¸ºå¼ƒç”¨å½¢å¼ã€‚ï¼‰<a href="https://github.com/PyO3/pyo3/pull/3111">#3111</a></li>
<li>å»¶é•¿ <code>PyRef::py</code> å’Œ <code>PyRefMut::py</code> è¿”å›çš„ GIL token çš„ç”Ÿå‘½å‘¨æœŸï¼Œä½¿å…¶ä¸åº•å±‚å€Ÿç”¨åŒ¹é…ã€‚<a href="https://github.com/PyO3/pyo3/pull/3131">#3131</a></li>
<li>ç°åœ¨åœ¨å®ç° <code>__traverse__</code> æ§½ä½å†…éƒ¨ï¼Œå¯¹ GIL çš„å®‰å…¨è®¿é—®ï¼ˆä¾‹å¦‚é€šè¿‡ <code>Python::with_gil</code>ï¼‰ä¼šè¢«é”å®šã€‚<a href="https://github.com/PyO3/pyo3/pull/3168">#3168</a></li>
</ul>
<h3 id="ç§»é™¤-4"><a class="header" href="#ç§»é™¤-4">ç§»é™¤</a></h3>
<ul>
<li>ç§»é™¤åœ¨ PyO3 0.17 ä¸­å·²å¼ƒç”¨çš„æ‰€æœ‰åŠŸèƒ½ï¼Œæœ€æ˜¾è‘—çš„æ˜¯ <code>Python::acquire_gil</code> å·²ç”± <code>Python::with_gil</code> å–ä»£ã€‚<a href="https://github.com/PyO3/pyo3/pull/2981">#2981</a></li>
</ul>
<h3 id="ä¿®å¤-15"><a class="header" href="#ä¿®å¤-15">ä¿®å¤</a></h3>
<ul>
<li>ä¿®æ­£ FFI å®šä¹‰ <code>PyGetSetDef</code>ã€<code>PyMemberDef</code>ã€<code>PyStructSequence_Field</code> å’Œ <code>PyStructSequence_Desc</code> ä¸­ <code>name</code> å’Œ <code>doc</code> æˆå‘˜çš„ç±»å‹ä¸º <code>*const c_char</code>ï¼ˆè€Œé <code>*mut c_char</code>ï¼‰ã€‚<a href="https://github.com/PyO3/pyo3/pull/3036">#3036</a></li>
<li>ä¿®å¤ <code>fmt::Display</code> ä¸­çš„ panicï¼Œæ”¹ä¸ºè¿”å›å­—ç¬¦ä¸² <code>"&lt;unprintable object&gt;"</code> å¹¶é€šè¿‡ <code>sys.unraisablehook()</code> æŠ¥å‘Šé”™è¯¯ã€‚<a href="https://github.com/PyO3/pyo3/pull/3062">#3062</a></li>
<li>ä¿®å¤å½“ <code>#[pyfunction]</code> å¼•ç”¨ <code>#[pyclass]</code> ä¸­çš„å¼•ç”¨æ—¶å‡ºç°çš„â€œä¸´æ—¶å€¼åœ¨å€Ÿç”¨æœŸé—´è¢«ä¸¢å¼ƒâ€ç¼–è¯‘é”™è¯¯ã€‚<a href="https://github.com/PyO3/pyo3/pull/3142">#3142</a></li>
<li>ä¿®å¤å›  PyO3 åœ¨è¿›å…¥ <code>__traverse__</code> å®ç°æ—¶åº”ç”¨å»¶è¿Ÿçš„å¼•ç”¨è®¡æ•°æ›´æ–°è€Œå¯¼è‡´çš„å´©æºƒã€‚<a href="https://github.com/PyO3/pyo3/pull/3168">#3168</a></li>
<li>ç¦æ­¢åœ¨å…¶ä»–çº¿ç¨‹ä¸Šè¿è¡Œæ— æ³•å‘é€ï¼ˆunsendableï¼‰ç±»çš„ <code>Drop</code> å®ç°ã€‚<a href="https://github.com/PyO3/pyo3/pull/3176">#3176</a></li>
<li>ä¿®å¤å½“ <code>#[pymethods]</code> çš„é¡¹æ¥è‡ªå¤–éƒ¨ï¼ˆä¾‹å¦‚ä½œä¸ºå®å‚æ•°ï¼‰ä¸”ä½¿ç”¨äº†å¦‚ <code>Py&lt;Self&gt;</code> è¿™æ ·çš„è‡ªå®šä¹‰æ¥æ”¶å™¨æ—¶çš„ç¼–è¯‘é”™è¯¯ã€‚<a href="https://github.com/PyO3/pyo3/pull/3178">#3178</a></li>
</ul>
<h2 id="0183---2023-04-13"><a class="header" href="#0183---2023-04-13">[0.18.3] - 2023-04-13</a></h2>
<h3 id="æ–°å¢-19"><a class="header" href="#æ–°å¢-19">æ–°å¢</a></h3>
<ul>
<li>æ·»åŠ  <code>GILProtected&lt;T&gt;</code>ï¼Œç”¨äºå€ŸåŠ© Python çš„å…¨å±€è§£é‡Šå™¨é”ï¼ˆGILï¼‰åè°ƒå¯¹å€¼çš„å¹¶å‘è®¿é—®ã€‚<a href="https://github.com/PyO3/pyo3/pull/2975">#2975</a></li>
<li>æ”¯æŒåœ¨å¤§ç«¯æ¶æ„ä¸Šä½¿ç”¨ <code>PyASCIIObject</code> / <code>PyUnicode</code> åŠç›¸å…³æ–¹æ³•ã€‚<a href="https://github.com/PyO3/pyo3/pull/3015">#3015</a></li>
<li>ä¸º CPython 3.10 åŠä»¥ä¸Šç‰ˆæœ¬æ·»åŠ  FFI å®šä¹‰ <code>_PyDict_Contains_KnownHash()</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/3088">#3088</a></li>
</ul>
<h3 id="ä¿®å¤-16"><a class="header" href="#ä¿®å¤-16">ä¿®å¤</a></h3>
<ul>
<li>ä¿®å¤å‡½æ•°åä¸º â€œoutputâ€ çš„ <code>#[pymethods]</code> å’Œ <code>#[pyfunction]</code> çš„ç¼–è¯‘é”™è¯¯ã€‚<a href="https://github.com/PyO3/pyo3/pull/3022">#3022</a></li>
<li>ä¿®å¤ä½¿ç”¨ <code>#[staticmethod]</code> å®ç°çš„é­”æ³•æ–¹æ³•åœ¨ç”Ÿæˆä»£ç ä¸­çš„ç¼–è¯‘é”™è¯¯ã€‚<a href="https://github.com/PyO3/pyo3/pull/3055">#3055</a></li>
<li>ä¿®å¤ <code>PyDateTime</code> çš„ <code>is_instance</code> é—®é¢˜ï¼ˆåŸä¼šé”™è¯¯åœ°æ£€æŸ¥ <code>PyDate</code>ï¼‰ã€‚<a href="https://github.com/PyO3/pyo3/pull/3071">#3071</a></li>
<li>ä¿®å¤å›  Python 3.10 èµ· <code>PyUnicode_InternImmortal</code> è¢«å¼ƒç”¨å¯¼è‡´çš„ä¸Šæ¸¸é—®é¢˜ã€‚<a href="https://github.com/PyO3/pyo3/pull/3087">#3087</a></li>
</ul>
<h2 id="0182---2023-03-24"><a class="header" href="#0182---2023-03-24">[0.18.2] - 2023-03-24</a></h2>
<h3 id="æ‰“åŒ…-15"><a class="header" href="#æ‰“åŒ…-15">æ‰“åŒ…</a></h3>
<ul>
<li>ç¦ç”¨ <code>chrono</code> çš„é»˜è®¤åŠŸèƒ½ï¼Œä»¥é¿å…ä¾èµ– <code>time</code> v0.1.xã€‚<a href="https://github.com/PyO3/pyo3/pull/2939">#2939</a></li>
</ul>
<h3 id="æ–°å¢-20"><a class="header" href="#æ–°å¢-20">æ–°å¢</a></h3>
<ul>
<li>ä¸º <code>Cow&lt;[u8]&gt;</code> å®ç° <code>IntoPy&lt;PyObject&gt;</code>ã€<code>ToPyObject</code> å’Œ <code>FromPyObject</code>ï¼Œä»¥ä¾¿é«˜æ•ˆå¤„ç† <code>bytes</code> å’Œ <code>bytearray</code> å¯¹è±¡ã€‚<a href="https://github.com/PyO3/pyo3/pull/2899">#2899</a></li>
<li>ä¸º <code>Cell&lt;T&gt;</code> å®ç° <code>IntoPy&lt;PyObject&gt;</code>ã€<code>ToPyObject</code> å’Œ <code>FromPyObject</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/3014">#3014</a></li>
<li>æ·»åŠ  <code>PyList::to_tuple()</code>ï¼Œæä¾›ä¸€ç§ä¾¿æ·é«˜æ•ˆçš„åˆ—è¡¨åˆ°å…ƒç»„è½¬æ¢æ–¹å¼ã€‚<a href="https://github.com/PyO3/pyo3/pull/3042">#3042</a></li>
<li>æ·»åŠ  <code>PyTuple::to_list()</code>ï¼Œæä¾›ä¸€ç§ä¾¿æ·é«˜æ•ˆçš„å…ƒç»„åˆ°åˆ—è¡¨è½¬æ¢æ–¹å¼ã€‚<a href="https://github.com/PyO3/pyo3/pull/3044">#3044</a></li>
</ul>
<h3 id="å˜æ›´-6"><a class="header" href="#å˜æ›´-6">å˜æ›´</a></h3>
<ul>
<li>ä¼˜åŒ–é’ˆå¯¹ <code>list</code> å’Œ <code>tuple</code> è¾“å…¥çš„ <code>PySequence</code> è½¬æ¢ã€‚<a href="https://github.com/PyO3/pyo3/pull/2944">#2944</a></li>
<li>æ”¹è¿›æ¨¡å—å¯¼å…¥æœŸé—´åˆ›å»º <code>#[pyclass]</code> ç±»å‹å¯¹è±¡å¤±è´¥æ—¶å¼•å‘çš„å¼‚å¸¸ä¿¡æ¯ã€‚<a href="https://github.com/PyO3/pyo3/pull/2947">#2947</a></li>
<li>ä¼˜åŒ–é’ˆå¯¹ <code>dict</code> è¾“å…¥çš„ <code>PyMapping</code> è½¬æ¢ã€‚<a href="https://github.com/PyO3/pyo3/pull/2954">#2954</a></li>
<li>å…è®¸ <code>create_exception!</code> æ¥æ”¶ <code>dotted.module</code> å½¢å¼çš„å‚æ•°ï¼Œå°†å¼‚å¸¸æ”¾å…¥å­æ¨¡å—ä¸­ã€‚<a href="https://github.com/PyO3/pyo3/pull/2979">#2979</a></li>
</ul>
<h3 id="ä¿®å¤-17"><a class="header" href="#ä¿®å¤-17">ä¿®å¤</a></h3>
<ul>
<li>ä¿®å¤åœ¨ <code>allow_threads</code> å—ä¸­å…‹éš† <code>PyObject</code> æ—¶å­˜åœ¨çš„å¼•ç”¨è®¡æ•°ç«äº‰æ¡ä»¶ã€‚<a href="https://github.com/PyO3/pyo3/pull/2952">#2952</a></li>
<li>ä¿®å¤ <code>#[pyo3(signature = (...))]</code> æ³¨è§£ä¸­é»˜è®¤å‚æ•°è§¦å‘ <code>clippy::redundant_closure</code> æ£€æŸ¥çš„é—®é¢˜ã€‚<a href="https://github.com/PyO3/pyo3/pull/2990">#2990</a></li>
<li>ä¿®å¤ <code>#[pyfunction]</code> å®ç”Ÿæˆä»£ç ä¸­è§¦å‘ <code>non_snake_case</code> æ£€æŸ¥çš„é—®é¢˜ã€‚<a href="https://github.com/PyO3/pyo3/pull/2993">#2993</a></li>
<li>ä¿®å¤ç”¨äºå³å°†å‘å¸ƒçš„ PyPy 3.10 ç‰ˆæœ¬çš„ä¸€äº› FFI å®šä¹‰ã€‚<a href="https://github.com/PyO3/pyo3/pull/3031">#3031</a></li>
</ul>
<h2 id="0181---2023-02-07"><a class="header" href="#0181---2023-02-07">[0.18.1] - 2023-02-07</a></h2>
<h3 id="æ–°å¢-21"><a class="header" href="#æ–°å¢-21">æ–°å¢</a></h3>
<ul>
<li>æ·»åŠ  <code>PyErr::write_unraisable()</code> æ–¹æ³•ã€‚<a href="https://github.com/PyO3/pyo3/pull/2889">#2889</a></li>
<li>æ·»åŠ  <code>Python::Ellipsis()</code> å’Œ <code>PyAny::is_ellipsis()</code> æ–¹æ³•ã€‚<a href="https://github.com/PyO3/pyo3/pull/2911">#2911</a></li>
<li>æ·»åŠ  <code>PyDict::update()</code> å’Œ <code>PyDict::update_if_missing()</code> æ–¹æ³•ã€‚<a href="https://github.com/PyO3/pyo3/pull/2912">#2912</a></li>
</ul>
<h3 id="å˜æ›´-7"><a class="header" href="#å˜æ›´-7">å˜æ›´</a></h3>
<ul>
<li>CPython 3.7 ä¸Šçš„ FFI å®šä¹‰ <code>PyIter_Check</code> ç°åœ¨å®ç°ä¸º <code>hasattr(type(obj), "__next__")</code>ï¼Œå¯åœ¨æ‰€æœ‰å¹³å°æ­£ç¡®è¿è¡Œå¹¶æ”¯æŒ <code>abi3</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/2914">#2914</a></li>
<li>å°† <code>PYO3_CONFIG_FILE</code> ä¸­æœªçŸ¥é…ç½®é”®çš„å¤„ç†ç”±æ‹’ç»æ”¹ä¸ºè­¦å‘Šã€‚<a href="https://github.com/PyO3/pyo3/pull/2926">#2926</a></li>
</ul>
<h3 id="ä¿®å¤-18"><a class="header" href="#ä¿®å¤-18">ä¿®å¤</a></h3>
<ul>
<li>å°† <code>__releasebuffer__</code> è¿”å›çš„é”™è¯¯å‘é€è‡³ <code>sys.unraisablehook</code>ï¼Œè€Œéå¼•å‘ <code>SystemError</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/2886">#2886</a></li>
<li>ä¿®å¤å¯¹æœªå®ç° <code>__next__</code> çš„ Python ç±»ä¹Ÿèƒ½æˆåŠŸå‘ä¸‹è½¬æ¢ä¸º <code>PyIterator</code> çš„é—®é¢˜ã€‚<a href="https://github.com/PyO3/pyo3/pull/2914">#2914</a></li>
<li>ä¿®å¤åœ¨ <code>__traverse__</code> ä¸­è®¿é—® <code>Option&lt;T: AsPyPointer&gt;</code> çš„ <code>None</code> å­—æ®µæ—¶å¯¼è‡´çš„æ®µé”™è¯¯ã€‚<a href="https://github.com/PyO3/pyo3/pull/2921">#2921</a></li>
<li>ä¿®å¤ <code>#[pymethods(crate = "...")]</code> é€‰é¡¹è¢«å¿½ç•¥çš„é—®é¢˜ã€‚<a href="https://github.com/PyO3/pyo3/pull/2923">#2923</a></li>
<li>åœ¨ Windows ä¸Šä¸ºè°ƒè¯•ç‰ˆæœ¬çš„ Python æ„å»ºæ—¶é“¾æ¥ <code>pythonXY_d.dll</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/2937">#2937</a></li>
</ul>
<h2 id="0180---2023-01-17"><a class="header" href="#0180---2023-01-17">[0.18.0] - 2023-01-17</a></h2>
<h3 id="æ‰“åŒ…-16"><a class="header" href="#æ‰“åŒ…-16">æ‰“åŒ…</a></h3>
<ul>
<li>æ”¾å®½ <code>indexmap</code> å¯é€‰ä¾èµ–çš„èŒƒå›´ä¸º <code>&gt;= 1.6, &lt; 2</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/2849">#2849</a></li>
<li>æ”¾å®½ <code>hashbrown</code> å¯é€‰ä¾èµ–çš„èŒƒå›´ä¸º <code>&gt;= 0.9, &lt; 0.14</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/2875">#2875</a></li>
<li>å°† <code>memoffset</code> ä¾èµ–æ›´æ–°è‡³ 0.8 ç‰ˆæœ¬ã€‚<a href="https://github.com/PyO3/pyo3/pull/2875">#2875</a></li>
</ul>
<h3 id="æ–°å¢-22"><a class="header" href="#æ–°å¢-22">æ–°å¢</a></h3>
<ul>
<li>ä¸º <code>GILOnceCell</code> æ·»åŠ  <code>get_or_try_init</code> æ–¹æ³•ï¼Œæ”¯æŒå¯å¤±è´¥çš„åˆå§‹åŒ–ã€‚<a href="https://github.com/PyO3/pyo3/pull/2398">#2398</a></li>
<li>æ·»åŠ å®éªŒæ€§åŠŸèƒ½ <code>experimental-inspect</code>ï¼ŒåŒ…å« <code>type_input()</code> å’Œ <code>type_output()</code> è¾…åŠ©å‡½æ•°ï¼Œç”¨äºè·å–ä»»æ„ Python å…¼å®¹å¯¹è±¡çš„ Python ç±»å‹ã€‚<a href="https://github.com/PyO3/pyo3/pull/2490">#2490</a> <a href="https://github.com/PyO3/pyo3/pull/2882">#2882</a></li>
<li><code>#[pyclass]</code> å®ç°åœ¨å¯æ¥å— <code>get_all</code> å’Œ <code>set_all</code>ï¼Œä¸ºæ¯ä¸ªå­—æ®µè‡ªåŠ¨ç”Ÿæˆ getter å’Œ setterã€‚<a href="https://github.com/PyO3/pyo3/pull/2692">#2692</a></li>
<li>ä¸º <code>#[pyfunction]</code> å’Œ <code>#[pymethods]</code> æ·»åŠ  <code>#[pyo3(signature = (...))]</code> é€‰é¡¹ã€‚<a href="https://github.com/PyO3/pyo3/pull/2702">#2702</a></li>
<li><code>pyo3-build-config</code>ï¼šå½“ç¯å¢ƒå˜é‡ <code>PYO3_ENVIRONMENT_SIGNATURE</code> å€¼å˜åŒ–æ—¶é‡æ–°æ„å»ºã€‚<a href="https://github.com/PyO3/pyo3/pull/2727">#2727</a>- åœ¨ <code>std::num</code> ä¸­çš„éé›¶æ•´å‹ä¸ Python <code>int</code> ä¹‹é—´æ·»åŠ è½¬æ¢æ”¯æŒã€‚<a href="https://github.com/PyO3/pyo3/pull/2730">#2730</a></li>
<li>ä¸º <code>PyAny::downcast()</code> æ·»åŠ é…å¥—çš„ <code>Py::downcast()</code>ï¼Œå¹¶ä¸ºä¸¤è€…æ·»åŠ  <code>downcast_unchecked()</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/2734">#2734</a></li>
<li>æ·»åŠ æ‰€æœ‰å†…ç½® <code>Warning</code> ç±»å‹çš„ç±»å‹å®šä¹‰ï¼Œä»¥åŠ <code>PyErr::warn_explicit</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/2742">#2742</a></li>
<li>æ·»åŠ  <code>abi3-py311</code> åŠŸèƒ½ç‰¹æ€§ã€‚<a href="https://github.com/PyO3/pyo3/pull/2776">#2776</a></li>
<li>ä¸º CPython æ·»åŠ  FFI å®šä¹‰ <code>_PyErr_ChainExceptions()</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/2788">#2788</a></li>
<li>ä¸º PyPy 3.8 åŠæ›´é«˜ç‰ˆæœ¬æ·»åŠ  FFI å®šä¹‰ <code>PyVectorcall_NARGS</code> å’Œ <code>PY_VECTORCALL_ARGUMENTS_OFFSET</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/2811">#2811</a></li>
<li>ä¸º PyPy æ·»åŠ  <code>PyList::get_item_unchecked</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/2827">#2827</a></li>
</ul>
<h3 id="å˜æ›´-8"><a class="header" href="#å˜æ›´-8">å˜æ›´</a></h3>
<ul>
<li>å½“å‡½æ•°è¿”å›å€¼æœªå®ç°æ‰€éœ€ trait æ—¶ï¼ŒPyO3 å®ç°åœ¨ä¼šè¾“å‡ºæ›´å‹å¥½çš„é”™è¯¯ä¿¡æ¯ã€‚<a href="https://github.com/PyO3/pyo3/pull/2664">#2664</a></li>
<li>å½“æ‹’ç»å°†å­—ç¬¦ä¸²è§†ä¸º Vec æ—¶ï¼Œä½¿ç”¨ TypeError è€Œä¸æ˜¯ ValueErrorã€‚<a href="https://github.com/PyO3/pyo3/pull/2685">#2685</a></li>
<li>ä¿®æ”¹ <code>PyCFunction::new_closure</code> ä»¥æ¥å— <code>name</code> å’Œ <code>doc</code> å‚æ•°ã€‚<a href="https://github.com/PyO3/pyo3/pull/2686">#2686</a></li>
<li><code>PyType::is_subclass</code>ã€<code>PyErr::is_instance</code> å’Œ <code>PyAny::is_instance</code> ç°åœ¨æ¥å— <code>&amp;PyAny</code> è€Œä¸æ˜¯ <code>&amp;PyType</code> å‚æ•°ï¼Œä»¥ä¾¿ä¸é€šè¿‡ <code>__subclasscheck__</code> å’Œ <code>__instancecheck__</code> ä¼ªè£…ä¸ºç±»å‹çš„å¯¹è±¡å…¼å®¹ã€‚<a href="https://github.com/PyO3/pyo3/pull/2695">#2695</a></li>
<li>å¼ƒç”¨ <code>#[args]</code> å±æ€§ä»¥åŠç›´æ¥å°† â€œargsâ€ è¯´æ˜ä¼ é€’ç»™ <code>#[pyfunction]</code> çš„æ–¹å¼ï¼Œæ¨èä½¿ç”¨æ–°çš„ <code>#[pyo3(signature = (...))]</code> é€‰é¡¹ã€‚<a href="https://github.com/PyO3/pyo3/pull/2702">#2702</a></li>
<li>å¼ƒç”¨åœ¨ <code>#[pyfunction]</code> å’Œ <code>#[pymethods]</code> ä¸­ï¼Œåœ¨ <code>Option&lt;T&gt;</code> å‚æ•°ä¹‹åä½¿ç”¨å¿…éœ€å‚æ•°ï¼Œè€ŒæœªåŒæ—¶ä½¿ç”¨ <code>#[pyo3(signature)]</code> æŒ‡å®šå‚æ•°æ˜¯å¦å¿…éœ€æˆ–å…·æœ‰é»˜è®¤å€¼çš„åšæ³•ã€‚<a href="https://github.com/PyO3/pyo3/pull/2703">#2703</a></li>
<li>ä¿®æ”¹ <code>#[pyfunction]</code> å’Œ <code>#[pymethods]</code> ä»¥ä½¿ç”¨é€šç”¨çš„è°ƒç”¨â€œè·³æ¿â€ï¼Œç•¥å¾®å‡å°‘ç”Ÿæˆä»£ç å¤§å°å’Œç¼–è¯‘æ—¶é—´ã€‚<a href="https://github.com/PyO3/pyo3/pull/2705">#2705</a></li>
<li><code>PyAny::cast_as()</code> å’Œ <code>Py::cast_as()</code> ç°å·²è¢«å¼ƒç”¨ï¼Œæ¨èä½¿ç”¨ <code>PyAny::downcast()</code> å’Œæ–°çš„ <code>Py::downcast()</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/2734">#2734</a></li>
<li>æ”¾å®½ <code>PyAny::downcast()</code> çš„ç”Ÿå‘½å‘¨æœŸé™åˆ¶ã€‚<a href="https://github.com/PyO3/pyo3/pull/2734">#2734</a></li>
<li>ä¸ºæ‰€æœ‰ä½¿ç”¨ <code>#[pyfunction]</code> å’Œ <code>#[pymethods]</code> åˆ›å»ºçš„ Python å‡½æ•°è‡ªåŠ¨ç”Ÿæˆ <code>__text_signature__</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/2784">#2784</a></li>
<li>åœ¨ <code>PySet::new</code> å’Œ <code>PyFrozenSet::new</code> ä¸­æ¥å—ä»»æ„è¿­ä»£å™¨ã€‚<a href="https://github.com/PyO3/pyo3/pull/2795">#2795</a></li>
<li><code>#[pyclass]</code> ç»“æ„ä½“å­—æ®µä¸Šçš„ <code>#[cfg(...)]</code> å’Œ <code>#[pyo3(...)]</code> å±æ€§æ··åˆä½¿ç”¨ç°åœ¨å¯ä»¥æ­£å¸¸å·¥ä½œã€‚<a href="https://github.com/PyO3/pyo3/pull/2796">#2796</a></li>
<li>é‡æ–°å¯ç”¨åœ¨æ„å»º abi3 æˆ– PyPy æ—¶çš„ <code>PyFunction</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/2838">#2838</a></li>
<li>æ”¹è¿› <code>derive(FromPyObject)</code>ï¼Œåœ¨é€‚ç”¨æ—¶å¯¹ <code>#[pyo3(item)]</code> ä½¿ç”¨ <code>intern!</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/2879">#2879</a></li>
</ul>
<h3 id="ç§»é™¤-5"><a class="header" href="#ç§»é™¤-5">ç§»é™¤</a></h3>
<ul>
<li>ç§»é™¤å·²å¼ƒç”¨çš„ <code>pyproto</code> åŠŸèƒ½ã€<code>#[pyproto]</code> å®åŠç›¸å…³ APIã€‚<a href="https://github.com/PyO3/pyo3/pull/2587">#2587</a></li>
<li>ç§»é™¤ PyO3 0.16 ä¸­å¼ƒç”¨çš„æ‰€æœ‰åŠŸèƒ½ã€‚<a href="https://github.com/PyO3/pyo3/pull/2843">#2843</a></li>
</ul>
<h3 id="ä¿®å¤-19"><a class="header" href="#ä¿®å¤-19">ä¿®å¤</a></h3>
<ul>
<li>åœ¨ PyPy ä¸Šç¦ç”¨ <code>PyModule::filename</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/2715">#2715</a></li>
<li><code>PyCodeObject</code> åœ¨ Python 3.7 ä¸Šå†æ¬¡å®šä¹‰ä¸ºåŒ…å«å­—æ®µã€‚<a href="https://github.com/PyO3/pyo3/pull/2726">#2726</a></li>
<li>è‹¥å¸¦æœ‰ <code>#[new]</code> çš„ pymethod æ¥æ”¶æ— å‚æ•°ä½†åœ¨è°ƒç”¨æ—¶ä¼ å…¥äº†å‚æ•°ï¼ŒæŠ›å‡º <code>TypeError</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/2749">#2749</a></li>
<li>å¯¹ä»…æ¥å—å•ä¸ª <code>py: Python</code> å‚æ•°çš„æ–¹æ³•ä½¿ç”¨ <code>NOARGS</code> è°ƒç”¨çº¦å®šï¼ˆä½œä¸ºæ€§èƒ½ä¼˜åŒ–ï¼‰ã€‚<a href="https://github.com/PyO3/pyo3/pull/2760">#2760</a></li>
<li>ä¿®å¤ <code>PySlice::new</code> ä¸­ <code>isize</code> å€¼è¢«æˆªæ–­ä¸º <code>c_long</code> çš„é—®é¢˜ã€‚<a href="https://github.com/PyO3/pyo3/pull/2769">#2769</a></li>
<li>ä¿®å¤ PyPy ä¸Š FFI å®šä¹‰ <code>PyUnicodeDecodeError_Create</code> å¯¼è‡´çš„å†…å­˜å®‰å…¨é—®é¢˜ï¼Œè¯¥é—®é¢˜ä¼šå¼•èµ·ä¸ç¡®å®šè¡Œä¸ºï¼ˆé€šå¸¸æ˜¯ <code>TypeError</code>ï¼‰ã€‚<a href="https://github.com/PyO3/pyo3/pull/2772">#2772</a></li>
<li>å…è®¸æ¥å— <code>**kwargs</code> çš„å‡½æ•°æ¥æ”¶ä¸ä»…ä½ç½®å‚æ•°åŒåçš„å…³é”®å­—å‚æ•°ï¼ˆç¬¦åˆ PEP 570 çš„è§„å®šï¼‰ã€‚<a href="https://github.com/PyO3/pyo3/pull/2800">#2800</a></li>
<li>ä¿®å¤ PyPy 3.9 åŠæ›´é«˜ç‰ˆæœ¬ä¸­ <code>PyObject_Vectorcall</code> ç¬¦å·æœªè§£æçš„é—®é¢˜ã€‚<a href="https://github.com/PyO3/pyo3/pull/2811">#2811</a></li>
<li>ä¿®å¤ <code>PyCFunction::new_closure</code> ä¸­çš„å†…å­˜æ³„æ¼ã€‚<a href="https://github.com/PyO3/pyo3/pull/2842">#2842</a></li>
</ul>
<h2 id="0173---2022-11-01"><a class="header" href="#0173---2022-11-01">[0.17.3] - 2022-11-01</a></h2>
<h3 id="æ‰“åŒ…-17"><a class="header" href="#æ‰“åŒ…-17">æ‰“åŒ…</a></h3>
<ul>
<li>æ”¯æŒ Python 3.11ã€‚ï¼ˆä¹‹å‰çš„ PyO3 0.17 ç‰ˆæœ¬å·²æµ‹è¯•è¿‡ Python 3.11 çš„å‘å¸ƒå€™é€‰ç‰ˆå¹¶é¢„æœŸå…¼å®¹ï¼Œè¿™æ˜¯é¦–ä¸ªæ­£å¼æµ‹è¯• Python 3.11.0 çš„ç‰ˆæœ¬ã€‚ï¼‰<a href="https://github.com/PyO3/pyo3/pull/2708">#2708</a></li>
</ul>
<h3 id="æ–°å¢-23"><a class="header" href="#æ–°å¢-23">æ–°å¢</a></h3>
<ul>
<li>ä¸º <code>PyListIterator</code>ã€<code>PyDictIterator</code>ã€<code>PySetIterator</code> å’Œ <code>PyFrozenSetIterator</code> å®ç° <code>ExactSizeIterator</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/2676">#2676</a></li>
</ul>
<h3 id="ä¿®å¤-20"><a class="header" href="#ä¿®å¤-20">ä¿®å¤</a></h3>
<ul>
<li>ä¿®å¤ <code>impl FromPyObject for [T; N]</code> æ— æ³•æ¥å—é€šè¿‡ <code>PySequence_Check</code> çš„ç±»å‹ï¼ˆå¦‚ NumPy æ•°ç»„ï¼‰çš„å›å½’é—®é¢˜ï¼Œè¯¥é—®é¢˜è‡ª 0.17.0 ç‰ˆæœ¬å‡ºç°ï¼Œæ­¤æ¬¡æ˜¯å°† 0.17.1 å¯¹ <code>Vec&lt;T&gt;</code> çš„ä¿®å¤æ‰©å±•è‡³å®šé•¿æ•°ç»„ã€‚<a href="https://github.com/PyO3/pyo3/pull/2675">#2675</a></li>
<li>ä¿®å¤å› ä»ç©ºæŒ‡é’ˆåˆ›å»ºåˆ‡ç‰‡å¯¼è‡´çš„ <code>FunctionDescription::extract_arguments_fastcall</code> ä¸­çš„æœªå®šä¹‰è¡Œä¸ºï¼ˆUBï¼‰ã€‚<a href="https://github.com/PyO3/pyo3/pull/2687">#2687</a></li>
</ul>
<h2 id="0172---2022-10-04"><a class="header" href="#0172---2022-10-04">[0.17.2] - 2022-10-04</a></h2>
<h3 id="æ‰“åŒ…-18"><a class="header" href="#æ‰“åŒ…-18">æ‰“åŒ…</a></h3>
<ul>
<li>æ·»åŠ å¯é€‰çš„ <code>chrono</code> åŠŸèƒ½ä»¥å°† <code>chrono</code> ç±»å‹è½¬æ¢ä¸º <code>datetime</code> æ¨¡å—ä¸­çš„ç±»å‹ã€‚<a href="https://github.com/PyO3/pyo3/pull/2612">#2612</a></li>
</ul>
<h3 id="æ–°å¢-24"><a class="header" href="#æ–°å¢-24">æ–°å¢</a></h3>
<ul>
<li>æ·»åŠ å¯¹ PyPy ä¸Š <code>num-bigint</code> åŠŸèƒ½çš„æ”¯æŒã€‚<a href="https://github.com/PyO3/pyo3/pull/2626">#2626</a></li>
</ul>
<h3 id="ä¿®å¤-21"><a class="header" href="#ä¿®å¤-21">ä¿®å¤</a></h3>
<ul>
<li>æ­£ç¡®å®ç°æšä¸¾çš„ <code>__richcmp__</code>ï¼Œä¿®å¤ <code>__ne__</code> å§‹ç»ˆè¿”å› <code>True</code> çš„é—®é¢˜ã€‚<a href="https://github.com/PyO3/pyo3/pull/2622">#2622</a></li>
<li>ä¿®å¤è‡ª 0.17.0 ä»¥æ¥ä½¿ç”¨å¸¦æœ‰é»˜è®¤å€¼çš„ <code>Option&lt;&amp;SomePyClass&gt;</code> å‚æ•°å¯¼è‡´çš„ç¼–è¯‘é”™è¯¯ã€‚<a href="https://github.com/PyO3/pyo3/pull/2630">#2630</a></li>
<li>ä¿®å¤ <code>impl FromPyObject for Vec&lt;T&gt;</code> æ— æ³•æ¥å—é€šè¿‡ <code>PySequence_Check</code> çš„ç±»å‹ï¼ˆå¦‚ NumPy æ•°ç»„ï¼‰çš„å›å½’é—®é¢˜ï¼Œè¯¥é—®é¢˜è‡ª 0.17.0 ç‰ˆæœ¬èµ·å­˜åœ¨ã€‚<a href="https://github.com/PyO3/pyo3/pull/2631">#2631</a></li>
</ul>
<h2 id="0171---2022-08-28"><a class="header" href="#0171---2022-08-28">[0.17.1] - 2022-08-28</a></h2>
<h3 id="ä¿®å¤-22"><a class="header" href="#ä¿®å¤-22">ä¿®å¤</a></h3>
<ul>
<li>ä¿®å¤ PyO3 0.17.0 ä¸­æ–°å¢çš„ <code>PyDictItems</code>ã€<code>PyDictKeys</code> å’Œ <code>PyDictValues</code> ç±»å‹çš„å¯è§æ€§é—®é¢˜ã€‚</li>
<li>ä¿®å¤åœ¨ <code>Option&lt;T&gt;</code> ç±»å‹å‚æ•°ä¸Šä½¿ç”¨ <code>#[pyo3(from_py_with = "...")]</code> å±æ€§æ—¶å¯¼è‡´çš„ç¼–è¯‘å¤±è´¥ã€‚<a href="https://github.com/PyO3/pyo3/pull/2592">#2592</a></li>
<li>ä¿®å¤ <code>#[pyfunction]</code> å’Œ <code>#[pymethods]</code> å¯¹ <code>**kwargs</code> å‚æ•°è§¦å‘ clippy <code>redundant-closure</code> è­¦å‘Šçš„é—®é¢˜ã€‚<a href="https://github.com/PyO3/pyo3/pull/2595">#2595</a></li>
</ul>
<h2 id="0170---2022-08-23"><a class="header" href="#0170---2022-08-23">[0.17.0] - 2022-08-23</a></h2>
<h3 id="æ‰“åŒ…-19"><a class="header" href="#æ‰“åŒ…-19">æ‰“åŒ…</a></h3>
<ul>
<li>å°† inventory ä¾èµ–æ›´æ–°è‡³ <code>0.3</code>ï¼ˆ<code>multiple-pymethods</code> åŠŸèƒ½ç°éœ€ Rust 1.62 ä»¥ä¿è¯æ­£ç¡®æ€§ï¼‰ã€‚<a href="https://github.com/PyO3/pyo3/pull/2492">#2492</a></li>
</ul>
<h3 id="æ–°å¢-25"><a class="header" href="#æ–°å¢-25">æ–°å¢</a></h3>
<ul>
<li>æ·»åŠ  <code>timezone_utc</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/1588">#1588</a></li>
<li>ä¸º <code>[T; N]</code> å®ç° <code>ToPyObject</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/2313">#2313</a></li>
<li>æ·»åŠ  <code>PyDictKeys</code>ã€<code>PyDictValues</code> å’Œ <code>PyDictItems</code> Rust ç±»å‹ã€‚<a href="https://github.com/PyO3/pyo3/pull/2358">#2358</a></li>
<li>æ·»åŠ  <code>append_to_inittab</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/2377">#2377</a></li>
<li>æ·»åŠ  FFI å®šä¹‰ <code>PyFrame_GetCode</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/2406">#2406</a></li>
<li>æ·»åŠ é«˜å±‚å¯¹è±¡ <code>PyCode</code> å’Œ <code>PyFrame</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/2408">#2408</a></li>
<li>æ·»åŠ  FFI å®šä¹‰ <code>Py_fstring_input</code>ã€<code>sendfunc</code> å’Œ <code>_PyErr_StackItem</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/2423">#2423</a></li>
<li>ä¸º PyPy æ·»åŠ  <code>PyDateTime::new_with_fold</code>ã€<code>PyTime::new_with_fold</code>ã€<code>PyTime::get_fold</code> å’Œ <code>PyDateTime::get_fold</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/2428">#2428</a></li>
<li>æ·»åŠ  <code>#[pyclass(frozen)]</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/2448">#2448</a></li>
<li>å…è®¸ <code>#[pyo3(name)]</code> ç”¨äºæšä¸¾å˜ä½“ã€‚<a href="https://github.com/PyO3/pyo3/pull/2457">#2457</a></li>
<li>æ·»åŠ  <code>CompareOp::matches</code>ï¼Œé€šè¿‡ <code>std::cmp::Ordering</code> æ¯”è¾ƒç»“æœæ¥å®ç° <code>__richcmp__</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/2460">#2460</a></li>
<li>æ·»åŠ  <code>PySuper</code> ç±»å‹ã€‚<a href="https://github.com/PyO3/pyo3/pull/2486">#2486</a></li>
<li>é€šè¿‡ <code>generate-import-lib</code> åŠŸèƒ½æ”¯æŒ Windows ä¸Šçš„ PyPyã€‚<a href="https://github.com/PyO3/pyo3/pull/2506">#2506</a></li>
<li>æ·»åŠ  FFI å®šä¹‰ <code>Py_EnterRecursiveCall</code> å’Œ <code>Py_LeaveRecursiveCall</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/2511">#2511</a></li>
<li>æ·»åŠ  <code>PyDict::get_item_with_error</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/2536">#2536</a></li>
<li>æ·»åŠ  <code>#[pyclass(sequence)]</code> é€‰é¡¹ã€‚<a href="https://github.com/PyO3/pyo3/pull/2567">#2567</a></li>
</ul>
<h3 id="å˜æ›´-9"><a class="header" href="#å˜æ›´-9">å˜æ›´</a></h3>
<ul>
<li>å°†æ¥æ”¶ <code>tzinfo</code> çš„ datetime æ„é€ å‡½æ•°æ”¹ä¸ºæ¥æ”¶ <code>Option&lt;&amp;PyTzInfo&gt;</code> è€Œé <code>Option&lt;&amp;PyObject&gt;</code>ï¼š<code>PyDateTime::new</code>ã€<code>PyDateTime::new_with_fold</code>ã€<code>PyTime::new</code> å’Œ <code>PyTime::new_with_fold</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/1588">#1588</a></li>
<li>å°† <code>PyTypeObject::type_object</code> æ–¹æ³•ç§»è‡³ <code>PyTypeInfo</code> traitï¼Œå¹¶å¼ƒç”¨ <code>PyTypeObject</code> traitã€‚<a href="https://github.com/PyO3/pyo3/pull/2287">#2287</a></li>
<li><code>Py</code> å’Œ <code>PyAny</code> çš„æ–¹æ³•ç°åœ¨æ¥å— <code>impl IntoPy&lt;Py&lt;PyString&gt;&gt;</code> è€Œä¸ä»…æ˜¯ <code>&amp;str</code>ï¼Œä»¥æ”¯æŒ <code>intern!</code> å®ã€‚<a href="https://github.com/PyO3/pyo3/pull/2312">#2312</a></li>
<li>å°†å·²å¼ƒç”¨çš„ <code>pyproto</code> åŠŸèƒ½æ”¹ä¸ºé»˜è®¤ä¸å¯ç”¨ï¼ˆopt-inï¼‰è€Œéé»˜è®¤å¯ç”¨ï¼ˆopt-outï¼‰ã€‚<a href="https://github.com/PyO3/pyo3/pull/2322">#2322</a></li>
<li>åœ¨ <code>#[pyfunction]</code> è¿”å›ç±»å‹æœªå®ç° <code>IntoPy</code> æ—¶è¾“å‡ºæ›´æ¸…æ™°çš„é”™è¯¯ä¿¡æ¯ã€‚<a href="https://github.com/PyO3/pyo3/pull/2326">#2326</a></li>
<li>å¯¹ <code>impl&lt;T, const N: usize&gt; IntoPy&lt;PyObject&gt; for [T; N]</code> è¦æ±‚ <code>T: IntoPy</code> è€Œä¸æ˜¯ <code>T: ToPyObject</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/2326">#2326</a></li>
<li>å¼ƒç”¨ <code>ToBorrowedObject</code> traitã€‚<a href="https://github.com/PyO3/pyo3/pull/2333">#2333</a></li>
<li>è‹¥è¿­ä»£è¿‡ç¨‹ä¸­åº•å±‚é›†åˆè¢«ä¿®æ”¹ï¼Œ<code>PySet</code> å’Œ <code>PyDict</code> çš„è¿­ä»£å™¨ç°åœ¨ä¼š panicã€‚<a href="https://github.com/PyO3/pyo3/pull/2380">#2380</a>- å½“è¿­ä»£æœŸé—´åº•å±‚é›†åˆè¢«ä¿®æ”¹æ—¶ï¼Œ<code>PySet</code> å’Œ <code>PyDict</code> çš„è¿­ä»£å™¨ç°åœ¨ä¼š panicã€‚<a href="https://github.com/PyO3/pyo3/pull/2380">#2380</a></li>
<li>å…è®¸ <code>#[classattr]</code> æ–¹æ³•è¿”å›é”™è¯¯ã€‚<a href="https://github.com/PyO3/pyo3/pull/2385">#2385</a></li>
<li>é˜²æ­¢å•ä¸ª <code>#[pyclass]</code> ä¸­å‡ºç°å¤šä¸ªåŒå <code>#[pymethods]</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/2399">#2399</a></li>
<li>ä½¿ç”¨ <code>PYO3_CONFIG_FILE</code> æ—¶ä¿®å¤ <code>lib_name</code> çš„é…ç½®é—®é¢˜ã€‚<a href="https://github.com/PyO3/pyo3/pull/2404">#2404</a></li>
<li>ä¸ºå…ƒç»„ç»“æ„ä½“ <code>#[derive(FromPyObject)]</code> å®ç°æŠ›å‡ºçš„ <code>ValueError</code> æ·»åŠ é”™è¯¯æ¶ˆæ¯ã€‚<a href="https://github.com/PyO3/pyo3/pull/2414">#2414</a></li>
<li>å…è®¸ <code>#[classattr]</code> æ–¹æ³•æ¥å— <code>Python</code> å‚æ•°ã€‚<a href="https://github.com/PyO3/pyo3/pull/2456">#2456</a></li>
<li>é‡æ„ <code>PyCapsule</code> ç±»å‹ä»¥è§£å†³å®‰å…¨æ€§é—®é¢˜ï¼š<a href="https://github.com/PyO3/pyo3/pull/2485">#2485</a>
<ul>
<li><code>PyCapsule::new</code> å’Œ <code>PyCapsule::new_with_destructor</code> ç°åœ¨æ¥å— <code>name: Option&lt;CString&gt;</code> è€Œä¸æ˜¯ <code>&amp;CStr</code>ã€‚</li>
<li><code>PyCapsule::new_with_destructor</code> ä¸­çš„ææ„å‡½æ•° <code>F</code> ç°åœ¨å¿…é¡»æ˜¯ <code>Send</code>ã€‚</li>
<li>ä¸å†æ¨èä½¿ç”¨ <code>PyCapsule::get_context</code>ï¼Œæ¨èä½¿ç”¨ä¸æ¥å— <code>py: Python&lt;'_&gt;</code> å‚æ•°çš„ <code>PyCapsule::context</code>ã€‚</li>
<li><code>PyCapsule::set_context</code> ä¸å†æ¥å— <code>py: Python&lt;'_&gt;</code> å‚æ•°ã€‚</li>
<li><code>PyCapsule::name</code> ç°åœ¨è¿”å› <code>PyResult&lt;Option&lt;&amp;CStr&gt;&gt;</code> è€Œä¸æ˜¯ <code>&amp;CStr</code>ã€‚</li>
</ul>
</li>
<li><code>Vec&lt;T&gt;</code> çš„ <code>FromPyObject::extract</code> ä¸å†æ¥å— Python <code>str</code> è¾“å…¥ã€‚<a href="https://github.com/PyO3/pyo3/pull/2500">#2500</a></li>
<li>ç¡®ä¿æ¯ä¸ª <code>#[pymodule]</code> ä»…åˆå§‹åŒ–ä¸€æ¬¡ã€‚<a href="https://github.com/PyO3/pyo3/pull/2523">#2523</a></li>
<li><code>pyo3_build_config::add_extension_module_link_args</code> ç°åœ¨ä¹Ÿä¼šä¸º <code>wasm32-unknown-emscripten</code> å‘å‡ºé“¾æ¥å™¨å‚æ•°ã€‚<a href="https://github.com/PyO3/pyo3/pull/2538">#2538</a></li>
<li><code>PySequence</code> å’Œ <code>PyMapping</code> çš„ç±»å‹æ£€æŸ¥ç°åœ¨è¦æ±‚è¾“å…¥åˆ†åˆ«ç»§æ‰¿è‡ªï¼ˆæˆ–æ³¨å†Œåˆ°ï¼‰<code>collections.abc.Sequence</code> å’Œ <code>collections.abc.Mapping</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/2477">#2477</a></li>
<li>åœ¨æ„å»º abi3 æˆ– PyPy ç›®æ ‡æ—¶ç¦ç”¨ <code>PyFunction</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/2542">#2542</a></li>
<li>æ ‡è®° <code>Python::acquire_gil</code> ä¸ºå·²å¼ƒç”¨ã€‚<a href="https://github.com/PyO3/pyo3/pull/2549">#2549</a></li>
</ul>
<h3 id="å·²ç§»é™¤-4"><a class="header" href="#å·²ç§»é™¤-4">å·²ç§»é™¤</a></h3>
<ul>
<li>ç§»é™¤ PyO3 0.15 ä¸­å·²å¼ƒç”¨çš„æ‰€æœ‰åŠŸèƒ½ã€‚<a href="https://github.com/PyO3/pyo3/pull/2283">#2283</a></li>
<li>å°† <code>Dict</code>ã€<code>WeakRef</code> å’Œ <code>BaseNativeType</code> æˆå‘˜è®¾ä¸º <code>PyClass</code> çš„ç§æœ‰å®ç°ç»†èŠ‚ã€‚<a href="https://github.com/PyO3/pyo3/pull/2572">#2572</a></li>
</ul>
<h3 id="å·²ä¿®å¤-14"><a class="header" href="#å·²ä¿®å¤-14">å·²ä¿®å¤</a></h3>
<ul>
<li>å¯ç”¨é”™è¯¯ç¦ç”¨çš„ FFI å®šä¹‰ <code>PyThreadState_DeleteCurrent</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/2357">#2357</a></li>
<li>ä¿®å¤ <code>wrap_pymodule</code> ä¸å‘½åè§£æè§„åˆ™çš„äº¤äº’ï¼šå½“ <code>submodule::submodule</code> æ˜¯ <code>#[pymodule]</code> æ—¶ï¼Œä¸å†â€œç©¿é€â€ <code>use submodule::*</code> çš„é€šé…ç¬¦å¯¼å…¥ã€‚<a href="https://github.com/PyO3/pyo3/pull/2363">#2363</a></li>
<li>ä¿®æ­£ FFI å®šä¹‰ <code>PyEval_EvalCodeEx</code> ä»¥æ¥å— <code>*const *mut PyObject</code> æ•°ç»„å‚æ•°ï¼Œè€Œé <code>*mut *mut PyObject</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/2368">#2368</a></li>
<li>ä¿®å¤â€œåŸå§‹æ ‡è¯†ç¬¦â€ç»“æ„ä½“ï¼ˆå¦‚ <code>#[pyclass] struct r#RawName</code>ï¼‰åœ¨ Python ä¸­åˆ›å»ºçš„ç±»åé”™è¯¯åœ°åŒ…å«å‰å¯¼ <code>r#</code> çš„é—®é¢˜ã€‚<a href="https://github.com/PyO3/pyo3/pull/2395">#2395</a></li>
<li>ä¿®æ­£ FFI å®šä¹‰ <code>Py_tracefunc</code> ä¸º <code>unsafe extern "C" fn</code>ï¼ˆä¹‹å‰æ˜¯å®‰å…¨çš„ï¼‰ã€‚<a href="https://github.com/PyO3/pyo3/pull/2407">#2407</a></li>
<li>ä¿®å¤åœ¨ <code>#[derive(FromPyObject)]</code> ç»“æ„ä½“å­—æ®µä¸Šä½¿ç”¨ <code>#[pyo3(from_py_with = "...")]</code> æ³¨è§£æ—¶çš„ç¼–è¯‘å¤±è´¥é—®é¢˜ã€‚<a href="https://github.com/PyO3/pyo3/pull/2414">#2414</a></li>
<li>ä¿®å¤ FFI å®šä¹‰ <code>_PyDateTime_BaseTime</code> å’Œ <code>_PyDateTime_BaseDateTime</code> åç§°ç¼ºå°‘å‰å¯¼ä¸‹åˆ’çº¿çš„é—®é¢˜ã€‚<a href="https://github.com/PyO3/pyo3/pull/2421">#2421</a></li>
<li>åœ¨ Python 3.10 åŠä»¥ä¸Šç‰ˆæœ¬ä¸­ç§»é™¤ FFI å®šä¹‰ <code>PyArena</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/2421">#2421</a></li>
<li>ä¿®å¤ FFI å®šä¹‰ <code>PyCompilerFlags</code> åœ¨ Python 3.8 åŠä»¥ä¸Šç‰ˆæœ¬ä¸­ç¼ºå°‘æˆå‘˜ <code>cf_feature_version</code> çš„é—®é¢˜ã€‚<a href="https://github.com/PyO3/pyo3/pull/2423">#2423</a></li>
<li>ä¿®å¤ FFI å®šä¹‰ <code>PyAsyncMethods</code> åœ¨ Python 3.10 åŠä»¥ä¸Šç‰ˆæœ¬ä¸­ç¼ºå°‘æˆå‘˜ <code>am_send</code> çš„é—®é¢˜ã€‚<a href="https://github.com/PyO3/pyo3/pull/2423">#2423</a></li>
<li>ä¿®å¤ FFI å®šä¹‰ <code>PyGenObject</code> åœ¨ä¸åŒ Python ç‰ˆæœ¬ä¸­å¤šä¸ªæˆå‘˜ä¸æ­£ç¡®çš„é—®é¢˜ã€‚<a href="https://github.com/PyO3/pyo3/pull/2423">#2423</a></li>
<li>ä¿®å¤ FFI å®šä¹‰ <code>PySyntaxErrorObject</code> åœ¨ Python 3.10 åŠä»¥ä¸Šç‰ˆæœ¬ä¸­ç¼ºå°‘æˆå‘˜ <code>end_lineno</code> å’Œ <code>end_offset</code> çš„é—®é¢˜ã€‚<a href="https://github.com/PyO3/pyo3/pull/2423">#2423</a></li>
<li>ä¿®å¤ FFI å®šä¹‰ <code>PyHeapTypeObject</code> åœ¨ Python 3.9 åŠä»¥ä¸Šç‰ˆæœ¬ä¸­ç¼ºå°‘æˆå‘˜ <code>ht_module</code> çš„é—®é¢˜ã€‚<a href="https://github.com/PyO3/pyo3/pull/2423">#2423</a></li>
<li>ä¿®å¤ FFI å®šä¹‰ <code>PyFrameObject</code> åœ¨ä¸åŒ Python ç‰ˆæœ¬ä¸­å¤šä¸ªæˆå‘˜ä¸æ­£ç¡®çš„é—®é¢˜ã€‚<a href="https://github.com/PyO3/pyo3/pull/2424">#2424</a> <a href="https://github.com/PyO3/pyo3/pull/2434">#2434</a></li>
<li>ä¿®å¤ FFI å®šä¹‰ <code>PyTypeObject</code> åœ¨ Python 3.8 ä¸­ç¼ºå°‘å·²å¼ƒç”¨å­—æ®µ <code>tp_print</code> çš„é—®é¢˜ã€‚<a href="https://github.com/PyO3/pyo3/pull/2428">#2428</a></li>
<li>ä¿®å¤ PyPy ä¸Šçš„ FFI å®šä¹‰ <code>PyDateTime_CAPI</code>ã€<code>PyDateTime_Date</code>ã€<code>PyASCIIObject</code>ã€<code>PyBaseExceptionObject</code>ã€<code>PyListObject</code> å’Œ <code>PyTypeObject</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/2428">#2428</a></li>
<li>ä¿®å¤ FFI å®šä¹‰ <code>_inittab</code> çš„å­—æ®µ <code>initfun</code> çš„æ‹¼å†™é”™è¯¯ï¼ˆåº”ä¸º <code>initfunc</code>ï¼‰ã€‚<a href="https://github.com/PyO3/pyo3/pull/2431">#2431</a></li>
<li>ä¿®å¤ FFI å®šä¹‰ <code>_PyDateTime_BaseTime</code> å’Œ <code>_PyDateTime_BaseDateTime</code> é”™è¯¯åŒ…å« <code>fold</code> æˆå‘˜çš„é—®é¢˜ã€‚<a href="https://github.com/PyO3/pyo3/pull/2432">#2432</a></li>
<li>ä¿®å¤ PyPy 3.9 ä¸Šçš„ FFI å®šä¹‰ <code>PyTypeObject</code>ã€<code>PyHeapTypeObject</code> å’Œ <code>PyCFunctionObject</code> ä¸­æˆå‘˜ä¸æ­£ç¡®çš„é—®é¢˜ã€‚<a href="https://github.com/PyO3/pyo3/pull/2433">#2433</a></li>
<li>ä¿®æ­£ FFI å®šä¹‰ <code>PyGetSetDef</code> çš„ <code>doc</code> æˆå‘˜ä¸º <code>*const c_char</code>ï¼ˆè€Œé <code>*mut c_char</code>ï¼‰ã€‚<a href="https://github.com/PyO3/pyo3/pull/2439">#2439</a></li>
<li>ä¿®å¤å¯¹å•å…ƒç´ å…ƒç»„ç»“æ„ä½“å’Œé€æ˜ç»“æ„ä½“å¿½ç•¥ <code>#[pyo3(from_py_with = "...")]</code> çš„é—®é¢˜ã€‚<a href="https://github.com/PyO3/pyo3/pull/2440">#2440</a></li>
<li>ä½¿ç”¨ <code>memoffset</code> è®¡ç®— <code>PyCell</code> å¸ƒå±€ä»¥é¿å…æœªå®šä¹‰è¡Œä¸ºï¼ˆUBï¼‰ã€‚<a href="https://github.com/PyO3/pyo3/pull/2450">#2450</a></li>
<li>ä¿®å¤ <code>#[pyclass(name = "...")]</code> é‡å‘½åçš„æšä¸¾ç”Ÿæˆçš„ <code>repr</code> è¿”å›é”™è¯¯çš„æšä¸¾åç§°çš„é—®é¢˜ã€‚<a href="https://github.com/PyO3/pyo3/pull/2457">#2457</a></li>
<li>ä¿®å¤åœ¨ Python 3.9 ä¸Šæ„å»º abi3 æ—¶é”™è¯¯åœ°å¯ç”¨ <code>PyObject_CallNoArgs</code> çš„é—®é¢˜ã€‚<a href="https://github.com/PyO3/pyo3/pull/2476">#2476</a></li>
<li>ä¿®å¤ <code>#[pyfunction]</code> å‚æ•°ç”Ÿæˆçš„å¤šä¸ª clippy è­¦å‘Šã€‚<a href="https://github.com/PyO3/pyo3/pull/2503">#2503</a></li>
</ul>
<h2 id="0166---2022-08-23"><a class="header" href="#0166---2022-08-23">[0.16.6] - 2022-08-23</a></h2>
<h3 id="æ›´æ”¹-11"><a class="header" href="#æ›´æ”¹-11">æ›´æ”¹</a></h3>
<ul>
<li>ä½¿ç”¨éƒ¨åˆ†å˜é€šæ–¹æ³•ä¿®å¤ <code>PyCapsule</code> ç±»å‹çš„å®‰å…¨æ€§é—®é¢˜ã€‚å»ºè®®ç”¨æˆ·å°½å¿«å‡çº§åˆ° PyO3 0.17ï¼Œè¯¥ç‰ˆæœ¬é€šè¿‡ç ´åæ€§å˜æ›´æä¾›äº†é•¿æœŸè§£å†³æ–¹æ¡ˆã€‚<a href="https://github.com/PyO3/pyo3/pull/2522">#2522</a>
<ul>
<li><code>PyCapsule::new</code> å’Œ <code>PyCapsule::new_with_destructor</code> ç°åœ¨ä¼šå¤åˆ¶å¹¶æ‹¥æœ‰ <code>name</code> çš„æ‰€æœ‰æƒï¼Œä»¥è§£å†³å¯èƒ½çš„æ‚¬å‚æŒ‡é’ˆé—®é¢˜ã€‚</li>
<li>è‹¥èƒ¶å›Šæ— åç§°ï¼Œ<code>PyCapsule::name</code> ç°åœ¨è¿”å›ç©º <code>CStr</code>ï¼Œè€Œä¸å†è§£å¼•ç”¨ç©ºæŒ‡é’ˆã€‚</li>
<li>è‹¥èƒ¶å›Šåœ¨å…¶åˆ›å»ºçº¿ç¨‹ä»¥å¤–çš„å…¶ä»–çº¿ç¨‹ä¸­è¢«åˆ é™¤ï¼Œåˆ™ <code>PyCapsule::new_with_destructor</code> ä¸­çš„ææ„å‡½æ•° <code>F</code> æ°¸è¿œä¸ä¼šè¢«è°ƒç”¨ï¼ˆå°†å‘å‡ºè­¦å‘Šï¼‰ã€‚</li>
</ul>
</li>
<li>å½“ PyO3 æ•è·çš„ panic payload åœ¨ drop æœŸé—´å‘ç”Ÿ panic æ—¶ï¼Œç°åœ¨å°†ä¸­æ­¢ç¨‹åºã€‚<a href="https://github.com/PyO3/pyo3/pull/2544">#2544</a></li>
</ul>
<h2 id="0165---2022-05-15"><a class="header" href="#0165---2022-05-15">[0.16.5] - 2022-05-15</a></h2>
<h3 id="æ–°å¢-26"><a class="header" href="#æ–°å¢-26">æ–°å¢</a></h3>
<ul>
<li>æ·»åŠ å®éªŒæ€§ <code>generate-import-lib</code> åŠŸèƒ½ï¼Œæ”¯æŒä¸º Windows ç›®æ ‡è‡ªåŠ¨ç”Ÿâ€‹â€‹æˆé abi3 çš„ Python å¯¼å…¥åº“ã€‚<a href="https://github.com/PyO3/pyo3/pull/2364">#2364</a></li>
<li>æ·»åŠ  FFI å®šä¹‰ <code>Py_ExitStatusException</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/2374">#2374</a></li>
</ul>
<h3 id="æ›´æ”¹-12"><a class="header" href="#æ›´æ”¹-12">æ›´æ”¹</a></h3>
<ul>
<li>å°†å®éªŒæ€§ <code>generate-abi3-import-lib</code> åŠŸèƒ½æ ‡è®°ä¸ºå¼ƒç”¨ï¼Œæ¨èä½¿ç”¨æ–°çš„ <code>generate-import-lib</code> åŠŸèƒ½ã€‚<a href="https://github.com/PyO3/pyo3/pull/2364">#2364</a></li>
</ul>
<h3 id="å·²ä¿®å¤-15"><a class="header" href="#å·²ä¿®å¤-15">å·²ä¿®å¤</a></h3>
<ul>
<li>ä¸º 3.10+ ç‰ˆæœ¬çš„ <code>PyConfig</code> æ·»åŠ ç¼ºå¤±çš„ <code>warn_default_encoding</code> å­—æ®µã€‚æ­¤å‰ç¼ºå¤±è¯¥å­—æ®µå¯èƒ½å¯¼è‡´ä¸æ­£ç¡®çš„è¡Œä¸ºæˆ–å´©æºƒã€‚<a href="https://github.com/PyO3/pyo3/pull/2370">#2370</a></li>
<li>ä¿®å¤ 3.10+ ç‰ˆæœ¬ä¸­ <code>PyConfig</code> çš„ <code>pathconfig_warnings</code> å’Œ <code>program_name</code> å­—æ®µé¡ºåºé”™è¯¯çš„é—®é¢˜ã€‚æ­¤å‰å­—æ®µé¡ºåºé¢ å€’ï¼Œå¯èƒ½å¼•å‘ä¸æ­£ç¡®çš„è¡Œä¸ºæˆ–å´©æºƒã€‚<a href="https://github.com/PyO3/pyo3/pull/2370">#2370</a></li>
</ul>
<h2 id="0164---2022-04-14"><a class="header" href="#0164---2022-04-14">[0.16.4] - 2022-04-14</a></h2>
<h3 id="æ–°å¢-27"><a class="header" href="#æ–°å¢-27">æ–°å¢</a></h3>
<ul>
<li>æ·»åŠ  <code>PyTzInfoAccess</code> traitï¼Œç”¨äºå®‰å…¨è®¿é—®æ—¶åŒºä¿¡æ¯ã€‚<a href="https://github.com/PyO3/pyo3/pull/2263">#2263</a></li>
<li>æ·»åŠ å®éªŒæ€§ <code>generate-abi3-import-lib</code> åŠŸèƒ½ï¼Œç”¨äºä¸º Windows è‡ªåŠ¨ç”Ÿâ€‹â€‹æˆ <code>python3.dll</code> å¯¼å…¥åº“ã€‚<a href="https://github.com/PyO3/pyo3/pull/2282">#2282</a></li>
<li>æ·»åŠ  <code>PyDateTime_BaseTime</code> å’Œ <code>PyDateTime_BaseDateTime</code> çš„ FFI å®šä¹‰ã€‚<a href="https://github.com/PyO3/pyo3/pull/2294">#2294</a></li>
</ul>
<h3 id="æ›´æ”¹-13"><a class="header" href="#æ›´æ”¹-13">æ›´æ”¹</a></h3>
<ul>
<li>æå‡è°ƒç”¨ <code>FromPyObject::extract</code> å¤±è´¥æ—¶çš„æ€§èƒ½ï¼Œæ­¤ç±»æƒ…å†µåœ¨å‡½æ•°æ¥å—å¤šç§ä¸åŒç±»å‹æ—¶å¾ˆå¸¸è§ã€‚<a href="https://github.com/PyO3/pyo3/pull/2279">#2279</a></li>
<li>åœ¨ Unix ä¸Šä¸º CPython 3.7 é€‰æ‹© <code>libpython</code> é“¾æ¥åæ—¶é»˜è®¤ä½¿ç”¨ â€œmâ€ ABI æ ‡ç­¾ã€‚<a href="https://github.com/PyO3/pyo3/pull/2288">#2288</a></li>
<li>å…è®¸åœ¨æ²¡æœ‰å¯ç”¨æ„å»ºä¸»æœº Python è§£é‡Šå™¨çš„æƒ…å†µä¸‹ç¼–è¯‘ â€œabi3â€ æ‰©å±•ã€‚<a href="https://github.com/PyO3/pyo3/pull/2293">#2293</a></li>
</ul>
<h3 id="å·²ä¿®å¤-16"><a class="header" href="#å·²ä¿®å¤-16">å·²ä¿®å¤</a></h3>
<ul>
<li>ä¾èµ– PyO3 çš„ crate ç°å¯åœ¨ç¨³å®šç‰ˆ Rust ä¸‹é€šè¿‡ LLVM æ’æ¡©æ”¶é›†ä»£ç è¦†ç›–ç‡ã€‚<a href="https://github.com/PyO3/pyo3/pull/2286">#2286</a></li>
<li>ä¿®å¤åœ¨æ²¡æœ‰ <code>tzinfo</code> çš„ <code>datetime</code> æˆ– <code>time</code> ä¸Šè°ƒç”¨ FFI æ–¹æ³• <code>PyDateTime_DATE_GET_TZINFO</code> æˆ– <code>PyDateTime_TIME_GET_TZINFO</code> æ—¶çš„æ®µé”™è¯¯ã€‚<a href="https://github.com/PyO3/pyo3/pull/2289">#2289</a></li>
<li>ä¿®å¤å› ç›®å½•åä»¥å­—æ¯ <code>n</code> å¼€å¤´å¯¼è‡´ä» PyO3 0.16.3 å¼€å§‹åœ¨ Windows ä¸Šåºåˆ—åŒ–è§£æå™¨é…ç½®å¤±è´¥çš„é—®é¢˜ã€‚<a href="https://github.com/PyO3/pyo3/pull/2299">#2299</a></li>
</ul>
<h2 id="0163---2022-04-05"><a class="header" href="#0163---2022-04-05">[0.16.3] - 2022-04-05</a></h2>
<h3 id="æ‰“åŒ…-20"><a class="header" href="#æ‰“åŒ…-20">æ‰“åŒ…</a></h3>
<ul>
<li>æ‰©å±• <code>parking_lot</code> ä¾èµ–çš„ç‰ˆæœ¬æ”¯æŒï¼ŒåŒ…æ‹¬ 0.12 ç‰ˆæœ¬ã€‚<a href="https://github.com/PyO3/pyo3/pull/2239">#2239</a></li>
</ul>
<h3 id="æ–°å¢-28"><a class="header" href="#æ–°å¢-28">æ–°å¢</a></h3>
<ul>
<li>ä¸º <code>pyo3_build_config::InterpreterConfig</code> æ·»åŠ æ–¹æ³•ï¼Œä»¥ä½¿ç”¨é…ç½®çš„å¯æ‰§è¡Œæ–‡ä»¶è¿è¡Œ Python è„šæœ¬ã€‚<a href="https://github.com/PyO3/pyo3/pull/2092">#2092</a></li>
<li>ä¸º <code>Py&lt;PyBytes&gt;</code> æ·»åŠ  <code>as_bytes</code> æ–¹æ³•ã€‚<a href="https://github.com/PyO3/pyo3/pull/2235">#2235</a>- ä¸º <code>PyType_FromModuleAndSpec</code>ã€<code>PyType_GetModule</code>ã€<code>PyType_GetModuleState</code> å’Œ <code>PyModule_AddType</code> æ·»åŠ  FFI å®šä¹‰ã€‚<a href="https://github.com/PyO3/pyo3/pull/2250">#2250</a></li>
<li>æ·»åŠ  <code>pyo3_build_config::cross_compiling_from_to</code>ï¼Œä½œä¸ºæ£€æµ‹ PyO3 æ˜¯å¦å¤„äºäº¤å‰ç¼–è¯‘çŠ¶æ€çš„è¾…åŠ©å·¥å…·ã€‚<a href="https://github.com/PyO3/pyo3/pull/2253">#2253</a></li>
<li>æ·»åŠ  <code>#[pyclass(mapping)]</code> é€‰é¡¹ï¼Œä»¥åœ¨å®¹å™¨å®ç°ä¸­ç•™ç©ºåºåˆ—æ§½ä½ã€‚<a href="https://github.com/PyO3/pyo3/pull/2265">#2265</a></li>
<li>æ·»åŠ  <code>PyString::intern</code>ï¼Œç”¨äºå¯ç”¨ Python å†…å»ºçš„å­—ç¬¦ä¸²é©»ç•™æœºåˆ¶ã€‚<a href="https://github.com/PyO3/pyo3/pull/2268">#2268</a></li>
<li>åŠ å…¥ <code>intern!</code> å®ï¼Œå¯é€šè¿‡å°†å­—ç¬¦ä¸²å­˜å‚¨åœ¨ <code>GILOnceCell</code> ä¸­æ¥åˆ†æ‘Šåˆ›å»º Python å­—ç¬¦ä¸²çš„å¼€é”€ã€‚<a href="https://github.com/PyO3/pyo3/pull/2269">#2269</a></li>
<li>æ·»åŠ  <code>PYO3_CROSS_PYTHON_IMPLEMENTATION</code> ç¯å¢ƒå˜é‡ï¼Œç”¨äºé€‰æ‹©é»˜è®¤çš„äº¤å‰ç¼–è¯‘ Python å®ç°ã€‚<a href="https://github.com/PyO3/pyo3/pull/2272">#2272</a></li>
</ul>
<h3 id="æ›´æ”¹-14"><a class="header" href="#æ›´æ”¹-14">æ›´æ”¹</a></h3>
<ul>
<li>å…è®¸ <code>#[pyo3(crate = "...", text_signature = "...")]</code> é€‰é¡¹ç›´æ¥ç”¨äº <code>#[pyclass(crate = "...", text_signature = "...")]</code> ä¸­ã€‚<a href="https://github.com/PyO3/pyo3/pull/2234">#2234</a></li>
<li>åœ¨äº¤å‰ç¼–è¯‘æ—¶ä½¿ <code>PYO3_CROSS_LIB_DIR</code> ç¯å¢ƒå˜é‡å˜ä¸ºå¯é€‰ã€‚<a href="https://github.com/PyO3/pyo3/pull/2241">#2241</a></li>
<li>å°† <code>METH_FASTCALL</code> è°ƒç”¨çº¦å®šåœ¨ Python 3.10 ä¸­æ ‡è®°ä¸ºå—é™ APIã€‚<a href="https://github.com/PyO3/pyo3/pull/2250">#2250</a></li>
<li>å°† <code>pyo3_build_config::cross_compiling</code> æ ‡è®°ä¸ºåºŸå¼ƒï¼Œæ¨èä½¿ç”¨ <code>pyo3_build_config::cross_compiling_from_to</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/2253">#2253</a></li>
</ul>
<h3 id="ä¿®å¤-23"><a class="header" href="#ä¿®å¤-23">ä¿®å¤</a></h3>
<ul>
<li>ä¿®å¤ <code>abi3-py310</code> åŠŸèƒ½ï¼šå½“å¯ç”¨æ—¶ä½¿ç”¨ Python 3.10 ABIï¼Œè€Œä¸æ˜¯é™é»˜é™çº§åˆ° 3.9 ABIã€‚<a href="https://github.com/PyO3/pyo3/pull/2242">#2242</a></li>
<li>åœ¨ä¸º macOS äº¤å‰ç¼–è¯‘å¹¶é“¾æ¥ <a href="https://developer.apple.com/library/archive/documentation/MacOSX/Conceptual/BPFrameworks/Concepts/FrameworkAnatomy.html">Framework bundle</a> æ—¶ä½¿ç”¨å…±äº«é“¾æ¥æ¨¡å¼ã€‚<a href="https://github.com/PyO3/pyo3/pull/2233">#2233</a></li>
<li>ä¿®å¤å½“ <code>PYO3_CROSS_LIB_DIR</code> åœ¨æŸäº›ä¸»æœº/ç›®æ ‡ç»„åˆä¸‹è®¾ç½®æ—¶ç¼–è¯‘æœŸé—´çš„ panic é—®é¢˜ã€‚<a href="https://github.com/PyO3/pyo3/pull/2232">#2232</a></li>
<li>ä¿®æ­£ <code>syn</code> ä¾èµ–ç‰ˆæœ¬ï¼Œè¦æ±‚æœ€å°è¡¥ä¸ç‰ˆæœ¬ä¸º 1.0.56ã€‚<a href="https://github.com/PyO3/pyo3/pull/2240">#2240</a></li>
</ul>
<h2 id="0162---2022-03-15"><a class="header" href="#0162---2022-03-15">[0.16.2] - 2022-03-15</a></h2>
<h3 id="æ‰“åŒ…-21"><a class="header" href="#æ‰“åŒ…-21">æ‰“åŒ…</a></h3>
<ul>
<li>å½“åœ¨ PyPy 3.7 ä¸”ç‰ˆæœ¬æ—§äº PyPy 7.3.8 çš„ç¯å¢ƒä¸­å¯¼å…¥æ¨¡å—æ—¶å‘å‡ºè­¦å‘Šï¼Œå› ä¸ºå·²çŸ¥å­˜åœ¨äºŒè¿›åˆ¶å…¼å®¹æ€§é—®é¢˜ã€‚<a href="https://github.com/PyO3/pyo3/pull/2217">#2217</a></li>
<li>ç¡®ä¿ <code>pyo3-ffi</code> çš„æ„å»ºè„šæœ¬åœ¨ <code>pyo3</code> ä¹‹å‰è¿è¡Œï¼Œä»¥ä¿®å¤äº¤å‰ç¼–è¯‘é—®é¢˜ã€‚<a href="https://github.com/PyO3/pyo3/pull/2224">#2224</a></li>
</ul>
<h2 id="0161---2022-03-05"><a class="header" href="#0161---2022-03-05">[0.16.1] - 2022-03-05</a></h2>
<h3 id="æ‰“åŒ…-22"><a class="header" href="#æ‰“åŒ…-22">æ‰“åŒ…</a></h3>
<ul>
<li>æ‰©å±• <code>hashbrown</code> å¯é€‰ä¾èµ–çš„æ”¯æŒç‰ˆæœ¬ä»¥åŒ…å« 0.12ã€‚<a href="https://github.com/PyO3/pyo3/pull/2197">#2197</a></li>
</ul>
<h3 id="ä¿®å¤-24"><a class="header" href="#ä¿®å¤-24">ä¿®å¤</a></h3>
<ul>
<li>ä¿®å¤ <code>pyo3-build-config</code> ä¸­ Windows å¹³å°æ£€æµ‹ä¸æ­£ç¡®çš„é—®é¢˜ã€‚<a href="https://github.com/PyO3/pyo3/pull/2198">#2198</a></li>
<li>ä¿®å¤ 0.16 ç‰ˆæœ¬åæ— æ³•äº¤å‰ç¼–è¯‘åˆ° aarch64 macOS çš„å›å½’é—®é¢˜ã€‚<a href="https://github.com/PyO3/pyo3/pull/2201">#2201</a></li>
</ul>
<h2 id="0160---2022-02-27"><a class="header" href="#0160---2022-02-27">[0.16.0] - 2022-02-27</a></h2>
<h3 id="æ‰“åŒ…-23"><a class="header" href="#æ‰“åŒ…-23">æ‰“åŒ…</a></h3>
<ul>
<li>å°†æœ€ä½æ”¯æŒ Rust ç‰ˆæœ¬ï¼ˆMSRVï¼‰æ›´æ–°ä¸º 1.48ã€‚<a href="https://github.com/PyO3/pyo3/pull/2004">#2004</a></li>
<li>å°†å¯é€‰ä¾èµ– <code>indoc</code> æ›´æ–°è‡³ 1.0ã€‚<a href="https://github.com/PyO3/pyo3/pull/2004">#2004</a></li>
<li>åœæ­¢æ”¯æŒ Python 3.6ï¼Œç§»é™¤ <code>abi3-py36</code> åŠŸèƒ½ã€‚<a href="https://github.com/PyO3/pyo3/pull/2006">#2006</a></li>
<li><code>pyo3-build-config</code> ä¸å†é»˜è®¤å¯ç”¨ <code>resolve-config</code> åŠŸèƒ½ã€‚<a href="https://github.com/PyO3/pyo3/pull/2008">#2008</a></li>
<li>å°†å¯é€‰ä¾èµ– <code>inventory</code> æ›´æ–°è‡³ 0.2ã€‚<a href="https://github.com/PyO3/pyo3/pull/2019">#2019</a></li>
<li>ç§»é™¤ <code>paste</code> ä¾èµ–ã€‚<a href="https://github.com/PyO3/pyo3/pull/2081">#2081</a></li>
<li><code>pyo3::ffi</code> ä¸­çš„ç»‘å®šç°åœ¨æ˜¯ç‹¬ç«‹çš„ <code>pyo3-ffi</code> crate çš„é‡æ–°å¯¼å‡ºã€‚<a href="https://github.com/PyO3/pyo3/pull/2126">#2126</a></li>
<li>æ”¯æŒ PyPy 3.9ã€‚<a href="https://github.com/PyO3/pyo3/pull/2143">#2143</a></li>
</ul>
<h3 id="æ–°å¢-29"><a class="header" href="#æ–°å¢-29">æ–°å¢</a></h3>
<ul>
<li>æ·»åŠ  <code>PyCapsule</code> ç±»å‹ï¼Œæš´éœ² <a href="https://docs.python.org/3/c-api/capsule.html#capsules">Capsule API</a>ã€‚<a href="https://github.com/PyO3/pyo3/pull/1980">#1980</a></li>
<li>æ·»åŠ  <code>pyo3_build_config::Sysconfigdata</code> åŠç›¸å…³æ”¯æŒ APIã€‚<a href="https://github.com/PyO3/pyo3/pull/1996">#1996</a></li>
<li>æ·»åŠ  <code>Py::setattr</code> æ–¹æ³•ã€‚<a href="https://github.com/PyO3/pyo3/pull/2009">#2009</a></li>
<li>åœ¨æ‰€æœ‰å±æ€§å®ä¸­æ·»åŠ  <code>#[pyo3(crate = "some::path")]</code> é€‰é¡¹ï¼ˆé™¤å·²åºŸå¼ƒçš„ <code>#[pyproto]</code> å¤–ï¼‰ã€‚<a href="https://github.com/PyO3/pyo3/pull/2022">#2022</a></li>
<li>å…è®¸ <code>create_exception!</code> å®æ¥å—å¯é€‰çš„æ–‡æ¡£å­—ç¬¦ä¸²ã€‚<a href="https://github.com/PyO3/pyo3/pull/2027">#2027</a></li>
<li>æ”¯æŒå¯¹æ— å­—æ®µï¼ˆå³ C é£æ ¼ï¼‰æšä¸¾ä½¿ç”¨ <code>#[pyclass]</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/2034">#2034</a></li>
<li>åœ¨ <code>#[pymethods]</code> ä¸­æ·»åŠ ç¼“å†²åŒºé­”æœ¯æ–¹æ³• <code>__getbuffer__</code> å’Œ <code>__releasebuffer__</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/2067">#2067</a></li>
<li>åœ¨ <code>wrap_pyfunction</code> å’Œ <code>wrap_pymodule</code> ä¸­æ·»åŠ å¯¹è·¯å¾„çš„æ”¯æŒã€‚<a href="https://github.com/PyO3/pyo3/pull/2081">#2081</a></li>
<li>å…è®¸ <code>wrap_pyfunction!</code> åŒ…è£…åœ¨ä¸åŒ Rust æ¨¡å—æˆ– crate ä¸­å®ç°çš„ <code>#[pyfunction]</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/2091">#2091</a></li>
<li>æ·»åŠ  <code>PyAny::contains</code> æ–¹æ³•ï¼ˆå¯¹åº” <code>PyAny</code> çš„ <code>in</code> æ“ä½œç¬¦ï¼‰ã€‚<a href="https://github.com/PyO3/pyo3/pull/2115">#2115</a></li>
<li>æ·»åŠ  <code>PyMapping::contains</code> æ–¹æ³•ï¼ˆå¯¹åº” <code>PyMapping</code> çš„ <code>in</code> æ“ä½œç¬¦ï¼‰ã€‚<a href="https://github.com/PyO3/pyo3/pull/2133">#2133</a></li>
<li>åœ¨ <code>#[pymethods]</code> ä¸­æ·»åŠ åƒåœ¾å›æ”¶é­”æœ¯æ–¹æ³• <code>__traverse__</code> å’Œ <code>__clear__</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/2159">#2159</a></li>
<li>æ·»åŠ å¯¹ç»“æ„ä½“å…ƒç»„å’Œæšä¸¾çš„ <code>from_py_with</code> æ”¯æŒï¼Œä»¥è¦†ç›–é»˜è®¤çš„ä» Python è½¬æ¢é€»è¾‘ã€‚<a href="https://github.com/PyO3/pyo3/pull/2181">#2181</a></li>
<li>ä¸º <code>PyAny</code> æ·»åŠ  <code>eq</code>ã€<code>ne</code>ã€<code>lt</code>ã€<code>le</code>ã€<code>gt</code>ã€<code>ge</code> æ–¹æ³•ï¼Œä»¥åŒ…è£… <code>rich_compare</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/2175">#2175</a></li>
<li>æ·»åŠ  <code>Py::is</code> å’Œ <code>PyAny::is</code> æ–¹æ³•ç”¨äºæ£€æŸ¥å¯¹è±¡èº«ä»½ã€‚<a href="https://github.com/PyO3/pyo3/pull/2183">#2183</a></li>
<li>æ·»åŠ å¯¹ <code>__getattribute__</code> é­”æœ¯æ–¹æ³•çš„æ”¯æŒã€‚<a href="https://github.com/PyO3/pyo3/pull/2187">#2187</a></li>
</ul>
<h3 id="æ›´æ”¹-15"><a class="header" href="#æ›´æ”¹-15">æ›´æ”¹</a></h3>
<ul>
<li><code>PyType::is_subclass</code>ã€<code>PyErr::is_instance</code> å’Œ <code>PyAny::is_instance</code> ç°åœ¨åœ¨è¿è¡Œæ—¶æ“ä½œç±»å‹å¯¹è±¡ï¼Œè€Œä¸æ˜¯ç¼–è¯‘æ—¶å·²çŸ¥çš„ç±»å‹ã€‚æ—§è¡Œä¸ºä»å¯é€šè¿‡ <code>PyType::is_subclass_of</code>ã€<code>PyErr::is_instance_of</code> å’Œ <code>PyAny::is_instance_of</code> ä½¿ç”¨ã€‚<a href="https://github.com/PyO3/pyo3/pull/1985">#1985</a></li>
<li>é‡å‘½å <code>PyErr</code> ä¸Šçš„ä¸€äº›æ–¹æ³•ï¼ˆæ—§åç§°ç›®å‰ä»…æ ‡è®°ä¸ºåºŸå¼ƒï¼‰ï¼š<a href="https://github.com/PyO3/pyo3/pull/2026">#2026</a>
<ul>
<li><code>pytype</code> -&gt; <code>get_type</code></li>
<li><code>pvalue</code> -&gt; <code>value</code>ï¼ˆå¹¶åºŸå¼ƒç­‰æ•ˆçš„ <code>instance</code>ï¼‰</li>
<li><code>ptraceback</code> -&gt; <code>traceback</code></li>
<li><code>from_instance</code> -&gt; <code>from_value</code></li>
<li><code>into_instance</code> -&gt; <code>into_value</code></li>
</ul>
</li>
<li><code>PyErr::new_type</code> ç°åœ¨æ¥å—å¯é€‰çš„æ–‡æ¡£å­—ç¬¦ä¸²ï¼Œå¹¶è¿”å› <code>PyResult&lt;Py&lt;PyType&gt;&gt;</code> è€Œä¸æ˜¯ä¸€ä¸ª <code>ffi::PyTypeObject</code> æŒ‡é’ˆã€‚<a href="https://github.com/PyO3/pyo3/pull/2027">#2027</a></li>
<li>å°† <code>PyType::is_instance</code> æ ‡è®°ä¸ºåºŸå¼ƒï¼›å®ƒä¸å…¶ä»– PyO3 ä¸­çš„ <code>is_instance</code> æ–¹æ³•ä¸ä¸€è‡´ã€‚åº”ä½¿ç”¨ <code>obj.is_instance(typ)</code> ä»£æ›¿ <code>typ.is_instance(obj)</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/2031">#2031</a></li>
<li><code>#[pymethods]</code> ä¸­çš„ <code>__getitem__</code>ã€<code>__setitem__</code> å’Œ <code>__delitem__</code> ç°åœ¨é»˜è®¤åŒæ—¶å®ç° Python æ˜ å°„å’Œåºåˆ—ã€‚<a href="https://github.com/PyO3/pyo3/pull/2065">#2065</a></li>
<li>æå‡ <code>#[derive(FromPyObject)]</code> æšä¸¾çš„æ€§èƒ½å’Œé”™è¯¯æ¶ˆæ¯ã€‚<a href="https://github.com/PyO3/pyo3/pull/2068">#2068</a></li>
<li>å‡å°‘ä»¥ä¸‹å†…å®¹ç”Ÿæˆçš„ LLVM ä»£ç å¤§å°ï¼ˆä»¥æé«˜ç¼–è¯‘é€Ÿåº¦ï¼‰ï¼š
<ul>
<li>å†…éƒ¨ <code>handle_panic</code> è¾…åŠ©å‡½æ•° <a href="https://github.com/PyO3/pyo3/pull/2074">#2074</a> <a href="https://github.com/PyO3/pyo3/pull/2158">#2158</a></li>
<li><code>#[pyfunction]</code> å’Œ <code>#[pymethods]</code> çš„å‚æ•°æå– <a href="https://github.com/PyO3/pyo3/pull/2075">#2075</a> <a href="https://github.com/PyO3/pyo3/pull/2085">#2085</a></li>
<li><code>#[pyclass]</code> ç±»å‹å¯¹è±¡çš„åˆ›å»º <a href="https://github.com/PyO3/pyo3/pull/2076">#2076</a> <a href="https://github.com/PyO3/pyo3/pull/2081">#2081</a> <a href="https://github.com/PyO3/pyo3/pull/2157">#2157</a></li>
</ul>
</li>
<li>å°Šé‡è¢« <code>wrap_pyfunction</code> å’Œ <code>wrap_pymodule</code> åŒ…è£¹é¡¹çš„ Rust ç§æœ‰æ€§è§„åˆ™ã€‚<a href="https://github.com/PyO3/pyo3/pull/2081">#2081</a></li>
<li>ä¸º <code>__ipow__</code> é­”æœ¯æ–¹æ³•æ·»åŠ æ¨¡æ•°å‚æ•°ã€‚<a href="https://github.com/PyO3/pyo3/pull/2083">#2083</a></li>
<li>ä¿®å¤ <code>_PyCFunctionFast</code> çš„ FFI å®šä¹‰ã€‚<a href="https://github.com/PyO3/pyo3/pull/2126">#2126</a></li>
<li><code>PyDateTimeAPI</code> å’Œ <code>PyDateTime_TimeZone_UTC</code> ç°åœ¨æ˜¯ä¸å®‰å…¨å‡½æ•°è€Œéé™æ€å˜é‡ã€‚<a href="https://github.com/PyO3/pyo3/pull/2126">#2126</a></li>
<li><code>PyDateTimeAPI</code> ä¸å†éšå¼è°ƒç”¨ <code>PyDateTime_IMPORT</code>ï¼Œä»¥æ›´è´´è¿‘åŸå§‹ Python APIã€‚åœ¨é¦–æ¬¡è°ƒç”¨ <code>PyDateTime_IMPORT</code> å‰è¿”å›ç©ºæŒ‡é’ˆã€‚å› æ­¤åœ¨è°ƒç”¨ä»¥ä¸‹ä»»ä¸€ FFI å‡½æ•°å‰å¿…é¡»å…ˆè°ƒç”¨ <code>PyDateTime_IMPORT</code>ï¼Œä»¥é¿å…æœªå®šä¹‰è¡Œä¸ºï¼š<a href="https://github.com/PyO3/pyo3/pull/2126">#2126</a>
<ul>
<li><code>PyDateTime_TimeZone_UTC</code></li>
<li><code>PyDate_Check</code></li>
<li><code>PyDate_CheckExact</code></li>
<li><code>PyDateTime_Check</code></li>
<li><code>PyDateTime_CheckExact</code></li>
<li><code>PyTime_Check</code></li>
<li><code>PyTime_CheckExact</code></li>
<li><code>PyDelta_Check</code></li>
<li><code>PyDelta_CheckExact</code></li>
<li><code>PyTZInfo_Check</code></li>
<li><code>PyTZInfo_CheckExact</code></li>
<li><code>PyDateTime_FromTimestamp</code></li>
<li><code>PyDate_FromTimestamp</code></li>
</ul>
</li>
<li>å°† <code>pyclass</code> çš„ <code>gc</code> é€‰é¡¹ï¼ˆå¦‚ <code>#[pyclass(gc)]</code>ï¼‰æ ‡è®°ä¸ºåºŸå¼ƒã€‚ç›´æ¥å®ç° <code>__traverse__</code> <code>#[pymethod]</code> å³å¯ã€‚<a href="https://github.com/PyO3/pyo3/pull/2159">#2159</a></li>
<li><code>PyMethodDef</code> ä¸­çš„ <code>ml_meth</code> å­—æ®µç°åœ¨ç”± <code>PyMethodDefPointer</code> è”åˆä½“è¡¨ç¤ºã€‚<a href="https://github.com/PyO3/pyo3/pull/2166">2166</a></li>
<li>å°† <code>#[pyproto]</code> ç‰¹è´¨æ ‡è®°ä¸ºåºŸå¼ƒã€‚<a href="https://github.com/PyO3/pyo3/pull/2173">#2173</a></li>
</ul>
<h3 id="ç§»é™¤-6"><a class="header" href="#ç§»é™¤-6">ç§»é™¤</a></h3>
<ul>
<li>ç§»é™¤æ‰€æœ‰åœ¨ PyO3 0.14 ä¸­å·²åºŸå¼ƒçš„åŠŸèƒ½ã€‚<a href="https://github.com/PyO3/pyo3/pull/2007">#2007</a></li>
<li>ç§»é™¤ <code>PyMethodDef</code> çš„ <code>Default</code> å®ç°ã€‚<a href="https://github.com/PyO3/pyo3/pull/2166">#2166</a></li>
<li>ç§»é™¤ <code>Py</code> å’Œ <code>PyAny</code> çš„ <code>PartialEq</code> å®ç°ï¼ˆè¯·æ”¹ç”¨æ–°çš„ <code>is</code>ï¼‰ã€‚<a href="https://github.com/PyO3/pyo3/pull/2183">#2183</a></li>
</ul>
<h3 id="ä¿®å¤-25"><a class="header" href="#ä¿®å¤-25">ä¿®å¤</a></h3>
<ul>
<li>ä¿®å¤åœ¨ PyPy ä¸Š <code>PyObject_HasAttr</code> å‡ºç°çš„æœªå®šä¹‰ç¬¦å·é—®é¢˜ã€‚<a href="https://github.com/PyO3/pyo3/pull/2025">#2025</a></li>
<li>ä¿®å¤ <code>PyErr::into_value</code> ä¸­çš„å†…å­˜æ³„æ¼ã€‚<a href="https://github.com/PyO3/pyo3/pull/2026">#2026</a></li>
<li>ä¿®å¤ç”± <code>#[pyfunction]</code> å’Œ <code>#[pymethods]</code> ç”Ÿæˆä»£ç ä¸­çš„ clippy è­¦å‘Š <code>needless-option-as-deref</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/2040">#2040</a>- ä¿®å¤ <code>PySlice::indices</code> ä¸­çš„æœªå®šä¹‰è¡Œä¸ºã€‚<a href="https://github.com/PyO3/pyo3/pull/2061">#2061</a></li>
<li>ä¿®å¤ <code>wrap_pymodule!</code> å®åœ¨å¸¦æœ‰ <code>#[pyo3(name = "..")]</code> å±æ€§çš„ <code>#[pymodule]</code> ä¸Šä½¿ç”¨äº†é”™è¯¯åç§°çš„é—®é¢˜ã€‚<a href="https://github.com/PyO3/pyo3/pull/2081">#2081</a></li>
<li>ä¿®å¤ <code>#[pymethods]</code> ä¸­çš„é­”æ³•æ–¹æ³•æ¥å—å‚æ•°æ•°é‡é”™è¯¯çš„å®ç°ã€‚<a href="https://github.com/PyO3/pyo3/pull/2083">#2083</a></li>
<li>ä¿®å¤åœ¨ <code>#[pyfunction]</code> ç”Ÿæˆçš„ä»£ç ä¸­ï¼Œå½“ä¸€ä¸ªä½äº <code>Option</code> ä¹‹åçš„å¿…éœ€å‚æ•°æœªæä¾›æ—¶å¼•å‘çš„ panicã€‚<a href="https://github.com/PyO3/pyo3/pull/2093">#2093</a></li>
<li>ä¿®å¤å› ä¸æ­£ç¡®çš„ <code>ExactSizeIterator</code> å®ç°å¯¼è‡´çš„æœªå®šä¹‰è¡Œä¸ºã€‚<a href="https://github.com/PyO3/pyo3/pull/2124">#2124</a></li>
<li>ä¿®å¤åœ¨ Python 3.9 åŠä»¥ä¸Šç‰ˆæœ¬ä¸­ç¼ºå°‘ FFI å®šä¹‰ <code>PyCMethod_New</code> çš„é—®é¢˜ã€‚<a href="https://github.com/PyO3/pyo3/pull/2143">#2143</a></li>
<li>åœ¨ PyPy ä¸Šæ·»åŠ ç¼ºå¤±çš„ FFI å®šä¹‰ <code>_PyLong_NumBits</code> å’Œ <code>_PyLong_AsByteArray</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/2146">#2146</a></li>
<li>ä¿®å¤ <code>Option&lt;T&gt;</code> çš„ <code>AsPyPointer</code> å®ç°ä¸­çš„å†…å­˜æ³„æ¼ã€‚<a href="https://github.com/PyO3/pyo3/pull/2160">#2160</a></li>
<li>å°† <code>_PyLong_NumBits</code> çš„ FFI å®šä¹‰ä¿®æ”¹ä¸ºè¿”å› <code>size_t</code> è€Œé <code>c_int</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/2161">#2161</a></li>
<li>ä¿®å¤å‚æ•°è§£æå¤±è´¥æ—¶æŠ›å‡ºçš„ <code>TypeError</code> ç¼ºå°‘åŸå§‹é”™è¯¯åŸå› çš„é—®é¢˜ã€‚<a href="https://github.com/PyO3/pyo3/pull/2178">#2177</a></li>
</ul>
<h2 id="0152---2022-04-14"><a class="header" href="#0152---2022-04-14">[0.15.2] - 2022-04-14</a></h2>
<h3 id="æ‰“åŒ…-24"><a class="header" href="#æ‰“åŒ…-24">æ‰“åŒ…</a></h3>
<ul>
<li>ä» PyO3 0.16 å‘åç§»æ¤ PyPy 3.9 æ”¯æŒã€‚<a href="https://github.com/PyO3/pyo3/pull/2262">#2262</a></li>
</ul>
<h2 id="0151---2021-11-19"><a class="header" href="#0151---2021-11-19">[0.15.1] - 2021-11-19</a></h2>
<h3 id="æ–°å¢-30"><a class="header" href="#æ–°å¢-30">æ–°å¢</a></h3>
<ul>
<li>ä¸º <code>Py&lt;PySequence&gt;</code>ã€<code>Py&lt;PyIterator&gt;</code> å’Œ <code>Py&lt;PyMapping&gt;</code> æ·»åŠ  <code>Py::as_ref</code> å’Œ <code>Py::into_ref</code> çš„å®ç°ã€‚<a href="https://github.com/PyO3/pyo3/pull/1682">#1682</a></li>
<li>æ·»åŠ  <code>PyTraceback</code> ç±»å‹ä»¥è¡¨ç¤ºå’Œæ ¼å¼åŒ– Python çš„ tracebackã€‚<a href="https://github.com/PyO3/pyo3/pull/1977">#1977</a></li>
</ul>
<h3 id="æ›´æ”¹-16"><a class="header" href="#æ›´æ”¹-16">æ›´æ”¹</a></h3>
<ul>
<li>ä½¿ç”¨å·²çŸ¥é­”æ³•æ–¹æ³•åï¼ˆå°å†™ï¼‰çš„ <code>#[classattr]</code> å¸¸é‡ä¸å†è§¦å‘æœŸæœ›å¸¸é‡ä¸ºå¤§å†™çš„ lint è­¦å‘Šã€‚<a href="https://github.com/PyO3/pyo3/pull/1969">#1969</a></li>
</ul>
<h3 id="ä¿®å¤-26"><a class="header" href="#ä¿®å¤-26">ä¿®å¤</a></h3>
<ul>
<li>ä¿®å¤é€šè¿‡åç§°ä¸ºå·²çŸ¥é­”æ³•æ–¹æ³•çš„å‡½æ•°åˆ›å»º <code>#[classattr]</code> çš„é—®é¢˜ã€‚<a href="https://github.com/PyO3/pyo3/pull/1969">#1969</a></li>
<li>ä¿®å¤åœ¨ <code>allow_threads</code> ä¸­ä½¿ç”¨ <code>catch_unwind</code> å¯èƒ½å¯¼è‡´è‡´å‘½å´©æºƒçš„é—®é¢˜ã€‚<a href="https://github.com/PyO3/pyo3/pull/1989">#1989</a></li>
<li>ä¿®å¤åœ¨æ¿€æ´» abi3 ç‰¹æ€§æ—¶ PyPy ä¸Šæ„å»ºå¤±è´¥çš„é—®é¢˜ã€‚<a href="https://github.com/PyO3/pyo3/pull/1991">#1991</a></li>
<li>ä¿®å¤ mingw å¹³å°æ£€æµ‹é—®é¢˜ã€‚<a href="https://github.com/PyO3/pyo3/pull/1993">#1993</a></li>
<li>ä¿®å¤è®¿é—®ç±»å‹å¯¹è±¡ä¸Šçš„æè¿°ç¬¦æ—¶ <code>__get__</code> å®ç°ä¸­å‡ºç°çš„ panicã€‚<a href="https://github.com/PyO3/pyo3/pull/1997">#1997</a></li>
</ul>
<h2 id="0150---2021-11-03"><a class="header" href="#0150---2021-11-03">[0.15.0] - 2021-11-03</a></h2>
<h3 id="æ‰“åŒ…-25"><a class="header" href="#æ‰“åŒ…-25">æ‰“åŒ…</a></h3>
<ul>
<li><code>pyo3</code> çš„ <code>Cargo.toml</code> ç°åœ¨å£°æ˜ <code>links = "python"</code>ï¼Œä»¥å‘ŠçŸ¥ Cargo å®ƒé“¾æ¥åˆ° <em>libpython</em>ã€‚<a href="https://github.com/PyO3/pyo3/pull/1819">#1819</a></li>
<li>æ·»åŠ å¯é€‰çš„ <code>anyhow</code> ç‰¹æ€§ï¼Œç”¨äºå°† <code>anyhow::Error</code> è½¬æ¢ä¸º <code>PyErr</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/1822">#1822</a></li>
<li>æ”¯æŒ Python 3.10ã€‚<a href="https://github.com/PyO3/pyo3/pull/1889">#1889</a></li>
<li>æ·»åŠ å¯é€‰çš„ <code>eyre</code> ç‰¹æ€§ï¼Œç”¨äºå°† <code>eyre::Report</code> è½¬æ¢ä¸º <code>PyErr</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/1893">#1893</a></li>
<li>æ”¯æŒ PyPy 3.8ã€‚<a href="https://github.com/PyO3/pyo3/pull/1948">#1948</a></li>
</ul>
<h3 id="æ–°å¢-31"><a class="header" href="#æ–°å¢-31">æ–°å¢</a></h3>
<ul>
<li>æ·»åŠ  <code>PyList::get_item_unchecked</code> å’Œ <code>PyTuple::get_item_unchecked</code>ï¼Œç”¨äºåœ¨æ— è¾¹ç•Œæ£€æŸ¥çš„æƒ…å†µä¸‹è·å–å…ƒç´ ã€‚<a href="https://github.com/PyO3/pyo3/pull/1733">#1733</a></li>
<li>æ”¯æŒ Rust 1.54 åŠä»¥ä¸Šç‰ˆæœ¬çš„ <code>#[doc = include_str!(...)]</code> å±æ€§ã€‚<a href="https://github.com/PyO3/pyo3/issues/1746">#1746</a></li>
<li>æ·»åŠ  <code>PyAny::py</code> ä½œä¸º <code>PyNativeType::py</code> çš„ä¾¿æ·æ–¹æ³•ã€‚<a href="https://github.com/PyO3/pyo3/pull/1751">#1751</a></li>
<li>ä¸º <code>PyList</code>ã€<code>PyTuple</code> å’Œ <code>PySequence</code> æ·»åŠ  <code>std::ops::Index&lt;usize&gt;</code> çš„å®ç°ã€‚<a href="https://github.com/PyO3/pyo3/pull/1825">#1825</a></li>
<li>ä¸º <code>PyList</code>ã€<code>PyTuple</code> å’Œ <code>PySequence</code> æ·»åŠ  <code>std::ops::Index</code> çš„èŒƒå›´ç´¢å¼•å®ç°ã€‚<a href="https://github.com/PyO3/pyo3/pull/1829">#1829</a></li>
<li>æ·»åŠ  <code>PyMapping</code> ç±»å‹ä»¥è¡¨ç¤º Python æ˜ å°„åè®®ã€‚<a href="https://github.com/PyO3/pyo3/pull/1844">#1844</a></li>
<li>ä¸º <code>PyList</code> å’Œ <code>PyTuple</code> æ·»åŠ å¸¸ç”¨åºåˆ—æ–¹æ³•ã€‚<a href="https://github.com/PyO3/pyo3/pull/1849">#1849</a></li>
<li>ä¸º <code>PyList</code> å’Œ <code>PyTuple</code> æ·»åŠ  <code>as_sequence</code> æ–¹æ³•ã€‚<a href="https://github.com/PyO3/pyo3/pull/1860">#1860</a></li>
<li>åœ¨ <code>#[pymethods]</code> ä¸­æ·»åŠ å¯¹é­”æ³•æ–¹æ³•çš„æ”¯æŒï¼Œæ—¨åœ¨æ›¿ä»£ <code>#[pyproto]</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/1864">#1864</a></li>
<li>æ·»åŠ  <code>abi3-py310</code> ç‰¹æ€§ã€‚<a href="https://github.com/PyO3/pyo3/pull/1889">#1889</a></li>
<li>æ·»åŠ  <code>PyCFunction::new_closure</code>ï¼Œç”¨äºä» Rust é—­åŒ…åˆ›å»º Python å‡½æ•°ã€‚<a href="https://github.com/PyO3/pyo3/pull/1901">#1901</a></li>
<li>åœ¨ <code>#[pyfunction]</code> ä¸­æ·»åŠ å¯¹ä»…ä½ç½®å‚æ•°çš„æ”¯æŒã€‚<a href="https://github.com/PyO3/pyo3/pull/1925">#1925</a></li>
<li>æ·»åŠ  <code>PyErr::take</code>ï¼Œç”¨äºå°è¯•è·å–å½“å‰å­˜åœ¨çš„ Python å¼‚å¸¸ã€‚<a href="https://github.com/PyO3/pyo3/pull/1957">#1957</a></li>
</ul>
<h3 id="æ›´æ”¹-17"><a class="header" href="#æ›´æ”¹-17">æ›´æ”¹</a></h3>
<ul>
<li><code>PyList</code>ã€<code>PyTuple</code> å’Œ <code>PySequence</code> çš„ API ç°åœ¨æ¥å— <code>usize</code> ç´¢å¼•è€Œé <code>isize</code>ã€‚
<a href="https://github.com/PyO3/pyo3/pull/1733">#1733</a>ï¼Œ<a href="https://github.com/PyO3/pyo3/pull/1802">#1802</a>ï¼Œ
<a href="https://github.com/PyO3/pyo3/pull/1803">#1803</a></li>
<li><code>PyList::get_item</code> å’Œ <code>PyTuple::get_item</code> ç°åœ¨è¿”å› <code>PyResult&lt;&amp;PyAny&gt;</code> è€Œé panicã€‚<a href="https://github.com/PyO3/pyo3/pull/1733">#1733</a></li>
<li><code>PySequence::in_place_repeat</code> å’Œ <code>PySequence::in_place_concat</code> ç°åœ¨è¿”å› <code>PyResult&lt;&amp;PySequence&gt;</code> è€Œé <code>PyResult&lt;()&gt;</code>ï¼Œè¿™å¯¹ä¸å¯å˜åºåˆ—ï¼ˆå¦‚å…ƒç»„ï¼‰æ˜¯å¿…éœ€çš„ã€‚<a href="https://github.com/PyO3/pyo3/pull/1803">#1803</a></li>
<li><code>PySequence::get_slice</code> ç°åœ¨è¿”å› <code>PyResult&lt;&amp;PySequence&gt;</code> è€Œé <code>PyResult&lt;&amp;PyAny&gt;</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/1829">#1829</a></li>
<li>å¼ƒç”¨ <code>PyTuple::split_from</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/1804">#1804</a></li>
<li>å¼ƒç”¨ <code>PyTuple::slice</code>ï¼Œæ–°å¢ä½¿ç”¨ <code>usize</code> ç´¢å¼•çš„æ–¹æ³• <code>PyTuple::get_slice</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/1828">#1828</a></li>
<li>åœ¨ä¸º Python 3.9 æ„å»ºæ—¶ï¼Œå¼ƒç”¨ FFI å®šä¹‰ <code>PyParser_SimpleParseStringFlags</code>ã€<code>PyParser_SimpleParseStringFlagsFilename</code> å’Œ <code>PyParser_SimpleParseFileFlags</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/1830">#1830</a></li>
<li>æ ‡è®° Python 3.10 ä¸­å·²ç§»é™¤çš„ FFI å®šä¹‰ <code>PyParser_ASTFromString</code>ã€<code>PyParser_ASTFromStringObject</code>ã€<code>PyParser_ASTFromFile</code>ã€<code>PyParser_ASTFromFileObject</code>ã€<code>PyParser_SimpleParseStringFlags</code>ã€<code>PyParser_SimpleParseStringFlagsFilename</code>ã€<code>PyParser_SimpleParseFileFlags</code>ã€<code>PyParser_SimpleParseString</code>ã€<code>PyParser_SimpleParseFile</code>ã€<code>Py_SymtableString</code> å’Œ <code>Py_SymtableStringObject</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/1830">#1830</a></li>
<li><code>#[pymethods]</code> ç°åœ¨å¯¹é­”æ³•æ–¹æ³•çš„å¤„ç†æ–¹å¼ç±»ä¼¼äº <code>#[pyproto]</code>ã€‚æœªæ¥å¯èƒ½ä¼šå¼ƒç”¨ <code>#[pyproto]</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/1864">#1864</a></li>
<li>å¼ƒç”¨ FFI å®šä¹‰ <code>PySys_AddWarnOption</code>ã€<code>PySys_AddWarnOptionUnicode</code> å’Œ <code>PySys_HasWarnOptions</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/1887">#1887</a></li>
<li>å¼ƒç”¨ <code>#[call]</code> å±æ€§ï¼Œå»ºè®®æ”¹ç”¨ <code>fn __call__</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/1929">#1929</a></li>
<li>ä¿®å¤ Python 3.10 ä¸Šç¼ºå¤±çš„ FFI å®šä¹‰ <code>_PyImport_FindExtensionObject</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/1942">#1942</a></li>
<li>æ›´æ”¹ <code>PyErr::fetch</code>ï¼Œåœ¨ debug æ¨¡å¼ä¸‹è‹¥æ— å¼‚å¸¸å­˜åœ¨åˆ™ panicã€‚<a href="https://github.com/PyO3/pyo3/pull/1957">#1957</a></li>
</ul>
<h3 id="ä¿®å¤-27"><a class="header" href="#ä¿®å¤-27">ä¿®å¤</a></h3>
<ul>
<li>ä¿®å¤åœ¨ Windows ä¸Šä½¿ç”¨ conda ç¯å¢ƒæ„å»ºçš„é—®é¢˜ã€‚<a href="https://github.com/PyO3/pyo3/pull/1873">#1873</a></li>
<li>ä¿®å¤åœ¨ Python åˆå§‹åŒ–ä½†çº¿ç¨‹æœªåˆå§‹åŒ–æ—¶ï¼Œè°ƒç”¨ <code>Python::with_gil</code> åœ¨ Python 3.6 ä¸Š panic çš„é—®é¢˜ã€‚<a href="https://github.com/PyO3/pyo3/pull/1874">#1874</a></li>
<li>ä¿®å¤åœ¨ä½¿ç”¨ <code>abi3</code> æ—¶äº¤å‰ç¼–è¯‘åˆ° Windows æ—¶é”™è¯¯é“¾æ¥ç‰ˆæœ¬ç‰¹å®š DLL è€Œé <code>python3.dll</code> çš„é—®é¢˜ã€‚<a href="https://github.com/PyO3/pyo3/pull/1880">#1880</a></li>
<li>ä¿®å¤ <code>PyTuple_ClearFreeList</code> çš„ FFI å®šä¹‰åœ¨ Python 3.9 åŠä»¥ä¸Šç‰ˆæœ¬ä¸­é”™è¯¯å­˜åœ¨çš„é—®é¢˜ã€‚<a href="https://github.com/PyO3/pyo3/pull/1887">#1887</a></li>
<li>ä¿®å¤ä¸ºæšä¸¾ç”Ÿæˆçš„ <code>#[derive(FromPyObject)]</code> ä¸­å‡ºç°çš„ panicã€‚<a href="https://github.com/PyO3/pyo3/pull/1888">#1888</a></li>
<li>ä¿®å¤ä½¿ç”¨ â€œmâ€ abi æ ‡å¿—äº¤å‰ç¼–è¯‘åˆ° Python 3.7 æ„å»ºçš„é—®é¢˜ã€‚<a href="https://github.com/PyO3/pyo3/pull/1908">#1908</a></li>
<li>ä¿®å¤ <code>__mod__</code> é­”æ³•æ–¹æ³•å›é€€åˆ° <code>__rmod__</code> çš„é—®é¢˜ã€‚<a href="https://github.com/PyO3/pyo3/pull/1934">#1934</a></li>
<li>ä¿®å¤ Python 3.10 ä¸Šç¼ºå¤±çš„ FFI å®šä¹‰ <code>_PyImport_FindExtensionObject</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/1942">#1942</a></li>
</ul>
<h2 id="0145---2021-09-05"><a class="header" href="#0145---2021-09-05">[0.14.5] - 2021-09-05</a></h2>
<h3 id="æ–°å¢-32"><a class="header" href="#æ–°å¢-32">æ–°å¢</a></h3>
<ul>
<li>å°† <code>pyo3_build_config::InterpreterConfig</code> åŠå…¶å­å­—æ®µè®¾ä¸ºå…¬å¼€ã€‚<a href="https://github.com/PyO3/pyo3/pull/1848">#1848</a></li>
<li>åœ¨ <code>pyo3-build-config</code> ä¸­æ·»åŠ  <code>resolve-config</code> ç‰¹æ€§ï¼Œä»¥æ§åˆ¶å…¶æ„å»ºè„šæœ¬æ˜¯å¦æ‰§è¡Œæ“ä½œã€‚<a href="https://github.com/PyO3/pyo3/pull/1856">#1856</a></li>
</ul>
<h3 id="ä¿®å¤-28"><a class="header" href="#ä¿®å¤-28">ä¿®å¤</a></h3>
<ul>
<li>ä¿®å¤ 0.14.4 åœ¨ <code>s390x-unknown-linux-gnu</code> ç›®æ ‡ä¸Šçš„ç¼–è¯‘å›å½’é—®é¢˜ã€‚<a href="https://github.com/PyO3/pyo3/pull/1850">#1850</a></li>
</ul>
<h2 id="0144---2021-08-29"><a class="header" href="#0144---2021-08-29">[0.14.4] - 2021-08-29</a></h2>
<h3 id="æ›´æ”¹-18"><a class="header" href="#æ›´æ”¹-18">æ›´æ”¹</a></h3>
<ul>
<li>å°† <code>PyString::data</code> æ ‡è®°ä¸º <code>unsafe</code>ï¼Œå¹¶ä¸”åœ¨å¤§ç«¯åºç›®æ ‡ä¸Šç¦ç”¨è¯¥æ–¹æ³•åŠä¸€äº›ä¾èµ– C ä½åŸŸçš„ PyUnicode FFI APIã€‚<a href="https://github.com/PyO3/pyo3/pull/1834">#1834</a></li>
</ul>
<h2 id="0143---2021-08-22"><a class="header" href="#0143---2021-08-22">[0.14.3] - 2021-08-22</a></h2>
<h3 id="æ–°å¢-33"><a class="header" href="#æ–°å¢-33">æ–°å¢</a></h3>
<ul>
<li>æ·»åŠ  <code>PyString::data</code> ä»¥è®¿é—® Python å­—ç¬¦ä¸²ä¸­å­˜å‚¨çš„åŸå§‹å­—èŠ‚ã€‚<a href="https://github.com/PyO3/pyo3/pull/1794">#1794</a></li>
</ul>
<h3 id="ä¿®å¤-29"><a class="header" href="#ä¿®å¤-29">ä¿®å¤</a></h3>
<ul>
<li>åœ¨å¯¹å¸¦æœ‰ <code>#[setter]</code> çš„ç±»å±æ€§è°ƒç”¨ <code>del</code> æ—¶æŠ›å‡º <code>AttributeError</code> ä»¥é¿å… panicã€‚<a href="https://github.com/PyO3/pyo3/pull/1779">#1779</a></li>
<li>å°† FFI å®šä¹‰ <code>PyGILState_Check</code> å’Œ <code>Py_tracefunc</code> é™åˆ¶åœ¨æ— é™ API ä¸­ã€‚<a href="https://github.com/PyO3/pyo3/pull/1787">#1787</a></li>
<li>åœ¨ <code>PyStatus</code> ç»“æ„ä½“å®šä¹‰ä¸­æ·»åŠ ç¼ºå¤±çš„ <code>_type</code> å­—æ®µã€‚<a href="https://github.com/PyO3/pyo3/pull/1791">#1791</a></li>
<li>é™ä½ <code>num-complex</code> å¯é€‰ä¾èµ–çš„ä¸‹é™ç‰ˆæœ¬ï¼Œä»¥æ”¯æŒåœ¨ MSRV ä¸º 1.41 æ—¶ä¸ <code>rust-numpy</code> å’Œ <code>ndarray</code> äº’æ“ä½œã€‚<a href="https://github.com/PyO3/pyo3/pull/1799">#1799</a></li>
<li>ä¿®å¤ <code>Python::run_code</code> ä¸­çš„å†…å­˜æ³„æ¼ã€‚<a href="https://github.com/PyO3/pyo3/pull/1806">#1806</a></li>
<li>ä¿®å¤ <code>PyModule::from_code</code> ä¸­çš„å†…å­˜æ³„æ¼ã€‚<a href="https://github.com/PyO3/pyo3/pull/1810">#1810</a></li>
<li>ç§»é™¤ <code>pyo3::types::datetime</code> ä¸­å¯¹ <code>pyo3::</code> çš„ä½¿ç”¨ï¼Œæ­¤é—®é¢˜åœ¨ä½¿ç”¨ <code>-Z avoid-dev-deps</code> æ—¶ä¼šç ´åæ„å»ºã€‚<a href="https://github.com/PyO3/pyo3/pull/1811">#1811</a></li>
</ul>
<h2 id="0142---2021-08-09"><a class="header" href="#0142---2021-08-09">[0.14.2] - 2021-08-09</a></h2>
<h3 id="æ–°å¢--æ·»åŠ -indexmap-åŠŸèƒ½ä¸º-indexmapindexmap-æä¾›-topyobjectintopy-å’Œ-frompyobject-çš„å®ç°1728"><a class="header" href="#æ–°å¢--æ·»åŠ -indexmap-åŠŸèƒ½ä¸º-indexmapindexmap-æä¾›-topyobjectintopy-å’Œ-frompyobject-çš„å®ç°1728">æ–°å¢- æ·»åŠ  <code>indexmap</code> åŠŸèƒ½ï¼Œä¸º <code>indexmap::IndexMap</code> æä¾› <code>ToPyObject</code>ã€<code>IntoPy</code> å’Œ <code>FromPyObject</code> çš„å®ç°ã€‚<a href="https://github.com/PyO3/pyo3/pull/1728">#1728</a></a></h3>
<ul>
<li>æ·»åŠ  <code>pyo3_build_config::add_extension_module_link_args</code>ï¼Œç”¨äºåœ¨æ„å»ºè„šæœ¬ä¸­è®¾ç½®é“¾æ¥å™¨å‚æ•°ï¼ˆé€‚ç”¨äº macOSï¼‰ã€‚<a href="https://github.com/PyO3/pyo3/pull/1755">#1755</a></li>
<li>æ·»åŠ  <code>Python::with_gil_unchecked</code>ï¼Œè¿™æ˜¯ <code>Python::with_gil</code> çš„ä¸å®‰å…¨å˜ä½“ï¼Œå…è®¸åœ¨ <code>Python::with_gil</code> ä¼šå¤±è´¥çš„åœºæ™¯ä¸­è·å– <code>Python</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/1769">#1769</a></li>
</ul>
<h3 id="å˜æ›´-10"><a class="header" href="#å˜æ›´-10">å˜æ›´</a></h3>
<ul>
<li><code>PyErr::new</code> ä¸å†åœ¨å†…éƒ¨è·å– Python GILã€‚<a href="https://github.com/PyO3/pyo3/pull/1724">#1724</a></li>
<li>æ’¤é”€ PyO3 0.14.0 åœ¨å…¶æ„å»ºè„šæœ¬ä¸­ä½¿ç”¨ <code>cargo:rustc-cdylib-link-arg</code> çš„è¡Œä¸ºï¼Œå› ä¸º Cargo æ„å¤–åœ°å…è®¸ crate é€šè¿‡è¿™ç§æ–¹å¼å‘ä¸‹æ¸¸ crate ä¼ é€’é“¾æ¥å™¨å‚æ•°ã€‚æ”¯æŒ macOS çš„é¡¹ç›®å¯èƒ½éœ€è¦æ¢å¤ <code>.cargo/config.toml</code> æ–‡ä»¶ã€‚<a href="https://github.com/PyO3/pyo3/pull/1755">#1755</a></li>
</ul>
<h3 id="ä¿®å¤-30"><a class="header" href="#ä¿®å¤-30">ä¿®å¤</a></h3>
<ul>
<li>ä¿®å¤ 0.14.0 ç‰ˆæœ¬ä¸­çš„å›å½’é—®é¢˜ï¼Œè¯¥é—®é¢˜æ‹’ç»åœ¨ä½¿ç”¨ PyO3 å®æ³¨è§£çš„ç»“æ„ä½“å’Œå‡½æ•°ä¸Šä½¿ç”¨ <code>#[doc(hidden)]</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/1722">#1722</a></li>
<li>ä¿®å¤ 0.14.0 ç‰ˆæœ¬ä¸­çš„å›å½’é—®é¢˜ï¼Œè¯¥é—®é¢˜å¯¼è‡´ <code>#[pyfunction]</code> çš„ä»£ç è¦†ç›–ç‡è®¡ç®—ä¸æ­£ç¡®ã€‚<a href="https://github.com/PyO3/pyo3/pull/1726">#1726</a></li>
<li>ä¿®å¤ PyPy ä¸Š <code>Py_Buffer</code> çš„é”™è¯¯ FFI å®šä¹‰ã€‚<a href="https://github.com/PyO3/pyo3/pull/1737">#1737</a></li>
<li>ä¿®å¤ 32 ä½ Windows ä¸Š <code>dictoffset</code> çš„é”™è¯¯è®¡ç®—ã€‚<a href="https://github.com/PyO3/pyo3/pull/1475">#1475</a></li>
<li>ä¿®å¤ 0.13.2 ç‰ˆæœ¬ä¸­çš„å›å½’é—®é¢˜ï¼Œè¯¥é—®é¢˜å¯¼è‡´åœ¨ Windows â€œgnuâ€ ç›®æ ‡ä¸Šé“¾æ¥åˆ°é”™è¯¯çš„ Python åº“ã€‚<a href="https://github.com/PyO3/pyo3/pull/1759">#1759</a></li>
<li>ä¿®å¤ç¼–è¯‘å™¨è­¦å‘Šï¼šç¦æ­¢åœ¨è¡¨è¾¾å¼å®ä¸­ä½¿ç”¨å°¾éšåˆ†å·ã€‚<a href="https://github.com/PyO3/pyo3/pull/1762">#1762</a></li>
<li>ä¿®å¤ <code>Py_DecodeLocale</code> çš„é”™è¯¯ FFI å®šä¹‰ã€‚ç¬¬äºŒä¸ªå‚æ•°ç°åœ¨æ˜¯ <code>*mut Py_ssize_t</code> è€Œä¸æ˜¯ <code>Py_ssize_t</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/1766">#1766</a></li>
</ul>
<h2 id="0141---2021-07-04"><a class="header" href="#0141---2021-07-04">[0.14.1] - 2021-07-04</a></h2>
<h3 id="æ–°å¢-34"><a class="header" href="#æ–°å¢-34">æ–°å¢</a></h3>
<ul>
<li>ä¸º <code>&amp;PathBuf</code> å’Œ <code>&amp;OsString</code> å®ç° <code>IntoPy&lt;PyObject&gt;</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/1712">#1712</a></li>
</ul>
<h3 id="ä¿®å¤-31"><a class="header" href="#ä¿®å¤-31">ä¿®å¤</a></h3>
<ul>
<li>ä¿®å¤å›  <code>PyList_SET_ITEM</code> çš„é”™è¯¯å®šä¹‰å¯¼è‡´åœ¨ PyPy ä¸Šå´©æºƒçš„é—®é¢˜ã€‚<a href="https://github.com/PyO3/pyo3/pull/1713">#1713</a></li>
</ul>
<h2 id="0140---2021-07-03"><a class="header" href="#0140---2021-07-03">[0.14.0] - 2021-07-03</a></h2>
<h3 id="æ‰“åŒ…-26"><a class="header" href="#æ‰“åŒ…-26">æ‰“åŒ…</a></h3>
<ul>
<li>å°†å¯é€‰ä¾èµ–é¡¹ <code>num-bigint</code> æ›´æ–°è‡³ 0.4ã€‚<a href="https://github.com/PyO3/pyo3/pull/1481">#1481</a></li>
<li>å°†å¯é€‰ä¾èµ–é¡¹ <code>num-complex</code> æ›´æ–°è‡³ 0.4ã€‚<a href="https://github.com/PyO3/pyo3/pull/1482">#1482</a></li>
<li>æ‰©å±•å¯é€‰ä¾èµ–é¡¹ <code>hashbrown</code> çš„æ”¯æŒç‰ˆæœ¬ï¼ŒåŒ…å« 0.11ã€‚<a href="https://github.com/PyO3/pyo3/pull/1496">#1496</a></li>
<li>æ”¯æŒ PyPy 3.7ã€‚<a href="https://github.com/PyO3/pyo3/pull/1538">#1538</a></li>
</ul>
<h3 id="æ–°å¢-35"><a class="header" href="#æ–°å¢-35">æ–°å¢</a></h3>
<ul>
<li>ä½¿ç”¨ const genericsï¼ˆåœ¨ Rust 1.51 åŠä»¥ä¸Šç‰ˆæœ¬ï¼‰æ‰©å±• <code>[T; N]</code> çš„è½¬æ¢æ”¯æŒè‡³æ‰€æœ‰ <code>N</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/1128">#1128</a></li>
<li>æ·»åŠ  <code>OsStr</code> / <code>OsString</code> ä¸ Python å­—ç¬¦ä¸²ä¹‹é—´çš„è½¬æ¢ã€‚<a href="https://github.com/PyO3/pyo3/pull/1379">#1379</a></li>
<li>æ·»åŠ  <code>Path</code> / <code>PathBuf</code> ä¸ Python å­—ç¬¦ä¸²ï¼ˆä»¥åŠ <code>pathlib.Path</code> å¯¹è±¡ï¼‰ä¹‹é—´çš„è½¬æ¢ã€‚<a href="https://github.com/PyO3/pyo3/pull/1379">#1379</a> <a href="https://github.com/PyO3/pyo3/pull/1654">#1654</a></li>
<li>æ·»åŠ ä¸€ç»„æ–°çš„ <code>#[pyo3(...)]</code> å±æ€§ï¼Œç”¨äºæ§åˆ¶å„ç§ PyO3 å®åŠŸèƒ½ï¼š
<ul>
<li><code>#[pyo3(from_py_with = "...")]</code> ç”¨äºè¦†ç›–é»˜è®¤çš„ä» Python è½¬æ¢é€»è¾‘ï¼Œé€‚ç”¨äºå‡½æ•°å‚æ•°å’Œç»“æ„ä½“å­—æ®µã€‚<a href="https://github.com/PyO3/pyo3/pull/1411">#1411</a></li>
<li><code>#[pyo3(name = "...")]</code> ç”¨äºè®¾ç½® Python åç§°ã€‚<a href="https://github.com/PyO3/pyo3/pull/1567">#1567</a></li>
<li><code>#[pyo3(text_signature = "...")]</code> ç”¨äºè®¾ç½®æ–‡æœ¬ç­¾åã€‚<a href="https://github.com/PyO3/pyo3/pull/1658">#1658</a></li>
</ul>
</li>
<li>ä¸º Python 3.9 åŠæ›´é«˜ç‰ˆæœ¬æ·»åŠ  FFI å®šä¹‰ <code>PyCFunction_CheckExact</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/1425">#1425</a></li>
<li>æ·»åŠ  FFI å®šä¹‰ <code>Py_IS_TYPE</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/1429">#1429</a></li>
<li>æ·»åŠ  FFI å®šä¹‰ <code>_Py_InitializeMain</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/1473">#1473</a></li>
<li>æ·»åŠ æ¥è‡ª <code>cpython/import.h</code> çš„ FFI å®šä¹‰ã€‚<a href="https://github.com/PyO3/pyo3/pull/1475">#1475</a></li>
<li>ä¸º <code>#[pyclass]</code> å®æ·»åŠ å…ƒç»„å’Œå•å…ƒç»“æ„ä½“æ”¯æŒã€‚<a href="https://github.com/PyO3/pyo3/pull/1504">#1504</a></li>
<li>æ·»åŠ  FFI å®šä¹‰ <code>PyDateTime_TimeZone_UTC</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/1572">#1572</a></li>
<li>æ·»åŠ å¯¹ <code>#[pyclass(extends=Exception)]</code> çš„æ”¯æŒã€‚<a href="https://github.com/PyO3/pyo3/pull/1591">#1591</a></li>
<li>æ·»åŠ  <code>PyErr::cause</code> å’Œ <code>PyErr::set_cause</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/1679">#1679</a></li>
<li>æ·»åŠ æ¥è‡ª <code>cpython/pystate.h</code> çš„ FFI å®šä¹‰ã€‚<a href="https://github.com/PyO3/pyo3/pull/1687/">#1687</a></li>
<li>åœ¨ <code>pyo3::prelude</code> ä¸­æ·»åŠ  <code>wrap_pyfunction!</code> å®ã€‚<a href="https://github.com/PyO3/pyo3/pull/1695">#1695</a></li>
</ul>
<h3 id="å˜æ›´-11"><a class="header" href="#å˜æ›´-11">å˜æ›´</a></h3>
<ul>
<li>é»˜è®¤æƒ…å†µä¸‹ï¼Œæ¯ä¸ª <code>#[pyclass]</code> ä»…å…è®¸ä¸€ä¸ª <code>#[pymethods]</code> å—ï¼Œä»¥ç§»é™¤å¯¹ <code>inventory</code> çš„ä¾èµ–ã€‚æ·»åŠ  <code>multiple-pymethods</code> åŠŸèƒ½ä»¥é€‰æ‹©æ€§å¯ç”¨åŸå§‹è¡Œä¸ºåŠå¯¹ <code>inventory</code> çš„ä¾èµ–ã€‚<a href="https://github.com/PyO3/pyo3/pull/1457">#1457</a></li>
<li>å°† <code>PyTimeAccess::get_fold</code> çš„è¿”å›å€¼ä» <code>u8</code> æ›´æ”¹ä¸º <code>bool</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/1397">#1397</a></li>
<li>ä¸º Python 3.9 åŠä»¥ä¸Šç‰ˆæœ¬å¼ƒç”¨ FFI å®šä¹‰ <code>PyCFunction_Call</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/1425">#1425</a></li>
<li>å¼ƒç”¨ FFI å®šä¹‰ <code>PyModule_GetFilename</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/1425">#1425</a></li>
<li><code>auto-initialize</code> åŠŸèƒ½ä¸å†é»˜è®¤å¯ç”¨ã€‚<a href="https://github.com/PyO3/pyo3/pull/1443">#1443</a></li>
<li>å°† <code>PyCFunction::new</code> å’Œ <code>PyCFunction::new_with_keywords</code> æ›´æ”¹ä¸ºæ¥å— <code>'static str</code> å‚æ•°ï¼Œè€Œä¸æ˜¯éšå¼å¤åˆ¶ï¼ˆå¹¶æ³„æ¼ï¼‰å®ƒä»¬ã€‚<a href="https://github.com/PyO3/pyo3/pull/1450">#1450</a></li>
<li>å¼ƒç”¨ <code>PyModule::call</code>ã€<code>PyModule::call0</code>ã€<code>PyModule::call1</code> å’Œ <code>PyModule::get</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/1492">#1492</a></li>
<li>åœ¨ <code>PyBuffer::copy_to_slice</code> å’Œ <code>PyBuffer::copy_from_slice</code> å¼•å‘çš„ <code>PyBufferError</code> ä¸­æ·»åŠ é•¿åº¦ä¿¡æ¯ã€‚<a href="https://github.com/PyO3/pyo3/pull/1534">#1534</a></li>
<li>åœ¨ä½¿ç”¨ <code>extension-module</code> åŠŸèƒ½æ—¶ï¼Œè‡ªåŠ¨åœ¨ macOS ä¸Šè®¾ç½® <code>-undefined</code> å’Œ <code>dynamic_lookup</code> é“¾æ¥å™¨å‚æ•°ã€‚<a href="https://github.com/PyO3/pyo3/pull/1539">#1539</a></li>
<li>å¼ƒç”¨æ›´æ˜“äºé€šè¿‡ <code>#[pymethods]</code> å®ç°çš„ <code>#[pyproto]</code> æ–¹æ³•ï¼š<a href="https://github.com/PyO3/pyo3/pull/1560">#1560</a>
<ul>
<li><code>PyBasicProtocol::__bytes__</code> å’Œ <code>PyBasicProtocol::__format__</code></li>
<li><code>PyContextProtocol::__enter__</code> å’Œ <code>PyContextProtocol::__exit__</code></li>
<li><code>PyDescrProtocol::__delete__</code> å’Œ <code>PyDescrProtocol::__set_name__</code></li>
<li><code>PyMappingProtocol::__reversed__</code></li>
<li><code>PyNumberProtocol::__complex__</code> å’Œ <code>PyNumberProtocol::__round__</code></li>
<li><code>PyAsyncProtocol::__aenter__</code> å’Œ <code>PyAsyncProtocol::__aexit__</code></li>
</ul>
</li>
<li>å¼ƒç”¨å¤šä¸ªå±æ€§ï¼Œæ”¹ç”¨æ–°çš„ <code>#[pyo3(...)]</code> é€‰é¡¹ï¼š
<ul>
<li><code>#[name = "..."]</code> æ›¿æ¢ä¸º <code>#[pyo3(name = "...")]</code> <a href="https://github.com/PyO3/pyo3/pull/1567">#1567</a></li>
<li><code>#[pyfn(m, "name")]</code> æ›¿æ¢ä¸º <code>#[pyfn(m)] #[pyo3(name = "...")]</code> <a href="https://github.com/PyO3/pyo3/pull/1610">#1610</a></li>
<li><code>#[pymodule(name)]</code> æ›¿æ¢ä¸º <code>#[pymodule] #[pyo3(name = "...")]</code> <a href="https://github.com/PyO3/pyo3/pull/1650">#1650</a></li>
<li><code>#[text_signature = "..."]</code> æ›¿æ¢ä¸º <code>#[pyo3(text_signature = "...")]</code> <a href="https://github.com/PyO3/pyo3/pull/1658">#1658</a></li>
</ul>
</li>
<li>å‡å°‘ LLVM è¡Œæ•°ä»¥æé«˜ç¼–è¯‘é€Ÿåº¦ã€‚<a href="https://github.com/PyO3/pyo3/pull/1604">#1604</a></li>
<li>ä¸å†åœ¨ <code>#[pymodule]</code> åˆå§‹åŒ–ä»£ç ä¸­è°ƒç”¨ <code>PyEval_InitThreads</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/1630">#1630</a></li>
<li>åœ¨å¯èƒ½çš„æƒ…å†µä¸‹ä½¿ç”¨ <code>METH_FASTCALL</code> å‚æ•°ä¼ é€’çº¦å®šï¼Œä»¥æé«˜ <code>#[pyfunction]</code> å’Œæ–¹æ³•çš„æ€§èƒ½ã€‚
<a href="https://github.com/PyO3/pyo3/pull/1619">#1619</a>, <a href="https://github.com/PyO3/pyo3/pull/1660">#1660</a></li>
<li>äº¤å‰ç¼–è¯‘æ—¶æŒ‰æ¶æ„è¿‡æ»¤ sysconfigdata å€™é€‰é¡¹ã€‚<a href="https://github.com/PyO3/pyo3/pull/1626">#1626</a></li>
</ul>
<h3 id="ç§»é™¤-7"><a class="header" href="#ç§»é™¤-7">ç§»é™¤</a></h3>
<ul>
<li>ç§»é™¤å·²å¼ƒç”¨çš„å¼‚å¸¸åç§° <code>BaseException</code> ç­‰ã€‚<a href="https://github.com/PyO3/pyo3/pull/1426">#1426</a></li>
<li>ç§»é™¤å·²å¼ƒç”¨çš„æ–¹æ³• <code>Python::is_instance</code>ã€<code>Python::is_subclass</code>ã€<code>Python::release</code>ã€<code>Python::xdecref</code> å’Œ <code>Py::from_owned_ptr_or_panic</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/1426">#1426</a></li>
<li>ç§»é™¤è®¸å¤šåœ¨ Python C-API ä¸­ä»æœªå­˜åœ¨çš„ FFI å®šä¹‰ï¼š
<ul>
<li>ï¼ˆå…ˆå‰å·²å¼ƒç”¨ï¼‰<code>PyGetSetDef_INIT</code>ã€<code>PyGetSetDef_DICT</code>ã€<code>PyCoro_Check</code>ã€<code>PyCoroWrapper_Check</code> å’Œ <code>PyAsyncGen_Check</code> <a href="https://github.com/PyO3/pyo3/pull/1426">#1426</a></li>
<li><code>PyMethodDef_INIT</code> <a href="https://github.com/PyO3/pyo3/pull/1426">#1426</a></li>
<li><code>PyTypeObject_INIT</code> <a href="https://github.com/PyO3/pyo3/pull/1429">#1429</a></li>
<li><code>PyObject_Check</code>ã€<code>PySuper_Check</code> å’Œ <code>FreeFunc</code> <a href="https://github.com/PyO3/pyo3/pull/1438">#1438</a></li>
<li><code>PyModuleDef_INIT</code> <a href="https://github.com/PyO3/pyo3/pull/1630">#1630</a></li>
</ul>
</li>
<li>ä» <code>PyTypeInfo</code> ä¸­ç§»é™¤ pyclass çš„å®ç°ç»†èŠ‚ï¼š
<ul>
<li><code>Type</code>ã€<code>DESCRIPTION</code> å’Œ <code>FLAGS</code> <a href="https://github.com/PyO3/pyo3/pull/1456">#1456</a></li>
<li><code>BaseType</code>ã€<code>BaseLayout</code>ã€<code>Layout</code>ã€<code>Initializer</code> <a href="https://github.com/PyO3/pyo3/pull/1596">#1596</a></li>
</ul>
</li>
<li>ç§»é™¤ <code>PYO3_CROSS_INCLUDE_DIR</code> ç¯å¢ƒå˜é‡åŠç›¸å…³ C å¤´æ–‡ä»¶è§£æåŠŸèƒ½ã€‚<a href="https://github.com/PyO3/pyo3/pull/1521">#1521</a></li>
<li>ç§»é™¤ <code>raw_pycfunction!</code> å®ã€‚<a href="https://github.com/PyO3/pyo3/pull/1619">#1619</a></li>
<li>ç§»é™¤ <code>PyClassAlloc</code> traitã€‚<a href="https://github.com/PyO3/pyo3/pull/1657">#1657</a></li>
<li>ç§»é™¤ <code>PyList::get_parked_item</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/1664">#1664</a></li>
</ul>
<h3 id="ä¿®å¤-32"><a class="header" href="#ä¿®å¤-32">ä¿®å¤</a></h3>
<ul>
<li>ä¸º Python 3.9 åŠæ›´é«˜ç‰ˆæœ¬ç§»é™¤ FFI å®šä¹‰ <code>PyCFunction_ClearFreeList</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/1425">#1425</a></li>
<li>ç¼–è¯‘æ—¶ä» macOS arm64 å‘ x86-64 Python ç¼–è¯‘æˆ–åä¹‹ï¼Œä¸å†éœ€è¦ <code>PYO3_CROSS_LIB_DIR</code> ç¯å¢ƒå˜é‡ã€‚<a href="https://github.com/PyO3/pyo3/pull/1428">#1428</a></li>
<li>ä¿®å¤ FFI å®šä¹‰ <code>_PyEval_RequestCodeExtraIndex</code>ï¼Œå…¶å‚æ•°ç±»å‹é”™è¯¯ã€‚<a href="https://github.com/PyO3/pyo3/pull/1429">#1429</a></li>
<li>ä¿®å¤åœ¨å¯ç”¨ <code>abi3</code> åŠŸèƒ½æ—¶ <code>PyIndex_Check</code> çš„ FFI å®šä¹‰ç¼ºå¤±é—®é¢˜ã€‚<a href="https://github.com/PyO3/pyo3/pull/1436">#1436</a></li>
<li>ä¿®å¤å½“åœ¨ <code>*args</code> ä¸­ä¼ é€’å…³é”®å­—å‚æ•°å’Œä½ç½®å‚æ•°æ—¶å¼•å‘çš„é”™è¯¯ <code>TypeError</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/1440">#1440</a></li>
<li>ä¿®å¤åœ¨ <code>#[pyfunction]</code> ä¸­æ— æ³•ä¸º <code>&amp;PyTuple</code> çš„ <code>*args</code> ä½¿ç”¨å‘½åç”Ÿå‘½å‘¨æœŸçš„é—®é¢˜ã€‚<a href="https://github.com/PyO3/pyo3/pull/1440">#1440</a>- ä¿®å¤åœ¨å®å±•å¼€å†…éƒ¨ä½¿ç”¨ Python å‚æ•°æ—¶ <code>#[pymethods]</code> çš„é—®é¢˜ã€‚<a href="https://github.com/PyO3/pyo3/pull/1505">#1505</a></li>
<li>ä¸å†å°† <code>__doc__</code> åŒ…å«åœ¨ <code>#[pymodule]</code> ç”Ÿæˆçš„ <code>__all__</code> ä¸­ã€‚<a href="https://github.com/PyO3/pyo3/pull/1509">#1509</a></li>
<li>åªè¦è®¾ç½®äº† <code>PYO3_CROSS</code> ç³»åˆ—ç¯å¢ƒå˜é‡ä¸­çš„ä»»æ„ä¸€ä¸ªï¼Œå°±å§‹ç»ˆä½¿ç”¨äº¤å‰ç¼–è¯‘é…ç½®ã€‚<a href="https://github.com/PyO3/pyo3/pull/1514">#1514</a></li>
<li>åœ¨ PyPy ä¸Šæ”¯æŒ <code>EnvironmentError</code>ã€<code>IOError</code> å’Œ <code>WindowsError</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/1533">#1533</a></li>
<li>ä¿®å¤åœ¨ Python è™šæ‹Ÿç¯å¢ƒä¸­æ¥å›æ‰§è¡Œ <code>cargo check</code> å’Œ <code>cargo clippy</code> æ—¶ä¸å¿…è¦çš„é‡æ–°æ„å»ºé—®é¢˜ã€‚<a href="https://github.com/PyO3/pyo3/pull/1557">#1557</a></li>
<li>ä¿®å¤åœ¨æœªæŒæœ‰ GIL æ—¶è§£å¼•ç”¨ <code>ffi::PyDateTimeAPI</code> å¯¼è‡´çš„æ®µé”™è¯¯ã€‚<a href="https://github.com/PyO3/pyo3/pull/1563">#1563</a></li>
<li>ä¿®å¤ <code>u128</code> å’Œ <code>i128</code> çš„ <code>FromPyObject</code> å®ç°ä¸­çš„å†…å­˜æ³„æ¼ã€‚<a href="https://github.com/PyO3/pyo3/pull/1638">#1638</a></li>
<li>ä¿®å¤ <code>#[pyclass(extends=PyDict)]</code> åœ¨ Drop æ—¶æ³„éœ²å­—å…¸å†…å®¹çš„é—®é¢˜ã€‚<a href="https://github.com/PyO3/pyo3/pull/1657">#1657</a></li>
<li>ä¿®å¤è°ƒç”¨ <code>PyList::get_item</code> æ—¶ä½¿ç”¨è´Ÿç´¢å¼•å¯¼è‡´çš„æ®µé”™è¯¯ã€‚<a href="https://github.com/PyO3/pyo3/pull/1668">#1668</a></li>
<li>ä¿®å¤ <code>PyEval_SetProfile</code>/<code>PyEval_SetTrace</code> çš„ FFI å®šä¹‰ï¼Œä½¿å…¶æ¥å— <code>Option&lt;Py_tracefunc&gt;</code> å‚æ•°ã€‚<a href="https://github.com/PyO3/pyo3/pull/1692">#1692</a></li>
<li>ä¿®å¤ <code>HashSet</code> çš„ <code>ToPyObject</code> å®ç°ä»¥æ”¯æŒéé»˜è®¤å“ˆå¸Œå™¨ã€‚<a href="https://github.com/PyO3/pyo3/pull/1702">#1702</a></li>
</ul>
<h2 id="0132---2021-02-12"><a class="header" href="#0132---2021-02-12">[0.13.2] - 2021-02-12</a></h2>
<h3 id="æ‰“åŒ…-27"><a class="header" href="#æ‰“åŒ…-27">æ‰“åŒ…</a></h3>
<ul>
<li>å°†æœ€ä½æ”¯æŒçš„ Rust ç‰ˆæœ¬é™ä½ä¸º 1.41ã€‚<a href="https://github.com/PyO3/pyo3/pull/1421">#1421</a></li>
</ul>
<h3 id="æ–°å¢-36"><a class="header" href="#æ–°å¢-36">æ–°å¢</a></h3>
<ul>
<li>æ·»åŠ ä¸å®‰å…¨ API <code>with_embedded_python_interpreter</code>ï¼Œç”¨äºåˆå§‹åŒ– Python è§£é‡Šå™¨ã€æ‰§è¡Œé—­åŒ…å¹¶æœ€ç»ˆåŒ–è§£é‡Šå™¨ã€‚<a href="https://github.com/PyO3/pyo3/pull/1355">#1355</a></li>
<li>æ·»åŠ  <code>serde</code> åŠŸèƒ½ï¼Œä¸º <code>Py&lt;T&gt;</code> æä¾› <code>Serialize</code> å’Œ <code>Deserialize</code> çš„å®ç°ã€‚<a href="https://github.com/PyO3/pyo3/pull/1366">#1366</a></li>
<li>åœ¨ Python 3.7 åŠä»¥ä¸Šç‰ˆæœ¬ä¸­æ·»åŠ  FFI å®šä¹‰ <code>_PyCFunctionFastWithKeywords</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/1384">#1384</a></li>
<li>æ·»åŠ  <code>PyDateTime::new_with_fold</code> æ–¹æ³•ã€‚<a href="https://github.com/PyO3/pyo3/pull/1398">#1398</a></li>
<li>ä¸º <code>{PyDict, PyList, PySet, PyTuple}Iterator</code> æ·»åŠ  <code>size_hint</code> å®ç°ã€‚<a href="https://github.com/PyO3/pyo3/pull/1699">#1699</a></li>
</ul>
<h3 id="æ›´æ”¹-19"><a class="header" href="#æ›´æ”¹-19">æ›´æ”¹</a></h3>
<ul>
<li><code>prepare_freethreaded_python</code> å°†ä¸å†æ³¨å†Œ <code>atexit</code> å¤„ç†ç¨‹åºæ¥è°ƒç”¨ <code>Py_Finalize</code>ã€‚è¿™è§£å†³äº†å› ä¸å…¼å®¹çš„ C æ‰©å±•åœ¨æœ€ç»ˆåŒ–æ—¶å¼•å‘å´©æºƒçš„é—®é¢˜ã€‚<a href="https://github.com/PyO3/pyo3/pull/1355">#1355</a></li>
<li>å°† <code>PyLayout::py_init</code>ã€<code>PyClassDict::clear_dict</code> å’Œ <code>opt_to_pyobj</code> æ ‡è®°ä¸ºå®‰å…¨å‡½æ•°ï¼Œå› ä¸ºå®ƒä»¬ä¸æ‰§è¡Œä»»ä½•ä¸å®‰å…¨æ“ä½œã€‚<a href="https://github.com/PyO3/pyo3/pull/1404">#1404</a></li>
</ul>
<h3 id="ä¿®å¤-33"><a class="header" href="#ä¿®å¤-33">ä¿®å¤</a></h3>
<ul>
<li>ä¿®å¤åœ¨ pyfunction ä¸­ä½¿ç”¨ <code>r#raw_idents</code> ä½œä¸ºå‚æ•°åçš„æ”¯æŒé—®é¢˜ã€‚<a href="https://github.com/PyO3/pyo3/pull/1383">#1383</a></li>
<li>ä¿®å¤ <code>PyFunction_GetCode</code> çš„ FFI å®šä¹‰ä¸­çš„æ‹¼å†™é”™è¯¯ï¼ˆä¹‹å‰é”™è¯¯åœ°å†™æˆäº† <code>PyFunction_Code</code>ï¼‰ã€‚<a href="https://github.com/PyO3/pyo3/pull/1387">#1387</a></li>
<li>ä¿®å¤ FFI å®šä¹‰ <code>PyMarshal_WriteObjectToString</code> å’Œ <code>PyMarshal_ReadObjectFromString</code>ï¼Œä½¿å…¶åœ¨æœ‰é™ API ä¸­å¯ç”¨ã€‚<a href="https://github.com/PyO3/pyo3/pull/1387">#1387</a></li>
<li>ä¿®å¤ FFI å®šä¹‰ <code>PyListObject</code> ä»¥åŠæ¥è‡ª <code>funcobject.h</code> çš„å®šä¹‰ï¼Œä½¿å…¶éœ€ä½¿ç”¨éæœ‰é™ APIã€‚<a href="https://github.com/PyO3/pyo3/pull/1387">#1387</a></li>
<li>ä¿®å¤ <code>pyobject_native_type_base</code> ä¸­æœªé™å®šçš„ <code>Result</code> ä½¿ç”¨ã€‚<a href="https://github.com/PyO3/pyo3/pull/1402">#1402</a></li>
<li>ä¿®å¤åœ¨é»˜è®¤ Python ç¼–ç ä¸æ˜¯ UTF-8 çš„ç³»ç»Ÿä¸Šçš„æ„å»ºé—®é¢˜ã€‚<a href="https://github.com/PyO3/pyo3/pull/1405">#1405</a></li>
<li>ä¿®å¤åœ¨ mingw / MSYS2 ä¸Šçš„æ„å»ºé—®é¢˜ã€‚<a href="https://github.com/PyO3/pyo3/pull/1423">#1423</a></li>
</ul>
<h2 id="0131---2021-01-10"><a class="header" href="#0131---2021-01-10">[0.13.1] - 2021-01-10</a></h2>
<h3 id="æ–°å¢-37"><a class="header" href="#æ–°å¢-37">æ–°å¢</a></h3>
<ul>
<li>åœ¨ Python 3.9 åŠä»¥ä¸Šç‰ˆæœ¬ä¸­ï¼Œä¸º <code>abi3</code> åŠŸèƒ½æ·»åŠ å¯¹ <code>#[pyclass(dict)]</code> å’Œ <code>#[pyclass(weakref)]</code> çš„æ”¯æŒã€‚<a href="https://github.com/PyO3/pyo3/pull/1342">#1342</a></li>
<li>ä¸º Python 3.7 åŠä»¥ä¸Šç‰ˆæœ¬æ·»åŠ  FFI å®šä¹‰ <code>PyOS_BeforeFork</code>ã€<code>PyOS_AfterFork_Parent</code> å’Œ <code>PyOS_AfterFork_Child</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/1348">#1348</a></li>
<li>æ·»åŠ  <code>auto-initialize</code> åŠŸèƒ½ï¼Œç”¨äºæ§åˆ¶ PyO3 æ˜¯å¦åº”è‡ªåŠ¨åˆå§‹åŒ–åµŒå…¥å¼ Python è§£é‡Šå™¨ã€‚å‡ºäºå…¼å®¹æ€§è€ƒè™‘ï¼Œè¯¥åŠŸèƒ½åœ¨ PyO3 0.13.1 ä¸­é»˜è®¤å¯ç”¨ï¼Œä½†ä» PyO3 0.14.0 å¼€å§‹å°†æ”¹ä¸ºé€‰æ‹©æ€§å¯ç”¨ã€‚<a href="https://github.com/PyO3/pyo3/pull/1347">#1347</a></li>
<li>æ·»åŠ å¯¹æ— éœ€ <code>PYO3_CROSS_INCLUDE_DIR</code> å³å¯äº¤å‰ç¼–è¯‘åˆ° Windows çš„æ”¯æŒã€‚<a href="https://github.com/PyO3/pyo3/pull/1350">#1350</a></li>
</ul>
<h3 id="å·²å¼ƒç”¨"><a class="header" href="#å·²å¼ƒç”¨">å·²å¼ƒç”¨</a></h3>
<ul>
<li>åœ¨ä¸º Python 3.9 æ„å»ºæ—¶ï¼Œå¼ƒç”¨ FFI å®šä¹‰ <code>PyEval_CallObjectWithKeywords</code>ã€<code>PyEval_CallObject</code>ã€<code>PyEval_CallFunction</code> å’Œ <code>PyEval_CallMethod</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/1338">#1338</a></li>
<li>å¼ƒç”¨ä»æœªå­˜åœ¨äº Python API ä¸­çš„ FFI å®šä¹‰ <code>PyGetSetDef_DICT</code> å’Œ <code>PyGetSetDef_INIT</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/1341">#1341</a></li>
<li>å¼ƒç”¨ FFI å®šä¹‰ <code>PyGen_NeedsFinalizing</code>ã€<code>PyImport_Cleanup</code>ï¼ˆå·²åœ¨ 3.9 ä¸­ç§»é™¤ï¼‰å’Œ <code>PyOS_InitInterrupts</code>ï¼ˆ3.10ï¼‰ã€‚<a href="https://github.com/PyO3/pyo3/pull/1348">#1348</a></li>
<li>ä¸º Python 3.7 åŠä»¥ä¸Šç‰ˆæœ¬å¼ƒç”¨ FFI å®šä¹‰ <code>PyOS_AfterFork</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/1348">#1348</a></li>
<li>å¼ƒç”¨ FFI å®šä¹‰ <code>PyCoro_Check</code>ã€<code>PyAsyncGen_Check</code> å’Œ <code>PyCoroWrapper_Check</code>ï¼Œè¿™äº›ä»æœªå‡ºç°åœ¨ Python API ä¸­ï¼ˆå¯¹äºå‰ä¸¤ä¸ªï¼Œå¯ä»¥ä½¿ç”¨ <code>PyCoro_CheckExact</code> å’Œ <code>PyAsyncGen_CheckExact</code> æ›¿ä»£ï¼›è¿™äº›æ‰æ˜¯ Python API å®é™…æä¾›çš„å‡½æ•°ï¼‰ã€‚<a href="https://github.com/PyO3/pyo3/pull/1348">#1348</a></li>
<li>å›  <a href="https://www.python.org/dev/peps/pep-0623/">PEP 623</a>ï¼Œå¼ƒç”¨å°†ä» Python 3.12 åŠä»¥ä¸Šç‰ˆæœ¬ä¸­ç§»é™¤çš„ <code>PyUnicode_FromUnicode</code>ã€<code>PyUnicode_AsUnicode</code> å’Œ <code>PyUnicode_AsUnicodeAndSize</code> çš„ FFI å®šä¹‰ã€‚<a href="https://github.com/PyO3/pyo3/pull/1370">#1370</a></li>
</ul>
<h3 id="å·²ç§»é™¤-5"><a class="header" href="#å·²ç§»é™¤-5">å·²ç§»é™¤</a></h3>
<ul>
<li>ä¸º Python 3.9 æ„å»ºæ—¶ï¼Œç§»é™¤ FFI å®šä¹‰ <code>PyFrame_ClearFreeList</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/1341">#1341</a></li>
<li>ä¸º Python 3.10 æ„å»ºæ—¶ï¼Œç§»é™¤ FFI å®šä¹‰ <code>_PyDict_Contains</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/1341">#1341</a></li>
<li>ç§»é™¤ FFI å®šä¹‰ <code>PyGen_NeedsFinalizing</code> å’Œ <code>PyImport_Cleanup</code>ï¼ˆé€‚ç”¨äº 3.9 åŠä»¥ä¸Šï¼‰ï¼Œä»¥åŠ <code>PyOS_InitInterrupts</code>ï¼ˆ3.10ï¼‰ã€‚<a href="https://github.com/PyO3/pyo3/pull/1348">#1348</a></li>
</ul>
<h3 id="ä¿®å¤-34"><a class="header" href="#ä¿®å¤-34">ä¿®å¤</a></h3>
<ul>
<li>å½“ Python 3.8 åŠä»¥ä¸Šç‰ˆæœ¬ä¸­è®¾ç½®äº† <code>Py_DEBUG</code> æ—¶ï¼Œä¸å†è‡ªåŠ¨åŒ…å« <code>Py_TRACE_REFS</code> é…ç½®è®¾ç½®ã€‚<a href="https://github.com/PyO3/pyo3/pull/1334">#1334</a></li>
<li>ç§»é™¤ <code>#[deny(warnings)]</code> å±æ€§ï¼ˆè½¬è€Œä»…åœ¨ CI ä¸­æ‹’ç»è­¦å‘Šï¼‰ã€‚<a href="https://github.com/PyO3/pyo3/pull/1340">#1340</a></li>
<li>ä¿®å¤ <code>#[pyclass]</code> ä¸­ç¼ºå°‘ <code>__module__</code> å¼•å‘çš„å¼ƒç”¨è­¦å‘Šã€‚<a href="https://github.com/PyO3/pyo3/pull/1343">#1343</a></li>
<li>å°† <code>PyFrozenSet::empty</code> çš„è¿”å›ç±»å‹ä¿®æ­£ä¸º <code>&amp;PyFrozenSet</code>ï¼ˆä¹‹å‰é”™è¯¯åœ°ä¸º <code>&amp;PySet</code>ï¼‰ã€‚<a href="https://github.com/PyO3/pyo3/pull/1351">#1351</a></li>
<li>ä¿®å¤åœ¨ 3.8 ä»¥ä¸‹ç‰ˆæœ¬ Python ä¸­å¯¹å †ç±»å‹å¯¹è±¡ç¼ºå°‘ <code>Py_INCREF</code> çš„é—®é¢˜ã€‚<a href="https://github.com/PyO3/pyo3/pull/1365">#1365</a></li>
</ul>
<h2 id="0130---2020-12-22"><a class="header" href="#0130---2020-12-22">[0.13.0] - 2020-12-22</a></h2>
<h3 id="æ‰“åŒ…-28"><a class="header" href="#æ‰“åŒ…-28">æ‰“åŒ…</a></h3>
<ul>
<li>åœæ­¢æ”¯æŒ Python 3.5ï¼ˆå› å…¶å·²åœæ­¢ç»´æŠ¤ï¼‰ã€‚<a href="https://github.com/PyO3/pyo3/pull/1250">#1250</a></li>
<li>å°†æœ€ä½æ”¯æŒçš„ Rust ç‰ˆæœ¬æå‡è‡³ 1.45ã€‚<a href="https://github.com/PyO3/pyo3/pull/1272">#1272</a></li>
<li>å°† indoc ä¾èµ–ç‰ˆæœ¬æå‡è‡³ 1.0ã€‚<a href="https://github.com/PyO3/pyo3/pull/1272">#1272</a></li>
<li>å°† paste ä¾èµ–ç‰ˆæœ¬æå‡è‡³ 1.0ã€‚<a href="https://github.com/PyO3/pyo3/pull/1272">#1272</a></li>
<li>å°†å†…éƒ¨ crate <code>pyo3cls</code> å’Œ <code>pyo3-derive-backend</code> é‡å‘½åä¸º <code>pyo3-macros</code> å’Œ <code>pyo3-macros-backend</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/1317">#1317</a></li>
</ul>
<h3 id="æ–°å¢-38"><a class="header" href="#æ–°å¢-38">æ–°å¢</a></h3>
<ul>
<li>æ·»åŠ å¯¹æ„å»º CPython æœ‰é™ API çš„æ”¯æŒã€‚å¯ç”¨æœ‰é™ API åï¼Œä½¿ç”¨ PyO3 æ„å»ºçš„å•ä¸€æ‰©å±• wheel å¯å®‰è£…åˆ°å¤šä¸ª Python ç‰ˆæœ¬ä¸Šã€‚è¿™éœ€è¦å¯¹ PyO3 <code>#[pyclass]</code> ç±»å‹çš„è¿è¡Œæ—¶è¡Œä¸ºè¿›è¡Œä¸€äº›ç»†å¾®è°ƒæ•´ã€‚è¯¦è§è¿ç§»æŒ‡å—ã€‚<a href="https://github.com/PyO3/pyo3/pull/1152">#1152</a>
<ul>
<li>æ·»åŠ åŠŸèƒ½æ ‡å¿— <code>abi3-py36</code>ã€<code>abi3-py37</code>ã€<code>abi3-py38</code> ç­‰ï¼Œä»¥åœ¨ä½¿ç”¨æœ‰é™ API æ—¶è®¾å®šæœ€ä½ Python ç‰ˆæœ¬ã€‚<a href="https://github.com/PyO3/pyo3/pull/1263">#1263</a></li>
</ul>
</li>
<li>ä¸º pymethod åŒ…è£…å™¨ç”Ÿæˆçš„ <code>TypeError</code> æ¶ˆæ¯æ·»åŠ å‚æ•°åç§°ã€‚<a href="https://github.com/PyO3/pyo3/pull/1212">#1212</a></li>
<li>æ·»åŠ  PEP 587 â€œPython åˆå§‹åŒ–é…ç½®â€çš„ FFI å®šä¹‰ã€‚<a href="https://github.com/PyO3/pyo3/pull/1247">#1247</a></li>
<li>æ·»åŠ  <code>PyEval_SetProfile</code> å’Œ <code>PyEval_SetTrace</code> çš„ FFI å®šä¹‰ã€‚<a href="https://github.com/PyO3/pyo3/pull/1255">#1255</a></li>
<li>æ·»åŠ  context.h å‡½æ•°çš„ FFI å®šä¹‰ï¼ˆå¦‚ <code>PyContext_New</code> ç­‰ï¼‰ã€‚<a href="https://github.com/PyO3/pyo3/pull/1259">#1259</a></li>
<li>æ·»åŠ  <code>PyAny::is_instance</code> æ–¹æ³•ã€‚<a href="https://github.com/PyO3/pyo3/pull/1276">#1276</a></li>
<li>æ·»åŠ  <code>char</code> å’Œ <code>PyString</code> ä¹‹é—´çš„è½¬æ¢æ”¯æŒã€‚<a href="https://github.com/PyO3/pyo3/pull/1282">#1282</a></li>
<li>æ·»åŠ  <code>PyBuffer_SizeFromFormat</code>ã€<code>PyObject_LengthHint</code>ã€<code>PyObject_CallNoArgs</code>ã€<code>PyObject_CallOneArg</code>ã€<code>PyObject_CallMethodNoArgs</code>ã€<code>PyObject_CallMethodOneArg</code>ã€<code>PyObject_VectorcallDict</code> å’Œ <code>PyObject_VectorcallMethod</code> çš„ FFI å®šä¹‰ã€‚<a href="https://github.com/PyO3/pyo3/pull/1287">#1287</a></li>
<li>ä¸º PyPy æ·»åŠ  <code>u128</code>/<code>i128</code> ä¸ <code>PyLong</code> ä¹‹é—´çš„è½¬æ¢æ”¯æŒã€‚<a href="https://github.com/PyO3/pyo3/pull/1310">#1310</a></li>
<li>æ·»åŠ  <code>Python::version</code> å’Œ <code>Python::version_info</code> æ–¹æ³•ä»¥è·å–è¿è¡Œä¸­çš„è§£é‡Šå™¨ç‰ˆæœ¬ã€‚<a href="https://github.com/PyO3/pyo3/pull/1322">#1322</a></li>
<li>æ·»åŠ å¯¹é•¿åº¦ä¸º 10ã€11 å’Œ 12 çš„å…ƒç»„çš„è½¬æ¢æ”¯æŒã€‚<a href="https://github.com/PyO3/pyo3/pull/1454">#1454</a></li>
</ul>
<h3 id="æ›´æ”¹-20"><a class="header" href="#æ›´æ”¹-20">æ›´æ”¹</a></h3>
<ul>
<li>å°† <code>PyType::name</code> çš„è¿”å›ç±»å‹ç”± <code>Cow&lt;str&gt;</code> æ”¹ä¸º <code>PyResult&lt;&amp;str&gt;</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/1152">#1152</a></li>
<li>ç°åœ¨ä» Rust è¿›è¡Œå­ç±»åŒ–æ—¶å¿…é¡»ä½¿ç”¨ <code>#[pyclass(subclass)]</code>ï¼ˆä»¥å‰ä»…åœ¨ä» Python å­ç±»åŒ–æ—¶è¦æ±‚ï¼‰ã€‚<a href="https://github.com/PyO3/pyo3/pull/1152">#1152</a></li>
<li>ä¿®æ”¹ <code>PyIterator</code> ä»¥ä¿æŒä¸å…¶ä»–åŸç”Ÿç±»å‹çš„ä¸€è‡´æ€§ï¼šç°åœ¨ä½¿ç”¨ <code>&amp;PyIterator</code> è€Œé <code>PyIterator&lt;'a&gt;</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/1176">#1176</a></li>
<li>è°ƒæ•´ <code>PyDowncastError</code> æ¶ˆæ¯çš„æ ¼å¼ï¼Œä½¿å…¶æ›´æ¥è¿‘ Python å†…ç½®çš„é”™è¯¯æ¶ˆæ¯ã€‚<a href="https://github.com/PyO3/pyo3/pull/1212">#1212</a></li>
<li>ä¿®æ”¹ <code>PyException</code> çš„ <code>Debug</code> å’Œ <code>Display</code> å®ç°ï¼Œä½¿å…¶ä¸ <code>PyAny</code> ä¿æŒä¸€è‡´ã€‚<a href="https://github.com/PyO3/pyo3/pull/1275">#1275</a>- æ›´æ”¹ <code>PyErr</code> çš„ <code>Debug</code> å®ç°ä»¥è¾“å‡ºæ›´æœ‰ç”¨çš„ä¿¡æ¯ï¼ˆå¦‚æœ‰å¿…è¦ï¼Œè·å– GILï¼‰ã€‚<a href="https://github.com/PyO3/pyo3/pull/1275">#1275</a></li>
<li>å°† <code>PyTypeInfo::is_instance</code> å’Œ <code>PyTypeInfo::is_exact_instance</code> é‡å‘½åä¸º <code>PyTypeInfo::is_type_of</code> å’Œ <code>PyTypeInfo::is_exact_type_of</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/1278">#1278</a></li>
<li>åœ¨ Python 3.9 åŠä»¥ä¸Šç‰ˆæœ¬ä¸­ä¼˜åŒ– <code>PyAny::call0</code>ã€<code>Py::call0</code>ã€<code>PyAny::call_method0</code> å’Œ <code>Py::call_method0</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/1285">#1287</a></li>
<li>è¦æ±‚ pyclass çš„åç§°å‚æ•°ä½¿ç”¨åŒå¼•å·ï¼Œä¾‹å¦‚ <code>#[pyclass(name = "MyClass")]</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/1303">#1303</a></li>
</ul>
<h3 id="å·²å¼ƒç”¨-1"><a class="header" href="#å·²å¼ƒç”¨-1">å·²å¼ƒç”¨</a></h3>
<ul>
<li>å¼ƒç”¨ <code>Python::is_instance</code>ã€<code>Python::is_subclass</code>ã€<code>Python::release</code> å’Œ <code>Python::xdecref</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/1292">#1292</a></li>
</ul>
<h3 id="å·²ç§»é™¤-6"><a class="header" href="#å·²ç§»é™¤-6">å·²ç§»é™¤</a></h3>
<ul>
<li>ç§»é™¤å·²å¼ƒç”¨çš„ FFI å®šä¹‰ <code>PyUnicode_AsUnicodeCopy</code>ã€<code>PyUnicode_GetMax</code>ã€<code>_Py_CheckRecursionLimit</code>ã€<code>PyObject_AsCharBuffer</code>ã€<code>PyObject_AsReadBuffer</code>ã€<code>PyObject_CheckReadBuffer</code> å’Œ <code>PyObject_AsWriteBuffer</code>ï¼Œè¿™äº›å°†åœ¨ Python 3.10 ä¸­è¢«ç§»é™¤ã€‚<a href="https://github.com/PyO3/pyo3/pull/1217">#1217</a></li>
<li>ç§»é™¤æœªä½¿ç”¨çš„ <code>python3</code> åŠŸèƒ½ã€‚<a href="https://github.com/PyO3/pyo3/pull/1235">#1235</a></li>
</ul>
<h3 id="ä¿®å¤-35"><a class="header" href="#ä¿®å¤-35">ä¿®å¤</a></h3>
<ul>
<li>ä¿®å¤ <code>PyCodeObject</code> ç»“æ„ä½“ä¸­ç¼ºå¤±çš„å­—æ®µï¼ˆ<code>co_posonlyargcount</code>ï¼‰ï¼Œè¯¥é—®é¢˜åœ¨ Python &gt;3.7 ä¸­å¯¼è‡´å…¶ä»–å­—æ®µè®¿é—®æ— æ•ˆã€‚<a href="https://github.com/PyO3/pyo3/pull/1260">#1260</a></li>
<li>ä¿®å¤ä» <code>x86_64-unknown-linux-gnu</code> ä¸»æœºå‘ <code>x86_64-unknown-linux-musl</code> ç›®æ ‡æ„å»ºçš„é—®é¢˜ã€‚<a href="https://github.com/PyO3/pyo3/pull/1267">#1267</a></li>
<li>ä¿®å¤ <code>#[text_signature]</code> ä¸ Rust çš„ <code>r#raw_identifiers</code> ä¸å…¼å®¹çš„é—®é¢˜ã€‚<a href="https://github.com/PyO3/pyo3/pull/1286">#1286</a></li>
<li>ä¿®å¤ <code>PyObject_Vectorcall</code> å’Œ <code>PyVectorcall_Call</code> çš„ FFI å®šä¹‰ã€‚<a href="https://github.com/PyO3/pyo3/pull/1285">#1287</a></li>
<li>ä¿®å¤åœ¨ virtualenv ä¸­ä½¿ç”¨ Anaconda Python æ„å»ºçš„é—®é¢˜ã€‚<a href="https://github.com/PyO3/pyo3/pull/1290">#1290</a></li>
<li>ä¿®å¤ä¸é€æ˜ FFI ç±»å‹çš„å®šä¹‰ã€‚<a href="https://github.com/PyO3/pyo3/pull/1312">#1312</a></li>
<li>ä¿®å¤åœ¨ pyclass çš„ <code>#[new]</code> æ–¹æ³•ä¸­ä½¿ç”¨è‡ªå®šä¹‰é”™è¯¯ç±»å‹çš„é—®é¢˜ã€‚<a href="https://github.com/PyO3/pyo3/pull/1319">#1319</a></li>
</ul>
<h2 id="0124---2020-11-28"><a class="header" href="#0124---2020-11-28">[0.12.4] - 2020-11-28</a></h2>
<h3 id="ä¿®å¤-36"><a class="header" href="#ä¿®å¤-36">ä¿®å¤</a></h3>
<ul>
<li>ä¿®å¤ <code>From&lt;Py&lt;T&gt;&gt;</code> for <code>PyObject</code> å®ç°ä¸­çš„å¼•ç”¨è®¡æ•°é”™è¯¯ï¼Œæ­¤é—®é¢˜æ˜¯ PyO3 0.12 ç‰ˆæœ¬å¼•å…¥çš„å›å½’é—®é¢˜ã€‚<a href="https://github.com/PyO3/pyo3/pull/1297">#1297</a></li>
</ul>
<h2 id="0123---2020-10-12"><a class="header" href="#0123---2020-10-12">[0.12.3] - 2020-10-12</a></h2>
<h3 id="ä¿®å¤-37"><a class="header" href="#ä¿®å¤-37">ä¿®å¤</a></h3>
<ul>
<li>ä¿®å¤å› åœ¨ PyO3 0.12.2 ä¸­é”™è¯¯åœ°å†…éƒ¨æ›´æ–°åˆ° paste 1.0 è€Œå¯¼è‡´çš„ Rust 1.39 è‡³ 1.44 ç‰ˆæœ¬æ”¯æŒé—®é¢˜ã€‚<a href="https://github.com/PyO3/pyo3/pull/1234">#1234</a></li>
</ul>
<h2 id="0122---2020-10-12"><a class="header" href="#0122---2020-10-12">[0.12.2] - 2020-10-12</a></h2>
<h3 id="æ–°å¢-39"><a class="header" href="#æ–°å¢-39">æ–°å¢</a></h3>
<ul>
<li>åœ¨ <code>#[pyfunction]</code> ä¸­æ”¯æŒæ— é»˜è®¤å€¼çš„å…³é”®å­—é™å®šå‚æ•°ã€‚<a href="https://github.com/PyO3/pyo3/pull/1209">#1209</a></li>
<li>æ·»åŠ  <code>Python::check_signals</code>ï¼Œä½œä¸º <code>PyErr_CheckSignals</code> çš„å®‰å…¨åŒ…è£…å™¨ã€‚<a href="https://github.com/PyO3/pyo3/pull/1214">#1214</a></li>
</ul>
<h3 id="ä¿®å¤-38"><a class="header" href="#ä¿®å¤-38">ä¿®å¤</a></h3>
<ul>
<li>ä¿®å¤åè®®æ–¹æ³•æ–‡æ¡£ä¸æ­£ç¡®çš„é—®é¢˜ã€‚<a href="https://github.com/PyO3/pyo3/pull/1169">#1169</a></li>
<li>éšè— <code>pyo3::class::methods</code> ä¸­ PyO3 ç§æœ‰å®ç°ç»†èŠ‚çš„æ–‡æ¡£ã€‚<a href="https://github.com/PyO3/pyo3/pull/1169">#1169</a></li>
<li>ä¿®å¤å½“ Python è§£é‡Šå™¨ç”± PYO3_PYTHON æä¾›æ—¶ï¼ŒPATH å˜åŒ–å¯¼è‡´ä¸å¿…è¦çš„é‡æ–°æ„å»ºé—®é¢˜ã€‚<a href="https://github.com/PyO3/pyo3/pull/1231">#1231</a></li>
</ul>
<h2 id="0121---2020-09-16"><a class="header" href="#0121---2020-09-16">[0.12.1] - 2020-09-16</a></h2>
<h3 id="ä¿®å¤-39"><a class="header" href="#ä¿®å¤-39">ä¿®å¤</a></h3>
<ul>
<li>ä¿®å¤åœ¨ 64 ä½ Windows ä¸Šä½¿ç”¨ 64 ä½ Rust å·¥å…·é“¾ä¸º 32 ä½ Python æ„å»ºçš„é—®é¢˜ã€‚<a href="https://github.com/PyO3/pyo3/pull/1179">#1179</a></li>
<li>ä¿®å¤åœ¨ <code>c_char</code> ä¸º <code>u8</code> çš„å¹³å°ä¸Šæ„å»ºçš„é—®é¢˜ã€‚<a href="https://github.com/PyO3/pyo3/pull/1182">#1182</a></li>
</ul>
<h2 id="0120---2020-09-12"><a class="header" href="#0120---2020-09-12">[0.12.0] - 2020-09-12</a></h2>
<h3 id="æ–°å¢-40"><a class="header" href="#æ–°å¢-40">æ–°å¢</a></h3>
<ul>
<li>æ·»åŠ  FFI å®šä¹‰ <code>Py_FinalizeEx</code>ã€<code>PyOS_getsig</code> å’Œ <code>PyOS_setsig</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/1021">#1021</a></li>
<li>æ·»åŠ  <code>PyString::to_str</code> ä»¥å°† <code>PyString</code> ä½œä¸º <code>&amp;str</code> è®¿é—®ã€‚<a href="https://github.com/PyO3/pyo3/pull/1023">#1023</a></li>
<li>æ·»åŠ  <code>Python::with_gil</code>ï¼Œç”¨äºåœ¨æŒæœ‰ Python GIL çš„æƒ…å†µä¸‹æ‰§è¡Œé—­åŒ…ã€‚<a href="https://github.com/PyO3/pyo3/pull/1037">#1037</a></li>
<li>åœ¨ <code>PyAny::downcast</code> ä¸­æ·»åŠ ç±»å‹ä¿¡æ¯åˆ°å¤±è´¥ä¿¡æ¯ä¸­ã€‚<a href="https://github.com/PyO3/pyo3/pull/1050">#1050</a></li>
<li>ä¸º <code>PyIterator</code> å®ç° <code>Debug</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/1051">#1051</a></li>
<li>æ·»åŠ  <code>PyBytes::new_with</code> å’Œ <code>PyByteArray::new_with</code>ï¼Œç”¨äºé€šè¿‡é—­åŒ…åˆå§‹åŒ– <code>bytes</code> å’Œ <code>bytearray</code> å¯¹è±¡ã€‚<a href="https://github.com/PyO3/pyo3/pull/1074">#1074</a></li>
<li>æ·»åŠ ç”¨äºæšä¸¾å’Œç»“æ„ä½“çš„ <code>#[derive(FromPyObject)]</code> å®ã€‚<a href="https://github.com/PyO3/pyo3/pull/1065">#1065</a></li>
<li>æ·»åŠ  <code>Py::as_ref</code> å’Œ <code>Py::into_ref</code>ï¼Œç”¨äºå°† <code>Py&lt;T&gt;</code> è½¬æ¢ä¸º <code>&amp;T</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/1098">#1098</a></li>
<li>æ·»åŠ ä» <code>#[pyfunction]</code>ã€<code>#[pymethod]</code> å’Œ <code>#[pyproto]</code> å‡½æ•°è¿”å›é™¤ <code>PyResult</code> ä¹‹å¤–çš„ <code>Result</code> ç±»å‹çš„èƒ½åŠ›ã€‚<a href="https://github.com/PyO3/pyo3/pull/1118">#1106</a></li>
<li>ä¸º <a href="https://crates.io/crates/hashbrown">hashbrown</a> çš„ <code>HashMap</code> å’Œ <code>HashSet</code> ç±»å‹å®ç° <code>ToPyObject</code>ã€<code>IntoPy</code> å’Œ <code>FromPyObject</code>ï¼ˆéœ€è¦ <code>hashbrown</code> åŠŸèƒ½ï¼‰ã€‚<a href="https://github.com/PyO3/pyo3/pull/1114">#1114</a></li>
<li>æ·»åŠ  <code>#[pyfunction(pass_module)]</code> å’Œ <code>#[pyfn(pass_module)]</code>ï¼Œä»¥ä¾¿å°†æ¨¡å—å¯¹è±¡ä½œä¸ºç¬¬ä¸€ä¸ªå‡½æ•°å‚æ•°ä¼ é€’ã€‚<a href="https://github.com/PyO3/pyo3/pull/1143">#1143</a></li>
<li>æ·»åŠ  <code>PyModule::add_function</code> å’Œ <code>PyModule::add_submodule</code>ï¼Œä½œä¸º <code>PyModule::add_wrapped</code> çš„ç±»å‹å®‰å…¨æ›¿ä»£æ–¹æ¡ˆã€‚<a href="https://github.com/PyO3/pyo3/pull/1143">#1143</a></li>
<li>æ·»åŠ åŸç”Ÿçš„ <code>PyCFunction</code> å’Œ <code>PyFunction</code> ç±»å‹ã€‚<a href="https://github.com/PyO3/pyo3/pull/1163">#1163</a></li>
</ul>
<h3 id="å˜æ›´-12"><a class="header" href="#å˜æ›´-12">å˜æ›´</a></h3>
<ul>
<li>é‡æ„å¼‚å¸¸ç±»å‹ï¼š<a href="https://github.com/PyO3/pyo3/pull/1024">#1024</a> <a href="https://github.com/PyO3/pyo3/pull/1115">#1115</a>
<ul>
<li>å°†å¼‚å¸¸ç±»å‹ä»ä¾‹å¦‚ <code>RuntimeError</code> é‡å‘½åä¸º <code>PyRuntimeError</code>ã€‚æ—§åç§°ä»å­˜åœ¨ä½†å·²è¢«å¼ƒç”¨ã€‚</li>
<li>å¼‚å¸¸å¯¹è±¡ç°åœ¨å¯ä»¥åƒå…¶ä»– Python åŸç”Ÿç±»å‹ä¸€æ ·ä½œä¸º <code>&amp;T</code> æˆ– <code>Py&lt;T&gt;</code> è®¿é—®ã€‚</li>
<li>å°† <code>PyException::py_err</code> é‡å‘½åä¸º <code>PyException::new_err</code>ã€‚</li>
<li>å°† <code>PyUnicodeDecodeErr::new_err</code> é‡å‘½åä¸º <code>PyUnicodeDecodeErr::new</code>ã€‚</li>
<li>ç§»é™¤ <code>PyStopIteration::stop_iteration</code>ã€‚</li>
</ul>
</li>
<li>è¦æ±‚ <code>Python::allow_threads</code> çš„è¿”å›å€¼ <code>T</code> æ»¡è¶³ <code>T: Send</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/1036">#1036</a></li>
<li>å°† <code>PYTHON_SYS_EXECUTABLE</code> é‡å‘½åä¸º <code>PYO3_PYTHON</code>ã€‚æ—§åç§°ä¼šç»§ç»­å·¥ä½œï¼ˆæ— æ–‡æ¡£ï¼‰ï¼Œä½†å°†åœ¨æœªæ¥ç‰ˆæœ¬ä¸­ç§»é™¤ã€‚<a href="https://github.com/PyO3/pyo3/pull/1039">#1039</a></li>
<li>ä» <code>PyType::as_type_ptr</code> çš„ç­¾åä¸­ç§»é™¤ <code>unsafe</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/1047">#1047</a></li>
<li>å°† <code>PyIterator::from_object</code> çš„è¿”å›ç±»å‹æ”¹ä¸º <code>PyResult&lt;PyIterator&gt;</code>ï¼ˆåŸæ¥æ˜¯ <code>Result&lt;PyIterator, PyDowncastError&gt;</code>ï¼‰ã€‚<a href="https://github.com/PyO3/pyo3/pull/1051">#1051</a></li>
<li><code>IntoPy</code> ä¸å†ç”± <code>FromPy</code> éšå¼æä¾›ã€‚<a href="https://github.com/PyO3/pyo3/pull/1063">#1063</a></li>
<li>å°† <code>PyObject</code> æ›´æ”¹ä¸º <code>Py&lt;PyAny&gt;</code> çš„ç±»å‹åˆ«åã€‚<a href="https://github.com/PyO3/pyo3/pull/1063">#1063</a></li>
<li>é‡æ„ <code>PyErr</code> ä»¥å…¼å®¹ <code>std::error::Error</code> traitï¼š<a href="https://github.com/PyO3/pyo3/pull/1067">#1067</a> <a href="https://github.com/PyO3/pyo3/pull/1115">#1115</a>
<ul>
<li>ä¸º <code>PyErr</code> å’Œ <code>PyErrArguments</code> å®ç° <code>Display</code>ã€<code>Error</code>ã€<code>Send</code> å’Œ <code>Sync</code>ã€‚</li>
<li>æ·»åŠ  <code>PyErr::instance</code> ä»¥å°† <code>PyErr</code> ä½œä¸º <code>&amp;PyBaseException</code> è®¿é—®ã€‚</li>
<li><code>PyErr</code> çš„å­—æ®µç°åœ¨æ˜¯å®ç°ç»†èŠ‚ï¼Œå¯é€šè¿‡ <code>PyErr::ptype</code>ã€<code>PyErr::pvalue</code> å’Œ <code>PyErr::ptraceback</code> è®¿é—®ç­‰ä»·å€¼ã€‚</li>
<li>å°† <code>PyErr::print</code> å’Œ <code>PyErr::print_and_set_sys_last_vars</code> çš„æ¥æ”¶å™¨æ”¹ä¸º <code>&amp;self</code>ï¼ˆåŸä¸º <code>self</code>ï¼‰ã€‚</li>
<li>ç§»é™¤ <code>PyErrValue</code>ã€<code>PyErr::from_value</code>ã€<code>PyErr::into_normalized</code> å’Œ <code>PyErr::normalize</code>ã€‚</li>
<li>ç§»é™¤ <code>PyException::into</code>ã€‚</li>
<li>ç§»é™¤ <code>PyErr</code> å’Œ <code>PyException</code> çš„ <code>Into&lt;PyResult&lt;T&gt;&gt;</code>ã€‚</li>
</ul>
</li>
<li>æ›´æ”¹ç”± <code>#[pyproto]</code> ç”Ÿæˆçš„æ–¹æ³•ï¼Œä½¿å…¶åœ¨ Python åº”å°è¯•åå‘æ“ä½œæ—¶è¿”å› <code>NotImplemented</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/1072">#1072</a></li>
<li>å°† <code>PyModule::add</code> çš„å‚æ•°æ›´æ”¹ä¸º <code>impl IntoPy&lt;PyObject&gt;</code>ï¼ˆåŸä¸º <code>impl ToPyObject</code>ï¼‰ã€‚<a href="https://github.com/PyO3/pyo3/pull/1124">#1124</a></li>
</ul>
<h3 id="å·²ç§»é™¤-7"><a class="header" href="#å·²ç§»é™¤-7">å·²ç§»é™¤</a></h3>
<ul>
<li>ç§»é™¤è®¸å¤šå¼‚å¸¸å’Œ <code>PyErr</code> çš„ APIï¼›è¯·å‚é˜…ä¸Šæ–¹â€œå˜æ›´â€éƒ¨åˆ†ã€‚<a href="https://github.com/PyO3/pyo3/pull/1024">#1024</a> <a href="https://github.com/PyO3/pyo3/pull/1067">#1067</a> <a href="https://github.com/PyO3/pyo3/pull/1115">#1115</a></li>
<li>ç§»é™¤ <code>PyString::to_string</code>ï¼ˆä½¿ç”¨æ–°çš„ <code>PyString::to_str</code>ï¼‰ã€‚<a href="https://github.com/PyO3/pyo3/pull/1023">#1023</a></li>
<li>ç§»é™¤ <code>PyString::as_bytes</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/1023">#1023</a></li>
<li>ç§»é™¤ <code>Python::register_any</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/1023">#1023</a></li>
<li>ä»å…¬å…± API ä¸­ç§»é™¤ <code>GILGuard::acquire</code>ã€‚è¯·ä½¿ç”¨ <code>Python::acquire_gil</code> æˆ– <code>Python::with_gil</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/1036">#1036</a></li>
<li>ç§»é™¤ <code>FromPy</code> traitã€‚<a href="https://github.com/PyO3/pyo3/pull/1063">#1063</a></li>
<li>ç§»é™¤ <code>AsPyRef</code> traitã€‚<a href="https://github.com/PyO3/pyo3/pull/1098">#1098</a></li>
</ul>
<h3 id="ä¿®å¤-40"><a class="header" href="#ä¿®å¤-40">ä¿®å¤</a></h3>
<ul>
<li>ä¿®æ­£ FFI å®šä¹‰ <code>Py_SetProgramName</code> å’Œ <code>Py_SetPythonHome</code> çš„å‚æ•°ä¸º <code>*const</code>ï¼ˆåŸä¸º <code>*mut</code>ï¼‰ã€‚<a href="https://github.com/PyO3/pyo3/pull/1021">#1021</a></li>
<li>ä¿®å¤ <code>FromPyObject</code> å¯¹ <code>num_bigint::BigInt</code> åœ¨å…·æœ‰ <code>__index__</code> æ–¹æ³•çš„ Python å¯¹è±¡ä¸Šçš„ä½¿ç”¨ã€‚<a href="https://github.com/PyO3/pyo3/pull/1027">#1027</a></li>
<li>ä¿®æ­£ FFI å®šä¹‰ <code>_PyLong_AsByteArray</code> çš„å‚æ•°ä¸º <code>*mut c_uchar</code>ï¼ˆåŸä¸º <code>*const c_uchar</code>ï¼‰ã€‚<a href="https://github.com/PyO3/pyo3/pull/1029">#1029</a></li>
<li>ä¿®å¤ <code>#[pyclass(dict, unsendable)]</code> å¯¼è‡´çš„æ®µé”™è¯¯ã€‚<a href="https://github.com/PyO3/pyo3/pull/1058">#1058</a> <a href="https://github.com/PyO3/pyo3/pull/1059">#1059</a></li>
<li>ä¿®å¤åœ¨ <code>#[pymethods]</code> å—ä¸­å°† <code>&amp;Self</code> ç”¨ä½œå‡½æ•°å‚æ•°ç±»å‹çš„é—®é¢˜ã€‚<a href="https://github.com/PyO3/pyo3/pull/1071">#1071</a></li>
<li>ä¿®å¤å°½åŠ›æ”¯æŒé’ˆå¯¹ PyPy 3.6 çš„æ„å»ºã€‚<a href="https://github.com/PyO3/pyo3/pull/1092">#1092</a></li>
<li>ä¿®å¤ <code>#[pyproto]</code> å®ç°ä¸­çš„è®¸å¤šç”Ÿå‘½å‘¨æœŸçœç•¥é—®é¢˜ã€‚<a href="https://github.com/PyO3/pyo3/pull/1093">#1093</a></li>
<li>ä¿®å¤äº¤å‰ç¼–è¯‘æ—¶ Python æ„å»ºé…ç½®çš„æ£€æµ‹é—®é¢˜ã€‚<a href="https://github.com/PyO3/pyo3/pull/1095">#1095</a></li>
<li>åœ¨ä½¿ç”¨ <code>extension-module</code> åŠŸèƒ½æ—¶ï¼Œå§‹ç»ˆåœ¨ Android ä¸Šé“¾æ¥ libpythonã€‚<a href="https://github.com/PyO3/pyo3/pull/1095">#1095</a></li>
<li>ä¿®å¤ <code>+</code> æ“ä½œç¬¦åœ¨ <code>PyNumberProtocol</code> ä¸­åŒæ—¶å®šä¹‰ <code>__add__</code> å’Œ <code>__radd__</code> æ—¶ä¸ä¼šå°è¯• <code>__radd__</code> çš„é—®é¢˜ï¼ˆå…¶ä»–å¯é€†æ“ä½œç¬¦åŒç†ï¼‰ã€‚<a href="https://github.com/PyO3/pyo3/pull/1107">#1107</a></li>
<li>ä¿®å¤ä½¿ç”¨ Anaconda Python æ„å»ºçš„é—®é¢˜ã€‚<a href="https://github.com/PyO3/pyo3/pull/1175">#1175</a></li>
</ul>
<h2 id="0111---2020-06-30"><a class="header" href="#0111---2020-06-30">[0.11.1] - 2020-06-30</a></h2>
<h3 id="æ–°å¢--pyclassunsendable1009"><a class="header" href="#æ–°å¢--pyclassunsendable1009">æ–°å¢- <code>#[pyclass(unsendable)]</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/1009">#1009</a></a></h3>
<h3 id="å˜æ›´-13"><a class="header" href="#å˜æ›´-13">å˜æ›´</a></h3>
<ul>
<li>å°† <code>parking_lot</code> ä¾èµ–é¡¹æ›´æ–°è‡³ <code>0.11</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/1010">#1010</a></li>
</ul>
<h2 id="0110---2020-06-28"><a class="header" href="#0110---2020-06-28">[0.11.0] - 2020-06-28</a></h2>
<h3 id="æ–°å¢-41"><a class="header" href="#æ–°å¢-41">æ–°å¢</a></h3>
<ul>
<li>æ”¯æŒç¨³å®šçš„ Rust ç‰ˆæœ¬ï¼ˆ&gt;=1.39ï¼‰ã€‚<a href="https://github.com/PyO3/pyo3/pull/969">#969</a></li>
<li>æ·»åŠ  FFI å®šä¹‰ <code>PyObject_AsFileDescriptor</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/938">#938</a></li>
<li>æ·»åŠ  <code>PyByteArray::data</code>ã€<code>PyByteArray::as_bytes</code> å’Œ <code>PyByteArray::as_bytes_mut</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/967">#967</a></li>
<li>æ·»åŠ  <code>GILOnceCell</code>ï¼Œç”¨äº <code>lazy_static</code> æˆ– <code>once_cell</code> å¯èƒ½å‘ç”Ÿæ­»é”çš„åœºæ™¯ã€‚<a href="https://github.com/PyO3/pyo3/pull/975">#975</a></li>
<li>ä¸ºè®¿é—® <code>#[pyclass]</code> å€¼ï¼Œæ·»åŠ  <code>Py::borrow</code>ã€<code>Py::borrow_mut</code>ã€<code>Py::try_borrow</code> å’Œ <code>Py::try_borrow_mut</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/976">#976</a></li>
<li>æ·»åŠ  <code>IterNextOutput</code> å’Œ <code>IterANextOutput</code>ï¼Œç”¨äºä» <code>__next__</code> / <code>__anext__</code> è¿”å›ã€‚<a href="https://github.com/PyO3/pyo3/pull/997">#997</a></li>
</ul>
<h3 id="å˜æ›´-14"><a class="header" href="#å˜æ›´-14">å˜æ›´</a></h3>
<ul>
<li>ç®€åŒ– <code>#[pyo3(get)]</code> å±æ€§çš„å†…éƒ¨å®ç°ã€‚ï¼ˆåˆ é™¤éšè— API <code>GetPropertyValue</code>ã€‚ï¼‰<a href="https://github.com/PyO3/pyo3/pull/934">#934</a></li>
<li>é€€å‡ºæ—¶è°ƒç”¨ <code>Py_Finalize</code> ä»¥åˆ·æ–°ç¼“å†²åŒºç­‰ã€‚<a href="https://github.com/PyO3/pyo3/pull/943">#943</a></li>
<li>ä¸º <code>PyBuffer</code> æ·»åŠ ç±»å‹å‚æ•°ã€‚<a href="https://github.com/PyO3/pyo3/pull/951">#951</a></li>
<li>ä¸º <code>#[pyclass]</code> è¦æ±‚ <code>Send</code> boundã€‚<a href="https://github.com/PyO3/pyo3/pull/966">#966</a></li>
<li>ä¸º <code>PyObject</code> å’Œ <code>Py&lt;T&gt;</code> çš„å¤§å¤šæ•°æ–¹æ³•æ·»åŠ  <code>Python</code> å‚æ•°ï¼Œä»¥ç¡®ä¿ GIL å®‰å…¨ã€‚<a href="https://github.com/PyO3/pyo3/pull/970">#970</a></li>
<li>æ›´æ”¹ <code>PyTypeObject::type_object</code> çš„ç­¾åâ€”â€”ç°åœ¨æ¥å— <code>Python</code> å‚æ•°å¹¶è¿”å› <code>&amp;PyType</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/970">#970</a></li>
<li>å°† <code>PyTuple::slice</code> å’Œ <code>PyTuple::split_from</code> çš„è¿”å›ç±»å‹ä» <code>Py&lt;PyTuple&gt;</code> æ›´æ”¹ä¸º <code>&amp;PyTuple</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/970">#970</a></li>
<li>å°† <code>PyTuple::as_slice</code> çš„è¿”å›ç±»å‹æ›´æ”¹ä¸º <code>&amp;[&amp;PyAny]</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/971">#971</a></li>
<li>å°† <code>PyTypeInfo::type_object</code> é‡å‘½åä¸º <code>type_object_raw</code>ï¼Œå¹¶æ·»åŠ  <code>Python</code> å‚æ•°ã€‚<a href="https://github.com/PyO3/pyo3/pull/975">#975</a></li>
<li>å°† <code>num-complex</code> å¯é€‰ä¾èµ–é¡¹ä» <code>0.2</code> æ›´æ–°è‡³ <code>0.3</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/977">#977</a></li>
<li>å°† <code>num-bigint</code> å¯é€‰ä¾èµ–é¡¹ä» <code>0.2</code> æ›´æ–°è‡³ <code>0.3</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/978">#978</a></li>
<li><code>#[pyproto]</code> é‡æ–°å®ç°ï¼Œä¸å†ä½¿ç”¨ç‰¹åŒ–ã€‚<a href="https://github.com/PyO3/pyo3/pull/961">#961</a></li>
<li>å°† <code>PyClassAlloc::alloc</code> é‡å‘½åä¸º <code>PyClassAlloc::new</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/990">#990</a></li>
<li><code>#[pyproto]</code> æ–¹æ³•ç°åœ¨å¯è¿”å› <code>T</code> æˆ– <code>PyResult&lt;T&gt;</code>ï¼ˆæ­¤å‰ä»…æ”¯æŒ <code>PyResult&lt;T&gt;</code>ï¼‰ã€‚<a href="https://github.com/PyO3/pyo3/pull/996">#996</a></li>
<li>è‹¥è¿”å›ç±»å‹ä¸º <code>()</code>ï¼Œ<code>#[pyproto]</code> æ–¹æ³•ç°åœ¨å¯çœç•¥è¿”å›ç±»å‹çš„æ³¨è§£ã€‚<a href="https://github.com/PyO3/pyo3/pull/998">#998</a></li>
</ul>
<h3 id="ç§»é™¤-8"><a class="header" href="#ç§»é™¤-8">ç§»é™¤</a></h3>
<ul>
<li>ç§»é™¤ <code>ManagedPyRef</code>ï¼ˆæœªä½¿ç”¨ï¼Œä¸”éœ€è¦ç‰¹åŒ–ï¼‰<a href="https://github.com/PyO3/pyo3/pull/930">#930</a></li>
</ul>
<h3 id="ä¿®å¤-41"><a class="header" href="#ä¿®å¤-41">ä¿®å¤</a></h3>
<ul>
<li>ä¿®å¤å‘å¸¦æœ‰é»˜è®¤å€¼çš„ <code>#[pyfunction]</code> ä¸­çš„ <code>Option&lt;T&gt;</code> å‚æ•°æ˜¾å¼ä¼ é€’ <code>None</code> çš„é—®é¢˜ã€‚<a href="https://github.com/PyO3/pyo3/pull/936">#936</a></li>
<li>ä¿®å¤ <code>PyClass.__new__</code> åœ¨ Python ç±»ç»§æ‰¿æ—¶æœªèƒ½æ­£ç¡®å¤„ç†å­ç±»çš„é—®é¢˜ã€‚<a href="https://github.com/PyO3/pyo3/pull/990">#990</a></li>
<li>ä¿®å¤ä» <code>#[pyproto]</code> æ–¹æ³•è¿”å› <code>Option&lt;T&gt;</code> çš„é—®é¢˜ã€‚<a href="https://github.com/PyO3/pyo3/pull/996">#996</a></li>
<li>ä¿®å¤ <code>#[getter]</code> å’Œ <code>#[setter]</code> æ–¹æ³•æ¥å— <code>PyRef&lt;Self&gt;</code> å’Œ <code>PyRefMut&lt;Self&gt;</code> çš„é—®é¢˜ã€‚<a href="https://github.com/PyO3/pyo3/pull/999">#999</a></li>
</ul>
<h2 id="0101---2020-05-14"><a class="header" href="#0101---2020-05-14">[0.10.1] - 2020-05-14</a></h2>
<h3 id="ä¿®å¤-42"><a class="header" href="#ä¿®å¤-42">ä¿®å¤</a></h3>
<ul>
<li>ä¿®å¤åœ¨ä¸¢å¼ƒ <code>PyObject</code> æˆ– <code>Py&lt;T&gt;</code> åè°ƒç”¨ <code>Python::acquire_gil</code> æ—¶çš„æ­»é”é—®é¢˜ã€‚<a href="https://github.com/PyO3/pyo3/pull/924">#924</a></li>
</ul>
<h2 id="0100---2020-05-13"><a class="header" href="#0100---2020-05-13">[0.10.0] - 2020-05-13</a></h2>
<h3 id="æ–°å¢-42"><a class="header" href="#æ–°å¢-42">æ–°å¢</a></h3>
<ul>
<li>æ·»åŠ  FFI å®šä¹‰ <code>_PyDict_NewPresized</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/849">#849</a></li>
<li>ä¸º <code>HashSet</code> å’Œ <code>BTreeSet</code> å®ç° <code>IntoPy&lt;PyObject&gt;</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/864">#864</a></li>
<li>æ·»åŠ  <code>PyAny::dir</code> æ–¹æ³•ã€‚<a href="https://github.com/PyO3/pyo3/pull/886">#886</a></li>
<li>å°†å®ç½®äº <code>macros</code> åŠŸèƒ½ä¸‹ï¼ˆé»˜è®¤å¯ç”¨ï¼‰ã€‚<a href="https://github.com/PyO3/pyo3/pull/897">#897</a></li>
<li>åœ¨ <code>#[pymethods]</code> ä¸­ä½¿ç”¨ <code>#[classattr]</code> å‡½æ•°å®šä¹‰ç±»å±æ€§ã€‚<a href="https://github.com/PyO3/pyo3/pull/905">#905</a></li>
<li>ä¸º <code>PyObject</code> å’Œ <code>Py&lt;T&gt;</code> å®ç° <code>Clone</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/908">#908</a></li>
<li>ä¸ºæ‰€æœ‰å†…ç½®ç±»å‹ï¼ˆ<code>PyList</code>ã€<code>PyTuple</code>ã€<code>PyDict</code> ç­‰ï¼‰å®ç° <code>Deref&lt;Target = PyAny&gt;</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/911">#911</a></li>
<li>ä¸º <code>PyCell&lt;T&gt;</code> å®ç° <code>Deref&lt;Target = PyAny&gt;</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/911">#911</a></li>
<li>åœ¨ <code>#[pymethods]</code> ä¸­çš„å…³è”å¸¸é‡ä¸Šæ”¯æŒ <code>#[classattr]</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/914">#914</a></li>
</ul>
<h3 id="å˜æ›´-15"><a class="header" href="#å˜æ›´-15">å˜æ›´</a></h3>
<ul>
<li>ç°åœ¨ï¼Œææ…Œï¼ˆpanicsï¼‰å°†ä½œä¸º Python çš„ <code>PanicException</code> è¢«æŠ›å‡ºã€‚<a href="https://github.com/PyO3/pyo3/pull/797">#797</a></li>
<li>æ›´æ”¹ <code>PyObject</code> å’Œ <code>Py&lt;T&gt;</code> çš„å¼•ç”¨è®¡æ•°è¡Œä¸ºï¼Œå½“æŒæœ‰ GIL æ—¶ï¼Œç«‹å³åœ¨ <code>drop</code> æ—¶é€’å‡ã€‚<a href="https://github.com/PyO3/pyo3/pull/851">#851</a></li>
<li>å…è®¸ <code>PyIterProtocol</code> æ–¹æ³•ä½¿ç”¨ <code>PyRef</code> æˆ– <code>PyRefMut</code> ä½œä¸ºæ¥æ”¶å™¨ç±»å‹ã€‚<a href="https://github.com/PyO3/pyo3/pull/856">#856</a></li>
<li>æ›´æ”¹ <code>FromPyObject</code> å¯¹ <code>Py&lt;T&gt;</code> çš„å®ç°ï¼Œä»¥é€‚ç”¨äºæ›´å¹¿æ³›çš„ <code>T</code>ï¼ŒåŒ…æ‹¬æ‰€æœ‰ <code>T: PyClass</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/880">#880</a></li>
<li>å°† <code>ObjectProtocol</code> trait çš„æ‰€æœ‰æ–¹æ³•ç§»è‡³ <code>PyAny</code> ç»“æ„ä½“ã€‚<a href="https://github.com/PyO3/pyo3/pull/911">#911</a></li>
<li>ç§»é™¤ä¾èµ– PyO3 çš„ crate ä¸­å¯¹ <code>#![feature(specialization)]</code> çš„éœ€æ±‚ã€‚<a href="https://github.com/PyO3/pyo3/pull/917">#917</a></li>
</ul>
<h3 id="ç§»é™¤-9"><a class="header" href="#ç§»é™¤-9">ç§»é™¤</a></h3>
<ul>
<li>ç§»é™¤ <code>PyMethodsProtocol</code> traitã€‚<a href="https://github.com/PyO3/pyo3/pull/889">#889</a></li>
<li>ç§»é™¤ <code>num-traits</code> ä¾èµ–ã€‚<a href="https://github.com/PyO3/pyo3/pull/895">#895</a></li>
<li>ç§»é™¤ <code>ObjectProtocol</code> traitã€‚<a href="https://github.com/PyO3/pyo3/pull/911">#911</a></li>
<li>ç§»é™¤ <code>PyAny::None</code>ã€‚ç”¨æˆ·åº”æ”¹ç”¨ <code>Python::None</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/911">#911</a></li>
<li>ç§»é™¤æ‰€æœ‰ <code>*ProtocolImpl</code> traitsã€‚<a href="https://github.com/PyO3/pyo3/pull/917">#917</a></li>
</ul>
<h3 id="ä¿®å¤-43"><a class="header" href="#ä¿®å¤-43">ä¿®å¤</a></h3>
<ul>
<li>ä¿®å¤ <code>__radd__</code> åŠå…¶ä»– <code>__r*__</code> æ–¹æ³•ä½œä¸º Python æ•°å­¦è¿ç®—ç¬¦å®ç°çš„æ”¯æŒã€‚<a href="https://github.com/PyO3/pyo3/pull/839">#839</a></li>
<li>ä¿®å¤åœ¨åƒåœ¾å›æ”¶æœŸé—´éå†å·²è¢«å¯å˜å€Ÿç”¨çš„å¯¹è±¡æ—¶å‘ç”Ÿçš„ææ…Œã€‚<a href="https://github.com/PyO3/pyo3/pull/855">#855</a></li>
<li>é˜²æ­¢åœ¨ <code>#[pyfunction]</code> å’Œ <code>#[pymethods]</code> ä¸­å°† <code>&amp;'static</code> å¼•ç”¨ä½œä¸º Python å¯¹è±¡å‚æ•°ã€‚<a href="https://github.com/PyO3/pyo3/pull/869">#869</a></li>
<li>ä¿®å¤ <code>AsPyRef::as_ref</code> çš„ç”Ÿå‘½å‘¨æœŸå®‰å…¨æ¼æ´ã€‚<a href="https://github.com/PyO3/pyo3/pull/876">#876</a></li>
<li>ä¿®å¤ä½œç”¨äº <code>Py&lt;T&gt;</code> å­—æ®µçš„ <code>#[pyo3(get)]</code> å±æ€§ã€‚<a href="https://github.com/PyO3/pyo3/pull/880">#880</a></li>
<li>ä¿®å¤å›  <code>PyList::get_item</code> ç­‰å‡½æ•°åœ¨ä¸å®‰å…¨çš„æƒ…å†µä¸‹è¿”å›å€Ÿç”¨å¯¹è±¡è€Œå¼•èµ·çš„æ®µé”™è¯¯ã€‚<a href="https://github.com/PyO3/pyo3/pull/890">#890</a></li>
<li>ä¿®å¤åµŒå¥—è°ƒç”¨ <code>Python::acquire_gil</code> äº§ç”Ÿæ‚¬å‚å¼•ç”¨å¯¼è‡´çš„æ®µé”™è¯¯ã€‚<a href="https://github.com/PyO3/pyo3/pull/893">#893</a></li>
<li>ä¿®å¤åœ¨è°ƒç”¨ <code>Python::allow_threads</code> æœŸé—´å‘ç”Ÿææ…Œå¯¼è‡´çš„æ®µé”™è¯¯ã€‚<a href="https://github.com/PyO3/pyo3/pull/912">#912</a></li>
</ul>
<h2 id="092---2020-04-09"><a class="header" href="#092---2020-04-09">[0.9.2] - 2020-04-09</a></h2>
<h3 id="æ–°å¢-43"><a class="header" href="#æ–°å¢-43">æ–°å¢</a></h3>
<ul>
<li>ä¸º <code>HashSet</code> å’Œ <code>BTreeSet</code> æ·»åŠ  <code>FromPyObject</code> å®ç°ã€‚<a href="https://github.com/PyO3/pyo3/pull/842">#842</a></li>
</ul>
<h3 id="ä¿®å¤-44"><a class="header" href="#ä¿®å¤-44">ä¿®å¤</a></h3>
<ul>
<li>æ­£ç¡®æ£€æµ‹ 32 ä½æ¶æ„ã€‚<a href="https://github.com/PyO3/pyo3/pull/830">#830</a></li>
</ul>
<h2 id="091---2020-03-23"><a class="header" href="#091---2020-03-23">[0.9.1] - 2020-03-23</a></h2>
<h3 id="ä¿®å¤-45"><a class="header" href="#ä¿®å¤-45">ä¿®å¤</a></h3>
<ul>
<li><code>#[pyclass]</code> çš„é”™è¯¯æ¶ˆæ¯ã€‚<a href="https://github.com/PyO3/pyo3/pull/826">#826</a></li>
<li><code>PySequence</code> çš„ <code>FromPyObject</code> å®ç°ã€‚<a href="https://github.com/PyO3/pyo3/pull/827">#827</a></li>
</ul>
<h2 id="090---2020-03-19"><a class="header" href="#090---2020-03-19">[0.9.0] - 2020-03-19</a></h2>
<h3 id="æ–°å¢-44"><a class="header" href="#æ–°å¢-44">æ–°å¢</a></h3>
<ul>
<li><code>PyCell</code>ï¼Œå…·æœ‰ç±»ä¼¼ <code>RefCell</code> çš„åŠŸèƒ½ã€‚<a href="https://github.com/PyO3/pyo3/pull/770">#770</a></li>
<li><code>PyClass</code>ã€<code>PyLayout</code>ã€<code>PyClassInitializer</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/683">#683</a></li>
<li>ä¸º <code>PySet</code> å’Œ <code>PyFrozenSet</code> å®ç° <code>IntoIterator</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/716">#716</a></li>
<li>ç°åœ¨ï¼Œå¯¹äºå®ç° <code>Clone</code> çš„ pyclass <code>T</code>ï¼Œè‡ªåŠ¨å®ç° <code>FromPyObject</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/730">#730</a></li>
<li><code>#[pyo3(get)]</code> å’Œ <code>#[pyo3(set)]</code> ç°åœ¨ä¼šä½¿ç”¨å­—æ®µçš„ Rust æ–‡æ¡£æ³¨é‡Šä½œä¸º Python å±æ€§çš„æ–‡æ¡£ã€‚<a href="https://github.com/PyO3/pyo3/pull/755">#755</a></li>
<li><code>#[setter]</code> å‡½æ•°ç°åœ¨å¯ä»¥æ¥å— <code>Pyo3::Python</code> å‚æ•°ã€‚<a href="https://github.com/PyO3/pyo3/pull/760">#760</a></li>
<li><code>PyTypeInfo::BaseLayout</code> å’Œ <code>PyClass::BaseNativeType</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/770">#770</a></li>
<li><code>PyDowncastImpl</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/770">#770</a></li>
<li>ä¸ºæ•°ç»„ï¼ˆæœ€å¤š 32 ä¸ªï¼‰å®ç° <code>FromPyObject</code> å’Œ <code>IntoPy&lt;PyObject&gt;</code> traitsã€‚<a href="https://github.com/PyO3/pyo3/pull/778">#778</a></li>
<li>æŒ‡å—ä¸­æ·»åŠ äº† <code>migration.md</code> å’Œ <code>types.md</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/795">#795</a>ï¼Œ<a href="https://github.com/PyO3/pyo3/pull/802">#802</a></li>
<li><code>ffi::{_PyBytes_Resize, _PyDict_Next, _PyDict_Contains, _PyDict_GetDictPtr}</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/820">#820</a></li>
</ul>
<h3 id="å˜æ›´-16"><a class="header" href="#å˜æ›´-16">å˜æ›´</a></h3>
<ul>
<li><code>#[new]</code> ä¸å†æ¥æ”¶ <code>PyRawObject</code>ï¼Œä¸”å¯ç›´æ¥è¿”å› <code>Self</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/683">#683</a></li>
<li><code>FromPyObject</code> å¯¹ <code>&amp;T</code> å’Œ <code>&amp;mut T</code> çš„æ³›å‹å®ç°ä¸å†å¯ç‰¹åŒ–ã€‚è¯·ä¸ºæ‚¨çš„ç±»å‹å®ç° <code>PyTryFrom</code>ï¼Œä»¥æ§åˆ¶ <code>FromPyObject::extract</code> çš„è¡Œä¸ºã€‚<a href="https://github.com/PyO3/pyo3/pull/713">#713</a></li>
<li><code>IntoPy&lt;U&gt; for T</code>ï¼ˆå½“ <code>U: FromPy&lt;T&gt;</code> æ—¶ï¼‰çš„å®ç°ä¸å†å¯ç‰¹åŒ–ã€‚é€šè¿‡ <code>FromPy</code> çš„å®ç°æ¥æ§åˆ¶è¯¥è¡Œä¸ºã€‚<a href="https://github.com/PyO3/pyo3/pull/713">#713</a></li>
<li>ä½¿ç”¨ <code>parking_lot::Mutex</code> æ›¿ä»£ <code>spin::Mutex</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/734">#734</a></li>
<li>å°†æœ€ä½ Rust ç‰ˆæœ¬æå‡è‡³ <code>1.42.0-nightly 2020-01-21</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/761">#761</a></li>
<li><code>PyRef</code> å’Œ <code>PyRefMut</code> ä¸º <code>PyCell</code> é‡æ–°è®¾è®¡ã€‚<a href="https://github.com/PyO3/pyo3/pull/770">#770</a></li>
<li>ä¸º Python 3.8 æ·»åŠ äº†ä¸€äº›æ–°çš„ FFI å‡½æ•°ã€‚<a href="https://github.com/PyO3/pyo3/pull/784">#784</a></li>
<li><code>PyAny</code> ç°åœ¨ä½äºé¡¶å±‚æ¨¡å—å’Œ prelude ä¸­ã€‚<a href="https://github.com/PyO3/pyo3/pull/816">#816</a></li>
</ul>
<h3 id="ç§»é™¤-10"><a class="header" href="#ç§»é™¤-10">ç§»é™¤</a></h3>
<ul>
<li><code>PyRawObject</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/683">#683</a></li>
<li><code>PyNoArgsFunction</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/741">#741</a>- <code>initialize_type</code>ã€‚è¦ä¸º <code>#[pyclass]</code> è®¾ç½®æ¨¡å—åï¼Œè¯·åœ¨å®ä¸­ä½¿ç”¨ <code>module</code> å‚æ•°ã€‚<a href="https://github.com/PyO3/pyo3/pull/751">#751</a></li>
<li><code>AsPyRef::as_mut/with/with_mut/into_py/into_mut_py</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/770">#770</a></li>
<li><code>PyTryFrom::try_from_mut/try_from_mut_exact/try_from_mut_unchecked</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/770">#770</a></li>
<li><code>Python::mut_from_owned_ptr/mut_from_borrowed_ptr</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/770">#770</a></li>
<li><code>ObjectProtocol::get_base/get_mut_base</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/770">#770</a></li>
</ul>
<h3 id="å·²ä¿®å¤-17"><a class="header" href="#å·²ä¿®å¤-17">å·²ä¿®å¤</a></h3>
<ul>
<li>ä¿®å¤äº†å­ç±»åŒ–çš„ä¸å®‰å…¨é—®é¢˜ã€‚<a href="https://github.com/PyO3/pyo3/pull/683">#683</a></li>
<li>å½“å¼‚å¸¸åœ¨ Rust ä¾§è¢«å¤„ç†æ—¶ï¼Œæ¸…é™¤é”™è¯¯æŒ‡ç¤ºå™¨ã€‚<a href="https://github.com/PyO3/pyo3/pull/719">#719</a></li>
<li>åœ¨ <code>#[pyo3(set)]</code> ä¸­ä½¿ç”¨åŸå§‹æ ‡è¯†ç¬¦çš„é—®é¢˜ã€‚<a href="https://github.com/PyO3/pyo3/pull/745">#745</a></li>
<li>åœ¨ <code>#[pyo3(get)]</code> ä¸­ä½¿ç”¨ <code>PyObject</code> çš„é—®é¢˜ã€‚<a href="https://github.com/PyO3/pyo3/pull/760">#760</a></li>
<li><code>#[pymethods]</code> ä¸ <code>#[cfg]</code> ä¸€èµ·ä½¿ç”¨çš„é—®é¢˜ã€‚<a href="https://github.com/PyO3/pyo3/pull/769">#769</a></li>
<li><code>#[pyfunction()]</code> å‚æ•°åˆ—è¡¨ä¸­çš„ <code>"*"</code> é”™è¯¯åœ°æ¥å—ä»»æ„æ•°é‡çš„ä½ç½®å‚æ•°ï¼ˆå¦‚éœ€æ­¤è¡Œä¸ºï¼Œè¯·ä½¿ç”¨ <code>args = "*"</code>ï¼‰ã€‚<a href="https://github.com/PyO3/pyo3/pull/792">#792</a></li>
<li><code>PyModule::dict</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/809">#809</a></li>
<li>ä¿®å¤ <code>DESCRIPTION</code> æœªä»¥ null ç»“å°¾çš„æƒ…å†µã€‚<a href="https://github.com/PyO3/pyo3/pull/822">#822</a></li>
</ul>
<h2 id="085---2020-01-05"><a class="header" href="#085---2020-01-05">[0.8.5] - 2020-01-05</a></h2>
<h3 id="æ–°å¢-45"><a class="header" href="#æ–°å¢-45">æ–°å¢</a></h3>
<ul>
<li>ä¸º <code>HashMap</code> å’Œ <code>BTreeMap</code> å®ç° <code>FromPyObject</code></li>
<li>æ”¯æŒ <code>#[pyfunction]</code> å’Œ <code>#[pymethods]</code> ä¸­çš„ <code>#[name = "foo"]</code> å±æ€§ã€‚<a href="https://github.com/PyO3/pyo3/pull/692">#692</a></li>
</ul>
<h2 id="084---2019-12-14"><a class="header" href="#084---2019-12-14">[0.8.4] - 2019-12-14</a></h2>
<h3 id="æ–°å¢-46"><a class="header" href="#æ–°å¢-46">æ–°å¢</a></h3>
<ul>
<li>æ”¯æŒ <code>#[text_signature]</code> å±æ€§ã€‚<a href="https://github.com/PyO3/pyo3/pull/675">#675</a></li>
</ul>
<h2 id="083---2019-11-23"><a class="header" href="#083---2019-11-23">[0.8.3] - 2019-11-23</a></h2>
<h3 id="ç§»é™¤-11"><a class="header" href="#ç§»é™¤-11">ç§»é™¤</a></h3>
<ul>
<li>ç§»é™¤ <code>#[init]</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/658">#658</a></li>
</ul>
<h3 id="å·²ä¿®å¤-18"><a class="header" href="#å·²ä¿®å¤-18">å·²ä¿®å¤</a></h3>
<ul>
<li>ç°åœ¨æ‰€æœ‰ <code>&amp;Py~</code> ç±»å‹éƒ½æœ‰ <code>!Send</code> é™å®šã€‚<a href="https://github.com/PyO3/pyo3/pull/655">#655</a></li>
<li>ä¿®å¤å›  <code>!</code> ç±»å‹ç¨³å®šåŒ–å¯¼è‡´çš„ç¼–è¯‘é”™è¯¯ã€‚<a href="https://github.com/PyO3/pyo3/issues/672">#672</a>ã€‚</li>
</ul>
<h2 id="082---2019-10-27"><a class="header" href="#082---2019-10-27">[0.8.2] - 2019-10-27</a></h2>
<h3 id="æ–°å¢-47"><a class="header" href="#æ–°å¢-47">æ–°å¢</a></h3>
<ul>
<li>ä¸º PEP 590 Vectorcall æä¾› FFI å…¼å®¹æ€§ã€‚<a href="https://github.com/PyO3/pyo3/pull/641">#641</a></li>
</ul>
<h3 id="å·²ä¿®å¤-19"><a class="header" href="#å·²ä¿®å¤-19">å·²ä¿®å¤</a></h3>
<ul>
<li>ä¿®å¤ PySequenceProtocol::set_itemã€‚<a href="https://github.com/PyO3/pyo3/pull/624">#624</a></li>
<li>ä¿®å¤ BigInt::FromPyObject çš„ä¸€ä¸ªè¾¹ç•Œæƒ…å†µã€‚<a href="https://github.com/PyO3/pyo3/pull/630">#630</a></li>
<li>ä¿®å¤å‚æ•°è½¬æ¢ä¸­çš„ç´¢å¼•é”™è¯¯ã€‚<a href="https://github.com/PyO3/pyo3/pull/631">#631</a></li>
<li>ä¿®å¤ <code>PyString::as_bytes</code> ä¸­æ— æ•ˆ UTF-8 åºåˆ—çš„å¤„ç†ã€‚<a href="https://github.com/PyO3/pyo3/pull/639">#639</a> å’Œ <code>PyString::to_string_lossy</code> <a href="https://github.com/PyO3/pyo3/pull/642">#642</a></li>
<li>ä» PyMappingProtocol ä¸­ç§»é™¤ <code>__contains__</code> å’Œ <code>__iter__</code>ã€‚<a href="https://github.com/PyO3/pyo3/pull/644">#644</a></li>
<li>ä¿®å¤ PySetAttrProtocol çš„è¿‡ç¨‹å®å®šä¹‰ã€‚<a href="https://github.com/PyO3/pyo3/pull/645">#645</a></li>
</ul>
<h2 id="081---2019-10-08"><a class="header" href="#081---2019-10-08">[0.8.1] - 2019-10-08</a></h2>
<h3 id="æ–°å¢-48"><a class="header" href="#æ–°å¢-48">æ–°å¢</a></h3>
<ul>
<li>æ”¯æŒ <a href="https://github.com/rust-num/num-bigint">num-bigint</a> ä¸ Python int ä¹‹é—´çš„è½¬æ¢ã€‚<a href="https://github.com/PyO3/pyo3/pull/608">#608</a></li>
</ul>
<h3 id="å·²ä¿®å¤-20"><a class="header" href="#å·²ä¿®å¤-20">å·²ä¿®å¤</a></h3>
<ul>
<li>ç¡®ä¿åœ¨ macOS æ„å»ºä¸­ä½¿ç”¨æ­£ç¡®çš„ Python è§£é‡Šå™¨ã€‚<a href="https://github.com/PyO3/pyo3/pull/604">#604</a></li>
<li>ä¿®å¤å›  Rust 1.40 å¯¼è‡´çš„ç‰¹åŒ–åŠŸèƒ½å¤±æ•ˆé—®é¢˜ã€‚<a href="https://github.com/PyO3/pyo3/issues/614">#614</a></li>
<li>ä¿®å¤ä¸ PyErr ç›¸å…³çš„æ®µé”™è¯¯ã€‚<a href="https://github.com/PyO3/pyo3/pull/597">#597</a></li>
</ul>
<h2 id="080---2019-09-16"><a class="header" href="#080---2019-09-16">[0.8.0] - 2019-09-16</a></h2>
<h3 id="æ–°å¢-49"><a class="header" href="#æ–°å¢-49">æ–°å¢</a></h3>
<ul>
<li><code>pyclass</code> å®çš„ <code>module</code> å‚æ•°ã€‚<a href="https://github.com/PyO3/pyo3/pull/499">#499</a></li>
<li><code>py_run!</code> å®ã€‚<a href="https://github.com/PyO3/pyo3/pull/512">#512</a></li>
<li>åœ¨è°ƒç”¨è‡ªå®šä¹‰ <code>**getattr**</code> å‰ï¼Œä¼˜å…ˆä½¿ç”¨ç°æœ‰å­—æ®µå’Œæ–¹æ³•ã€‚<a href="https://github.com/PyO3/pyo3/pull/505">#505</a></li>
<li><code>PyBytes</code> ç°åœ¨å¯ä»¥åƒ <code>Vec&lt;u8&gt;</code> ä¸€æ ·è¢«ç´¢å¼•</li>
<li>ä¸º <code>PyRef</code> å’Œ <code>PyRefMut</code> å®ç° <code>IntoPy&lt;PyObject&gt;</code></li>
</ul>
<h3 id="æ›´æ”¹-21"><a class="header" href="#æ›´æ”¹-21">æ›´æ”¹</a></h3>
<ul>
<li>ä½¿ç”¨ <code>pyclass</code> çš„ <code>gc</code> å‚æ•°ï¼ˆä¾‹å¦‚ <code>#[pyclass(gc)]</code>ï¼‰ä½†æœªå®ç° <code>class::PyGCProtocol</code> trait æ—¶ï¼Œç°åœ¨ä¼šè§¦å‘ç¼–è¯‘æ—¶é”™è¯¯ã€‚æœªå®ç°æ­¤ trait å¯èƒ½å¯¼è‡´æ®µé”™è¯¯ã€‚<a href="https://github.com/PyO3/pyo3/pull/532">#532</a></li>
<li><code>PyByteArray::data</code> å·²è¢« <code>PyDataArray::to_vec</code> å–ä»£ï¼Œå› ä¸ºè¿”å› <code>&amp;[u8]</code> æ˜¯ä¸å®‰å…¨çš„ã€‚ï¼ˆå‚è§ <a href="https://github.com/PyO3/pyo3/issues/373#issuecomment-512332696">æ­¤è¯„è®º</a> äº†è§£åŸå› ï¼‰</li>
<li>ç”¨ <code>paste</code> æ›¿æ¢ <code>mashup</code></li>
<li><code>GILPool</code> å¢åŠ äº† <code>Python</code> æ ‡è®°ï¼Œä»¥é˜²æ­¢åœ¨æ²¡æœ‰æŒæœ‰ GIL çš„æƒ…å†µä¸‹é”™è¯¯é‡Šæ”¾ Python å¯¹è±¡</li>
</ul>
<h3 id="ç§»é™¤-12"><a class="header" href="#ç§»é™¤-12">ç§»é™¤</a></h3>
<ul>
<li><code>IntoPyObject</code> è¢« <code>IntoPy&lt;PyObject&gt;</code> æ›¿ä»£</li>
<li><code>#[pyclass(subclass)]</code> è¢«éšè—ï¼Œç§»è‡³ <code>unsound-subclass</code> ç‰¹æ€§ï¼Œå› ä¸ºå®ƒä¼šå¯¼è‡´æ®µé”™è¯¯</li>
</ul>
<h3 id="å·²ä¿®å¤-21"><a class="header" href="#å·²ä¿®å¤-21">å·²ä¿®å¤</a></h3>
<ul>
<li>ä¸º <code>pyclass</code> ä¸­çš„æ³›å‹æä¾›æ›´æ¸…æ™°çš„é”™è¯¯ä¿¡æ¯ <a href="https://github.com/PyO3/pyo3/pull/503">#503</a></li>
</ul>
<h2 id="070---2019-05-26"><a class="header" href="#070---2019-05-26">[0.7.0] - 2019-05-26</a></h2>
<h3 id="æ–°å¢-50"><a class="header" href="#æ–°å¢-50">æ–°å¢</a></h3>
<ul>
<li>omerbenamram åœ¨ <a href="https://github.com/PyO3/pyo3/pull/393">#393</a> ä¸­æ·»åŠ äº†å¯¹ PyPy çš„æ”¯æŒ</li>
<li><code>PyModule</code> ç°åœ¨ç”Ÿæˆå…¶æˆå‘˜çš„ç´¢å¼•ï¼ˆå³ <code>__all__</code> åˆ—è¡¨ï¼‰</li>
<li>å…è®¸ <code>pyclass</code> ä½¿ç”¨ <code>slf: PyRef&lt;T&gt;</code> (#419)</li>
<li>å…è®¸åœ¨ <code>pymethods</code> ä¸­ä½¿ç”¨ç”Ÿå‘½å‘¨æœŸè¯´æ˜ç¬¦</li>
<li>æ·»åŠ  <code>marshal</code> æ¨¡å—ã€‚<a href="https://github.com/PyO3/pyo3/pull/460">#460</a></li>
</ul>
<h3 id="æ›´æ”¹-22"><a class="header" href="#æ›´æ”¹-22">æ›´æ”¹</a></h3>
<ul>
<li><code>Python::run</code> è¿”å› <code>PyResult&lt;()&gt;</code> è€Œä¸æ˜¯ <code>PyResult&lt;&amp;PyAny&gt;</code></li>
<li>ä½¿ç”¨ <code>#[getter]</code> å’Œ <code>#[setter]</code> è£…é¥°çš„æ–¹æ³•ç°åœ¨å¯ä»¥çœç•¥å°†è¿”å›ç±»å‹åŒ…è£…åœ¨ <code>PyResult</code> ä¸­ï¼Œå¦‚æœå®ƒä»¬ä¸æŠ›å‡ºå¼‚å¸¸</li>
</ul>
<h3 id="å·²ä¿®å¤-22"><a class="header" href="#å·²ä¿®å¤-22">å·²ä¿®å¤</a></h3>
<ul>
<li><code>type_object::PyTypeObject</code> è¢«æ ‡è®°ä¸º <code>unsafe</code>ï¼Œå› ä¸ºè¿å <code>type_object::PyTypeObject::init_type</code> çº¦å®šå¯èƒ½å¯¼è‡´æœªå®šä¹‰è¡Œä¸º</li>
<li>åœ¨ <a href="https://github.com/PyO3/pyo3/pull/423">#423</a> ä¸­ä¿®å¤äº† <code>PySequenceProtocol</code> çš„è‡ªåŠ¨æ´¾ç”Ÿå®ç°</li>
<li>æ”¹è¿›äº† README.md çš„å¤§å°å†™å’Œæªè¾</li>
<li>å±æ€§çš„æ–‡æ¡£å­—ç¬¦ä¸²ç°åœ¨æ­£ç¡®åœ°ä½¿ç”¨ <code>#[getter]</code> æ–¹æ³•çš„æ–‡æ¡£è®¾ç½®</li>
<li>ä¿®å¤äº†åœ¨åŒ…å«åŒå¼•å·çš„æ–‡æ¡£æ³¨é‡Šä¸­ä½¿ç”¨ <code>pymethods</code> æ—¶å´©æºƒçš„é—®é¢˜</li>
<li><code>PySet::new</code> å’Œ <code>PyFrozenSet::new</code> ç°åœ¨è¿”å› <code>PyResult&lt;&amp;Py[Frozen]Set&gt;</code>ï¼›å¦‚æœå…ƒç´ ä¸å¯å“ˆå¸Œï¼Œåˆ™ä¼šæŠ›å‡ºå¼‚å¸¸</li>
<li>ä¿®å¤äº†åœ¨ Windows ä¸Šä½¿ç”¨ <code>venv</code> æ„å»ºçš„é—®é¢˜</li>
<li><code>PyTuple::new</code> ç°åœ¨è¿”å› <code>&amp;PyTuple</code> è€Œä¸æ˜¯ <code>Py&lt;PyTuple&gt;</code></li>
<li>ä¿®å¤äº†å¤šä¸ªå‚æ•°è§£æé—®é¢˜ï¼›å°¤å…¶ï¼Œ<code>*args</code> å’Œ <code>**kwargs</code> å…ƒç»„/å­—å…¸ç°åœ¨ä¸ä¼šåŒ…å«å·²åˆ†é…ç»™å…¶ä»–å‚æ•°çš„å€¼</li>
</ul>
<h2 id="060---2019-03-28"><a class="header" href="#060---2019-03-28">[0.6.0] - 2019-03-28</a></h2>
<h3 id="å›å½’é—®é¢˜"><a class="header" href="#å›å½’é—®é¢˜">å›å½’é—®é¢˜</a></h3>
<ul>
<li>ç›®å‰ï¼Œ<a href="https://github.com/PyO3/pyo3/issues/341">#341</a> å¯¼è‡´åœ¨å¯ç”¨ <code>extension-module</code> åŠŸèƒ½æ—¶ <code>cargo test</code> å› å¥‡æ€ªçš„é“¾æ¥é”™è¯¯è€Œå¤±è´¥ã€‚æš‚æ—¶å¯é€šè¿‡å°† <code>extension-module</code> åŠŸèƒ½è®¾ä¸ºå¯é€‰ï¼Œå¹¶ä½¿ç”¨ <code>cargo test --no-default-features</code> è¿è¡Œæµ‹è¯•æ¥è§„é¿ï¼š</li>
</ul>
<pre><code class="language-toml">[dependencies.pyo3]
version = "0.6.0"

[features]
extension-module = ["pyo3/extension-module"]
default = ["extension-module"]
</code></pre>
<h3 id="æ–°å¢-51"><a class="header" href="#æ–°å¢-51">æ–°å¢</a></h3>
<ul>
<li>æ·»åŠ äº†ç±»ä¼¼äº <code>wrap_pyfunction!</code> çš„ <code>wrap_pymodule!</code> å®ã€‚ä»…åœ¨ Python 3 ä¸Šå¯ç”¨</li>
<li>mtp401 åœ¨ <a href="https://github.com/PyO3/pyo3/pull/327">#327</a> ä¸­æ·»åŠ äº†å¯¹äº¤å‰ç¼–è¯‘ï¼ˆä¾‹å¦‚åˆ° arm v7ï¼‰çš„æ”¯æŒã€‚è¯¦è§æŒ‡å—ä¸­â€œæ„å»ºä¸å‘å¸ƒâ€ç« èŠ‚çš„â€œäº¤å‰ç¼–è¯‘â€éƒ¨åˆ†</li>
<li><code>PyRef</code> å’Œ <code>PyRefMut</code> ç±»å‹ï¼Œç”¨äºåŒºåˆ†ä½äº Rust å †ä¸Šçš„ Rust ç»“æ„å®ä¾‹ä¸åµŒå…¥åœ¨ Python å¯¹è±¡ä¸­çš„å®ä¾‹ã€‚ç”± kngwyu åœ¨ <a href="https://github.com/PyO3/pyo3/pull/335">#335</a> ä¸­æ·»åŠ </li>
<li>æ·»åŠ  <code>FromPy&lt;T&gt;</code> å’Œ <code>IntoPy&lt;T&gt;</code>ï¼Œå®ƒä»¬ç­‰åŒäº <code>From&lt;T&gt;</code> å’Œ <code>Into&lt;T&gt;</code>ï¼Œä½†è¦æ±‚æä¾› GIL token</li>
<li>æ·»åŠ  <code>ManagedPyRef</code>ï¼Œå…¶æœ€ç»ˆå°†æ›¿ä»£ <code>ToBorrowedObject</code></li>
</ul>
<h3 id="æ›´æ”¹-23"><a class="header" href="#æ›´æ”¹-23">æ›´æ”¹</a></h3>
<ul>
<li>åœ¨ #388 ä¸­å°† <code>PyObjectRef</code> é‡å‘½åä¸º <code>PyAny</code></li>
<li><code>add_function</code> é‡å‘½åä¸º <code>add_wrapped</code>ï¼Œå› ä¸ºå®ƒç°åœ¨ä¹Ÿæ”¯æŒæ¨¡å—</li>
<li><code>#[pymodinit]</code> é‡å‘½åä¸º <code>#[pymodule]</code></li>
<li><code>py.init(|| value)</code> å˜ä¸º <code>Py::new(value)</code></li>
<li><code>py.init_ref(|| value)</code> å˜ä¸º <code>PyRef::new(value)</code></li>
<li><code>py.init_mut(|| value)</code> å˜ä¸º <code>PyRefMut::new(value)</code></li>
<li><code>PyRawObject::init</code> ç°åœ¨æ˜¯æ— å¤±è´¥çš„ï¼Œå³è¿”å› <code>()</code> è€Œé <code>PyResult&lt;()&gt;</code></li>
<li><code>py_exception!</code> é‡å‘½åä¸º <code>create_exception!</code> å¹¶é‡æ„äº†é”™è¯¯å®</li>
<li><code>wrap_function!</code> é‡å‘½åä¸º <code>wrap_pyfunction!</code></li>
<li><code>#[prop(get, set)]</code> é‡å‘½åä¸º <code>#[pyo3(get, set)]</code></li>
<li><code>#[pyfunction]</code> ç°åœ¨æ”¯æŒä¸ <code>#[pyfn()]</code> ç›¸åŒçš„å‚æ•°</li>
<li>ä¸€äº›å®ç°åœ¨å‘å‡ºæ­£ç¡®çš„å¸¦ä½ç½®é”™è¯¯è€Œé panic</li>
<li>è¿ç§»åˆ° 2018 ç‰ˆ</li>
<li><code>crate::types::exceptions</code> ç§»è‡³ <code>crate::exceptions</code></li>
<li>ç”¨ <code>IntoPy&lt;Py&lt;PyTuple&gt;&gt;</code> æ›¿ä»£ <code>IntoPyTuple</code></li>
<li><code>IntoPyPointer</code> å’Œ <code>ToPyPointer</code> ç§»è‡³ crate æ ¹ç›®å½•</li>
<li><code>class::CompareOp</code> ç§»è‡³ <code>class::basic::CompareOp</code></li>
<li>PyTypeObject ç°ä¸º PyTypeCreate çš„ç›´æ¥å­ traitï¼Œç§»é™¤äº† <a href="https://github.com/PyO3/pyo3/pull/350">#350</a> ä¸­çš„å¾ªç¯å®ç°</li>
<li>chr1sj0nes åœ¨ <a href="https://github.com/PyO3/pyo3/pull/357">#357</a> å’Œ <a href="https://github.com/PyO3/pyo3/pull/358">#358</a> ä¸­æ·»åŠ  <code>PyList::{sort, reverse}</code></li>
<li>å°† <code>typeob</code> æ¨¡å—é‡å‘½åä¸º <code>type_object</code></li>
</ul>
<h3 id="ç§»é™¤-13"><a class="header" href="#ç§»é™¤-13">ç§»é™¤</a></h3>
<ul>
<li>ç”±äºä¸å®‰å…¨æ€§ç§»é™¤äº† <code>PyToken</code>ï¼ˆè§ <a href="https://github.com/PyO3/pyo3/issues/94">#94</a>ï¼‰</li>
<li>ç§»é™¤äº† <code>PyObjectAlloc</code> ä¸­ä¸å¿…è¦çš„ç±»å‹å‚æ•°</li>
<li><code>NoArgs</code>ã€‚è¯·ç›´æ¥ä½¿ç”¨ç©ºå…ƒç»„</li>
<li><code>PyObjectWithGIL</code>ã€‚ç°åœ¨ <code>PyNativeType</code> å·²è¶³å¤Ÿï¼Œå› ä¸º PyToken å·²è¢«ç§»é™¤</li>
</ul>
<h3 id="å·²ä¿®å¤-23"><a class="header" href="#å·²ä¿®å¤-23">å·²ä¿®å¤</a></h3>
<ul>
<li>ä¿®å¤äº† <code>#[pyclass]</code> ç»“æ„ä½“çš„æ¯ä¸ªå®ä¾‹éƒ½è¢«è§†ä¸º Python å¯¹è±¡ä¸€éƒ¨åˆ†çš„å®‰å…¨æ€§æ¼æ´ï¼Œå°½ç®¡å¯ä»¥åˆ›å»ºä¸åœ¨ Python å †ä¸­çš„å®ä¾‹ã€‚è¯¥é—®é¢˜é€šè¿‡ <code>PyRef</code> å’Œ <code>PyRefMut</code> å¾—åˆ°ä¿®å¤</li>
<li>åœ¨ <a href="https://github.com/PyO3/pyo3/pull/328">#328</a> ä¸­ä¿®å¤ kwargs æ”¯æŒ</li>
<li>åœ¨ <a href="https://github.com/PyO3/pyo3/pull/403">#403</a> ä¸­æ·»åŠ å¯¹ <code>__dict__</code> çš„å®Œæ•´æ”¯æŒ</li>
</ul>
<h2 id="053---2019-01-04"><a class="header" href="#053---2019-01-04">[0.5.3] - 2019-01-04</a></h2>
<h3 id="å·²ä¿®å¤-24"><a class="header" href="#å·²ä¿®å¤-24">å·²ä¿®å¤</a></h3>
<ul>
<li>kngwyu åœ¨ <a href="https://github.com/PyO3/pyo3/pull/316">#316</a> ä¸­ä¿®å¤ ArrayList çš„å†…å­˜æ³„æ¼é—®é¢˜</li>
</ul>
<h2 id="052---2018-11-25"><a class="header" href="#052---2018-11-25">[0.5.2] - 2018-11-25</a></h2>
<h3 id="å·²ä¿®å¤-25"><a class="header" href="#å·²ä¿®å¤-25">å·²ä¿®å¤</a></h3>
<ul>
<li>kngwyu åœ¨ <a href="https://github.com/PyO3/pyo3/pull/281">#281</a> ä¸­ä¿®å¤åˆ›å»ºå¤§é‡å¯¹è±¡æ—¶çš„ä¸ç¡®å®šæ®µé”™è¯¯é—®é¢˜</li>
</ul>
<h2 id="051---2018-11-24"><a class="header" href="#051---2018-11-24">[0.5.1] - 2018-11-24</a></h2>
<p>å·²æ’¤é”€å‘å¸ƒ</p>
<h2 id="050---2018-11-11"><a class="header" href="#050---2018-11-11">[0.5.0] - 2018-11-11</a></h2>
<h3 id="æ–°å¢-52"><a class="header" href="#æ–°å¢-52">æ–°å¢</a></h3>
<ul>
<li><code>#[pyclass]</code> å¯¹è±¡ç°åœ¨å¯ä» Rust å‡½æ•°ä¸­è¿”å›- <code>PyComplex</code>ï¼Œç”± kngwyu åœ¨ <a href="https://github.com/PyO3/pyo3/pull/226">#226</a> ä¸­å®ç°</li>
<li><code>PyDict::from_sequence</code>ï¼Œç­‰ä»·äº <code>dict([(key, val), ...])</code></li>
<li>ä¸ºæ ‡å‡†åº“ <code>datetime</code> ç±»å‹æä¾›ç»‘å®šï¼š<code>PyDate</code>ã€<code>PyTime</code>ã€<code>PyDateTime</code>ã€<code>PyTzInfo</code>ã€<code>PyDelta</code>ï¼Œå¹¶é™„å¸¦ç›¸åº”çš„ <code>ffi</code> ç±»å‹ï¼Œç”± pganssle åœ¨ <a href="https://github.com/PyO3/pyo3/pull/200">#200</a> ä¸­å®ç°</li>
<li><code>PyString</code>ã€<code>PyUnicode</code> å’Œ <code>PyBytes</code> ç°åœ¨æ‹¥æœ‰ <code>as_bytes</code> æ–¹æ³•ï¼Œè¿”å› <code>&amp;[u8]</code></li>
<li><code>PyObjectProtocol::get_type_ptr</code>ï¼Œç”± ijl åœ¨ <a href="https://github.com/PyO3/pyo3/pull/242">#242</a> ä¸­å®ç°</li>
</ul>
<h3 id="æ›´æ”¹-24"><a class="header" href="#æ›´æ”¹-24">æ›´æ”¹</a></h3>
<ul>
<li>å°†ç±»å‹ä»æ ¹æ¨¡å—å’Œé¢„å¯¼å…¥æ¨¡å—ï¼ˆpreludeï¼‰ä¸­ç§»é™¤ï¼Œç°å­˜æ”¾äº <code>pyo3::types</code> ä¸­</li>
<li>æ‰€æœ‰å¼‚å¸¸å‡ä½¿ç”¨ <code>py_err</code> è€Œé <code>new</code> æ„é€ ï¼Œå› ä¸ºå®ƒä»¬è¿”å› <code>PyErr</code> è€Œé <code>Self</code></li>
<li><code>as_mut</code> åŠå…¶ç›¸å…³æ–¹æ³•ç°åœ¨æ¥æ”¶ <code>&amp;mut self</code> è€Œé <code>&amp;self</code></li>
<li><code>ObjectProtocol::call</code> ç°åœ¨æ¥æ”¶ <code>Option&lt;&amp;PyDict&gt;</code> ä½œä¸º kwargs å‚æ•°ï¼Œè€Œé <code>IntoPyDictPointer</code></li>
<li><code>IntoPyDictPointer</code> è¢« <code>IntoPyDict</code> æ›¿ä»£ï¼Œåè€…ä¸å†è½¬æ¢ <code>PyDict</code> è‡ªèº«ï¼Œä¸”è¿”å› <code>PyDict</code> è€Œé <code>*mut PyObject</code></li>
<li><code>PyTuple::new</code> ç°åœ¨æ¥æ”¶ <code>IntoIterator</code> è€Œé slice</li>
<li>å‡çº§è‡³ syn 0.15</li>
<li>å°† <code>PyTypeObject</code> æ‹†åˆ†ä¸ºä¸å¸¦ create æ–¹æ³•çš„ <code>PyTypeObject</code> å’Œè¦æ±‚ <code>PyObjectAlloc&lt;Self&gt; + PyTypeInfo + Sized</code> çš„ <code>PyTypeCreate</code></li>
<li>æ‰§è¡Œ <code>cargo edition --fix</code>ï¼Œä¸º Rust 2018 ç‰ˆæœ¬åœ¨è·¯å¾„å‰æ·»åŠ  <code>crate::</code></li>
<li>å°† <code>async</code> é‡å‘½åä¸º <code>pyasync</code>ï¼Œå› ä¸º <code>async</code> å°†åœ¨ 2018 ç‰ˆä¸­æˆä¸ºå…³é”®å­—</li>
<li>å¼€å§‹ä½¿ç”¨ <code>NonNull&lt;*mut PyObject&gt;</code> è¡¨ç¤º <code>Py</code> å’Œ <code>PyObject</code>ï¼Œç”± ijl åœ¨ <a href="https://github.com/PyO3/pyo3/pull/260">#260</a> ä¸­å®ç°</li>
</ul>
<h3 id="ç§»é™¤-14"><a class="header" href="#ç§»é™¤-14">ç§»é™¤</a></h3>
<ul>
<li>ä» prelude ä¸­ç§»é™¤äº†å¤§å¤šæ•°æ¡ç›®ï¼Œæ–°çš„ prelude æ›´ç®€æ´æ¸…æ™°</li>
<li>é€æ­¥ç§»é™¤å¯¹ç‰¹åŒ–ï¼ˆspecializationï¼‰çš„ä½¿ç”¨</li>
<li><code>PyString</code>ã€<code>PyUnicode</code> å’Œ <code>PyBytes</code> ä¸å†æœ‰ <code>data</code> æ–¹æ³•ï¼ˆå·²è¢« <code>as_bytes</code> æ›¿ä»£ï¼‰ï¼ŒåŒæ—¶ç§»é™¤äº† <code>PyStringData</code></li>
<li><code>pyobject_extract</code> å®</li>
</ul>
<h3 id="ä¿®å¤-46"><a class="header" href="#ä¿®å¤-46">ä¿®å¤</a></h3>
<ul>
<li>å¢åŠ äº†è¯´æ˜ï¼šå³ä½¿æŒæœ‰ GILGuardï¼ŒGIL ä»å¯èƒ½è¢«ä¸´æ—¶é‡Šæ”¾</li>
<li>ä¿®å¤äº†å¤§é‡ clippy é”™è¯¯</li>
<li>ä¿®å¤äº†åœ¨ PyObject ä¸Šè°ƒç”¨æœªçŸ¥æ–¹æ³•æ—¶çš„æ®µé”™è¯¯</li>
<li>é€šè¿‡ kngwyu åœ¨ <a href="https://github.com/PyO3/pyo3/pull/252">#252</a> ä¸­çš„å·¥ä½œï¼Œç»•è¿‡äº† <a href="https://github.com/rust-lang/rust/issues/55380">Rust ç¼–è¯‘å™¨çš„ä¸€ä¸ª bug</a></li>
<li>ä¿®å¤äº†é€šè¿‡å­ç±»ç»§æ‰¿ PyO3 åˆ›å»ºçš„ç±»å¹¶ä½¿ç”¨ <code>__class__</code> æ—¶çš„æ®µé”™è¯¯ï¼Œç”± kngwyu åœ¨ <a href="https://github.com/PyO3/pyo3/pull/263">#263</a> ä¸­å®ç°</li>
</ul>
<h2 id="041---2018-08-20"><a class="header" href="#041---2018-08-20">[0.4.1] - 2018-08-20</a></h2>
<h3 id="æ›´æ”¹-25"><a class="header" href="#æ›´æ”¹-25">æ›´æ”¹</a></h3>
<ul>
<li>PyTryFrom çš„é”™è¯¯æ€»æ˜¯ <code>PyDowncastError</code></li>
</ul>
<h3 id="ä¿®å¤-47"><a class="header" href="#ä¿®å¤-47">ä¿®å¤</a></h3>
<ul>
<li>ä¿®å¤äº†åœ¨å¤œé—´ç‰ˆæœ¬ï¼ˆnightlyï¼‰ä¸Šæ— æ³•ç¼–è¯‘çš„é—®é¢˜ï¼Œå› ä¸º <code>use_extern_macros</code> å·²ç¨³å®š</li>
</ul>
<h3 id="ç§»é™¤-15"><a class="header" href="#ç§»é™¤-15">ç§»é™¤</a></h3>
<ul>
<li><code>pyobject_downcast</code> å®</li>
</ul>
<h2 id="040---2018-07-30"><a class="header" href="#040---2018-07-30">[0.4.0] - 2018-07-30</a></h2>
<h3 id="æ›´æ”¹-26"><a class="header" href="#æ›´æ”¹-26">æ›´æ”¹</a></h3>
<ul>
<li>å°†ä¸¤ä¸ªç¤ºä¾‹åˆå¹¶ä¸ºä¸€ä¸ª</li>
<li>æ‰€æœ‰ä»£ç ä½¿ç”¨ rustfmt æ ¼å¼åŒ– :heavy_check_mark:</li>
<li>æ”¹ä¸ºä½¿ç”¨ <a href="https://keepachangelog.com/en/1.0.0/">Keep a Changelog</a></li>
</ul>
<h3 id="ç§»é™¤-16"><a class="header" href="#ç§»é™¤-16">ç§»é™¤</a></h3>
<ul>
<li>ç”±äº <a href="https://github.com/rust-lang/rust/issues/52050">rust-lang/rust#52050</a>ï¼Œç§»é™¤äº†å…ƒç»„åˆ° PyDict çš„è½¬æ¢</li>
</ul>
<h2 id="032---2018-07-22"><a class="header" href="#032---2018-07-22">[0.3.2] - 2018-07-22</a></h2>
<h3 id="æ›´æ”¹-27"><a class="header" href="#æ›´æ”¹-27">æ›´æ”¹</a></h3>
<ul>
<li>ç”¨ mashup æ›¿ä»£ <code>concat_idents</code></li>
</ul>
<h2 id="031---2018-07-18"><a class="header" href="#031---2018-07-18">[0.3.1] - 2018-07-18</a></h2>
<h3 id="ä¿®å¤-48"><a class="header" href="#ä¿®å¤-48">ä¿®å¤</a></h3>
<ul>
<li>ä¿®å¤äº† pyobject_native_type å®ä¸­çš„ä½œç”¨åŸŸ bugï¼Œè¯¥ bug ä¼šå¯¼è‡´ rust-numpy å‡ºç°é—®é¢˜</li>
</ul>
<h2 id="030---2018-07-18"><a class="header" href="#030---2018-07-18">[0.3.0] - 2018-07-18</a></h2>
<h3 id="æ–°å¢-53"><a class="header" href="#æ–°å¢-53">æ–°å¢</a></h3>
<ul>
<li>ä¸€äº›å†…éƒ¨å®æˆä¸ºå…¬å…± API çš„ä¸€éƒ¨åˆ†ï¼ˆ<a href="https://github.com/PyO3/pyo3/pull/155">#155</a>ï¼Œ<a href="https://github.com/PyO3/pyo3/pull/186">#186</a>ï¼‰</li>
<li>è·å–å™¨ï¼ˆgettersï¼‰ä¸­å§‹ç»ˆè¿›è¡Œå…‹éš†ï¼ˆcloneï¼‰ï¼Œå…è®¸åœ¨æ‰€æœ‰ Clone ç±»å‹ä¸Šä½¿ç”¨ get æ³¨è§£</li>
</ul>
<h3 id="æ›´æ”¹-28"><a class="header" href="#æ›´æ”¹-28">æ›´æ”¹</a></h3>
<ul>
<li>å‡çº§è‡³ syn 0.14ï¼Œå¸¦æ¥æ›´å¥½çš„é”™è¯¯æç¤º :tada:</li>
<li>æ”¯æŒ 128 ä½æ•´æ•°ï¼Œç”± <a href="https://github.com/kngwyu">kngwyu</a> å®ç° (<a href="https://github.com/PyO3/pyo3/pull/173">#137</a>)</li>
<li><code>proc_macro</code> å·²åœ¨ nightly ç‰ˆæœ¬ä¸­ç¨³å®š (<a href="https://github.com/rust-lang/rust/pull/52081">rust-lang/rust#52081</a>)ï¼Œè¿™æ„å‘³ç€å¯ä»¥ç§»é™¤ <code>proc_macro</code> ç‰¹æ€§ï¼Œä½†éœ€è¦ä½¿ç”¨ 2018 ç‰ˆæœ¬ä¸­çš„ <code>use_extern_macros</code></li>
<li>æ‰€æœ‰è¿‡ç¨‹å®å‡ä»¥ <code>py</code> ä¸ºå‰ç¼€å¹¶ä½äº prelude æ¨¡å—ä¸­ï¼Œå› æ­¤å¯ç›´æ¥ä½¿ç”¨ <code>#[pyclass]</code>ã€<code>#[pymethods]</code>ã€<code>#[pyproto]</code>ã€<code>#[pyfunction]</code> å’Œ <code>#[pymodinit]</code>ï¼ˆå‰ææ˜¯ä½¿ç”¨ <code>use pyo3::prelude::*</code>ï¼‰ï¼Œå®ƒä»¬ä¹Ÿè¢«ç§»è‡³åä¸º <code>proc_macro</code> çš„æ¨¡å—ä¸­ã€‚ä¸åº”ä½¿ç”¨ <code>#[pyo3::proc_macro::pyclass]</code> ç­‰è¾ƒé•¿è·¯å¾„ï¼Œå› ä¸º <code>proc_macro_path_invoc</code> æ— æ³•å¾ˆå¿«ç¨³å®š</li>
<li>å°† <code>pyclass</code> å®ä¸­çš„ <code>base</code> é€‰é¡¹é‡å‘½åä¸º <code>extends</code></li>
<li><code>#[pymodinit]</code> ä½¿ç”¨å‡½æ•°åä½œä¸ºæ¨¡å—åï¼Œé™¤éé€šè¿‡ <code>#[pymodinit(name)]</code> æ˜¾å¼æŒ‡å®šåç§°</li>
<li>æ–‡æ¡£æŒ‡å—ï¼ˆguideï¼‰å·²å…·å¤‡ç‰ˆæœ¬æ§åˆ¶</li>
</ul>
<h2 id="027---2018-05-18"><a class="header" href="#027---2018-05-18">[0.2.7] - 2018-05-18</a></h2>
<h3 id="ä¿®å¤-49"><a class="header" href="#ä¿®å¤-49">ä¿®å¤</a></h3>
<ul>
<li>ä¿®å¤ nightly ç‰ˆæœ¬ä¸­å›  proc_macro_path å¯¼è‡´çš„æ„å»ºé”™è¯¯</li>
</ul>
<h2 id="026---2018-04-03"><a class="header" href="#026---2018-04-03">[0.2.6] - 2018-04-03</a></h2>
<h3 id="ä¿®å¤-50"><a class="header" href="#ä¿®å¤-50">ä¿®å¤</a></h3>
<ul>
<li>ä¿®å¤ä¸ TryFrom trait çš„å…¼å®¹æ€§é—®é¢˜ #137</li>
</ul>
<h2 id="025---2018-02-21"><a class="header" href="#025---2018-02-21">[0.2.5] - 2018-02-21</a></h2>
<h3 id="æ–°å¢-54"><a class="header" href="#æ–°å¢-54">æ–°å¢</a></h3>
<ul>
<li>æ”¯æŒ CPython 3.7</li>
</ul>
<h3 id="ä¿®å¤-51"><a class="header" href="#ä¿®å¤-51">ä¿®å¤</a></h3>
<ul>
<li>ä¿®å¤åµŒå…¥ CPython 3.7b1 åœ¨åˆå§‹åŒ–æ—¶å´©æºƒçš„é—®é¢˜ #110</li>
<li>ä¿®å¤ç”Ÿæˆçš„æ‰©å±•å‡½æ•°ç±»å‹è¾ƒå¼±çš„é—®é¢˜ #108</li>
<li>ä¿®å¤ <code>call_method*</code> åœ¨æ–¹æ³•ä¸å­˜åœ¨æ—¶å´©æºƒçš„é—®é¢˜ #113</li>
<li>å…è®¸ä»åµŒå¥—æ¨¡å—å¯¼å…¥å¼‚å¸¸ #116</li>
</ul>
<h2 id="024---2018-01-19"><a class="header" href="#024---2018-01-19">[0.2.4] - 2018-01-19</a></h2>
<h3 id="æ–°å¢-55"><a class="header" href="#æ–°å¢-55">æ–°å¢</a></h3>
<ul>
<li>å…è®¸ä» PyObject è·å–å¯å˜å¼•ç”¨ #106</li>
<li>ç§»é™¤ <code>RefFromPyObject</code> trait</li>
<li>æ·»åŠ  <code>Python::register_any</code> æ–¹æ³•</li>
</ul>
<h3 id="ä¿®å¤-52"><a class="header" href="#ä¿®å¤-52">ä¿®å¤</a></h3>
<ul>
<li>ä¿®å¤ <code>Py&lt;T&gt;</code> çš„ <code>FromPyObject</code> å®ç°</li>
<li>å°†æ“ä½œåŸå§‹æŒ‡é’ˆçš„æ–¹æ³•æ ‡è®°ä¸º unsafe #95</li>
</ul>
<h2 id="023---2017-11-27"><a class="header" href="#023---2017-11-27">[0.2.3] - 2017-11-27</a></h2>
<h3 id="æ›´æ”¹-29"><a class="header" href="#æ›´æ”¹-29">æ›´æ”¹</a></h3>
<ul>
<li>å‡çº§è‡³ Rust 1.23.0-nightly (2017-11-07)</li>
</ul>
<h3 id="ä¿®å¤-53"><a class="header" href="#ä¿®å¤-53">ä¿®å¤</a></h3>
<ul>
<li>æ­£ç¡®ä½¿ç”¨ <code>c_char</code> #93</li>
</ul>
<h3 id="ç§»é™¤-17"><a class="header" href="#ç§»é™¤-17">ç§»é™¤</a></h3>
<ul>
<li>ç§»é™¤ä¸å†éœ€è¦çš„ â€˜AsciiExtâ€™ trait</li>
</ul>
<h2 id="022---2017-09-26"><a class="header" href="#022---2017-09-26">[0.2.2] - 2017-09-26</a></h2>
<h3 id="æ›´æ”¹-30"><a class="header" href="#æ›´æ”¹-30">æ›´æ”¹</a></h3>
<ul>
<li>å‡çº§è‡³ Rust 1.22.0-nightly (2017-09-30)</li>
</ul>
<h2 id="021---2017-09-26"><a class="header" href="#021---2017-09-26">[0.2.1] - 2017-09-26</a></h2>
<h3 id="ä¿®å¤-54"><a class="header" href="#ä¿®å¤-54">ä¿®å¤</a></h3>
<ul>
<li>ä¿®å¤ rustc const_fn åœ¨ nightly ç‰ˆæœ¬ä¸­çš„æ„å»ºé—®é¢˜</li>
</ul>
<h2 id="020---2017-08-12"><a class="header" href="#020---2017-08-12">[0.2.0] - 2017-08-12</a></h2>
<h3 id="æ–°å¢-56"><a class="header" href="#æ–°å¢-56">æ–°å¢</a></h3>
<ul>
<li>æ·»åŠ ç»§æ‰¿æ”¯æŒ #15</li>
<li>æ·»åŠ å¼±å¼•ç”¨ï¼ˆweakrefï¼‰æ”¯æŒ #56</li>
<li>æ·»åŠ å­ç±»æ”¯æŒ #64</li>
<li>æ·»åŠ  <code>self.__dict__</code> æ”¯æŒ #68</li>
<li>æ·»åŠ  <code>pyo3::prelude</code> æ¨¡å— #70</li>
<li>æ”¹è¿› PyTupleã€PyListã€PyDict çš„ <code>Iterator</code> æ”¯æŒ #75</li>
<li>å¼•å…¥ <code>IntoPyDictPointer</code>ï¼Œç±»ä¼¼äº <code>IntoPyTuple</code> #69</li>
</ul>
<h3 id="æ›´æ”¹-31"><a class="header" href="#æ›´æ”¹-31">æ›´æ”¹</a></h3>
<ul>
<li>å…è®¸åœ¨ä¸å®ç° <code>PyGCProtocol</code> çš„æƒ…å†µä¸‹æ·»åŠ  GC æ”¯æŒ #57</li>
<li>é‡æ„ <code>PyErr</code> çš„å®ç°ï¼Œæ„é€ å‡½æ•°ä¸­ç§»é™¤ <code>py</code> å‚æ•°</li>
</ul>
<h2 id="010---2017-07-23"><a class="header" href="#010---2017-07-23">[0.1.0] - 2017-07-23</a></h2>
<h3 id="æ–°å¢-57"><a class="header" href="#æ–°å¢-57">æ–°å¢</a></h3>
<ul>
<li>åˆå§‹å‘å¸ƒ[0.12.3]: https://github.com/pyo3/pyo3/compare/v0.12.2â€¦v0.12.3
[0.12.2]: https://github.com/pyo3/pyo3/compare/v0.12.1â€¦v0.12.2
[0.12.1]: https://github.com/pyo3/pyo3/compare/v0.12.0â€¦v0.12.1
[0.12.0]: https://github.com/pyo3/pyo3/compare/v0.11.1â€¦v0.12.0
[0.11.1]: https://github.com/pyo3/pyo3/compare/v0.11.0â€¦v0.11.1
[0.11.0]: https://github.com/pyo3/pyo3/compare/v0.10.1â€¦v0.11.0
[0.10.1]: https://github.com/pyo3/pyo3/compare/v0.10.0â€¦v0.10.1
[0.10.0]: https://github.com/pyo3/pyo3/compare/v0.9.2â€¦v0.10.0
[0.9.2]: https://github.com/pyo3/pyo3/compare/v0.9.1â€¦v0.9.2
[0.9.1]: https://github.com/pyo3/pyo3/compare/v0.9.0â€¦v0.9.1
[0.9.0]: https://github.com/pyo3/pyo3/compare/v0.8.5â€¦v0.9.0
[0.8.5]: https://github.com/pyo3/pyo3/compare/v0.8.4â€¦v0.8.5
[0.8.4]: https://github.com/pyo3/pyo3/compare/v0.8.3â€¦v0.8.4
[0.8.3]: https://github.com/pyo3/pyo3/compare/v0.8.2â€¦v0.8.3
[0.8.2]: https://github.com/pyo3/pyo3/compare/v0.8.1â€¦v0.8.2
[0.8.1]: https://github.com/pyo3/pyo3/compare/v0.8.0â€¦v0.8.1
[0.8.0]: https://github.com/pyo3/pyo3/compare/v0.7.0â€¦v0.8.0
[0.7.0]: https://github.com/pyo3/pyo3/compare/v0.6.0â€¦v0.7.0
[0.6.0]: https://github.com/pyo3/pyo3/compare/v0.5.3â€¦v0.6.0
[0.5.3]: https://github.com/pyo3/pyo3/compare/v0.5.2â€¦v0.5.3
[0.5.2]: https://github.com/pyo3/pyo3/compare/v0.5.1â€¦v0.5.2
[0.5.1]: https://github.com/pyo3/pyo3/compare/v0.5.0â€¦v0.5.1
[0.5.0]: https://github.com/pyo3/pyo3/compare/v0.4.1â€¦v0.5.0
[0.4.1]: https://github.com/pyo3/pyo3/compare/v0.4.0â€¦v0.4.1
[0.4.0]: https://github.com/pyo3/pyo3/compare/v0.3.2â€¦v0.4.0
[0.3.2]: https://github.com/pyo3/pyo3/compare/v0.3.1â€¦v0.3.2
[0.3.1]: https://github.com/pyo3/pyo3/compare/v0.3.0â€¦v0.3.1
[0.3.0]: https://github.com/pyo3/pyo3/compare/v0.2.7â€¦v0.3.0
[0.2.7]: https://github.com/pyo3/pyo3/compare/v0.2.6â€¦v0.2.7
[0.2.6]: https://github.com/pyo3/pyo3/compare/v0.2.5â€¦v0.2.6
[0.2.5]: https://github.com/pyo3/pyo3/compare/v0.2.4â€¦v0.2.5
[0.2.4]: https://github.com/pyo3/pyo3/compare/v0.2.3â€¦v0.2.4
[0.2.3]: https://github.com/pyo3/pyo3/compare/v0.2.2â€¦v0.2.3
[0.2.2]: https://github.com/pyo3/pyo3/compare/v0.2.1â€¦v0.2.2
[0.2.1]: https://github.com/pyo3/pyo3/compare/v0.2.0â€¦v0.2.1
[0.2.0]: https://github.com/pyo3/pyo3/compare/v0.1.0â€¦v0.2.0
[0.1.0]: https://github.com/PyO3/pyo3/tree/0.1.0</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="è´¡çŒ®æŒ‡å—"><a class="header" href="#è´¡çŒ®æŒ‡å—">è´¡çŒ®æŒ‡å—</a></h1>
<p>æ„Ÿè°¢æ‚¨æœ‰å…´è¶£ä¸º PyO3 åšå‡ºè´¡çŒ®ï¼æˆ‘ä»¬æ¬¢è¿æ‰€æœ‰äººâ€”â€”è¯·è€ƒè™‘é˜…è¯»æˆ‘ä»¬çš„<a href="https://github.com/PyO3/pyo3/blob/main/Code-of-Conduct.md">è¡Œä¸ºå‡†åˆ™</a>ï¼Œä»¥å¸®åŠ©æˆ‘ä»¬ä¿æŒç§¯æå’ŒåŒ…å®¹çš„ç¤¾åŒºç¯å¢ƒã€‚</p>
<p>å¦‚æœæ‚¨æ­£åœ¨å¯»æ‰¾è´¡çŒ®çš„æ–¹å‘ï¼Œè¯·å‰å¾€â€œå¼€å§‹è´¡çŒ®â€éƒ¨åˆ†ã€‚å¦‚æœå·²ç»ç¡®å®šäº†å…·ä½“çš„è®®é¢˜å¹¶éœ€è¦äº†è§£å¼€å‘æµç¨‹ï¼Œæ‚¨å¯èƒ½ä¼šå‘ç°â€œç¼–å†™ Pull Requestâ€éƒ¨åˆ†å¾ˆæœ‰å¸®åŠ©ã€‚</p>
<p>å¦‚æœæ‚¨æƒ³ç†Ÿæ‚‰ä»£ç åº“ï¼Œè¯·å‚é˜… <a href="https://github.com/PyO3/pyo3/blob/main/Architecture.md">Architecture.md</a>ã€‚</p>
<h2 id="å¼€å§‹è´¡çŒ®"><a class="header" href="#å¼€å§‹è´¡çŒ®">å¼€å§‹è´¡çŒ®</a></h2>
<p>æ¬¢è¿å‚ä¸ PyO3 çš„ä»»ä½•æ„Ÿå…´è¶£çš„æ–¹é¢ã€‚æˆ‘ä»¬ä½¿ç”¨ GitHub issues æ¥è®°å½•æ‰€æœ‰ bug å’Œæƒ³æ³•ã€‚å¦‚æœæ‚¨æƒ³å¤„ç†æŸä¸ª issueï¼Œå¯ä»¥è¯·æ±‚å°†å…¶åˆ†é…ç»™æ‚¨ã€‚</p>
<p>æ‚¨å¯ä»¥åœ¨æ­¤å¤„æµè§ˆ PyO3 éå…¬å¼€éƒ¨åˆ†çš„ APIï¼š<a href="https://pyo3.netlify.app/internal/doc/pyo3/index.html">here</a>ã€‚</p>
<p>ä»¥ä¸‹éƒ¨åˆ†è¿˜æä¾›äº†å…³äºå¦‚ä½•å¼€å§‹ä¸º PyO3 åšå‡ºè´¡çŒ®çš„å…·ä½“å»ºè®®ã€‚</p>
<h2 id="æ­å»ºå¼€å‘ç¯å¢ƒ"><a class="header" href="#æ­å»ºå¼€å‘ç¯å¢ƒ">æ­å»ºå¼€å‘ç¯å¢ƒ</a></h2>
<p>è¦å¼€å‘å’Œä½¿ç”¨ PyO3ï¼Œæ‚¨éœ€è¦åœ¨ç³»ç»Ÿä¸Šå®‰è£… Python å’Œ Rustã€‚</p>
<ul>
<li>æˆ‘ä»¬å»ºè®®ä½¿ç”¨ <a href="https://rustup.rs/">rustup</a> æ¥æ ¹æ®é¡¹ç›®é€‰æ‹©ç‰¹å®šçš„å·¥å…·é“¾ã€‚</li>
<li><a href="https://github.com/pyenv/pyenv">Pyenv</a> ä¹Ÿéå¸¸æ¨èï¼Œç”¨äºé€‰æ‹©ç‰¹å®šçš„ Python ç‰ˆæœ¬ã€‚</li>
<li><a href="https://virtualenv.pypa.io/en/latest/">virtualenv</a> ä¹Ÿå¯ä»¥ä¸ Pyenv ä¸€èµ·ä½¿ç”¨ï¼ˆæˆ–å•ç‹¬ä½¿ç”¨ï¼‰ï¼Œä»¥ä½¿ç”¨ç‰¹å®šå®‰è£…çš„ Python ç‰ˆæœ¬ã€‚</li>
<li>[<code>nox</code>][nox] ç”¨äºè‡ªåŠ¨åŒ–è®¸å¤š CI ä»»åŠ¡ã€‚</li>
</ul>
<h3 id="ä½¿ç”¨-nox-è¿›è¡Œæµ‹è¯•æ£€æŸ¥ç­‰"><a class="header" href="#ä½¿ç”¨-nox-è¿›è¡Œæµ‹è¯•æ£€æŸ¥ç­‰">ä½¿ç”¨ nox è¿›è¡Œæµ‹è¯•ã€æ£€æŸ¥ç­‰</a></h3>
<p>[<code>Nox</code>][nox] ç”¨äºè‡ªåŠ¨åŒ–è®¸å¤š CI ä»»åŠ¡ï¼Œå¯åœ¨æœ¬åœ°ç¼–ç æ—¶ç”¨äºæ‰§è¡ŒéªŒè¯ä»»åŠ¡ã€‚æˆ‘ä»¬å»ºè®®é€šè¿‡ nox è¿è¡Œè¿™äº›æ“ä½œï¼Œä»¥ä¾¿ä½¿ç”¨æˆ‘ä»¬é¦–é€‰çš„é…ç½®é€‰é¡¹ã€‚æ‚¨å¯ä»¥ä½¿ç”¨ pip å°† nox å®‰è£…åˆ°å…¨å±€ Python ç¯å¢ƒä¸­ï¼š<code>pip install nox</code>ï¼Œæˆ–è€…ï¼ˆæ¨èæ–¹å¼ï¼‰ä½¿ç”¨ [<code>pipx</code>][pipx]ï¼š<code>pip install pipx</code>ï¼Œ<code>pipx install nox</code>ã€‚</p>
<p>æˆ‘ä»¬å®ç°çš„ä¸»è¦ nox å‘½ä»¤åŒ…æ‹¬ï¼š</p>
<ul>
<li><code>nox -s test</code> å°†è¿è¡Œå®Œæ•´çš„ Rust å’Œ Python æ¨èæµ‹è¯•å¥—ä»¶ï¼ˆ&gt;10 åˆ†é’Ÿï¼‰</li>
<li><code>nox -s test-rust -- skip-full</code> å°†è¿è¡Œç®€çŸ­çš„ Rust æµ‹è¯•å¥—ä»¶ï¼ˆ2-3 åˆ†é’Ÿï¼‰</li>
<li><code>nox -s ruff</code> å°†æ£€æŸ¥ Python çš„ä»£ç é£æ ¼å¹¶åº”ç”¨æ ‡å‡†æ ¼å¼è§„åˆ™</li>
<li><code>nox -s rustfmt</code> å°†æ£€æŸ¥åŸºæœ¬çš„ Rust ä»£ç é£æ ¼å¹¶åº”ç”¨æ ‡å‡†æ ¼å¼è§„åˆ™</li>
<li><code>nox -s rumdl</code> å°†æ£€æŸ¥æŒ‡å—ä¸­çš„ Markdown</li>
<li><code>nox -s clippy</code> å°†è¿è¡Œ clippy å¹¶å¯¹ Rust é£æ ¼æå‡ºå»ºè®®</li>
<li><code>nox -s bench</code> å°†å¯¹æ‚¨çš„ Rust ä»£ç è¿›è¡Œæ€§èƒ½åŸºå‡†æµ‹è¯•</li>
<li><code>nox -s codspeed</code> å°†è¿è¡Œæˆ‘ä»¬çš„ Rust å’Œ Python æ€§èƒ½æµ‹è¯•å¥—ä»¶</li>
<li><code>nox -s coverage</code> å°†åˆ†ææµ‹è¯•è¦†ç›–ç‡å¹¶è¾“å‡º <code>coverage.json</code>ï¼ˆæˆ–è€…ä½¿ç”¨ <code>nox -s coverage lcov</code> è¾“å‡º <code>lcov.info</code>ï¼‰</li>
<li><code>nox -s check-guide</code> å°†ä½¿ç”¨ [<code>lychee</code>][lychee] æ£€æŸ¥æŒ‡å—å’Œæ–‡æ¡£æ³¨é‡Šä¸­çš„æ‰€æœ‰é“¾æ¥ã€‚</li>
</ul>
<p>ä½¿ç”¨ <code>nox -l</code> å¯åˆ—å‡ºæ‰€æœ‰å¯è¿è¡Œçš„å­å‘½ä»¤ã€‚</p>
<h4 id="ui-æµ‹è¯•"><a class="header" href="#ui-æµ‹è¯•">UI æµ‹è¯•</a></h4>
<p>PyO3 ä½¿ç”¨ [<code>trybuild</code>][trybuild] æ¥å¼€å‘ UI æµ‹è¯•ï¼Œç”¨äºæ•è· Rust ç¼–è¯‘å™¨åœ¨æŸäº›å®åŠŸèƒ½ä¸Šçš„é”™è¯¯æ¶ˆæ¯ã€‚</p>
<p>ç”±äºè¿™äº› UI æµ‹è¯•æœ‰å¤šç§åŠŸèƒ½ç»„åˆï¼Œå½“éœ€è¦å…¨éƒ¨æ›´æ–°æ—¶ï¼ˆä¾‹å¦‚å‡çº§æ–°çš„ Rust ç¼–è¯‘å™¨ç‰ˆæœ¬ï¼‰ï¼Œå¯ä»¥ä½¿ç”¨ <code>update-ui-tests</code> nox ä¼šè¯ï¼š</p>
<pre><code class="language-bash">nox -s update-ui-tests
</code></pre>
<h2 id="å¯ä»¥å¸®åŠ©çš„æ–¹å¼"><a class="header" href="#å¯ä»¥å¸®åŠ©çš„æ–¹å¼">å¯ä»¥å¸®åŠ©çš„æ–¹å¼</a></h2>
<h3 id="å¸®åŠ©ç”¨æˆ·è¯†åˆ«-bug"><a class="header" href="#å¸®åŠ©ç”¨æˆ·è¯†åˆ«-bug">å¸®åŠ©ç”¨æˆ·è¯†åˆ« bug</a></h3>
<p><a href="https://discord.gg/33kcChzH7f">PyO3 Discord æœåŠ¡å™¨</a> æ´»è·ƒç€è®¸å¤šæ–°ç”¨æˆ·ï¼Œä»–ä»¬å¸¸å¸¸æ˜¯åˆšæ¥è§¦ PyO3ï¼Œç”šè‡³æ˜¯å®Œå…¨æ–°æ‰‹çš„ Rust å¼€å‘è€…ã€‚å¸®åŠ©ä»–ä»¬è°ƒè¯•æ˜¯ç†Ÿæ‚‰ PyO3 ä»£ç åº“çš„å¥½æ–¹æ³•ã€‚</p>
<p>å¸®åŠ©ä»–äººé€šå¸¸ä¼šæš´éœ²å‡º bugã€æ–‡æ¡£ä¸è¶³æˆ–ç¼ºå¤±çš„ APIã€‚å»ºè®®ç«‹å³åˆ›å»º GitHub issues æ¥è®°å½•è¿™äº›é—®é¢˜ï¼Œä»¥ä¾¿è®¾è®¡å¹¶å®æ–½è§£å†³æ–¹æ¡ˆï¼</p>
<h3 id="å®ç°å·²å‡†å¤‡å¥½å¼€å‘çš„è®®é¢˜"><a class="header" href="#å®ç°å·²å‡†å¤‡å¥½å¼€å‘çš„è®®é¢˜">å®ç°å·²å‡†å¤‡å¥½å¼€å‘çš„è®®é¢˜</a></h3>
<p>å¯¹äºè§£å†³æ–¹æ¡ˆæ˜ç¡®ä¸”å°šæœªæœ‰äººå¼€å§‹å·¥ä½œçš„ issueï¼Œæˆ‘ä»¬ä½¿ç”¨ <a href="https://github.com/PyO3/pyo3/issues?q=is%3Aissue+is%3Aopen+label%3Aneeds-implementer">needs-implementer</a> æ ‡ç­¾ã€‚</p>
<p>å³ä½¿æ‚¨ä¸æ¸…æ¥šè§£å†³æ–¹æ¡ˆä¹Ÿæ— éœ€å®³æ€•ï¼PyO3 çš„æ ¸å¿ƒè´¡çŒ®è€…å¾ˆä¹æ„æŒ‡å¯¼æ‚¨ï¼Œå›ç­”æ‚¨çš„é—®é¢˜ï¼Œå¸®åŠ©æ‚¨ç¼–å†™è§£å†³æ–¹æ¡ˆã€‚</p>
<h3 id="ååŠ©ç¼–å†™ä¼˜ç§€çš„æ–‡æ¡£"><a class="header" href="#ååŠ©ç¼–å†™ä¼˜ç§€çš„æ–‡æ¡£">ååŠ©ç¼–å†™ä¼˜ç§€çš„æ–‡æ¡£</a></h3>
<p>PyO3 æ‹¥æœ‰ä¸€æœ¬ç”¨æˆ·æŒ‡å—ï¼ˆä½¿ç”¨ mdbook ç¼–å†™ï¼‰ä»¥åŠå¸¸è§„çš„ Rust API æ–‡æ¡£ã€‚æˆ‘ä»¬çš„ç›®æ ‡æ˜¯è®©è¿™ä¸¤è€…éƒ½è¯¦å°½ã€æ˜“äºç†è§£ä¸”ä¿æŒæœ€æ–°ã€‚æ¬¢è¿æäº¤ Pull Request æ¥ä¿®å¤æ‹¼å†™é”™è¯¯ã€è°ƒæ•´æªè¾ã€æ·»åŠ ç¤ºä¾‹ç­‰ã€‚</p>
<p>ç›®å‰æ–‡æ¡£æ–¹é¢æœ‰ä¸€äº›ç‰¹åˆ«éœ€è¦å¸®åŠ©çš„é‡ç‚¹é¢†åŸŸï¼š</p>
<ul>
<li>è¯·æ±‚æ”¹è¿›æ–‡æ¡£çš„ issue ä½¿ç”¨ <a href="https://github.com/PyO3/pyo3/issues?q=is%3Aissue+is%3Aopen+label%3Adocumentation">documentation</a> æ ‡ç­¾è¿›è¡Œè·Ÿè¸ªã€‚</li>
<li>å¹¶éæ‰€æœ‰ API åœ¨åˆ›å»ºæ—¶éƒ½æœ‰æ–‡æ¡£æˆ–ç¤ºä¾‹ã€‚æˆ‘ä»¬çš„ç›®æ ‡æ˜¯ä¸ºæ‰€æœ‰ PyO3 API æä¾›æ–‡æ¡£ï¼ˆ<a href="https://github.com/PyO3/pyo3/issues/306">#306</a>ï¼‰ã€‚å¦‚æœæ‚¨å‘ç°æŸä¸ª API ç¼ºå°‘æ–‡æ¡£ï¼Œè¯·ç¼–å†™ä¸€ä»½å¹¶æäº¤ PRï¼</li>
</ul>
<p>è¦æ„å»ºæ–‡æ¡£ï¼ˆåŒ…å«æ‰€æœ‰ç‰¹æ€§ï¼‰ï¼Œè¯·å…ˆå®‰è£… [<code>nox</code>][nox]ï¼Œç„¶åè¿è¡Œï¼š</p>
<pre><code class="language-shell">nox -s docs -- open
</code></pre>
<h4 id="æ–‡æ¡£æµ‹è¯•-doctests"><a class="header" href="#æ–‡æ¡£æµ‹è¯•-doctests">æ–‡æ¡£æµ‹è¯• (Doctests)</a></h4>
<p>æˆ‘ä»¬åœ¨æ–‡æ¡£ä¸­ä½¿ç”¨äº†å¾ˆå¤šä»£ç å—ã€‚ä¿®æ”¹æ–‡æ¡£åï¼Œè¯·è¿è¡Œ <code>cargo test --doc</code> æ£€æŸ¥æ–‡æ¡£æµ‹è¯•æ˜¯å¦ä»èƒ½é€šè¿‡ï¼Œæˆ–è€…è¿è¡Œ <code>cargo test</code> æ¥è¿è¡ŒåŒ…å«æ–‡æ¡£æµ‹è¯•åœ¨å†…çš„æ‰€æœ‰ Rust æµ‹è¯•ã€‚æœ‰å…³æ–‡æ¡£æµ‹è¯•çš„æŒ‡å—ï¼Œå‚è§ https://doc.rust-lang.org/rustdoc/documentation-tests.htmlã€‚</p>
<h4 id="æ„å»ºç”¨æˆ·æŒ‡å—"><a class="header" href="#æ„å»ºç”¨æˆ·æŒ‡å—">æ„å»ºç”¨æˆ·æŒ‡å—</a></h4>
<p>æ‚¨å¯ä»¥é€šè¿‡ <code>mdbook</code> åœ¨æœ¬åœ°æ„å»ºç”¨æˆ·æŒ‡å—è¿›è¡Œé¢„è§ˆã€‚</p>
<p>é¦–å…ˆï¼Œå®‰è£… [<code>mdbook</code>][mdbook]ã€[<code>mdbook-tabs</code>][mdbook-tabs] æ’ä»¶ä»¥åŠ [<code>nox</code>][nox]ã€‚ç„¶åè¿è¡Œï¼š</p>
<pre><code class="language-shell">nox -s build-guide -- --open
</code></pre>
<p>è¦æ£€æŸ¥æŒ‡å—ä¸­æ‰€æœ‰é“¾æ¥æ˜¯å¦æœ‰æ•ˆï¼Œè¯·é¢å¤–å®‰è£… [<code>lychee</code>][lychee]ï¼Œå¹¶æ”¹ç”¨ <code>check-guide</code> ä¼šè¯ï¼š</p>
<pre><code class="language-shell">nox -s check-guide
</code></pre>
<h3 id="ååŠ©è®¾è®¡ä¸‹ä¸€ä»£-pyo3"><a class="header" href="#ååŠ©è®¾è®¡ä¸‹ä¸€ä»£-pyo3">ååŠ©è®¾è®¡ä¸‹ä¸€ä»£ PyO3</a></h3>
<p>å°šæœªæœ‰æ˜ç¡®è§£å†³æ–¹æ¡ˆçš„è®®é¢˜ä½¿ç”¨ <a href="https://github.com/PyO3/pyo3/issues?q=is%3Aissue+is%3Aopen+label%3Aneeds-design">needs-design</a> æ ‡ç­¾ã€‚</p>
<p>å¦‚æœæ‚¨å¯¹å…¶ä¸­ä»»ä½•è®®é¢˜æ„Ÿå…´è¶£ï¼Œè¯·åŠ å…¥ç›¸å…³è®¨è®ºï¼æ‰€æœ‰æ„è§éƒ½è¢«é‡è§†ï¼Œå¦‚æœæ‚¨æœ‰å…´è¶£è¿›ä¸€æ­¥å°è¯•ï¼Œä¾‹å¦‚æäº¤è‰ç¨¿ PR æ¥å®éªŒ API è®¾è®¡ï¼Œé‚£å°±æ›´å¥½äº†ï¼</p>
<h3 id="å®¡æŸ¥-pull-request"><a class="header" href="#å®¡æŸ¥-pull-request">å®¡æŸ¥ Pull Request</a></h3>
<p>æ¬¢è¿æ‰€æœ‰äººå¯¹å¼€æ”¾çš„ PR æäº¤è¯„è®ºã€‚è¯·å¸®åŠ©ç¡®ä¿æ–°çš„ PyO3 API æ˜¯å®‰å…¨ã€é«˜æ•ˆã€æ•´æ´ä¸”æ˜“äºä½¿ç”¨çš„ï¼</p>
<h2 id="ç¼–å†™-pull-request"><a class="header" href="#ç¼–å†™-pull-request">ç¼–å†™ Pull Request</a></h2>
<p>åœ¨ç¼–å†™ PR æ—¶ï¼Œä»¥ä¸‹å‡ ç‚¹éœ€è¦æ³¨æ„ã€‚</p>
<h3 id="æµ‹è¯•ä¸æŒç»­é›†æˆ"><a class="header" href="#æµ‹è¯•ä¸æŒç»­é›†æˆ">æµ‹è¯•ä¸æŒç»­é›†æˆ</a></h3>
<p>PyO3 ä»“åº“ä½¿ç”¨ GitHub Actionsã€‚å¦‚æœ CI ä¸æˆåŠŸï¼ŒPR å°†æ— æ³•åˆå¹¶ã€‚æ‰€æœ‰ Rust å’Œ Python ä»£ç çš„æ ¼å¼åŒ–ã€æ£€æŸ¥å’Œæµ‹è¯•éƒ½ä¼šè¢«éªŒè¯ï¼ˆå¦‚æœæ ¼å¼åŒ–å¤±è´¥ï¼ŒCI ç®¡é“ä¼šæå‰ç»ˆæ­¢ä»¥èŠ‚çœèµ„æºï¼‰ã€‚æ­¤å¤–ï¼ŒRust ä»£ç ä¸­ä¸å…è®¸ä»»ä½•è­¦å‘Šï¼ˆä½¿ç”¨ <code>RUSTFLAGS="-D warnings"</code>ï¼‰ã€‚</p>
<p>æµ‹è¯•ä¼šåœ¨æ‰€æœ‰æ”¯æŒçš„ Python ç‰ˆæœ¬ä¸‹ä½¿ç”¨æœ€æ–°çš„ç¨³å®šç‰ˆ Rust ç¼–è¯‘å™¨è¿è¡Œï¼ŒåŒæ—¶ä¹Ÿä¼šé’ˆå¯¹ Python 3.9 å’Œæœ€ä½æ”¯æŒçš„ Rust ç‰ˆæœ¬è¿è¡Œã€‚</p>
<p>å¦‚æœæ‚¨æ·»åŠ äº†æ–°åŠŸèƒ½ï¼Œè¯·å°†å…¶åŠ å…¥ <em>Cargo.toml</em> ä¸­çš„ <code>full</code> featureï¼Œä»¥ä¾¿ CI èƒ½å¤Ÿå¯¹å…¶è¿›è¡Œæµ‹è¯•ã€‚</p>
<p>æ‚¨ä¹Ÿå¯ä»¥ä½¿ç”¨ <code>nox</code> è‡ªè¡Œè¿è¡Œ CI ç®¡é“ç»„ä»¶ï¼Œè¯·å‚è§<a href="#testing-linting-etc-with-nox">ä¸Šæ–¹çš„æµ‹è¯•éƒ¨åˆ†</a>ã€‚</p>
<h3 id="è®°å½•å˜æ›´"><a class="header" href="#è®°å½•å˜æ›´">è®°å½•å˜æ›´</a></h3>
<p>æˆ‘ä»¬ä½¿ç”¨ <a href="https://towncrier.readthedocs.io/en/stable/index.html">towncrier</a> ä¸ºæ¯æ¬¡å‘å¸ƒç”Ÿæˆ CHANGELOGã€‚</p>
<p>ä¸ºäº†è®©æ‚¨çš„æ›´æ”¹è¢«åŒ…å«è¿›å‘å¸ƒæ—¥å¿—ï¼Œè¯·åœ¨ <code>newsfragments</code> ç›®å½•ä¸­åˆ›å»ºä¸€ä¸ªï¼ˆæˆ–å¤šä¸ªï¼‰æ–°é—»æ¡ç›®ã€‚æœ‰æ•ˆçš„æ–°é—»æ¡ç›®åº”ä¿å­˜ä¸º <code>&lt;PR&gt;.&lt;CATEGORY&gt;.md</code>ï¼Œå…¶ä¸­ <code>&lt;PR&gt;</code> æ˜¯ Pull Request ç¼–å·ï¼Œ<code>&lt;CATEGORY&gt;</code> æ˜¯ä»¥ä¸‹ä¹‹ä¸€ï¼š</p>
<ul>
<li><code>packaging</code> - ä¾èµ–é¡¹å˜æ›´åŠ Python / Rust ç‰ˆæœ¬å…¼å®¹æ€§å˜æ›´</li>
<li><code>added</code> - æ–°åŠŸèƒ½</li>
<li><code>changed</code> - å·²å­˜åœ¨ä½†å·²ä¿®æ”¹æˆ–å·²å¼ƒç”¨çš„åŠŸèƒ½</li>
<li><code>removed</code> - å·²ç§»é™¤çš„åŠŸèƒ½</li>
<li><code>fixed</code> - å±äº bug ä¿®å¤çš„å˜æ›´</li>
</ul>
<p>ä»…æ–‡æ¡£æ›´æ–°çš„ PR ä¸éœ€è¦æ–°é—»æ¡ç›®ï¼›è¯·ä»¥ <code>docs:</code> å¼€å¤´ PR æ ‡é¢˜ä»¥è·³è¿‡æ£€æŸ¥ã€‚</p>
<h3 id="é£æ ¼æŒ‡å—"><a class="header" href="#é£æ ¼æŒ‡å—">é£æ ¼æŒ‡å—</a></h3>
<h4 id="æ³›å‹ä»£ç "><a class="header" href="#æ³›å‹ä»£ç ">æ³›å‹ä»£ç </a></h4>
<p>PyO3 æä¾›å¤§é‡æ³›å‹ API ä»¥æé«˜å¯ç”¨æ€§ã€‚ä½†è¿™å¯èƒ½ä¼šå¯¼è‡´æ³›å‹ä»£ç è†¨èƒ€ã€‚åœ¨åˆç†çš„æƒ…å†µä¸‹ï¼Œå°½é‡ä¸ºæ³›å‹å‡½æ•°å®ç°ä¸€ä¸ªå…·ä½“çš„å­éƒ¨åˆ†ã€‚è¿™æœ‰ä¸¤ç§å½¢å¼ï¼š</p>
<ul>
<li>å¦‚æœè¯¥å…·ä½“å­éƒ¨åˆ†ä¸ä¼šè¢«å…¶ä»–å‡½æ•°é‡å¤ä½¿ç”¨ï¼Œåˆ™å‘½åä¸º <code>inner</code> å¹¶å°†å…¶ä¿ç•™åœ¨å‡½æ•°å†…éƒ¨ä½œä¸ºå±€éƒ¨å‡½æ•°ã€‚</li>
<li>å¦‚æœè¯¥å…·ä½“å­éƒ¨åˆ†ä¼šè¢«å…¶ä»–å‡½æ•°å¤ç”¨ï¼Œåˆ™ä¼˜å…ˆå‘½åä¸º <code>_foo</code>ï¼Œå¹¶åœ¨æºç ä¸­ç›´æ¥æ”¾åœ¨ <code>foo</code> ä¸‹æ–¹ï¼ˆå…¶ä¸­ <code>foo</code> æ˜¯åŸæ¥çš„æ³›å‹å‡½æ•°ï¼‰ã€‚</li>
</ul>
<h4 id="ffi-è°ƒç”¨"><a class="header" href="#ffi-è°ƒç”¨">FFI è°ƒç”¨</a></h4>
<p>PyO3 ä½¿ç”¨åŸå§‹æŒ‡é’ˆå¯¹ Python çš„ C API è¿›è¡Œå¤§é‡ FFI è°ƒç”¨ã€‚å°½å¯èƒ½é¿å…åœ¨è¡¨è¾¾å¼ä¸­ä½¿ç”¨æŒ‡å‘ä¸´æ—¶å¯¹è±¡çš„æŒ‡é’ˆï¼š</p>
<pre><code class="language-rust">// å±é™©
pyo3::ffi::Something(name.to_object(py).as_ptr());

// å› ä¸ºä»¥ä¸‹é‡æ„ä¼šå¯¼è‡´æ‚¬å‚æŒ‡é’ˆï¼ˆuse-after-freeï¼‰é”™è¯¯ï¼š
let name = name.to_object(py).as_ptr();
pyo3::ffi::Something(name)</code></pre>
<p>ç›¸åï¼Œå»ºè®®åœ¨ä¼ é€’ç»™ FFI å‡½æ•°å‰å…ˆç»‘å®šå®‰å…¨çš„ã€æ‹¥æœ‰æ‰€æœ‰æƒçš„ <code>PyObject</code> åŒ…è£…å™¨ï¼š</p>
<pre><code class="language-rust">let name: PyObject = name.to_object(py);
pyo3::ffi::Something(name.as_ptr())
// å½“ name ç¦»å¼€ä½œç”¨åŸŸæ—¶ä¼šè‡ªåŠ¨é‡Šæ”¾</code></pre>
<h2 id="python-ä¸-rust-ç‰ˆæœ¬æ”¯æŒç­–ç•¥"><a class="header" href="#python-ä¸-rust-ç‰ˆæœ¬æ”¯æŒç­–ç•¥">Python ä¸ Rust ç‰ˆæœ¬æ”¯æŒç­–ç•¥</a></h2>
<p>PyO3 æ—¨åœ¨ä¿æŒè¶³å¤Ÿçš„å…¼å®¹æ€§ï¼Œä½¿å¾—å¤§å¤šæ•°å¸¸è§åŒ…ç®¡ç†å™¨èƒ½å¤Ÿæ–¹ä¾¿åœ°æ‰“åŒ…åŸºäº PyO3 æ„å»ºçš„ Python æ‰©å±•ã€‚</p>
<p>ä¸ºç®€åŒ–åŒ…ç»´æŠ¤è€…çš„å·¥ä½œï¼ŒPyO3 æ‰¿è¯ºå°½å¯èƒ½ä»…åœ¨åŒæ—¶è°ƒæ•´æœ€ä½æ”¯æŒçš„ Rust å’Œ Python ç‰ˆæœ¬æ—¶è¿›è¡Œå˜æ›´ã€‚æ­¤ç±»å‡çº§ä»…ä¼šåœ¨ <code>0.x</code> ç‰ˆæœ¬ä¸­è¿›è¡Œï¼Œå¤§çº¦æ¯å¹´ä¸€æ¬¡ï¼Œåœ¨æœ€æ—§æ”¯æŒçš„ Python ç‰ˆæœ¬è¾¾åˆ°ç”Ÿå‘½å‘¨æœŸç»ˆç‚¹ä¹‹åã€‚ï¼ˆå¯æŸ¥çœ‹ https://endoflife.date/python è·å–æ˜ç¡®çš„æ—¶é—´è¡¨ã€‚ï¼‰</p>
<p>ä»¥ä¸‹æ˜¯æ¯ç§è¯­è¨€ PR æ‰€éœ€å…¼å®¹æ€§çš„æŒ‡å¯¼åŸåˆ™ã€‚</p>
<h3 id="pythonpyo3-æ”¯æŒæ‰€æœ‰å®˜æ–¹æ”¯æŒçš„-python-ç‰ˆæœ¬ä»¥åŠæœ€æ–°çš„-pypy3-å‘è¡Œç‰ˆæ‰€æœ‰è¿™äº›ç‰ˆæœ¬éƒ½ä¼šåœ¨-ci-ä¸­è¿›è¡Œæµ‹è¯•"><a class="header" href="#pythonpyo3-æ”¯æŒæ‰€æœ‰å®˜æ–¹æ”¯æŒçš„-python-ç‰ˆæœ¬ä»¥åŠæœ€æ–°çš„-pypy3-å‘è¡Œç‰ˆæ‰€æœ‰è¿™äº›ç‰ˆæœ¬éƒ½ä¼šåœ¨-ci-ä¸­è¿›è¡Œæµ‹è¯•">PythonPyO3 æ”¯æŒæ‰€æœ‰å®˜æ–¹æ”¯æŒçš„ Python ç‰ˆæœ¬ï¼Œä»¥åŠæœ€æ–°çš„ PyPy3 å‘è¡Œç‰ˆã€‚æ‰€æœ‰è¿™äº›ç‰ˆæœ¬éƒ½ä¼šåœ¨ CI ä¸­è¿›è¡Œæµ‹è¯•ã€‚</a></h3>
<h4 id="æ·»åŠ å¯¹æ–°-cpython-ç‰ˆæœ¬çš„æ”¯æŒ"><a class="header" href="#æ·»åŠ å¯¹æ–°-cpython-ç‰ˆæœ¬çš„æ”¯æŒ">æ·»åŠ å¯¹æ–° CPython ç‰ˆæœ¬çš„æ”¯æŒ</a></h4>
<p>å¦‚æœä½ è®¡åˆ’æ·»åŠ å¯¹ CPython é¢„å‘å¸ƒç‰ˆæœ¬çš„æ”¯æŒï¼Œä»¥ä¸‹æ˜¯ï¼ˆéå®Œæ•´ï¼‰æ£€æŸ¥æ¸…å•ï¼š</p>
<ul>
<li><input disabled="" type="checkbox"> ç­‰å¾…æœ€åä¸€ä¸ª alpha ç‰ˆæœ¬ï¼ˆé€šå¸¸ä¸º alpha7ï¼‰ï¼Œå› ä¸ºåœ¨ç¬¬ä¸€ä¸ª beta ç‰ˆæœ¬ä¹‹å‰ï¼ŒABI æ— æ³•å¾—åˆ°ä¿è¯</li>
<li><input disabled="" type="checkbox"> åœ¨ <code>.github/workflows/ci.yml</code> ä¸­æ·»åŠ  prerelease_ver-devï¼ˆä¾‹å¦‚ <code>3.14-dev</code>ï¼‰ï¼Œå¹¶åœ¨ <code>noxfile.py</code>ã€<code>pyo3-ffi/Cargo.toml</code> çš„ <code>[package.metadata.cpython]</code> ä¸­çš„ <code>max-version</code>ã€ä»¥åŠ <code>pyo3-ffi/build.rs</code> çš„ <code>max</code> å­—æ®µä¸­æ›´æ–°ç‰ˆæœ¬</li>
<li><input disabled="" type="checkbox"> ä¸ºè¯¥ç‰ˆæœ¬æ·»åŠ ä¸€ä¸ªæ–°çš„ abi3-prerelease ç‰¹æ€§ï¼ˆä¾‹å¦‚ <code>abi3-py314</code>ï¼‰
<ul>
<li>åœ¨ <code>pyo3-build-config/Cargo.toml</code> ä¸­ï¼Œå°† abi3-most_current_stable è®¾ä¸º [â€œabi3-prereleaseâ€]ï¼Œabi3-prerelease è®¾ä¸º [â€œabi3â€]</li>
<li>åœ¨ <code>pyo3-ffi/Cargo.toml</code> ä¸­ï¼Œå°† abi3-most_current_stable è®¾ä¸º [â€œabi3-prereleaseâ€, â€œpyo3-build-config/abi3-most_current_stableâ€]ï¼Œabi3-prerelease è®¾ä¸º [â€œabi3â€, â€œpyo3-build-config/abi3-prereleaseâ€]</li>
<li>åœ¨ <code>Cargo.toml</code> ä¸­ï¼Œå°† abi3-most_current_stable è®¾ä¸º [â€œabi3-prereleaseâ€, â€œpyo3-ffi/abi3-most_current_stableâ€]ï¼Œabi3-prerelease è®¾ä¸º [â€œabi3â€, â€œpyo3-ffi/abi3-prereleaseâ€]</li>
</ul>
</li>
<li><input disabled="" type="checkbox"> ä½¿ç”¨ <code>#[cfg(Py_prerelease])</code>ï¼ˆä¾‹å¦‚ <code>#[cfg(Py_3_14)]</code>ï¼‰å’Œ <code>#[cfg(not(Py_prerelease))]</code> æ¥è¡¨ç¤º CPython ç¨³å®šåˆ†æ”¯ä¸é¢„å‘å¸ƒç‰ˆæœ¬ä¹‹é—´çš„å˜æ›´</li>
<li><input disabled="" type="checkbox"> ä¸è¦ä¸º CPython å¤´æ–‡ä»¶ä¸­ä»¥ <code>_</code> ä¸ºå‰ç¼€çš„ä»»ä½•å‡½æ•°ã€ç»“æ„ä½“æˆ–å…¨å±€å˜é‡æ·»åŠ  Rust ç»‘å®š</li>
<li><input disabled="" type="checkbox"> å¯è”ç³» @ngoldbaum å’Œ @davidhewitt è·å–å¸®åŠ©</li>
</ul>
<h3 id="rust-1"><a class="header" href="#rust-1">Rust</a></h3>
<p>PyO3 è‡´åŠ›äºä½¿ç”¨æœ€æ–°çš„ Rust è¯­è¨€ç‰¹æ€§ï¼Œä»¥ä¿æŒå…¶å®ç°å°½å¯èƒ½é«˜æ•ˆã€‚</p>
<p>æœ€ä½æ”¯æŒçš„ Rust ç‰ˆæœ¬å°†åœ¨å‡çº§ Python å’Œ Rust ç‰ˆæœ¬çš„å‘å¸ƒæ—¶å†³å®šã€‚å±Šæ—¶ï¼Œæœ€ä½æ”¯æŒçš„ Rust ç‰ˆæœ¬å°†ä¸ä¼šé«˜äºå½“å‰ Debianã€RHEL å’Œ Alpine Linux å‘è¡Œç‰ˆä¸­æä¾›çš„æœ€ä½ Rust ç‰ˆæœ¬ã€‚</p>
<p>CI ä¼šåŒæ—¶æµ‹è¯•æœ€æ–°çš„ç¨³å®š Rust ç‰ˆæœ¬å’Œæœ€ä½æ”¯æŒçš„ Rust ç‰ˆæœ¬ã€‚ç”±äº Rust çš„ç¨³å®šæ€§ä¿è¯ï¼Œè¿™è¶³ä»¥ç¡®è®¤å¯¹ä¸­é—´æ‰€æœ‰ Rust ç‰ˆæœ¬çš„æ”¯æŒã€‚</p>
<h2 id="åŸºå‡†æµ‹è¯•-1"><a class="header" href="#åŸºå‡†æµ‹è¯•-1">åŸºå‡†æµ‹è¯•</a></h2>
<p>PyO3 æœ‰ä¸¤ç»„åŸºå‡†æµ‹è¯•ç”¨äºè¯„ä¼°å…¶æ€§èƒ½çš„æŸäº›æ–¹é¢ã€‚å½“å‰åŸºå‡†æµ‹è¯•å¥—ä»¶éå¸¸å°â€”â€”å¦‚æœä½ æœ‰å…´è¶£å¸®åŠ©æ‰©å±•å®ƒï¼Œè¯·æäº¤åŒ…å«æ–°åŸºå‡†çš„ PRï¼</p>
<p>é¦–å…ˆï¼Œ<code>pyo3-benches</code> å­ç›®å½•ä¸­åŒ…å«åŸºäº Rust çš„åŸºå‡†æµ‹è¯•ã€‚ä½ å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤è¿è¡Œè¿™äº›åŸºå‡†æµ‹è¯•ï¼š</p>
<pre><code>nox -s bench
</code></pre>
<p>å…¶æ¬¡ï¼Œ<code>pytests</code> å­ç›®å½•ä¸­åŒ…å«ä¸€ä¸ªåŸºäº Python çš„åŸºå‡†æµ‹è¯•ã€‚ä½ å¯ä»¥<a href="https://github.com/PyO3/pyo3/tree/main/pytests">ç‚¹å‡»æ­¤å¤„</a>äº†è§£æ›´å¤šä¿¡æ¯ã€‚</p>
<h2 id="ä»£ç è¦†ç›–ç‡"><a class="header" href="#ä»£ç è¦†ç›–ç‡">ä»£ç è¦†ç›–ç‡</a></h2>
<p>ä½ å¯ä»¥æŸ¥çœ‹å“ªäº›ä»£ç è¢« PyO3 çš„æµ‹è¯•è¦†ç›–ï¼Œå“ªäº›æ²¡æœ‰ã€‚æˆ‘ä»¬ç›®æ ‡æ˜¯å®ç° 100% è¦†ç›–ç‡â€”â€”å¦‚æœä½ å‘ç°è¦†ç›–ç‡ä¸è¶³ï¼Œè¯·æ£€æŸ¥å¹¶æ·»åŠ æµ‹è¯•ï¼</p>
<ul>
<li>é¦–å…ˆï¼Œç¡®ä¿å·²å®‰è£… llvm-cov cargo æ’ä»¶ã€‚åœ¨ä½¿ç”¨ <code>nox</code> ä¹‹å‰ï¼Œä½ å¯èƒ½éœ€è¦å…ˆé€šè¿‡ cargo è¿è¡Œä¸€æ¬¡è¯¥æ’ä»¶ã€‚</li>
</ul>
<pre><code class="language-shell">cargo install cargo-llvm-cov
cargo llvm-cov
</code></pre>
<ul>
<li>ç„¶åï¼Œé€šè¿‡ä»¥ä¸‹å‘½ä»¤ç”Ÿæˆ <code>lcov.info</code> æ–‡ä»¶</li>
</ul>
<pre><code class="language-shell">nox -s coverage -- lcov
</code></pre>
<p>ä½ å¯ä»¥å®‰è£… IDE æ’ä»¶æ¥æŸ¥çœ‹è¦†ç›–ç‡ã€‚ä¾‹å¦‚ï¼Œå¦‚æœä½ ä½¿ç”¨ VSCodeï¼š</p>
<ul>
<li>å®‰è£… <a href="https://marketplace.visualstudio.com/items?itemName=ryanluker.vscode-coverage-gutters">coverage-gutters</a> æ’ä»¶ã€‚</li>
<li>åœ¨ VSCode çš„ <code>settings.json</code> ä¸­æ·»åŠ ä»¥ä¸‹è®¾ç½®ï¼š</li>
</ul>
<pre><code class="language-json">{
    "coverage-gutters.coverageFileNames": [
        "lcov.info",
        "cov.xml",
        "coverage.xml",
    ],
    "coverage-gutters.showLineCoverage": true
}
</code></pre>
<ul>
<li>ç°åœ¨ä½ åº”è¯¥èƒ½çœ‹åˆ°è¢«æµ‹è¯•ä»£ç çš„ç»¿è‰²é«˜äº®ï¼Œä»¥åŠæœªè¢«æµ‹è¯•ä»£ç çš„çº¢è‰²é«˜äº®ã€‚</li>
</ul>
<h2 id="èµåŠ©æ­¤é¡¹ç›®"><a class="header" href="#èµåŠ©æ­¤é¡¹ç›®">èµåŠ©æ­¤é¡¹ç›®</a></h2>
<p>ç›®å‰å°šæ— å®˜æ–¹ç»„ç»‡ä»£è¡¨ PyO3 æ¥å—èµåŠ©ã€‚å¦‚æœä½ å¸Œæœ›ä¸º PyO3 ç”Ÿæ€ç³»ç»Ÿæä¾›é‡å¤§èµ„é‡‘æ”¯æŒï¼Œè¯·é€šè¿‡ <a href="https://github.com/PyO3/pyo3/issues/new">GitHub</a> æˆ– <a href="https://discord.gg/33kcChzH7f">Discord</a> ä¸æˆ‘ä»¬è”ç³»ï¼Œæˆ‘ä»¬å¯ä»¥è¿›ä¸€æ­¥è®¨è®ºã€‚</p>
<p>åœ¨æ­¤æœŸé—´ï¼Œéƒ¨åˆ†ç»´æŠ¤è€…æ‹¥æœ‰ä¸ªäºº GitHub èµåŠ©é¡µé¢ï¼Œä»–ä»¬å°†éå¸¸æ„Ÿè°¢ä½ çš„æ”¯æŒï¼š</p>
<ul>
<li><a href="https://github.com/sponsors/davidhewitt">davidhewitt</a></li>
<li><a href="https://github.com/sponsors/messense">messense</a></li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>

        <template id=fa-eye><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M288 32c-80.8 0-145.5 36.8-192.6 80.6C48.6 156 17.3 208 2.5 243.7c-3.3 7.9-3.3 16.7 0 24.6C17.3 304 48.6 356 95.4 399.4C142.5 443.2 207.2 480 288 480s145.5-36.8 192.6-80.6c46.8-43.5 78.1-95.4 93-131.1c3.3-7.9 3.3-16.7 0-24.6c-14.9-35.7-46.2-87.7-93-131.1C433.5 68.8 368.8 32 288 32zM432 256c0 79.5-64.5 144-144 144s-144-64.5-144-144s64.5-144 144-144s144 64.5 144 144zM288 192c0 35.3-28.7 64-64 64c-11.5 0-22.3-3-31.6-8.4c-.2 2.8-.4 5.5-.4 8.4c0 53 43 96 96 96s96-43 96-96s-43-96-96-96c-2.8 0-5.6 .1-8.4 .4c5.3 9.3 8.4 20.1 8.4 31.6z"/></svg></span></template>
        <template id=fa-eye-slash><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M38.8 5.1C28.4-3.1 13.3-1.2 5.1 9.2S-1.2 34.7 9.2 42.9l592 464c10.4 8.2 25.5 6.3 33.7-4.1s6.3-25.5-4.1-33.7L525.6 386.7c39.6-40.6 66.4-86.1 79.9-118.4c3.3-7.9 3.3-16.7 0-24.6c-14.9-35.7-46.2-87.7-93-131.1C465.5 68.8 400.8 32 320 32c-68.2 0-125 26.3-169.3 60.8L38.8 5.1zM223.1 149.5C248.6 126.2 282.7 112 320 112c79.5 0 144 64.5 144 144c0 24.9-6.3 48.3-17.4 68.7L408 294.5c5.2-11.8 8-24.8 8-38.5c0-53-43-96-96-96c-2.8 0-5.6 .1-8.4 .4c5.3 9.3 8.4 20.1 8.4 31.6c0 10.2-2.4 19.8-6.6 28.3l-90.3-70.8zm223.1 298L373 389.9c-16.4 6.5-34.3 10.1-53 10.1c-79.5 0-144-64.5-144-144c0-6.9 .5-13.6 1.4-20.2L83.1 161.5C60.3 191.2 44 220.8 34.5 243.7c-3.3 7.9-3.3 16.7 0 24.6c14.9 35.7 46.2 87.7 93 131.1C174.5 443.2 239.2 480 320 480c47.8 0 89.9-12.9 126.2-32.5z"/></svg></span></template>
        <template id=fa-copy><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M502.6 70.63l-61.25-61.25C435.4 3.371 427.2 0 418.7 0H255.1c-35.35 0-64 28.66-64 64l.0195 256C192 355.4 220.7 384 256 384h192c35.2 0 64-28.8 64-64V93.25C512 84.77 508.6 76.63 502.6 70.63zM464 320c0 8.836-7.164 16-16 16H255.1c-8.838 0-16-7.164-16-16L239.1 64.13c0-8.836 7.164-16 16-16h128L384 96c0 17.67 14.33 32 32 32h47.1V320zM272 448c0 8.836-7.164 16-16 16H63.1c-8.838 0-16-7.164-16-16L47.98 192.1c0-8.836 7.164-16 16-16H160V128H63.99c-35.35 0-64 28.65-64 64l.0098 256C.002 483.3 28.66 512 64 512h192c35.2 0 64-28.8 64-64v-32h-47.1L272 448z"/></svg></span></template>
        <template id=fa-play><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M73 39c-14.8-9.1-33.4-9.4-48.5-.9S0 62.6 0 80V432c0 17.4 9.4 33.4 24.5 41.9s33.7 8.1 48.5-.9L361 297c14.3-8.7 23-24.2 23-41s-8.7-32.2-23-41L73 39z"/></svg></span></template>
        <template id=fa-clock-rotate-left><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M75 75L41 41C25.9 25.9 0 36.6 0 57.9V168c0 13.3 10.7 24 24 24H134.1c21.4 0 32.1-25.9 17-41l-30.8-30.8C155 85.5 203 64 256 64c106 0 192 86 192 192s-86 192-192 192c-40.8 0-78.6-12.7-109.7-34.4c-14.5-10.1-34.4-6.6-44.6 7.9s-6.6 34.4 7.9 44.6C151.2 495 201.7 512 256 512c141.4 0 256-114.6 256-256S397.4 0 256 0C185.3 0 121.3 28.7 75 75zm181 53c-13.3 0-24 10.7-24 24V256c0 6.4 2.5 12.5 7 17l72 72c9.4 9.4 24.6 9.4 33.9 0s9.4-24.6 0-33.9l-65-65V152c0-13.3-10.7-24-24-24z"/></svg></span></template>



        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr-ef4e11c1.min.js"></script>
        <script src="mark-09e88c2c.min.js"></script>
        <script src="searcher-c2a407aa.js"></script>

        <script src="clipboard-1626706a.min.js"></script>
        <script src="highlight-abc7f01d.js"></script>
        <script src="book-a0b12cfe.js"></script>

        <!-- Custom JS scripts -->
        <script src="theme/tabs-6977231d.js"></script>

        <script>
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>


    </div>
    </body>
</html>
