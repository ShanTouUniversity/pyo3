<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>é™„å½• Aï¼šè¿ç§»æŒ‡å— - PyO3 user guide</title>


        <!-- Custom HTML head -->

        <meta name="description" content="PyO3 user guide">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon-de23e50b.svg">
        <link rel="shortcut icon" href="favicon-8114d1fc.png">
        <link rel="stylesheet" href="css/variables-8adf115d.css">
        <link rel="stylesheet" href="css/general-2459343d.css">
        <link rel="stylesheet" href="css/chrome-ae938929.css">
        <link rel="stylesheet" href="css/print-9e4910d8.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="fonts/fonts-9644e21d.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="mdbook-highlight-css" href="highlight-493f70e1.css">
        <link rel="stylesheet" id="mdbook-tomorrow-night-css" href="tomorrow-night-4c0ae647.css">
        <link rel="stylesheet" id="mdbook-ayu-highlight-css" href="ayu-highlight-3fdfc3ac.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="theme/tabs-52f01167.css">


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "searchindex-78070eb0.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="toc-c528a6fa.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>â†</kbd> or <kbd>â†’</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="mdbook-body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="mdbook-sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("mdbook-sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="mdbook-sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="toc.html"></iframe>
            </noscript>
            <div id="mdbook-sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="mdbook-page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="mdbook-menu-bar-hover-placeholder"></div>
                <div id="mdbook-menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="mdbook-sidebar-toggle" class="icon-button" for="mdbook-sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="mdbook-sidebar">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M0 96C0 78.3 14.3 64 32 64H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32C14.3 128 0 113.7 0 96zM0 256c0-17.7 14.3-32 32-32H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32c-17.7 0-32-14.3-32-32zM448 416c0 17.7-14.3 32-32 32H32c-17.7 0-32-14.3-32-32s14.3-32 32-32H416c17.7 0 32 14.3 32 32z"/></svg></span>
                        </label>
                        <button id="mdbook-theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="mdbook-theme-list">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M371.3 367.1c27.3-3.9 51.9-19.4 67.2-42.9L600.2 74.1c12.6-19.5 9.4-45.3-7.6-61.2S549.7-4.4 531.1 9.6L294.4 187.2c-24 18-38.2 46.1-38.4 76.1L371.3 367.1zm-19.6 25.4l-116-104.4C175.9 290.3 128 339.6 128 400c0 3.9 .2 7.8 .6 11.6c1.8 17.5-10.2 36.4-27.8 36.4H96c-17.7 0-32 14.3-32 32s14.3 32 32 32H240c61.9 0 112-50.1 112-112c0-2.5-.1-5-.2-7.5z"/></svg></span>
                        </button>
                        <ul id="mdbook-theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-ayu">Ayu</button></li>
                        </ul>
                        <button id="mdbook-search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="mdbook-searchbar">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M416 208c0 45.9-14.9 88.3-40 122.7L502.6 457.4c12.5 12.5 12.5 32.8 0 45.3s-32.8 12.5-45.3 0L330.7 376c-34.4 25.2-76.8 40-122.7 40C93.1 416 0 322.9 0 208S93.1 0 208 0S416 93.1 416 208zM208 352c79.5 0 144-64.5 144-144s-64.5-144-144-144S64 128.5 64 208s64.5 144 144 144z"/></svg></span>
                        </button>
                    </div>

                    <h1 class="menu-title">PyO3 user guide</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <span class=fa-svg id="print-button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M128 0C92.7 0 64 28.7 64 64v96h64V64H354.7L384 93.3V160h64V93.3c0-17-6.7-33.3-18.7-45.3L400 18.7C388 6.7 371.7 0 354.7 0H128zM384 352v32 64H128V384 368 352H384zm64 32h32c17.7 0 32-14.3 32-32V256c0-35.3-28.7-64-64-64H64c-35.3 0-64 28.7-64 64v96c0 17.7 14.3 32 32 32H64v64c0 35.3 28.7 64 64 64H384c35.3 0 64-28.7 64-64V384zm-16-88c-13.3 0-24-10.7-24-24s10.7-24 24-24s24 10.7 24 24s-10.7 24-24 24z"/></svg></span>
                        </a>
                        <a href="https://github.com/PyO3/pyo3/tree/main/guide" title="Git repository" aria-label="Git repository">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg></span>
                        </a>
                        <a href="https://github.com/PyO3/pyo3/edit/main/guide/src/migration.md" title="Suggest an edit" aria-label="Suggest an edit" rel="edit">
                            <span class=fa-svg id="git-edit-button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M421.7 220.3l-11.3 11.3-22.6 22.6-205 205c-6.6 6.6-14.8 11.5-23.8 14.1L30.8 511c-8.4 2.5-17.5 .2-23.7-6.1S-1.5 489.7 1 481.2L38.7 353.1c2.6-9 7.5-17.2 14.1-23.8l205-205 22.6-22.6 11.3-11.3 33.9 33.9 62.1 62.1 33.9 33.9zM96 353.9l-9.3 9.3c-.9 .9-1.6 2.1-2 3.4l-25.3 86 86-25.3c1.3-.4 2.5-1.1 3.4-2l9.3-9.3H112c-8.8 0-16-7.2-16-16V353.9zM453.3 19.3l39.4 39.4c25 25 25 65.5 0 90.5l-14.5 14.5-22.6 22.6-11.3 11.3-33.9-33.9-62.1-62.1L314.3 67.7l11.3-11.3 22.6-22.6 14.5-14.5c25-25 65.5-25 90.5 0z"/></svg></span>
                        </a>

                    </div>
                </div>

                <div id="mdbook-search-wrapper" class="hidden">
                    <form id="mdbook-searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="mdbook-searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="mdbook-searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <span class=fa-svg id="fa-spin"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M304 48c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zm0 416c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zM48 304c26.5 0 48-21.5 48-48s-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48zm464-48c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zM142.9 437c18.7-18.7 18.7-49.1 0-67.9s-49.1-18.7-67.9 0s-18.7 49.1 0 67.9s49.1 18.7 67.9 0zm0-294.2c18.7-18.7 18.7-49.1 0-67.9S93.7 56.2 75 75s-18.7 49.1 0 67.9s49.1 18.7 67.9 0zM369.1 437c18.7 18.7 49.1 18.7 67.9 0s18.7-49.1 0-67.9s-49.1-18.7-67.9 0s-18.7 49.1 0 67.9z"/></svg></span>
                            </div>
                        </div>
                    </form>
                    <div id="mdbook-searchresults-outer" class="searchresults-outer hidden">
                        <div id="mdbook-searchresults-header" class="searchresults-header"></div>
                        <ul id="mdbook-searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('mdbook-sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('mdbook-sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#mdbook-sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="mdbook-content" class="content">
                    <main>
                        <h1 id="ä»æ—§ç‰ˆæœ¬-pyo3-è¿ç§»"><a class="header" href="#ä»æ—§ç‰ˆæœ¬-pyo3-è¿ç§»">ä»æ—§ç‰ˆæœ¬ PyO3 è¿ç§»</a></h1>
<p>æœ¬æŒ‡å—å¯å¸®åŠ©æ‚¨å°†ä»£ç ä»ä¸€ä¸ª PyO3 ç‰ˆæœ¬å‡çº§åˆ°ä¸‹ä¸€ä¸ªç‰ˆæœ¬ï¼Œä»¥åº”å¯¹ç ´åæ€§å˜æ›´ã€‚<br>å…³äºæ‰€æœ‰å˜æ›´çš„è¯¦ç»†åˆ—è¡¨ï¼Œè¯·å‚é˜… <a href="changelog.html">å˜æ›´æ—¥å¿—</a>ã€‚</p>
<h2 id="ä»-026-åˆ°-027"><a class="header" href="#ä»-026-åˆ°-027">ä» 0.26.* åˆ° 0.27</a></h2>
<h3 id="frompyobject-é‡æ„ä»¥æå‡çµæ´»æ€§å’Œæ•ˆç‡"><a class="header" href="#frompyobject-é‡æ„ä»¥æå‡çµæ´»æ€§å’Œæ•ˆç‡"><code>FromPyObject</code> é‡æ„ä»¥æå‡çµæ´»æ€§å’Œæ•ˆç‡</a></h3>
<details open="">
<summary><small>ç‚¹å‡»å±•å¼€</small></summary>
<p>éšç€ PyO3 0.23 ä¸­ç§»é™¤äº† <code>gil-ref</code> APIï¼Œç°åœ¨å¯ä»¥å®Œå…¨åˆ†ç¦» Python ç”Ÿå‘½å‘¨æœŸ <code>'py</code> å’Œè¾“å…¥ç”Ÿå‘½å‘¨æœŸ <code>'a</code>ã€‚è¿™å…è®¸ä»è¾“å…¥æ•°æ®ä¸­å€Ÿç”¨ï¼Œè€Œä¸ä¼šå°†ç”Ÿå‘½å‘¨æœŸå»¶é•¿è‡³ä¸è§£é‡Šå™¨ç»‘å®šã€‚</p>
<p><code>FromPyObject</code> ç°åœ¨æ¥å—ä¸€ä¸ªé¢å¤–çš„ç”Ÿå‘½å‘¨æœŸå‚æ•° <code>'a</code>ï¼Œç”¨äºæè¿°è¾“å…¥æ•°æ®çš„ç”Ÿå‘½å‘¨æœŸã€‚<code>extract</code> æ–¹æ³•çš„å‚æ•°ç±»å‹ä» <code>&amp;Bound&lt;'py, PyAny&gt;</code> å˜æ›´ä¸º <code>Borrowed&lt;'a, 'py, PyAny&gt;</code>ã€‚è¿™æ˜¯å› ä¸º <code>&amp;'a Bound&lt;'py, PyAny&gt;</code> ä¼šç”±äºå¼•ç”¨ç±»å‹å¯¼è‡´éšå¼çº¦æŸ <code>'py: 'a</code>ã€‚</p>
<p>è¿™ç§æ–°å½¢å¼æ—©åœ¨ 0.22 ç‰ˆæœ¬ä¸­å°±å·²é€šè¿‡å†…éƒ¨çš„ <code>FromPyObjectBound</code> trait éƒ¨åˆ†å®ç°ï¼Œç°åœ¨å·²æ‰©å±•è‡³æ‰€æœ‰ç±»å‹ã€‚</p>
<p>å¤§å¤šæ•°å®ç°åªéœ€æ·»åŠ ä¸€ä¸ªçœç•¥çš„ç”Ÿå‘½å‘¨æœŸå³å¯å®Œæˆè¿ç§»ã€‚</p>
<p>æ­¤å¤–ï¼Œ<code>FromPyObject</code> æ–°å¢äº†ä¸€ä¸ªå…³è”ç±»å‹ <code>Error</code>ï¼Œç”¨äºè¡¨ç¤ºè½¬æ¢å¤±è´¥æ—¶çš„é”™è¯¯ç±»å‹ã€‚åœ¨è¿ç§»è¿‡ç¨‹ä¸­ä½¿ç”¨ <code>PyErr</code> æ˜¯ä¸€ä¸ªä¸é”™çš„é»˜è®¤é€‰æ‹©ï¼Œåç»­å¯å¼•å…¥è‡ªå®šä¹‰é”™è¯¯ç±»å‹ä»¥é¿å…ä¸å¿…è¦çš„ Python å¼‚å¸¸å¯¹è±¡åˆ›å»ºï¼Œå¹¶æå‡ç±»å‹å®‰å…¨æ€§ã€‚</p>
<p>è¿ç§»å‰ï¼š</p>
<pre><code class="language-rust ignore">impl&lt;'py&gt; FromPyObject&lt;'py&gt; for IpAddr {
    fn extract_bound(obj: &amp;Bound&lt;'py, PyAny&gt;) -&gt; PyResult&lt;Self&gt; {
        ...
    }
}</code></pre>
<p>è¿ç§»åï¼š</p>
<pre><code class="language-rust ignore">impl&lt;'py&gt; FromPyObject&lt;'_, 'py&gt; for IpAddr {
    type Error = PyErr;

    fn extract(obj: Borrowed&lt;'_, 'py, PyAny&gt;) -&gt; Result&lt;Self, Self::Error&gt; {
        ...
        // ç”±äº `Borrowed` å®ç°äº† `Deref` åˆ° `&amp;Bound`ï¼Œå‡½æ•°ä½“é€šå¸¸æ— éœ€ä¿®æ”¹ï¼Œ
        // æˆ–ä»…éœ€å¶å°”æ·»åŠ  `&amp;`
    }
}</code></pre>
<p>åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œå¯èƒ½éœ€è¦æ›´å¤šæ­¥éª¤ã€‚å¯¹äºæ³›å‹ç±»å‹ï¼Œéœ€è¦è°ƒæ•´çº¦æŸæ¡ä»¶ï¼Œå…·ä½“çº¦æŸå–å†³äºç±»å‹çš„ä½¿ç”¨æ–¹å¼ã€‚</p>
<p>å¯¹äºç®€å•çš„åŒ…è£…ç±»å‹ï¼Œé€šå¸¸å¯ä»¥ç›´æ¥è½¬å‘çº¦æŸã€‚</p>
<p>è¿ç§»å‰ï¼š</p>
<pre><code class="language-rust ignore">struct MyWrapper&lt;T&gt;(T);

impl&lt;'py, T&gt; FromPyObject&lt;'py&gt; for MyWrapper&lt;T&gt;
where
    T: FromPyObject&lt;'py&gt;
{
    fn extract_bound(obj: &amp;Bound&lt;'py, PyAny&gt;) -&gt; PyResult&lt;Self&gt; {
        ob.extract().map(MyWrapper)
    }
}</code></pre>
<p>è¿ç§»åï¼š</p>
<pre><code class="language-rust"><span class="boring">use pyo3::prelude::*;
</span><span class="boring">#[allow(dead_code)]
</span><span class="boring">pub struct MyWrapper&lt;T&gt;(T);
</span>impl&lt;'a, 'py, T&gt; FromPyObject&lt;'a, 'py&gt; for MyWrapper&lt;T&gt;
where
    T: FromPyObject&lt;'a, 'py&gt;
{
    type Error = T::Error;

    fn extract(obj: Borrowed&lt;'a, 'py, PyAny&gt;) -&gt; Result&lt;Self, Self::Error&gt; {
        obj.extract().map(MyWrapper)
    }
}</code></pre>
<p>å¯¹äºåœ¨æå–è¿‡ç¨‹ä¸­éœ€è¦åˆ›å»ºä¸´æ—¶ Python å¼•ç”¨çš„å®¹å™¨ç±»å‹ï¼ˆä¾‹å¦‚ä» <code>PyList</code> æå–ï¼‰ï¼Œéœ€è¦æ›´å¼ºçš„çº¦æŸã€‚ä¸ºæ­¤å¼•å…¥äº† <code>FromPyObjectOwned</code> traitã€‚å¯¹äºä»»ä½•å®ç°äº† <code>FromPyObject</code> ä¸”æœªä»è¾“å…¥å€Ÿç”¨çš„ç±»å‹ï¼Œéƒ½ä¼šè‡ªåŠ¨å®ç°è¯¥ traitã€‚å»ºè®®åœ¨è¿™äº›åœºæ™¯ä¸‹å°†å…¶ç”¨ä½œ trait boundã€‚</p>
<p>è¿ç§»å‰ï¼š</p>
<pre><code class="language-rust ignore">struct MyVec&lt;T&gt;(Vec&lt;T&gt;);
impl&lt;'py, T&gt; FromPyObject&lt;'py&gt; for Vec&lt;T&gt;
where
    T: FromPyObject&lt;'py&gt;,
{
    fn extract_bound(obj: &amp;Bound&lt;'py, PyAny&gt;) -&gt; PyResult&lt;Self&gt; {
        let mut v = MyVec(Vec::new());
        for item in obj.try_iter()? {
            v.0.push(item?.extract::&lt;T&gt;()?);
        }
        Ok(v)
    }
}</code></pre>
<p>è¿ç§»åï¼š</p>
<pre><code class="language-rust"><span class="boring">use pyo3::prelude::*;
</span><span class="boring">#[allow(dead_code)]
</span><span class="boring">pub struct MyVec&lt;T&gt;(Vec&lt;T&gt;);
</span>impl&lt;'py, T&gt; FromPyObject&lt;'_, 'py&gt; for MyVec&lt;T&gt;
where
    T: FromPyObjectOwned&lt;'py&gt; // ğŸ‘ˆ åªèƒ½æå–æ‹¥æœ‰æ‰€æœ‰æƒçš„å€¼ï¼Œå› ä¸ºä¸‹é¢æ¯ä¸ª `item`
                              //    éƒ½æ˜¯ä¸´æ—¶çš„ã€ç”Ÿå‘½å‘¨æœŸçŸ­æš‚çš„æ‹¥æœ‰æƒå¼•ç”¨
{
    type Error = PyErr;

    fn extract(obj: Borrowed&lt;'_, 'py, PyAny&gt;) -&gt; Result&lt;Self, Self::Error&gt; {
        let mut v = MyVec(Vec::new());
        for item in obj.try_iter()? {
            v.0.push(item?.extract::&lt;T&gt;().map_err(Into::into)?); // éœ€è¦ `map_err`ï¼Œå› ä¸º `?` ä½¿ç”¨ `From` è€Œé `Into` ğŸ™
        }
        Ok(v)
    }
}</code></pre>
<p>è¿™ä¸ <code>serde</code> çš„ <a href="https://docs.rs/serde/latest/serde/trait.Deserialize.html"><code>Deserialize</code></a> å’Œ <a href="https://docs.rs/serde/latest/serde/de/trait.DeserializeOwned.html"><code>DeserializeOwned</code></a> trait éå¸¸ç›¸ä¼¼ï¼Œè¯¦è§ <a href="https://serde.rs/lifetimes.html">æ­¤å¤„</a>ã€‚</p>
</details>
<h2 id="downcast-å’Œ-downcasterror-æ›¿æ¢ä¸º-cast-å’Œ-casterror"><a class="header" href="#downcast-å’Œ-downcasterror-æ›¿æ¢ä¸º-cast-å’Œ-casterror"><code>.downcast()</code> å’Œ <code>DowncastError</code> æ›¿æ¢ä¸º <code>.cast()</code> å’Œ <code>CastError</code></a></h2>
<p><code>.downcast()</code> ç³»åˆ—å‡½æ•°åŸæœ¬ä»…åœ¨ <code>Bound&lt;PyAny&gt;</code> ä¸Šå¯ç”¨ã€‚åœ¨æŸäº›è¾¹ç¼˜æƒ…å†µï¼ˆç‰¹åˆ«æ˜¯ä¸ <code>.downcast_into()</code> ç›¸å…³ï¼‰ä¸‹ï¼Œè¿™éœ€è¦ä½¿ç”¨ <code>.as_any().downcast()</code> æˆ– <code>.into_any().downcast_into()</code> é“¾å¼è°ƒç”¨ã€‚æ­¤å¤–ï¼Œ<code>DowncastError</code> ç”Ÿæˆçš„ Python å¼‚å¸¸æ¶ˆæ¯ç”±äºä½¿ç”¨äº† Rust ç±»å‹åç§°è€Œä¸å¤Ÿâ€œPythonicâ€ã€‚</p>
<p><code>.cast()</code> ç³»åˆ—å‡½æ•°ç°åœ¨å¯åœ¨æ‰€æœ‰ <code>Bound</code> å’Œ <code>Borrowed</code> æ™ºèƒ½æŒ‡é’ˆä¸Šä½¿ç”¨ï¼ˆæ— è®ºå…¶ç±»å‹ï¼‰ï¼Œå¹¶ä¸”å…¶é”™è¯¯æ¶ˆæ¯åœ¨è¿è¡Œæ—¶ç”±å®é™…ç±»å‹åŠ¨æ€ç”Ÿæˆã€‚è¿™ä¸º PyO3 æ¨¡å—çš„ä½œè€…å’Œä½¿ç”¨è€…å¸¦æ¥äº†æ›´å‹å¥½çš„ä½“éªŒã€‚</p>
<p>è¿ç§»æ–¹æ³•ï¼šå°† <code>.downcast()</code> æ›¿æ¢ä¸º <code>.cast()</code>ï¼Œå°† <code>DowncastError</code> æ›¿æ¢ä¸º <code>CastError</code>ï¼ˆç±»ä¼¼åœ°ï¼Œ<code>.downcast_into()</code> æ›¿æ¢ä¸º <code>.cast_into()</code>ï¼Œ<code>DowncastIntoError</code> æ›¿æ¢ä¸º <code>CastIntoError</code> ç­‰ï¼‰ã€‚</p>
<p><code>CastError</code> éœ€è¦ä¸€ä¸ª Python <code>type</code> å¯¹è±¡ï¼ˆæˆ–å…¶ä»–ä¸ <code>isinstance()</code> å…¼å®¹çš„â€œç±»ä¿¡æ¯â€å¯¹è±¡ï¼‰ä½œä¸ºç¬¬äºŒä¸ªå‚æ•°ï¼Œå› æ­¤åœ¨æå°‘æ•°æ‰‹åŠ¨æ„é€  <code>DowncastError</code> çš„æƒ…å†µä¸‹ï¼Œä»£ç å¯èƒ½éœ€è¦å°‘é‡è°ƒæ•´ã€‚</p>
<h2 id="pytypecheck-ç°åœ¨æ˜¯ä¸€ä¸ª-unsafe-trait"><a class="header" href="#pytypecheck-ç°åœ¨æ˜¯ä¸€ä¸ª-unsafe-trait"><code>PyTypeCheck</code> ç°åœ¨æ˜¯ä¸€ä¸ª <code>unsafe trait</code></a></h2>
<p>ç”±äº <code>PyTypeCheck</code> æ˜¯ç”¨äºä¿æŠ¤ <code>.cast()</code> å‡½æ•°ä»¥å°† Python å¯¹è±¡è§†ä¸ºç‰¹å®šå…·ä½“ç±»å‹çš„ traitï¼Œå› æ­¤å…¶å®ç°æ˜¯ <code>unsafe</code> çš„ã€‚</p>
<p>è¿™æœ¬åº”ä»ä¸€å¼€å§‹å°±æ˜¯è¿™æ ·ï¼Œæ­¤å‰åœ¨åˆå§‹å®ç°ä¸­é—æ¼äº†è¿™ä¸€ç‚¹ï¼Œæ­¤æ¬¡å‘å¸ƒä¸­å·²äºˆä»¥çº æ­£ã€‚</p>
<h2 id="ä»-025-åˆ°-026"><a class="header" href="#ä»-025-åˆ°-026">ä» 0.25.* åˆ° 0.26</a></h2>
<h3 id="é‡å‘½å-pythonwith_gilpythonallow_threads-å’Œ-pyo3prepare_freethreaded_python"><a class="header" href="#é‡å‘½å-pythonwith_gilpythonallow_threads-å’Œ-pyo3prepare_freethreaded_python">é‡å‘½å <code>Python::with_gil</code>ã€<code>Python::allow_threads</code> å’Œ <code>pyo3::prepare_freethreaded_python</code></a></h3>
<details open="">
<summary><small>ç‚¹å‡»å±•å¼€</small></summary>
<p>è¿™äº› API çš„åç§°æ˜¯åœ¨å…¨å±€è§£é‡Šå™¨é”ï¼ˆGILï¼‰å¼ºåˆ¶å¯ç”¨çš„èƒŒæ™¯ä¸‹åˆ›å»ºçš„ã€‚éšç€ Python 3.13 ä¸­è‡ªç”±çº¿ç¨‹çš„å¼•å…¥ï¼Œè¿™ç§æƒ…å†µå·²ä¸å¤å­˜åœ¨ï¼Œè¿™äº›å‘½åä¸å†å…·æœ‰æ™®éæ„ä¹‰ã€‚<br>å› æ­¤ï¼Œæˆ‘ä»¬é€‰æ‹©å°†å…¶é‡å‘½åä¸ºè‡ªç”±çº¿ç¨‹å¼•å…¥çš„æ›´ç°ä»£æœ¯è¯­ï¼š</p>
<ul>
<li><code>Python::with_gil</code> ç°åœ¨ç§°ä¸º <code>Python::attach</code>ï¼Œå®ƒå°† Python çº¿ç¨‹çŠ¶æ€é™„åŠ åˆ°å½“å‰çº¿ç¨‹ã€‚åœ¨å¯ç”¨ GIL çš„æ„å»ºä¸­ï¼Œåªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½é™„åŠ åˆ°è§£é‡Šå™¨ï¼›åœ¨è‡ªç”±çº¿ç¨‹æ¨¡å¼ä¸‹å¯ä»¥æœ‰å¤šä¸ªã€‚</li>
<li><code>Python::allow_threads</code> ç°åœ¨ç§°ä¸º <code>Python::detach</code>ï¼Œå®ƒåˆ†ç¦»ä¹‹å‰é™„åŠ çš„çº¿ç¨‹çŠ¶æ€ã€‚</li>
<li><code>pyo3::prepare_freethreaded_python</code> ç°åœ¨ç§°ä¸º <code>Python::initialize</code>ã€‚</li>
</ul>
</details>
<h3 id="å¼ƒç”¨-pyobject-ç±»å‹åˆ«å"><a class="header" href="#å¼ƒç”¨-pyobject-ç±»å‹åˆ«å">å¼ƒç”¨ <code>PyObject</code> ç±»å‹åˆ«å</a></h3>
<details open="">
<summary><small>ç‚¹å‡»å±•å¼€</small></summary>
<p>ç±»å‹åˆ«å <code>PyObject</code>ï¼ˆå³ <code>Py&lt;PyAny&gt;</code>ï¼‰ç»å¸¸ä¸åŒåçš„ FFI å®šä¹‰ <code>pyo3::ffi::PyObject</code> æ··æ·†ã€‚å› æ­¤æˆ‘ä»¬å†³å®šå¼ƒç”¨å…¶ä½¿ç”¨ã€‚è¿ç§»æ—¶åªéœ€å°†å…¶æ›¿æ¢ä¸ºç›®æ ‡ç±»å‹ <code>Py&lt;PyAny&gt;</code> å³å¯ã€‚</p>
</details>
<h3 id="ä½¿ç”¨-pyoncelock-æ›¿ä»£-giloncecell"><a class="header" href="#ä½¿ç”¨-pyoncelock-æ›¿ä»£-giloncecell">ä½¿ç”¨ <code>PyOnceLock</code> æ›¿ä»£ <code>GILOnceCell</code></a></h3>
<details open="">
<summary><small>ç‚¹å‡»å±•å¼€</small></summary>
<p>ç±»ä¼¼äºä¸Šè¿°å¯¹ <code>Python::with_gil</code> åŠç›¸å…³ API çš„é‡å‘½åï¼Œ<code>GILOnceCell</code> ç±»å‹æœ€åˆæ˜¯ä¸ºå— GIL é™åˆ¶çš„ Python è§£é‡Šå™¨è®¾è®¡çš„ã€‚é™¤åç§°å¤–ï¼Œå®ƒå…è®¸â€œä¸€æ¬¡æ€§â€åˆå§‹åŒ–å‘ç”Ÿç«äº‰ï¼Œå› ä¸ºè¿™ç§ç«äº‰ç”± GIL åè°ƒï¼Œåœ¨å®é™…ä¸­æä¸å¯èƒ½å‡ºç°é—®é¢˜ã€‚</p>
<p>éšç€è‡ªç”±çº¿ç¨‹ Python çš„å¼•å…¥ï¼Œç«äº‰æ€§åˆå§‹åŒ–è¡Œä¸ºæ›´æœ‰å¯èƒ½å¼•å‘é—®é¢˜ã€‚å› æ­¤å¼•å…¥äº†æ–°çš„ç±»å‹ <code>PyOnceLock</code>ï¼Œå®ƒèƒ½åœ¨æ­£ç¡®é™„åŠ åˆ° Python è§£é‡Šå™¨çš„åŒæ—¶ï¼Œç¡®ä¿çœŸæ­£çš„å•æ¬¡åˆå§‹åŒ–ã€‚å®ƒæš´éœ²çš„ API ä¸ <code>GILOnceCell</code> ç›¸åŒï¼Œå› æ­¤é€šå¸¸æ˜¯ç›´æ¥æ›¿æ¢ã€‚ä½†å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœæ­¤å‰æ„å¤–ä¾èµ–äº† <code>GILOnceCell</code> çš„ç«äº‰åˆå§‹åŒ–è¡Œä¸ºï¼ˆä¾‹å¦‚ç”±äºå¾ªç¯å¼•ç”¨ï¼‰ï¼Œé‚£ä¹ˆ <code>PyOnceLock</code> æ›´å¼ºçš„â€œä»…ä¸€æ¬¡â€ä¿è¯å¯èƒ½å¯¼è‡´æ­»é”ï¼Œéœ€è¦é‡æ„ä»£ç ã€‚</p>
<p>è¿ç§»å‰ï¼š</p>
<pre><code class="language-rust"><span class="boring">#![allow(deprecated)]
</span><span class="boring">use pyo3::prelude::*;
</span><span class="boring">use pyo3::sync::GILOnceCell;
</span><span class="boring">use pyo3::types::PyType;
</span><span class="boring">fn main() -&gt; PyResult&lt;()&gt; {
</span><span class="boring">Python::attach(|py| {
</span>static DECIMAL_TYPE: GILOnceCell&lt;Py&lt;PyType&gt;&gt; = GILOnceCell::new();
DECIMAL_TYPE.import(py, "decimal", "Decimal")?;
<span class="boring">Ok(())
</span><span class="boring">})
</span><span class="boring">}</span></code></pre>
<p>è¿ç§»åï¼š</p>
<pre><code class="language-rust"><span class="boring">use pyo3::prelude::*;
</span><span class="boring">use pyo3::sync::PyOnceLock;
</span><span class="boring">use pyo3::types::PyType;
</span><span class="boring">fn main() -&gt; PyResult&lt;()&gt; {
</span><span class="boring">Python::attach(|py| {
</span>static DECIMAL_TYPE: PyOnceLock&lt;Py&lt;PyType&gt;&gt; = PyOnceLock::new();
DECIMAL_TYPE.import(py, "decimal", "Decimal")?;
<span class="boring">Ok(())
</span><span class="boring">})
</span><span class="boring">}</span></code></pre>
</details>
<h3 id="å¼ƒç”¨-gilprotected"><a class="header" href="#å¼ƒç”¨-gilprotected">å¼ƒç”¨ <code>GILProtected</code></a></h3>
<details open="">
<summary><small>ç‚¹å‡»å±•å¼€</small></summary>
<p>ä½œä¸ºä¸ GIL é™åˆ¶çš„ Python è®¾è®¡çš„å¹¶å‘åŸè¯­ç›¸å…³çš„å¦ä¸€é¡¹æ¸…ç†å·¥ä½œï¼Œ<code>GILProtected</code> ç±»å‹ç°å·²è¢«å¼ƒç”¨ã€‚å»ºè®®ä½¿ç”¨ä¸è‡ªç”±çº¿ç¨‹ Python å…¼å®¹çš„å¹¶å‘åŸè¯­ï¼Œå¦‚ <a href="https://doc.rust-lang.org/std/sync/struct.Mutex.html"><code>std::sync::Mutex</code></a>ï¼ˆç»“åˆ PyO3 çš„ <a href="{{#PYO3_DOCS_URL}}/pyo3/sync/trait.MutexExt.html"><code>MutexExt</code></a> traitï¼‰ã€‚</p>
<p>è¿ç§»å‰ï¼š</p>
<pre><code class="language-rust"><span class="boring">#![allow(deprecated)]
</span><span class="boring">use pyo3::prelude::*;
</span><span class="boring">fn main() {
</span><span class="boring">#[cfg(not(Py_GIL_DISABLED))] {
</span>use pyo3::sync::GILProtected;
use std::cell::RefCell;
<span class="boring">Python::attach(|py| {
</span>static NUMBERS: GILProtected&lt;RefCell&lt;Vec&lt;i32&gt;&gt;&gt; = GILProtected::new(RefCell::new(Vec::new()));
Python::attach(|py| {
    NUMBERS.get(py).borrow_mut().push(42);
});
<span class="boring">})
</span><span class="boring">}
</span><span class="boring">}</span></code></pre>
<p>è¿ç§»åï¼š</p>
<pre><code class="language-rust"><span class="boring">use pyo3::prelude::*;
</span>use pyo3::sync::MutexExt;
use std::sync::Mutex;
<span class="boring">fn main() {
</span><span class="boring">Python::attach(|py| {
</span>static NUMBERS: Mutex&lt;Vec&lt;i32&gt;&gt; = Mutex::new(Vec::new());
Python::attach(|py| {
    NUMBERS.lock_py_attached(py).expect("no poisoning").push(42);
});
<span class="boring">})
</span><span class="boring">}
</span>```&lt;/details&gt;

## `PyMemoryError` ç°åœ¨åœ¨è½¬æ¢ä¸º `io::Error` æ—¶æ˜ å°„åˆ° `io::ErrorKind::OutOfMemory`

&lt;details&gt;
&lt;summary&gt;&lt;small&gt;ç‚¹å‡»å±•å¼€&lt;/small&gt;&lt;/summary&gt;

æ­¤å‰ï¼Œå°† `PyMemoryError` è½¬æ¢ä¸º Rust çš„ `io::Error` æ—¶ï¼Œé”™è¯¯ç±»å‹ï¼ˆkindï¼‰ä¸º `Other`ã€‚ç°åœ¨ï¼Œå®ƒä¼šç”Ÿæˆç±»å‹ä¸º `OutOfMemory` çš„é”™è¯¯ã€‚  
ç±»ä¼¼åœ°ï¼Œå°†ç±»å‹ä¸º `OutOfMemory` çš„ `io::Error` è½¬æ¢å› Python é”™è¯¯æ—¶ï¼Œæ­¤å‰ä¼šå¾—åˆ°ä¸€ä¸ªé€šç”¨çš„ `PyOSError`ï¼Œè€Œç°åœ¨åˆ™ä¼šå¾—åˆ° `PyMemoryError`ã€‚

è¿™ä¸€æ›´æ”¹ä½¿é”™è¯¯è½¬æ¢æ›´åŠ ç²¾ç¡®ï¼Œå¹¶åœ¨ Python å’Œ Rust ä¹‹é—´ç»Ÿä¸€äº†å†…å­˜è€—å°½é”™è¯¯çš„è¯­ä¹‰ã€‚
&lt;/details&gt;

# ä» 0.24.* å‡çº§åˆ° 0.25

## `AsPyPointer` çš„ç§»é™¤

&lt;details&gt;
&lt;summary&gt;&lt;small&gt;ç‚¹å‡»å±•å¼€&lt;/small&gt;&lt;/summary&gt;

`AsPyPointer` trait ä¸»è¦æ˜¯å·²è¢«ç§»é™¤çš„ gil-refs API çš„é—ç•™äº§ç‰©ã€‚æœ€åå‰©ä½™çš„ç”¨é€”æ˜¯ GC APIï¼ˆå³ `PyVisit::call`ï¼‰ä»¥åŠå¯¹è±¡èº«ä»½æ¯”è¾ƒï¼ˆ`PyAnyMethods::is` å’Œ `Py::is`ï¼‰ã€‚

`PyVisit::call` å·²æ›´æ–°ä¸ºæ¥å— `T: Into&lt;Option&lt;&amp;Py&lt;T&gt;&gt;&gt;`ï¼Œè¿™ä½¿å¾—å¯ä»¥ä¼ å…¥ç±»å‹ä¸º `&amp;Py&lt;T&gt;`ã€`&amp;Option&lt;Py&lt;T&gt;&gt;` æˆ– `Option&lt;&amp;Py&lt;T&gt;&gt;` çš„å‚æ•°ã€‚è¿ç§»æ—¶é€šå¸¸æ— éœ€ä¿®æ”¹ä»£ç ã€‚

`PyAnyMethods::is` / `Py::is` å·²æ›´æ–°ä¸ºæ¥å— `T: AsRef&lt;Py&lt;PyAny&gt;&gt;`ã€‚æ­¤å¤–ï¼Œè¿˜ä¸º `Py`ã€`Bound` å’Œ `Borrowed` æ·»åŠ äº† `AsRef&lt;Py&lt;PyAny&gt;&gt;` çš„å®ç°ã€‚ç”±äºå·²å­˜åœ¨ `AsRef&lt;Bound&lt;PyAny&gt;&gt; for Bound&lt;T&gt;` çš„å®ç°ï¼Œè¿™å¯èƒ½ä¼šåœ¨éæ³›å‹ä»£ç ä¸­å¼•èµ·ç±»å‹æ¨æ–­é—®é¢˜ã€‚å¯ä»¥é€šè¿‡å°†è¿™äº›è°ƒç”¨ä¸­çš„ `as_ref` æ›¿æ¢ä¸º `as_any` æ¥è½»æ¾å®Œæˆè¿ç§»ã€‚
&lt;/details&gt;

# ä» 0.23.* å‡çº§åˆ° 0.24

&lt;details&gt;
&lt;summary&gt;&lt;small&gt;ç‚¹å‡»å±•å¼€&lt;/small&gt;&lt;/summary&gt;

ä» 0.23 åˆ° 0.24 æ²¡æœ‰éœ€è¦åœ¨æ­¤æŒ‡å—ä¸­ç‰¹åˆ«è®°å½•çš„é‡å¤§å˜æ›´ã€‚
&lt;/details&gt;

# ä» 0.22.* å‡çº§åˆ° 0.23

&lt;details&gt;
&lt;summary&gt;&lt;small&gt;ç‚¹å‡»å±•å¼€&lt;/small&gt;&lt;/summary&gt;

PyO3 0.23 å¯¹å†…éƒ¨å®ç°è¿›è¡Œäº†é‡å¤§é‡æ„ï¼Œå¸¦æ¥ä¸¤ä¸ªä¸»è¦æ”¹è¿›ï¼š

- æ”¯æŒ Python 3.13 çš„æ–°è‡ªç”±çº¿ç¨‹æ„å»ºç‰ˆæœ¬ï¼ˆåˆç§° "3.13t"ï¼‰
- ä½¿ç”¨æ–°çš„ `IntoPyObject` trait é‡æ„åˆ° Python çš„ç±»å‹è½¬æ¢

è¿™ä¸¤é¡¹å˜æ›´éƒ½è¾ƒä¸ºé‡è¦ï¼Œæˆ‘ä»¬å·²å°½åŠ›ç¡®ä¿å°½å¯èƒ½å¤šçš„ç°æœ‰ä»£ç æ— éœ€ä¿®æ”¹å³å¯ç»§ç»­è¿è¡Œã€‚å‡çº§æ—¶å¯èƒ½åœ¨ä»¥ä¸‹ä¸‰ä¸ªæ–¹é¢æ„Ÿå—åˆ°å½±å“ï¼š

- PyO3 çš„æ•°æ®ç»“æ„ [ç°åœ¨æ˜¯çº¿ç¨‹å®‰å…¨çš„](#free-threaded-python-support)ï¼Œä¸å†ä¾èµ– GIL è¿›è¡ŒåŒæ­¥ã€‚ç‰¹åˆ«æ˜¯ï¼Œ`#[pyclass]` ç±»å‹ [ç°åœ¨å¿…é¡»å®ç° `Sync`](./class/thread-safety.md)ã€‚
- æ‚¨ä»£ç åº“ä¸­çš„æŸäº›ç±»å‹å¯èƒ½éœ€è¦å®ç° [`IntoPyObject` trait](#new-intopyobject-trait-unifies-to-python-conversions)ã€‚å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ [`#[derive(IntoPyObject)]`](#intopyobject-and-intopyobjectref-derive-macros) å®ã€‚ç”±äº `IntoPy` å’Œ `ToPyObject` trait è¢«æ›¿æ¢ï¼Œä¼šè§¦å‘å¤§é‡å¼ƒç”¨è­¦å‘Šã€‚
- [æœ€ç»ˆç§»é™¤äº† `gil-refs` åŠŸèƒ½](#gil-refs-feature-removed) ä¹Ÿä¼šå¯¼è‡´å¤§é‡å¼ƒç”¨è­¦å‘Šï¼Œä½†è¿™ä¸º PyO3 çš„ "Bound" API æ¸…ç†å’Œç®€åŒ–è…¾å‡ºäº†ç©ºé—´ã€‚

ä¸‹æ–‡å°†æ›´æ·±å…¥åœ°è®¨è®ºæ¯é¡¹å˜æ›´çš„åŸç†å’Œç»†èŠ‚ã€‚
&lt;/details&gt;

## è‡ªç”±çº¿ç¨‹ Python æ”¯æŒ

&lt;details&gt;
&lt;summary&gt;&lt;small&gt;ç‚¹å‡»å±•å¼€&lt;/small&gt;&lt;/summary&gt;

PyO3 0.23 å¼•å…¥äº†å¯¹ CPython 3.13 æ–°çš„è‡ªç”±çº¿ç¨‹æ„å»ºç‰ˆæœ¬ï¼ˆåˆç§° "3.13t"ï¼‰çš„åˆæ­¥æ”¯æŒã€‚

ç”±äºè¯¥æ„å»ºå…è®¸å¤šä¸ª Python çº¿ç¨‹åŒæ—¶æ“ä½œåº•å±‚ Rust æ•°æ®ï¼Œ`#[pyclass]` å®ç°åœ¨è¦æ±‚å…¶ä½œç”¨çš„ç±»å‹å®ç° `Sync`ã€‚

é™¤äº† `#[pyclass]` çš„è¿™ä¸€å˜æ›´å¤–ï¼ŒPyO3 çš„å¤§å¤šæ•°åŠŸèƒ½ä»ä¿æŒä¸å˜ï¼Œå› ä¸ºå˜æ›´ä¸»è¦é›†ä¸­åœ¨ä½¿å†…éƒ¨æ•°æ®ç»“æ„çº¿ç¨‹å®‰å…¨ã€‚ä¾‹å¦‚ `GILOnceCell` ç±»å‹ï¼Œè¿‡å»ä¾èµ– GIL æ¥ä¿è¯å•æ¬¡åˆå§‹åŒ–çš„åŒæ­¥æ€§ï¼Œç°åœ¨æ”¹ç”¨å†…éƒ¨é”æ¥ç¡®ä¿ä»…ä¸€æ¬¡å†™å…¥æˆåŠŸï¼Œä½†å®ƒå…è®¸åˆå§‹åŒ–é—­åŒ…çš„å¤šæ¬¡ç«äº‰æ‰§è¡Œã€‚æ›´æ¨èçš„åšæ³•æ˜¯ä½¿ç”¨ `std::sync::OnceLock` æ­é… `pyo3::sync::OnceLockExt` traitï¼Œè¯¥ trait æä¾›äº† `OnceLock::get_or_init_py_attached`ï¼Œå¯ä¿è¯åˆå§‹åŒ–é—­åŒ…åªæ‰§è¡Œä¸€æ¬¡ä¸”ä¸ä¼šä¸ GIL æ­»é”ã€‚

æœªæ¥ç‰ˆæœ¬çš„ PyO3 å¾ˆå¯èƒ½ä¼šæ·»åŠ æ›´å¤š trait å’Œæ•°æ®ç»“æ„ï¼Œä»¥ç®€åŒ–è‡ªç”±çº¿ç¨‹ Python çš„ä½¿ç”¨ã€‚

ä»¥ä¸‹åŠŸèƒ½åœ¨è‡ªç”±çº¿ç¨‹æ„å»ºä¸­ä¸å¯ç”¨ï¼š

- `GILProtected` ç±»å‹ï¼Œå®ƒä¾èµ– GIL æ¥å®ç°å†…éƒ¨å†…å®¹çš„åŒæ­¥è®¿é—®
- `PyList::get_item_unchecked`ï¼Œç”±äºæ£€æŸ¥æ—¶ä¸ä½¿ç”¨æ—¶ä¹‹é—´å­˜åœ¨ç«äº‰ï¼Œæ— æ³•å®‰å…¨ä½¿ç”¨

å¦‚æœæ‚¨çš„ä»£ç ä½¿ç”¨äº†è¿™äº›åŠŸèƒ½ï¼Œåˆ™éœ€è¦å¤„ç†å®ƒä»¬åœ¨è‡ªç”±çº¿ç¨‹æ„å»ºä¸‹çš„ä¸å¯ç”¨æ€§ã€‚ä¸€ç§æ–¹æ³•æ˜¯é€šè¿‡æ¡ä»¶ç¼–è¯‘â€”â€”æ‰©å±•å¯ä»¥ä½¿ç”¨ `pyo3-build-config` æ¥è·å– `#[cfg(Py_GIL_DISABLED)]` å®ˆæŠ¤æ¡ä»¶ã€‚

è¯¦æƒ…è¯·å‚è§[å…³äºè‡ªç”±çº¿ç¨‹ Python çš„æŒ‡å—ç« èŠ‚](free-threading.md)ï¼Œäº†è§£å¦‚ä½•åœ¨æ‚¨çš„ PyO3 æ‰©å±•ä¸­æ”¯æŒè‡ªç”±çº¿ç¨‹ Pythonã€‚
&lt;/details&gt;

## æ–°çš„ `IntoPyObject` trait ç»Ÿä¸€äº†åˆ° Python çš„è½¬æ¢

&lt;details&gt;
&lt;summary&gt;&lt;small&gt;ç‚¹å‡»å±•å¼€&lt;/small&gt;&lt;/summary&gt;

PyO3 0.23 å¼•å…¥äº†ä¸€ä¸ªæ–°çš„ `IntoPyObject` traitï¼Œç”¨äºå°† Rust ç±»å‹è½¬æ¢ä¸º Python å¯¹è±¡ï¼Œå–ä»£äº†åŸæœ‰çš„ `IntoPy` å’Œ `ToPyObject` traitã€‚è¯¥æ–° trait çš„ä¸»è¦ç‰¹æ€§åŒ…æ‹¬ï¼š

- è½¬æ¢ç°åœ¨å¯ä»¥è¿”å›é”™è¯¯
- å®ƒè¢«è®¾è®¡ä¸ºå¯¹ `T`ï¼ˆå€¼ç±»å‹ï¼‰å’Œ `&amp;T`ï¼ˆå¼•ç”¨ç±»å‹ï¼‰éƒ½èƒ½é«˜æ•ˆå·¥ä½œ
- ç›¸æ¯” `IntoPy&lt;T&gt;`ï¼Œæ³›å‹ `T` è¢«ç§»è‡³å…³è”ç±»å‹ï¼Œå› æ­¤ï¼š
  - ç°åœ¨è½¬æ¢æŸä¸ªç±»å‹åªæœ‰ä¸€ç§æ–¹å¼
  - è¾“å‡ºç±»å‹æ›´ç²¾ç¡®ï¼Œå¯è¿”å›ä»»æ„ Python ç±»å‹è€Œä¸ä»…é™äº `PyAny`
- å­—èŠ‚é›†åˆç°åœ¨ä¸“é—¨è½¬æ¢ä¸º `PyBytes`ï¼Œè¯¦è§[ä¸‹æ–‡](#to-python-conversions-changed-for-byte-collections-vecu8-u8-n-and-smallvecu8-n)
- `()`ï¼ˆå•å…ƒç±»å‹ï¼‰ç°åœ¨ä»…åœ¨ `#[pyfunction]` å’Œ `#[pymethods]` çš„è¿”å›ä½ç½®è¢«ç‰¹åŒ–ä¸ºè¿”å› `None`ï¼›åœ¨æ™®é€šä½¿ç”¨ä¸­ï¼Œå®ƒä¼šè½¬æ¢ä¸ºä¸€ä¸ªç©ºçš„ `PyTuple`

æ‰€æœ‰ PyO3 å†…ç½®ç±»å‹ä»¥åŠ `#[pyclass]` ç±»å‹éƒ½å·²å®ç°äº† `IntoPyObject`ã€‚å…¶ä»–ç±»å‹éœ€è¦é€‚é… `IntoPyObject` çš„å®ç°ï¼Œä»¥ä¿æŒä¸ Python API çš„å…¼å®¹æ€§ã€‚åœ¨è®¸å¤šæƒ…å†µä¸‹ï¼Œå¯ä»¥ä½¿ç”¨æ–°çš„ [`#[derive(IntoPyObject)]`](#intopyobject-and-intopyobjectref-derive-macros) å®ä»£æ›¿[æ‰‹åŠ¨å®ç°](#intopyobject-manual-implementation)ã€‚

ç”±äº `IntoPyObject::into_pyobject` å¯èƒ½è¿”å› `Bound` æˆ– `Borrowed`ï¼Œæ‚¨å¯èƒ½ä¼šå‘ç° [`BoundObject`](conversions/traits.md#boundobject-for-conversions-that-may-be-bound-or-borrowed) trait æœ‰åŠ©äºç¼–å†™èƒ½é€šç”¨å¤„ç†è¿™ä¸¤ç§æ™ºèƒ½æŒ‡é’ˆçš„ä»£ç ã€‚

éšç€ `IntoPyObject` çš„å¼•å…¥ï¼Œæ—§çš„è½¬æ¢ trait `ToPyObject` å’Œ `IntoPy` å·²è¢«å¼ƒç”¨ï¼Œå°†åœ¨æœªæ¥çš„ PyO3 ç‰ˆæœ¬ä¸­ç§»é™¤ã€‚

### `IntoPyObject` å’Œ `IntoPyObjectRef` æ´¾ç”Ÿå®

è¦å®ç°è¯¥æ–° traitï¼Œå¯ä½¿ç”¨å¦‚ä¸‹æ–°çš„ `IntoPyObject` å’Œ `IntoPyObjectRef` æ´¾ç”Ÿå®ï¼š

```rust,no_run
<span class="boring">use pyo3::prelude::*;
</span>#[derive(IntoPyObject, IntoPyObjectRef)]
struct Struct {
    count: usize,
    obj: Py&lt;PyAny&gt;,
}</code></pre>
<p><code>IntoPyObjectRef</code> æ´¾ç”Ÿå®ä¸ºå¼•ç”¨ç±»å‹ï¼ˆå¦‚ä¸Šä¾‹ä¸­çš„ <code>&amp;Struct</code>ï¼‰ç”Ÿæˆå®ç°ï¼Œä»¥æ›¿ä»£ <code>ToPyObject</code> traitã€‚</p>
<h4 id="intopyobject-æ‰‹åŠ¨å®ç°"><a class="header" href="#intopyobject-æ‰‹åŠ¨å®ç°"><code>IntoPyObject</code> æ‰‹åŠ¨å®ç°</a></h4>
<p>æ­¤å‰ï¼š</p>
<pre><code class="language-rust ignore"><span class="boring">use pyo3::prelude::*;
</span><span class="boring">#[allow(dead_code)]
</span>struct MyPyObjectWrapper(PyObject);

impl IntoPy&lt;PyObject&gt; for MyPyObjectWrapper {
    fn into_py(self, py: Python&lt;'_&gt;) -&gt; PyObject {
        self.0
    }
}

impl ToPyObject for MyPyObjectWrapper {
    fn to_object(&amp;self, py: Python&lt;'_&gt;) -&gt; PyObject {
        self.0.clone_ref(py)
    }
}</code></pre>
<p>ä¹‹åï¼š</p>
<pre><code class="language-rust no_run"><span class="boring">#![allow(deprecated)]
</span><span class="boring">use pyo3::prelude::*;
</span><span class="boring">#[allow(dead_code)]
</span><span class="boring">struct MyPyObjectWrapper(PyObject);
</span>
impl&lt;'py&gt; IntoPyObject&lt;'py&gt; for MyPyObjectWrapper {
    type Target = PyAny; // Python ç±»å‹
    type Output = Bound&lt;'py, Self::Target&gt;; // å¤šæ•°æƒ…å†µä¸‹ä¸º `Bound`
    type Error = std::convert::Infallible;

    fn into_pyobject(self, py: Python&lt;'py&gt;) -&gt; Result&lt;Self::Output, Self::Error&gt; {
        Ok(self.0.into_bound(py))
    }
}

// `ToPyObject` çš„å®ç°åº”è½¬æ¢ä¸ºå¼•ç”¨ç±»å‹çš„å®ç°
impl&lt;'a, 'py&gt; IntoPyObject&lt;'py&gt; for &amp;'a MyPyObjectWrapper {
    type Target = PyAny;
    type Output = Borrowed&lt;'a, 'py, Self::Target&gt;; // `Borrowed` å¯ç”¨äºä¼˜åŒ–å¼•ç”¨è®¡æ•°
    type Error = std::convert::Infallible;

    fn into_pyobject(self, py: Python&lt;'py&gt;) -&gt; Result&lt;Self::Output, Self::Error&gt; {
        Ok(self.0.bind_borrowed(py))
    }
}</code></pre>
</details>
<h3 id="å­—èŠ‚é›†åˆçš„åˆ°-python-è½¬æ¢å˜æ›´vecu8u8-n-å’Œ-smallvecu8-n"><a class="header" href="#å­—èŠ‚é›†åˆçš„åˆ°-python-è½¬æ¢å˜æ›´vecu8u8-n-å’Œ-smallvecu8-n">å­—èŠ‚é›†åˆçš„åˆ° Python è½¬æ¢å˜æ›´ï¼ˆ<code>Vec&lt;u8&gt;</code>ã€<code>[u8; N]</code> å’Œ <code>SmallVec&lt;[u8; N]&gt;</code>ï¼‰</a></h3>
<details>
<summary><small>ç‚¹å‡»å±•å¼€</small></summary>
<p>éšç€ <code>IntoPyObject</code> trait çš„å¼•å…¥ï¼ŒPyO3 çš„å®åœ¨ç”Ÿæˆ Python å€¼æ—¶ç°åœ¨ä¼˜å…ˆä½¿ç”¨ <code>IntoPyObject</code> å®ç°ï¼Œè€Œé <code>IntoPy&lt;PyObject&gt;</code>ã€‚è¿™é€‚ç”¨äº <code>#[pyfunction]</code> å’Œ <code>#[pymethods]</code> çš„è¿”å›å€¼ï¼Œä»¥åŠé€šè¿‡ <code>#[pyo3(get)]</code> è®¿é—®çš„å­—æ®µã€‚</p>
<p>è¿™ä¸€å˜æ›´å½±å“è¿”å›ä»¥ä¸‹_å­—èŠ‚_é›†åˆçš„å‡½æ•°å’Œæ–¹æ³•ï¼š</p>
<ul>
<li><code>Vec&lt;u8&gt;</code></li>
<li><code>[u8; N]</code></li>
<li><code>SmallVec&lt;[u8; N]&gt;</code></li>
</ul>
<p>åœ¨æ–°çš„ <code>IntoPyObject</code> å®ç°ä¸­ï¼Œå®ƒä»¬ç°åœ¨å°†è½¬æ¢ä¸º <code>PyBytes</code> è€Œé <code>PyList</code>ã€‚æ‰€æœ‰å…¶ä»– <code>T</code> ç±»å‹ä¸å—å½±å“ï¼Œä»è½¬æ¢ä¸º <code>PyList</code>ã€‚</p>
<pre><code class="language-rust no_run"><span class="boring">#![allow(dead_code)]
</span><span class="boring">use pyo3::prelude::*;
</span>#[pyfunction]
fn foo() -&gt; Vec&lt;u8&gt; { // æ­¤å‰è½¬æ¢ä¸º `PyList`ï¼Œç°åœ¨è½¬æ¢ä¸º `PyBytes`
    vec![0, 1, 2, 3]
}

#[pyfunction]
fn bar() -&gt; Vec&lt;u16&gt; { // ä¸å—å½±å“ï¼Œè¿”å› `PyList`
    vec![0, 1, 2, 3]
}</code></pre>
<p>å¦‚æœä¸éœ€è¦æ­¤è½¬æ¢è¡Œä¸ºï¼Œå¯è€ƒè™‘ä½¿ç”¨ <code>PyList::new</code> æ‰‹åŠ¨æ„é€ åˆ—è¡¨ã€‚</p>
<p>ä»¥ä¸‹ç±»å‹æ­¤å‰ä»…å¯¹ <code>u8</code> å®ç°ï¼Œç°åœ¨å…è®¸å…¶ä»– <code>T</code> è½¬æ¢ä¸º <code>PyList</code>ï¼š</p>
<ul>
<li><code>&amp;[T]</code></li>
<li><code>Cow&lt;[T]&gt;</code></li>
</ul>
</details>è¿™çº¯ç²¹æ˜¯é¢å¤–çš„ï¼Œä»…ç”¨äºæ‰©å±•å¯èƒ½çš„è¿”å›ç±»å‹ã€‚

<h3 id="ç§»é™¤-gil-refs-åŠŸèƒ½"><a class="header" href="#ç§»é™¤-gil-refs-åŠŸèƒ½">ç§»é™¤ <code>gil-refs</code> åŠŸèƒ½</a></h3>
<details>
<summary><small>ç‚¹å‡»å±•å¼€</small></summary>
<p>PyO3 0.23 å®Œæˆäº†å¯¹â€œGIL Refsâ€API çš„ç§»é™¤ï¼Œè½¬è€Œä½¿ç”¨åœ¨ PyO3 0.21 ä¸­å¼•å…¥çš„æ–°çš„â€œBoundâ€APIã€‚</p>
<p>éšç€æ—§ API çš„ç§»é™¤ï¼Œè®¸å¤šä¹‹å‰å¸¦æœ‰ <code>_bound</code> åç¼€å¼•å…¥çš„â€œBoundâ€API æ–¹æ³•ä¸å†éœ€è¦è¿™äº›åç¼€ï¼Œå› ä¸ºè¿™äº›åç§°å·²è¢«é‡Šæ”¾ã€‚ä¾‹å¦‚ï¼Œ<code>PyTuple::new_bound</code> ç°åœ¨ä»…ä¸º <code>PyTuple::new</code>ï¼ˆç°æœ‰åç§°ä»ç„¶ä¿ç•™ä½†å·²å¼ƒç”¨ï¼‰ã€‚</p>
<p>ä¹‹å‰ï¼š</p>
<pre><code class="language-rust ignore"><span class="boring">#![allow(deprecated)]
</span><span class="boring">use pyo3::prelude::*;
</span><span class="boring">use pyo3::types::PyTuple;
</span><span class="boring">fn main() {
</span><span class="boring">Python::attach(|py| {
</span>// ä¾‹å¦‚ï¼ŒPyTupleã€‚è®¸å¤šæ­¤ç±» API å·²æ›´æ”¹ã€‚
let tup = PyTuple::new_bound(py, [1, 2, 3]);
<span class="boring">})
</span><span class="boring">}</span></code></pre>
<p>ä¹‹åï¼š</p>
<pre><code class="language-rust"><span class="boring">use pyo3::prelude::*;
</span><span class="boring">use pyo3::types::PyTuple;
</span><span class="boring">fn main() {
</span><span class="boring">Python::attach(|py| {
</span>// ä¾‹å¦‚ï¼ŒPyTupleã€‚è®¸å¤šæ­¤ç±» API å·²æ›´æ”¹ã€‚
let tup = PyTuple::new(py, [1, 2, 3]);
<span class="boring">})
</span><span class="boring">}</span></code></pre>
<h4 id="intopydict-trait-è°ƒæ•´ä»¥ç§»é™¤-gil-refs"><a class="header" href="#intopydict-trait-è°ƒæ•´ä»¥ç§»é™¤-gil-refs"><code>IntoPyDict</code> trait è°ƒæ•´ä»¥ç§»é™¤ <code>gil-refs</code></a></h4>
<p>ä½œä¸ºæ­¤ API ç®€åŒ–çš„ä¸€éƒ¨åˆ†ï¼Œ<code>IntoPyDict</code> trait ç»å†äº†ä¸€ä¸ªå°çš„ç ´åæ€§å˜æ›´ï¼š<code>IntoPyDict::into_py_dict_bound</code> æ–¹æ³•å·²é‡å‘½åä¸º <code>IntoPyDict::into_py_dict</code>ã€‚åŒæ—¶ï¼Œå®ƒç°åœ¨ä¹Ÿæ˜¯å¯å¤±è´¥çš„ï¼Œè¿™æ˜¯ <code>IntoPyObject</code> trait æ·»åŠ å¸¦æ¥çš„å˜åŒ–ã€‚</p>
<p>å¦‚æœä½ æ›¾ä¸ºä½ è‡ªå·±çš„ç±»å‹å®ç° <code>IntoPyDict</code>ï¼Œä½ åº”è¯¥å®ç° <code>into_py_dict</code> è€Œä¸æ˜¯ <code>into_py_dict_bound</code>ã€‚æ—§åç§°ä»ç„¶å¯ä»¥è°ƒç”¨ä½†å·²å¼ƒç”¨ã€‚</p>
<p>ä¹‹å‰ï¼š</p>
<pre><code class="language-rust ignore"><span class="boring">use pyo3::prelude::*;
</span><span class="boring">use pyo3::types::{PyDict, IntoPyDict};
</span><span class="boring">use std::collections::HashMap;
</span>

struct MyMap&lt;K, V&gt;(HashMap&lt;K, V&gt;);


impl&lt;K, V&gt; IntoPyDict for MyMap&lt;K, V&gt;
where
    K: ToPyObject,
    V: ToPyObject,
{
    fn into_py_dict_bound(self, py: Python&lt;'_&gt;) -&gt; Bound&lt;'_, PyDict&gt; {
        let dict = PyDict::new_bound(py);
        for (key, value) in self.0 {
            dict.set_item(key, value)
                .expect("Failed to set_item on dict");
        }
        dict
    }
}</code></pre>
<p>ä¹‹åï¼š</p>
<pre><code class="language-rust no_run"><span class="boring">use pyo3::prelude::*;
</span><span class="boring">use pyo3::types::{PyDict, IntoPyDict};
</span><span class="boring">use std::collections::HashMap;
</span>

<span class="boring">#[allow(dead_code)]
</span>struct MyMap&lt;K, V&gt;(HashMap&lt;K, V&gt;);


impl&lt;'py, K, V&gt; IntoPyDict&lt;'py&gt; for MyMap&lt;K, V&gt;
where
    K: IntoPyObject&lt;'py&gt;,
    V: IntoPyObject&lt;'py&gt;,
{
    fn into_py_dict(self, py: Python&lt;'py&gt;) -&gt; PyResult&lt;Bound&lt;'py, PyDict&gt;&gt; {
        let dict = PyDict::new(py);
        for (key, value) in self.0 {
            dict.set_item(key, value)?;
        }
        Ok(dict)
    }
}</code></pre>
</details>
<h2 id="ä»-021-å‡çº§åˆ°-022"><a class="header" href="#ä»-021-å‡çº§åˆ°-022">ä» 0.21.* å‡çº§åˆ° 0.22</a></h2>
<h3 id="ç»§ç»­å¼ƒç”¨-gil-refs-åŠŸèƒ½"><a class="header" href="#ç»§ç»­å¼ƒç”¨-gil-refs-åŠŸèƒ½">ç»§ç»­å¼ƒç”¨ <code>gil-refs</code> åŠŸèƒ½</a></h3>
<details>
<summary><small>ç‚¹å‡»å±•å¼€</small></summary>
<p>ç»§ PyO3 0.21 å¼•å…¥â€œBoundâ€API å¹¶è®¡åˆ’ç§»é™¤â€œGIL Refsâ€API ä¹‹åï¼Œæ‰€æœ‰ä¸ GIL Refs ç›¸å…³çš„åŠŸèƒ½ç°åœ¨éƒ½è¢«é™åˆ¶åœ¨ <code>gil-refs</code> åŠŸèƒ½ä¸‹ï¼Œå¹¶åœ¨ä½¿ç”¨æ—¶å‘å‡ºå¼ƒç”¨è­¦å‘Šã€‚</p>
<p>è¯·å‚é˜… <a href="#from-021-to-022">0.21 è¿ç§»æ¡ç›®</a> è·å–å‡çº§å¸®åŠ©ã€‚</p>
</details>
<h3 id="å¼ƒç”¨å°¾éƒ¨å¯é€‰å‚æ•°çš„éšå¼é»˜è®¤å€¼"><a class="header" href="#å¼ƒç”¨å°¾éƒ¨å¯é€‰å‚æ•°çš„éšå¼é»˜è®¤å€¼">å¼ƒç”¨å°¾éƒ¨å¯é€‰å‚æ•°çš„éšå¼é»˜è®¤å€¼</a></h3>
<details>
<summary><small>ç‚¹å‡»å±•å¼€</small></summary>
<p>ä» <code>pyo3</code> 0.22 å¼€å§‹ï¼Œå°¾éƒ¨ <code>Option&lt;T&gt;</code> ç±»å‹å‚æ•°çš„éšå¼ <code>None</code> é»˜è®¤å€¼å·²è¢«å¼ƒç”¨ã€‚è¿ç§»æ—¶ï¼Œè¯·åœ¨å—å½±å“çš„å‡½æ•°æˆ–æ–¹æ³•ä¸Šæ·»åŠ  <code>#[pyo3(signature = (...))]</code> å±æ€§ï¼Œå¹¶æ˜ç¡®æŒ‡å®šæ‰€éœ€è¡Œä¸ºã€‚è¿ç§»è­¦å‘Šä¼šæŒ‡å‡ºä¿æŒå½“å‰è¡Œä¸ºæ‰€éœ€çš„ç­¾åã€‚åˆ° 0.23 ç‰ˆæœ¬ï¼Œä»»ä½•åŒ…å« <code>Option&lt;T&gt;</code> ç±»å‹å‚æ•°çš„å‡½æ•°éƒ½å°†è¦æ±‚æ˜ç¡®æŒ‡å®šç­¾åï¼Œä»¥é˜²æ­¢è¡Œä¸ºå‘ç”Ÿæ„å¤–ä¸”æœªå¯Ÿè§‰çš„å˜åŒ–ã€‚åˆ° 0.24 ç‰ˆæœ¬ï¼Œæ­¤é™åˆ¶å°†å†æ¬¡æ”¾å®½ï¼Œ<code>Option&lt;T&gt;</code> ç±»å‹å‚æ•°å°†è¢«è§†ä¸ºæ™®é€šå‚æ•°ï¼Œä¸å†æœ‰ç‰¹æ®Šå¤„ç†ã€‚</p>
<p>ä¹‹å‰ï¼š</p>
<pre><code class="language-rust no_run"><span class="boring">#![allow(deprecated, dead_code)]
</span><span class="boring">use pyo3::prelude::*;
</span>#[pyfunction]
fn increment(x: u64, amount: Option&lt;u64&gt;) -&gt; u64 {
    x + amount.unwrap_or(1)
}</code></pre>
<p>ä¹‹åï¼š</p>
<pre><code class="language-rust no_run"><span class="boring">#![allow(dead_code)]
</span><span class="boring">use pyo3::prelude::*;
</span>#[pyfunction]
#[pyo3(signature = (x, amount=None))]
fn increment(x: u64, amount: Option&lt;u64&gt;) -&gt; u64 {
    x + amount.unwrap_or(1)
}</code></pre>
</details>
<h3 id="pyclone-ç°åœ¨å—é™äº-py-clone-åŠŸèƒ½"><a class="header" href="#pyclone-ç°åœ¨å—é™äº-py-clone-åŠŸèƒ½"><code>Py::clone</code> ç°åœ¨å—é™äº <code>py-clone</code> åŠŸèƒ½</a></h3>
<details>
<summary><small>ç‚¹å‡»å±•å¼€</small></summary>
å¦‚æœä½ ä¾èµ– `impl<t> Clone for Py<t>` æ¥æ»¡è¶³ç°æœ‰ Rust ä»£ç ï¼ˆéåŸºäº PyO3 ç¼–å†™çš„ä»£ç ï¼‰æ–½åŠ çš„ trait è¦æ±‚ï¼Œåˆ™å¿…é¡»å¯ç”¨æ–°å¼•å…¥çš„åŠŸèƒ½ `py-clone`ã€‚
<p>ç„¶è€Œï¼Œè¯·æ³¨æ„å…¶è¡Œä¸ºä¸ä¹‹å‰ç‰ˆæœ¬ä¸åŒã€‚å¦‚æœåœ¨æœªæŒæœ‰ GIL çš„æƒ…å†µä¸‹è°ƒç”¨ <code>Clone</code>ï¼Œæˆ‘ä»¬æ›¾å°è¯•å»¶è¿Ÿè¿™äº›å¼•ç”¨è®¡æ•°å¢é‡çš„åº”ç”¨ï¼Œç›´åˆ°åŸºäº PyO3 çš„ä»£ç é‡æ–°è·å– GIL ä¸ºæ­¢ã€‚è¿™è¢«è¯æ˜æ— æ³•ä»¥å®‰å…¨çš„æ–¹å¼å®ç°ï¼Œå› æ­¤å·²ç§»é™¤ã€‚ç°åœ¨ï¼Œå¦‚æœåœ¨æœªæŒæœ‰ GIL çš„æƒ…å†µä¸‹è°ƒç”¨ <code>Clone</code>ï¼Œæˆ‘ä»¬ä¼šç›´æ¥è§¦å‘ panicï¼Œè€Œè°ƒç”¨ä»£ç å¯èƒ½å¹¶æœªä¸ºæ­¤åšå¥½å‡†å¤‡ã€‚</p>
<p>å»ºè®®é€æ­¥å¼ƒç”¨ <code>py-clone</code> åŠŸèƒ½ã€‚æœ€ç®€å•çš„æ–¹å¼æ˜¯å°† <code>Py&lt;T&gt;</code> åŒ…è£…ä¸º <code>Arc&lt;Py&lt;T&gt;&gt;</code>ï¼Œå¹¶é€šè¿‡å…‹éš† Arc æ¥å®ç°ã€‚</p>
<p>ä¸æ­¤ç›¸å…³ï¼Œæˆ‘ä»¬ä¹Ÿæ·»åŠ äº†ä¸€ä¸ª <code>pyo3_disable_reference_pool</code> æ¡ä»¶ç¼–è¯‘æ ‡å¿—ï¼Œç”¨äºç§»é™¤ <code>impl&lt;T&gt; Drop for Py&lt;T&gt;</code> æ‰€éœ€çš„å»¶è¿Ÿå¼•ç”¨è®¡æ•°é€’å‡åŸºç¡€è®¾æ–½ã€‚å®ƒä»¬ä¼¼ä¹ä¸æ„æˆå®‰å…¨æ€§éšæ‚£ï¼Œæœ€åæƒ…å†µä¹Ÿåªæ˜¯å†…å­˜æ³„æ¼ã€‚ä½†æ˜¯ï¼Œå…¨å±€åŒæ­¥ä¼šåœ¨è·¨ Python-Rust è¾¹ç•Œæ—¶å¸¦æ¥æ˜¾è‘—å¼€é”€ã€‚å¯ç”¨æ­¤åŠŸèƒ½å°†æ¶ˆé™¤è¿™äº›æˆæœ¬ï¼Œå¹¶åœ¨æœªæŒæœ‰ GIL æ—¶è°ƒç”¨ <code>Drop</code> å®ç°æ—¶ç›´æ¥ç»ˆæ­¢è¿›ç¨‹ã€‚</p>

<h3 id="ä¸ºç®€å•æšä¸¾çš„æ¯”è¾ƒè¦æ±‚æ˜¾å¼é€‰æ‹©å¯ç”¨"><a class="header" href="#ä¸ºç®€å•æšä¸¾çš„æ¯”è¾ƒè¦æ±‚æ˜¾å¼é€‰æ‹©å¯ç”¨">ä¸ºç®€å•æšä¸¾çš„æ¯”è¾ƒè¦æ±‚æ˜¾å¼é€‰æ‹©å¯ç”¨</a></h3>
<details>
<summary><small>ç‚¹å‡»å±•å¼€</small></summary>
<p>ä» <code>pyo3</code> 0.22 å¼€å§‹ï¼Œæ–°çš„ <code>#[pyo3(eq)]</code> é€‰é¡¹å…è®¸ä½¿ç”¨ Rust çš„ <code>PartialEq</code> è‡ªåŠ¨å®ç° Python ç­‰å€¼æ¯”è¾ƒã€‚åœ¨æ­¤ä¹‹å‰ï¼Œç®€å•æšä¸¾ä¼šè‡ªåŠ¨æ ¹æ®å…¶åˆ¤åˆ«ç¬¦ï¼ˆdiscriminantï¼‰å®ç°ç­‰å€¼æ¯”è¾ƒã€‚ä¸ºäº†ä½¿ PyO3 æ›´ä¸€è‡´ï¼Œç°åœ¨å¼ƒç”¨è¿™ç§è‡ªåŠ¨ç­‰å€¼å®ç°ï¼Œæ”¹ä¸ºè¦æ±‚æ‰€æœ‰ <code>#[pyclass]</code> ç±»å‹æ˜¾å¼é€‰æ‹©å¯ç”¨ã€‚ç±»ä¼¼åœ°ï¼Œç®€å•æšä¸¾æ›¾æ”¯æŒä¸æ•´æ•°æ¯”è¾ƒï¼Œä½†è¯¥åŠŸèƒ½ä¸å— Rust <code>PartialEq</code> æ´¾ç”Ÿæ”¯æŒï¼Œå› æ­¤å·²å•ç‹¬æ‹†åˆ†ä¸º <code>#[pyo3(eq_int)]</code> å±æ€§ã€‚</p>
<p>è¿ç§»æ—¶ï¼Œè¯·åœ¨ç®€å•æšä¸¾ç±»ä¸Šæ·»åŠ  <code>#[pyo3(eq, eq_int)]</code> å±æ€§ã€‚</p>
<p>ä¹‹å‰ï¼š</p>
<pre><code class="language-rust no_run"><span class="boring">#![allow(deprecated, dead_code)]
</span><span class="boring">use pyo3::prelude::*;
</span>#[pyclass]
enum SimpleEnum {
    VariantA,
    VariantB = 42,
}</code></pre>
<p>ä¹‹åï¼š</p>
<pre><code class="language-rust no_run"><span class="boring">#![allow(dead_code)]
</span><span class="boring">use pyo3::prelude::*;
</span>#[pyclass(eq, eq_int)]
#[derive(PartialEq)]
enum SimpleEnum {
    VariantA,
    VariantB = 42,
}</code></pre>
</details>
<h3 id="pytypename-é‡æ„ä»¥æ›´å¥½åœ°åŒ¹é…-python-çš„-__name__"><a class="header" href="#pytypename-é‡æ„ä»¥æ›´å¥½åœ°åŒ¹é…-python-çš„-__name__"><code>PyType::name</code> é‡æ„ä»¥æ›´å¥½åœ°åŒ¹é… Python çš„ <code>__name__</code></a></h3>
<details>
<summary><small>ç‚¹å‡»å±•å¼€</small></summary>
<p>è¯¥å‡½æ•°ä¹‹å‰ä¼šå°è¯•ç›´æ¥ä» Python ç±»å‹å¯¹è±¡çš„ C API å­—æ®µï¼ˆ<code>tp_name</code>ï¼‰è¯»å–å†…å®¹ï¼Œæ­¤æ—¶ä¼šè¿”å› <code>Cow::Borrowed</code>ã€‚ä½† <code>tp_name</code> çš„å†…å®¹è¯­ä¹‰ä¸æ˜ç¡®ã€‚</p>
<p>ç°åœ¨ <code>PyType::name()</code> è¿”å›ç›¸å½“äº Python ä¸­ <code>__name__</code> çš„å€¼ï¼Œå¹¶è¿”å› <code>PyResult&lt;Bound&lt;'py, PyString&gt;&gt;</code>ã€‚</p>
<p>æœ€æ¥è¿‘ PyO3 0.21 ç‰ˆæœ¬ <code>PyType::name()</code> çš„æ–°å‡½æ•°æ˜¯ <code>PyType::fully_qualified_name()</code>ï¼Œå…¶ç­‰ä»·äºå°† <code>__module__</code> å’Œ <code>__qualname__</code> è¿æ¥ä¸º <code>module.qualname</code>ã€‚</p>
<p>ä¹‹å‰ï¼š</p>
<pre><code class="language-rust ignore"><span class="boring">#![allow(deprecated, dead_code)]
</span><span class="boring">use pyo3::prelude::*;
</span><span class="boring">use pyo3::types::{PyBool};
</span><span class="boring">fn main() -&gt; PyResult&lt;()&gt; {
</span>Python::with_gil(|py| {
    let bool_type = py.get_type_bound::&lt;PyBool&gt;();
    let name = bool_type.name()?.into_owned();
    println!("Hello, {}", name);


    let mut name_upper = bool_type.name()?;
    name_upper.to_mut().make_ascii_uppercase();
    println!("Hello, {}", name_upper);


    Ok(())
})
<span class="boring">}</span></code></pre>
<p>ä¹‹åï¼š</p>
<pre><code class="language-rust ignore"><span class="boring">#![allow(dead_code)]
</span><span class="boring">use pyo3::prelude::*;
</span><span class="boring">use pyo3::types::{PyBool};
</span><span class="boring">fn main() -&gt; PyResult&lt;()&gt; {
</span>Python::with_gil(|py| {
    let bool_type = py.get_type_bound::&lt;PyBool&gt;();
    let name = bool_type.name()?;
    println!("Hello, {}", name);


    // ï¼ˆå¦‚æœéœ€è¦å®Œæ•´çš„ç‚¹åˆ†è·¯å¾„ï¼Œè¯·å°† `name()` æ›¿æ¢ä¸º `fully_qualified_name()`ï¼‰
    let mut name_upper = bool_type.fully_qualified_name()?.to_string();
    name_upper.make_ascii_uppercase();
    println!("Hello, {}", name_upper);


    Ok(())
})
<span class="boring">}</span></code></pre>
</details>
<h2 id="ä»-020-å‡çº§åˆ°-021"><a class="header" href="#ä»-020-å‡çº§åˆ°-021">ä» 0.20.* å‡çº§åˆ° 0.21</a></h2>
<details>
<summary><small>ç‚¹å‡»å±•å¼€</small></summary>
<p>PyO3 0.21 å¼•å…¥äº†ä¸€ä¸ªæ–°çš„ <code>Bound&lt;'py, T&gt;</code> æ™ºèƒ½æŒ‡é’ˆï¼Œç”¨äºæ›¿ä»£ç°æœ‰çš„â€œGIL Refsâ€API æ¥ä¸ Python å¯¹è±¡äº¤äº’ã€‚ä¾‹å¦‚ï¼Œåœ¨ PyO3 0.20 ä¸­ä½¿ç”¨ <code>&amp;'py PyAny</code> ä¸ Python å¯¹è±¡äº¤äº’ï¼Œè€Œåœ¨ PyO3 0.21 ä¸­æ›´æ–°ä¸º <code>Bound&lt;'py, PyAny&gt;</code>ã€‚æ­¤å˜æ›´å°† Rust çš„æ‰€æœ‰æƒè¯­ä¹‰ä» PyO3 å†…éƒ¨ç§»åˆ°ç”¨æˆ·ä»£ç ä¸­ã€‚è¿™ä¸€æ”¹å˜ä¿®å¤äº†<a href="https://github.com/PyO3/pyo3/issues/3668">ä¸ gevent äº¤äº’ä¸­å·²çŸ¥çš„å®‰å…¨æ€§è¾¹ç•Œæƒ…å†µ</a>ï¼Œå¹¶æå‡äº† CPU å’Œ <a href="https://github.com/PyO3/pyo3/issues/1056">å†…å­˜æ€§èƒ½</a>ã€‚å®Œæ•´è®¨è®ºå†å²è§ <a href="https://github.com/PyO3/pyo3/issues/3382">https://github.com/PyO3/pyo3/issues/3382</a>ã€‚</p>
<p>â€œGIL Refâ€ <code>&amp;'py PyAny</code> ä»¥åŠç±»ä¼¼ <code>&amp;'py PyDict</code> çš„ç±»å‹ä»ä½œä¸ºå·²å¼ƒç”¨ API å¯ç”¨ã€‚ç”±äºæ–° API çš„ä¼˜åŠ¿ï¼Œå»ºè®®æ‰€æœ‰ç”¨æˆ·å°½å¿«å‡çº§ã€‚</p>
<p>é™¤äº†ä¸»è¦ API ç±»å‹é‡æ„å¤–ï¼ŒPyO3 è¿˜å¯¹å…¶ä»–ä¸€äº› API è¿›è¡Œäº†å°‘é‡ç ´åæ€§è°ƒæ•´ï¼Œä»¥å¼¥è¡¥æ­£ç¡®æ€§å’Œå®‰å…¨æ€§ä¸Šçš„æ¼æ´ã€‚</p>
<p>æ¨èçš„å‡çº§åˆ° PyO3 0.21 çš„æ­¥éª¤å¦‚ä¸‹ï¼š</p>
<ol>
<li>å¯ç”¨ <code>gil-refs</code> åŠŸèƒ½ä»¥å±è”½ä¸ API å˜æ›´ç›¸å…³çš„å¼ƒç”¨è­¦å‘Š</li>
<li>ä¿®å¤æ‰€æœ‰å…¶ä»– PyO3 0.21 è¿ç§»æ­¥éª¤ä¸­æŒ‡å‡ºçš„é—®é¢˜</li>
<li>ç¦ç”¨ <code>gil-refs</code> åŠŸèƒ½å¹¶è¿ç§»åˆ°æ–° APIä»¥ä¸‹å„èŠ‚æŒ‰æ­¤é¡ºåºæ’åˆ—ã€‚</li>
</ol>
</details>
<h3 id="å¯ç”¨-gil-refs-åŠŸèƒ½"><a class="header" href="#å¯ç”¨-gil-refs-åŠŸèƒ½">å¯ç”¨ <code>gil-refs</code> åŠŸèƒ½</a></h3>
<details>
<summary><small>ç‚¹å‡»å±•å¼€</small></summary>
<p>ä¸ºäº†å°½å¯èƒ½å¹³æ»‘åœ°è¿‡æ¸¡ PyO3 ç”Ÿæ€ç³»ç»Ÿï¼Œä½¿å…¶è„±ç¦» GIL Refs APIï¼Œåœ¨ PyO3 0.21 ç‰ˆæœ¬ä¸­ï¼Œæ‰€æœ‰æ¶ˆè´¹æˆ–äº§ç”Ÿ GIL Refs çš„ API å‡æœªæ›´æ”¹ã€‚å–è€Œä»£ä¹‹çš„æ˜¯å¼•å…¥äº†ä½¿ç”¨ <code>Bound&lt;T&gt;</code> æ™ºèƒ½æŒ‡é’ˆçš„å˜ä½“ã€‚ä¾‹å¦‚ï¼Œ<code>PyTuple::new_bound</code> è¿”å› <code>Bound&lt;PyTuple&gt;</code>ï¼Œç”¨ä»¥æ›¿ä»£ <code>PyTuple::new</code>ã€‚GIL Refs ç›¸å…³ API å·²è¢«å¼ƒç”¨ï¼Œä½†ä¸ºäº†ä¾¿äºè¿ç§»ï¼Œå¯ä»¥é€šè¿‡å¯ç”¨ <code>gil-refs</code> åŠŸèƒ½æ¥ç¦ç”¨è¿™äº›å¼ƒç”¨è­¦å‘Šã€‚</p>
<blockquote>
<p>å”¯ä¸€ä¸€ä¸ªå°±åœ°ä¿®æ”¹ç°æœ‰ API çš„ä¾‹å¤–æ˜¯ <code>pyo3::intern!</code> å®ã€‚å‡ ä¹æ‰€æœ‰å¯¹è¿™ä¸ªå®çš„ä½¿ç”¨éƒ½ä¸éœ€è¦æ›´æ–°ä»£ç æ¥é€‚åº”å…¶æ”¹ä¸ºç«‹å³è¿”å› <code>&amp;Bound&lt;PyString&gt;</code> çš„å˜åŒ–ï¼Œè€Œæ·»åŠ ä¸€ä¸ª <code>intern_bound!</code> æ›¿ä»£å®è¢«è®¤ä¸ºä¼šç»™ç”¨æˆ·å¸¦æ¥é¢å¤–è´Ÿæ‹…ã€‚</p>
</blockquote>
<p>å»ºè®®ç”¨æˆ·åœ¨å‡çº§åˆ° PyO3 0.21 æ—¶é¦–å…ˆæ‰§è¡Œæ­¤æ­¥éª¤ï¼Œä»¥é¿å…å¼ƒç”¨è­¦å‘Šå¹²æ‰°å…¶ä»–è¿ç§»æ­¥éª¤çš„è§£å†³ã€‚</p>
<p>ä¹‹å‰ï¼š</p>
<pre><code class="language-toml"># Cargo.toml
[dependencies]
pyo3 = "0.20"
</code></pre>
<p>ä¹‹åï¼š</p>
<pre><code class="language-toml"># Cargo.toml
[dependencies]
pyo3 = { version = "0.21", features = ["gil-refs"] }
</code></pre>
</details>
<h3 id="pytypeinfo-å’Œ-pytryfrom-å·²è¢«è°ƒæ•´"><a class="header" href="#pytypeinfo-å’Œ-pytryfrom-å·²è¢«è°ƒæ•´"><code>PyTypeInfo</code> å’Œ <code>PyTryFrom</code> å·²è¢«è°ƒæ•´</a></h3>
<details>
<summary><small>ç‚¹å‡»å±•å¼€</small></summary>
<p><code>PyTryFrom</code> trait çš„è®¾è®¡å·²æ˜¾é™ˆæ—§ï¼Œå…¶ <code>try_from</code> æ–¹æ³•åœ¨ Rust 2021 ç‰ˆæœ¬çš„é¢„å¯¼å…¥ï¼ˆpreludeï¼‰ä¸­ä¸ <code>TryFrom::try_from</code> å†²çªã€‚æ­¤å¤–ï¼Œå®ƒçš„è®¸å¤šåŠŸèƒ½ä¹Ÿä¸ <code>PyTypeInfo</code> é‡å¤ã€‚</p>
<p>ä½œä¸º GIL Refs API å¼ƒç”¨å·¥ä½œçš„ä¸€éƒ¨åˆ†ï¼Œä¸ºä½¿ PyO3 çš„ trait ä½“ç³»æ›´ç´§å‡‘ï¼Œ<code>PyTypeInfo</code> trait æ–°å¢äº†ä¸€ä¸ªæ›´ç®€å•çš„è¾…åŠ© trait <code>PyTypeCheck</code>ã€‚<code>PyAny::downcast</code> å’Œ <code>PyAny::downcast_exact</code> æ–¹æ³•ä¸å†ä½¿ç”¨ <code>PyTryFrom</code> ä½œä¸ºçº¦æŸï¼Œè€Œæ˜¯åˆ†åˆ«ä½¿ç”¨ <code>PyTypeCheck</code> å’Œ <code>PyTypeInfo</code>ã€‚</p>
<p>è¿ç§»æ–¹æ³•ï¼šå°†æ‰€æœ‰ç±»å‹è½¬æ¢ä» <code>try_from(obj)</code> æ”¹ä¸ºä½¿ç”¨ <code>obj.downcast()</code>ï¼ˆ<code>downcast_exact</code> åŒç†ï¼‰ã€‚</p>
<p>ä¹‹å‰ï¼š</p>
<pre><code class="language-rust ignore"><span class="boring">#![allow(deprecated)]
</span><span class="boring">use pyo3::prelude::*;
</span><span class="boring">use pyo3::types::{PyInt, PyList};
</span><span class="boring">fn main() -&gt; PyResult&lt;()&gt; {
</span>Python::with_gil(|py| {
    let list = PyList::new(py, 0..5);
    let b = &lt;PyInt as PyTryFrom&gt;::try_from(list.get_item(0).unwrap())?;
    Ok(())
})
<span class="boring">}</span></code></pre>
<p>ä¹‹åï¼š</p>
<pre><code class="language-rust ignore"><span class="boring">use pyo3::prelude::*;
</span><span class="boring">use pyo3::types::{PyInt, PyList};
</span><span class="boring">fn main() -&gt; PyResult&lt;()&gt; {
</span>Python::with_gil(|py| {
    // æ³¨æ„ PyList::new å·²è¢«å¼ƒç”¨ï¼Œåº”ä½¿ç”¨ PyList::new_boundï¼Œè¿™æ˜¯ GIL Refs API ç§»é™¤çš„ä¸€éƒ¨åˆ†
    // è¯¦è§ä¸‹æ–‡å…³äºè¿ç§»åˆ° Bound&lt;T&gt; çš„ç« èŠ‚ã€‚
    #[allow(deprecated)]
    let list = PyList::new(py, 0..5);
    let b = list.get_item(0).unwrap().downcast::&lt;PyInt&gt;()?;
    Ok(())
})
<span class="boring">}</span></code></pre>
</details>
<h3 id="iteranextoutput-å·²è¢«å¼ƒç”¨"><a class="header" href="#iteranextoutput-å·²è¢«å¼ƒç”¨"><code>Iter(A)NextOutput</code> å·²è¢«å¼ƒç”¨</a></h3>
<details>
<summary><small>ç‚¹å‡»å±•å¼€</small></summary>
<p><code>__next__</code> å’Œ <code>__anext__</code> é­”æ³•æ–¹æ³•ç°åœ¨å¯ä»¥åƒå…¶ä»–æ‰€æœ‰ <code>#[pymethods]</code> ä¸€æ ·ï¼Œç›´æ¥è¿”å›ä»»ä½•å¯è½¬æ¢ä¸º Python å¯¹è±¡çš„ç±»å‹ã€‚å› æ­¤ï¼Œ<code>__next__</code> ä½¿ç”¨çš„ <code>IterNextOutput</code> ä»¥åŠ <code>__anext__</code> ä½¿ç”¨çš„ <code>IterANextOutput</code> å‡è¢«å¼ƒç”¨ã€‚æœ€é‡è¦çš„æ˜¯ï¼Œè¿™ä¸€æ›´æ”¹å…è®¸ <code>__anext__</code> ç›´æ¥è¿”å›ä¸€ä¸ªå¯ç­‰å¾…å¯¹è±¡ï¼ˆawaitableï¼‰ï¼Œè€Œæ— éœ€å°†å…¶æ— æ„ä¹‰åœ°åŒ…è£¹åœ¨ <code>Yield</code> æˆ– <code>Some</code> ä¸­ã€‚åªæœ‰è¿”å›ç±»å‹ <code>Option&lt;T&gt;</code> å’Œ <code>Result&lt;Option&lt;T&gt;, E&gt;</code> ä»ä»¥ç‰¹æ®Šæ–¹å¼å¤„ç†ï¼š<code>Some(val)</code> è¡¨ç¤ºäº§ç”Ÿ <code>val</code>ï¼Œ<code>None</code> è¡¨ç¤ºåœæ­¢è¿­ä»£ã€‚</p>
<p>ä»¥ä¸€ä¸ªä½¿ç”¨ <code>IterNextOutput</code> å®ç° Python è¿­ä»£å™¨ä¸ºä¾‹ï¼š</p>
<pre><code class="language-rust ignore">use pyo3::prelude::*;
use pyo3::iter::IterNextOutput;


#[pyclass]
struct PyClassIter {
    count: usize,
}


#[pymethods]
impl PyClassIter {
    fn __next__(&amp;mut self) -&gt; IterNextOutput&lt;usize, &amp;'static str&gt; {
        if self.count &lt; 5 {
            self.count += 1;
            IterNextOutput::Yield(self.count)
        } else {
            IterNextOutput::Return("done")
        }
    }
}</code></pre>
<p>å¦‚æœä¸éœ€è¦é€šè¿‡ <code>StopIteration</code> è¿”å› <code>"done"</code>ï¼Œåˆ™åº”æ”¹å†™ä¸ºï¼š</p>
<pre><code class="language-rust no_run">use pyo3::prelude::*;


#[pyclass]
struct PyClassIter {
    count: usize,
}


#[pymethods]
impl PyClassIter {
    fn __next__(&amp;mut self) -&gt; Option&lt;usize&gt; {
        if self.count &lt; 5 {
            self.count += 1;
            Some(self.count)
        } else {
            None
        }
    }
}</code></pre>
<p>è¿™ç§å†™æ³•è¿˜æœ‰é¢å¤–ä¼˜ç‚¹ï¼šå®ƒåœ¨ä¹‹å‰ç‰ˆæœ¬çš„ PyO3 ä¸­å·²ç»å¯ç”¨ï¼Œä¸ Rust çš„ <a href="https://doc.rust-lang.org/stable/std/iter/trait.Iterator.html"><code>Iterator</code> trait</a> ç­¾åä¸€è‡´ï¼Œå¹¶å…è®¸åœ¨ CPython ä¸­ä½¿ç”¨å¿«é€Ÿè·¯å¾„ï¼Œå®Œå…¨é¿å…æŠ›å‡º <code>StopIteration</code> å¼‚å¸¸çš„å¼€é”€ã€‚æ³¨æ„ï¼Œé€šè¿‡ä½¿ç”¨ <a href="https://doc.rust-lang.org/stable/std/option/enum.Option.html#method.transpose"><code>Option::transpose</code></a> å’Œ <code>Result&lt;Option&lt;T&gt;, E&gt;</code> å˜ä½“ï¼Œæ­¤å½¢å¼ä¹Ÿå¯ç”¨äºåŒ…è£…å¯èƒ½å‡ºé”™çš„è¿­ä»£å™¨ã€‚</p>
<p>æˆ–è€…ï¼Œä¹Ÿå¯ä»¥åƒåœ¨ Python ä¸­ä¸€æ ·ï¼Œé€šè¿‡â€œæŠ›å‡ºâ€<code>StopIteration</code> å¼‚å¸¸æ¥å®ç°ï¼š</p>
<pre><code class="language-rust no_run">use pyo3::prelude::*;
use pyo3::exceptions::PyStopIteration;


#[pyclass]
struct PyClassIter {
    count: usize,
}


#[pymethods]
impl PyClassIter {
    fn __next__(&amp;mut self) -&gt; PyResult&lt;usize&gt; {
        if self.count &lt; 5 {
            self.count += 1;
            Ok(self.count)
        } else {
            Err(PyStopIteration::new_err("done"))
        }
    }
}</code></pre>
<p>æœ€åï¼Œå¼‚æ­¥è¿­ä»£å™¨å¯ä»¥ç›´æ¥è¿”å›ä¸€ä¸ªå¯ç­‰å¾…å¯¹è±¡ï¼Œè€Œæ— éœ€æ··æ·†çš„åŒ…è£…ï¼š</p>
<pre><code class="language-rust no_run">use pyo3::prelude::*;


#[pyclass]
struct PyClassAwaitable {
    number: usize,
}


#[pymethods]
impl PyClassAwaitable {
    fn __next__(&amp;self) -&gt; usize {
        self.number
    }


    fn __await__(slf: Py&lt;Self&gt;) -&gt; Py&lt;Self&gt; {
        slf
    }
}


#[pyclass]
struct PyClassAsyncIter {
    number: usize,
}


#[pymethods]
impl PyClassAsyncIter {
    fn __anext__(&amp;mut self) -&gt; PyClassAwaitable {
        self.number += 1;
        PyClassAwaitable {
            number: self.number,
        }
    }


    fn __aiter__(slf: Py&lt;Self&gt;) -&gt; Py&lt;Self&gt; {
        slf
    }
}</code></pre>
</details>
<h3 id="pytypename-å·²é‡å‘½åä¸º-pytypequalname"><a class="header" href="#pytypename-å·²é‡å‘½åä¸º-pytypequalname"><code>PyType::name</code> å·²é‡å‘½åä¸º <code>PyType::qualname</code></a></h3>
<details>
<summary><small>ç‚¹å‡»å±•å¼€</small></summary>
<p><code>PyType::name</code> å·²é‡å‘½åä¸º <code>PyType::qualname</code>ï¼Œä»¥è¡¨æ˜å…¶ç¡®å®è¿”å›çš„æ˜¯<a href="https://docs.python.org/3/glossary.html#term-qualified-name">é™å®šåç§°</a>ï¼Œä¸ <code>__qualname__</code> å±æ€§ä¸€è‡´ã€‚æ–°æ·»åŠ çš„ <code>PyType::name</code> æ–¹æ³•ç°åœ¨è¿”å›åŒ…å«æ¨¡å—åç§°çš„å®Œæ•´åç§°ï¼Œå¯¹åº”å±æ€§å±‚é¢çš„ <code>__module__.__name__</code>ã€‚</p>
</details>
<h3 id="pycell-å·²è¢«å¼ƒç”¨"><a class="header" href="#pycell-å·²è¢«å¼ƒç”¨"><code>PyCell</code> å·²è¢«å¼ƒç”¨</a></h3>
<details>
<summary><small>ç‚¹å‡»å±•å¼€</small></summary>
<p>ç”¨ Rust å®ç°çš„ Python å¯¹è±¡çš„äº¤äº’ä¸å†éœ€è¦é€šè¿‡ <code>PyCell&lt;T&gt;</code>ã€‚ç°åœ¨ï¼Œæ— è®º <code>T</code> æ˜¯åŸç”Ÿ Python å¯¹è±¡è¿˜æ˜¯ç”¨ <code>#[pyclass]</code> å®šä¹‰çš„ Rust ç±»å‹ï¼Œä¸ Python å¯¹è±¡çš„äº¤äº’éƒ½ä¸€è‡´åœ°é€šè¿‡ <code>Bound&lt;T&gt;</code> æˆ– <code>Py&lt;T&gt;</code> è¿›è¡Œã€‚ä½¿ç”¨ <code>Bound::new</code> æˆ– <code>Py::new</code> åˆ›å»ºå¯¹è±¡ï¼Œå¹¶ä½¿ç”¨ <code>Bound::borrow(_mut)</code> / <code>Py::borrow(_mut)</code> æ¥å€Ÿç”¨å†…éƒ¨çš„ Rust å¯¹è±¡ã€‚</p>
</details>
<h3 id="ä»-gil-refs-api-è¿ç§»åˆ°-boundt"><a class="header" href="#ä»-gil-refs-api-è¿ç§»åˆ°-boundt">ä» GIL Refs API è¿ç§»åˆ° <code>Bound&lt;T&gt;</code></a></h3>
<details>
<summary><small>ç‚¹å‡»å±•å¼€</small></summary>
<p>ä¸ºäº†å°½é‡å‡å°‘å¯¹ä½¿ç”¨ GIL Refs API çš„ä»£ç é€ æˆç ´åï¼ŒPyO3 å¼•å…¥äº† <code>Bound&lt;T&gt;</code> æ™ºèƒ½æŒ‡é’ˆï¼Œå¹¶ä¸ºæ‰€æœ‰æ¥æ”¶æˆ–è¿”å› GIL Refs çš„å‡½æ•°æä¾›äº†å¯¹åº”çš„æ›¿ä»£ç‰ˆæœ¬ã€‚è¿™ä½¿ä»£ç å¯ä»¥é€šè¿‡ç”¨æ–° API æ›¿æ¢æ—§çš„å¼ƒç”¨ API æ¥é€æ­¥è¿ç§»ã€‚</p>
<p>è¦è¯†åˆ«éœ€è¦è¿ç§»çš„éƒ¨åˆ†ï¼Œå¯ä¸´æ—¶å…³é—­ <code>gil-refs</code> åŠŸèƒ½ï¼Œä»¥æŸ¥çœ‹å‡ ä¹æ‰€æœ‰ä½¿ç”¨æ¥å—æˆ–äº§ç”Ÿ GIL Refs çš„ API<a href="#cases-where-pyo3-cannot-emit-gil-ref-deprecation-warnings">ä½ç½®</a>ä¸Šçš„å¼ƒç”¨è­¦å‘Šã€‚é€šè¿‡ä¸€ä¸ªæˆ–å¤šä¸ª PRï¼Œå¯ä»¥ä¾ç…§å¼ƒç”¨æç¤ºé€æ­¥æ›´æ–°ä»£ç ã€‚æ ¹æ®å¼€å‘ç¯å¢ƒä¸åŒï¼Œå…³é—­ <code>gil-refs</code> åŠŸèƒ½å¯èƒ½ä¼šå¼•å…¥<a href="#deactivating-the-gil-refs-feature">ä¸€äº›ç‰¹å®šçš„é”™è¯¯</a>ï¼Œå› æ­¤å¯èƒ½éœ€è¦å…ˆä¿®å¤è¿™äº›é”™è¯¯ã€‚</p>
<p>ä¾‹å¦‚ï¼Œä»¥ä¸‹ API å‡å·²è·å¾—æ›´æ–°çš„å˜ä½“ï¼š</p>
<ul>
<li><code>PyList::new</code>ã€<code>PyTuple::new</code> ç­‰æ„é€ å‡½æ•°ï¼Œå¯¹åº”æ›¿ä»£ä¸º <code>PyList::new_bound</code>ã€<code>PyTuple::new_bound</code> ç­‰ã€‚</li>
<li><code>FromPyObject::extract</code> æœ‰äº†æ–°çš„ <code>FromPyObject::extract_bound</code>ï¼ˆè§ä¸‹æ–‡ï¼‰ã€‚</li>
<li><code>PyTypeInfo</code> trait æ–°å¢äº† <code>_bound</code> æ–¹æ³•ï¼Œç”¨äºæ¥æ”¶æˆ–è¿”å› <code>Bound&lt;T&gt;</code>ã€‚</li>
</ul>
<p>ç”±äºæ–°çš„ <code>Bound&lt;T&gt;</code> API å°†æ‰€æœ‰æƒä» PyO3 æ¡†æ¶ç§»äº¤åˆ°äº†ç”¨æˆ·ä»£ç ä¸­ï¼Œå› æ­¤åœ¨åˆ‡æ¢åˆ°æ–° API æ—¶ï¼Œç”¨æˆ·ä»£ç å¯èƒ½éœ€è¦è¿›è¡Œå¦‚ä¸‹è°ƒæ•´ï¼š</p>
<ul>
<li>ä»£ç å¯èƒ½éœ€è¦æ·»åŠ å¶å°”çš„ <code>&amp;</code> æ¥å€Ÿç”¨æ–°çš„æ™ºèƒ½æŒ‡é’ˆ <code>&amp;Bound&lt;T&gt;</code> è¿›è¡Œä¼ é€’ï¼ˆæˆ–ä½¿ç”¨ <code>.clone()</code>ï¼Œå…¶ä»£ä»·æ˜¯è½»å¾®å¢åŠ  Python å¼•ç”¨è®¡æ•°ï¼‰ã€‚</li>
<li><code>Bound&lt;PyList&gt;</code> å’Œ <code>Bound&lt;PyTuple&gt;</code> ä¸æ”¯æŒ <code>list[0]</code> ç´¢å¼•ï¼Œè€Œåº”ä½¿ç”¨ <code>list.get_item(0)</code>ã€‚</li>
<li><code>Bound&lt;PyTuple&gt;::iter_borrowed</code> æ¯” <code>Bound&lt;PyTuple&gt;::iter</code> ç¨å¾®æ›´é«˜æ•ˆã€‚<code>Bound&lt;PyTuple&gt;</code> çš„é»˜è®¤è¿­ä»£æ— æ³•è¿”å›å€Ÿç”¨å¼•ç”¨ï¼Œå› ä¸º Rust ç›®å‰å°šæœªæ”¯æŒâ€œå‡ºå€Ÿè¿­ä»£å™¨â€ï¼ˆlending iteratorsï¼‰ã€‚åŒç†ï¼Œ<code>Bound&lt;PyTuple&gt;::get_borrowed_item</code> æ¯” <code>get_item</code> æ›´é«˜æ•ˆã€‚</li>
<li><code>&amp;Bound&lt;T&gt;</code> ä¸å†å®ç° <code>FromPyObject</code>ï¼ˆå°½ç®¡æœªæ¥åœ¨ GIL Refs API å®Œå…¨ç§»é™¤åå¯èƒ½å®ç°ï¼‰ã€‚åº”ä½¿ç”¨ <code>bound_any.downcast::&lt;T&gt;()</code> æ›¿ä»£ <code>bound_any.extract::&lt;&amp;Bound&lt;T&gt;&gt;()</code>ã€‚</li>
<li><code>Bound&lt;PyString&gt;::to_str</code> ç°åœ¨ä» <code>Bound&lt;PyString&gt;</code> æœ¬èº«å€Ÿç”¨ï¼Œè€Œéä»åŸæœ‰çš„ <code>'py</code> ç”Ÿå‘½å‘¨æœŸå€Ÿç”¨ï¼Œå› æ­¤åœ¨æŸäº›ä¹‹å‰ <code>&amp;PyString</code> ä»…ä½œä¸ºä¸´æ—¶å€¼ä½¿ç”¨çš„åœ°æ–¹ï¼Œç°åœ¨éœ€è¦å°†æ™ºèƒ½æŒ‡é’ˆä½œä¸ºå€¼å­˜å‚¨ã€‚ï¼ˆ<a href="#deactivating-the-gil-refs-feature">ä¸‹æ–‡</a> ä¸­å¯¹æ­¤æœ‰æ›´å¤šç»†èŠ‚è¯´æ˜ã€‚ï¼‰</li>
</ul>
</details>- `.extract::&lt;&amp;str&gt;()` ç°åœ¨ä¼šä»æº Python å¯¹è±¡å€Ÿç”¨ã€‚æœ€ç®€å•çš„å‡çº§æ–¹å¼æ˜¯æ”¹ä¸ºä½¿ç”¨ `.extract::<pybackedstr>()`ï¼Œå®ƒå¯ä»¥ä¿ç•™å¯¹ Python å¼•ç”¨çš„æ‰€æœ‰æƒã€‚æ›´å¤šä¿¡æ¯è¯·å‚è§[å…³äºåœç”¨ `gil-refs` ç‰¹æ€§çš„ç« èŠ‚](#deactivating-the-gil-refs-feature)ã€‚
<p>è¦åœ¨ <code>&amp;PyAny</code> å’Œ <code>&amp;Bound&lt;PyAny&gt;</code> ä¹‹é—´è½¬æ¢ï¼Œè¯·ä½¿ç”¨ <code>as_borrowed()</code> æ–¹æ³•ï¼š</p>
<pre><code class="language-rust ignore">let gil_ref: &amp;PyAny = ...;
let bound: &amp;Bound&lt;PyAny&gt; = &amp;gil_ref.as_borrowed();</code></pre>
<p>è¦åœ¨ <code>Py&lt;T&gt;</code> å’Œ <code>Bound&lt;T&gt;</code> ä¹‹é—´è½¬æ¢ï¼Œè¯·ä½¿ç”¨ <code>bind()</code> / <code>into_bound()</code> æ–¹æ³•ï¼›è¦ä» <code>Bound&lt;T&gt;</code> å›åˆ° <code>Py&lt;T&gt;</code>ï¼Œè¯·ä½¿ç”¨ <code>as_unbound()</code> / <code>unbind()</code> æ–¹æ³•ã€‚</p>
<pre><code class="language-rust ignore">let obj: Py&lt;PyList&gt; = ...;
let bound: &amp;Bound&lt;'py, PyList&gt; = obj.bind(py);
let bound: Bound&lt;'py, PyList&gt; = obj.into_bound(py);

let obj: &amp;Py&lt;PyList&gt; = bound.as_unbound();
let obj: Py&lt;PyList&gt; = bound.unbind();</code></pre>
<div class="warning">
<p>âš ï¸ è­¦å‘Šï¼šæ‚¬å‚æŒ‡é’ˆé™·é˜± ğŸ’£</p>
<blockquote>
<p>ç”±äºæ‰€æœ‰æƒçš„å˜æ›´ï¼Œé‚£äº›ä½¿ç”¨ <code>.as_ptr()</code> å°† <code>&amp;PyAny</code> å’Œå…¶ä»– GIL å¼•ç”¨è½¬æ¢ä¸º <code>*mut pyo3_ffi::PyObject</code> çš„ä»£ç ï¼Œç°åœ¨éœ€è¦ç‰¹åˆ«æ³¨æ„é¿å…åœ¨ <code>Bound&lt;PyAny&gt;</code> æŒæœ‰æ‰€æœ‰æƒçš„æƒ…å†µä¸‹åˆ›å»ºæ‚¬å‚æŒ‡é’ˆã€‚</p>
<p>ä¾‹å¦‚ï¼Œåœ¨è¿ç§»åˆ° <code>Bound&lt;PyAny&gt;</code> æ™ºèƒ½æŒ‡é’ˆæ—¶ï¼Œä»¥ä¸‹ä½¿ç”¨ <code>Option&lt;&amp;PyAny&gt;</code> çš„æ¨¡å¼å¾ˆå®¹æ˜“äº§ç”Ÿæ‚¬å‚æŒ‡é’ˆï¼š</p>
<pre><code class="language-rust ignore">let opt: Option&lt;&amp;PyAny&gt; = ...;
let p: *mut ffi::PyObject = opt.map_or(std::ptr::null_mut(), |any| any.as_ptr());</code></pre>
<p>æ­£ç¡®çš„è¿ç§»æ–¹å¼æ˜¯ä½¿ç”¨ <code>.as_ref()</code>ï¼Œä»¥é¿å…åœ¨ <code>map_or</code> é—­åŒ…ä¸­æå‰ææ„ <code>Bound&lt;PyAny&gt;</code>ï¼š</p>
<pre><code class="language-rust ignore">let opt: Option&lt;Bound&lt;PyAny&gt;&gt; = ...;
let p: *mut ffi::PyObject = opt.as_ref().map_or(std::ptr::null_mut(), Bound::as_ptr);</code></pre>
</blockquote>
</div>

<h4 id="è¿ç§»-frompyobject-çš„å®ç°"><a class="header" href="#è¿ç§»-frompyobject-çš„å®ç°">è¿ç§» <code>FromPyObject</code> çš„å®ç°</a></h4>
<p><code>FromPyObject</code> æ–°å¢äº†ä¸€ä¸ªæ–¹æ³• <code>extract_bound</code>ï¼Œå…¶å‚æ•°ä¸º <code>&amp;Bound&lt;'py, PyAny&gt;</code> è€Œé <code>&amp;PyAny</code>ã€‚<code>extract</code> å’Œ <code>extract_bound</code> éƒ½å·²è¢«æä¾›äº†å½¼æ­¤çš„é»˜è®¤å®ç°ï¼Œä»¥é¿å…åœ¨å‡çº§åˆ° 0.21 æ—¶ç«‹åˆ»ç ´åç°æœ‰ä»£ç ã€‚</p>
<p>æ‰€æœ‰ <code>FromPyObject</code> çš„å®ç°éƒ½åº”ä» <code>extract</code> è¿ç§»åˆ° <code>extract_bound</code>ã€‚</p>
<p>è¿ç§»å‰ï¼š</p>
<pre><code class="language-rust ignore">impl&lt;'py&gt; FromPyObject&lt;'py&gt; for MyType {
    fn extract(obj: &amp;'py PyAny) -&gt; PyResult&lt;Self&gt; {
        /* ... */
    }
}</code></pre>
<p>è¿ç§»åï¼š</p>
<pre><code class="language-rust ignore">impl&lt;'py&gt; FromPyObject&lt;'py&gt; for MyType {
    fn extract_bound(obj: &amp;Bound&lt;'py, PyAny&gt;) -&gt; PyResult&lt;Self&gt; {
        /* ... */
    }
}</code></pre>
<p>é¢„è®¡åœ¨ 0.22 ç‰ˆæœ¬ä¸­ï¼Œ<code>extract_bound</code> å°†ä¸å†æä¾›é»˜è®¤å®ç°ï¼›åœ¨ 0.23 ç‰ˆæœ¬ä¸­ï¼Œ<code>extract</code> å°†è¢«å®Œå…¨ç§»é™¤ã€‚</p>
<h4 id="pyo3-æ— æ³•å‘å‡º-gil-å¼•ç”¨å¼ƒç”¨è­¦å‘Šçš„åœºæ™¯"><a class="header" href="#pyo3-æ— æ³•å‘å‡º-gil-å¼•ç”¨å¼ƒç”¨è­¦å‘Šçš„åœºæ™¯">PyO3 æ— æ³•å‘å‡º GIL å¼•ç”¨å¼ƒç”¨è­¦å‘Šçš„åœºæ™¯</a></h4>
<p>å°½ç®¡ PyO3 äº§ç”Ÿäº†å¤§é‡å¼ƒç”¨è­¦å‘Šä»¥å¸®åŠ©ç”¨æˆ·ä» GIL å¼•ç”¨è¿ç§»åˆ° Bound APIï¼Œä½†ä»æœ‰ä¸€äº›æƒ…å†µä¸‹æ— æ³•è‡ªåŠ¨è­¦å‘Š GIL å¼•ç”¨çš„ä½¿ç”¨ã€‚åœ¨å¤„ç†å®Œæ‰€æœ‰å¼ƒç”¨è­¦å‘Šåï¼Œå»ºè®®æ‰‹åŠ¨æ£€æŸ¥ä»¥ä¸‹æƒ…å†µï¼š</p>
<ul>
<li><code>FromPyObject</code> trait çš„å…·ä½“å®ç°æ— æ³•è¢«æ ‡è®°ä¸ºå¼ƒç”¨ï¼Œå› æ­¤ PyO3 æ— æ³•è­¦å‘Šç±»ä¼¼ <code>.extract&lt;&amp;PyAny&gt;()</code> è¿™æ ·äº§ç”Ÿ GIL å¼•ç”¨çš„ä»£ç æ¨¡å¼ã€‚</li>
<li><code>#[pyfunction]</code> å‚æ•°ä¸­çš„ GIL å¼•ç”¨ä¼šå‘å‡ºè­¦å‘Šï¼Œä½†å¦‚æœ GIL å¼•ç”¨è¢«åŒ…è£¹åœ¨å…¶ä»–å®¹å™¨ä¸­ï¼ˆä¾‹å¦‚ <code>Vec&lt;&amp;PyAny&gt;</code>ï¼‰ï¼ŒPyO3 å°±æ— æ³•å‘å‡ºè­¦å‘Šã€‚</li>
<li><code>wrap_pyfunction!(function)(py)</code> è¿™ç§å»¶è¿Ÿä¼ å‚å½¢å¼çš„å®è°ƒç”¨ä¸­ï¼Œå½“ä¼ å…¥ <code>py: Python&lt;'py&gt;</code> æ—¶ä¼šäº§ç”Ÿ GIL å¼•ç”¨ï¼Œä½†ç”±äºç±»å‹æ¨å¯¼çš„é™åˆ¶ï¼ŒPyO3 æ— æ³•é’ˆå¯¹æ­¤æƒ…å†µå‘å‡ºè­¦å‘Šã€‚</li>
</ul>

<h3 id="åœç”¨-gil-refs-ç‰¹æ€§"><a class="header" href="#åœç”¨-gil-refs-ç‰¹æ€§">åœç”¨ <code>gil-refs</code> ç‰¹æ€§</a></h3>
<details>
<summary><small>ç‚¹å‡»å±•å¼€</small></summary>
<p>ä½œä¸ºè¿ç§»çš„æœ€åä¸€æ­¥ï¼Œåœç”¨ <code>gil-refs</code> ç‰¹æ€§å°†ä¸ºä»£ç å¸¦æ¥æœ€ä½³æ€§èƒ½ï¼Œå¹¶ä¸º PyO3 0.22 å»ºç«‹å‘å‰å…¼å®¹çš„ APIã€‚</p>
<p>æ­¤æ—¶ï¼ŒåŸå…ˆéœ€è¦ç®¡ç† GIL å¼•ç”¨å†…å­˜çš„ä»£ç å¯ä»¥å®‰å…¨åœ°ç§»é™¤å¯¹ <code>GILPool</code> çš„ä½¿ç”¨ï¼ˆè¯¥å¯¹è±¡ç”± <code>Python::new_pool</code> å’Œ <code>Python::with_pool</code> è°ƒç”¨åˆ›å»ºï¼‰ã€‚å¼ƒç”¨è­¦å‘Šå°†é«˜äº®è¿™äº›ä½¿ç”¨åœºæ™¯ã€‚</p>
<p>ç¦ç”¨è¯¥ç‰¹æ€§åï¼Œåªæœ‰ä¸€ç§æƒ…å†µä¼šå¯¼è‡´ä»£ç è¡Œä¸ºå˜åŒ–ï¼šå¯¹äºé‚£äº›ç›´æ¥ä»è¾“å…¥æ•°æ®å€Ÿç”¨çš„ç±»å‹ï¼ŒPyO3 åœ¨æ²¡æœ‰ GIL å¼•ç”¨çš„æƒ…å†µä¸‹æ— æ³•å®ç° <code>FromPyObject</code> traitï¼ˆç›®å‰æ­£å¤„äºç§»é™¤ GIL å¼•ç”¨ API çš„è¿‡ç¨‹ä¸­ï¼‰ã€‚ä¸»è¦å—å½±å“çš„ç±»å‹åŒ…æ‹¬ <code>&amp;str</code>ã€<code>Cow&lt;'_, str&gt;</code>ã€<code>&amp;[u8]</code>ã€<code>Cow&lt;'_, u8&gt;</code>ã€‚</p>
<p>ä¸ºäº†åœ¨ GIL å¼•ç”¨ API è¢«ç§»é™¤çš„è¿‡ç¨‹ä¸­ä¿æŒ PyO3 æ ¸å¿ƒåŠŸèƒ½çš„å¯ç”¨æ€§ï¼Œç¦ç”¨ <code>gil-refs</code> ç‰¹æ€§åï¼Œ<code>&amp;str</code>ã€<code>Cow&lt;'_, str&gt;</code>ã€<code>&amp;[u8]</code>ã€<code>Cow&lt;'_, u8&gt;</code> çš„ <code>FromPyObject</code> å®ç°å°†è¢«ç§»è‡³ä¸€ä¸ªæ–°çš„ä¸´æ—¶ trait <code>FromPyObjectBound</code>ã€‚è¯¥ trait æ˜¯æœªæ¥ <code>FromPyObject</code> çš„é¢„æœŸå½¢æ€ï¼Œé¢å¤–å¼•å…¥äº†ä¸€ä¸ªç”Ÿå‘½å‘¨æœŸ <code>'a</code>ï¼Œä»¥æ”¯æŒè¿™äº›ç±»å‹ä» Python å¯¹è±¡ä¸­å€Ÿç”¨æ•°æ®ã€‚</p>
<p>PyO3 0.21 å¼•å…¥äº† <a href="{{#PYO3_DOCS_URL}}/pyo3/pybacked/struct.PyBackedStr.html"><code>PyBackedStr</code></a> å’Œ <a href="{{#PYO3_DOCS_URL}}/pyo3/pybacked/struct.PyBackedBytes.html"><code>PyBackedBytes</code></a> ç±»å‹æ¥åº”å¯¹è¿™ä¸€å˜åŒ–ã€‚é¿å… <code>&amp;str</code> æå–å¸¦æ¥çš„ç”Ÿå‘½å‘¨æœŸé—®é¢˜çš„æœ€ç®€å•æ–¹å¼å°±æ˜¯ä½¿ç”¨è¿™ä¸¤ä¸ªç±»å‹ã€‚å¯¹äºæ›´å¤æ‚çš„ç±»å‹ï¼ˆå¦‚ <code>Vec&lt;&amp;str&gt;</code>ï¼‰ï¼Œç°åœ¨å·²ç»æ— æ³•ç›´æ¥ä» Python å¯¹è±¡ä¸­æå–ï¼Œæ¨èçš„å‡çº§è·¯å¾„æ˜¯ä½¿ç”¨ <code>Vec&lt;PyBackedStr&gt;</code>ã€‚</p>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œç”±äºæå–è¿™äº›ç±»å‹ç°åœ¨ç»‘å®šåˆ°äº†è¾“å…¥å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸï¼Œä¸€äº›éå¸¸å¸¸è§çš„æ¨¡å¼å¯èƒ½éœ€è¦æ‹†åˆ†ä¸ºå¤šè¡Œ Rust ä»£ç ã€‚ä¾‹å¦‚ï¼Œä»¥ä¸‹ç›´æ¥åœ¨ <code>.getattr()</code> ç»“æœä¸Šè°ƒç”¨ <code>.extract::&lt;&amp;str&gt;()</code> çš„ä»£ç ç‰‡æ®µï¼Œåœ¨åœç”¨ <code>gil-refs</code> ç‰¹æ€§åéœ€è¦è¿›è¡Œè°ƒæ•´ã€‚</p>
<p>è¿ç§»å‰ï¼š</p>
<pre><code class="language-rust ignore"><span class="boring">#[cfg(feature = "gil-refs")] {
</span><span class="boring">use pyo3::prelude::*;
</span><span class="boring">use pyo3::types::{PyList, PyType};
</span><span class="boring">fn example&lt;'py&gt;(py: Python&lt;'py&gt;) -&gt; PyResult&lt;()&gt; {
</span>#[allow(deprecated)] // GIL Ref API
let obj: &amp;'py PyType = py.get_type::&lt;PyList&gt;();
let name: &amp;'py str = obj.getattr("__name__")?.extract()?;
assert_eq!(name, "list");
<span class="boring">Ok(())
</span><span class="boring">}
</span><span class="boring">Python::with_gil(example).unwrap();
</span><span class="boring">}</span></code></pre>
<p>è¿ç§»åï¼š</p>
<pre><code class="language-rust ignore"><span class="boring">#[cfg(any(not(Py_LIMITED_API), Py_3_10))] {
</span><span class="boring">use pyo3::prelude::*;
</span><span class="boring">use pyo3::types::{PyList, PyType};
</span><span class="boring">fn example&lt;'py&gt;(py: Python&lt;'py&gt;) -&gt; PyResult&lt;()&gt; {
</span>let obj: Bound&lt;'py, PyType&gt; = py.get_type_bound::&lt;PyList&gt;();
let name_obj: Bound&lt;'py, PyAny&gt; = obj.getattr("__name__")?;
// æ•°æ®çš„ç”Ÿå‘½å‘¨æœŸä¸å†æ˜¯ `'py`ï¼Œè€Œæ˜¯ä¸Šæ–‡ `name_obj` æ™ºèƒ½æŒ‡é’ˆçš„æ›´çŸ­ç”Ÿå‘½å‘¨æœŸ
let name: &amp;'_ str = name_obj.extract()?;
assert_eq!(name, "list");
<span class="boring">Ok(())
</span><span class="boring">}
</span><span class="boring">Python::with_gil(example).unwrap();
</span><span class="boring">}</span></code></pre>
<p>å¦‚æœå¸Œæœ›å®Œå…¨é¿å…å¤„ç†ç”Ÿå‘½å‘¨æœŸé—®é¢˜ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨æ–°çš„ <code>PyBackedStr</code> ç±»å‹ï¼Œå®ƒå­˜å‚¨å¯¹ Python <code>str</code> çš„å¼•ç”¨ä½†æ— éœ€é™„åŠ ç”Ÿå‘½å‘¨æœŸã€‚ç‰¹åˆ«æ˜¯å¯¹äºä½äº 3.10 ç‰ˆæœ¬ Python çš„ <code>abi3</code> æ„å»ºï¼Œ<code>PyBackedStr</code> éå¸¸æœ‰ç”¨ã€‚ç”±äºæ—§ç‰ˆæœ¬ <code>abi3</code> CPython API çš„é™åˆ¶ï¼ŒPyO3 æ— æ³•åœ¨è¿™äº›ç‰ˆæœ¬ä¸Šä¸º <code>&amp;str</code> æä¾› <code>FromPyObjectBound</code> å®ç°ã€‚å› æ­¤ï¼Œå¯¹äºæ—§ç‰ˆ <code>abi3</code> æ„å»ºï¼Œæœ€ç®€å•çš„è¿ç§»æ–¹å¼æ˜¯å°†æ‰€æœ‰ <code>.extract::&lt;&amp;str&gt;()</code> æ›¿æ¢ä¸º <code>.extract::&lt;PyBackedStr&gt;()</code>ã€‚æˆ–è€…ï¼Œä¹Ÿå¯ä½¿ç”¨ <code>.extract::&lt;Cow&lt;str&gt;&gt;()</code>ã€<code>.extract::&lt;String&gt;()</code> å°†æ•°æ®å¤åˆ¶åˆ° Rust ä¸­ã€‚</p>
<p>ä»¥ä¸‹ç¤ºä¾‹ä¸ä¸Šé¢ç±»ä¼¼ï¼Œä½†æœ€ç»ˆæå–ç±»å‹ä¸º <code>PyBackedStr</code>ï¼š</p>
<pre><code class="language-rust ignore"><span class="boring">use pyo3::prelude::*;
</span><span class="boring">use pyo3::types::{PyList, PyType};
</span><span class="boring">fn example&lt;'py&gt;(py: Python&lt;'py&gt;) -&gt; PyResult&lt;()&gt; {
</span>use pyo3::pybacked::PyBackedStr;
let obj: Bound&lt;'py, PyType&gt; = py.get_type_bound::&lt;PyList&gt;();
let name: PyBackedStr = obj.getattr("__name__")?.extract()?;
assert_eq!(&amp;*name, "list");
<span class="boring">Ok(())
</span><span class="boring">}
</span><span class="boring">Python::with_gil(example).unwrap();</span></code></pre>
</details>
<h2 id="ä»-019-å‡çº§åˆ°-020"><a class="header" href="#ä»-019-å‡çº§åˆ°-020">ä» 0.19.* å‡çº§åˆ° 0.20</a></h2>
<h3 id="åœæ­¢æ”¯æŒæ—§æŠ€æœ¯"><a class="header" href="#åœæ­¢æ”¯æŒæ—§æŠ€æœ¯">åœæ­¢æ”¯æŒæ—§æŠ€æœ¯</a></h3>
<details>
<summary><small>ç‚¹å‡»å±•å¼€</small></summary>
<p>PyO3 0.20 å°†æœ€ä½ Rust ç‰ˆæœ¬æå‡è‡³ 1.56ã€‚è¿™ä½¿å¾—é¡¹ç›®å¯ä»¥ä½¿ç”¨æ›´æ–°çš„è¯­è¨€ç‰¹æ€§ï¼Œå¹¶ç®€åŒ–äº†ç»´æŠ¤å·¥ä½œã€‚</p>
</details>
<h3 id="pydictget_item-ç°åœ¨è¿”å›-result"><a class="header" href="#pydictget_item-ç°åœ¨è¿”å›-result"><code>PyDict::get_item</code> ç°åœ¨è¿”å› <code>Result</code></a></h3>
<details>
<summary><small>ç‚¹å‡»å±•å¼€</small></summary>
<p>åœ¨ PyO3 0.19 åŠæ›´æ—©ç‰ˆæœ¬ä¸­ï¼Œ<code>PyDict::get_item</code> ä½¿ç”¨äº†ä¼šæŠ‘åˆ¶æ‰€æœ‰å¼‚å¸¸å¹¶åœ¨å‡ºé”™æ—¶è¿”å› <code>None</code> çš„ Python APIã€‚è¿™åŒ…æ‹¬åœ¨æŸ¥æ‰¾é”®æ—¶å…¶ <code>__hash__</code> å’Œ <code>__eq__</code> æ–¹æ³•ä¸­å‡ºç°çš„é”™è¯¯ã€‚</p>
<p>Python æ ¸å¿ƒå¼€å‘è€…çš„æœ€æ–°å»ºè®®æ˜¯é¿å…ä½¿ç”¨ä¼šæŠ‘åˆ¶å¼‚å¸¸çš„ APIï¼Œè€Œåº”è®©å¼‚å¸¸å‘ä¸ŠæŠ›å‡ºã€‚<code>PyDict::get_item_with_error</code> å·²ç»å®ç°äº†è¿™ä¸€æ¨èè¡Œä¸ºï¼Œå› æ­¤è¯¥ API è¢«é‡å‘½åä¸º <code>PyDict::get_item</code>ã€‚</p>
<p>è¿ç§»å‰ï¼š</p>
<pre><code class="language-rust ignore">use pyo3::prelude::*;
use pyo3::exceptions::PyTypeError;
use pyo3::types::{PyDict, IntoPyDict};

<span class="boring">fn main() {
</span><span class="boring">let _ =
</span>Python::with_gil(|py| {
    let dict: &amp;PyDict = [("a", 1)].into_py_dict(py);
    // `a` åœ¨å­—å…¸ä¸­ï¼Œå€¼ä¸º 1
    assert!(dict.get_item("a").map_or(Ok(false), |x| x.eq(1))?);
    // `b` ä¸åœ¨å­—å…¸ä¸­
    assert!(dict.get_item("b").is_none());
    // `dict` ä¸å¯å“ˆå¸Œï¼Œå› æ­¤æ­¤å¤„ä¼šæŠ›å‡º `TypeError`
    assert!(dict
        .get_item_with_error(dict)
        .unwrap_err()
        .is_instance_of::&lt;PyTypeError&gt;(py));
});
<span class="boring">}</span></code></pre>
<p>è¿ç§»åï¼š</p>
<pre><code class="language-rust ignore">use pyo3::prelude::*;
use pyo3::exceptions::PyTypeError;
use pyo3::types::{PyDict, IntoPyDict};

<span class="boring">fn main() {
</span><span class="boring">let _ =
</span>Python::with_gil(|py| -&gt; PyResult&lt;()&gt; {
    let dict: &amp;PyDict = [("a", 1)].into_py_dict(py);
    // `a` åœ¨å­—å…¸ä¸­ï¼Œå€¼ä¸º 1
    assert!(dict.get_item("a")?.map_or(Ok(false), |x| x.eq(1))?);
    // `b` ä¸åœ¨å­—å…¸ä¸­
    assert!(dict.get_item("b")?.is_none());
    // `dict` ä¸å¯å“ˆå¸Œï¼Œå› æ­¤æ­¤å¤„ä¼šæŠ›å‡º `TypeError`
    assert!(dict
        .get_item(dict)
        .unwrap_err()
        .is_instance_of::&lt;PyTypeError&gt;(py));

    Ok(())
});
<span class="boring">}</span></code></pre>
</details>### åœ¨å¯é€‰å‚æ•°ä¹‹åä¸å†æ¥å—å¿…éœ€å‚æ•°
<details>
<summary><small>ç‚¹å‡»å±•å¼€</small></summary>
<p>å°¾éšçš„ <code>Option&lt;T&gt;</code> å‚æ•°å…·æœ‰è‡ªåŠ¨é»˜è®¤å€¼ <code>None</code>ã€‚ä¸ºäº†é¿å…åœ¨ä¿®æ”¹å‡½æ•°ç­¾åæ—¶äº§ç”Ÿæ„å¤–è¡Œä¸ºï¼Œä» PyO3 0.18 å¼€å§‹ï¼Œè‹¥åœ¨ <code>Option&lt;T&gt;</code> å‚æ•°ä¹‹åå­˜åœ¨å¿…éœ€å‚æ•°ï¼Œä¸”æœªä½¿ç”¨ <code>#[pyo3(signature = (...))]</code> æ˜¾å¼æŒ‡å®šé»˜è®¤å€¼ï¼Œåˆ™ä¼šè§¦å‘å¼ƒç”¨è­¦å‘Šã€‚åœ¨ PyO3 0.20 ä¸­ï¼Œè¿™å°†æˆä¸ºç¡¬æ€§é”™è¯¯ã€‚</p>
<p>ä¿®æ”¹å‰ï¼š</p>
<pre><code class="language-rust ignore">#[pyfunction]
fn x_or_y(x: Option&lt;u64&gt;, y: u64) -&gt; u64 {
    x.unwrap_or(y)
}</code></pre>
<p>ä¿®æ”¹åï¼š</p>
<pre><code class="language-rust no_run"><span class="boring">#![allow(dead_code)]
</span><span class="boring">use pyo3::prelude::*;
</span>

#[pyfunction]
#[pyo3(signature = (x, y))] // x å’Œ y éƒ½æ²¡æœ‰é»˜è®¤å€¼ï¼Œå‡ä¸ºå¿…éœ€å‚æ•°
fn x_or_y(x: Option&lt;u64&gt;, y: u64) -&gt; u64 {
    x.unwrap_or(y)
}</code></pre>
</details>
<h3 id="ç§»é™¤å·²å¼ƒç”¨çš„å‡½æ•°å½¢å¼"><a class="header" href="#ç§»é™¤å·²å¼ƒç”¨çš„å‡½æ•°å½¢å¼">ç§»é™¤å·²å¼ƒç”¨çš„å‡½æ•°å½¢å¼</a></h3>
<details>
<summary><small>ç‚¹å‡»å±•å¼€</small></summary>
<p>åœ¨ PyO3 0.18 ä¸­ï¼Œ<code>#[pymethods]</code> çš„ <code>#[args]</code> å±æ€§ä»¥åŠç›´æ¥åœ¨ <code>#[pyfunction]</code> ä¸­æŒ‡å®šå‡½æ•°ç­¾åçš„æ–¹å¼å·²è¢«å¼ƒç”¨ã€‚è¯¥åŠŸèƒ½å·²åœ¨ PyO3 0.20 ä¸­ç§»é™¤ã€‚</p>
<p>ä¿®æ”¹å‰ï¼š</p>
<pre><code class="language-rust ignore">#[pyfunction]
#[pyo3(a, b = "0", "/")]
fn add(a: u64, b: u64) -&gt; u64 {
    a + b
}</code></pre>
<p>ä¿®æ”¹åï¼š</p>
<pre><code class="language-rust no_run"><span class="boring">#![allow(dead_code)]
</span><span class="boring">use pyo3::prelude::*;
</span>

#[pyfunction]
#[pyo3(signature = (a, b=0, /))]
fn add(a: u64, b: u64) -&gt; u64 {
    a + b
}</code></pre>
</details>
<h3 id="ç§»é™¤-intopypointer-trait"><a class="header" href="#ç§»é™¤-intopypointer-trait">ç§»é™¤ <code>IntoPyPointer</code> trait</a></h3>
<details>
<summary><small>ç‚¹å‡»å±•å¼€</small></summary>
<p>æä¾› <code>into_ptr</code> æ–¹æ³•çš„ trait <code>IntoPyPointer</code> å·²è¢«ç§»é™¤ã€‚<code>into_ptr</code> ç°åœ¨ä½œä¸ºå›ºæœ‰æ–¹æ³•ç›´æ¥å­˜åœ¨äºæ­¤å‰å®ç°è¯¥ trait çš„æ‰€æœ‰ç±»å‹ä¸Šã€‚</p>
</details>
<h3 id="aspypointer-ç°åœ¨ä¸º-unsafe-trait"><a class="header" href="#aspypointer-ç°åœ¨ä¸º-unsafe-trait"><code>AsPyPointer</code> ç°åœ¨ä¸º <code>unsafe</code> trait</a></h3>
<details>
<summary><small>ç‚¹å‡»å±•å¼€</small></summary>
<p>trait <code>AsPyPointer</code> ç°åœ¨è¢«æ ‡è®°ä¸º <code>unsafe trait</code>ï¼Œæ„å‘³ç€ä»»ä½•å¤–éƒ¨å®ç°éƒ½å¿…é¡»ä½¿ç”¨ <code>unsafe impl</code> æ ‡è®°ï¼Œå¹¶ç¡®ä¿å§‹ç»ˆè¿”å›æœ‰æ•ˆçš„æŒ‡é’ˆã€‚</p>
</details>
<h2 id="ä»-018-å‡çº§åˆ°-019"><a class="header" href="#ä»-018-å‡çº§åˆ°-019">ä» 0.18.* å‡çº§åˆ° 0.19</a></h2>
<h3 id="ç°åœ¨ç¦æ­¢åœ¨-__traverse__-å®ç°ä¸­è®¿é—®-python"><a class="header" href="#ç°åœ¨ç¦æ­¢åœ¨-__traverse__-å®ç°ä¸­è®¿é—®-python">ç°åœ¨ç¦æ­¢åœ¨ <code>__traverse__</code> å®ç°ä¸­è®¿é—® <code>Python</code></a></h3>
<details>
<summary><small>ç‚¹å‡»å±•å¼€</small></summary>
<p>åœ¨ Python åƒåœ¾å›æ”¶çš„ <code>__traverse__</code> å®ç°è¿‡ç¨‹ä¸­ï¼Œä»…å…è®¸éå† <code>#[pyclass]</code> çš„æˆå‘˜ï¼Œå…¶ä»–ä»»ä½•æ“ä½œå‡è¢«ç¦æ­¢ã€‚è¿™æ„å‘³ç€ä¸å…è®¸è°ƒç”¨ Python å‡½æ•°æˆ–å…¶ä»– APIã€‚</p>
<p>æ—©æœŸç‰ˆæœ¬çš„ PyO3 å…è®¸è®¿é—® <code>Python</code>ï¼ˆä¾‹å¦‚é€šè¿‡ <code>Python::with_gil</code>ï¼‰ï¼Œè¿™å¯èƒ½å¯¼è‡´ Python è§£é‡Šå™¨å´©æºƒæˆ–å¹²æ‰°åƒåœ¾å›æ”¶ç®—æ³•ã€‚</p>
<p>ç°åœ¨ï¼Œå°è¯•è·å– GIL å°†è§¦å‘ panicã€‚è¯¦æƒ…è¯·è§ <a href="https://github.com/PyO3/pyo3/issues/3165">#3165</a>ã€‚</p>
<pre><code class="language-rust ignore"><span class="boring">use pyo3::prelude::*;
</span>

#[pyclass]
struct SomeClass {}


impl SomeClass {
    fn __traverse__(&amp;self, pyo3::class::gc::PyVisit&lt;'_&gt;) -&gt; Result&lt;(), pyo3::class::gc::PyTraverseError&gt;` {
        Python::with_gil(|| { /*...*/ })  // é”™è¯¯ï¼šæ­¤å¤„å°† panic
    }
}</code></pre>
</details>
<h3 id="å½“å†…éƒ¨é”™è¯¯ä¸ºç®€å•-pyerr-æ—¶anyhowerror--eyrereport-è½¬æ¢æ›´æ™ºèƒ½"><a class="header" href="#å½“å†…éƒ¨é”™è¯¯ä¸ºç®€å•-pyerr-æ—¶anyhowerror--eyrereport-è½¬æ¢æ›´æ™ºèƒ½">å½“å†…éƒ¨é”™è¯¯ä¸ºâ€œç®€å•â€ <code>PyErr</code> æ—¶ï¼Œ<code>anyhow::Error</code> / <code>eyre::Report</code> è½¬æ¢æ›´æ™ºèƒ½</a></h3>
<details>
<summary><small>ç‚¹å‡»å±•å¼€</small></summary>
<p>å½“ä» <code>anyhow::Error</code> æˆ– <code>eyre::Report</code> è½¬æ¢ä¸º <code>PyErr</code> æ—¶ï¼Œå¦‚æœå†…éƒ¨é”™è¯¯æ˜¯ä¸€ä¸ªâ€œç®€å•â€çš„ <code>PyErr</code>ï¼ˆå³æ²¡æœ‰æºé”™è¯¯ï¼‰ï¼Œåˆ™è¯¥å†…éƒ¨é”™è¯¯å°†ç›´æ¥ç”¨ä½œ <code>PyErr</code>ï¼Œè€Œä¸æ˜¯å°†å…¶åŒ…è£…åœ¨ä¸€ä¸ªæ–°çš„ <code>PyRuntimeError</code> ä¸­å¹¶å°†åŸä¿¡æ¯è½¬ä¸ºå­—ç¬¦ä¸²ã€‚</p>
<pre><code class="language-rust ignore"><span class="boring">#[cfg(feature = "anyhow")]
</span><span class="boring">#[allow(dead_code)]
</span><span class="boring">mod anyhow_only {
</span><span class="boring">use pyo3::prelude::*;
</span><span class="boring">use pyo3::exceptions::PyValueError;
</span>#[pyfunction]
fn raise_err() -&gt; anyhow::Result&lt;()&gt; {
    Err(PyValueError::new_err("original error message").into())
}


fn main() {
    Python::with_gil(|py| {
        let rs_func = wrap_pyfunction!(raise_err, py).unwrap();
        pyo3::py_run!(
            py,
            rs_func,
            r"
        try:
            rs_func()
        except Exception as e:
            print(repr(e))
        "
        );
    })
}
<span class="boring">}</span></code></pre>
<p>æ­¤å‰ï¼Œä¸Šè¿°ä»£ç ä¼šè¾“å‡º <code>RuntimeError('ValueError: original error message')</code>ï¼Œè¿™å¯èƒ½ä¼šä»¤äººå›°æƒ‘ã€‚</p>
<p>ç°åœ¨ï¼ŒåŒæ ·çš„ä»£ç å°†è¾“å‡º <code>ValueError: original error message</code>ï¼Œæ›´åŠ ç›´è§‚ã€‚</p>
<p>ç„¶è€Œï¼Œå¦‚æœ <code>anyhow::Error</code> æˆ– <code>eyre::Report</code> åŒ…å«æºé”™è¯¯ï¼Œåˆ™åŸå§‹å¼‚å¸¸ä»å°†è¢«åŒ…è£…åœ¨ <code>PyRuntimeError</code> ä¸­ã€‚</p>
</details>
<h3 id="å·²ç§»é™¤å¼ƒç”¨çš„-pythonacquire_gilå¿…é¡»æ”¹ç”¨-pythonwith_gil"><a class="header" href="#å·²ç§»é™¤å¼ƒç”¨çš„-pythonacquire_gilå¿…é¡»æ”¹ç”¨-pythonwith_gil">å·²ç§»é™¤å¼ƒç”¨çš„ <code>Python::acquire_gil</code>ï¼Œå¿…é¡»æ”¹ç”¨ <code>Python::with_gil</code></a></h3>
<details>
<summary><small>ç‚¹å‡»å±•å¼€</small></summary>
<p>è™½ç„¶ <a href="https://docs.rs/pyo3/0.18.3/pyo3/marker/struct.Python.html#method.acquire_gil"><code>Python::acquire_gil</code></a> æä¾›çš„ API çœ‹ä¼¼æ–¹ä¾¿ï¼Œä½†å®ƒå­˜åœ¨ä¸€å®šçš„è„†å¼±æ€§ï¼Œå› ä¸º <a href="https://docs.rs/pyo3/0.18.3/pyo3/marker/struct.Python.html"><code>Python</code></a> token çš„è®¾è®¡ä¾èµ–äºæ­£ç¡®çš„åµŒå¥—ç»“æ„ï¼Œè‹¥ä½¿ç”¨ä¸å½“ä¼šå¯¼è‡´ panicï¼Œä¾‹å¦‚ï¼š</p>
<pre><code class="language-rust ignore"><span class="boring">#![allow(dead_code, deprecated)]
</span><span class="boring">use pyo3::prelude::*;
</span>

#[pyclass]
struct SomeClass {}


struct ObjectAndGuard {
    object: Py&lt;SomeClass&gt;,
    guard: GILGuard,
}


impl ObjectAndGuard {
    fn new() -&gt; Self {
        let guard = Python::acquire_gil();
        let object = Py::new(guard.python(), SomeClass {}).unwrap();


        Self { object, guard }
    }
}


let first = ObjectAndGuard::new();
let second = ObjectAndGuard::new();
// ç”±äº `second` å†…éƒ¨çš„ guard ä»å­˜æ´»ï¼Œæ­¤å¤„ä¼š panic
drop(first);
drop(second);</code></pre>
<p>æ›¿ä»£æ–¹æ¡ˆæ˜¯ <a href="https://docs.rs/pyo3/0.18.3/pyo3/marker/struct.Python.html#method.with_gil"><code>Python::with_gil</code></a>ï¼Œè™½ç„¶ç”¨èµ·æ¥æ›´ç¹çï¼Œä½†å…¶è®¾è®¡ä¸Šå¼ºåˆ¶äº†æ­£ç¡®çš„åµŒå¥—ç»“æ„ï¼Œä¾‹å¦‚ï¼š</p>
<pre><code class="language-rust ignore"><span class="boring">#![allow(dead_code)]
</span><span class="boring">use pyo3::prelude::*;
</span>

#[pyclass]
struct SomeClass {}


struct Object {
    object: Py&lt;SomeClass&gt;,
}


impl Object {
    fn new(py: Python&lt;'_&gt;) -&gt; Self {
        let object = Py::new(py, SomeClass {}).unwrap();


        Self { object }
    }
}


// è¦ä¹ˆå¼ºåˆ¶æˆ‘ä»¬åœ¨å†æ¬¡è·å– GIL å‰é‡Šæ”¾å®ƒ
let first = Python::with_gil(|py| Object::new(py));
let second = Python::with_gil(|py| Object::new(py));
drop(first);
drop(second);


// è¦ä¹ˆç¡®ä¿å†…éƒ¨é”åœ¨å¤–éƒ¨é”ä¹‹å‰é‡Šæ”¾
Python::with_gil(|py| {
    let first = Object::new(py);
    let second = Python::with_gil(|py| Object::new(py));
    drop(first);
    drop(second);
});</code></pre>
<p>æ­¤å¤–ï¼Œ<code>Python::acquire_gil</code> æä¾›å¯¹ <code>GILGuard</code> çš„æ‰€æœ‰æƒï¼Œè¯¥å¯¹è±¡å¯è¢«è‡ªç”±å­˜å‚¨å’Œä¼ é€’ã€‚è¿™é€šå¸¸å¹¶æ— å¸®åŠ©ï¼Œåè€Œå¯èƒ½å¯¼è‡´é”é•¿æœŸæŒæœ‰ï¼Œé˜»å¡ç¨‹åºå…¶ä»–éƒ¨åˆ†çš„æ‰§è¡Œã€‚è€Œ <code>Python::with_gil</code> æä¾›çš„ Python token å…·æœ‰ç”Ÿæˆæ€§ç”Ÿå‘½å‘¨æœŸï¼ˆgenerative lifetimeï¼‰ï¼Œåªèƒ½å‘ä¸‹ä¼ é€’è°ƒç”¨é“¾ï¼Œä»è€Œé¿å…äº†è¯¥é—®é¢˜ã€‚é€šå¸¸ï¼Œä»»ä½• GIL ç»‘å®šçš„å¼•ç”¨ <code>&amp;'py PyAny</code> ä¹Ÿå¯é€šè¿‡ <a href="https://docs.rs/pyo3/0.22.5/pyo3/types/struct.PyAny.html#method.py"><code>PyAny::py</code></a> æ–¹æ³•è·å¾— <code>Python&lt;'py&gt;</code> tokenï¼Œä»è€Œå®Œå…¨é¿å…æ­¤ç±»é—®é¢˜ã€‚</p>
</details>
<h2 id="ä»-017-å‡çº§åˆ°-018"><a class="header" href="#ä»-017-å‡çº§åˆ°-018">ä» 0.17.* å‡çº§åˆ° 0.18</a></h2>
<h3 id="option_-å‚æ•°ä¹‹åçš„å¿…éœ€å‚æ•°å°†ä¸å†è‡ªåŠ¨æ¨æ–­"><a class="header" href="#option_-å‚æ•°ä¹‹åçš„å¿…éœ€å‚æ•°å°†ä¸å†è‡ªåŠ¨æ¨æ–­"><code>Option&lt;_&gt;</code> å‚æ•°ä¹‹åçš„å¿…éœ€å‚æ•°å°†ä¸å†è‡ªåŠ¨æ¨æ–­</a></h3>
<details>
<summary><small>ç‚¹å‡»å±•å¼€</small></summary>
<p>åœ¨ <code>#[pyfunction]</code> å’Œ <code>#[pymethods]</code> ä¸­ï¼Œå¦‚æœåƒ <code>i32</code> è¿™æ ·çš„â€œå¿…éœ€â€å‡½æ•°å‚æ•°å‡ºç°åœ¨ <code>Option&lt;_&gt;</code> å‚æ•°ä¹‹åï¼Œåˆ™è¯¥ <code>Option&lt;_&gt;</code> ä¼šéšå¼åœ°è¢«è§†ä¸ºå¿…éœ€å‚æ•°ï¼ˆæ‰€æœ‰å°¾éšçš„ <code>Option&lt;_&gt;</code> å‚æ•°åŸæœ¬è¢«è§†ä¸ºå¯é€‰ï¼Œå…·æœ‰ <code>None</code> çš„é»˜è®¤å€¼ï¼‰ã€‚</p>
<p>ä» PyO3 0.18 å¼€å§‹ï¼Œæ­¤è¡Œä¸ºå·²è¢«å¼ƒç”¨ï¼Œæœªæ¥ç‰ˆæœ¬å°†è¦æ±‚ä½¿ç”¨ <a href="./function/signature.html"><code>#[pyo3(signature = (...))]</code> é€‰é¡¹</a> æ˜¾å¼å£°æ˜å¼€å‘è€…çš„æ„å›¾ã€‚</p>
<p>æ­¤å‰ï¼Œåœ¨ä»¥ä¸‹ç¤ºä¾‹ä¸­ï¼Œx å¿…é¡»ç”± Python ä»£ç æ˜¾å¼ä¼ å…¥ï¼š</p>
<pre><code class="language-rust compile_fail ignore"><span class="boring">#![allow(dead_code)]
</span><span class="boring">use pyo3::prelude::*;
</span>

#[pyfunction]
fn required_argument_after_option(x: Option&lt;i32&gt;, y: i32) {}</code></pre>
<p>ä¿®æ”¹åï¼Œéœ€æ˜¾å¼æŒ‡å®šé¢„æœŸçš„ Python ç­¾åï¼š</p>
<pre><code class="language-rust no_run"><span class="boring">#![allow(dead_code)]
</span><span class="boring">use pyo3::prelude::*;
</span>

// å¦‚æœ x ç¡®å®åº”ä¸ºå¿…éœ€å‚æ•°
#[pyfunction(signature = (x, y))]
fn required_argument_after_option_a(x: Option&lt;i32&gt;, y: i32) {}


// å¦‚æœ x åº”ä¸ºå¯é€‰å‚æ•°ï¼Œåˆ™ y ä¹Ÿéœ€æœ‰é»˜è®¤å€¼
#[pyfunction(signature = (x=None, y=0))]
fn required_argument_after_option_b(x: Option&lt;i32&gt;, y: i32) {}</code></pre>
</details>
<h3 id="__text_signature__-ç°åœ¨ä¼šä¸º-pyfunction-å’Œ-pymethods-è‡ªåŠ¨ç”Ÿæˆ"><a class="header" href="#__text_signature__-ç°åœ¨ä¼šä¸º-pyfunction-å’Œ-pymethods-è‡ªåŠ¨ç”Ÿæˆ"><code>__text_signature__</code> ç°åœ¨ä¼šä¸º <code>#[pyfunction]</code> å’Œ <code>#[pymethods]</code> è‡ªåŠ¨ç”Ÿæˆ</a></h3>
<details>
<summary><small>ç‚¹å‡»å±•å¼€</small></summary>
<p>è¿‡å»ï¼Œå”¯ä¸€æ”¯æŒè®¾ç½®ç”Ÿæˆ Python å‡½æ•°çš„ <code>__text_signature__</code> å±æ€§çš„æ–¹å¼æ˜¯ <a href="./function/signature.html#making-the-function-signature-available-to-python"><code>#[pyo3(text_signature = "...")]</code> é€‰é¡¹</a>ã€‚</p>
<p>ç°åœ¨ï¼ŒPyO3 èƒ½å¤ŸåŸºäºå‡½æ•°çš„ Rust ç­¾åï¼ˆæˆ–æ–°çš„ <a href="./function/signature.html"><code>#[pyo3(signature = (...))]</code> é€‰é¡¹</a>ï¼‰è‡ªåŠ¨ä¸ºæ‰€æœ‰å‡½æ•°å¡«å…… <code>__text_signature__</code>ã€‚è¿™äº›è‡ªåŠ¨ç”Ÿæˆçš„ <code>__text_signature__</code> å€¼å½“å‰å¯¹äºæ‰€æœ‰é»˜è®¤å€¼ç»Ÿä¸€æ˜¾ç¤ºä¸º <code>...</code>ã€‚åœ¨å‡çº§åˆ° PyO3 0.18 æ—¶ï¼Œè®¸å¤š <code>#[pyo3(text_signature = "...")]</code> é€‰é¡¹å¯ä»¥è¢«åˆ é™¤ã€‚ä½†ç›®å‰ï¼Œå¯¹äºåŒ…å«é»˜è®¤å€¼çš„å‡½æ•°ï¼Œæ‰‹åŠ¨å®ç°å¯èƒ½ä»æ›´å—é’çã€‚</p>
<p>ä¾‹å¦‚ï¼š</p>
<pre><code class="language-rust"><span class="boring">use pyo3::prelude::*;
</span>

// æ­¤å¤„çš„ `text_signature` é€‰é¡¹å·²ä¸å†å¿…è¦ï¼Œå› ä¸º PyO3 ä¼šè‡ªåŠ¨ç”Ÿæˆå®Œå…¨ç›¸åŒçš„å€¼ã€‚
#[pyfunction(text_signature = "(a, b, c)")]
fn simple_function(a: i32, b: i32, c: i32) {}


// åœ¨ PyO3 0.18 ä¸­ï¼Œæ­¤å¤„ `text_signature` ä»æœ‰ä»·å€¼ï¼Œå› ä¸ºè‡ªåŠ¨ç”Ÿæˆçš„ç­¾åä¼šæ˜¯ "(a, b=..., c=...)"ã€‚
#[pyfunction(signature = (a, b = 1, c = 2), text_signature = "(a, b=1, c=2)")]
fn function_with_defaults(a: i32, b: i32, c: i32) {}


<span class="boring">fn main() {
</span><span class="boring">    Python::attach(|py| {
</span><span class="boring">        let simple = wrap_pyfunction!(simple_function, py).unwrap();
</span><span class="boring">        assert_eq!(simple.getattr("__text_signature__").unwrap().to_string(), "(a, b, c)");
</span><span class="boring">        let defaulted = wrap_pyfunction!(function_with_defaults, py).unwrap();
</span><span class="boring">        assert_eq!(defaulted.getattr("__text_signature__").unwrap().to_string(), "(a, b=1, c=2)");
</span><span class="boring">    })
</span><span class="boring">}
</span>```&lt;/details&gt;

# ä» 0.16.* å‡çº§åˆ° 0.17

## `PyMapping` å’Œ `PySequence` ç±»å‹çš„ç±»å‹æ£€æŸ¥å·²æ›´æ”¹

&lt;details&gt;
&lt;summary&gt;&lt;small&gt;ç‚¹å‡»å±•å¼€&lt;/small&gt;&lt;/summary&gt;

æ­¤å‰ï¼Œ`PyMapping` å’Œ `PySequence` çš„ç±»å‹æ£€æŸ¥ï¼ˆåœ¨ `PyTryFrom` ä¸­å®ç°ï¼‰ä½¿ç”¨çš„æ˜¯ Python C-API å‡½æ•° `PyMapping_Check` å’Œ `PySequence_Check`ã€‚é—æ†¾çš„æ˜¯ï¼Œè¿™äº›å‡½æ•°ä¸è¶³ä»¥å‡†ç¡®åŒºåˆ†è¿™äº›ç±»å‹ï¼Œå¯¼è‡´è¡Œä¸ºä¸ä¸€è‡´ï¼ˆå‚è§ [pyo3/pyo3#2072](https://github.com/PyO3/pyo3/issues/2072)ï¼‰ã€‚

PyO3 0.17 å°†è¿™äº›å‘ä¸‹è½¬å‹æ£€æŸ¥æ›´æ”¹ä¸ºæ˜¾å¼æµ‹è¯•ç±»å‹æ˜¯å¦ä¸ºå¯¹åº”çš„æŠ½è±¡åŸºç±» `collections.abc.Mapping` æˆ– `collections.abc.Sequence` çš„å­ç±»ã€‚è¯·æ³¨æ„ï¼Œè¿™éœ€è¦è°ƒç”¨ Python è¿è¡Œæ—¶ï¼Œå› æ­¤ç›¸æ¯”ä¹‹å‰çš„æ–¹æ³•å¯èƒ½ä¼šå¸¦æ¥æ€§èƒ½å¼€é”€ã€‚å¦‚æœæ€§èƒ½æŸå¤±æˆä¸ºä¸€ä¸ªé—®é¢˜ï¼Œä½ å¯ä»¥è‡ªè¡Œæ‰§è¡Œæ£€æŸ¥ï¼Œå¹¶ä½¿ç”¨ `try_from_unchecked`ï¼ˆä¸å®‰å…¨æ–¹æ³•ï¼‰ã€‚

å¦ä¸€ä¸ªå‰¯ä½œç”¨æ˜¯ï¼Œåœ¨ Rust ä¸­ä½¿ç”¨ PyO3 å®šä¹‰çš„ pyclass å¿…é¡»è¢«**æ³¨å†Œ**åˆ°å¯¹åº”çš„ Python æŠ½è±¡åŸºç±»ï¼Œå‘ä¸‹è½¬å‹æ‰èƒ½æˆåŠŸã€‚ä¸ºæ­¤æ–°å¢äº† `PySequence::register` å’Œ `PyMapping::register` æ–¹æ³•ï¼Œä¾¿äºä» Rust ä»£ç ä¸­å®Œæˆæ³¨å†Œã€‚å®ƒä»¬ç­‰ä»·äºåœ¨ Python ä¸­è°ƒç”¨ `collections.abc.Mapping.register(MappingPyClass)` æˆ– `collections.abc.Sequence.register(SequencePyClass)`ã€‚

ä¾‹å¦‚ï¼Œå¯¹äºä¸€ä¸ªåœ¨ Rust ä¸­å®šä¹‰çš„æ˜ å°„ç±»ï¼š

```rust,compile_fail
use pyo3::prelude::*;
use std::collections::HashMap;

#[pyclass(mapping)]
struct Mapping {
    index: HashMap&lt;String, usize&gt;,
}

#[pymethods]
impl Mapping {
    #[new]
    fn new(elements: Option&lt;&amp;PyList&gt;) -&gt; PyResult&lt;Self&gt; {
    // ...
    // æ­¤æ˜ å°„ pyclass çš„å®ç°è¢«æˆªæ–­ â€”â€” åŸºæœ¬ä¸Šæ˜¯ HashMap çš„å°è£…
}</code></pre>
<p>ä½ å¿…é¡»åœ¨å‘ä¸‹è½¬å‹ç”Ÿæ•ˆå‰å°†ç±»æ³¨å†Œåˆ° <code>collections.abc.Mapping</code>ï¼š</p>
<pre><code class="language-rust compile_fail">let m = Py::new(py, Mapping { index }).unwrap();
assert!(m.as_ref(py).downcast::&lt;PyMapping&gt;().is_err());
PyMapping::register::&lt;Mapping&gt;(py).unwrap();
assert!(m.as_ref(py).downcast::&lt;PyMapping&gt;().is_ok());</code></pre>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæœªæ¥å½“ pyclass èƒ½å¤Ÿç›´æ¥ç»§æ‰¿æŠ½è±¡åŸºç±»æ—¶ï¼Œè¿™ä¸€è¦æ±‚å¯èƒ½ä¼šè¢«ç§»é™¤ï¼ˆå‚è§ <a href="https://github.com/PyO3/pyo3/issues/991">pyo3/pyo3#991</a>ï¼‰ã€‚</p>
</details>
<h3 id="multiple-pymethods-åŠŸèƒ½ç°åœ¨éœ€è¦-rust-162"><a class="header" href="#multiple-pymethods-åŠŸèƒ½ç°åœ¨éœ€è¦-rust-162"><code>multiple-pymethods</code> åŠŸèƒ½ç°åœ¨éœ€è¦ Rust 1.62</a></h3>
<details>
<summary><small>ç‚¹å‡»å±•å¼€</small></summary>
<p>ç”±äº <code>multiple-pymethods</code> åŠŸèƒ½æ‰€ä¾èµ–çš„ <code>inventory</code> crate å­˜åœ¨é™åˆ¶ï¼Œè¯¥åŠŸèƒ½ç°åœ¨éœ€è¦ Rust 1.62ã€‚æ›´å¤šä¿¡æ¯è¯·å‚è§ <a href="https://github.com/dtolnay/inventory/issues/32">dtolnay/inventory#32</a>ã€‚</p>
</details>
<h3 id="æ–°å¢-impl-intopypypystring-for-str"><a class="header" href="#æ–°å¢-impl-intopypypystring-for-str">æ–°å¢ <code>impl IntoPy&lt;Py&lt;PyString&gt;&gt; for &amp;str</code></a></h3>
<details>
<summary><small>ç‚¹å‡»å±•å¼€</small></summary>
<p>è¿™å¯èƒ½ä¼šå¯¼è‡´ç±»å‹æ¨æ–­é”™è¯¯ã€‚</p>
<p>ä»¥å‰ï¼š</p>
<pre><code class="language-rust compile_fail"><span class="boring">use pyo3::prelude::*;
</span><span class="boring">
</span><span class="boring">fn main() {
</span>Python::with_gil(|py| {
    // æ— æ³•æ¨æ–­æ˜¯ `Py&lt;PyAny&gt;` è¿˜æ˜¯ `Py&lt;PyString&gt;`
    let _test = "test".into_py(py);
});
<span class="boring">}</span></code></pre>
<p>å‡çº§åï¼Œå¯èƒ½éœ€è¦æ·»åŠ ç±»å‹æ³¨è§£ï¼š</p>
<pre><code class="language-rust ignore"><span class="boring">#![allow(deprecated)]
</span><span class="boring">use pyo3::prelude::*;
</span><span class="boring">
</span><span class="boring">fn main() {
</span>Python::with_gil(|py| {
    let _test: Py&lt;PyAny&gt; = "test".into_py(py);
});
<span class="boring">}</span></code></pre>
</details>
<h3 id="pyproto-åŠŸèƒ½ç°åœ¨é»˜è®¤ç¦ç”¨"><a class="header" href="#pyproto-åŠŸèƒ½ç°åœ¨é»˜è®¤ç¦ç”¨"><code>pyproto</code> åŠŸèƒ½ç°åœ¨é»˜è®¤ç¦ç”¨</a></h3>
<details>
<summary><small>ç‚¹å‡»å±•å¼€</small></summary>
<p>ä¸ºå°†æ¥ç§»é™¤å·²åºŸå¼ƒçš„ <code>#[pyproto]</code> å±æ€§å®åšå‡†å¤‡ï¼Œè¯¥åŠŸèƒ½ç°åœ¨é»˜è®¤å…³é—­ï¼Œéœ€é€šè¿‡æ‰‹åŠ¨å¯ç”¨åŠŸèƒ½æ ‡å¿—æ¥å¼€å¯ã€‚è¿™ä¹Ÿä¸ºä¸ä½¿ç”¨è¯¥åºŸå¼ƒå®çš„ä»£ç å¸¦æ¥è½»å¾®çš„ç¼–è¯‘æ—¶é—´ä¼˜åŒ–ã€‚</p>
</details>
<h3 id="pytypeobject-trait-å·²è¢«åºŸå¼ƒ"><a class="header" href="#pytypeobject-trait-å·²è¢«åºŸå¼ƒ"><code>PyTypeObject</code> trait å·²è¢«åºŸå¼ƒ</a></h3>
<details>
<summary><small>ç‚¹å‡»å±•å¼€</small></summary>
<p><code>PyTypeObject</code> trait æ­¤å‰å‡ ä¹æ— ç”¨ï¼›å‡ ä¹æ‰€æœ‰åŠŸèƒ½æ—©å·²å­˜åœ¨äº <code>PyTypeInfo</code> trait ä¸Šï¼Œè€Œ <code>PyTypeObject</code> å¯¹å…¶ä»…æœ‰ç©ºç™½å®ç°ã€‚åœ¨ PyO3 0.17 ä¸­ï¼Œæœ€åä¸€ä¸ªæ–¹æ³• <code>PyTypeObject::type_object</code> å·²è¿ç§»åˆ° <code>PyTypeInfo::type_object</code>ã€‚</p>
<p>è¿ç§»æ–¹å¼æ˜¯å°† trait è¾¹ç•Œå’Œå¯¼å…¥ä» <code>PyTypeObject</code> æ”¹ä¸º <code>PyTypeInfo</code>ã€‚</p>
<p>ä¹‹å‰ï¼š</p>
<pre><code class="language-rust ignore">use pyo3::Python;
use pyo3::type_object::PyTypeObject;
use pyo3::types::PyType;

fn get_type_object&lt;T: PyTypeObject&gt;(py: Python&lt;'_&gt;) -&gt; &amp;PyType {
    T::type_object(py)
}</code></pre>
<p>ä¹‹åï¼š</p>
<pre><code class="language-rust ignore">use pyo3::{Python, PyTypeInfo};
use pyo3::types::PyType;

fn get_type_object&lt;T: PyTypeInfo&gt;(py: Python&lt;'_&gt;) -&gt; &amp;PyType {
    T::type_object(py)
}

<span class="boring">Python::with_gil(|py| { get_type_object::&lt;pyo3::types::PyList&gt;(py); });</span></code></pre>
</details>
<h3 id="implt-const-n-usize-intopypyobject-for-t-n-ç°åœ¨è¦æ±‚-t-intopy-è€Œé-t-topyobject"><a class="header" href="#implt-const-n-usize-intopypyobject-for-t-n-ç°åœ¨è¦æ±‚-t-intopy-è€Œé-t-topyobject"><code>impl&lt;T, const N: usize&gt; IntoPy&lt;PyObject&gt; for [T; N]</code> ç°åœ¨è¦æ±‚ <code>T: IntoPy</code> è€Œé <code>T: ToPyObject</code></a></h3>
<details>
<summary><small>ç‚¹å‡»å±•å¼€</small></summary>
<p>å¦‚æœè¿™å¼•å‘é”™è¯¯ï¼Œåªéœ€ä¸º <code>T</code> å®ç° <code>IntoPy</code> å³å¯ã€‚ç”±äº pyclass å·²ç»å®ç°äº† <code>IntoPy</code>ï¼Œä½ å¯èƒ½æ— éœ€æ‹…å¿ƒè¿™ä¸€ç‚¹ã€‚</p>
</details>
<h3 id="æ¯ä¸ª-pymodule-ç°åœ¨æ¯ä¸ªè¿›ç¨‹ä¸­åªèƒ½åˆå§‹åŒ–ä¸€æ¬¡"><a class="header" href="#æ¯ä¸ª-pymodule-ç°åœ¨æ¯ä¸ªè¿›ç¨‹ä¸­åªèƒ½åˆå§‹åŒ–ä¸€æ¬¡">æ¯ä¸ª <code>#[pymodule]</code> ç°åœ¨æ¯ä¸ªè¿›ç¨‹ä¸­åªèƒ½åˆå§‹åŒ–ä¸€æ¬¡</a></h3>
<details>
<summary><small>ç‚¹å‡»å±•å¼€</small></summary>
<p>ä¸ºäº†è®© PyO3 æ¨¡å—åœ¨å­˜åœ¨ Python å­è§£é‡Šå™¨æ—¶ä¿æŒå®‰å…¨ï¼Œç›®å‰å¿…é¡»æ˜ç¡®ç¦ç”¨åŒä¸€è¿›ç¨‹å†…å¤šæ¬¡åˆå§‹åŒ– <code>#[pymodule]</code> çš„èƒ½åŠ›ã€‚å°è¯•é‡å¤åˆå§‹åŒ–ç°åœ¨ä¼šæŠ›å‡º <code>ImportError</code>ã€‚</p>
</details>
<h2 id="ä»-015-å‡çº§åˆ°-016"><a class="header" href="#ä»-015-å‡çº§åˆ°-016">ä» 0.15.* å‡çº§åˆ° 0.16</a></h2>
<!-- rumdl-disable MD024 - same heading used above -->
<h3 id="æ”¾å¼ƒå¯¹æ—§æŠ€æœ¯çš„æ”¯æŒ"><a class="header" href="#æ”¾å¼ƒå¯¹æ—§æŠ€æœ¯çš„æ”¯æŒ">æ”¾å¼ƒå¯¹æ—§æŠ€æœ¯çš„æ”¯æŒ</a></h3>
<!-- rumdl-enable MD024 -->
<details>
<summary><small>ç‚¹å‡»å±•å¼€</small></summary>
<p>PyO3 0.16 å°†æœ€ä½ Rust ç‰ˆæœ¬æå‡è‡³ 1.48ï¼Œæœ€ä½ Python ç‰ˆæœ¬æå‡è‡³ 3.7ã€‚è¿™ä½¿å¾—é¡¹ç›®å¯ä»¥ä½¿ç”¨æ›´æ–°çš„è¯­è¨€ç‰¹æ€§ï¼ˆæ”¯æŒ 0.16 ä¸­çš„å…¶ä»–æ–°å¢åŠŸèƒ½ï¼‰ï¼Œå¹¶ç®€åŒ–äº†ç»´æŠ¤å·¥ä½œã€‚</p>
</details>
<h3 id="pyproto-å·²è¢«åºŸå¼ƒ"><a class="header" href="#pyproto-å·²è¢«åºŸå¼ƒ"><code>#[pyproto]</code> å·²è¢«åºŸå¼ƒ</a></h3>
<details>
<summary><small>ç‚¹å‡»å±•å¼€</small></summary>
<p>åœ¨ PyO3 0.15 ä¸­ï¼Œ<code>#[pymethods]</code> å±æ€§å®å¢åŠ äº†å¯¹å®ç°â€œé­”æ³•æ–¹æ³•â€ï¼ˆå¦‚ <code>__str__</code>ï¼Œåˆç§°â€œåŒä¸‹åˆ’çº¿æ–¹æ³•â€ï¼‰çš„æ”¯æŒã€‚å½“æ—¶è¯¥å®ç°å°šæœªå®Œå…¨å®šå‹ï¼Œä»æœ‰ä¸€äº›è¾¹ç•Œæƒ…å†µå¾…å†³å®šï¼Œå› æ­¤ä¿ç•™äº†åŸæœ‰çš„ <code>#[pyproto]</code> å±æ€§å®ä»¥è¦†ç›–è¿™äº›æƒ…å†µã€‚</p>
<p>åœ¨ PyO3 0.16 ä¸­ï¼Œ<code>#[pymethods]</code> çš„å®ç°å·²ç»å®Œæˆï¼Œç°å·²æˆä¸ºå®ç°é­”æ³•æ–¹æ³•çš„æ¨èæ–¹å¼ã€‚ä¸ºäº†è®© PyO3 é¡¹ç›®æŒç»­å‘å±•ï¼Œ<code>#[pyproto]</code> å·²è¢«åºŸå¼ƒï¼ˆé¢„è®¡åœ¨ PyO3 0.18 ä¸­ç§»é™¤ï¼‰ã€‚</p>
<p>ä» <code>#[pyproto]</code> è¿ç§»åˆ° <code>#[pymethods]</code> å¾ˆç®€å•ï¼›åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œåªéœ€å°†åŸæœ‰æ–¹æ³•ä» <code>#[pyproto]</code> trait å®ç°ä¸­ç›´æ¥å¤åˆ¶åˆ° <code>#[pymethods]</code> å—ä¸­å³å¯ã€‚</p>
<p>ä¹‹å‰ï¼š</p>
<pre><code class="language-rust compile_fail">use pyo3::prelude::*;
use pyo3::class::{PyObjectProtocol, PyIterProtocol};
use pyo3::types::PyString;

#[pyclass]
struct MyClass {}

#[pyproto]
impl PyObjectProtocol for MyClass {
    fn __str__(&amp;self) -&gt; &amp;'static [u8] {
        b"hello, world"
    }
}

#[pyproto]
impl PyIterProtocol for MyClass {
    fn __iter__(slf: PyRef&lt;self&gt;) -&gt; PyResult&lt;&amp;PyAny&gt; {
        PyString::new(slf.py(), "hello, world").iter()
    }
}</code></pre>
<p>ä¹‹åï¼š</p>
<pre><code class="language-rust compile_fail">use pyo3::prelude::*;
use pyo3::types::PyString;

#[pyclass]
struct MyClass {}

#[pymethods]
impl MyClass {
    fn __str__(&amp;self) -&gt; &amp;'static [u8] {
        b"hello, world"
    }

    fn __iter__(slf: PyRef&lt;self&gt;) -&gt; PyResult&lt;&amp;PyAny&gt; {
        PyString::new(slf.py(), "hello, world").iter()
    }
}</code></pre>
</details>
<h3 id="ç§»é™¤äº†å¯¹è±¡åŒ…è£…å™¨çš„-partialeq-å®ç°"><a class="header" href="#ç§»é™¤äº†å¯¹è±¡åŒ…è£…å™¨çš„-partialeq-å®ç°">ç§»é™¤äº†å¯¹è±¡åŒ…è£…å™¨çš„ <code>PartialEq</code> å®ç°</a></h3>
<details>
<summary><small>ç‚¹å‡»å±•å¼€</small></summary>
<p>Python å¯¹è±¡åŒ…è£…å™¨ <code>Py</code> å’Œ <code>PyAny</code> åŸå…ˆå®ç°äº† <code>PartialEq</code>ï¼Œä½¿å¾— <code>object_a == object_b</code> å¯¹åº”äº Python ä¸­çš„ <code>is</code> æ“ä½œç¬¦ï¼ˆæŒ‡é’ˆç›¸ç­‰æ€§åˆ¤æ–­ï¼‰ï¼Œè€Œé <code>==</code> æ“ä½œç¬¦ã€‚æ­¤è¡Œä¸ºå·²è¢«ç§»é™¤ï¼Œå–è€Œä»£ä¹‹çš„æ˜¯æ–°æ–¹æ³•ï¼šåº”ä½¿ç”¨ <code>object_a.is(object_b)</code>ã€‚</p>
<p>è¿™ä¸€æ›´æ”¹è¿˜æœ‰ä¸€ä¸ªä¼˜åŠ¿ï¼šä¸å†è¦æ±‚ <code>object_a</code> å’Œ <code>object_b</code> å…·æœ‰ç›¸åŒçš„åŒ…è£…ç±»å‹ï¼Œä½ ç°åœ¨å¯ä»¥ç›´æ¥æ¯”è¾ƒ <code>Py&lt;T&gt;</code> å’Œ <code>&amp;PyAny</code>ï¼Œè€Œæ— éœ€è½¬æ¢ã€‚</p>
<p>è‹¥è¦æ£€æŸ¥ Python å¯¹è±¡çš„ç›¸ç­‰æ€§ï¼ˆå³ Python çš„ <code>==</code> æ“ä½œç¬¦ï¼‰ï¼Œè¯·ä½¿ç”¨æ–°æ–¹æ³• <code>eq()</code>ã€‚</p>
</details>
<h3 id="å®¹å™¨é­”æ³•æ–¹æ³•ç°åœ¨ä¸-python-è¡Œä¸ºä¸€è‡´"><a class="header" href="#å®¹å™¨é­”æ³•æ–¹æ³•ç°åœ¨ä¸-python-è¡Œä¸ºä¸€è‡´">å®¹å™¨é­”æ³•æ–¹æ³•ç°åœ¨ä¸ Python è¡Œä¸ºä¸€è‡´</a></h3>
<details>
<summary><small>ç‚¹å‡»å±•å¼€</small></summary>
<p>åœ¨ PyO3 0.15 ä¸­ï¼Œ<code>#[pymethods]</code> ä¸­çš„ <code>__getitem__</code>ã€<code>__setitem__</code> å’Œ <code>__delitem__</code> åªä¼šä¸º <code>#[pyclass]</code> ç”Ÿæˆ<strong>æ˜ å°„ï¼ˆmappingï¼‰</strong> çš„å®ç°ã€‚ä¸ºäº†ä¸ Python è¡Œä¸ºä¸€è‡´ï¼Œè¿™äº›æ–¹æ³•ç°åœ¨ä¼šåŒæ—¶ç”Ÿæˆ<strong>æ˜ å°„ï¼ˆmappingï¼‰</strong> å’Œ<strong>åºåˆ—ï¼ˆsequenceï¼‰</strong> çš„å®ç°ã€‚</p>
<p>è¿™æ„å‘³ç€å®ç°äº†è¿™äº› <code>#[pymethods]</code> çš„ç±»ç°åœ¨ä¹Ÿä¼šè¢«è§†ä¸ºåºåˆ—ï¼Œå°±åƒåŸç”Ÿ Python <code>class</code> ä¸€æ ·ã€‚è¿™å¯èƒ½å¯¼è‡´ä¸€äº›ç»†å¾®çš„è¡Œä¸ºå·®å¼‚ï¼š</p>
<ul>
<li>PyO3 å…è®¸å°†è¿™äº›ç±»çš„å®ä¾‹è½¬æ¢ä¸º <code>PySequence</code> å’Œ <code>PyMapping</code>ã€‚</li>
<li>Python ä¼šä¸ºè¿™ç±»ç±»æä¾›é»˜è®¤çš„ <code>__iter__</code> å®ç°ï¼ˆå¦‚æœç±»æœ¬èº«æœªå®šä¹‰ï¼‰ï¼Œè¯¥å®ç°ä¼šåå¤è°ƒç”¨ <code>__getitem__</code> å¹¶ä¼ å…¥æ•´æ•°ç´¢å¼•ï¼ˆä» 0 å¼€å§‹ï¼‰ï¼Œç›´åˆ°æŠ›å‡º <code>IndexError</code> ä¸ºæ­¢ã€‚</li>
</ul>
<p>è¯¦ç»†è¯´æ˜å¦‚ä¸‹ï¼Œè€ƒè™‘ä»¥ä¸‹ Python ç±»ï¼š</p>
<pre><code class="language-python">class ExampleContainer:

    def __len__(self):
        return 5

    def __getitem__(self, idx: int) -&gt; int:
        if idx &lt; 0 or idx &gt; 5:
            raise IndexError()
        return idx
</code></pre>
<p>è¯¥ç±»å®ç°äº†ä¸€ä¸ª Python <a href="https://docs.python.org/3/glossary.html#term-sequence">åºåˆ—</a>ã€‚</p>
<p><code>__len__</code> å’Œ <code>__getitem__</code> ä¹Ÿå¯ç”¨äºå®ç° Python <a href="https://docs.python.org/3/glossary.html#term-mapping">æ˜ å°„</a>ã€‚åœ¨ Python C-API ä¸­ï¼Œè¿™äº›æ–¹æ³•å¹¶ä¸å…±äº«ï¼šåºåˆ—çš„ <code>__len__</code> å’Œ <code>__getitem__</code> ç”± <code>sq_length</code> å’Œ <code>sq_item</code> æ§½ä½å®šä¹‰ï¼Œè€Œæ˜ å°„å¯¹åº”çš„åˆ™æ˜¯ <code>mp_length</code> å’Œ <code>mp_subscript</code>ã€‚<code>__setitem__</code> å’Œ <code>__delitem__</code> ä¹Ÿæœ‰ç±»ä¼¼çš„åŒºåˆ†ã€‚</p>
</details>å› ä¸º Python ä¸­æ²¡æœ‰è¿™æ ·çš„åŒºåˆ†ï¼Œå®ç°è¿™äº›æ–¹æ³•ä¼šåŒæ—¶å¡«å……æ˜ å°„ï¼ˆmappingï¼‰å’Œåºåˆ—ï¼ˆsequenceï¼‰çš„æ§½ä½ã€‚ä¾‹å¦‚ï¼Œä¸€ä¸ªå®ç°äº† `__len__` çš„ Python ç±»å°†åŒæ—¶å¡«å…… `sq_length` å’Œ `mp_length` æ§½ä½ã€‚
<p>PyO3 åœ¨ 0.16 ç‰ˆæœ¬ä¸­çš„é»˜è®¤è¡Œä¸ºå·²æ›´æ¥è¿‘äºè¿™ç§ Python è¡Œä¸ºã€‚</p>

<h3 id="wrap_pymodule-å’Œ-wrap_pyfunction-ç°åœ¨æ­£ç¡®åœ°éµå¾ªå¯è§æ€§è§„åˆ™"><a class="header" href="#wrap_pymodule-å’Œ-wrap_pyfunction-ç°åœ¨æ­£ç¡®åœ°éµå¾ªå¯è§æ€§è§„åˆ™"><code>wrap_pymodule!</code> å’Œ <code>wrap_pyfunction!</code> ç°åœ¨æ­£ç¡®åœ°éµå¾ªå¯è§æ€§è§„åˆ™</a></h3>
<details>
<summary><small>ç‚¹å‡»å±•å¼€</small></summary>
<p>åœ¨ PyO3 0.16 ä¹‹å‰ï¼Œ<code>wrap_pymodule!</code> å’Œ <code>wrap_pyfunction!</code> å®å¯ä»¥ä½¿ç”¨é‚£äº›æ ¹æ® Rust å¯è§æ€§è§„åˆ™æ— æ³•è®¿é—®çš„æ¨¡å—å’Œå‡½æ•°ã€‚</p>
<p>ä¾‹å¦‚ï¼Œä»¥ä¸‹ä»£ç åœ¨ 0.16 ç‰ˆæœ¬ä¹‹å‰æ˜¯åˆæ³•çš„ï¼Œä½†ä» 0.16 å¼€å§‹ä¼šè¢«æ‹’ç»ï¼Œå› ä¸º <code>wrap_pymodule!</code> å®æ— æ³•è®¿é—® <code>private_submodule</code> å‡½æ•°ï¼š</p>
<pre><code class="language-rust compile_fail">mod foo {
    use pyo3::prelude::*;

    #[pymodule]
    fn private_submodule(_py: Python&lt;'_&gt;, m: &amp;PyModule) -&gt; PyResult&lt;()&gt; {
        Ok(())
    }
}

use pyo3::prelude::*;
use foo::*;

#[pymodule]
fn my_module(_py: Python&lt;'_&gt;, m: &amp;PyModule) -&gt; PyResult&lt;()&gt; {
    m.add_wrapped(wrap_pymodule!(private_submodule))?;
    Ok(())
}</code></pre>
<p>è¦ä¿®å¤æ­¤é—®é¢˜ï¼Œè¯·ä½¿ç§æœ‰å­æ¨¡å—å¯è§ï¼Œä¾‹å¦‚ä½¿ç”¨ <code>pub</code> æˆ– <code>pub(crate)</code>ã€‚</p>
<pre><code class="language-rust ignore">mod foo {
    use pyo3::prelude::*;

    #[pymodule]
    pub(crate) fn private_submodule(_py: Python&lt;'_&gt;, m: &amp;PyModule) -&gt; PyResult&lt;()&gt; {
        Ok(())
    }
}

use pyo3::prelude::*;
use pyo3::wrap_pymodule;
use foo::*;

#[pymodule]
fn my_module(_py: Python&lt;'_&gt;, m: &amp;PyModule) -&gt; PyResult&lt;()&gt; {
    m.add_wrapped(wrap_pymodule!(private_submodule))?;
    Ok(())
}</code></pre>
</details>
<h2 id="ä»-014-å‡çº§åˆ°-015"><a class="header" href="#ä»-014-å‡çº§åˆ°-015">ä» 0.14.* å‡çº§åˆ° 0.15</a></h2>
<h3 id="åºåˆ—ç´¢å¼•çš„å˜æ›´"><a class="header" href="#åºåˆ—ç´¢å¼•çš„å˜æ›´">åºåˆ—ç´¢å¼•çš„å˜æ›´</a></h3>
<details>
<summary><small>ç‚¹å‡»å±•å¼€</small></summary>
<p>å¯¹äºæ‰€æœ‰æ¥å—åºåˆ—ç´¢å¼•çš„ç±»å‹ï¼ˆ<code>PyList</code>ã€<code>PyTuple</code> å’Œ <code>PySequence</code>ï¼‰ï¼ŒAPI å·²ç»Ÿä¸€ä¸ºä»…æ¥å— <code>usize</code> ç±»å‹çš„ç´¢å¼•ï¼Œä»¥ç¬¦åˆ Rust çš„ç´¢å¼•æƒ¯ä¾‹ã€‚ä¹‹å‰å³ä½¿åœ¨æ”¯æŒ <code>isize</code> çš„ API ä¸­ä¹Ÿä»…éƒ¨åˆ†æ”¯æŒè´Ÿæ•°ç´¢å¼•ï¼Œç°åœ¨è¿™äº› API å‡ä¸å†æ”¯æŒè´Ÿæ•°ç´¢å¼•ã€‚</p>
<p>æ­¤å¤–ï¼Œ<code>get_item</code> æ–¹æ³•ç°åœ¨åœ¨ç´¢å¼•æ— æ•ˆæ—¶æ€»æ˜¯è¿”å› <code>PyResult</code>ï¼Œè€Œä¸å†å¼•å‘ panicã€‚<code>Index</code> trait å·²è¢«å®ç°ï¼Œæä¾›äº†ä¸ Rust å‘é‡ç›¸åŒçš„ panic è¡Œä¸ºã€‚</p>
<p>è¯·æ³¨æ„ï¼Œ<em>åˆ‡ç‰‡</em> ç´¢å¼•ï¼ˆå¦‚ <code>PySequence::get_slice</code> ç­‰æ–¹æ³•æ‰€æ¥å—ï¼‰ä»ç»§æ‰¿ Python çš„è¡Œä¸ºï¼šç´¢å¼•ä¼šè¢«é™åˆ¶åœ¨å®é™…é•¿åº¦èŒƒå›´å†…ï¼Œè¶…å‡ºèŒƒå›´ä¹Ÿä¸ä¼š panic æˆ–è¿”å›é”™è¯¯ã€‚</p>
<p>å¯¹è¿™äº›ç±»å‹é‡‡ç”¨ Rust çš„ç´¢å¼•çº¦å®šçš„å¦ä¸€ä¸ªå¥½å¤„æ˜¯ï¼Œå®ƒä»¬ç°åœ¨ä¹Ÿå¯ä»¥ä½œä¸ºç»Ÿä¸€ API çš„ä¸€éƒ¨åˆ†ï¼Œæ”¯æŒ Rust çš„ç´¢å¼•æ“ä½œç¬¦ï¼š</p>
<pre><code class="language-rust ignore">#![allow(deprecated)]
use pyo3::{Python, types::PyList};

Python::with_gil(|py| {
    let list = PyList::new(py, &amp;[1, 2, 3]);
    assert_eq!(list[0..2].to_string(), "[1, 2]");
});</code></pre>
</details>
<h2 id="ä»-013-å‡çº§åˆ°-014"><a class="header" href="#ä»-013-å‡çº§åˆ°-014">ä» 0.13.* å‡çº§åˆ° 0.14</a></h2>
<h3 id="auto-initialize-åŠŸèƒ½ç°åœ¨éœ€è¦æ˜¾å¼å¯ç”¨"><a class="header" href="#auto-initialize-åŠŸèƒ½ç°åœ¨éœ€è¦æ˜¾å¼å¯ç”¨"><code>auto-initialize</code> åŠŸèƒ½ç°åœ¨éœ€è¦æ˜¾å¼å¯ç”¨</a></h3>
<details>
<summary><small>ç‚¹å‡»å±•å¼€</small></summary>
<p>å¯¹äºåœ¨ Rust ä¸­åµŒå…¥ Python çš„é¡¹ç›®ï¼Œé™¤éå¯ç”¨äº† <a href="features.html#auto-initialize"><code>auto-initialize</code> åŠŸèƒ½</a>ï¼Œå¦åˆ™ PyO3 ä¸å†åœ¨é¦–æ¬¡è°ƒç”¨ <code>Python::with_gil</code>ï¼ˆæˆ– <code>Python::acquire_gil</code>ï¼‰æ—¶è‡ªåŠ¨åˆå§‹åŒ– Python è§£é‡Šå™¨ã€‚</p>
</details>
<h3 id="æ–°å¢-multiple-pymethods-åŠŸèƒ½"><a class="header" href="#æ–°å¢-multiple-pymethods-åŠŸèƒ½">æ–°å¢ <code>multiple-pymethods</code> åŠŸèƒ½</a></h3>
<details>
<summary><small>ç‚¹å‡»å±•å¼€</small></summary>
<p><code>#[pymethods]</code> å·²ç»è¿‡é‡æ„ï¼Œé‡‡ç”¨æ›´ç®€å•çš„é»˜è®¤å®ç°ï¼Œç§»é™¤äº†å¯¹ <code>inventory</code> crate çš„ä¾èµ–ã€‚è¿™å‡å°‘äº†å¤§å¤šæ•°ç”¨æˆ·çš„ä¾èµ–é¡¹å’Œç¼–è¯‘æ—¶é—´ã€‚</p>
<p>æ–°é»˜è®¤å®ç°çš„é™åˆ¶æ˜¯æ— æ³•æ”¯æŒåŒä¸€ <code>#[pyclass]</code> æœ‰å¤šä¸ª <code>#[pymethods]</code> å—ã€‚å¦‚æœéœ€è¦è¯¥åŠŸèƒ½ï¼Œå¿…é¡»å¯ç”¨ <code>multiple-pymethods</code> åŠŸèƒ½ï¼Œä»¥åˆ‡æ¢å›åŸºäº <code>inventory</code> çš„å®ç°ã€‚</p>
</details>
<h3 id="å·²å¼ƒç”¨çš„-pyproto-æ–¹æ³•"><a class="header" href="#å·²å¼ƒç”¨çš„-pyproto-æ–¹æ³•">å·²å¼ƒç”¨çš„ <code>#[pyproto]</code> æ–¹æ³•</a></h3>
<details>
<summary><small>ç‚¹å‡»å±•å¼€</small></summary>
<p>ä¸€äº›åè®®æ–¹æ³•ï¼ˆå³ <code>__dunder__</code> æ–¹æ³•ï¼‰ï¼Œä¾‹å¦‚ <code>__bytes__</code> å’Œ <code>__format__</code>ï¼Œé•¿æœŸä»¥æ¥å¯ä»¥é€šè¿‡ä¸¤ç§æ–¹å¼åœ¨ PyO3 ä¸­å®ç°ï¼šä½¿ç”¨ <code>#[pyproto]</code>ï¼ˆä¾‹å¦‚æœ¬å¤„åˆ—å‡ºçš„æ–¹æ³•å¯¹åº”çš„ <code>PyObjectProtocol</code>ï¼‰ï¼Œæˆ–ç›´æ¥åœ¨ <code>#[pymethods]</code> ä¸­ç¼–å†™ã€‚ä½†è¿™ç§æƒ…å†µä»…é€‚ç”¨äºå°‘æ•°å‡ ä¸ª <code>#[pyproto]</code> æ–¹æ³•ï¼ˆç”±äº PyO3 å½“å‰ä¸ Python C API äº¤äº’çš„æŠ€æœ¯åŸå› ï¼‰ã€‚</p>
<p>ä¸ºäº†åšæŒâ€œä¸€ç§æ˜ç¡®çš„æ–¹æ³•åšä¸€ä»¶äº‹â€çš„åŸåˆ™ï¼Œè¿™äº›æ–¹æ³•çš„ <code>#[pyproto]</code> å½¢å¼å·²è¢«å¼ƒç”¨ã€‚</p>
<p>è¿ç§»æ–¹æ³•æ˜¯å°†å—å½±å“çš„æ–¹æ³•ä» <code>#[pyproto]</code> å—ç§»è‡³ <code>#[pymethods]</code> å—å³å¯ã€‚</p>
<p>ä¹‹å‰ï¼š</p>
<pre><code class="language-rust compile_fail">use pyo3::prelude::*;
use pyo3::class::basic::PyObjectProtocol;

#[pyclass]
struct MyClass {}

#[pyproto]
impl PyObjectProtocol for MyClass {
    fn __bytes__(&amp;self) -&gt; &amp;'static [u8] {
        b"hello, world"
    }
}</code></pre>
<p>ä¹‹åï¼š</p>
<pre><code class="language-rust no_run">use pyo3::prelude::*;

#[pyclass]
struct MyClass {}

#[pymethods]
impl MyClass {
    fn __bytes__(&amp;self) -&gt; &amp;'static [u8] {
        b"hello, world"
    }
}</code></pre>
</details>
<h2 id="ä»-012-å‡çº§åˆ°-013"><a class="header" href="#ä»-012-å‡çº§åˆ°-013">ä» 0.12.* å‡çº§åˆ° 0.13</a></h2>
<h3 id="æœ€ä½-rust-ç‰ˆæœ¬å‡çº§è‡³-rust-145"><a class="header" href="#æœ€ä½-rust-ç‰ˆæœ¬å‡çº§è‡³-rust-145">æœ€ä½ Rust ç‰ˆæœ¬å‡çº§è‡³ Rust 1.45</a></h3>
<details>
<summary><small>ç‚¹å‡»å±•å¼€</small></summary>
<p>PyO3 <code>0.13</code> ä½¿ç”¨äº†åœ¨ Rust 1.40 è‡³ 1.45 ä¹‹é—´ç¨³å®šçš„æ–° Rust è¯­è¨€ç‰¹æ€§ã€‚å¦‚æœä½ ä½¿ç”¨çš„ Rust ç¼–è¯‘å™¨æ—©äº 1.45 ç‰ˆæœ¬ï¼Œåˆ™å¿…é¡»æ›´æ–°å·¥å…·é“¾æ‰èƒ½ç»§ç»­ä½¿ç”¨ PyO3ã€‚</p>
</details>
<h3 id="è¿è¡Œæ—¶å˜æ›´ä»¥æ”¯æŒ-cpython-æœ‰é™-api"><a class="header" href="#è¿è¡Œæ—¶å˜æ›´ä»¥æ”¯æŒ-cpython-æœ‰é™-api">è¿è¡Œæ—¶å˜æ›´ä»¥æ”¯æŒ CPython æœ‰é™ API</a></h3>
<details>
<summary><small>ç‚¹å‡»å±•å¼€</small></summary>
<p>åœ¨ PyO3 <code>0.13</code> ä¸­å¢åŠ äº†å¯¹ç¼–è¯‘ CPython æœ‰é™ API çš„æ”¯æŒã€‚è¿™å¯¹æ‰€æœ‰ PyO3 ç”¨æˆ·éƒ½äº§ç”Ÿäº†ä¸€äº›å½±å“ï¼Œå…·ä½“å¦‚ä¸‹ã€‚</p>
<p>å…¶ä¸­æœ€å¤§çš„ä¸€ç‚¹æ˜¯ï¼Œæ‰€æœ‰ç”± PyO3 åˆ›å»ºçš„ç±»å‹ç°åœ¨éƒ½æ˜¯ CPython æ‰€ç§°çš„â€œå †ç±»å‹â€ï¼ˆheap typesï¼‰ã€‚å…¶å…·ä½“å½±å“åŒ…æ‹¬ï¼š</p>
<ul>
<li>å¦‚æœä½ æƒ³ä» Rust å­ç±»åŒ–è¿™äº›ç±»å‹ï¼Œå¿…é¡»ä½¿ç”¨ <code>#[pyclass(subclass)]</code> æ ‡è®°å®ƒä»¬ï¼Œå°±åƒä½ æƒ³å…è®¸ä» Python ä»£ç ä¸­å­ç±»åŒ–å®ƒä»¬ä¸€æ ·ã€‚</li>
<li>ç±»å‹å¯¹è±¡ç°åœ¨æ˜¯å¯å˜çš„â€”â€”Python ä»£ç å¯ä»¥ä¸ºå…¶è®¾ç½®å±æ€§ã€‚</li>
<li>å¯¹äºæœªä½¿ç”¨ <code>#[pyclass(module="mymodule")]</code> çš„ç±»å‹ï¼Œå…¶ <code>__module__</code> ä¸å†è¿”å› <code>builtins</code>ï¼Œè€Œæ˜¯ä¼šå¼•å‘ <code>AttributeError</code>ã€‚</li>
</ul>
</details>
<h2 id="ä»-011-å‡çº§åˆ°-012"><a class="header" href="#ä»-011-å‡çº§åˆ°-012">ä» 0.11.* å‡çº§åˆ° 0.12</a></h2>
<h3 id="pyerr-å·²ç»è¿‡é‡æ„"><a class="header" href="#pyerr-å·²ç»è¿‡é‡æ„"><code>PyErr</code> å·²ç»è¿‡é‡æ„</a></h3>
<details>
<summary><small>ç‚¹å‡»å±•å¼€</small></summary>
<p>åœ¨ PyO3 <code>0.12</code> ä¸­ï¼Œ<code>PyErr</code> ç±»å‹è¢«é‡æ–°å®ç°ï¼Œä»¥æ›´å¥½åœ°ä¸æ ‡å‡† Rust é”™è¯¯å¤„ç†ç”Ÿæ€ç³»ç»Ÿå…¼å®¹ã€‚å…·ä½“è€Œè¨€ï¼Œ<code>PyErr</code> ç°åœ¨å®ç°äº† <code>Error + Send + Sync</code>ï¼Œè¿™æ˜¯ Rust ä¸­é”™è¯¯ç±»å‹çš„æ ‡å‡† traitã€‚</p>
<p>å°½ç®¡è¿™å¯¼è‡´ä¸€äº› API è¢«ç§»é™¤ï¼Œä½†æ–°çš„ <code>PyErr</code> ç±»å‹ç°åœ¨åº”è¯¥æ›´å®¹æ˜“ä½¿ç”¨ã€‚ä»¥ä¸‹éƒ¨åˆ†è¯¦ç»†åˆ—å‡ºäº†å˜æ›´å†…å®¹ä»¥åŠå¦‚ä½•è¿ç§»åˆ°æ–° APIã€‚</p>
</details>
<h4 id="pyerrnew-å’Œ-pyerrfrom_type-ç°åœ¨è¦æ±‚å…¶å‚æ•°å®ç°-send--sync"><a class="header" href="#pyerrnew-å’Œ-pyerrfrom_type-ç°åœ¨è¦æ±‚å…¶å‚æ•°å®ç°-send--sync"><code>PyErr::new</code> å’Œ <code>PyErr::from_type</code> ç°åœ¨è¦æ±‚å…¶å‚æ•°å®ç° <code>Send + Sync</code></a></h4>
<details>
<summary><small>ç‚¹å‡»å±•å¼€</small></summary>
<p>å¯¹å¤§å¤šæ•°ä½¿ç”¨åœºæ™¯è€Œè¨€æ— éœ€ä¿®æ”¹ã€‚å¦‚æœä½ å°è¯•ç”¨ä¸€ä¸ªä¸æ»¡è¶³ <code>Send + Sync</code> çš„å€¼æ„é€  <code>PyErr</code>ï¼Œä½ éœ€è¦å…ˆåˆ›å»º Python å¯¹è±¡ï¼Œç„¶åä½¿ç”¨ <code>PyErr::from_instance</code>ã€‚</p>
<p>ç±»ä¼¼åœ°ï¼Œä»»ä½•å®ç°äº† <code>PyErrArguments</code> çš„ç±»å‹ç°åœ¨ä¹Ÿå¿…é¡»æ»¡è¶³ <code>Send + Sync</code>ã€‚</p>
</details>
<h4 id="pyerr-çš„å†…éƒ¨å­—æ®µç°åœ¨ä¸ºç§æœ‰"><a class="header" href="#pyerr-çš„å†…éƒ¨å­—æ®µç°åœ¨ä¸ºç§æœ‰"><code>PyErr</code> çš„å†…éƒ¨å­—æ®µç°åœ¨ä¸ºç§æœ‰</a></h4>
<details>
<summary><small>ç‚¹å‡»å±•å¼€</small></summary>
<p>ä¸å†å…è®¸ç›´æ¥è®¿é—® <code>PyErr</code> çš„ <code>.ptype</code>ã€<code>.pvalue</code> å’Œ <code>.ptraceback</code> å­—æ®µã€‚ä½ åº”è¯¥æ”¹ç”¨æ–°çš„æ–¹æ³• <code>PyErr::ptype</code>ã€<code>PyErr::pvalue</code> å’Œ <code>PyErr::ptraceback</code>ã€‚</p>
</details>
<h4 id="pyerrvalue-å’Œ-pyerrfrom_value-å·²è¢«ç§»é™¤"><a class="header" href="#pyerrvalue-å’Œ-pyerrfrom_value-å·²è¢«ç§»é™¤"><code>PyErrValue</code> å’Œ <code>PyErr::from_value</code> å·²è¢«ç§»é™¤</a></h4>
<details>
<summary><small>ç‚¹å‡»å±•å¼€</small></summary>
<p>ç”±äºè¿™äº› API å±äºå·²è¢«é‡æ„çš„ <code>PyErr</code> å†…éƒ¨æœºåˆ¶ï¼Œå› æ­¤ä¸å†å­˜åœ¨ã€‚</p>
<p>å¦‚æœä½ æ›¾ä½¿ç”¨è¿™äº› APIï¼Œå»ºè®®æ”¹ç”¨ <code>PyException::new_err</code>ï¼ˆè§ <a href="#exception-types-have-been-reworked">å¼‚å¸¸ç±»å‹é‡æ„éƒ¨åˆ†</a>ï¼‰ã€‚</p>
</details>
<h4 id="ç§»é™¤äº†-pyerr-åˆ°-pyresultt-çš„-into-å®ç°"><a class="header" href="#ç§»é™¤äº†-pyerr-åˆ°-pyresultt-çš„-into-å®ç°">ç§»é™¤äº† <code>PyErr</code> åˆ° <code>PyResult&lt;T&gt;</code> çš„ <code>Into</code> å®ç°</a></h4>
<details>
<summar y=""><small>ç‚¹å‡»å±•å¼€</small>
<p>è¯¥å®ç°æ˜¯å†—ä½™çš„ã€‚è¯·ç›´æ¥æ„é€  <code>Result::Err</code> å˜ä½“å³å¯ã€‚</p>
<p>ä¹‹å‰ï¼š</p>
<pre><code class="language-rust compile_fail">let result: PyResult&lt;()&gt; = PyErr::new::&lt;TypeError, _&gt;("error message").into();</code></pre>
<p>ä¹‹åï¼ˆåŒæ—¶ä½¿ç”¨é‡æ„åçš„å¼‚å¸¸ç±»å‹ï¼›è§ä¸‹ä¸€éƒ¨åˆ†ï¼‰ï¼š</p>
<pre><code class="language-rust no_run"><span class="boring">use pyo3::{PyResult, exceptions::PyTypeError};
</span>let result: PyResult&lt;()&gt; = Err(PyTypeError::new_err("error message"));</code></pre>

<h3 id="å¼‚å¸¸ç±»å‹å·²é‡æ„"><a class="header" href="#å¼‚å¸¸ç±»å‹å·²é‡æ„">å¼‚å¸¸ç±»å‹å·²é‡æ„</a></h3>
<details>
<summary><small>ç‚¹å‡»å±•å¼€</small></summary>
<p>ä»¥å‰å¼‚å¸¸ç±»å‹æ˜¯é›¶å¤§å°çš„æ ‡è®°ç±»å‹ï¼Œä»…ç”¨äºæ„é€  <code>PyErr</code>ã€‚åœ¨ PyO3 0.12 ä¸­ï¼Œè¿™äº›ç±»å‹å·²è¢«æ›¿æ¢ä¸ºå®Œæ•´å®šä¹‰ï¼Œå¯ä»¥åƒ <code>PyAny</code>ã€<code>PyDict</code> ç­‰ä¸€æ ·ä½¿ç”¨ã€‚è¿™ä½¿å¾—èƒ½å¤Ÿä¸ Python å¼‚å¸¸å¯¹è±¡è¿›è¡Œäº¤äº’ã€‚</p>
<p>æ–°ç±»å‹çš„åç§°å‡ä»¥ â€œPyâ€ ä¸ºå‰ç¼€ã€‚ä¾‹å¦‚ï¼Œä¹‹å‰ï¼š</p>
<pre><code class="language-rust ignore">let err: PyErr = TypeError::py_err("error message");</code></pre>
<p>ä¹‹åï¼š</p>
<pre><code class="language-rust ignore"><span class="boring">use pyo3::{PyErr, PyResult, Python, type_object::PyTypeObject};
</span><span class="boring">use pyo3::exceptions::{PyBaseException, PyTypeError};
</span><span class="boring">Python::with_gil(|py| -&gt; PyResult&lt;()&gt; {
</span>let err: PyErr = PyTypeError::new_err("error message");

// ä½¿ç”¨ PyErr çš„ Display ç‰¹æ€§ï¼ŒPyO3 0.12 çš„æ–°åŠŸèƒ½
assert_eq!(err.to_string(), "TypeError: error message");

// ç°åœ¨å¯ä»¥ä¸å¼‚å¸¸å®ä¾‹äº¤äº’ï¼ŒPyO3 0.12 çš„æ–°åŠŸèƒ½
let instance: &amp;PyBaseException = err.instance(py);
assert_eq!(
    instance.getattr("__class__")?,
    PyTypeError::type_object(py).as_ref()
);
<span class="boring">Ok(())
</span><span class="boring">}).unwrap();</span></code></pre>
</details>
<h3 id="frompy-å·²è¢«ç§»é™¤"><a class="header" href="#frompy-å·²è¢«ç§»é™¤"><code>FromPy</code> å·²è¢«ç§»é™¤</a></h3>
<details>
<summary><small>ç‚¹å‡»å±•å¼€</small></summary>
<p>ä¸ºäº†ç®€åŒ– PyO3 çš„è½¬æ¢ traitï¼Œ<code>FromPy</code> trait å·²è¢«ç§»é™¤ã€‚ä»¥å‰æœ‰ä¸¤ç§æ–¹å¼å®šä¹‰ç±»å‹çš„è½¬ Python è½¬æ¢ï¼š<code>FromPy&lt;T&gt; for PyObject</code> å’Œ <code>IntoPy&lt;PyObject&gt; for T</code>ã€‚</p>
<p>ç°åœ¨å®šä¹‰è½¬æ¢çš„å”¯ä¸€æ–¹å¼æ˜¯ <code>IntoPy</code>ï¼Œå› æ­¤ä¸‹æ¸¸ crate å¯èƒ½éœ€è¦ç›¸åº”è°ƒæ•´ã€‚</p>
<p>ä¹‹å‰ï¼š</p>
<pre><code class="language-rust compile_fail"><span class="boring">use pyo3::prelude::*;
</span>struct MyPyObjectWrapper(PyObject);


impl FromPy&lt;MyPyObjectWrapper&gt; for PyObject {
    fn from_py(other: MyPyObjectWrapper, _py: Python&lt;'_&gt;) -&gt; Self {
        other.0
    }
}</code></pre>
<p>ä¹‹åï¼š</p>
<pre><code class="language-rust ignore"><span class="boring">use pyo3::prelude::*;
</span><span class="boring">#[allow(dead_code)]
</span>struct MyPyObjectWrapper(PyObject);


<span class="boring">#[allow(deprecated)]
</span>impl IntoPy&lt;PyObject&gt; for MyPyObjectWrapper {
    fn into_py(self, _py: Python&lt;'_&gt;) -&gt; PyObject {
        self.0
    }
}</code></pre>
<p>åŒæ ·ï¼Œä½¿ç”¨ <code>FromPy</code> trait çš„ä»£ç å¯ä»¥è½»æ¾é‡å†™ä¸ºä½¿ç”¨ <code>IntoPy</code>ã€‚</p>
<p>ä¹‹å‰ï¼š</p>
<pre><code class="language-rust compile_fail"><span class="boring">use pyo3::prelude::*;
</span><span class="boring">Python::with_gil(|py| {
</span>let obj = PyObject::from_py(1.234, py);
<span class="boring">})</span></code></pre>
<p>ä¹‹åï¼š</p>
<pre><code class="language-rust ignore"><span class="boring">#![allow(deprecated)]
</span><span class="boring">use pyo3::prelude::*;
</span><span class="boring">Python::with_gil(|py| {
</span>let obj: PyObject = 1.234.into_py(py);
<span class="boring">})</span></code></pre>
</details>
<h3 id="pyobject-ç°åœ¨æ˜¯-pypyany-çš„ç±»å‹åˆ«å"><a class="header" href="#pyobject-ç°åœ¨æ˜¯-pypyany-çš„ç±»å‹åˆ«å"><code>PyObject</code> ç°åœ¨æ˜¯ <code>Py&lt;PyAny&gt;</code> çš„ç±»å‹åˆ«å</a></h3>
<details>
<summary><small>ç‚¹å‡»å±•å¼€</small></summary>
<p>ä»ä½¿ç”¨è§’åº¦æ¥çœ‹ï¼Œè¿™ä¸€æ”¹åŠ¨å½±å“æå°ã€‚å¦‚æœä½ æ›¾ä¸º <code>PyObject</code> å’Œ <code>Py&lt;T&gt;</code> éƒ½å®ç°äº† traitï¼Œç°åœ¨å¯èƒ½åªéœ€è¦ç§»é™¤ <code>PyObject</code> çš„å®ç°å³å¯ã€‚</p>
</details>
<h3 id="aspyref-å·²è¢«ç§»é™¤"><a class="header" href="#aspyref-å·²è¢«ç§»é™¤"><code>AsPyRef</code> å·²è¢«ç§»é™¤</a></h3>
<details>
<summary><small>ç‚¹å‡»å±•å¼€</small></summary>
<p>ç”±äº <code>PyObject</code> ç°åœ¨åªæ˜¯ä¸€ä¸ªç±»å‹åˆ«åï¼Œ<code>AsPyRef</code> å”¯ä¸€å‰©ä¸‹çš„å®ç°è€…æ˜¯ <code>Py&lt;T&gt;</code>ã€‚å› æ­¤ä¸å†éœ€è¦è¯¥ traitï¼Œ<code>AsPyRef::as_ref</code> æ–¹æ³•å·²ç›´æ¥ç§»è‡³ <code>Py::as_ref</code>ã€‚</p>
<p>é™¤äº†ç§»é™¤æœªä½¿ç”¨ <code>pyo3::prelude::*</code> çš„ä»£ç ä¸­çš„ <code>use pyo3::AsPyRef</code> å¤–ï¼Œåº”æ— éœ€å…¶ä»–ä»£ç ä¿®æ”¹ã€‚</p>
<p>ä¹‹å‰ï¼š</p>
<pre><code class="language-rust ignore">use pyo3::{AsPyRef, Py, types::PyList};
<span class="boring">pyo3::Python::with_gil(|py| {
</span>let list_py: Py&lt;PyList&gt; = PyList::empty(py).into();
let list_ref: &amp;PyList = list_py.as_ref(py);
<span class="boring">})</span></code></pre>
<p>ä¹‹åï¼š</p>
<pre><code class="language-rust ignore">use pyo3::{Py, types::PyList};
<span class="boring">pyo3::Python::with_gil(|py| {
</span>let list_py: Py&lt;PyList&gt; = PyList::empty(py).into();
let list_ref: &amp;PyList = list_py.as_ref(py);
<span class="boring">})</span></code></pre>
</details>
<h2 id="ä»-010-å‡çº§åˆ°-011"><a class="header" href="#ä»-010-å‡çº§åˆ°-011">ä» 0.10.* å‡çº§åˆ° 0.11</a></h2>
<h3 id="ç¨³å®šç‰ˆ-rust"><a class="header" href="#ç¨³å®šç‰ˆ-rust">ç¨³å®šç‰ˆ Rust</a></h3>
<details>
<summary><small>ç‚¹å‡»å±•å¼€</small></summary>
<p>PyO3 ç°åœ¨æ”¯æŒç¨³å®šçš„ Rust å·¥å…·é“¾ã€‚æœ€ä½è¦æ±‚ç‰ˆæœ¬ä¸º 1.39.0ã€‚</p>
</details>
<h3 id="pyclass-ç»“æ„ä½“ç°åœ¨å¿…é¡»æ˜¯-send-æˆ–æ ‡è®°ä¸º-unsendable"><a class="header" href="#pyclass-ç»“æ„ä½“ç°åœ¨å¿…é¡»æ˜¯-send-æˆ–æ ‡è®°ä¸º-unsendable"><code>#[pyclass]</code> ç»“æ„ä½“ç°åœ¨å¿…é¡»æ˜¯ <code>Send</code> æˆ–æ ‡è®°ä¸º <code>unsendable</code></a></h3>
<details>
<summary><small>ç‚¹å‡»å±•å¼€</small></summary>
<p>ç”±äº Python è§£é‡Šå™¨å¯ä»¥åœ¨çº¿ç¨‹é—´ä¼ é€’ <code>#[pyclass]</code> ç»“æ„ä½“ï¼Œå®ƒä»¬å¿…é¡»å®ç° <code>Send</code> æˆ–è¢«å£°æ˜ä¸º <code>unsendable</code>ï¼ˆé€šè¿‡ <code>#[pyclass(unsendable)]</code>ï¼‰ã€‚æ³¨æ„ <code>unsendable</code> æ˜¯åœ¨ PyO3 <code>0.11.1</code> ä¸­æ·»åŠ çš„ï¼Œåœ¨ PyO3 <code>0.11.0</code> ä¸­å§‹ç»ˆè¦æ±‚ <code>Send</code>ã€‚</p>
<p>è¿™å¯èƒ½ä¼šâ€œç ´åâ€ä¸€äº›ä¹‹å‰å¯ä»¥ç¼–è¯‘ä½†å®é™…ä¸Šæ˜¯ä¸å®‰å…¨çš„ä»£ç ã€‚æœ‰ä¸¤ç§ä¿®å¤æ–¹å¼ï¼š</p>
<ol>
<li>
<p>å¦‚æœä½ è®¤ä¸ºä½ çš„ <code>#[pyclass]</code> ç¡®å®åº”è¯¥æ˜¯å¯ <code>Send</code> çš„ï¼Œè¯·å®ç° <code>Send</code>ã€‚ä¸€ç§å¸¸è§ä¸”æ›´å®‰å…¨çš„æ–¹æ³•æ˜¯ä½¿ç”¨çº¿ç¨‹å®‰å…¨ç±»å‹ã€‚ä¾‹å¦‚ï¼Œç”¨ <code>Arc</code> æ›¿ä»£ <code>Rc</code>ï¼Œç”¨ <code>Mutex</code> æ›¿ä»£ <code>RefCell</code>ï¼Œç”¨ <code>Box&lt;dyn Send + T&gt;</code> æ›¿ä»£ <code>Box&lt;dyn T&gt;</code>ã€‚</p>
<p>ä¹‹å‰ï¼š</p>
<pre><code class="language-rust compile_fail">use pyo3::prelude::*;
use std::rc::Rc;
use std::cell::RefCell;

#[pyclass]
struct NotThreadSafe {
    shared_bools: Rc&lt;RefCell&lt;Vec&lt;bool&gt;&gt;&gt;,
    closure: Box&lt;dyn Fn()&gt;,
}</code></pre>
<p>ä¹‹åï¼š</p>
<pre><code class="language-rust ignore"><span class="boring">#![allow(dead_code)]
</span>use pyo3::prelude::*;
use std::sync::{Arc, Mutex};

#[pyclass]
struct ThreadSafe {
    shared_bools: Arc&lt;Mutex&lt;Vec&lt;bool&gt;&gt;&gt;,
    closure: Box&lt;dyn Fn() + Send&gt;,
}</code></pre>
<p>å¦‚æœä½ æ— æ³•æ›´æ”¹ <code>#[pyclass]</code> ä»¥è‡ªåŠ¨å®ç° <code>Send</code>ï¼ˆä¾‹å¦‚ï¼Œå½“å®ƒåŒ…å«è£¸æŒ‡é’ˆæ—¶ï¼‰ï¼Œå¯ä»¥ä½¿ç”¨ <code>unsafe impl Send</code>ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œéœ€ç¡®ä¿ç»“æ„ä½“å®é™…ä¸Šæ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚æ›´å¤šä¿¡æ¯è¯·å‚è§ <a href="https://doc.rust-lang.org/nomicon/send-and-sync.html">the Rustonomicon</a>ã€‚</p>
</li>
<li>
<p>å¦‚æœä½ è®¤ä¸ºä½ çš„ <code>#[pyclass]</code> ä¸åº”è¢«å…¶ä»–çº¿ç¨‹è®¿é—®ï¼Œå¯ä»¥ä½¿ç”¨ <code>unsendable</code> æ ‡å¿—ã€‚æ ‡è®°ä¸º <code>unsendable</code> çš„ç±»åœ¨è¢«å…¶ä»–çº¿ç¨‹è®¿é—®æ—¶ä¼š panicï¼Œä»è€Œä½¿å‘ Python è§£é‡Šå™¨æš´éœ²ä¸å¯å‘é€å¯¹è±¡æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚</p>
<p>ä¹‹å‰ï¼š</p>
<pre><code class="language-rust compile_fail">use pyo3::prelude::*;

#[pyclass]
struct Unsendable {
    pointers: Vec&lt;*mut std::ffi::c_char&gt;,
}</code></pre>
<p>ä¹‹åï¼š</p>
<pre><code class="language-rust no_run"><span class="boring">#![allow(dead_code)]
</span>use pyo3::prelude::*;

#[pyclass(unsendable)]
struct Unsendable {
    pointers: Vec&lt;*mut std::ffi::c_char&gt;,
}</code></pre>
</li>
</ol>
</details>
<h3 id="æ‰€æœ‰-pyobject-å’Œ-pyt-æ–¹æ³•ç°åœ¨éƒ½éœ€è¦-python-ä½œä¸ºå‚æ•°"><a class="header" href="#æ‰€æœ‰-pyobject-å’Œ-pyt-æ–¹æ³•ç°åœ¨éƒ½éœ€è¦-python-ä½œä¸ºå‚æ•°">æ‰€æœ‰ <code>PyObject</code> å’Œ <code>Py&lt;T&gt;</code> æ–¹æ³•ç°åœ¨éƒ½éœ€è¦ <code>Python</code> ä½œä¸ºå‚æ•°</a></h3>
<details>
<summary><small>ç‚¹å‡»å±•å¼€</small></summary>
<p>ä»¥å‰ï¼Œä¸€äº›æ–¹æ³•å¦‚ <code>Object::get_refcnt</code> ä¸éœ€è¦ <code>Python</code> å‚æ•°ï¼ˆä»¥ç¡®ä¿å½“å‰çº¿ç¨‹æŒæœ‰ Python GILï¼‰ã€‚ä»æŠ€æœ¯ä¸Šè®²ï¼Œè¿™æ˜¯ä¸å®‰å…¨çš„ã€‚è¿ç§»æ—¶ï¼Œåªéœ€å°† <code>py</code> å‚æ•°ä¼ é€’ç»™è¿™äº›æ–¹æ³•çš„è°ƒç”¨å³å¯ã€‚</p>
<p>ä¹‹å‰ï¼š</p>
<pre><code class="language-rust compile_fail"><span class="boring">pyo3::Python::attach(|py| {
</span>py.None().get_refcnt();
<span class="boring">})</span></code></pre>
<p>ä¹‹åï¼š</p>
<pre><code class="language-rust"><span class="boring">pyo3::Python::attach(|py| {
</span>py.None().get_refcnt(py);
<span class="boring">})</span></code></pre>
</details>
<h2 id="ä»-09-å‡çº§åˆ°-010"><a class="header" href="#ä»-09-å‡çº§åˆ°-010">ä» 0.9.* å‡çº§åˆ° 0.10</a></h2>
<h3 id="objectprotocol-å·²ç§»é™¤"><a class="header" href="#objectprotocol-å·²ç§»é™¤"><code>ObjectProtocol</code> å·²ç§»é™¤</a></h3>
<details>
<summary><small>ç‚¹å‡»å±•å¼€</small></summary>
<p>æ‰€æœ‰æ–¹æ³•éƒ½å·²ç§»è‡³ <a href="{{#PYO3_DOCS_URL}}/pyo3/types/struct.PyAny.html"><code>PyAny</code></a>ã€‚å¹¶ä¸”ç”±äºç°åœ¨æ‰€æœ‰åŸç”Ÿç±»å‹ï¼ˆä¾‹å¦‚ <code>PyList</code>ï¼‰éƒ½å®ç°äº† <code>Deref&lt;Target=PyAny&gt;</code>ï¼Œä½ åªéœ€ä»ä»£ç ä¸­ç§»é™¤ <code>ObjectProtocol</code> å³å¯ã€‚å¦‚æœä½ é€šè¿‡ <code>use pyo3::prelude::*</code> ä½¿ç”¨ <code>ObjectProtocol</code>ï¼Œåˆ™æ— éœ€ä»»ä½•æ›´æ”¹ã€‚</p>
<p>ä¹‹å‰ï¼š</p>
<pre><code class="language-rust compile_fail ignore">use pyo3::ObjectProtocol;

<span class="boring">pyo3::Python::with_gil(|py| {
</span>let obj = py.eval("lambda: 'Hi :)'", None, None).unwrap();
let hi: &amp;pyo3::types::PyString = obj.call0().unwrap().downcast().unwrap();
assert_eq!(hi.len().unwrap(), 5);
<span class="boring">})</span></code></pre>
<p>ä¹‹åï¼š</p>
<pre><code class="language-rust ignore"><span class="boring">pyo3::Python::with_gil(|py| {
</span>let obj = py.eval("lambda: 'Hi :)'", None, None).unwrap();
let hi: &amp;pyo3::types::PyString = obj.call0().unwrap().downcast().unwrap();
assert_eq!(hi.len().unwrap(), 5);
<span class="boring">})</span></code></pre>
</details>
<h3 id="ç”¨æˆ·ä»£ç ä¸­ä¸å†éœ€è¦-featurespecialization"><a class="header" href="#ç”¨æˆ·ä»£ç ä¸­ä¸å†éœ€è¦-featurespecialization">ç”¨æˆ·ä»£ç ä¸­ä¸å†éœ€è¦ <code>#![feature(specialization)]</code></a></h3>
<details>
<summary><small>ç‚¹å‡»å±•å¼€</small></summary>
<p>è™½ç„¶ PyO3 æœ¬èº«ä»éœ€è¦ specialization å’Œ nightly Rustï¼Œä½†ç°åœ¨ä½ çš„ crate ä¸­ä¸å†éœ€è¦ä½¿ç”¨ <code>#![feature(specialization)]</code>ã€‚</p>
</details>
<h2 id="ä»-08-å‡çº§åˆ°-09"><a class="header" href="#ä»-08-å‡çº§åˆ°-09">ä» 0.8.* å‡çº§åˆ° 0.9</a></h2>
<h3 id="new-æ¥å£"><a class="header" href="#new-æ¥å£"><code>#[new]</code> æ¥å£</a></h3>
<details>
<summary><small>ç‚¹å‡»å±•å¼€</small></summary>
<p><a href="https://docs.rs/pyo3/0.8.5/pyo3/type_object/struct.PyRawObject.html"><code>PyRawObject</code></a> å·²è¢«ç§»é™¤ï¼Œæˆ‘ä»¬çš„æ„é€ å‡½æ•°è¯­æ³•å·²æ›´æ”¹ã€‚</p>
<p>ä¹‹å‰ï¼š</p>
<pre><code class="language-rust compile_fail">#[pyclass]
struct MyClass {}

#[pymethods]
impl MyClass {
    #[new]
    fn new(obj: &amp;PyRawObject) {
        obj.init(MyClass {})
    }
}</code></pre>
<p>ä¹‹åï¼š</p>
<pre><code class="language-rust no_run"><span class="boring">use pyo3::prelude::*;
</span>#[pyclass]
struct MyClass {}

#[pymethods]
impl MyClass {
    #[new]
    fn new() -&gt; Self {
        MyClass {}
    }
}</code></pre>
<p>åŸºæœ¬ä¸Šä½ å¯ä»¥ç›´æ¥è¿”å› <code>Self</code> æˆ– <code>Result&lt;Self&gt;</code>ã€‚æ›´å¤šä¿¡æ¯è¯·å‚è§æœ¬æŒ‡å—çš„<a href="class.html#constructor">æ„é€ å‡½æ•°ç« èŠ‚</a>ã€‚</p>
</details>
<h3 id="pycell"><a class="header" href="#pycell">PyCell</a></h3>
<details>
<summary><small>ç‚¹å‡»å±•å¼€</small></summary>
<p>PyO3 0.9 å¼•å…¥äº† <code>PyCell</code>ï¼Œè¿™æ˜¯ä¸€ä¸ªç±»ä¼¼äº <a href="https://doc.rust-lang.org/std/cell/struct.RefCell.html"><code>RefCell</code></a> çš„å¯¹è±¡åŒ…è£…å™¨ï¼Œç”¨äºç¡®ä¿ Rust å…³äºå¼•ç”¨åˆ«åçš„è§„åˆ™å¾—ä»¥éµå®ˆã€‚æ›´å¤šç»†èŠ‚è¯·å‚è§ <a href="https://doc.rust-lang.org/book/ch04-02-references-and-borrowing.html#the-rules-of-references">Rust ä¹¦ç±ä¸­å…³äºå¼•ç”¨è§„åˆ™çš„éƒ¨åˆ†</a></p>
<p>å¯¹äº <code>#[pymethods]</code> æˆ– <code>#[pyfunction]</code>ï¼Œç°æœ‰ä»£ç åº”æ— éœ€æ›´æ”¹å³å¯ç»§ç»­å·¥ä½œã€‚å½“ä½ çš„å‡½æ•°ä½¿ç”¨æ–¹å¼è¿åäº† Rust çš„å¼•ç”¨è§„åˆ™æ—¶ï¼Œä¼šè‡ªåŠ¨å¼•å‘ Python å¼‚å¸¸ã€‚</p>
<p>ç¤ºä¾‹å¦‚ä¸‹ï¼š</p>
<pre><code class="language-rust"><span class="boring">use pyo3::prelude::*;
</span>
#[pyclass]
struct Names {
    names: Vec&lt;String&gt;,
}

#[pymethods]
impl Names {
    #[new]
    fn new() -&gt; Self {
        Names { names: vec![] }
    }
    fn merge(&amp;mut self, other: &amp;mut Names) {
        self.names.append(&amp;mut other.names)
    }
}
<span class="boring">Python::attach(|py| {
</span><span class="boring">    let names = Py::new(py, Names::new()).unwrap();
</span><span class="boring">    pyo3::py_run!(py, names, r"
</span><span class="boring">    try:
</span><span class="boring">       names.merge(names)
</span><span class="boring">       assert False, 'Unreachable'
</span><span class="boring">    except RuntimeError as e:
</span><span class="boring">       assert str(e) == 'Already borrowed'
</span><span class="boring">    ");
</span><span class="boring">})</span></code></pre>
<p><code>Names</code> æœ‰ä¸€ä¸ª <code>merge</code> æ–¹æ³•ï¼Œå®ƒæ¥å— <code>&amp;mut self</code> å’Œå¦ä¸€ä¸ª <code>&amp;mut Self</code> ç±»å‹çš„å‚æ•°ã€‚ç»™å®šæ­¤ <code>#[pyclass]</code>ï¼Œåœ¨ Python ä¸­è°ƒç”¨ <code>names.merge(names)</code> ä¼šå¼•å‘ <a href="{{#PYO3_DOCS_URL}}/pyo3/pycell/struct.PyBorrowMutError.html"><code>PyBorrowMutError</code></a> å¼‚å¸¸ï¼Œå› ä¸ºå®ƒéœ€è¦å¯¹ <code>names</code> è¿›è¡Œä¸¤æ¬¡å¯å˜å€Ÿç”¨ã€‚</p>
<p>ç„¶è€Œï¼Œå¯¹äº <code>#[pyproto]</code> å’ŒæŸäº›å‡½æ•°ï¼Œä½ éœ€è¦æ‰‹åŠ¨ä¿®å¤ä»£ç ã€‚</p>
<h4 id="å¯¹è±¡åˆ›å»º"><a class="header" href="#å¯¹è±¡åˆ›å»º">å¯¹è±¡åˆ›å»º</a></h4>
<p>åœ¨ 0.8 ç‰ˆä¸­ï¼Œå¯¹è±¡åˆ›å»ºä½¿ç”¨ <code>PyRef::new</code> å’Œ <code>PyRefMut::new</code>ã€‚åœ¨ 0.9 ç‰ˆä¸­ï¼Œä¸¤è€…éƒ½å·²ç§»é™¤ã€‚è¦å‡çº§ä»£ç ï¼Œè¯·æ”¹ç”¨ <code>PyCell::new</code>ã€‚å¦‚æœä½ éœ€è¦ <a href="{{#PYO3_DOCS_URL}}/pyo3/pycell/struct.PyRef.html"><code>PyRef</code></a> æˆ– <a href="{{#PYO3_DOCS_URL}}/pyo3/pycell/struct.PyRef.html"><code>PyRefMut</code></a>ï¼Œåªéœ€åœ¨æ–°åˆ›å»ºçš„ <code>PyCell</code> ä¸Šè°ƒç”¨ <code>.borrow()</code> æˆ– <code>.borrow_mut()</code>ã€‚</p>
<p>ä¹‹å‰ï¼š</p>
<pre><code class="language-rust compile_fail"><span class="boring">use pyo3::prelude::*;
</span><span class="boring">#[pyclass]
</span><span class="boring">struct MyClass {}
</span><span class="boring">Python::with_gil(|py| {
</span>let obj_ref = PyRef::new(py, MyClass {}).unwrap();
<span class="boring">})</span></code></pre>
<p>ä¹‹åï¼š</p>
<pre><code class="language-rust ignore"><span class="boring">use pyo3::prelude::*;
</span><span class="boring">#[pyclass]
</span><span class="boring">struct MyClass {}
</span><span class="boring">Python::with_gil(|py| {
</span>let obj = PyCell::new(py, MyClass {}).unwrap();
let obj_ref = obj.borrow();
<span class="boring">})</span></code></pre>
<h4 id="å¯¹è±¡æå–"><a class="header" href="#å¯¹è±¡æå–">å¯¹è±¡æå–</a></h4>
<p>å¯¹äº <code>PyClass</code> ç±»å‹ <code>T</code>ï¼Œ<code>&amp;T</code> å’Œ <code>&amp;mut T</code> ä¸å†å…·æœ‰ <a href="{{#PYO3_DOCS_URL}}/pyo3/conversion/trait.FromPyObject.html"><code>FromPyObject</code></a> çš„å®ç°ã€‚ä½ åº”è¯¥åˆ†åˆ«æå– <code>PyRef&lt;T&gt;</code> æˆ– <code>PyRefMut&lt;T&gt;</code>ã€‚å¦‚æœ <code>T</code> å®ç°äº† <code>Clone</code>ï¼Œä½ å¯ä»¥ç›´æ¥æå– <code>T</code> æœ¬èº«ã€‚æ­¤å¤–ï¼Œä½ ä¹Ÿå¯ä»¥æå– <code>&amp;PyCell&lt;T&gt;</code>ï¼Œå°½ç®¡è¿™ç§æƒ…å†µå¾ˆå°‘éœ€è¦ã€‚</p>
<p>ä¹‹å‰ï¼š</p>
<pre><code class="language-compile_fail">let obj: &amp;PyAny = create_obj();
let obj_ref: &amp;MyClass = obj.extract().unwrap();
let obj_ref_mut: &amp;mut MyClass = obj.extract().unwrap();
</code></pre>
<p>ä¹‹åï¼š</p>
<pre><code class="language-rust ignore"><span class="boring">use pyo3::prelude::*;
</span><span class="boring">use pyo3::types::IntoPyDict;
</span><span class="boring">#[pyclass] #[derive(Clone)] struct MyClass {}
</span><span class="boring">#[pymethods] impl MyClass { #[new]fn new() -&gt; Self { MyClass {} }}
</span><span class="boring">Python::with_gil(|py| {
</span><span class="boring">let typeobj = py.get_type::&lt;MyClass&gt;();
</span><span class="boring">let d = [("c", typeobj)].into_py_dict(py);
</span><span class="boring">let create_obj = || py.eval("c()", None, Some(d)).unwrap();
</span>let obj: &amp;PyAny = create_obj();
let obj_cell: &amp;PyCell&lt;MyClass&gt; = obj.extract().unwrap();
let obj_cloned: MyClass = obj.extract().unwrap(); // é€šè¿‡å…‹éš†å¯¹è±¡æå–
{
    let obj_ref: PyRef&lt;'_, MyClass&gt; = obj.extract().unwrap();
    // ç”±äº Rust çš„å¼•ç”¨è§„åˆ™ï¼Œæˆ‘ä»¬éœ€è¦åœ¨æå– PyRefMut ä¹‹å‰å…ˆé‡Šæ”¾ obj_ref
}
let obj_ref_mut: PyRefMut&lt;'_, MyClass&gt; = obj.extract().unwrap();
<span class="boring">})
</span>```#### `#[pyproto]`

`#[pyproto]` å®ç°ä¸­çš„å¤§å¤šæ•°æ–¹æ³•å‚æ•°éƒ½éœ€è¦å®ç° [`FromPyObject`]ã€‚
å› æ­¤ï¼Œå¦‚æœæ‚¨çš„åè®®æ–¹æ³•æ¥å— `&amp;T` æˆ– `&amp;mut T`ï¼ˆå…¶ä¸­ `T: PyClass`ï¼‰ï¼Œè¯·æ”¹ç”¨ [`PyRef`] æˆ– [`PyRefMut`]ã€‚

ä¹‹å‰ï¼š

```rust,compile_fail
<span class="boring">use pyo3::prelude::*;
</span><span class="boring">use pyo3::class::PySequenceProtocol;
</span>#[pyclass]
struct ByteSequence {
    elements: Vec&lt;u8&gt;,
}
#[pyproto]
impl PySequenceProtocol for ByteSequence {
    fn __concat__(&amp;self, other: &amp;Self) -&gt; PyResult&lt;Self&gt; {
        let mut elements = self.elements.clone();
        elements.extend_from_slice(&amp;other.elements);
        Ok(Self { elements })
    }
}</code></pre>
<p>ä¹‹åï¼š</p>
<pre><code class="language-rust compile_fail"><span class="boring">use pyo3::prelude::*;
</span><span class="boring">use pyo3::class::PySequenceProtocol;
</span>#[pyclass]
struct ByteSequence {
    elements: Vec&lt;u8&gt;,
}
#[pyproto]
impl PySequenceProtocol for ByteSequence {
    fn __concat__(&amp;self, other: PyRef&lt;'p, Self&gt;) -&gt; PyResult&lt;Self&gt; {
        let mut elements = self.elements.clone();
        elements.extend_from_slice(&amp;other.elements);
        Ok(Self { elements })
    }
}</code></pre>
</details>
<style>
    /* ç«‹å³åœ¨ h3 æ ‡é¢˜ä¸‹æ–¹æ¸²æŸ“ details */
    h3:has(+ details) {
        margin-bottom: 0;
    }

    /* è®© summary æ–‡æœ¬æç¤ºå…¶å¯ç‚¹å‡»ï¼Œå¹¶é€šè¿‡å‘ä¸‹å¡«å……å¢åŠ å¯ç‚¹å‡»åŒºåŸŸ */
    details > summary {
        cursor: pointer;
        padding-bottom: 0.5em;
    }

    /* å‡å°‘ç´§æ¥åœ¨å¯ç‚¹å‡»åŒºåŸŸä¸‹æ–¹æ®µè½çš„ä¸Šè¾¹è·ï¼Œä»¥é¿å…å¤§ç©ºç™½ */
    details > summary + p {
        margin-block-start: 0.5em;
    }

    /* ç¨å¾®ç´§å‡‘åœ°æ’åˆ—æœªå±•å¼€çŠ¶æ€ä¸‹çš„ç›¸é‚»æ ‡é¢˜ */
    h3 + details:not([open]) + h3 {
        margin-top: 1.5em;
    }
</style>
</summar></details></pybackedstr></t></t></details>
                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="faq.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M41.4 233.4c-12.5 12.5-12.5 32.8 0 45.3l160 160c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L109.3 256 246.6 118.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0l-160 160z"/></svg></span>
                            </a>

                            <a rel="next prefetch" href="trait-bounds.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M278.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-160 160c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L210.7 256 73.4 118.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l160 160z"/></svg></span>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="faq.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M41.4 233.4c-12.5 12.5-12.5 32.8 0 45.3l160 160c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L109.3 256 246.6 118.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0l-160 160z"/></svg></span>
                    </a>

                    <a rel="next prefetch" href="trait-bounds.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M278.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-160 160c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L210.7 256 73.4 118.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l160 160z"/></svg></span>
                    </a>
            </nav>

        </div>

        <template id=fa-eye><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M288 32c-80.8 0-145.5 36.8-192.6 80.6C48.6 156 17.3 208 2.5 243.7c-3.3 7.9-3.3 16.7 0 24.6C17.3 304 48.6 356 95.4 399.4C142.5 443.2 207.2 480 288 480s145.5-36.8 192.6-80.6c46.8-43.5 78.1-95.4 93-131.1c3.3-7.9 3.3-16.7 0-24.6c-14.9-35.7-46.2-87.7-93-131.1C433.5 68.8 368.8 32 288 32zM432 256c0 79.5-64.5 144-144 144s-144-64.5-144-144s64.5-144 144-144s144 64.5 144 144zM288 192c0 35.3-28.7 64-64 64c-11.5 0-22.3-3-31.6-8.4c-.2 2.8-.4 5.5-.4 8.4c0 53 43 96 96 96s96-43 96-96s-43-96-96-96c-2.8 0-5.6 .1-8.4 .4c5.3 9.3 8.4 20.1 8.4 31.6z"/></svg></span></template>
        <template id=fa-eye-slash><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M38.8 5.1C28.4-3.1 13.3-1.2 5.1 9.2S-1.2 34.7 9.2 42.9l592 464c10.4 8.2 25.5 6.3 33.7-4.1s6.3-25.5-4.1-33.7L525.6 386.7c39.6-40.6 66.4-86.1 79.9-118.4c3.3-7.9 3.3-16.7 0-24.6c-14.9-35.7-46.2-87.7-93-131.1C465.5 68.8 400.8 32 320 32c-68.2 0-125 26.3-169.3 60.8L38.8 5.1zM223.1 149.5C248.6 126.2 282.7 112 320 112c79.5 0 144 64.5 144 144c0 24.9-6.3 48.3-17.4 68.7L408 294.5c5.2-11.8 8-24.8 8-38.5c0-53-43-96-96-96c-2.8 0-5.6 .1-8.4 .4c5.3 9.3 8.4 20.1 8.4 31.6c0 10.2-2.4 19.8-6.6 28.3l-90.3-70.8zm223.1 298L373 389.9c-16.4 6.5-34.3 10.1-53 10.1c-79.5 0-144-64.5-144-144c0-6.9 .5-13.6 1.4-20.2L83.1 161.5C60.3 191.2 44 220.8 34.5 243.7c-3.3 7.9-3.3 16.7 0 24.6c14.9 35.7 46.2 87.7 93 131.1C174.5 443.2 239.2 480 320 480c47.8 0 89.9-12.9 126.2-32.5z"/></svg></span></template>
        <template id=fa-copy><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M502.6 70.63l-61.25-61.25C435.4 3.371 427.2 0 418.7 0H255.1c-35.35 0-64 28.66-64 64l.0195 256C192 355.4 220.7 384 256 384h192c35.2 0 64-28.8 64-64V93.25C512 84.77 508.6 76.63 502.6 70.63zM464 320c0 8.836-7.164 16-16 16H255.1c-8.838 0-16-7.164-16-16L239.1 64.13c0-8.836 7.164-16 16-16h128L384 96c0 17.67 14.33 32 32 32h47.1V320zM272 448c0 8.836-7.164 16-16 16H63.1c-8.838 0-16-7.164-16-16L47.98 192.1c0-8.836 7.164-16 16-16H160V128H63.99c-35.35 0-64 28.65-64 64l.0098 256C.002 483.3 28.66 512 64 512h192c35.2 0 64-28.8 64-64v-32h-47.1L272 448z"/></svg></span></template>
        <template id=fa-play><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M73 39c-14.8-9.1-33.4-9.4-48.5-.9S0 62.6 0 80V432c0 17.4 9.4 33.4 24.5 41.9s33.7 8.1 48.5-.9L361 297c14.3-8.7 23-24.2 23-41s-8.7-32.2-23-41L73 39z"/></svg></span></template>
        <template id=fa-clock-rotate-left><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M75 75L41 41C25.9 25.9 0 36.6 0 57.9V168c0 13.3 10.7 24 24 24H134.1c21.4 0 32.1-25.9 17-41l-30.8-30.8C155 85.5 203 64 256 64c106 0 192 86 192 192s-86 192-192 192c-40.8 0-78.6-12.7-109.7-34.4c-14.5-10.1-34.4-6.6-44.6 7.9s-6.6 34.4 7.9 44.6C151.2 495 201.7 512 256 512c141.4 0 256-114.6 256-256S397.4 0 256 0C185.3 0 121.3 28.7 75 75zm181 53c-13.3 0-24 10.7-24 24V256c0 6.4 2.5 12.5 7 17l72 72c9.4 9.4 24.6 9.4 33.9 0s9.4-24.6 0-33.9l-65-65V152c0-13.3-10.7-24-24-24z"/></svg></span></template>



        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr-ef4e11c1.min.js"></script>
        <script src="mark-09e88c2c.min.js"></script>
        <script src="searcher-c2a407aa.js"></script>

        <script src="clipboard-1626706a.min.js"></script>
        <script src="highlight-abc7f01d.js"></script>
        <script src="book-a0b12cfe.js"></script>

        <!-- Custom JS scripts -->
        <script src="theme/tabs-6977231d.js"></script>



    </div>
    </body>
</html>
